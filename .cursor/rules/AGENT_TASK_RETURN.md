# Правила возврата задач для агентов

## Общие принципы

Если агент получает задачу, которая не соответствует его правилам или не готова для работы, он **ОБЯЗАН** вернуть задачу соответствующему агенту или этапу.

## Метки для возвращенных задач

### Метка `returned`
- Добавляется при возврате задачи
- Показывает, что задача была возвращена и требует внимания
- Удаляется при принятии задачи следующим агентом

### Метка `needs-review`
- Добавляется при неясной ситуации
- Требует ручного вмешательства
- Удаляется после решения проблемы

## Процесс возврата задачи

### Шаг 1: Проверка готовности

**ОБЯЗАТЕЛЬНО перед началом работы:**
1. Проверь входные данные (см. раздел "Входные данные" в правилах агента)
2. Проверь тип задачи (контентная vs системная)
3. Проверь статус задачи (не обработана ли уже)
4. Проверь наличие необходимых артефактов (OpenAPI, архитектура и т.д.)

### Шаг 2: Определение причины возврата

**Основные причины возврата:**

1. **Отсутствие входных данных:**
   - Нет OpenAPI спецификации (для Backend)
   - Нет архитектуры (для API Designer)
   - Нет готового функционала (для QA)
   - Нет готового бекенда (для UE5)

2. **Неправильный тип задачи:**
   - Контентный квест попал к системному агенту
   - Системная задача попала к контентному агенту

3. **Задача уже обработана:**
   - Файлы уже созданы
   - Issue уже закрыт
   - Задача на другом этапе

4. **Задача не соответствует этапу:**
   - Задача на неправильном Development Stage
   - Отсутствуют необходимые метки

### Шаг 3: Возврат задачи

**ОБЯЗАТЕЛЬНО при возврате:**

1. **Удали свою метку агента:**
   - Удали `agent:{agent-name}`
   - Удали `stage:{stage-name}`

2. **Добавь метку возврата:**
   - Добавь `returned` - для явного возврата
   - Добавь `needs-review` - если неясно, кому передать

3. **Добавь метку правильного агента:**
   - Если знаешь, кому передать → добавь метку этого агента
   - Если не знаешь → оставь только `needs-review`

4. **Обнови статус Project:**
   - Верни на предыдущий этап (если знаешь)
   - Или оставь текущий этап с меткой `returned`

5. **Добавь комментарий с объяснением:**
   - Укажи причину возврата
   - Укажи, что отсутствует
   - Укажи, кому должна быть передана задача

## Шаблоны комментариев для возврата

### Возврат из-за отсутствия входных данных

```markdown
⚠️ **Задача возвращена: отсутствуют входные данные**

**Причина возврата:**
- Отсутствует: [OpenAPI спецификация / Архитектура / Готовый функционал]
- Задача не может быть обработана без необходимых входных данных

**Требуется:**
- [Что нужно для продолжения работы]

**Рекомендация:**
Задача должна быть передана агенту [agent-name] для [что нужно сделать]

**Метки обновлены:**
- Удалено: `agent:{my-agent}`, `stage:{my-stage}`
- Добавлено: `returned`, `agent:{correct-agent}`
```

### Возврат из-за неправильного типа задачи

```markdown
⚠️ **Задача возвращена: неправильный тип задачи**

**Причина возврата:**
- Задача является [контентным квестом / системной задачей]
- Данный агент не обрабатывает задачи этого типа

**Правильный агент:**
- Задача должна быть передана агенту [agent-name]

**Метки обновлены:**
- Удалено: `agent:{my-agent}`, `stage:{my-stage}`
- Добавлено: `returned`, `agent:{correct-agent}`
```

### Возврат из-за уже обработанной задачи

```markdown
⚠️ **Задача уже обработана**

**Причина:**
- [Файлы уже созданы / Issue закрыт / Задача на другом этапе]
- Работа уже выполнена

**Статус:**
- [Текущий статус задачи]
- [Ссылка на созданные файлы / PR]

**Рекомендация:**
- Проверь существующие файлы/PR
- Если нужно - обнови существующую работу
- Не создавай дубликаты
```

### Возврат с неясной ситуацией

```markdown
⚠️ **Задача возвращена: требуется ручное вмешательство**

**Причина:**
- [Описание неясной ситуации]
- Не могу определить правильного агента или этап

**Требуется:**
- Ручная проверка задачи
- Определение правильного агента
- Обновление меток и статуса

**Метки обновлены:**
- Удалено: `agent:{my-agent}`, `stage:{my-stage}`
- Добавлено: `needs-review`
```

## Специфичные сценарии для агентов

### QA Agent

**Возврат, если:**
- Нет готового функционала (бекенд или клиент не реализован)
- Нет OpenAPI спецификации для тестирования API
- Нет требований для тестирования

**Кому возвращать:**
- Если нет бекенда → `agent:backend`
- Если нет клиента → `agent:ue5`
- Если нет спецификации → `agent:api-designer`

### Backend Developer

**Возврат, если:**
- Нет OpenAPI спецификации
- Нет архитектуры
- Это контентный квест

**Кому возвращать:**
- Если нет OpenAPI → `agent:api-designer`
- Если нет архитектуры → `agent:architect`
- Если контентный квест → `agent:content-writer`

### API Designer

**Возврат, если:**
- Нет архитектуры
- Это контентный квест

**Кому возвращать:**
- Если нет архитектуры → `agent:architect`
- Если контентный квест → `agent:content-writer`

### Architect

**Возврат, если:**
- Нет идеи от Idea Writer
- Это контентный квест

**Кому возвращать:**
- Если нет идеи → `agent:idea-writer`
- Если контентный квест → `agent:content-writer`

### UE5 Developer

**Возврат, если:**
- Нет готового бекенда
- Нет OpenAPI спецификации
- Это контентный квест

**Кому возвращать:**
- Если нет бекенда → `agent:backend`
- Если нет спецификации → `agent:api-designer`
- Если контентный квест → `agent:content-writer`

### Content Writer

**Возврат, если:**
- Нет концепции квеста от Idea Writer
- Это системная задача (требует архитектуры)

**Кому возвращать:**
- Если нет концепции → `agent:idea-writer`
- Если системная задача → `agent:architect`

## Примеры использования MCP GitHub

### Возврат задачи с объяснением

```javascript
async function returnTask(issueNumber, reason, correctAgent) {
  // 1. Читаем Issue
  const issue = await getCachedIssue(issueNumber);
  const currentLabels = issue.labels.map(l => l.name);
  
  // 2. Удаляем свои метки
  const myAgentLabel = 'agent:qa'; // пример
  const myStageLabel = 'stage:testing'; // пример
  const labelsWithoutMine = currentLabels.filter(
    l => l !== myAgentLabel && l !== myStageLabel
  );
  
  // 3. Добавляем метки возврата и правильного агента
  const newLabels = [
    ...labelsWithoutMine,
    'returned',
    correctAgent, // например, 'agent:backend'
    `stage:${getStageForAgent(correctAgent)}`
  ];
  
  // 4. Обновляем Issue
  await mcp_github_issue_write({
    method: 'update',
    owner: 'gc-lover',
    repo: 'necpgame-monorepo',
    issue_number: issueNumber,
    labels: newLabels
  });
  
  await delay(300);
  
  // 5. Добавляем комментарий
  await mcp_github_add_issue_comment({
    owner: 'gc-lover',
    repo: 'necpgame-monorepo',
    issue_number: issueNumber,
    body: `⚠️ **Задача возвращена: ${reason}**\n\n[Детали возврата]`
  });
  
  await delay(300);
}
```

## Чеклист перед возвратом

- [ ] Проверена готовность входных данных
- [ ] Проверен тип задачи
- [ ] Проверен статус задачи
- [ ] Определен правильный агент для передачи
- [ ] Удалены свои метки агента
- [ ] Добавлена метка `returned` или `needs-review`
- [ ] Добавлена метка правильного агента (если известна)
- [ ] Обновлен статус Project (если нужно)
- [ ] Добавлен комментарий с объяснением
- [ ] Инвалидирован кэш Issue

## Важно

- **НЕ начинай работу**, если входные данные не готовы
- **НЕ создавай дубликаты** работы
- **ВСЕГДА объясняй причину возврата** в комментарии
- **ВСЕГДА обновляй метки** при возврате
- **ВСЕГДА используй метку `returned`** для явного возврата
- **Используй `needs-review`** только если неясно, кому передать

## Дополнительные ресурсы

- `.cursor/rules/AGENT_LABEL_MANAGEMENT.md` - управление метками
- `.cursor/rules/AGENT_TASK_DISCOVERY.md` - поиск задач
- Правила конкретных агентов: `.cursor/rules/agent-*.mdc`








