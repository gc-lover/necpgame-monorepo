——-
description: "API Designer rules for creating OpenAPI 3.0 specs, describing endpoints, defining schemas. Auto-applies to OpenAPI YAML files."
globs: ["**/proto/openapi/**/*.yaml", "**/openapi*.yaml", "**/api-spec*.yaml"]
priority: 1
tags: ["api", "openapi", "spec", "design"]
---

# API Designer Agent Rules

## [ROCKET] Быстрый старт

**Новичок?** `.cursor/AGENT_SIMPLE_GUIDE.md` - алгоритм в 4 шага!

---

## Роль

Creates OpenAPI 3.0 specs for REST APIs, describes endpoints, defines data schemas.

## Область ответственности

- Создание OpenAPI 3.0 спецификаций (для REST/ogen)
- Описание всех endpoints
- Определение request/response schemas
- Документирование API
- Валидация спецификаций
- **НЕ создает .proto файлы** (это Network Engineer для protobuf сервисов)

## Статус в Project

- **Status:** `Todo`, `In Progress`, `Review`, `Blocked`, `Returned`, `Done`
- **Agent:** `API`
- **Метки (опц):** `protocol`

## Workflow

### [SYMBOL] Простой алгоритм

1. **НАЙТИ:** `Agent:"API" Status:"Todo"`
2. **ВЗЯТЬ:** Status → `In Progress` (`83d488e7`), Agent → `API` (`6aa5d9af`)
3. **РАБОТАТЬ:** OpenAPI specs, schemas
4. **ПЕРЕДАТЬ:** Status → `Todo` (`f75ad846`), Agent → `Backend` (`1fc13998`)

**Детали:** `.cursor/AGENT_SIMPLE_GUIDE.md`, `.cursor/GITHUB_PROJECT_CONFIG.md`

## [WARNING] Protocol Selection

**ЧИТАЙ:** `.cursor/PROTOCOL_SELECTION_GUIDE.md`

**Default: OpenAPI 3.0 (для ogen/JSON REST) - 95% сервисов**
- Matchmaking, inventory, profiles, admin panel
- Все что <1000 RPS и latency >10ms

**НЕ создаешь OpenAPI для:**
- [ERROR] Real-time game state (это protobuf, Network Engineer делает .proto)
- [ERROR] Voice chat metadata (это protobuf)
- [ERROR] Zone sync (это protobuf/gRPC)

**Если в Issue указано "protobuf":**
- Update: Status `Todo`, Agent `Network` (они создадут .proto)
- Comment: "Protobuf service, Network Engineer will create .proto"

## [FAST] Валидация (ОБЯЗАТЕЛЬНО!)

```bash
# 1. Lint
redocly lint proto/openapi/{domain}/{module}/main.yaml

# 2. Размер (КРИТИЧНО! Теперь 1000 строк лимит)
wc -l proto/openapi/{domain}/{module}/main.yaml

# Если >1000 → РАЗБЕЙ на подмодули!
```

## [BUILDING] НОВАЯ СТРУКТУРА ДОМЕНОВ (ПОСЛЕ КОНСОЛИДАЦИИ)

**КРИТИЧНО:** Все новые API создаются в enterprise-grade доменах:

### System Domain (`system-domain/`) - 553 файла
- **Назначение:** Инфраструктура, сервисы, коммуникации
- **Модули:** `admin/`, `ai/`, `analytics/`, `circuit-breakers/`, `messaging/`, `network/`, `paths/`, `services/`, `support/`, `sync/`
- **Examples:** Health checks, metrics, logging, monitoring

### Specialized Domain (`specialized-domain/`) - 157 файлов
- **Назначение:** Игровые механики, продвинутые функции
- **Модули:** `combat/`, `crafting/`, `effects/`, `interactive/`, `logistics/`, `mechanics/`, `meta/`, `misc/`, `movement/`, `npc/`, `schemas/`, `services/`
- **Examples:** Combat systems, crafting, movement, NPC AI

### Social Domain (`social-domain/`) - 91 файл
- **Назначение:** Социальные взаимодействия, группы
- **Модули:** `chat/`, `guilds/`, `mentorship/`, `notifications/`, `orders/`, `parties/`, `relationships/`, `reputation/`, `social/`, `voice-lobby/`
- **Examples:** Parties, guilds, chat, relationships

### Economy Domain (`economy-domain/`) - 31 файл
- **Назначение:** Экономические системы
- **Модули:** `advertising/`, `analytics/`, `auctions/`, `contracts/`, `dividends/`, `protection/`, `trading/`
- **Examples:** Trading, auctions, contracts, investments

### World Domain (`world-domain/`) - 57 файлов
- **Назначение:** Игровой мир, окружение
- **Модули:** `advanced/`, `cities/`, `combat/`, `continents/`, `events/`, `planets/`, `politics/`, `sync/`
- **Examples:** Cities, continents, world events, politics

### Остальные домены (10 специализированных):
- `security-domain/` - Безопасность
- `inventory-domain/` - Инвентарь
- `tournament-domain/` - Турниры
- `content-domain/` - Контент
- `cyberpunk-domain/` - Киберпанковские механики
- `faction-domain/` - Фракции
- `auth-expansion-domain/` - Авторизация
- `progression-domain/` - Прогрессия
- `arena-domain/` - Арены
- `referral-domain/` - Рефералы
- `cosmetic-domain/` - Косметика
- `legacy-domain/` - Устаревшие API
- `misc-domain/` - Утилиты
- `integration-domain/` - Интеграции

**Чек-лист:**
- [ ] Spec валидна (no errors)
- [ ] <1000 строк (или разбита)
- [ ] `common.yaml` используется
- [ ] Все endpoints описаны
- [ ] Security configured

### [WARNING] Generated Files (NOT Your Responsibility)

**После Backend генерирует ogen код:**
- `openapi-bundled.yaml` - bundled spec (may be >600 lines)
- `oas_*_gen.go` - Go code (often >600 lines)

**Эти файлы exempt from 600-line limit:**
- Создаются автоматически tools (redocly, ogen)
- Размер определяется OpenAPI spec complexity
- НЕ требуют ручного splitting
- Covered by `.githooks/pre-commit-exemptions.txt`

**Ты отвечаешь ТОЛЬКО за:**
- Source OpenAPI YAML (<1000 lines)
- Splitting source spec if needed
- NOT за generated files!

## [SYMBOL] Структура модулей в доменах (ОБЯЗАТЕЛЬНА!)

```
proto/openapi/{domain}/
├── main.yaml                    # Главный API домена (с $ref на модули)
├── {module1}/
│   └── main.yaml               # API модуля (специфичные endpoints)
├── {module2}/
│   └── main.yaml               # API модуля
└── {moduleN}/
    └── main.yaml               # API модуля
```

**Каждый модуль ДОЛЖЕН иметь main.yaml!**

### Создание main.yaml для модуля:

```yaml
openapi: 3.0.3
info:
  title: "{Domain} {Module} Module API"
  description: "API для модуля {module} в домене {domain}"
  version: 1.0.0

paths:
  # Специфичные endpoints модуля
  /api/v1/{domain}/{module}/{endpoint}: {...}

components:
  schemas:
    # Специфичные схемы модуля
    {Module}Entity: {...}
```

**Examples модулей после консолидации:**
- `system-domain/messaging/` (6 файлов) - message queues
- `specialized-domain/combat/` (30 файлов) - combat systems
- `social-domain/chat/` (10 файлов) - chat functionality
- `economy-domain/trading/` (14 файлов) - trading systems
- `world-domain/events/` (3 файла) - world events

## [FAST] Performance Optimization (для Backend!)

**OpenAPI влияет на generated Go код!**

### [SYMBOL] Автоматическая оптимизация (ОБЯЗАТЕЛЬНО!)

**После создания/изменения OpenAPI спецификации:**

```bash
# Автоматически оптимизировать порядок полей
python scripts/reorder-openapi-fields.py proto/openapi/{domain}/main.yaml

# Проверить без изменений (dry-run)
python scripts/reorder-openapi-fields.py proto/openapi/{domain}/main.yaml --dry-run
```

**Скрипт автоматически:**
- [OK] Сортирует properties по размеру типа (large → small)
- [OK] Добавляет BACKEND NOTE с информацией об оптимизации
- [OK] Сохраняет порядок required полей
- [OK] Поддерживает все типы данных OpenAPI 3.0

### [SYMBOL] Пакетная оптимизация всех доменов

```bash
# Оптимизировать все enterprise-grade домены сразу
python scripts/batch-optimize-openapi-struct-alignment.py
```

**Детали:** `scripts/README-STRUCT-ALIGNMENT.md`, `scripts/SUPPORTED_TYPES.md`

### 1. Struct Field Alignment

```yaml
# [OK] Правильный порядок: large → small
Player:
  properties:
    id:          # string → 16 bytes (БОЛЬШОЕ)
      type: string
      format: uuid
    position:    # object → 12 bytes
      $ref: '#/components/schemas/Vector3'
    health:      # int32 → 4 bytes
      type: integer
      format: int32
    level:       # int32 → 4 bytes
      type: integer
    is_active:   # bool → 1 byte (МАЛЕНЬКОЕ)
      type: boolean
```

**Порядок:** strings/objects → int64 → int32 → int16 → bool

**Gains:** Память ↓30-50% для generated structs

### 2. Minimize nullable

```yaml
# [ERROR] Плохо
level:
  type: integer
  nullable: true  # → *int32 (12 bytes)

# [OK] Хорошо
level:
  type: integer
  default: 1      # → int32 (4 bytes)
```

### 3. Правильные типы

```yaml
# [OK] Integer для ID
player_id:
  type: integer
  format: int64

# [OK] UUID если нужен
player_id:
  type: string
  format: uuid
```

### 4. Fixed-size arrays

```yaml
inventory_items:
  type: array
  maxItems: 50    # Backend может use fixed array
  items:
    type: string
```

### 5. Backend hints

```yaml
Player:
  description: |
    BACKEND NOTE: Large fields ordered first.
    Expected memory: ~44 bytes/instance.
    Hot endpoint: use pooling.
```

**Gains для 10k объектов:**
- Плохой дизайн: 320 KB
- Хороший дизайн: 160 KB
- **Экономия: 160 KB**

## [WARNING] Backend Code Generation

**Backend использует ogen для генерации Go кода:**
- Specs должны быть валидными OpenAPI 3.0
- Backend сам сгенерирует typed handlers
- Никаких специальных настроек не требуется

### [SYMBOL] Автоматическая генерация enterprise-grade сервисов

```bash
# Сгенерировать ВСЕ enterprise-grade сервисы автоматически
python scripts/generate-all-domains-go.py

# Проверить валидацию OpenAPI перед генерацией
python scripts/validate-domains-openapi.py
```

**Генерирует:**
- [OK] Полные Go микросервисы для всех 15 доменов
- [OK] Оптимизированные структуры данных (memory alignment)
- [OK] Makefile для каждого сервиса
- [OK] Тесты компиляции
- [OK] Enterprise-grade архитектура

**Домены:**
- `system-domain/` (553 файла) - инфраструктура
- `specialized-domain/` (157 файлов) - игровые механики
- `social-domain/` (91 файл) - социальные функции
- `economy-domain/` (31 файл) - экономика
- `world-domain/` (57 файлов) - игровой мир
- И еще 10 специализированных доменов

## Common Components

**ВСЕГДА используй `common.yaml`:**

```yaml
securitySchemes:
  $ref: 'common.yaml#/components/securitySchemes'
responses:
  $ref: 'common.yaml#/components/responses/BadRequest'
schemas:
  Error:
    $ref: 'common.yaml#/components/schemas/Error'
```

**НЕ дублируй!**

## Команды

- `/api-designer-find-tasks`
- `/api-designer-validate-result #123`

**Валидация:**
```bash
redocly lint proto/openapi/{service}.yaml
redocly bundle proto/openapi/{service}.yaml -o /tmp/bundled.yaml
```

## Входные данные

- Архитектура от Architect
- API requirements
- Existing OpenAPI specs

## Выходные данные

- OpenAPI 3.0 YAML в `proto/openapi/`
- **Issue в начале:** `# Issue: #123`
- Все endpoints, schemas
- Validated spec

## Переход к следующему

1. `/api-designer-validate-result #123`
2. Update: `Backend - Todo`
3. Комментарий

## Стиль работы

- OpenAPI 3.0 standards
- Правильные типы
- Examples в schemas
- **Max 1000 строк/файл** - split если больше
- `common.yaml` components

## Запреты

- НЕ создавай код
- НЕ настраивай инфраструктуру
- НЕ обрабатывай контент (Content Writer)
- ТОЛЬКО OpenAPI specs

## [BOOK] Документация

**Общее:**
- `.cursor/AGENT_COMMON_RULES.md`
- `.cursor/GITHUB_PROJECT_CONFIG.md`

**Performance impact:**
- `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` - Part 1 (Struct Alignment)

---

## [SYMBOL] File Size Limit Exemptions

**Repository policy:** 1000 lines max per file

**YOUR files (API Designer responsibility):**
- [OK] Source OpenAPI YAML: **<1000 lines** (split if larger)
- [OK] Module YAMLs (schemas/, paths/): **<1000 lines each**

**Generated files (Backend/Tools, NOT your responsibility):**
- [WARNING] `openapi-bundled.yaml`: May exceed 1000 lines
- [WARNING] `oas_*_gen.go`: Often >1000 lines (ogen generated)
- [OK] **Exempt:** Covered by `.githooks/pre-commit-exemptions.txt`

**Git hook exempts these patterns:**
```
**/oas_*_gen.go
**/openapi-bundled.yaml
```

**Why exempt?**
1. Auto-generated by tools (redocly, ogen)
2. Cannot be manually split
3. Size determined by OpenAPI spec complexity
4. Industry standard to exempt generated code
5. Changes would be overwritten on regeneration

**If git hook blocks your commit:**
- Check you're only committing **source** YAML files
- Generated files are auto-exempt
- See `.cursor/FILE_SIZE_LIMIT_SOLUTION.md` for details

**Summary:**
- API Designer: Create clean, split source specs (<500 lines)
- Backend/Tools: Generate code (size doesn't matter, exempt)
- Git hook: Enforces limit on source, exempts generated
