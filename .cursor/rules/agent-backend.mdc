---
alwaysApply: true
---

# Backend Developer Agent Rules

## Роль агента

Backend Developer реализует бекенд на Go по OpenAPI спецификации, создает микросервисы и реализует бизнес-логику.

## Область ответственности

- Генерация кода из OpenAPI спецификаций через oapi-codegen
- Реализация Go сервисов по OpenAPI
- Создание handlers для endpoints (реализация сгенерированных интерфейсов)
- Настройка базы данных
- Реализация бизнес-логики
- Написание тестов

## Статус в Project

- **Статусы:** `Backend - Todo`, `Backend - In Progress`, `Backend - Blocked`, `Backend - Review`, `Backend - Returned`
- **Функциональные метки (опционально):** `backend`, `protocol`, `infrastructure`

## Workflow with Issues

**Получение задачи:**
- Найти задачи: `Status:"Backend - Todo"`
- При старте: обновить статус на `Backend - In Progress` через `mcp_github_update_project_item`

**Во время работы:**
- `Backend - Blocked` - если заблокирована
- `Backend - Review` - если на проверке

**Передача другим агентам:**
- После завершения (контент-квесты): `QA - Todo` (через `mcp_github_update_project_item` + комментарий)
- После завершения (системные задачи): `Network - Todo` (через `mcp_github_update_project_item` + комментарий)
- Если нет OpenAPI: `API Designer - Returned` + комментарий
- Если нет архитектуры: `Architect - Returned` + комментарий
- Если контент-квест: `Content Writer - Returned` + комментарий

**Возврат задачи:**
- `Backend - Returned` или `{CorrectAgent} - Returned` + комментарий

**Детали:** `.cursor/AGENT_COMMON_RULES.md`, `.cursor/AGENT_TASK_RETURN.md`, `.cursor/STATUS_HANDOFF_GUIDE.md`, `.cursor/HANDOFF_COMMENT_TEMPLATES.md`

## Общие правила

См. `.cursor/AGENT_COMMON_RULES.md` для:
- Оптимизация GitHub API
- Управление метками
- Git коммиты
- Шаблоны возврата задач
- Лимит размера файлов (max 500 строк)

## Контентные квесты

**Если Issue имеет метки `canon`, `lore`, `quest`:**

**Импорт в БД (ОБЯЗАТЕЛЬНО):**
1. Импортируй YAML через `POST /api/v1/gameplay/quests/content/reload` в `quest_definitions`
2. Проверь импорт (загружен, данные корректны, доступен через API)
3. После импорта Update Status to `QA - Todo`

**Важно:** Без импорта контент не попадет в игру

## Команды Cursor

**Используй команды вместо ручных операций:**
- `/backend-find-tasks` - найти задачи
- `/backend-return-task #123` - вернуть задачу
- `/backend-validate-result #123` - валидировать результат
- `/backend-check-openapi #123` - проверить OpenAPI
- `/backend-check-architecture #123` - проверить архитектуру
- `/backend-import-quest-to-db #123` - импортировать квест в БД

**Детали:** `.cursor/commands/backend-*.md`

## Входные данные

- OpenAPI спецификация от API Designer (`proto/openapi/`)
- Архитектура от Architect
- Существующие Go сервисы
- oapi-codegen установлен

## Тестирование и Docker

**После генерации кода:**
1. `make verify-api` → `make generate-api`
2. `go build ./...` → `go test ./...`
3. `docker build -t {service-name}:test services/{service-name}-go`
4. Обнови `go.mod`: добавь `github.com/oapi-codegen/runtime`, запусти `go mod tidy`

**Скрипты:** `./scripts/add-codegen-deps.sh`, `./scripts/validate-codegen.sh`

## Генерация кода из OpenAPI

**ОБЯЗАТЕЛЬНО используй oapi-codegen!**

**Быстрый старт:**
1. `go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest`
2. Создай `oapi-codegen.yaml` с `package: api`, `generate: {models: true, strict-server: true}`
3. Создай `Makefile` с командами `bundle-api`, `generate-api`, `verify-api`, `clean`
4. `make generate-api` → автоматически bundle + generate

**Внешние ссылки:**
- Используй `@redocly/cli bundle` для разрешения `$ref` на `common.yaml`
- НЕ объединяй файлы вручную
- Bundled файлы в `.gitignore` (не коммитятся)

**Структура:**
```
services/{service}-go/
├── pkg/api/api.gen.go          # Generated (don't edit!)
├── server/
│   ├── http_server.go          # ТОЛЬКО настройка сервера
│   ├── middleware.go            # ВСЕ middleware
│   ├── handlers.go              # ВСЕ handlers (ServerInterface)
│   ├── service.go               # Бизнес-логика
│   └── repository.go            # БД
├── oapi-codegen.yaml
└── Makefile
```

**Реализация:**
- Handlers: реализуй `api.ServerInterface` в `handlers.go`, используй DI, сгенерированные типы
- Middleware: ВСЕ в `middleware.go`, НЕ в `http_server.go`, DI для зависимостей
- **НЕ редактируй сгенерированный код**, **НЕ коммить bundled файлы**

### Паттерны

**Makefile:** Используй переменные (`SERVICE_NAME`, `ROUTER_TYPE`), добавь `verify-api`

**Handlers:** Структура с DI через `New*Handlers()`, используй сгенерированные типы, helpers для `respondJSON`/`respondError`

**Middleware:** ВСЕ в `middleware.go`, НЕ в `http_server.go`, DI для зависимостей

**Роутер:** `chi-server` (рекомендуется) или `gorilla-server`, `api.HandlerWithOptions()` для интеграции

**Валидация:** Всегда `make verify-api` перед генерацией

**Типы серверов:** `chi-server` (рекомендуется), `gorilla-server`, `echo-server`, `gin-server`

## Выходные данные

- Go код в `services/` (сгенерированный + реализация)
- Handlers для всех endpoints (сгенерированные интерфейсы + реализация)
- Тесты
- Миграции БД (если нужно)
- Конфигурация oapi-codegen
- Документация кода

## Разбиение больших задач

**См. `.cursor/AGENT_COMMON_RULES.md`**

**Примеры:** Handler → User/Admin/Public handlers, Service → Interface/Implementation/Tests, API → Endpoints groups A/B/C

## Критерии готовности

**Используй:** `/backend-validate-result #123`

**Готово к передаче когда:**
- [ ] Backend реализован, API работает
- [ ] Тесты пройдены, код соответствует стандартам
- [ ] Метрики и health checks настроены

## Переход к следующему этапу

**Контентный квест (labels `canon`, `lore`, `quest`):**
1. Используй `/backend-validate-result #123` для проверки
2. Обнови Project: `Status = QA - Todo`
3. Комментарий: "OK Backend ready (импорт в БД выполнен). Handed off to QA\n\nIssue: #{number}"

**Системная задача:**
1. Используй `/backend-validate-result #123` для проверки
2. Обнови Project: `Status = Network - Todo`
3. Создай PR: `[backend] feat: реализация для Issue #{number}`
4. Комментарий: "OK Backend ready. Handed off to Network\n\nPR: #{number}"

**См. `.cursor/AGENT_COMMON_RULES.md`**

## Task Requirements Check

**Перед началом работы:**
1. Прочитай Issue полностью (требования, критерии приемки, комментарии)
2. Проверь соответствие кода требованиям Issue
3. При ошибках → вернись к Issue и проверь требования

**См. `.cursor/AGENT_COMMON_RULES.md` для деталей**

## Стиль работы

- **ОБЯЗАТЕЛЬНО используй oapi-codegen** для генерации кода из OpenAPI спецификаций
- **ОБЯЗАТЕЛЬНО указывай Issue в начале каждого файла:** `// Issue: #123`
- Следуй Go best practices
- Используй структурированное логирование (JSON)
- Экспортируй метрики на `/metrics`
- Health checks через `/health`
- Dependency injection где возможно
- Маленькие классы (300-400 строк максимум)
- **КРИТИЧЕСКИ ВАЖНО: НЕ создавай файлы больше 500 строк!** Если файл превышает 500 строк, разбей его на несколько файлов
- **НЕ редактируй сгенерированный код** - реализуй бизнес-логику в отдельных файлах

## SOLID принципы

**ОБЯЗАТЕЛЬНО соблюдай SOLID:**

**SRP:** Каждый файл - одна ответственность. **НЕ пиши middleware и handlers в `http_server.go`!**

**OCP:** Используй интерфейсы для расширяемости

**LSP:** Реализации интерфейсов взаимозаменяемы, используй DI

**ISP:** Маленькие, специфичные интерфейсы

**DIP:** Зависимости через интерфейсы, DI в конструкторах

**Структура:**
- `http_server.go` - ТОЛЬКО настройка сервера и роутера
- `middleware.go` - ВСЕ middleware функции
- `handlers.go` - ВСЕ handlers (ServerInterface)
- `service.go` - бизнес-логика
- `repository.go` - работа с БД

**НЕПРАВИЛЬНО:** middleware и handlers в `http_server.go`

**ПРАВИЛЬНО:** разделение на отдельные файлы, middleware из `middleware.go`, handlers из `handlers.go`
    api.HandlerWithOptions(handlers, api.ChiServerOptions{
        BaseURL:    "/api/v1",
        BaseRouter: router,
    })
    
    // Health check
    router.Get("/health", healthCheck)
    
    return &HTTPServer{
        addr:   addr,
        router: router,
        service: service,
    }
}
```

### Чек-лист структуры кода

При создании или рефакторинге сервиса проверь:

- [ ] `http_server.go` содержит ТОЛЬКО настройку сервера и роутера
- [ ] Все middleware функции вынесены в `middleware.go`
- [ ] Все handlers вынесены в `handlers.go`
- [ ] Бизнес-логика вынесена в `service.go`
- [ ] Работа с БД вынесена в `repository.go`
- [ ] Каждый файл не превышает 500 строк
- [ ] Используется dependency injection через конструкторы
- [ ] Интерфейсы определены для всех зависимостей

### WARNING ВАЖНО: Dockerfile паттерн

Все Dockerfile унифицированы: используй multi-stage build, Go 1.24-alpine, security context (non-root user appuser), health checks на `/metrics`, статическая линковка. Для сервисов с proto/ используй контекст из корня (context: .), без proto/ - из директории сервиса.

### Dockerfile с генерацией кода

**ОБЯЗАТЕЛЬНО** обнови Dockerfile для включения генерации кода перед сборкой:

```dockerfile
FROM golang:1.24-alpine AS builder

WORKDIR /app

RUN apk add --no-cache make nodejs npm

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN make generate-api || true

RUN go mod tidy
RUN CGO_ENABLED=0 GOOS=linux go build -o {service-name} -ldflags="-w -s" .

FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

COPY --from=builder /app/{service-name} /app/

EXPOSE {port}/tcp {metrics-port}

ENTRYPOINT ["/app/{service-name}"]
```

**Важно:**
- Установка `make`, `nodejs`, `npm` для генерации кода
- `RUN make generate-api || true` - генерация кода с игнорированием ошибок (на случай если спецификация еще не готова)
- Генерация происходит перед `go mod tidy` и сборкой

### Миграция существующих сервисов на генерацию

**Процесс миграции:**

1. **Проверь наличие OpenAPI спецификации:**
   - Убедись, что спецификация существует в `proto/openapi/{service-name}.yaml`
   - Проверь, что спецификация валидна: `make verify-api`

2. **Определи тип роутера:**
   - Если используется `github.com/go-chi/chi/v5` → используй `chi-server`
   - Если используется `github.com/gorilla/mux` → используй `gorilla-server` или перейди на chi

3. **Создай файлы для генерации:**
   - Скопируй улучшенный `Makefile` и адаптируй под имя сервиса
   - Создай `oapi-codegen.yaml` с нужной конфигурацией
   - Создай `.gitignore` для bundled файлов

4. **Сгенерируй код:**
   ```bash
   cd services/{service}-go
   make generate-api
   ```

5. **Мигрируй handlers:**
   - Создай структуру handlers, реализующую `api.ServerInterface`
   - Перенеси бизнес-логику из старых handlers
   - Используй сгенерированные типы вместо ручных моделей
   - Удали старые модели из `models/`, если они дублируют сгенерированные

6. **Обнови HTTP сервер:**
   - Используй `api.HandlerWithOptions()` для интеграции
   - Удали ручную регистрацию routes
   - Вынеси ВСЕ middleware в `middleware.go`
   - `http_server.go` должен ТОЛЬКО настраивать сервер и регистрировать middleware/handlers

7. **Проверь компиляцию:**
   ```bash
   go build ./...
   go test ./...
   ```

8. **Обнови зависимости:**
   - Убедись, что `go.mod` содержит необходимые зависимости
   - Для chi: `github.com/go-chi/chi/v5`
   - Для oapi-codegen: `github.com/oapi-codegen/runtime`

**Важно при миграции:**
- Сохрани существующую бизнес-логику
- Не удаляй тесты сразу - адаптируй их под новую структуру
- Проверь совместимость с существующим кодом
- Убедись, что API endpoints остаются теми же

## Формат вывода

- Go код в соответствующих сервисах
- Тесты рядом с кодом
- Миграции в `infrastructure/liquibase/`

## Git коммиты

**См. `.cursor/AGENT_COMMON_RULES.md` для формата коммитов**

**Формат:** `[backend] {type}: {description}\n\n{details}\n\nRelated Issue: #{number}`

**Типы:** `feat:`, `fix:`, `test:`, `refactor:`, `docs:`

**Когда:** После реализации endpoint, исправления бага, добавления тестов, рефакторинга

## Запреты

- НЕ создавай клиентский код (UE5)
- НЕ настраивай инфраструктуру (Docker/K8s)
- НЕ оптимизируй сетевой код (это Network Engineer)
- **НЕ обрабатывай контентные квесты** (передавай Content Writer)
- ТОЛЬКО бекенд реализация

## Миграция сервисов

**Скрипты:** `scripts/add-codegen-deps.sh`, `scripts/validate-codegen.sh`, `scripts/update-makefiles.sh`

**Чек-лист после генерации:**
- [ ] `Makefile`, `oapi-codegen.yaml`, `.gitignore` созданы
- [ ] `Dockerfile` обновлен, `go.mod` обновлен
- [ ] `make verify-api` → `make generate-api` → `go build` → `go test` → `docker build`
- [ ] Коммит с префиксом `[backend]`, указан Issue
