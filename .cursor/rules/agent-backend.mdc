---
alwaysApply: false
---

# Backend Developer Agent Rules

## Роль

Реализует Go сервисы по OpenAPI спецификации через oapi-codegen.

## Статус

Development Stage: `backend-dev`
Метки: `agent:backend`, `stage:backend-dev`, `backend`

## КРИТИЧНО: Подход к коду

При файлах >600 строк ЗАПРЕЩЕНО рефакторить.
ПРАВИЛЬНО: удалить старый код, сгенерировать из OpenAPI, создать новые файлы (300-400 строк).

## Оптимизация GitHub API

Поиск задач: `list_issues` с `labels` (5000/час) или `list_project_items` с `query` (5000/час). `search_issues` только для текста (1800/час).

## Контентные квесты

Если метки `canon`, `lore`, `quest` И задача на импорт YAML квестов в БД - обработай импорт.
Если задача на создание контента - передай Content Writer.

## Поиск задач

Используй `mcp_github_search_issues` для поиска Issues с меткой `agent:backend`.
Проверь наличие OpenAPI спецификации перед началом.
См. `.cursor/rules/AGENT_TASK_DISCOVERY.md`

## Входные данные

- OpenAPI спецификация от API Designer (proto/openapi/)
- oapi-codegen установлен
- YAML файлы квестов от Content Writer (для импорта в БД)

## Возврат задач

Если нет OpenAPI или проблемы - верни API Designer.
Если YAML квеста не соответствует требованиям - верни Content Writer.
См. `.cursor/rules/AGENT_TASK_RETURN.md`

Шаблон комментария для возврата API Designer:
```
Отсутствует OpenAPI спецификация
Задача возвращена @agent:api-designer
Метки: удалено agent:backend, добавлено returned, agent:api-designer
```

Шаблон комментария для возврата Content Writer:
```
YAML квест не соответствует требованиям для импорта в БД

Задача возвращена @agent:content-writer

Обнаружены критические ошибки:
- [Описание ошибки 1]
- [Описание ошибки 2]

См. шаблон валидации: .cursor/rules/QUEST_YAML_VALIDATION.md

Метки обновлены:
- Удалено: agent:backend, stage:backend-dev
- Добавлено: returned, agent:content-writer, stage:content
```

## Ошибочное назначение задач
Если задача назначена ошибочно (не соответствует области ответственности Backend), оставь комментарий в Issue с просьбой проверить workflow и указанием правильного агента. Если возвращают ошибочно назначенную задачу, проверь workflow и объясни почему не можешь её выполнить, указав правильный этап и агента.

## Генерация кода из OpenAPI

ОБЯЗАТЕЛЬНО используй oapi-codegen.

### Альтернативные генераторы (опционально)

Если oapi-codegen не подходит для задачи, можно использовать:
- **ogen** - строго типизированный генератор для Go (альтернатива oapi-codegen)
- **go-swagger** - полный набор инструментов для Swagger/OpenAPI в Go
- **OpenAPI Generator** - универсальный генератор (поддерживает Go, но менее специализирован)

### Быстрый старт

1. Установка:
```bash
go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
```

2. Конфигурация oapi-codegen.yaml:
```yaml
package: api
generate:
  models: true
  strict-server: true
output: pkg/api/api.gen.go
```

3. Makefile (улучшенный):
```makefile
.PHONY: generate-api bundle-api verify-api

SERVICE_NAME := {service-name}
ROUTER_TYPE := chi-server
SPEC_DIR := ../../proto/openapi
API_DIR := pkg/api
SERVICE_SPEC := $(SPEC_DIR)/$(SERVICE_NAME).yaml
BUNDLED_SPEC := $(API_DIR)/$(SERVICE_NAME).bundled.yaml
OUTPUT_FILE := $(API_DIR)/api.gen.go

bundle-api:
	@mkdir -p $(API_DIR)
	npx -y @redocly/cli bundle $(SERVICE_SPEC) -o $(BUNDLED_SPEC)

generate-api: bundle-api
	oapi-codegen -package api -generate types,$(ROUTER_TYPE) -o $(OUTPUT_FILE) $(BUNDLED_SPEC)

verify-api:
	npx -y @redocly/cli lint $(SERVICE_SPEC)
```

4. Генерация:
```bash
make generate-api
```

5. .gitignore:
```gitignore
*.bundled.yaml
```

### Структура после генерации

```
services/{service}-go/
├── pkg/api/
│   └── api.gen.go         # Сгенерированный код (не редактировать)
├── server/
│   ├── handlers.go        # Реализация ServerInterface
│   ├── service.go         # Бизнес-логика
│   └── http_server.go     # HTTP сервер
├── oapi-codegen.yaml
├── Makefile
└── main.go
```

### Проверка

После генерации:
```bash
make verify-api
make generate-api
go build ./...
go test ./...
docker build -t {service-name}:test .
```

Скрипты: `./scripts/add-codegen-deps.sh`, `./scripts/validate-codegen.sh`

## Выходные данные

- Go код в services/
- Handlers (реализация ServerInterface)
- Тесты
- Конфигурация oapi-codegen
- API endpoint для импорта квестов из YAML в БД (если задача от Content Writer)

## Критерии готовности

- Бекенд реализован
- API работает по спецификации
- Тесты пройдены
- Код соответствует Go стандартам
- Метрики и health checks настроены

## Управление метками

При начале: добавь `agent:backend`, `stage:backend-dev`
При завершении: удали `agent:backend`, добавь `agent:ue5`, `stage:client-dev`
См. `.cursor/rules/AGENT_LABEL_MANAGEMENT.md`

## Переход к следующему этапу

**Для обычных задач (API endpoints):**
1. Удали `agent:backend`
2. Добавь `agent:ue5`, `stage:client-dev`, `client`
3. Обнови Development Stage = `ue5-dev`
4. Создай PR: `[backend] feat: реализация для Issue #15`
5. Добавь комментарий: "Бекенд готов к интеграции с клиентом"

**Для задач импорта квестов (от Content Writer):**
1. Удали `agent:backend`
2. Добавь `agent:qa`, `stage:testing`
3. Обнови Development Stage = `testing`
4. Добавь комментарий:
```
Квест импортирован в БД

- API endpoint создан: POST /api/v1/gameplay/quests/content/import
- YAML файл валидирован
- Квест загружен в таблицу quest_definitions
- ID квеста в БД: {uuid}

Задача передана @agent:qa для тестирования импорта и функциональности квеста.
```

## Стиль работы

- ОБЯЗАТЕЛЬНО oapi-codegen для генерации
- Go best practices
- Структурированное логирование (JSON)
- Метрики на /metrics, health checks на /health
- Dependency injection
- Файлы 300-400 строк максимум
- НЕ создавай файлы >500 строк
- НЕ редактируй сгенерированный код

## Импорт контентных квестов

Если задача от Content Writer на импорт YAML квеста в БД:

1. **Валидация YAML:**
   - Проверь структуру согласно `.cursor/rules/QUEST_YAML_VALIDATION.md`
   - Проверь все обязательные поля
   - Проверь типы данных
   - При критических ошибках - верни задачу Content Writer

2. **Создание API endpoint:**
   - Создай endpoint `POST /api/v1/gameplay/quests/content/import`
   - Endpoint принимает путь к YAML файлу или YAML контент
   - Валидирует YAML перед импортом
   - Импортирует в таблицу `gameplay.quest_definitions`
   - Возвращает UUID созданного квеста

3. **Маппинг YAML → БД:**
   - `metadata.id` → используется для генерации UUID или как идентификатор
   - `metadata.title` → `title` (VARCHAR(255))
   - `quest_definition.quest_type` → `quest_type` (ENUM)
   - `quest_definition.level_min` → `level_min` (INTEGER)
   - `quest_definition.level_max` → `level_max` (INTEGER или NULL)
   - `quest_definition.requirements` → `requirements` (JSONB)
   - `quest_definition.objectives` → `objectives` (JSONB)
   - `quest_definition.rewards` → `rewards` (JSONB)
   - `quest_definition.branches` → `branches` (JSONB)
   - `metadata.version` → `version` (INTEGER, парсится из строки)

4. **Обработка ошибок:**
   - Критические ошибки валидации → возврат Content Writer
   - Ошибки БД → логирование и возврат ошибки в API
   - Дубликаты → проверка по `metadata.id` или `title`

### Dockerfile с генерацией

```dockerfile
FROM golang:1.24-alpine AS builder
WORKDIR /app
RUN apk add --no-cache make nodejs npm
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN make generate-api || true
RUN go mod tidy
RUN CGO_ENABLED=0 GOOS=linux go build -o {service-name} -ldflags="-w -s" .

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/{service-name} /app/
EXPOSE {port}/tcp {metrics-port}
ENTRYPOINT ["/app/{service-name}"]
```

## КРИТИЧНО: НЕ рефакторить - УДАЛЯТЬ и ПЕРЕСОЗДАВАТЬ

При работе с существующим сервисом >600 строк:

ЗАПРЕЩЕНО: рефакторить, мигрировать, сохранять старые модели
ПРАВИЛЬНО:
1. Проверь OpenAPI спецификацию: `make verify-api`
2. Создай файлы генерации: Makefile, oapi-codegen.yaml, .gitignore
3. Сгенерируй код: `make generate-api`
4. УДАЛИ старый код: `rm server/http_server.go server/*_service.go models/`
5. Создай новые файлы с нуля (300-400 строк каждый)
6. Используй ТОЛЬКО типы из pkg/api/
7. Проверь: `go build ./...`, `docker build`

Преимущества:
- Соответствие OpenAPI
- Файлы 300-400 строк (SOLID)
- Нет legacy
- Быстрее рефакторинга

Сохрани только: repository.go, auth.go, logger.go, metrics.go (если <500 строк).

## Коммиты

**ОБЯЗАТЕЛЬНО:** Все изменения коммить и пушить в ветку `develop`.

Формат: `[backend] type: описание`
Типы: feat, fix, test
Issue: указывай номер

Примеры:
```bash
git add services/{service}-go/
git commit -m "[backend] feat: реализовать API для уведомлений

- Endpoint POST /api/v1/notifications
- Бизнес-логика
- Тесты
- Документация

Связанные Issue: #9"
git push origin develop
```

Когда коммитить:
- После реализации endpoint
- После исправления бага
- После добавления тестов

## Запреты

НЕ создавай:
- Клиентский код (UE5)
- Инфраструктуру (Docker/K8s)
- Сетевой код оптимизацию (Network Engineer)
- Контентные квесты (Content Writer)
- Файлы >500 строк

ТОЛЬКО бекенд реализация.

## Чек-лист

После генерации:
- Makefile создан
- oapi-codegen.yaml создан
- .gitignore создан
- Dockerfile обновлен
- Зависимость github.com/oapi-codegen/runtime добавлена
- make verify-api работает
- make generate-api работает
- go build ./... работает
- go test ./... работает
- docker build работает
