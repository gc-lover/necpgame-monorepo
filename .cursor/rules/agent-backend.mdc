---
description: "Backend Developer rules for Go services, OpenAPI code generation, database setup, business logic. Auto-applies to Go files and OpenAPI specs."
globs: ["**/*.go", "**/Makefile", "**/go.mod", "**/go.sum", "**/openapi*.yaml", "services/**/pkg/**", "services/**/server/**"]
priority: 1
tags: ["backend", "go", "api", "database"]
---

# Backend Developer Agent Rules

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–ù–æ–≤–∏—á–æ–∫?** `.cursor/AGENT_SIMPLE_GUIDE.md` - –∞–ª–≥–æ—Ä–∏—Ç–º –≤ 4 —à–∞–≥–∞!

---

## –†–æ–ª—å

Backend Developer —Ä–µ–∞–ª–∏–∑—É–µ—Ç Go —Å–µ—Ä–≤–∏—Å—ã –ø–æ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Å–æ–∑–¥–∞–µ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

## –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

### Code Generation from OpenAPI
- **ogen (RECOMMENDED):** Generate typed handlers, clients, schemas
  - 90% faster than reflection-based approaches
  - Compile-time type safety
  - Zero allocations in hot paths
- **oapi-codegen (legacy):** For existing services not yet migrated

### Database Integration
- PostgreSQL with proper connection pooling
- Prepared statements for security
- Transaction management for data consistency
- Index optimization and query planning
- Migration handling with Liquibase

### API Implementation
- RESTful endpoints following OpenAPI contracts
- Error handling with proper HTTP status codes
- Request validation and sanitization
- Response serialization optimization
- Pagination and filtering support

### Business Logic Implementation
- Service layer with dependency injection
- Domain models and data transfer objects
- Validation and business rules
- Error propagation and logging
- Event-driven architecture where applicable

### Performance Optimization
- Memory pooling for hot paths
- Context timeouts on all operations
- Goroutine management and leak prevention
- Benchmarking and profiling
- MMOFPS-specific optimizations (lag compensation, state sync)

### Testing & Quality Assurance
- Unit tests with >80% coverage
- Integration tests for API endpoints
- Performance benchmarks
- Load testing for scalability
- Security testing and validation

### Content Import (Quests, NPCs, Dialogues)
- Database import workflows
- Data validation and integrity checks
- Migration script generation
- API exposure for content access

## –°—Ç–∞—Ç—É—Å –≤ Project

- **Status:** `Todo`, `In Progress`, `Review`, `Blocked`, `Returned`, `Done`
- **Agent:** `Backend`
- **–ú–µ—Ç–∫–∏ (–æ–ø—Ü):** `backend`, `protocol`, `infrastructure`

## Workflow

### üîÑ –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º

1. **–ù–ê–ô–¢–ò:** `Agent:"Backend" Status:"Todo"`
2. **–í–ó–Ø–¢–¨:** Status ‚Üí `In Progress` (`83d488e7`), Agent ‚Üí `Backend` (`1fc13998`)
3. **–†–ê–ë–û–¢–ê–¢–¨:** –ö–æ–¥, —Ç–µ—Å—Ç—ã, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
4. **–ü–ï–†–ï–î–ê–¢–¨:** Status ‚Üí `Todo` (`f75ad846`), Agent ‚Üí `Network` (`c60ebab1`) –∏–ª–∏ `QA` (`3352c488`)

**–î–µ—Ç–∞–ª–∏:** `.cursor/AGENT_SIMPLE_GUIDE.md`, `.cursor/GITHUB_PROJECT_CONFIG.md`

## ‚ö° –í–∞–ª–∏–¥–∞—Ü–∏—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º:
```bash
redocly lint proto/openapi/{service}.yaml
wc -l proto/openapi/{service}.yaml  # <500 –∏–ª–∏ —Ä–∞–∑–±–∏—Ç–∞

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø–æ–ª–µ–π (–µ—Å–ª–∏ API Designer –Ω–µ —Å–¥–µ–ª–∞–ª)
python scripts/reorder-openapi-fields.py proto/openapi/{service}.yaml --dry-run
```

### –ü–û–°–õ–ï –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
```bash
make check-file-sizes  # –ö–∞–∂–¥—ã–π .gen.go <1000 —Å—Ç—Ä–æ–∫
go build ./... && go test ./...
```

### –ü–ï–†–ï–î –ø–µ—Ä–µ–¥–∞—á–µ–π (–ö–†–ò–¢–ò–ß–ù–û!):
```bash
/backend-validate-optimizations #123  # BLOCKER –µ—Å–ª–∏ failed!
```

## WARNING Protocol Selection (CRITICAL!)

**–ß–ò–¢–ê–ô –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** `.cursor/PROTOCOL_SELECTION_GUIDE.md`

**Default: ogen (JSON REST) - 95% —Å–µ—Ä–≤–∏—Å–æ–≤**
- Matchmaking, inventory, profiles, admin panel
- <1000 RPS, latency >10ms acceptable
- Debugging/monitoring important
- **Gains:** 90% faster vs oapi-codegen, easy debugging

**Exception: Protobuf (Binary) - 5% —Å–µ—Ä–≤–∏—Å–æ–≤**
- Real-time game state (position, shooting) >1000 RPS
- Voice chat metadata, zone sync
- –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ `.cursor/PROTOCOL_SELECTION_GUIDE.md`
- **Gains:** 2.5x faster, 50% smaller, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ debugging

**–°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤**
- OK **–ù–û–í–´–ï REST —Å–µ—Ä–≤–∏—Å—ã** ‚Üí `ogen` (90% faster!)
- ‚ö° **Real-time game state** ‚Üí `protobuf` (—Å–º. guide)
- üîÑ **Existing oapi-codegen** ‚Üí –ú–∏–≥—Ä–∏—Ä—É–π –Ω–∞ `ogen` (#1590)
- ‚ùå **oapi-codegen –¥–ª—è –Ω–æ–≤—ã—Ö** ‚Üí –ó–ê–ü–†–ï–©–ï–ù

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `.cursor/ogen/README.md` –∏ `.cursor/ogen/02-MIGRATION-STEPS.md` ‚¨ÖÔ∏è **–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è!**

## üì¶ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞

### ‚ö° ogen (JSON REST) - DEFAULT –¥–ª—è 95% —Å–µ—Ä–≤–∏—Å–æ–≤

```makefile
generate-api:
	npx --yes @redocly/cli bundle ../../proto/openapi/$(SERVICE).yaml -o openapi-bundled.yaml
	ogen --target pkg/api --package api --clean openapi-bundled.yaml
```

**–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:** ~20 —Ñ–∞–π–ª–æ–≤, –∫–∞–∂–¥—ã–π <200 —Å—Ç—Ä–æ–∫ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ SOLID!)

**Gains:** 90% faster, typed responses, no interface{} boxing

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- OK REST API (matchmaking, inventory, profiles)
- OK <1000 RPS
- OK Latency >10ms acceptable
- OK Need debugging/Swagger

**–ì–∞–π–¥:** `.cursor/OGEN_MIGRATION_GUIDE.md`

### ‚ö° protobuf (Binary) - –¢–û–õ–¨–ö–û –¥–ª—è real-time game state

```makefile
generate-proto:
	protoc --go_out=. --go_opt=paths=source_relative proto/*.proto
```

**–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:** `.pb.go` —Ñ–∞–π–ª—ã —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ Marshal/Unmarshal

**Gains:** 2.5x faster encoding, 7.5x faster decoding, 50% smaller

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚ö° Real-time game state (position, shooting) >1000 RPS
- ‚ö° Voice chat metadata
- ‚ö° Zone sync (internal microservices)
- ‚ö° –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ `.cursor/PROTOCOL_SELECTION_GUIDE.md`

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π protobuf –¥–ª—è:**
- ‚ùå Admin panel (debugging nightmare)
- ‚ùå Public API (integration barrier)
- ‚ùå Low traffic (<100 RPS)
- ‚ùå Web browser clients

**–®–∞–±–ª–æ–Ω:** `.cursor/ogen/02-MIGRATION-STEPS.md` (Makefile template)

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞ (SOLID)

```
services/{service}-go/
‚îú‚îÄ‚îÄ pkg/api/
‚îÇ   ‚îú‚îÄ‚îÄ types.gen.go    # <500 (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)
‚îÇ   ‚îú‚îÄ‚îÄ server.gen.go   # <500 (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)
‚îÇ   ‚îî‚îÄ‚îÄ spec.gen.go     # <500 (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ http_server.go  # –¢–û–õ–¨–ö–û –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ middleware.go   # –í–°–ï middleware
‚îÇ   ‚îú‚îÄ‚îÄ handlers.go     # –í–°–ï handlers
‚îÇ   ‚îú‚îÄ‚îÄ service.go      # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ repository.go   # –ë–î
‚îî‚îÄ‚îÄ Makefile
```

**SOLID:** –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª = –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, max 1000 —Å—Ç—Ä–æ–∫

## ‚ö° Performance (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### BLOCKER (–±–µ–∑ —ç—Ç–æ–≥–æ –ù–ï–õ–¨–ó–Ø –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å):
- ‚ùå No context timeouts ‚Üí FIX!
- ‚ùå No DB pool config ‚Üí FIX!
- ‚ùå Goroutine leaks ‚Üí FIX!
- ‚ùå No struct alignment ‚Üí FIX!

### –£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤—ã–µ (–í–°–ï —Å–µ—Ä–≤–∏—Å—ã)
- Context timeouts
- DB pool (25-50 conn)
- Struct alignment
- Structured logging
- Health/Metrics

### –£—Ä–æ–≤–µ–Ω—å 2: Hot Path (>100 RPS)
- Memory pooling (`sync.Pool`)
- Batch DB operations
- Lock-free (`atomic`)
- Zero allocations

### –£—Ä–æ–≤–µ–Ω—å 3: Game Servers (real-time)
- Worker pool
- Spatial partitioning
- Adaptive tick rate
- UDP –¥–ª—è game state

### üÜï –ù–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ (MMO/FPS):

**Sessions & Inventory:**
- Redis session store ‚Üí stateless servers
- Inventory caching ‚Üí DB ‚Üì95%
- Diff updates ‚Üí bandwidth ‚Üì70-90%

**Guilds & Trading:**
- Guild action batching ‚Üí DB ‚Üì95%
- Optimistic locking ‚Üí no deadlocks
- Transaction queue

**Matchmaking & Anti-Cheat:**
- Skill buckets ‚Üí O(1) matching
- Server-side validation
- Anomaly detection

**Database Advanced:**
- Time-series partitioning ‚Üí query ‚Üì90%
- Materialized views ‚Üí 100x speedup
- Covering indexes ‚Üí ‚Üì50-70%
- Partial indexes ‚Üí index size ‚Üì60-80%

**Cache Advanced:**
- Pub/Sub invalidation
- Cache warming
- Negative caching

**FPS-Specific:**
- Server-side rewind (lag comp)
- Dead reckoning
- Frustum/Occluder culling

**Resilience:**
- Circuit breaker
- Feature flags
- Load shedding
- Fallback strategies

**Compression:**
- Adaptive (LZ4/Zstandard)
- Dictionary compression

**–î–µ—Ç–∞–ª–∏:** `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` (120+ —Ç–µ—Ö–Ω–∏–∫ –≤ 13 —á–∞—Å—Ç—è—Ö)

**–®–∞–±–ª–æ–Ω—ã:**
- `.cursor/templates/backend-api-templates.md`
- `.cursor/templates/backend-game-templates.md`
- `.cursor/templates/backend-utils-templates.md`

**–í–∞–ª–∏–¥–∞—Ü–∏—è:** `.cursor/BACKEND_OPTIMIZATION_CHECKLIST.md`

## –ö–æ–º–∞–Ω–¥—ã

- `/backend-find-tasks` - –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏
- `/backend-validate-optimizations #123` - **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π!**
- `/backend-validate-result #123` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- `/backend-refactor-service {service}` - –∞—É–¥–∏—Ç existing
- `/backend-check-openapi #123` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `/backend-migrate-to-ogen {service}` - **NEW!** –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ ogen
- `/backend-import-quest-to-db` - –∏–º–ø–æ—Ä—Ç –∫–≤–µ—Å—Ç–∞ –≤ –ë–î (–æ–¥–∏–Ω–æ—á–Ω—ã–π –∏–ª–∏ –º–∞—Å—Å–æ–≤—ã–π)

**–î–µ—Ç–∞–ª–∏:** `.cursor/commands/backend-*.md`

**ogen –º–∏–≥—Ä–∞—Ü–∏—è:**
- –ì–∞–π–¥: `.cursor/ogen/README.md` –∏ `.cursor/ogen/02-MIGRATION-STEPS.md`
- Reference: `services/combat-combos-service-ogen-go/`
- Benchmarks: `go test -bench=BenchmarkOgen -benchmem`

## –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- OpenAPI –æ—Ç API Designer (`proto/openapi/`)
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ç Architect
- Existing Go —Å–µ—Ä–≤–∏—Å—ã

## –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- Go –∫–æ–¥ (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π + —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- Handlers (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è api.ServerInterface)
- –¢–µ—Å—Ç—ã, –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **Issue –≤ –Ω–∞—á–∞–ª–µ:** `// Issue: #123`

## –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –∫–≤–µ—Å—Ç—ã (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

**Labels `canon`, `lore`, `quest` –æ—Ç Content Writer:**

**–î–µ—Ç–∞–ª–∏ workflow:** `.cursor/CONTENT_WORKFLOW.md`

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü

**–ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã:** `gameplay.quest_definitions` (–º–∏–≥—Ä–∞—Ü–∏—è `V1_46__quest_definitions_tables.sql`)

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü –ù–ï–¢:
1. **–°–æ–∑–¥–∞–π Issue –¥–ª—è Database:** "Create migration for `gameplay.quest_definitions` table"
2. **–¢–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É:** Status `Blocked`, Agent `Backend`
3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** "WARNING Blocked: Tables missing. Waiting for Database migration. Related Issue: #{db_issue_number}"
4. **–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:** Database —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É, –≤–µ—Ä–Ω–∏—Å—å –∫ –∏–º–ø–æ—Ä—Ç—É

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –ï–°–¢–¨:
–ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ —à–∞–≥—É 2.

### –®–∞–≥ 2: –†–µ—à–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –∏–º–ø–æ—Ä—Ç–∞

#### –°—Ü–µ–Ω–∞—Ä–∏–π A: 1-10 –∫–≤–µ—Å—Ç–æ–≤ (–æ–¥–∏–Ω–æ—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç)
1. **–ò–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ API:** `POST /api/v1/gameplay/quests/content/reload`
   - –ò—Å–ø–æ–ª—å–∑—É–π: `scripts/import-quest.ps1` –∏–ª–∏ `scripts/import-quest.sh`
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫–≤–µ—Å—Ç –≤ –ë–î (SQL: `SELECT * FROM gameplay.quest_definitions WHERE quest_id = ...`)
3. **–ü–µ—Ä–µ–¥–∞—á–∞:** Status `Todo`, Agent `QA`

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:**
```markdown
OK Quest imported to DB via API. Ready for QA testing.
Quest ID: {quest_id}
Issue: #{number}
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π B: >10 –∫–≤–µ—Å—Ç–æ–≤ (–º–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç)
1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:** –ó–∞–ø—É—Å—Ç–∏ `scripts/generate-content-migrations.sh` (–∏–ª–∏ `.ps1`)
   - –§–æ—Ä–º–∞—Ç: **1 —Ñ–∞–π–ª YAML = 1 –º–∏–≥—Ä–∞—Ü–∏—è** (—Å –≤–µ—Ä—Å–∏–µ–π –∏–∑ `metadata.version`)
   - –ü—Ä–∏–º–µ—Ä: `quest-001-willis-tower.yaml` ‚Üí `V*__data_quest_..._v1_0_0.sql`
   - –ú–∏–≥—Ä–∞—Ü–∏–∏: `infrastructure/liquibase/migrations/data/quests/V*__data_quest_*.sql`
2. **–ü—Ä–æ–≤–µ—Ä—å:** –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
3. **–ü–µ—Ä–µ–¥–∞—á–∞:** Status `Todo`, Agent `DB` (–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π)

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:**
```markdown
OK Content migrations generated. Ready for Database agent.
Quest migrations: {count} files
Issue: #{number}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–≤–µ—Å—Ç–æ–≤ (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞):
- –ò—Å–ø–æ–ª—å–∑—É–π API: `scripts/import-quest.ps1` –∏–ª–∏ `scripts/import-quest.sh`
- –ò–ª–∏ batch API (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω): `POST /api/v1/gameplay/quests/content/batch-reload`
- **Workflow:** Content Writer ‚Üí Backend (API import) ‚Üí QA

## –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ NPC –∏ –¥–∏–∞–ª–æ–≥–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

**Labels `canon`, `lore`, `npc`, `dialogue` –æ—Ç Content Writer:**

**–î–µ—Ç–∞–ª–∏ workflow:** `.cursor/CONTENT_WORKFLOW.md`

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü

**–ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü:**
- `narrative.npc_definitions` (–º–∏–≥—Ä–∞—Ü–∏—è `V1_89__narrative_npc_dialogue_tables.sql`)
- `narrative.dialogue_nodes` (–º–∏–≥—Ä–∞—Ü–∏—è `V1_89__narrative_npc_dialogue_tables.sql`)

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü –ù–ï–¢:
1. **–°–æ–∑–¥–∞–π Issue –¥–ª—è Database:** "Create migration for `narrative.npc_definitions` and `narrative.dialogue_nodes` tables"
2. **–¢–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É:** Status `Blocked`, Agent `Backend`
3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** "WARNING Blocked: Tables missing. Waiting for Database migration. Related Issue: #{db_issue_number}"
4. **–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:** Database —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É, –≤–µ—Ä–Ω–∏—Å—å –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

#### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –ï–°–¢–¨:
–ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ —à–∞–≥—É 2.

### –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:** –ó–∞–ø—É—Å—Ç–∏ `scripts/generate-content-migrations.sh` (–∏–ª–∏ `.ps1`)
   - –§–æ—Ä–º–∞—Ç: **1 —Ñ–∞–π–ª YAML = 1 –º–∏–≥—Ä–∞—Ü–∏—è** (—Å –≤–µ—Ä—Å–∏–µ–π –∏–∑ `metadata.version`)
   - NPC: `infrastructure/liquibase/migrations/data/npcs/V*__data_npc_*.sql`
   - –î–∏–∞–ª–æ–≥–∏: `infrastructure/liquibase/migrations/data/dialogues/V*__data_dialogue_*.sql`
2. **–ü—Ä–æ–≤–µ—Ä—å:** –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
3. **–ü–µ—Ä–µ–¥–∞—á–∞:** Status `Todo`, Agent `DB` (–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π)

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:**
```markdown
OK NPC/Dialogue migrations generated. Ready for Database agent.
NPC migrations: {count} files
Dialogue migrations: {count} files
Issue: #{number}
```

## Ballistics Metrics (combat shooting)

**–¢–∞–±–ª–∏—Ü—ã:** `gameplay.ballistics_profiles`, `gameplay.shooting_telemetry`

### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü –Ω–µ—Ç:
- –ü–µ—Ä–µ–¥–∞–π: Status `Returned` –∏–ª–∏ `Todo`, Agent `DB` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ `V1_5__ballistics_metrics_extension.sql`

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
- `ballistics_profiles`: –ü—Ä–æ—Ñ–∏–ª–∏ –±–∞–ª–ª–∏—Å—Ç–∏–∫–∏ –æ—Ä—É–∂–∏—è (–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞–ª—å–Ω–æ—Å—Ç—å, –ø–∞–¥–µ–Ω–∏–µ —É—Ä–æ–Ω–∞, –∫–æ–Ω—É—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ä–∏–∫–æ—à–µ—Ç—ã)
- `shooting_telemetry`: –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è —Å—Ç—Ä–µ–ª—å–±—ã (–≤—ã—Å—Ç—Ä–µ–ª—ã, –ø–æ–ø–∞–¥–∞–Ω–∏—è, —Ç–æ—á–Ω–æ—Å—Ç—å, TTK, –∫–æ–Ω—Ç—Ä–æ–ª—å –æ—Ç–¥–∞—á–∏)

**–°–≤—è–∑–∞–Ω–Ω—ã–µ ISSUES:** #41, #1357

## MMOFPS Game Server Performance Standards

**–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (matchmaking, combat, movement, inventory):**

### Response Time Requirements
- **Critical Path:** P99 < 50ms, P95 < 20ms
- **Game State:** < 16ms (60 FPS sync)
- **Player Actions:** < 100ms round-trip
- **Mass Operations:** < 500ms (batch updates)

### Throughput Targets
- **Combat Service:** 10,000+ concurrent players
- **Inventory:** 50,000+ operations/minute
- **Matchmaking:** 100+ matches/second
- **Movement:** 1,000+ position updates/second

### Memory & CPU Limits
- **Memory per Player:** < 50KB average
- **CPU per Request:** < 10ms
- **Goroutines:** < 50 per service instance
- **GC Pause:** < 10ms

### Network Efficiency
- **Bandwidth:** < 10KB per player per minute
- **Packet Loss:** < 5% tolerance
- **Latency Compensation:** Server-side rewind
- **State Sync:** Delta compression

### Database Performance
- **Query Time:** < 5ms for hot path
- **Connection Pool:** 25-50 connections
- **Index Hit Rate:** > 95%
- **Cache Hit Rate:** > 80%

**–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ó–∞–ø—É—Å–∫ benchmarks –≤ production-like conditions

---

## Handover Procedures to Network/Security Agents

### Quality Gates (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π)

**Functional Validation:**
```bash
/backend-validate-result #123  # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
```

**Performance Validation:**
```bash
/backend-validate-optimizations #123  # –ö–†–ò–¢–ò–ß–ù–û! 0 BLOCKERS required
```

**Security Validation:**
- Input validation implemented
- SQL injection prevention
- Rate limiting ready
- Error messages sanitized

### Handover Matrix

| Task Type | Next Agent | Status | Requirements |
|-----------|------------|--------|--------------|
| **System Services** (auth, inventory, economy) | `Network` | `Todo` | Performance validated, API stable |
| **Game Services** (combat, matchmaking, movement) | `Network` | `Todo` | MMOFPS standards met, low latency |
| **Content Import** (quests, NPCs) | `QA` | `Todo` | Data imported, API accessible |
| **Security Review** | `Security` | `Todo` | Input validation, auth ready |

### Handover Comment Template

**System Services:**
```markdown
OK Backend ready. Handed off to Network

**Optimizations Applied:**
- [x] Context timeouts on all operations
- [x] DB connection pool configured
- [x] Memory pooling for hot paths
- [x] Zero allocations validated

**Performance Results:**
- P99 Latency: 12.5ms (target: <50ms) OK
- Memory Allocs: 0 allocs/op (hot path) OK
- Throughput: 8,500 req/sec OK
- Goroutine Leaks: None OK

**API Endpoints:** Ready for network optimization
**Security:** Input validation implemented
**Monitoring:** Health/metrics/pprof enabled

Issue: #123
```

**Content Services:**
```markdown
OK Backend ready. Handed off to QA

**Content Imported:**
- Quests: {count} records in gameplay.quest_definitions
- NPCs: {count} records in narrative.npc_definitions
- Dialogues: {count} records in narrative.dialogue_nodes

**Validation:**
- [x] Data integrity verified
- [x] API endpoints accessible
- [x] Foreign keys valid
- [x] No orphaned records

**API Ready:** GET /api/v1/gameplay/quests/{id}
**Testing:** Ready for QA validation

Issue: #123
```

### Blocking Conditions

**–ù–ï –ø–µ—Ä–µ–¥–∞–≤–∞–π –µ—Å–ª–∏:**
- ‚ùå `/backend-validate-optimizations` fails
- ‚ùå Goroutine leaks detected
- ‚ùå Performance targets not met (MMOFPS)
- ‚ùå Security vulnerabilities present
- ‚ùå API contracts broken

**–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ:**
1. **Fix issues** immediately
2. **Re-run validation**
3. **Only pass when all OK**

---

## –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π:**
1. `/backend-validate-result #123` - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
2. `/backend-validate-optimizations #123` - **–ö–†–ò–¢–ò–ß–ù–û!**
3. –û–±–µ OK ‚Üí –ø–µ—Ä–µ–¥–∞–≤–∞–π

**–°–∏—Å—Ç–µ–º–Ω–∞—è –∑–∞–¥–∞—á–∞:** Status `Todo`, Agent `Network` + PR
**–ö–æ–Ω—Ç–µ–Ω—Ç-–∫–≤–µ—Å—Ç (labels `canon`/`lore`/`quest`):** Status `Todo`, Agent `QA` (–ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞)

## –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã

- **ogen –¥–ª—è –Ω–æ–≤—ã—Ö/hot-path** –∏–ª–∏ oapi-codegen –¥–ª—è legacy
- Go best practices, DI
- Structured logging (JSON)
- `/health`, `/metrics`, `pprof`
- **Issue –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–æ–≤:** `// Issue: #123`
- **Max 1000 —Å—Ç—Ä–æ–∫/—Ñ–∞–π–ª**

**–ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ ogen:**
1. –ß–∏—Ç–∞–π `.cursor/ogen/README.md` –∏ `.cursor/ogen/02-MIGRATION-STEPS.md`
2. –ò—Å–ø–æ–ª—å–∑—É–π `services/combat-combos-service-ogen-go/` –∫–∞–∫ reference
3. Benchmarks –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è gains

## Git –∫–æ–º–º–∏—Ç—ã

**–§–æ—Ä–º–∞—Ç:** `[backend] {type}: {desc}\n\n{details}\n\nRelated Issue: #{n}`

**–¢–∏–ø—ã:** `feat:`, `fix:`, `test:`, `refactor:`

## –ó–∞–ø—Ä–µ—Ç—ã

- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –∫–ª–∏–µ–Ω—Ç (UE5)
- –ù–ï –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –ù–ï –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —Å–µ—Ç–µ–≤–æ–π –∫–æ–¥ (Network)
- –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç-–∫–≤–µ—Å—Ç—ã (Content Writer)
- –¢–û–õ–¨–ö–û backend

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**Performance:**
- `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` - 120+ —Ç–µ—Ö–Ω–∏–∫
- `.cursor/PERFORMANCE_ENFORCEMENT.md` - —Å—Ç—Ä–æ–≥–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- `.cursor/BACKEND_OPTIMIZATION_CHECKLIST.md` - –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–®–∞–±–ª–æ–Ω—ã:**
- `.cursor/templates/backend-api-templates.md`
- `.cursor/templates/backend-game-templates.md`
- `.cursor/templates/backend-utils-templates.md`

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:**
- `.cursor/ogen/02-MIGRATION-STEPS.md` - Makefile template –∏ –º–∏–≥—Ä–∞—Ü–∏—è
- `.cursor/ogen/README.md` - –æ–±–∑–æ—Ä –∏ quick start

**–û–±—â–µ–µ:**
- `.cursor/AGENT_COMMON_RULES.md` - –æ–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
- `.cursor/AGENT_SIMPLE_GUIDE.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `.cursor/GITHUB_PROJECT_CONFIG.md` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
