---
description: "Backend Developer rules for Go services, OpenAPI code generation, database setup, business logic. Auto-applies to Go files and OpenAPI specs."
globs: ["**/*.go", "**/Makefile", "**/go.mod", "**/go.sum", "**/openapi*.yaml", "services/**/pkg/**", "services/**/server/**"]
priority: 1
tags: ["backend", "go", "api", "database"]
---

# Backend Developer Agent Rules

## üöÄ Quick Start
**New?** See `.cursor/AGENT_QUICK_START.md` (4 steps).

## Role
Implement Go services using **Enterprise-grade Domain Architecture**, OpenAPI contracts, and optimize for MMOFPS performance.

## üõ†Ô∏è Code Generation (Enterprise-Grade)
**CRITICAL:** All new services use Domain Architecture with optimizations.

### scripts (REQUIRED)
```bash
# 1. Validation
python scripts/openapi/validate-domains-openapi.py --domain {domain}

# 2. Struct Alignment (30-50% memory savings)
python scripts/batch-optimize-openapi-struct-alignment.py proto/openapi/{service}-service/main.yaml

# 3. Generate Service (Domain Inheritance)
python scripts/generation/enhanced_service_generator.py --spec proto/openapi/{service}-service/main.yaml

# 4. Batch Generation (All Domains)
python scripts/generate-all-domains-go.py --parallel 3 --memory-pool
```
**Benefits:** Domain inheritance, strict typing, optimistic locking, memory pooling, zero allocs.

### Generators
1.  **ogen (Recommended):** JSON REST. 90% faster than reflection. Use for System/Meta services (<1000 RPS).
    *   mig: `.cursor/ogen/README.md`
2.  **Protobuf (Binary):** Real-time Game State (>1000 RPS). Position, shooting.
3.  **oapi-codegen (Legacy):** Existing only. New services MUST use `ogen`.

## üîÑ Workflow
–°–º. `AGENT_QUICK_START.md` –¥–ª—è –æ–±—â–µ–≥–æ workflow.

**Backend —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞:**
- –í–∑—è—Ç—å: `Agent:"Backend" Status:"Todo"`
- –ü–µ—Ä–µ–¥–∞—Ç—å: `Agent:"Network"` –∏–ª–∏ `Agent:"QA"`

## üîÑ GitHub MCP Integration

### –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á Backend

```javascript
// –ú–ï–¢–û–î 1: GitHub Projects API (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
mcp_github_list_project_items({
  owner_type: 'user',
  owner: 'gc-lover',
  project_number: 1,
  query: 'Agent:"Backend" Status:"Todo"'
});

// –ú–ï–¢–û–î 2: GitHub Issues API (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)
mcp_github_list_issues({
  owner: 'gc-lover',
  repo: 'necpgame-monorepo',
  state: 'open'
});
// –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ: title —Å–æ–¥–µ—Ä–∂–∏—Ç '[Backend]' –∏–ª–∏ status = Todo
```

### –í–∑—è—Ç–∏–µ –∑–∞–¥–∞—á

```javascript
mcp_github_update_project_item({
  owner_type: 'user',
  owner: 'gc-lover',
  project_number: 1,
  item_id: item_id,
  updated_field: [
    {id: '239690516', value: '83d488e7'}, // Status: In Progress
    {id: '243899542', value: '1fc13998'}, // Agent: Backend
    {id: '246469155', value: '08174330'}, // Type: BACKEND
    {id: '246468990', value: '22932cc7'}  // Check: 0
  ]
});
```

### –ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞–¥–∞—á

```javascript
mcp_github_update_project_item({...});
mcp_github_add_issue_comment({
  owner: 'gc-lover',
  repo: 'necpgame-monorepo',
  issue_number: issue_number,
  body: '[OK] Backend implementation complete. Handed off to Network.\\n\\nIssue: #123'
});
```

## ‚úÖ Validation (MANDATORY)
**BEFORE Coding:**
*   Validate OpenAPI: `python scripts/validate-domains-openapi.py`
*   Optimize Structs: `python scripts/batch-optimize-openapi-struct-alignment.py --dry-run`

**AFTER Generation:**
*   Validate Migrations: `python scripts/validate-all-migrations.py`
*   Build & Test: `go test ./...`
*   Bench: `go test -bench=. -benchmem`

**BEFORE Handover (BLOCKER):**
*   **Run:** `/backend-validate-optimizations #123`
*   **Must pass:** No allocations in hot paths, Configured timeouts, DB pool.
*   **Run:** `/backend-validate-result #123` (Functional)

## ‚ö° Performance Standards (MMOFPS)
**Targets:**
*   **Critical Path:** P99 < 50ms
*   **Game State:** < 16ms
*   **Allocations:** 0 allocs/op (hot path)
*   **DB:** < 5ms query, Pool 25-50 conns

**Techniques:**
1.  **Level 1 (All):** Context timeouts, Struct alignment, Object pooling.
2.  **Level 2 (>100 RPS):** Batch DB, Lock-free, Zero allocs.
3.  **Level 3 (Game):** Spatial partition, UDP, Delta compression.
*   *Guide:* `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md`

## üì¶ Service Structure (SOLID)
`services/{service}-go/`
*   `pkg/api/`: Generated types/server `<500 lines`
*   `server/http_server.go`: Setup only
*   `server/middleware.go`: All middleware
*   `server/handlers.go`: Implementation
*   `server/service.go`: Business Logic
*   `server/repository.go`: DB Access

## üîß Code Generation Standards (–ö–†–ò–¢–ò–ß–ù–û!)

### OpenAPI Spec Generation
**STRICT RULES - violations cause compilation failures:**

1. **Domain Separation:** Use `.cursor/templates/openapi-service-template.yaml` template
2. **Struct Alignment:** Order fields Large‚ÜíSmall (30-50% memory savings)
3. **SOLID/DRY Inheritance:** Use `allOf` and `$ref` to `common/schemas/{domain}-entities.yaml`, NO field duplication
   - –ù–∞—Å–ª–µ–¥—É–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è (id, timestamps, version) —á–µ—Ä–µ–∑ `allOf` –∏ `$ref`
   - –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Å–µ—Ä–≤–∏—Å–∞
   - –ù–ï –¥—É–±–ª–∏—Ä—É–µ–º –æ–±—â–∏–µ –ø–æ–ª—è –∏–∑ domain entities
4. **Performance Hints:** Add backend optimization notes in comments

### ogen Generation (REQUIRED)
```bash
# 1. Generate from bundled spec
python scripts/openapi/bundle-openapi-spec.py proto/openapi/{domain}/main.yaml > services/{service}-go/openapi-bundled.yaml

# 2. Generate API code (ALWAYS use this)
ogen --package api --target pkg/api --config ogen.yml openapi-bundled.yaml

# 3. Fix imports (CRITICAL!)
sed -i 's|services/.*-go/|necpgame/services/\{service\}-go/|g' pkg/api/*.go
```

### Import Path Standards (–ö–†–ò–¢–ò–ß–ù–û!)
**ALL imports MUST use full module paths:**

```go
// [OK] CORRECT - Full module path
import (
    "necpgame/services/guild-service-go/internal/service"
    "necpgame/services/guild-service-go/pkg/api"
)

// [ERROR] WRONG - Relative imports cause issues
import (
    "guild-service-go/internal/service"  // BROKEN!
    "../pkg/api"                         // BROKEN!
)
```

**Why:** Relative imports break when moving files, cause confusion, and fail in different environments.

### Interface/Implementation Sync (–ö–†–ò–¢–ò–ß–ù–û!)
**Repository Interface MUST match Implementation:**

```go
// repository.go - Interface
type Repository interface {
    GetGuild(ctx context.Context, id uuid.UUID) (*api.Guild, error)
    // NO methods with missing implementations!
}

// repository.go - Implementation
func (r *PostgresRepository) GetGuild(ctx context.Context, id uuid.UUID) (*api.Guild, error) {
    // Implementation exists
}
```

**PROHIBITED:** Methods in interface without implementation = compilation failure!

### Type Prefix Consistency (–ö–†–ò–¢–ò–ß–ù–û!)
**api. vs no prefix - BE CONSISTENT:**

```go
// [OK] CORRECT - Interface uses api. prefix
type Repository interface {
    GetGuild(ctx context.Context, id uuid.UUID) (*api.Guild, error)
}

// [OK] CORRECT - Implementation matches
func (r *PostgresRepository) GetGuild(ctx context.Context, id uuid.UUID) (*api.Guild, error)
```

**PROHIBITED:** Mixed prefixes cause undefined type errors!

### Generation Workflow (MANDATORY)
```bash
# 1. Update OpenAPI spec
edit proto/openapi/{domain}/main.yaml

# 2. Bundle external refs
python scripts/openapi/bundle-openapi-spec.py proto/openapi/{domain}/main.yaml > temp.yaml

# 3. Generate (ALWAYS use config)
ogen --config ogen.yml --package api --target pkg/api temp.yaml

# 4. Fix imports (automate this!)
find pkg/api -name "*.go" -exec sed -i 's|services/.*-go/|necpgame/services/{service}-go/|g' {} \;

# 5. Clean temp files
rm temp.yaml
```

### Avoiding Import Issues (CHECKLIST)
- [ ] **Full module paths only:** `necpgame/services/...`
- [ ] **No relative imports:** `../pkg/api` forbidden
- [ ] **Interface matches implementation:** Same method signatures
- [ ] **Consistent type prefixes:** All `api.` or none
- [ ] **Generated code cleaned:** Imports fixed after ogen
- [ ] **Test compilation:** `go build .` after generation

## üìú Content Import (Quests/NPCs)
**Labels:** `canon`, `lore`, `quest`, `npc`

### 1. Check Tables
Ensure tables exist (e.g., `gameplay.quest_definitions`, `narrative.npc_definitions`).
*   **If missing:** Create DB Issue -> Status `Blocked` (Backend).

### 2. Import Method
*   **Single (1-10):** API Import via `scripts/import-quest.ps1`.
    *   *To QA:* `Todo`
*   **Batch (>10):** Generate Migrations via `scripts/generate-content-migrations.sh`.
    *   *To DB:* `Todo` (Apply migrations)

## üí¨ API Commands
*   `/backend-find-tasks`
*   `/backend-validate-optimizations #issue` (**CRITICAL**)
*   `/backend-validate-result #issue`
*   `/backend-migrate-to-ogen {service}`
*   `/backend-import-quest-to-db`

## üöß Handover Procedures
**To Network (System/Game Services):**
*   Perf/Func/Security Validated.
*   Comment needs: P99 stats, Alloc stats, Throughput.

**To QA (Content):**
*   Data imported, API verified (`GET /api/v1/...`).
*   Comment includes count of records.

## üö´ Constraints
*   **NO** Client code (UE5).
*   **NO** Infra/DevOps tasks.
*   **NO** Network Protocol optimization (Network Agent).
*   **NO** Creative writing (Content Agent).

## üìö –°—Å—ã–ª–∫–∏
- `MCP_GITHUB_GUIDE.md` - —Ä–∞–±–æ—Ç–∞ —Å GitHub Projects
- `PERFORMANCE_ENFORCEMENT.md` - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º
- `.cursor/templates/openapi-service-template.yaml` - OpenAPI —à–∞–±–ª–æ–Ω
- `.cursor/templates/go-service-main-template.go` - Go service main.go —à–∞–±–ª–æ–Ω
- `.cursor/templates/README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —à–∞–±–ª–æ–Ω–∞–º
