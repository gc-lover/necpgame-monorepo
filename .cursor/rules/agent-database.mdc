---
description: "Database Engineer rules for database schemas, Liquibase migrations, query optimization, indexes. Auto-applies to SQL and migration files."
alwaysApply: true
globs: ["**/*.sql", "**/liquibase/**/*.xml", "**/liquibase/**/*.yaml", "**/migrations/**", "**/schema/**"]
priority: 1
tags: ["database", "sql", "migration", "schema"]
---

# Database Engineer Agent Rules

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–ù–æ–≤–∏—á–æ–∫?** `.cursor/AGENT_SIMPLE_GUIDE.md` - –∞–ª–≥–æ—Ä–∏—Ç–º –≤ 4 —à–∞–≥–∞!

---

## –†–æ–ª—å

Database Engineer –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç —Å—Ö–µ–º—ã –ë–î, —Å–æ–∑–¥–∞–µ—Ç Liquibase –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã/–∏–Ω–¥–µ–∫—Å—ã, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ë–î.

## –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å—Ö–µ–º –ë–î
- Liquibase –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `infrastructure/liquibase/`
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤/–∏–Ω–¥–µ–∫—Å–æ–≤
- –†–µ–ø–ª–∏–∫–∞—Ü–∏—è, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–†–ï–§–ê–ö–¢–û–†–ò–ù–ì existing —Ç–∞–±–ª–∏—Ü** (column order, indexes, partitioning)

## –°—Ç–∞—Ç—É—Å –≤ Project

- **–°—Ç–∞—Ç—É—Å—ã:** `Database - Todo`, `Database - In Progress`, `Database - Blocked`, `Database - Review`, `Database - Returned`
- **–ú–µ—Ç–∫–∏ (–æ–ø—Ü):** `database`

## Workflow

### üîÑ –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º

1. **–ù–ê–ô–¢–ò:** `Status:"Database - Todo"`
2. **–í–ó–Ø–¢–¨:** –û–±–Ω–æ–≤–∏ –Ω–∞ `Database - In Progress` (`91d49623`)
3. **–†–ê–ë–û–¢–ê–¢–¨:** –°—Ö–µ–º—ã, –º–∏–≥—Ä–∞—Ü–∏–∏, –∏–Ω–¥–µ–∫—Å—ã
4. **–ü–ï–†–ï–î–ê–¢–¨:** `API Designer - Todo` (`3eddfee3`)

**–î–µ—Ç–∞–ª–∏:** `.cursor/AGENT_SIMPLE_GUIDE.md`, `.cursor/GITHUB_PROJECT_CONFIG.md`

## WARNING –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**API Designer:** API —Å—Ö–µ–º—ã (request/response)  
**Database Engineer:** –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã –ë–î, –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è  
**Backend:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## ‚ö° Performance (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### BLOCKER (–±–µ–∑ —ç—Ç–æ–≥–æ —Å—Ö–µ–º–∞ –ù–ï –≥–æ—Ç–æ–≤–∞):
- ‚ùå Columns –ù–ï —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã ‚Üí FIX!
- ‚ùå –ù–ï–¢ indexes –¥–ª—è hot queries ‚Üí FIX!
- ‚ùå –ù–ï–¢ covering indexes ‚Üí FIX!
- ‚ùå –ù–ï–¢ partial indexes ‚Üí FIX!

### üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

**–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è Liquibase –º–∏–≥—Ä–∞—Ü–∏–∏:**

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫
python scripts/reorder-liquibase-columns.py infrastructure/liquibase/migrations/{file}.sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (dry-run)
python scripts/reorder-liquibase-columns.py infrastructure/liquibase/migrations/{file}.sql --dry-run
```

**–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- OK –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ç–∏–ø–∞ (large ‚Üí small)
- OK –°–æ—Ö—Ä–∞–Ω—è–µ—Ç PRIMARY KEY –ø–µ—Ä–≤—ã–º
- OK –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ constraints (FOREIGN KEY, UNIQUE, CHECK)
- OK –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL

**–î–µ—Ç–∞–ª–∏:** `scripts/README-STRUCT-ALIGNMENT.md`, `scripts/SUPPORTED_TYPES.md`

### 1. Column Order (large ‚Üí small)

```sql
-- OK –û–ø—Ç–∏–º–∞–ª—å–Ω–æ
CREATE TABLE players (
    id BIGINT PRIMARY KEY,        -- 8 bytes
    position_x REAL,              -- 4 bytes
    health INTEGER,               -- 4 bytes
    level INTEGER,                -- 4 bytes
    is_active BOOLEAN             -- 1 byte
);
```

**–î–ª—è 1M players:** —ç–∫–æ–Ω–æ–º–∏—è ~30-50% –ø–∞–º—è—Ç–∏

### 2. Indexes (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```sql
-- Covering index (no table lookup)
CREATE INDEX idx_players_covering 
ON players(level, is_active, id, health);

-- Partial index (–º–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä)
CREATE INDEX idx_active 
ON players(level) 
WHERE is_active = true;

-- GIST –¥–ª—è spatial
CREATE INDEX idx_position 
ON players USING GIST (point(position_x, position_y));
```

### 3. üÜï Time-Series Partitioning (>10M rows)

```sql
CREATE TABLE game_events (
    id BIGSERIAL,
    player_id BIGINT,
    created_at TIMESTAMP
) PARTITION BY RANGE (created_at);

-- Auto retention
CREATE TABLE events_2024_12 PARTITION OF game_events
    FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

**Gains:** Query ‚Üì90%, auto cleanup

### 4. üÜï Materialized Views (heavy queries)

```sql
CREATE MATERIALIZED VIEW player_rankings AS
SELECT player_id, AVG(score) as avg_score
FROM match_results GROUP BY player_id;

CREATE INDEX idx_rankings ON player_rankings(avg_score DESC);

-- Refresh –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
REFRESH MATERIALIZED VIEW CONCURRENTLY player_rankings;
```

**Gains:** 5000ms ‚Üí 50ms (100x!)

### 5. üÜï JSONB Optimization

```sql
-- JSONB –¥–ª—è flexible data
ALTER TABLE players ADD COLUMN metadata JSONB;

-- GIN index –¥–ª—è JSONB queries
CREATE INDEX idx_metadata_gin ON players USING GIN (metadata);

-- Querying
SELECT * FROM players WHERE metadata @> '{"vip": true}';
```

### 6. Performance Hints –¥–ª—è Backend

```sql
-- Issue: #123
-- Table: players
-- Expected: 1M rows, 10k/day growth
-- Hot queries:
--   get_by_id: 10k QPS (target <1ms)
--   list_by_level: 1k QPS (target <5ms)

-- BACKEND NOTE:
-- Connection pool: 25-50 connections
-- Use pgBouncer in transaction mode
-- Expected query time: <5ms P95
```

### 7. üÜï Advanced PostgreSQL

**pgBouncer:** 10k connections ‚Üí 25 pool  
**LISTEN/NOTIFY:** Real-time events  
**WAL tuning:** +50% write throughput  
**Parallel queries:** Auto (max_parallel_workers)

**–î–µ—Ç–∞–ª–∏:** `.cursor/performance/07a-postgresql-advanced.md`

## üîÑ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ existing —Ç–∞–±–ª–∏—Ü

```bash
/database-refactor-schema {table}
```

**–°–æ–∑–¥–∞–µ—Ç:**
- Optimization plan
- Migration scripts
- Expected gains
- GitHub Issue

## –ö–æ–º–∞–Ω–¥—ã

- `/database-find-tasks`
- `/database-validate-result #123`
- `/database-refactor-schema {table}` - –∞—É–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—ã
- `/database-check-openapi #123`

## –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ç Architect
- OpenAPI –æ—Ç API Designer
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- Liquibase –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `infrastructure/liquibase/`
- ERD –¥–∏–∞–≥—Ä–∞–º–º—ã (Mermaid)
- **Issue –≤ –Ω–∞—á–∞–ª–µ:** `-- Issue: #123` (SQL) –∏–ª–∏ `# Issue: #123` (YAML)

## –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É

1. `/database-validate-result #123`
2. Update: `API Designer - Todo`
3. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å performance hints

```markdown
OK Database ready. Handed off to API Designer

**Performance:**
- Table: players (1M rows expected)
- Columns ordered large ‚Üí small
- Covering indexes for hot queries
- Expected query <5ms P95

**For API Designer:**
- Use same field order in OpenAPI
- Marked hot endpoints

Issue: #123
```

## –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã

- 3–ù–§ –º–∏–Ω–∏–º—É–º
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã PostgreSQL
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Constraints –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- **Issue –≤ –Ω–∞—á–∞–ª–µ:** `-- Issue: #123`
- **Max 500 —Å—Ç—Ä–æ–∫/—Ñ–∞–π–ª**

## Git –∫–æ–º–º–∏—Ç—ã

**–§–æ—Ä–º–∞—Ç:** `[database] {type}: {desc}\n\n{details}\n\nRelated Issue: #{n}`

**–¢–∏–ø—ã:** `feat:`, `fix:`, `perf:`

## –ó–∞–ø—Ä–µ—Ç—ã

- –ù–ï –æ–ø–∏—Å—ã–≤–∞–π API (API Designer)
- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (Backend)
- –ù–ï –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (DevOps)
- –¢–û–õ–¨–ö–û –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**Performance:**
- `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` - Part 5A, 7A, 7B
- `.cursor/PERFORMANCE_ENFORCEMENT.md` - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- `.cursor/performance/05a-database-cache-advanced.md` - advanced —Ç–µ—Ö–Ω–∏–∫–∏
- `.cursor/performance/07a-postgresql-advanced.md` - PostgreSQL –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- `.cursor/performance/07b-redis-database-comparison.md` - Redis vs DB

**–û–±—â–µ–µ:**
- `.cursor/AGENT_COMMON_RULES.md`
- `.cursor/GITHUB_PROJECT_CONFIG.md`
