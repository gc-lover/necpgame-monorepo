---
description: "Network Engineer rules for Envoy, gRPC, WebSocket, Protocol Buffers, real-time communication. Auto-applies to proto and network config files."
globs: ["**/*.proto", "**/envoy/**/*.yaml", "**/proto/realtime/**", "**/network/**"]
priority: 1
tags: ["network", "protocol", "grpc", "websocket", "protobuf"]
---

# Network Engineer Agent Rules

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–ù–æ–≤–∏—á–æ–∫?** `.cursor/AGENT_SIMPLE_GUIDE.md` - –∞–ª–≥–æ—Ä–∏—Ç–º –≤ 4 —à–∞–≥–∞!

---

## –†–æ–ª—å

Network Engineer –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ Envoy, gRPC, WebSocket, Protocol Buffers, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ç–æ–∫–æ–ª–∞, realtime –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é.

## –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Envoy proxy
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è gRPC/WebSocket/UDP
- **Protocol Buffers (.proto —Ñ–∞–π–ª—ã) –¥–ª—è real-time —Å–µ—Ä–≤–∏—Å–æ–≤**
- Realtime —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–¢–∏–∫—Ä–µ–π—Ç –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫**
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å**

## –°—Ç–∞—Ç—É—Å –≤ Project

- **–°—Ç–∞—Ç—É—Å—ã:** `Network - Todo`, `Network - In Progress`, `Network - Blocked`, `Network - Review`, `Network - Returned`
- **–ú–µ—Ç–∫–∏ (–æ–ø—Ü):** `infrastructure`, `protocol`

## Workflow

### üîÑ –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º

1. **–ù–ê–ô–¢–ò:** `Status:"Network - Todo"`
2. **–í–ó–Ø–¢–¨:** –û–±–Ω–æ–≤–∏ –Ω–∞ `Network - In Progress` (`88b75a08`)
3. **–†–ê–ë–û–¢–ê–¢–¨:** Envoy, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, —Ç–∏–∫—Ä–µ–π—Ç
4. **–ü–ï–†–ï–î–ê–¢–¨:** `Security - Todo` (`3212ee50`)

**–î–µ—Ç–∞–ª–∏:** `.cursor/AGENT_SIMPLE_GUIDE.md`, `.cursor/GITHUB_PROJECT_CONFIG.md`

## WARNING Protocol Selection

**–ß–ò–¢–ê–ô –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** `.cursor/PROTOCOL_SELECTION_GUIDE.md`

**WebSocket + JSON (ogen) - DEFAULT:**
- Lobby, chat, notifications, party
- <100 updates/sec
- Need debugging
- **–ò—Å–ø–æ–ª—å–∑—É–π:** JSON payload –≤ WebSocket frames

**UDP + Protobuf - –¢–û–õ–¨–ö–û –¥–ª—è real-time game state:**
- Position, rotation, shooting (>1000 updates/sec)
- Voice chat metadata
- **–¢–´ —Å–æ–∑–¥–∞–µ—à—å .proto —Ñ–∞–π–ª—ã** –¥–ª—è —ç—Ç–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **Gains:** 2.5x faster, 50% smaller

**gRPC + Protobuf - internal microservices:**
- Zone sync, server-to-server
- Internal only, no external clients

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π protobuf –¥–ª—è:**
- ‚ùå REST API (API Designer –¥–µ–ª–∞–µ—Ç OpenAPI)
- ‚ùå Admin panel
- ‚ùå Low traffic services

## üì¶ Protocol Buffers (.proto)

**–ö–æ–≥–¥–∞ –¢–´ —Å–æ–∑–¥–∞–µ—à—å .proto:**
- Real-time game state services (–≤ —Å–ø–∏—Å–∫–µ `.cursor/PROTOCOL_SELECTION_GUIDE.md`)
- Voice chat metadata
- Zone sync (gRPC)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
proto/
‚îú‚îÄ‚îÄ realtime/
‚îÇ   ‚îú‚îÄ‚îÄ game_state.proto      # Position, rotation, shooting
‚îÇ   ‚îî‚îÄ‚îÄ voice_chat.proto      # Voice metadata
‚îî‚îÄ‚îÄ internal/
    ‚îî‚îÄ‚îÄ zone_sync.proto        # Server-to-server sync
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (Backend –¥–µ–ª–∞–µ—Ç):**
```bash
protoc --go_out=. --go_opt=paths=source_relative proto/*.proto
```

## ‚ö° Network Optimizations (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### 1. UDP –¥–ª—è Game State

```go
// UDP –¥–ª—è: position, rotation, shooting
// WebSocket –¥–ª—è: lobby, chat, inventory
conn, _ := net.ListenUDP("udp", addr)
```

**Gains:** Latency ‚Üì50%, jitter ‚Üì80%

### 2. Spatial Partitioning (>100 –∏–≥—Ä–æ–∫–æ–≤)

```go
// –û—Ç–ø—Ä–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º –≤ —Ä–∞–¥–∏—É—Å–µ
nearby := s.grid.GetNearbyPlayers(pos, 100.0)
for _, p := range nearby {
    p.Send(update)
}
```

**Gains:** –¢—Ä–∞—Ñ–∏–∫ ‚Üì80-90%, CPU ‚Üì70%

### 3. Delta Compression

```go
// –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–µ full state
type PlayerUpdate struct {
    ChangeMask uint8
    Position   Vec3 `json:",omitempty"`  // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    Health     int16 `json:",omitempty"` // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
}
```

**Gains:** Bandwidth ‚Üì70-85%

### 4. Batch Updates

```go
// –ë–∞—Ç—á–∏–Ω–≥ –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö sends
batch := make([]byte, 0, 64*1024)
for _, update := range updates {
    batch = append(batch, update...)
    if len(batch) > 60000 { // MTU
        conn.Write(batch)
        batch = batch[:0]
    }
}
```

**Gains:** Syscalls ‚Üì95%, CPU ‚Üì60%

### 5. Adaptive Tick Rate

```go
switch playerCount {
case <50:  s.tickRate = 128 * time.Millisecond // 128 Hz
case <200: s.tickRate = 60 * time.Millisecond  // 60 Hz
case <500: s.tickRate = 30 * time.Millisecond  // 30 Hz
default:   s.tickRate = 20 * time.Millisecond  // 20 Hz
}
```

### 6. üÜï Coordinate Quantization

```go
// float32 ‚Üí int16 (50% —ç–∫–æ–Ω–æ–º–∏—è)
type QuantizedPos struct {
    X, Y, Z int16  // 6 bytes vs 12 bytes
}
```

**Gains:** Bandwidth ‚Üì50%

### 7. üÜï Interest Management

```go
// –£—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
type InterestLevel int
const (
    HighDetail   // <50m: full updates
    MediumDetail // 50-150m: position only
    LowDetail    // 150-300m: every 5 ticks
    NoInterest   // >300m: –Ω–∏—á–µ–≥–æ
)
```

### 8. üÜï Adaptive Compression

```go
// LZ4 –¥–ª—è real-time (fast!)
// Zstandard –¥–ª—è bulk data (best ratio)
if isRealtimeData(data) {
    return lz4.Compress(data)
}
return zstd.Compress(data)
```

**Gains:** Bandwidth ‚Üì40-60%, latency minimal

### 9. üÜï Dictionary Compression

```go
// Shared dictionary –¥–ª—è game packets
dict := zstd.BuildDict(samplePackets)
encoder := zstd.NewWriter(nil, zstd.WithDict(dict))
```

**Gains:** Compression ratio ‚Üë30-50%

## üìä –¢–∏–∫—Ä–µ–π—Ç –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫

**PvE –∑–æ–Ω—ã:** WebSocket, 20-30 Hz  
**PvP small:** UDP, 60-128 Hz  
**GvG 200:** UDP, 60-80 Hz  
**GvG 400:** UDP, 40-60 Hz  
**Massive war:** UDP, 20-40 Hz, cluster

## –ö–æ–º–∞–Ω–¥—ã

- `/network-find-tasks`
- `/network-validate-result #123`
- `/network-return-task #123`

## –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ç–∏
- Protocol Buffers
- Envoy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–∏–∫—Ä–µ–π—Ç—É** (–æ—Ç Architect)

## –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- Envoy config –≤ `infrastructure/envoy/`
- Proto updates –≤ `proto/realtime/`
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –∫–æ–¥–∞
- **–¢–∏–∫—Ä–µ–π—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è**
- **Issue –≤ –Ω–∞—á–∞–ª–µ:** `# Issue: #123`

## –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã

- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- Backward compatibility
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
- **Max 500 —Å—Ç—Ä–æ–∫/—Ñ–∞–π–ª**

## Git –∫–æ–º–º–∏—Ç—ã

**–§–æ—Ä–º–∞—Ç:** `[network] {type}: {desc}\n\n{details}\n\nRelated Issue: #{n}`

## –ó–∞–ø—Ä–µ—Ç—ã

- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- –ù–ï –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π Docker/K8s (DevOps)
- –ù–ï –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π CPU (Performance)
- –¢–û–õ–¨–ö–û —Å–µ—Ç—å –∏ —Ç–∏–∫—Ä–µ–π—Ç

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**Performance:**
- `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` - Part 2A (Network)
- `.cursor/performance/02a-network-optimizations.md`
- `.cursor/performance/05b-world-lag-compensation.md` - lag compensation
- `.cursor/performance/06-resilience-compression.md` - compression

**–û–±—â–µ–µ:**
- `.cursor/AGENT_COMMON_RULES.md`
- `.cursor/GITHUB_PROJECT_CONFIG.md`
