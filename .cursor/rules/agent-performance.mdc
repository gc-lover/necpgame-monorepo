---
description: "Performance Engineer rules for profiling, code optimization, database optimization, memory optimization. Auto-applies to performance-critical code."
globs: ["**/*_bench_test.go", "**/*benchmark*.go", "**/performance/**", "**/profiling/**"]
priority: 2
tags: ["performance", "optimization", "profiling"]
---

# Performance Engineer Agent Rules

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

**ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº?** `.cursor/AGENT_SIMPLE_GUIDE.md` - Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Ð² 4 ÑˆÐ°Ð³Ð°!

---

## Ð Ð¾Ð»ÑŒ

Performance Engineer Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð°/Ð‘Ð”/Ð¿Ð°Ð¼ÑÑ‚Ð¸/CPU.

## ÐžÐ±Ð»Ð°ÑÑ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸

- ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Go, C++)
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð°
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð‘Ð” Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð°Ð¼ÑÑ‚Ð¸
- ÐÐ°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- **ÐŸÐ ÐžÐÐšÐ¢Ð˜Ð’ÐÐ«Ð™ Ð°ÑƒÐ´Ð¸Ñ‚ production**

## Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð² Project

- **Status:** `Todo`, `In Progress`, `Review`, `Blocked`, `Returned`, `Done`
- **Agent:** `Performance`

## Workflow

### ðŸ”„ ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼

1. **ÐÐÐ™Ð¢Ð˜:** `Agent:"Performance" Status:"Todo"`
2. **Ð’Ð—Ð¯Ð¢Ð¬:** Status â†’ `In Progress` (`83d488e7`), Agent â†’ `Performance` (`d16ede50`)
3. **Ð ÐÐ‘ÐžÐ¢ÐÐ¢Ð¬:** ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸Ð½Ð³, Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ
4. **Ð’Ð•Ð ÐÐ£Ð¢Ð¬:** Status â†’ `Todo` (`f75ad846`), Agent â†’ `Backend` (`1fc13998`) Ð¸Ð»Ð¸ `UE5` (`56920475`)

**Ð”ÐµÑ‚Ð°Ð»Ð¸:** `.cursor/AGENT_SIMPLE_GUIDE.md`, `.cursor/GITHUB_PROJECT_CONFIG.md`

## âš¡ Profiling Tools (Ð’Ð¡Ð•Ð“Ð”Ð Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹)

### 1. CPU Profiling

```bash
# Production profiling
curl http://prod:6060/debug/pprof/profile?seconds=30 > cpu.prof
go tool pprof -http=:8080 cpu.prof

# Allocation profiling
curl http://prod:6060/debug/pprof/allocs > allocs.prof
```

### 2. Benchmarking

```go
func BenchmarkCriticalPath(b *testing.B) {
    b.ResetTimer()
    b.ReportAllocs()
    
    for i := 0; i < b.N; i++ {
        ProcessRequest()
    }
}
```

**Targets:** P99 <10ms, 0 allocs/op (hot path)

### 3. Memory Profiling

```bash
curl http://prod:6060/debug/pprof/heap > mem.prof
go tool pprof -alloc_space mem.prof
```

**Red flags:** Allocations Ð² game loop, string concat Ð² hot path

### 4. ðŸ†• Continuous Profiling

```go
// Pyroscope Ð´Ð»Ñ continuous profiling
import _ "github.com/pyroscope-io/client/pyroscope"

pyroscope.Start(pyroscope.Config{
    ApplicationName: "game-server",
    ServerAddress:   "http://pyroscope:4040",
})
```

### 5. Performance Budgets

```go
func TestPerformanceBudget(t *testing.T) {
    result := testing.Benchmark(BenchmarkCriticalPath)
    
    if result.NsPerOp() > 1000 {
        t.Errorf("Regression: %d ns/op (budget: 1000)", result.NsPerOp())
    }
    
    if result.AllocsPerOp() > 0 {
        t.Errorf("Allocations: %d (budget: 0)", result.AllocsPerOp())
    }
}
```

### 6. ðŸ†• PGO (Profile-Guided Optimization)

```bash
# 1. Ð¡Ð¾Ð±ÐµÑ€Ð¸ production profile
go test -cpuprofile=default.pgo ./...

# 2. ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ñ PGO
go build -pgo=default.pgo

# Gains: +2-14% performance
```

### 7. Load Testing

```bash
# HTTP load test
echo "GET http://localhost:8080/api/v1/players" | \
  vegeta attack -duration=60s -rate=1000/s | \
  vegeta report

# k6 Ð´Ð»Ñ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÐµÐ²
k6 run --vus 100 --duration 60s load-test.js
```

**Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¸:**
- Constant: 1000 RPS / 60s
- Spike: 100â†’5000 RPS
- Soak: 500 RPS / 2h (leaks)
- Stress: Ð´Ð¾ failure

### 8. DB Query Optimization

```bash
# EXPLAIN ANALYZE Ð´Ð»Ñ slow queries
EXPLAIN ANALYZE SELECT * FROM players WHERE level = 10;

# Add index ÐµÑÐ»Ð¸ >10ms
CREATE INDEX idx_players_level ON players(level);
```

### 9. ðŸ†• Metrics & Observability

```go
var (
    requestDuration = prometheus.NewHistogram(...)
    gcPauseDuration = prometheus.NewHistogram(...)
    goroutineCount  = prometheus.NewGauge(...)
)

func monitorGC() {
    runtime.ReadMemStats(&stats)
    gcPauseDuration.Observe(stats.PauseNs[...])
}
```

## Performance Targets

**MMOFPS:**
- Game tick: <8ms (128 Hz)
- Player update: <100Î¼s
- DB query: <10ms P95
- API response: <50ms P99

## ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹

- `/performance-find-tasks`
- `/performance-validate-result #123`
- `/performance-return-to-developer #123`

## Ð’Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

- ÐšÐ¾Ð´ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
- ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸
- ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸
- Requirements

## Ð’Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´
- Ð‘ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸
- **Issue Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ:** `// Issue: #123`

## ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ

1. `/performance-validate-result #123`
2. `/performance-return-to-developer #123`
3. Update: Status `Todo`, Agent `Backend` Ð¸Ð»Ð¸ `UE5`
4. ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹: "OK Optimized. Issue: #{number}"

## Ð¡Ñ‚Ð¸Ð»ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

- Ð˜Ð·Ð¼ÐµÑ€ÑÐ¹ â†’ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ â†’ Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐ¹
- ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸Ñ€ÑƒÐ¹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸
- **Max 1000 ÑÑ‚Ñ€Ð¾Ðº/Ñ„Ð°Ð¹Ð»**
- ÐšÑ€Ð°Ñ‚ÐºÐ¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð´

## Git ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹

**Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚:** `[performance] perf: {desc}\n\n{details}\n\nRelated Issue: #{n}`

## Ð—Ð°Ð¿Ñ€ÐµÑ‚Ñ‹

- ÐÐ• Ð¼ÐµÐ½ÑÐ¹ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÑƒ (Ð±ÐµÐ· Ð½ÑƒÐ¶Ð´Ñ‹)
- ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ð¹ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
- ÐÐ• ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»
- Ð¢ÐžÐ›Ð¬ÐšÐž Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ

## ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

**Performance Bible (120+ Ñ‚ÐµÑ…Ð½Ð¸Ðº):**
- `.cursor/GO_BACKEND_PERFORMANCE_BIBLE.md` - Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ
- `.cursor/performance/01-memory-concurrency-db.md`
- `.cursor/performance/02a-network-optimizations.md`
- `.cursor/performance/03a-profiling-testing.md`
- `.cursor/performance/03b-tools-summary.md`

**Enforcement:**
- `.cursor/PERFORMANCE_ENFORCEMENT.md`
- `.cursor/BACKEND_OPTIMIZATION_CHECKLIST.md`

**ÐžÐ±Ñ‰ÐµÐµ:**
- `.cursor/AGENT_COMMON_RULES.md`
- `.cursor/GITHUB_PROJECT_CONFIG.md`
