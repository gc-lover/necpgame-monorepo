#!/bin/bash

if ! command -v bash >/dev/null 2>&1; then
  exit 0
fi

ALLOWED_BRANCH="develop"

if ! command -v git-lfs >/dev/null 2>&1; then
  LFS_CHECK=0
else
  if ! git lfs post-checkout "$@" 2>/dev/null; then
    LFS_CHECK=0
  else
    LFS_CHECK=1
  fi
fi

BRANCH_CHECKOUT="$3"
if [ "$BRANCH_CHECKOUT" = "1" ]; then
  CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || git branch --show-current 2>/dev/null || echo "")
  
  if [ -n "$CURRENT_BRANCH" ] && [ "$CURRENT_BRANCH" != "$ALLOWED_BRANCH" ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "[GIT_HOOK_ERROR] BRANCH_POLICY_VIOLATION"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "ERROR_TYPE: branch_policy_violation"
    echo "CURRENT_BRANCH: $CURRENT_BRANCH"
    echo "ALLOWED_BRANCH: $ALLOWED_BRANCH"
    echo "POLICY: Only 'develop' branch is allowed"
    echo ""
    echo "RESTRICTIONS:"
    echo "  - Branch creation is prohibited"
    echo "  - Branch switching is prohibited"
    echo "  - Only '$ALLOWED_BRANCH' branch can be used"
    echo ""
    echo "AUTOMATIC_ACTION: Switching back to '$ALLOWED_BRANCH' branch"
    echo ""
echo "FOR_AI_AGENTS:"
echo "  [WARNING] CRITICAL: You MUST NEVER leave the '$ALLOWED_BRANCH' branch!"
echo "  [WARNING] FORBIDDEN: Branch '$CURRENT_BRANCH' violates repository policy"
echo "  [WARNING] FORBIDDEN: Creating branches is PROHIBITED"
echo "  [WARNING] FORBIDDEN: Switching from '$ALLOWED_BRANCH' is PROHIBITED"
echo "  [WARNING] FORBIDDEN: 'git commit --no-verify' bypasses quality checks!"
echo "  [OK] REQUIRED: Only '$ALLOWED_BRANCH' branch is allowed"
echo "  [OK] REQUIRED: Never run 'git checkout -b' or 'git checkout <other-branch>'"
echo "  [OK] REQUIRED: Always work ONLY in '$ALLOWED_BRANCH' branch"
echo "  [OK] REQUIRED: ALL commits must pass architecture validation"
echo "  This repository enforces a strict policy: ONLY '$ALLOWED_BRANCH' branch is allowed."
echo "  You attempted to use '$CURRENT_BRANCH' which is automatically being corrected."
echo "  System is switching you back to '$ALLOWED_BRANCH' and deleting prohibited branch."
echo "  Do NOT attempt to create or switch to other branches. Stay in '$ALLOWED_BRANCH'."
echo "  Do NOT bypass quality checks with --no-verify. Fix validation errors instead."
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    if [ "$CURRENT_BRANCH" != "$ALLOWED_BRANCH" ]; then
      echo "[ERROR] Branch '$CURRENT_BRANCH' is not allowed. Please switch to '$ALLOWED_BRANCH' manually."
      echo "[ERROR] Branch deletion is forbidden for safety reasons."
      exit 1
    fi
  fi
fi

if [ "$LFS_CHECK" = "1" ]; then
  exit 0
fi

exit 0
