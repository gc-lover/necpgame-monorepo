#!/bin/bash

# Git Hook: Pre-commit protection against dangerous commands
# This hook prevents commits that might contain traces of dangerous git operations

echo "ðŸ” Git Safety Check: Scanning for dangerous command traces..."

# Check if any staged files contain dangerous git command patterns
# This catches cases where agents might have accidentally included command output

DANGEROUS_PATTERNS=(
    "git reset"
    "git clean"
    "git checkout --force"
    "git branch -D"
    "git push --force"
    "git rebase --abort"
    "git stash drop"
)

# Check staged files for dangerous patterns
DANGEROUS_FOUND=""
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Skip system files that contain safety documentation
        if [[ "$file" == .githooks/* ]] || [[ "$file" == .cursor/rules/* ]] || [[ "$file" == ACTIVATE-ABSOLUTE-PROTECTION.bat ]] || [[ "$file" == SYSTEM-GIT-BLOCKING-README.md ]] || [[ "$file" == install-system-git-blocker.bat ]] || [[ "$file" == uninstall-system-git-blocker.bat ]] || [[ "$file" == test-system-blocking.bat ]]; then
            continue
        fi
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" "$file" 2>/dev/null; then
                DANGEROUS_FOUND="$DANGEROUS_FOUND\n  - $pattern (in $file)"
            fi
        done
    fi
done

if [ -n "$DANGEROUS_FOUND" ]; then
    echo "ðŸš¨ CRITICAL SECURITY VIOLATION: DANGEROUS GIT COMMANDS DETECTED!"
    echo "AI AGENT SECURITY BREACH DETECTED!"
    echo "PROJECT SAFETY PROTOCOL ACTIVATED!"
    echo ""
    echo "FORBIDDEN COMMANDS DETECTED IN FILES:$DANGEROUS_FOUND"
    echo ""
    echo "WHY THIS IS BLOCKED:"
    echo "â€¢ git reset (any)  â†’ LOSES WORK irreversibly"
    echo "â€¢ git clean (any)  â†’ DELETES FILES permanently"
    echo "â€¢ git push --force â†’ DESTROYS shared history"
    echo "â€¢ git branch -D    â†’ DELETES branches permanently"
    echo ""
    echo "ðŸš« VIOLATION: Attempting to use destructive git commands"
    echo "ðŸš« RESULT: Commit BLOCKED for project safety"
    echo "ðŸš« ACTION: This is a SERIOUS SECURITY BREACH"
    echo ""
    echo "REQUIRED IMMEDIATE ACTION:"
    echo "1. STOP what you are doing"
    echo "2. Return task with security violation note"
    echo "3. DO NOT attempt to bypass this protection"
    echo "4. Contact human administrator if needed"
    echo ""
    echo "SAFE ALTERNATIVES INSTEAD:"
    echo "â€¢ To undo file changes:    git restore <file>"
    echo "â€¢ To undo last commit:     git revert HEAD"
    echo "â€¢ To clean safely:         git clean -n (preview first)"
    echo "â€¢ To force push safely:    git push --force-with-lease"
    echo ""
    echo "EDUCATION: Git reset/clean are powerful but DANGEROUS tools."
    echo "They can destroy hours/days/weeks of work instantly."
    echo "This protection saves your project from catastrophic loss."
    echo ""
    echo "SECURITY INCIDENT LOGGED - VIOLATION REPORTED"
    echo "COMMIT REJECTED - PROJECT PROTECTED"
    exit 1
fi

echo "OK Git Safety Check: No dangerous command traces found."
exit 0