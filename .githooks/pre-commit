#!/bin/bash

# Git Hook: Unified Pre-commit Validation
# Uses Python scripts for all validation checks

echo "[CHECK] Unified Pre-commit Validation: Starting checks..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# 1. Git Safety Check: Scan for dangerous command traces
echo "[CHECK] Git Safety Check: Scanning for dangerous command traces..."
if [ -n "$STAGED_FILES" ]; then
    DANGEROUS_FOUND=""
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Skip system files that contain safety documentation
            if [[ "$file" == .githooks/* ]] || [[ "$file" == .cursor/rules/* ]] || [[ "$file" == scripts/git-security/* ]] || [[ "$file" == scripts/linting/* ]]; then
                continue
            fi
            # Check for dangerous git commands in file content
            if grep -q "git reset\|git clean\|git checkout --force\|git branch -D\|git push --force\|git rebase --abort\|git stash drop" "$file" 2>/dev/null; then
                DANGEROUS_FOUND="$DANGEROUS_FOUND\n  - Dangerous git command found in $file"
            fi
        fi
    done

    if [ -n "$DANGEROUS_FOUND" ]; then
        echo "[CRITICAL] SECURITY VIOLATION: DANGEROUS GIT COMMANDS DETECTED!"
        echo "COMMIT REJECTED - PROJECT PROTECTED$DANGEROUS_FOUND"
        exit 1
    fi
fi
echo "[SUCCESS] Git Safety Check: No dangerous command traces found."

# 2. Emoji Ban Check
echo "[CHECK] Emoji Ban Check: Scanning for forbidden Unicode characters..."
if [ -f "scripts/validate-emoji-ban.py" ] && [ -n "$STAGED_FILES" ]; then
    # Filter files for emoji validation (Python files and OpenAPI specs)
    PYTHON_FILES=$(echo "$STAGED_FILES" | grep "\.py$" | grep -v -E "\.githooks/|\.cursor/|scripts/framework\.py|scripts/SCRIPT_MIGRATION_GUIDE\.md" || true)
    OPENAPI_FILES=$(echo "$STAGED_FILES" | grep -E "\.yaml$|\.yml$" | grep -E "proto/openapi/" || true)

    if [ -n "$PYTHON_FILES" ]; then
        echo "$PYTHON_FILES" | xargs python scripts/validate-emoji-ban.py
        if [ $? -ne 0 ]; then
            echo "[BLOCKED] Commit blocked due to emoji violation in Python files"
            exit 1
        fi
    fi

    if [ -n "$OPENAPI_FILES" ]; then
        echo "$OPENAPI_FILES" | xargs python scripts/validate-emoji-ban.py --openapi
        if [ $? -ne 0 ]; then
            echo "[BLOCKED] Commit blocked due to emoji violation in OpenAPI files"
            exit 1
        fi
    fi
else
    echo "[WARNING] Emoji validation script not found, skipping emoji check"
fi
echo "[SUCCESS] Emoji Ban Check: Validation completed."

# 3. Script Language Enforcement
echo "[CHECK] Script Language Enforcement: Only Python scripts allowed..."
if [ -f "scripts/validate-script-types.py" ] && [ -n "$STAGED_FILES" ]; then
    echo "$STAGED_FILES" | xargs python scripts/validate-script-types.py
    if [ $? -ne 0 ]; then
        echo "[BLOCKED] COMMIT BLOCKED: FORBIDDEN SCRIPT TYPE DETECTED!"
        exit 1
    fi
fi
echo "[SUCCESS] Script Language Enforcement: Only Python scripts detected."

# 4. OpenAPI Validation
echo "[CHECK] OpenAPI Validation: Checking OpenAPI specs..."
if command -v redocly >/dev/null 2>&1 && [ -n "$STAGED_FILES" ]; then
    OPENAPI_FILES=$(echo "$STAGED_FILES" | grep -E "\.yaml$|\.yml$" | grep -E "proto/openapi/" || true)

    if [ -n "$OPENAPI_FILES" ]; then
        echo "Found OpenAPI files to validate: $OPENAPI_FILES"
        for api_file in $OPENAPI_FILES; do
            if [ -f "$api_file" ]; then
                echo "Validating $api_file..."
                if ! redocly lint "$api_file" --format=stylish; then
                    echo "[ERROR] OpenAPI validation failed for $api_file!"
                    echo "[BLOCKED] Commit blocked due to OpenAPI validation failure"
                    exit 1
                fi
            fi
        done
        echo "[SUCCESS] All OpenAPI files passed validation"
    fi
else
    echo "[WARNING] redocly not found or no files to validate, skipping OpenAPI validation"
fi

echo "[SUCCESS] Unified Pre-commit Validation: All checks passed."
exit 0