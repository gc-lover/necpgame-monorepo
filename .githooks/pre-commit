#!/bin/bash
# Issue: #1858
# Pre-commit hook for automatic quality checks

set -e

echo "üîç Running pre-commit quality checks..."

PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Check if we're in the correct directory
if [ ! -d "$PROJECT_ROOT/scripts" ]; then
    print_status $RED "Error: scripts directory not found. Make sure you're in the project root."
    exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    print_status $GREEN "No files staged for commit. Skipping checks."
    exit 0
fi

print_status $YELLOW "Checking staged files: $STAGED_FILES"

# Check file sizes for staged files
print_status $YELLOW "üìè Checking file sizes..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Count lines
        lines=$(wc -l < "$file" 2>/dev/null || echo "0")
        ext="${file##*.}"

        # Check size limits
        case $ext in
            go|py|yaml|yml)
                if [ "$lines" -gt 500 ]; then
                    print_status $RED "Error: $file exceeds 500 lines ($lines lines)"
                    exit 1
                fi
                ;;
            md)
                if [ "$lines" -gt 1000 ]; then
                    print_status $RED "Error: $file exceeds 1000 lines ($lines lines)"
                    exit 1
                fi
                ;;
            sql)
                if [ "$lines" -gt 800 ]; then
                    print_status $RED "Error: $file exceeds 800 lines ($lines lines)"
                    exit 1
                fi
                ;;
        esac
    fi
done

# Run architecture validator if available
if [ -f "$PROJECT_ROOT/scripts/architecture-validator.py" ]; then
    print_status $YELLOW "üèóÔ∏è  Running architecture validation..."
    if ! python3 "$PROJECT_ROOT/scripts/architecture-validator.py" --project-root "$PROJECT_ROOT" 2>/dev/null; then
        print_status $RED "Architecture validation failed. Please fix the issues before committing."
        exit 1
    fi
fi

# Run OpenAPI validator for API spec changes
if echo "$STAGED_FILES" | grep -q "proto/openapi.*\.yaml"; then
    if [ -f "$PROJECT_ROOT/scripts/openapi-validator.py" ]; then
        print_status $YELLOW "üìã Running OpenAPI validation..."
        if ! python3 "$PROJECT_ROOT/scripts/openapi-validator.py" --project-root "$PROJECT_ROOT" 2>/dev/null; then
            print_status $RED "OpenAPI validation failed. Please fix the API specs before committing."
            exit 1
        fi
    fi
fi

# Check for Issue references in commit messages for code changes
if echo "$STAGED_FILES" | grep -E '\.(go|py|js|ts|cpp|h|java)$'; then
    COMMIT_MSG_FILE=$(git rev-parse --git-dir)/COMMIT_EDITMSG
    if [ -f "$COMMIT_MSG_FILE" ]; then
        commit_msg=$(cat "$COMMIT_MSG_FILE")
        if ! echo "$commit_msg" | grep -q "Issue: #[0-9]"; then
            print_status $YELLOW "Warning: Consider adding 'Issue: #XXX' to commit message for code changes"
        fi
    fi
fi

# Check for large files
print_status $YELLOW "üì¶ Checking for large files..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        # 50MB limit
        if [ "$size" -gt 52428800 ]; then
            print_status $RED "Error: $file is too large ($size bytes). Consider using Git LFS."
            exit 1
        fi
    fi
done

# Check for secrets/tokens
print_status $YELLOW "üîí Checking for potential secrets..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for common patterns
        if grep -q "password\|secret\|token\|key\|api_key" "$file" 2>/dev/null; then
            if grep -q "password.*=.*[\"'][^\"']*[\"']\|secret.*=.*[\"'][^\"']*[\"']\|token.*=.*[\"'][^\"']*[\"']\|key.*=.*[\"'][^\"']*[\"']\|api_key.*=.*[\"'][^\"']*[\"']" "$file" 2>/dev/null; then
                print_status $RED "Warning: Potential hardcoded secrets found in $file"
                print_status $YELLOW "Please ensure secrets are loaded from environment variables or secure stores"
            fi
        fi
    fi
done

print_status $GREEN "OK All pre-commit checks passed!"
exit 0