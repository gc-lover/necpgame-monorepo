#!/bin/bash

# Git Hook: Pre-commit protection against dangerous commands
# This hook prevents commits that might contain traces of dangerous git operations

echo "ðŸ” Git Safety Check: Scanning for dangerous command traces..."

# Check if any staged files contain dangerous git command patterns
# This catches cases where agents might have accidentally included command output

DANGEROUS_PATTERNS=(
    "git reset"
    "git clean"
    "git checkout --force"
    "git branch -D"
    "git push --force"
    "git rebase --abort"
    "git stash drop"
)

# Check staged files for dangerous patterns
DANGEROUS_FOUND=""
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Skip system files that contain safety documentation
        if [[ "$file" == .githooks/* ]] || [[ "$file" == .cursor/rules/* ]]; then
            continue
        fi
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" "$file" 2>/dev/null; then
                DANGEROUS_FOUND="$DANGEROUS_FOUND\n  - $pattern (in $file)"
            fi
        done
    fi
done

if [ -n "$DANGEROUS_FOUND" ]; then
    echo "ðŸš¨ BLOCKED: Found traces of dangerous git commands in staged files!"
    echo "These commands can cause data loss and are forbidden for agents."
    echo ""
    echo "Forbidden commands detected:$DANGEROUS_FOUND"
    echo ""
    echo "Please remove these traces and use safe git commands only."
    echo "Safe commands: git add, git commit, git push, git pull, git checkout <branch>"
    exit 1
fi

echo "OK Git Safety Check: No dangerous command traces found."
exit 0