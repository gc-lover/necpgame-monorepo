#!/bin/bash

# Git Hook: Pre-commit protection against dangerous commands
# This hook prevents commits that might contain traces of dangerous git operations

echo "[CHECK] Git Safety Check: Scanning for dangerous command traces..."

# Check if any staged files contain dangerous git command patterns
# This catches cases where agents might have accidentally included command output

DANGEROUS_PATTERNS=(
    "git reset"
    "git clean"
    "git checkout --force"
    "git branch -D"
    "git push --force"
    "git rebase --abort"
    "git stash drop"
)

# Check staged files for dangerous patterns
DANGEROUS_FOUND=""
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Skip system files that contain safety documentation
        if [[ "$file" == .githooks/* ]] || [[ "$file" == .cursor/rules/* ]] || [[ "$file" == ACTIVATE-ABSOLUTE-PROTECTION.bat ]] || [[ "$file" == SYSTEM-GIT-BLOCKING-README.md ]] || [[ "$file" == install-system-git-blocker.bat ]] || [[ "$file" == uninstall-system-git-blocker.bat ]] || [[ "$file" == test-system-blocking.bat ]]; then
            continue
        fi
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" "$file" 2>/dev/null; then
                DANGEROUS_FOUND="$DANGEROUS_FOUND\n  - $pattern (in $file)"
            fi
        done
    fi
done

if [ -n "$DANGEROUS_FOUND" ]; then
    echo "[CRITICAL] SECURITY VIOLATION: DANGEROUS GIT COMMANDS DETECTED!"
    echo "AI AGENT SECURITY BREACH DETECTED!"
    echo "PROJECT SAFETY PROTOCOL ACTIVATED!"
    echo ""
    echo "FORBIDDEN COMMANDS DETECTED IN FILES:$DANGEROUS_FOUND"
    echo ""
    echo "WHY THIS IS BLOCKED:"
    echo "- git reset (any)  -> LOSES WORK irreversibly"
    echo "- git clean (any)  -> DELETES FILES permanently"
    echo "- git push --force -> DESTROYS shared history"
    echo "- git branch -D    -> DELETES branches permanently"
    echo ""
    echo "[FORBIDDEN] DO NOT ATTEMPT TO BYPASS THIS PROTECTION!"
    echo "[FORBIDDEN] DO NOT TRY TO USE THESE COMMANDS IN ANY WAY!"
    echo "[FORBIDDEN] THIS IS A SERIOUS SECURITY VIOLATION!"
    echo ""
    echo "REQUIRED IMMEDIATE ACTION:"
    echo "1. STOP what you are doing"
    echo "2. Return task with security violation note"
    echo "3. DO NOT attempt to bypass this protection"
    echo "4. Contact human administrator if needed"
    echo ""
    echo "SAFE ALTERNATIVES INSTEAD:"
    echo "- To undo file changes:    git restore <file>"
    echo "- To undo last commit:     git revert HEAD"
    echo "- To clean safely:         git clean -n (preview first)"
    echo "- To force push safely:    git push --force-with-lease"
    echo ""
    echo "EDUCATION: Git reset/clean are powerful but DANGEROUS tools."
    echo "They can destroy hours/days/weeks of work instantly."
    echo "This protection saves your project from catastrophic loss."
    echo ""
    echo "SECURITY INCIDENT LOGGED - VIOLATION REPORTED"
    echo "COMMIT REJECTED - PROJECT PROTECTED"
    exit 1
fi

echo "[SUCCESS] Git Safety Check: No dangerous command traces found."

# Check for emoji and special characters in staged files
echo "[CHECK] Emoji Ban Check: Scanning for forbidden Unicode characters..."

if [ -f "scripts/validate-emoji-ban.sh" ]; then
    # Run emoji validation on staged files
    STAGED_FILES=$(git diff --cached --name-only)

    # Skip validation for git hook files (system files)
    if echo "$STAGED_FILES" | grep -q ".githooks/"; then
        echo "[INFO] Skipping emoji validation for git hook system files"
    elif [ -n "$STAGED_FILES" ]; then
        echo "$STAGED_FILES" | xargs bash scripts/validate-emoji-ban.sh
        if [ $? -ne 0 ]; then
            echo "[BLOCKED] COMMIT BLOCKED: Emoji/special character violation detected!"
            echo "Please remove all emoji and special Unicode characters from your code."
            echo ""
            echo "Common fixes:"
            echo "- Replace emoji with :smile:"
            echo "- Replace forbidden emoji with [FORBIDDEN]"
            echo "- Remove decorative symbols like stars, diamonds, etc."
            echo "- Use plain ASCII text in comments"
            exit 1
        fi
    fi
else
    echo "[WARNING] Emoji validation script not found, skipping emoji check"
fi

echo "[SUCCESS] Emoji Ban Check: No forbidden characters found."
exit 0