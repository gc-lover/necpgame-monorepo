#!/bin/bash

# Git Hook: Pre-commit protection against dangerous commands
# This hook prevents commits that might contain traces of dangerous git operations

echo "[CHECK] Git Safety Check: Scanning for dangerous command traces..."

# Check if any staged files contain dangerous git command patterns
# This catches cases where agents might have accidentally included command output

DANGEROUS_PATTERNS=(
    "git reset"
    "git clean"
    "git checkout --force"
    "git branch -D"
    "git push --force"
    "git rebase --abort"
    "git stash drop"
)

# Check staged files for dangerous patterns
DANGEROUS_FOUND=""
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Skip system files that contain safety documentation
        if [[ "$file" == .githooks/* ]] || [[ "$file" == .cursor/rules/* ]]; then
            continue
        fi
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" "$file" 2>/dev/null; then
                DANGEROUS_FOUND="$DANGEROUS_FOUND\n  - $pattern (in $file)"
            fi
        done
    fi
done

if [ -n "$DANGEROUS_FOUND" ]; then
    echo "[CRITICAL] SECURITY VIOLATION: DANGEROUS GIT COMMANDS DETECTED!"
    echo "AI AGENT SECURITY BREACH DETECTED!"
    echo ""
    echo "STRICTLY FORBIDDEN: These commands can DESTROY ENTIRE PROJECT!"
    echo "You are attempting to execute commands that can cause IRREVERSIBLE DATA LOSS!"
    echo ""
    echo "DETECTED FORBIDDEN COMMANDS:$DANGEROUS_FOUND"
    echo ""
    echo "[FORBIDDEN] DO NOT ATTEMPT TO BYPASS THIS PROTECTION!"
    echo "[FORBIDDEN] DO NOT TRY TO USE THESE COMMANDS IN ANY WAY!"
    echo "[FORBIDDEN] THIS IS A SERIOUS SECURITY VIOLATION!"
    echo ""
    echo "REQUIRED ACTION: Return task immediately with security violation note"
    echo "DO NOT proceed with any dangerous operations!"
    echo ""
    echo "ALLOWED SAFE COMMANDS ONLY:"
    echo "  git add <files>     # Stage files safely"
    echo "  git commit -m 'msg' # Commit changes safely"
    echo "  git push            # Push to remote safely"
    echo "  git pull            # Pull from remote safely"
    echo "  git checkout <branch> # Switch branches safely"
    echo ""
    echo "SECURITY INCIDENT LOGGED - ADMIN NOTIFICATION SENT"
    exit 1
fi

echo "[SUCCESS] Git Safety Check: No dangerous command traces found."

# Check for emoji and special characters in staged files
echo "[CHECK] Emoji Ban Check: Scanning for forbidden Unicode characters..."

if [ -f "scripts/validate-emoji-ban.sh" ]; then
    # Run emoji validation on staged files
    STAGED_FILES=$(git diff --cached --name-only)
    if [ -n "$STAGED_FILES" ]; then
        echo "$STAGED_FILES" | xargs bash scripts/validate-emoji-ban.sh
        if [ $? -ne 0 ]; then
            echo "[BLOCKED] COMMIT BLOCKED: Emoji/special character violation detected!"
            echo "Please remove all emoji and special Unicode characters from your code."
            echo ""
            echo "Common fixes:"
            echo "• Replace emoji with :smile:"
            echo "• Replace forbidden emoji with [FORBIDDEN]"
            echo "• Remove decorative symbols like stars, diamonds, etc."
            echo "• Use plain ASCII text in comments"
            exit 1
        fi
    fi
else
    echo "[WARNING] Emoji validation script not found, skipping emoji check"
fi

echo "[SUCCESS] Emoji Ban Check: No forbidden characters found."
exit 0