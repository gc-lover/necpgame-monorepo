#!/bin/bash

# Git Hook: Pre-push protection
# Additional safety check before pushing to remote

echo "ðŸ›¡ï¸ Git Pre-Push Safety Check..."

# Check recent commits for dangerous command patterns in commit messages
# This catches cases where agents might have accidentally committed with dangerous command references

DANGEROUS_PATTERNS=(
    "reset"
    "clean"
    "checkout --force"
    "branch -D"
    "push --force"
    "rebase --abort"
    "stash drop"
)

# Get the commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # This is a new branch, check all commits
        commits_to_check=$(git rev-list --oneline $remote_sha..$local_sha 2>/dev/null || git rev-list --oneline $local_sha)
    else
        # Check commits between local and remote
        commits_to_check=$(git rev-list --oneline $remote_sha..$local_sha)
    fi

    if [ -n "$commits_to_check" ]; then
        echo "Checking commits for dangerous patterns..."

        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if echo "$commits_to_check" | grep -i "$pattern" >/dev/null; then
                echo "ðŸš¨ BLOCKED: Found dangerous command pattern '$pattern' in commit messages!"
                echo "This suggests unsafe git operations were performed."
                echo ""
                echo "Please review your commits and ensure no dangerous commands were used."
                echo "Safe commands: git add, git commit, git push, git pull, git checkout <branch>"
                exit 1
            fi
        done
    fi
done

echo "OK Git Pre-Push Safety Check: All commits appear safe."
exit 0