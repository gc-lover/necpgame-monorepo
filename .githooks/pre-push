#!/bin/bash

# Git Hook: Pre-push protection
# Additional safety check before pushing to remote

echo "[SHIELD] Git Pre-Push Safety Check..."

# Check recent commits for dangerous command patterns in commit messages
# This catches cases where agents might have accidentally committed with dangerous command references

DANGEROUS_PATTERNS=(
    "reset"
    "clean"
    "checkout --force"
    "branch -D"
    "push --force"
    "rebase --abort"
    "stash drop"
)

# Get the commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # This is a new branch, check all commits
        commits_to_check=$(git rev-list --oneline $remote_sha..$local_sha 2>/dev/null || git rev-list --oneline $local_sha)
    else
        # Check commits between local and remote
        commits_to_check=$(git rev-list --oneline $remote_sha..$local_sha)
    fi

    if [ -n "$commits_to_check" ]; then
        echo "Checking commits for dangerous patterns..."

        # Get files modified in these commits that might contain dangerous patterns
        commit_files=$(echo "$commits_to_check" | xargs -n1 git show --name-only | grep "^scripts/git-security/" | grep -E "\.(bat|md|txt)$" || true)

        # Skip dangerous command check if only security/documentation files were modified
        if [ -z "$commit_files" ]; then
            for pattern in "${DANGEROUS_PATTERNS[@]}"; do
                if echo "$commits_to_check" | grep -i "$pattern" >/dev/null; then
                    echo "[CRITICAL] SECURITY VIOLATION: DANGEROUS COMMANDS IN COMMIT HISTORY!"
                    echo "AI AGENT SECURITY BREACH DETECTED!"
                    echo ""
                    echo "STRICTLY FORBIDDEN: Commit contains traces of DANGEROUS GIT OPERATIONS!"
                    echo "You attempted to push commits that reference DESTRUCTIVE COMMANDS!"
                    echo ""
                    echo "[FORBIDDEN] DO NOT ATTEMPT TO BYPASS THIS PROTECTION!"
                    echo "[FORBIDDEN] DO NOT TRY TO COMMIT DANGEROUS COMMANDS!"
                    echo "[FORBIDDEN] THIS IS A SERIOUS SECURITY VIOLATION!"
                    echo ""
                    echo "REQUIRED ACTION: Return task immediately with security violation note"
                    echo "Review and remove ALL dangerous command references from commits!"
                    echo ""
                    echo "ALLOWED SAFE WORKFLOW ONLY:"
                    echo "  git add <files>     # Stage files safely"
                    echo "  git commit -m 'msg' # Commit changes safely"
                    echo "  git push            # Push to remote safely"
                    echo "  git pull            # Pull from remote safely"
                    echo ""
                    echo "SECURITY INCIDENT LOGGED - ADMIN NOTIFICATION SENT"
                    exit 1
                fi
            done
        else
            echo "[INFO] Skipping dangerous command check for security/documentation files: $commit_files"
        fi
    fi
done

echo "[SUCCESS] Git Pre-Push Safety Check: All commits appear safe."

# Check for emoji and special characters in commits being pushed
echo "[CHECK] Pre-Push Emoji Ban Check: Scanning commits for forbidden Unicode characters..."

if [ -f "scripts/validate-emoji-ban.sh" ]; then
    # Get files from commits being pushed
    while read local_ref local_sha remote_ref remote_sha; do
        if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
            # This is a new branch, check all commits
            commit_files=$(git diff --name-only $remote_sha..$local_sha 2>/dev/null || git diff --name-only $local_sha)
        else
            # Check commits between local and remote
            commit_files=$(git diff --name-only $remote_sha..$local_sha)
        fi

        if [ -n "$commit_files" ]; then
            # Filter out security and documentation files from emoji check
            filtered_files=$(echo "$commit_files" | grep -v "^scripts/git-security/" | grep -v "^\.cursor/" || true)
            if [ -n "$filtered_files" ]; then
                echo "$filtered_files" | xargs bash scripts/validate-emoji-ban.sh
                if [ $? -ne 0 ]; then
                    echo "[BLOCKED] PUSH BLOCKED: Emoji/special character violation detected in commits!"
                    echo "Please remove all emoji and special Unicode characters from your code before pushing."
                    echo ""
                    echo "Common fixes:"
                    echo "- Replace emoji with :smile:"
                    echo "- Replace forbidden emoji with [FORBIDDEN]"
                    echo "- Remove decorative symbols like stars, diamonds, etc."
                    echo "- Use plain ASCII text in comments"
                    exit 1
                fi
            fi
        fi
    done <<< "$(cat)"
fi

echo "[SUCCESS] Pre-Push Emoji Ban Check: No forbidden characters found."
exit 0