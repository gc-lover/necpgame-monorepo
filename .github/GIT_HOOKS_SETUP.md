# Git Hooks Setup

## Установка

Проект использует Git hooks для проверки качества кода перед коммитом.

### Автоматическая установка

**Linux/Mac:**
```bash
./scripts/install-git-hooks.sh
```

**Windows:**
```cmd
scripts\install-git-hooks.bat
```

### Ручная установка

```bash
git config core.hooksPath .githooks
chmod +x .githooks/*
```

## Настроенные хуки

Все hooks оптимизированы для работы на Windows и Linux/Mac.

### Pre-checkout

Запрещает переключение на ветки, отличные от `develop`.

**Что проверяется:**
- Разрешена только ветка `develop`
- Запрещено создание новых веток через `git checkout -b`
- Запрещено переключение на существующие ветки кроме `develop`
- Проверка файлов (не веток) разрешена

**WARNING Важно для Windows:**
На некоторых версиях Git для Windows hook `pre-checkout` может не срабатывать при использовании `git checkout` через cmd.exe. Основная защита обеспечивается через `pre-commit` hook, который блокирует коммиты в неправильных ветках.

**Обход проверки (не рекомендуется):**
```bash
git checkout --no-verify <branch>
```

### Pre-commit

Проверяет размер файлов перед коммитом и текущую ветку.

**Что проверяется:**
- Разрешена только ветка `develop` для коммитов
- Максимум **600 строк** на файл (настраивается в `.github/file-size-config.sh`)
- Только файлы в staging area (готовые к коммиту)
- Типы файлов: `.go`, `.cpp`, `.h`, `.yaml`, `.md`, `.sql`, и др.

**Что проверяется:**
- Максимум **600 строк** на файл (настраивается в `.github/file-size-config.sh`)
- Только файлы в staging area (готовые к коммиту)
- Типы файлов: `.go`, `.cpp`, `.h`, `.yaml`, `.md`, `.sql`, и др.

**Исключения:**
- `*.gen.go` - сгенерированные файлы
- `*.pb.go` - protobuf файлы
- `vendor/*` - зависимости
- `node_modules/*` - npm пакеты
- `*/pkg/api/api.gen.go` - API сгенерированный код

**Обход проверки (не рекомендуется):**
```bash
git commit --no-verify
```

### Pre-push

Блокирует push веток, отличных от `develop`, и проверяет LFS файлы перед отправкой.

**Что проверяется:**
- Разрешена только ветка `develop` для push в remote
- Запрещено push любых других веток
- Интегрирован с Git LFS для управления большими файлами

**Обход проверки (не рекомендуется):**
```bash
git push --no-verify <remote> <branch>
```

**Примечание:** Локальное создание веток разрешено, но push в remote блокируется для всех веток кроме `develop`.

### Post-checkout

Автоматически возвращает на `develop` при попытке переключения на другие ветки и обрабатывает LFS файлы.

**Что проверяется:**
- Автоматически переключает обратно на `develop`, если переключились на другую ветку
- Автоматически удаляет созданные запрещенные ветки
- Выводит структурированное сообщение об ошибке для AI-агентов
- Интегрирован с Git LFS для управления большими файлами

**Автоматические действия:**
- При создании ветки через `git checkout -b` → автоматически возврат на `develop` и удаление созданной ветки
- При переключении на существующую ветку → автоматически возврат на `develop`

**Примечание:** Этот hook автоматически исправляет нарушения политики, возвращая пользователя на разрешенную ветку.

### Post-commit, Post-merge

Эти hooks интегрированы с Git LFS для управления большими файлами:
- **Post-commit** - обрабатывает LFS файлы после коммита
- **Post-merge** - обрабатывает LFS файлы после merge

Все hooks автоматически пропускаются, если Git LFS не установлен или недоступен.

## Конфигурация

Все настройки в одном месте: `.github/file-size-config.sh`

```bash
export MAX_LINES=600                    # Максимум строк на файл
export FILE_EXTENSIONS=(...)            # Проверяемые типы файлов
export EXCLUDED_PATTERNS=(...)          # Исключения из проверки
```

Эта же конфигурация используется в:
- Git pre-commit hook
- GitHub Actions workflow

## Troubleshooting

### Hook не запускается

```bash
chmod +x .githooks/pre-commit
git config core.hooksPath .githooks
```

### Ошибка "permission denied" на Windows

- Запустите Git Bash от имени администратора
- Или используйте `install-git-hooks.bat`

### Git команды зависают на Windows

Если git команды зависают, это может быть связано с несколькими причинами:

1. **Проблема:** Process substitution в pre-commit hook (исправлено)
   - **Решение:** Hook обновлен для использования временных файлов вместо process substitution
   - Теперь работает корректно на Windows (cmd.exe и Git Bash)

2. **Проблема:** WSL2 bash не работает (ошибка подключения диска WSL2)
   - **Решение:** Убедитесь, что Git использует Git Bash вместо WSL2 bash

```bash
# Проверьте, какой bash используется
where bash.exe

# Должен показать путь к Git Bash: C:\Program Files\Git\bin\bash.exe
# Если показывает WSL путь - проблема в WSL2

# Исправление: Настройте Git для использования Git Bash
git config --global core.editor "'C:/Program Files/Git/bin/bash.exe' -c 'EDITOR=\"$EDITOR\" exec \"$EDITOR\" \"$@\"'"
```

Если проблема сохраняется, hooks настроены для автоматического обхода при ошибках. Они не должны блокировать git команды.

### Оптимизация для Windows

Все hooks оптимизированы для работы на Windows:
- OK Убраны `set -e` для предотвращения преждевременного завершения
- OK Улучшена обработка ошибок с явными проверками
- OK Используются временные файлы вместо process substitution
- OK Поддержка Windows-переменных окружения (TMPDIR, TMP)
- OK Автоматический обход при ошибках (hooks не блокируют git команды)

### Проверка установленных хуков

```bash
git config core.hooksPath
ls -la .githooks/
```

### Временное отключение hooks

```bash
git config --unset core.hooksPath
```

WARNING **Важно:** Отключение hooks позволит использовать другие ветки, что нарушает политику проекта.

## Защита веток

Проект использует строгую политику работы только с веткой `develop`:

- OK Разрешена только ветка `develop`
- ❌ Запрещено создание новых веток
- ❌ Запрещено переключение на другие ветки
- ❌ Запрещены коммиты в другие ветки

Эта защита реализована через:
- `pre-checkout` hook - блокирует checkout других веток (может не работать на некоторых версиях Git для Windows)
- `pre-commit` hook - **основная защита** - блокирует коммиты в ветках, отличных от `develop`
- `pre-push` hook - **критическая защита** - блокирует push любых веток кроме `develop` в remote
- `post-checkout` hook - **автоматическое исправление** - автоматически возвращает на `develop` и удаляет запрещенные ветки

**Многоуровневая защита:**
1. **Предотвращение:** `pre-checkout` блокирует переключение на другие ветки (если работает)
2. **Локальная защита:** `pre-commit` блокирует коммиты в неправильных ветках
3. **Remote защита:** `pre-push` блокирует push любых веток кроме `develop`
4. **Автоматическое исправление:** `post-checkout` автоматически возвращает на `develop` и удаляет запрещенные ветки

**Автоматическое исправление:**
При попытке создать или переключиться на ветку, отличную от `develop`:
- OK Автоматически переключает обратно на `develop`
- OK Автоматически удаляет созданную запрещенную ветку
- OK Выводит понятное сообщение для AI-агентов

**Примечание для Windows:**
Даже если `pre-checkout` hook не срабатывает, `post-checkout` автоматически исправляет ситуацию, возвращая пользователя на `develop` и удаляя запрещенные ветки. Дополнительно `pre-commit` и `pre-push` блокируют коммиты и push в неправильных ветках.

### Работа с разрешенной веткой

```bash
# Переключение на develop (разрешено)
git checkout develop

# Создание коммита (только в develop)
git add .
git commit -m "feat: новая функция"
```

## Удаление

```bash
git config --unset core.hooksPath
```

