name: Agent Stage Transition

on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [closed]

jobs:
  transition-to-next-stage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
      projects: write
    steps:
      - name: Check for Ready Status
        id: check_ready
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) {
              core.setOutput('is_ready', 'false');
              return;
            }
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const body = issue.body || '';
            const checkboxes = body.match(/- \[([ x])\]/g) || [];
            const checked = checkboxes.filter(cb => cb.includes('x')).length;
            const total = checkboxes.length;
            
            const isReady = total > 0 && checked === total && issue.state === 'open';
            
            core.setOutput('is_ready', isReady ? 'true' : 'false');
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', body);
            
            if (isReady) {
              const labels = issue.labels.map(l => l.name);
              core.setOutput('current_labels', JSON.stringify(labels));
            }

      - name: Determine Next Stage
        if: steps.check_ready.outputs.is_ready == 'true'
        id: next_stage
        uses: actions/github-script@v7
        with:
          script: |
            const labels = JSON.parse('${{ steps.check_ready.outputs.current_labels }}');
            const labelNames = labels.map(l => l.name || l);
            
            const hasContentLabels = labelNames.some(l => ['canon', 'lore', 'quest'].includes(l));
            const isContentQuest = hasContentLabels && (labelNames.some(l => l.includes('idea-writer')) || labelNames.some(l => l.includes('content')));
            
            const stageTransitions = {
              'idea-writer': isContentQuest ? { next: 'content-writer', agent: 'content-writer', stage: 'content' } : { next: 'architect', agent: 'architect', stage: 'design' },
              'content-writer': { next: 'testing', agent: 'qa', stage: 'testing' },
              'architect': { next: 'database-dev', agent: 'database', stage: 'database' },
              'database-dev': { next: 'api-designer', agent: 'api-designer', stage: 'api-design' },
              'api-designer': { next: 'backend-dev', agent: 'backend', stage: 'backend-dev' },
              'backend-dev': { next: 'network-dev', agent: 'network', stage: 'network' },
              'network-dev': { next: 'security', agent: 'security', stage: 'security' },
              'security': { next: 'devops', agent: 'devops', stage: 'infrastructure' },
              'devops': { next: 'ue5-dev', agent: 'ue5', stage: 'client-dev' },
              'ue5-dev': { next: 'testing', agent: 'qa', stage: 'testing' },
              'testing': { next: 'game-balance', agent: 'game-balance', stage: 'balance' },
              'game-balance': { next: 'release', agent: 'release', stage: 'release' }
            };
            
            let currentStage = '';
            if (labelNames.some(l => l.includes('content-writer') || l.includes('content'))) {
              currentStage = 'content-writer';
            } else if (labelNames.some(l => l.includes('idea-writer') || l.includes('idea'))) {
              currentStage = 'idea-writer';
            } else if (labelNames.some(l => l.includes('architect') || l.includes('architecture'))) {
              currentStage = 'architect';
            } else if (labelNames.some(l => l.includes('database'))) {
              currentStage = 'database-dev';
            } else if (labelNames.some(l => l.includes('api-designer') || l.includes('api'))) {
              currentStage = 'api-designer';
            } else if (labelNames.some(l => l.includes('backend'))) {
              currentStage = 'backend-dev';
            } else if (labelNames.some(l => l.includes('network'))) {
              currentStage = 'network-dev';
            } else if (labelNames.some(l => l.includes('security'))) {
              currentStage = 'security';
            } else if (labelNames.some(l => l.includes('devops'))) {
              currentStage = 'devops';
            } else if (labelNames.some(l => l.includes('ue5') || l.includes('client'))) {
              currentStage = 'ue5-dev';
            } else if (labelNames.some(l => l.includes('testing') || l.includes('qa'))) {
              currentStage = 'testing';
            } else if (labelNames.some(l => l.includes('game-balance'))) {
              currentStage = 'game-balance';
            }
            
            const transition = stageTransitions[currentStage];
            
            if (transition) {
              core.setOutput('next_stage', transition.next);
              core.setOutput('next_agent', transition.agent);
              core.setOutput('next_stage_label', transition.stage);
              core.setOutput('current_stage', currentStage);
            } else {
              core.setOutput('next_stage', '');
            }

      - name: Transition to Next Stage
        if: steps.next_stage.outputs.next_stage != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.check_ready.outputs.issue_number }}';
            const nextStage = '${{ steps.next_stage.outputs.next_stage }}';
            const nextAgent = '${{ steps.next_stage.outputs.next_agent }}';
            const nextStageLabel = '${{ steps.next_stage.outputs.next_stage_label }}';
            const currentStage = '${{ steps.next_stage.outputs.current_stage }}';
            
            const agentNames = {
              'content-writer': '‚úçÔ∏è Content Writer',
              'architect': 'üìê Architect',
              'database': 'üóÑÔ∏è Database Engineer',
              'api-designer': 'üìã API Designer',
              'backend': '‚öôÔ∏è Backend Developer',
              'network': 'üåê Network Engineer',
              'security': 'üîí Security Agent',
              'devops': 'üê≥ DevOps',
              'ue5': 'üéÆ UE5 Developer',
              'qa': 'üß™ QA/Testing',
              'game-balance': '‚öñÔ∏è Game Balance Agent',
              'release': 'üöÄ Release Manager'
            };
            
            const newLabels = [`agent:${nextAgent}`, `stage:${nextStageLabel}`];
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              labels: newLabels
            });
            
            const comment = `## ‚úÖ –≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É
            
**–ó–∞–≤–µ—Ä—à–µ–Ω —ç—Ç–∞–ø:** \`${currentStage}\`
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** \`${nextStage}\`
**–ù–∞–∑–Ω–∞—á–µ–Ω –∞–≥–µ–Ω—Ç:** ${agentNames[nextAgent] || nextAgent}

–í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
- –ê–≥–µ–Ω—Ç ${agentNames[nextAgent] || nextAgent} –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –∑–∞–¥–∞—á–µ–π
- –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞–º –≤ \`.cursor/rules/agent-${nextAgent}.mdc\`
- –û–±–Ω–æ–≤–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---
*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: comment
            });
            
            console.log(`Transitioned issue #${issueNumber} from ${currentStage} to ${nextStage}`);

