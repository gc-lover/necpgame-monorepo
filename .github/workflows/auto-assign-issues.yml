name: Auto Assign Issues to Agents

on:
  issues:
    types: [opened, labeled]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Auto-assign based on title and labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;
            const body = issue.body || '';
            let labels = issue.labels.map(l => l.name);

            const labelsToAdd = [];
            const labelsToRemove = [];

            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å agent –º–µ—Ç–∫–∞, –Ω–µ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º
            const hasAgentLabel = labels.some(l => l.startsWith('agent:'));
            if (hasAgentLabel && context.payload.action === 'labeled') {
              console.log('Issue already has agent label, skipping auto-assignment');
              return;
            }

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –ø–æ title
            if (title.startsWith('[Idea]') || title.includes('[Idea Writer]')) {
              labelsToAdd.push('agent:idea-writer', 'stage:idea');
            } else if (title.startsWith('[Analysis]') || title.includes('[Analyst]')) {
              labelsToAdd.push('agent:analyst', 'stage:analysis');
            } else if (title.startsWith('[Architect]')) {
              labelsToAdd.push('agent:architect', 'stage:design');
            } else if (title.startsWith('[API Designer]') || title.includes('OpenAPI')) {
              labelsToAdd.push('agent:api-designer', 'stage:api-design', 'protocol');
            } else if (title.startsWith('[Backend]')) {
              labelsToAdd.push('agent:backend', 'stage:backend-dev', 'backend');
            } else if (title.startsWith('[Database]')) {
              labelsToAdd.push('agent:database-engineer', 'stage:database-design', 'database');
            } else if (title.startsWith('[Frontend]') || title.startsWith('[Client]')) {
              labelsToAdd.push('agent:frontend', 'stage:frontend-dev', 'frontend');
            } else if (title.startsWith('[QA]') || title.startsWith('[Testing]')) {
              labelsToAdd.push('agent:qa', 'stage:testing');
            } else if (title.startsWith('[DevOps]') || title.startsWith('[Infrastructure]')) {
              labelsToAdd.push('agent:devops', 'stage:deployment', 'infrastructure');
            } else if (title.startsWith('[Canon/Lore]') || labels.includes('canon') || labels.includes('lore') || labels.includes('quest')) {
              labelsToAdd.push('agent:content-writer', 'stage:concept');
            } else if (title.startsWith('[Mechanics]')) {
              // Mechanics —Ç—Ä–µ–±—É–µ—Ç —Å–Ω–∞—á–∞–ª–∞ Idea Writer –¥–ª—è –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∑–∞—Ç–µ–º Architect –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
              const status = body.match(/status:\s*(\w+)/i);
              if (status && status[1].toLowerCase() === 'approved') {
                labelsToAdd.push('agent:architect', 'stage:design');
              } else {
                labelsToAdd.push('agent:idea-writer', 'stage:idea', 'mechanics');
              }
            } else if (title.startsWith('[Implementation]')) {
              // Implementation –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
              labelsToAdd.push('agent:architect', 'stage:design');
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–µ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
            if (labelsToAdd.length > 0) {
              const currentLabels = issue.labels.map(l => l.name);
              const finalLabels = [...new Set([...currentLabels, ...labelsToAdd])];
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: finalLabels
              });
              
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
              
              // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏
              const agentLabel = labelsToAdd.find(l => l.startsWith('agent:'));
              if (agentLabel) {
                const agentName = agentLabel.replace('agent:', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ü§ñ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ**\n\n–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∞–≥–µ–Ω—Ç—É: **${agentName}**\n\n–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ–≤–µ—Ä–Ω–æ, –∏–∑–º–µ–Ω–∏—Ç–µ –º–µ—Ç–∫–∏ –≤—Ä—É—á–Ω—É—é.`
                });
              }
            }


