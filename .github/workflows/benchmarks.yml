name: Benchmark All Services

on:
  schedule:
    - cron: '0 2 * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00 UTC
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  push:
    branches: [main, develop]
    paths:
      - 'services/**/*_bench_test.go'
      - 'services/**/server/**/*.go'
      - 'services/**/Makefile'
      - 'scripts/run-all-benchmarks.sh'
      - 'scripts/run-changed-benchmarks.ps1'
  pull_request:
    paths:
      - 'services/**/*_bench_test.go'
      - 'services/**/server/**/*.go'
      - 'services/**/Makefile'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          go install golang.org/x/perf/cmd/benchstat@latest
      
      - name: Detect changed services
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '^services/([^/]+)/server/.*\.go$' | sed 's|^services/\([^/]*\)/.*|\1|' | sort -u | tr '\n' ' ')
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '^services/([^/]+)/server/.*\.go$' | sed 's|^services/\([^/]*\)/.*|\1|' | sort -u | tr '\n' ' ')
          fi
          echo "services=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed services: $CHANGED"
      
      - name: Run benchmarks for changed services
        if: steps.changed.outputs.services != ''
        run: |
          for service in ${{ steps.changed.outputs.services }}; do
            if [ -f "services/$service/server/handlers_bench_test.go" ]; then
              echo "ðŸ“Š Benchmarking: $service"
              cd "services/$service"
              if [ -f "Makefile" ]; then
                make bench-json || true
              else
                mkdir -p ../../.benchmarks/results
                go test -run=^$$ -bench=. -benchmem -json ./server > "../../.benchmarks/results/${service}_bench.json" || true
              fi
              cd ../..
            fi
          done
      
      - name: Run all benchmarks (if no changes detected)
        if: steps.changed.outputs.services == ''
        run: |
          chmod +x scripts/run-all-benchmarks.sh
          ./scripts/run-all-benchmarks.sh
      
      - name: Compare with previous
        id: compare
        continue-on-error: true
        run: |
          LATEST=$(ls -t .benchmarks/results/*.json | head -1)
          PREVIOUS=$(ls -t .benchmarks/results/*.json | head -2 | tail -1)
          
          if [ -f "$PREVIOUS" ] && [ "$LATEST" != "$PREVIOUS" ]; then
            echo "ðŸ“Š Comparing with previous run..."
            benchstat -json "$PREVIOUS" "$LATEST" > .benchmarks/comparison.json || true
            echo "comparison=true" >> $GITHUB_OUTPUT
          else
            echo "comparison=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: .benchmarks/
          retention-days: 90
      
      - name: Commit results
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .benchmarks/
          git diff --staged --quiet || git commit -m "[ci] benchmark: update results $(date +%Y%m%d_%H%M%S)"
          git push || echo "No changes to commit"

