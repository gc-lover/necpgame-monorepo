name: CD ArgoCD Sync

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'k8s/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  sync-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
      
      - name: Login to ArgoCD
        run: |
          argocd login ${{ secrets.ARGOCD_SERVER }} --username ${{ secrets.ARGOCD_USERNAME }} --password ${{ secrets.ARGOCD_PASSWORD }} --insecure
      
      - name: Sync application
        run: |
          argocd app sync necpgame --prune
          argocd app wait necpgame --health --timeout 600
      
      - name: Get application status
        run: |
          argocd app get necpgame

