name: Backend CI

on:
  push:
    paths:
      - "services/**"
      - "proto/**"
      - ".github/workflows/ci-backend.yml"
  pull_request:
    paths:
      - "services/**"
      - "proto/**"

jobs:
  quality-gates:
    uses: ./.github/workflows/quality-gates.yml

  discover-services:
    needs: quality-gates
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.list.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Improve checkout performance
          sparse-checkout: |
            services/
            proto/
      - name: Discover changed Go services
        id: list
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA=$(git rev-parse HEAD~1)
          fi

          changed_files=$(git diff --name-only --diff-filter=ACMR $BASE_SHA $HEAD_SHA)
          echo "Changed files: $changed_files"

          proto_changed=$(echo "$changed_files" | grep -qE '^proto/' && echo "true" || echo "false")
          changed_service_dirs=$(echo "$changed_files" | grep -E '^services/[^/]+-go/' | cut -d'/' -f1-2 | sort -u | sed 's|services/||')

          echo "Proto changed: $proto_changed"
          echo "Changed service dirs: $changed_service_dirs"

          all_services=$(find services -maxdepth 1 -type d -name "*-go" -exec basename {} \;)
          valid_services=""

          while IFS= read -r service; do
            if [ -f "services/$service/go.mod" ]; then
              valid_services="${valid_services}${service}\n"
            fi
          done <<< "$all_services"

          if [ "$proto_changed" = "true" ] && [ -z "$changed_service_dirs" ]; then
            services=$(echo -e "$valid_services" | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
            echo "Proto changed, using all services"
          elif [ -n "$changed_service_dirs" ]; then
            filtered_services=""
            while IFS= read -r service; do
              if echo "$changed_service_dirs" | grep -q "^${service}$"; then
                filtered_services="${filtered_services}${service}\n"
              fi
            done <<< "$valid_services"
            services=$(echo -e "$filtered_services" | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
            echo "Using filtered changed services"
          else
            services=$(echo -e "$valid_services" | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
            echo "No changes detected, using all services"
          fi

          if [ -z "$services" ] || [ "$services" = "[]" ] || [ "$services" = "" ]; then
            echo "WARNING: No services to process, using all valid services as fallback"
            services=$(echo -e "$valid_services" | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
          fi

          if [ -z "$services" ] || [ "$services" = "[]" ]; then
            echo "ERROR: Still no services found after fallback"
            services="[]"
          fi

          echo "services=$services" >> $GITHUB_OUTPUT
          echo "Found services: $services"

  test:
    needs: discover-services
    if: needs.discover-services.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.services) }}
      max-parallel: 15  # Increased parallelization

    steps:
      - name: Maximize build space
        run: |
          echo "Available storage:"
          df -h
          echo "Cleaning up Docker..."
          docker system prune -f --volumes || true
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build (runs tests and benchmarks)
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f "Makefile" ] && grep -q "^build:" Makefile; then
            make build
          else
            echo "Running tests..."
            go test ./... || (echo "ERROR: Tests failed" && exit 1)
            echo "Running benchmarks..."
            if [ -f "server/handlers_bench_test.go" ] || find . -name "*_bench_test.go" | grep -q .; then
              go test -run=^$$ -bench=. -benchmem -benchtime=100ms ./server || echo "WARNING: Benchmarks failed, continuing..."
            fi
            echo "Building..."
            go build -o /tmp/${{ matrix.service }} ./...
          fi

  lint:
    needs: discover-services
    if: needs.discover-services.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.services) }}
      max-parallel: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          working-directory: services/${{ matrix.service }}
