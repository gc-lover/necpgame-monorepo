name: CI Monitor

on:
  workflow_run:
    workflows: ["Backend CI"]
    types:
      - completed
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      cleanup_only:
        description: "Only cleanup old reports"
        required: false
        type: boolean
        default: false

env:
  PROJECT_NUMBER: 1
  MAX_REPORTS_TO_KEEP: 5

jobs:
  monitor-workflow:
    if: github.event.inputs.cleanup_only != 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Workflow Run Info
        id: workflow_info
        uses: actions/github-script@v7
        with:
          script: |
            let runId;
            
            if (context.payload.workflow_run) {
              runId = context.payload.workflow_run.id.toString();
              console.log(`Processing workflow_run event for run: ${runId}`);
            } else {
              console.log('No workflow_run event, searching for latest Backend CI run...');
              
              const { data: workflowsList } = await github.rest.actions.listWorkflowsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const backendWorkflow = workflowsList.workflows.find(w => w.name === 'Backend CI' || w.path.endsWith('ci-backend.yml'));
              
              if (!backendWorkflow) {
                console.log('Backend CI workflow not found');
                core.setOutput('should_create_issue', 'false');
                return;
              }
              
              const { data: workflows } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: backendWorkflow.id,
                per_page: 1
              });
              
              if (!workflows.workflow_runs || workflows.workflow_runs.length === 0) {
                console.log('No Backend CI runs found');
                core.setOutput('should_create_issue', 'false');
                return;
              }
              
              const latestRun = workflows.workflow_runs[0];
              runId = latestRun.id.toString();
              
              const runAge = Date.now() - new Date(latestRun.created_at).getTime();
              const maxAge = 24 * 60 * 60 * 1000;
              
              if (runAge > maxAge) {
                console.log(`Latest run is ${Math.floor(runAge / 1000 / 60)} minutes old, skipping`);
                core.setOutput('should_create_issue', 'false');
                return;
              }
              
              console.log(`Found latest Backend CI run: ${runId} (${Math.floor(runAge / 1000 / 60)} minutes ago)`);
            }
            
            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(runId)
            });
            
            if (!run) {
              console.log('Workflow run not found');
              core.setOutput('should_create_issue', 'false');
              return;
            }
            
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(runId),
              per_page: 100
            });
            
            let allJobs = jobs.jobs || [];
            let page = 1;
            while (jobs.jobs.length === 100) {
              const nextPage = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: parseInt(runId),
                per_page: 100,
                page: ++page
              });
              if (nextPage.data.jobs.length === 0) break;
              allJobs = allJobs.concat(nextPage.data.jobs);
            }
            
            const failedJobs = allJobs.filter(job => job.conclusion === 'failure');
            const cancelledJobs = allJobs.filter(job => job.conclusion === 'cancelled');
            const inProgressJobs = allJobs.filter(job => job.status === 'in_progress');
            const successJobs = allJobs.filter(job => job.conclusion === 'success');
            
            const workflowUrl = run.html_url;
            const commitSha = run.head_sha.substring(0, 7);
            const branch = run.head_branch || 'unknown';
            const workflowName = run.name || 'Unknown';
            const workflowStatus = run.conclusion || run.status;
            const createdAt = run.created_at;
            const updatedAt = run.updated_at || run.created_at;
            
            core.setOutput('run_id', runId);
            core.setOutput('workflow_url', workflowUrl);
            core.setOutput('commit_sha', commitSha);
            core.setOutput('branch', branch);
            core.setOutput('workflow_name', workflowName);
            core.setOutput('workflow_status', workflowStatus);
            core.setOutput('created_at', createdAt);
            core.setOutput('updated_at', updatedAt);
            core.setOutput('total_jobs', allJobs.length);
            core.setOutput('success_jobs', successJobs.length);
            core.setOutput('failed_jobs', failedJobs.length);
            core.setOutput('cancelled_jobs', cancelledJobs.length);
            core.setOutput('in_progress_jobs', inProgressJobs.length);
            core.setOutput('jobs_data', JSON.stringify(allJobs));
            core.setOutput('failed_jobs_data', JSON.stringify(failedJobs));
            
            console.log(`Workflow: ${workflowName}`);
            console.log(`Status: ${workflowStatus}`);
            console.log(`Jobs: ${successJobs.length} success, ${failedJobs.length} failed, ${cancelledJobs.length} cancelled, ${inProgressJobs.length} in progress`);
            
            core.setOutput('should_create_issue', 'true');

      - name: Get Project Info
        id: project
        if: steps.workflow_info.outputs.should_create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: projectV2 } = await github.graphql(`
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              number: ${{ env.PROJECT_NUMBER }}
            });
            
            const project = projectV2.user?.projectV2;
            
            if (!project) {
              core.setOutput('project_node_id', '');
              core.setOutput('status_field_id', '');
              return;
            }
            
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const statusFieldId = statusField?.id || '';
            const statusOptions = {};
            
            if (statusField && statusField.options) {
              statusField.options.forEach(opt => {
                statusOptions[opt.name] = opt.id;
              });
            }
            
            core.setOutput('project_node_id', project.id);
            core.setOutput('status_field_id', statusFieldId);
            core.setOutput('status_options', JSON.stringify(statusOptions));

      - name: Create or Update CI Report Issue
        id: create_issue
        if: steps.workflow_info.outputs.should_create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = '${{ steps.workflow_info.outputs.run_id }}';
            const commitSha = '${{ steps.workflow_info.outputs.commit_sha }}';
            const branch = '${{ steps.workflow_info.outputs.branch }}';
            const workflowName = '${{ steps.workflow_info.outputs.workflow_name }}';
            const workflowStatus = '${{ steps.workflow_info.outputs.workflow_status }}';
            const workflowUrl = '${{ steps.workflow_info.outputs.workflow_url }}';
            const totalJobs = parseInt('${{ steps.workflow_info.outputs.total_jobs }}') || 0;
            const successJobs = parseInt('${{ steps.workflow_info.outputs.success_jobs }}') || 0;
            const failedJobs = parseInt('${{ steps.workflow_info.outputs.failed_jobs }}') || 0;
            const cancelledJobs = parseInt('${{ steps.workflow_info.outputs.cancelled_jobs }}') || 0;
            const inProgressJobs = parseInt('${{ steps.workflow_info.outputs.in_progress_jobs }}') || 0;
            const createdAt = '${{ steps.workflow_info.outputs.created_at }}';
            const updatedAt = '${{ steps.workflow_info.outputs.updated_at }}';
            
            const jobsData = JSON.parse('${{ steps.workflow_info.outputs.jobs_data }}' || '[]');
            const failedJobsData = JSON.parse('${{ steps.workflow_info.outputs.failed_jobs_data }}' || '[]');
            
            const title = `[CI] ${workflowName} - ${commitSha} (${branch})`;
            
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const matchingIssue = existingIssues.data.find(issue => 
              issue.title === title || issue.title.includes(commitSha)
            );
            
            let issueNumber;
            
            if (matchingIssue) {
              issueNumber = matchingIssue.number;
              issueNumber = existingIssues.data[0].number;
              
              const statusEmoji = workflowStatus === 'success' ? 'OK' : 
                                 workflowStatus === 'failure' ? '‚ùå' : 
                                 workflowStatus === 'cancelled' ? '‚èπÔ∏è' : 'üîÑ';
              
              const statusText = workflowStatus === 'success' ? 'SUCCESS' :
                                workflowStatus === 'failure' ? 'FAILURE' :
                                workflowStatus === 'cancelled' ? 'CANCELLED' : 'IN_PROGRESS';
              
              let body = `# CI Workflow Report\n\n`;
              body += `${statusEmoji} **Status:** ${statusText}\n\n`;
              body += `**Workflow:** [${workflowName}](${workflowUrl})\n`;
              body += `**Commit:** \`${commitSha}\`\n`;
              body += `**Branch:** \`${branch}\`\n`;
              body += `**Run ID:** ${runId}\n`;
              body += `**Created:** ${new Date(createdAt).toLocaleString()}\n`;
              body += `**Updated:** ${new Date(updatedAt).toLocaleString()}\n\n`;
              body += `---\n\n`;
              body += `## Jobs Summary\n\n`;
              body += `| Status | Count |\n`;
              body += `|--------|-------|\n`;
              body += `| OK Success | ${successJobs} |\n`;
              body += `| ‚ùå Failed | ${failedJobs} |\n`;
              body += `| ‚èπÔ∏è Cancelled | ${cancelledJobs} |\n`;
              body += `| üîÑ In Progress | ${inProgressJobs} |\n`;
              body += `| **Total** | **${totalJobs}** |\n\n`;
              
              if (failedJobsData.length > 0) {
                body += `## Failed Jobs\n\n`;
                for (const job of failedJobsData) {
                  body += `### ‚ùå ${job.name}\n\n`;
                  body += `- **Job ID:** ${job.id}\n`;
                  body += `- **Status:** ${job.status}\n`;
                  body += `- **Conclusion:** ${job.conclusion}\n`;
                  body += `- **Started:** ${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}\n`;
                  body += `- **Completed:** ${job.completed_at ? new Date(job.completed_at).toLocaleString() : 'N/A'}\n`;
                  body += `- **URL:** [View Job](${job.html_url})\n\n`;
                  
                  if (job.steps && job.steps.length > 0) {
                    body += `**Steps:**\n`;
                    for (const step of job.steps) {
                      const stepIcon = step.conclusion === 'success' ? 'OK' :
                                      step.conclusion === 'failure' ? '‚ùå' :
                                      step.conclusion === 'cancelled' ? '‚èπÔ∏è' : 'üîÑ';
                      body += `- ${stepIcon} ${step.name}: ${step.conclusion || step.status}\n`;
                    }
                    body += `\n`;
                  }
                }
              }
              
              if (jobsData.length > 0 && failedJobsData.length === 0) {
                body += `## All Jobs\n\n`;
                for (const job of jobsData) {
                  const jobIcon = job.conclusion === 'success' ? 'OK' :
                                 job.conclusion === 'failure' ? '‚ùå' :
                                 job.conclusion === 'cancelled' ? '‚èπÔ∏è' :
                                 job.status === 'in_progress' ? 'üîÑ' : '‚è≥';
                  body += `- ${jobIcon} [${job.name}](${job.html_url}): ${job.conclusion || job.status}\n`;
                }
              }
              
              body += `\n---\n\n`;
              body += `*This report is automatically generated by CI Monitor workflow.*\n`;
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
              
              console.log(`Updated issue #${issueNumber}`);
            } else {
              const statusEmoji = workflowStatus === 'success' ? 'OK' : 
                                 workflowStatus === 'failure' ? '‚ùå' : 
                                 workflowStatus === 'cancelled' ? '‚èπÔ∏è' : 'üîÑ';
              
              const statusText = workflowStatus === 'success' ? 'SUCCESS' :
                                workflowStatus === 'failure' ? 'FAILURE' :
                                workflowStatus === 'cancelled' ? 'CANCELLED' : 'IN_PROGRESS';
              
              let body = `# CI Workflow Report\n\n`;
              body += `${statusEmoji} **Status:** ${statusText}\n\n`;
              body += `**Workflow:** [${workflowName}](${workflowUrl})\n`;
              body += `**Commit:** \`${commitSha}\`\n`;
              body += `**Branch:** \`${branch}\`\n`;
              body += `**Run ID:** ${runId}\n`;
              body += `**Created:** ${new Date(createdAt).toLocaleString()}\n`;
              body += `**Updated:** ${new Date(updatedAt).toLocaleString()}\n\n`;
              body += `---\n\n`;
              body += `## Jobs Summary\n\n`;
              body += `| Status | Count |\n`;
              body += `|--------|-------|\n`;
              body += `| OK Success | ${successJobs} |\n`;
              body += `| ‚ùå Failed | ${failedJobs} |\n`;
              body += `| ‚èπÔ∏è Cancelled | ${cancelledJobs} |\n`;
              body += `| üîÑ In Progress | ${inProgressJobs} |\n`;
              body += `| **Total** | **${totalJobs}** |\n\n`;
              
              if (failedJobsData.length > 0) {
                body += `## Failed Jobs\n\n`;
                for (const job of failedJobsData) {
                  body += `### ‚ùå ${job.name}\n\n`;
                  body += `- **Job ID:** ${job.id}\n`;
                  body += `- **Status:** ${job.status}\n`;
                  body += `- **Conclusion:** ${job.conclusion}\n`;
                  body += `- **Started:** ${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}\n`;
                  body += `- **Completed:** ${job.completed_at ? new Date(job.completed_at).toLocaleString() : 'N/A'}\n`;
                  body += `- **URL:** [View Job](${job.html_url})\n\n`;
                  
                  if (job.steps && job.steps.length > 0) {
                    body += `**Steps:**\n`;
                    for (const step of job.steps) {
                      const stepIcon = step.conclusion === 'success' ? 'OK' :
                                      step.conclusion === 'failure' ? '‚ùå' :
                                      step.conclusion === 'cancelled' ? '‚èπÔ∏è' : 'üîÑ';
                      body += `- ${stepIcon} ${step.name}: ${step.conclusion || step.status}\n`;
                    }
                    body += `\n`;
                  }
                }
              }
              
              if (jobsData.length > 0 && failedJobsData.length === 0) {
                body += `## All Jobs\n\n`;
                for (const job of jobsData) {
                  const jobIcon = job.conclusion === 'success' ? 'OK' :
                                 job.conclusion === 'failure' ? '‚ùå' :
                                 job.conclusion === 'cancelled' ? '‚èπÔ∏è' :
                                 job.status === 'in_progress' ? 'üîÑ' : '‚è≥';
                  body += `- ${jobIcon} [${job.name}](${job.html_url}): ${job.conclusion || job.status}\n`;
                }
              }
              
              body += `\n---\n\n`;
              body += `*This report is automatically generated by CI Monitor workflow.*\n`;
              
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body
              });
              
              issueNumber = issue.number;
              console.log(`Created issue #${issueNumber}: ${issue.html_url}`);
            }
            
            core.setOutput('issue_number', issueNumber);

      - name: Add Issue to Project
        if: steps.workflow_info.outputs.should_create_issue == 'true' && steps.create_issue.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const statusFieldId = '${{ steps.project.outputs.status_field_id }}';
            const statusOptions = JSON.parse('${{ steps.project.outputs.status_options }}' || '{}');
            const issueNumber = parseInt('${{ steps.create_issue.outputs.issue_number }}');
            
            if (!projectNodeId || !issueNumber) {
              console.log('Skipping: missing project or issue');
              return;
            }
            
            const { data: issue } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            if (!issue.repository.issue) {
              console.log(`Issue #${issueNumber} not found`);
              return;
            }
            
            const issueNodeId = issue.repository.issue.id;
            
            try {
              const { data: addResult } = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: issueNodeId
              });
              
              const projectItemId = addResult?.addProjectV2ItemById?.item?.id;
              
              if (projectItemId && statusFieldId) {
                const devopsStatus = statusOptions['DevOps - Todo'] || 
                                   statusOptions['Backend - Todo'] ||
                                   Object.values(statusOptions)[0];
                
                if (devopsStatus) {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: String!) {
                      updateProjectV2ItemField(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: {
                          singleSelectOptionId: $valueId
                        }
                      }) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: projectNodeId,
                    itemId: projectItemId,
                    fieldId: statusFieldId,
                    valueId: devopsStatus
                  });
                  
                  console.log(`Added issue #${issueNumber} to project with status`);
                }
              }
            } catch (error) {
              console.error(`Error adding issue to project: ${error.message}`);
            }

  cleanup-old-reports:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get Recent Commits
        id: commits
        run: |
          recent_commits=$(git log --oneline -${{ env.MAX_REPORTS_TO_KEEP }} --format="%H")
          echo "recent_commits<<EOF" >> $GITHUB_OUTPUT
          echo "$recent_commits" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$recent_commits" | head -${{ env.MAX_REPORTS_TO_KEEP }}
      
      - name: Cleanup Old CI Reports
        uses: actions/github-script@v7
        with:
          script: |
            const maxReports = ${{ env.MAX_REPORTS_TO_KEEP }};
            const recentCommits = `${{ steps.commits.outputs.recent_commits }}`.trim().split('\n').filter(c => c);
            
            console.log(`Keeping reports for ${recentCommits.length} recent commits`);
            console.log('Recent commits:', recentCommits.map(c => c.substring(0, 7)).join(', '));
            
            const allIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100,
              sort: 'updated',
              direction: 'desc'
            });
            
            const ciReportIssues = allIssues.data.filter(issue => 
              issue.title.startsWith('[CI]')
            );
            
            const issuesToKeep = new Set();
            
            for (const commit of recentCommits) {
              const shortSha = commit.substring(0, 7);
              
              for (const issue of ciReportIssues) {
                if (issue.title.includes(shortSha)) {
                  issuesToKeep.add(issue.number);
                  break;
                }
              }
            }
            
            console.log(`Found ${ciReportIssues.length} CI report issues`);
            console.log(`Keeping ${issuesToKeep.size} issues`);
            
            let closedCount = 0;
            for (const issue of ciReportIssues) {
              if (!issuesToKeep.has(issue.number)) {
                if (issue.state === 'open') {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    state: 'closed',
                    state_reason: 'not_planned'
                  });
                  console.log(`Closed old CI report issue #${issue.number}`);
                  closedCount++;
                }
              }
            }
            
            console.log(`Closed ${closedCount} old CI report issues`);

