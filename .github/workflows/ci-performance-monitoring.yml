name: CI Performance Monitoring

on:
  workflow_run:
    workflows: [ "Backend CI", "Quality Gates" ]
    types: [ completed ]
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  analyze-performance:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install PyYAML requests

      - name: Run CI Performance Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/analyze-ci-performance.py --days 7 --output ci-performance-report.json

      - name: Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: ci-performance-report
          path: ci-performance-report.json
          retention-days: 30

      - name: Performance Alert (if needed)
        run: |
          if [ -f ci-performance-report.json ]; then
            # Check for performance degradation
            python -c "
  import json
with open('ci-performance-report.json') as f:
  data = json.load(f)
  
  workflows = data.get('workflows', {}).get('summary', {})
for name, stats in workflows.items():
  score = stats.get('performance_score', 100)
  if score < 60:
    print(f'::warning::Performance degradation in {name}: { score:.1f }/100')
    exit(1)
  "
          fi

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

- name: Run Docker Security Validation
  run: |
    python scripts/validate-docker-security.py --output docker-security-report.json

- name: Upload Security Report
  uses: actions/upload-artifact@v3
  with:
    name: docker-security-report
    path: docker-security-report.json
    retention-days: 30

- name: Security Alert (if critical issues found)
  run: |
    if [ -f docker-security-report.json ]; then
      python -c "
  import json
  import sys

with open('docker-security-report.json') as f:
  data = json.load(f)
  
  issues = data.get('summary', {}).get('total_issues', 0)
if issues > 0:
  print(f'::error::Found {issues} security issues in Docker/K8s configuration')
  sys.exit(1)
  "
          fi

  generate-insights:
    needs: [analyze-performance, security-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Reports
        uses: actions/download-artifact@v3
        with:
          path: reports/

      - name: Generate Optimization Insights
        run: |
          echo "# CI/CD Optimization Insights" > optimization-insights.md
  echo "" >> optimization-insights.md
  echo "## Performance Analysis" >> optimization-insights.md
  
  if [ -f reports/ci-performance-report/ci-performance-report.json ]; then
  echo "### CI Performance Metrics" >> optimization-insights.md
  python -c "
  import json
with open('reports/ci-performance-report/ci-performance-report.json') as f:
  data = json.load(f)

print(f\"- Analysis Period: { data.get('analysis_period_days', 'N/A') } days\")
  workflows = data.get('workflows', {}).get('summary', {})
for name, stats in workflows.items():
  score = stats.get('performance_score', 0)
  duration = stats.get('avg_duration_seconds', 0)
  success = stats.get('success_rate', 0)
  print(f\"- {name}: Score {score:.1f}/100, {duration:.1f}s avg, {success:.1%} success\")
    " >> optimization-insights.md
    fi
    
    echo "" >> optimization-insights.md
    echo "## Security Analysis" >> optimization-insights.md
    
    if [ -f reports/docker-security-report/docker-security-report.json ]; then
    echo "### Docker/K8s Security" >> optimization-insights.md
    python -c "
  import json
with open('reports/docker-security-report/docker-security-report.json') as f:
  data = json.load(f)
  
  summary = data.get('summary', {})
print(f\"- Docker Score: { summary.get('docker_score', 0):.1f }/100\")
print(f\"- Total Issues: { summary.get('total_issues', 0) }\")
print(f\"- Total Warnings: { summary.get('total_warnings', 0) }\")
print(f\"- Optimization Opportunities: { summary.get('total_optimizations', 0) }\")
                                         " >> optimization-insights.md
                                         fi

                                         - name: Upload Insights Report
                                           uses: actions/upload-artifact@v3
                                           with:
                                             name: optimization-insights
                                             path: optimization-insights.md
                                             retention-days: 30

                                         notify:
                                           needs: [ generate-insights ]
                                           runs-on: ubuntu-latest
                                           if: failure()

                                           steps:
                                             - name: Notify on Performance Issues
                                               run: |
                                                 echo "ðŸš¨ CI/CD Performance Alert" > notification.md
                                                 echo "" >> notification.md
                                                 echo "Performance or security issues detected in CI/CD pipeline." >> notification.md
                                                 echo "Check the uploaded artifacts for detailed reports." >> notification.md

                                             - name: Upload Notification
                                               uses: actions/upload-artifact@v3
                                               with:
                                                 name: performance-alert
                                                 path: notification.md
                                                 retention-days: 7