name: Quest System CI/CD

on:
  push:
    paths:
      - "knowledge/canon/lore/_03-lore/timeline-author/quests/**"
      - "services/gameplay-service-go/**"
      - "proto/openapi/**quest**"
      - "infrastructure/liquibase/migrations/**quest**"
      - "k8s/**quest**"
  pull_request:
    paths:
      - "knowledge/canon/lore/_03-lore/timeline-author/quests/**"
      - "services/gameplay-service-go/**"
      - "proto/openapi/**quest**"
      - "infrastructure/liquibase/migrations/**quest**"
      - "k8s/**quest**"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-gameplay-service-go

jobs:
  validate-quest-content:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install PyYAML jsonschema

      - name: Validate quest YAML schemas
        run: |
          find knowledge/canon/lore/_03-lore/timeline-author/quests -name "*.yaml" -exec python -c "
          import yaml
          import json
          import sys
          from jsonschema import validate, ValidationError

          schema = {
              'type': 'object',
              'required': ['metadata', 'objectives', 'rewards'],
              'properties': {
                  'metadata': {
                      'type': 'object',
                      'required': ['id', 'title', 'quest_type'],
                      'properties': {
                          'id': {'type': 'string'},
                          'title': {'type': 'string'},
                          'quest_type': {'type': 'string', 'enum': ['main', 'side', 'cultural', 'mystery', 'culinary']}
                      }
                  },
                  'objectives': {'type': 'array', 'minItems': 1},
                  'rewards': {'type': 'object'}
              }
          }

          try:
              with open('{}', 'r', encoding='utf-8') as f:
                  data = yaml.safe_load(f)
              validate(instance=data, schema=schema)
              print('OK {} - valid'.format('{}'))
          except Exception as e:
              print('‚ùå {} - {}'.format('{}', str(e)))
              sys.exit(1)
          " \;

      - name: Check quest ID uniqueness
        run: |
          ids=$(find knowledge/canon/lore/_03-lore/timeline-author/quests -name "*.yaml" -exec grep -l "id:" {} \; | xargs grep "id:" | sed 's/.*id: //' | sort | uniq -c | grep -v " 1 " || true)
          if [ -n "$ids" ]; then
            echo "‚ùå Duplicate quest IDs found:"
            echo "$ids"
            exit 1
          else
            echo "OK All quest IDs are unique"
          fi

  test-quest-import:
    needs: validate-quest-content
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: necpgame
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Create database schema
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d necpgame -f infrastructure/liquibase/migrations/V1_46__quest_definitions_tables.sql

      - name: Import Miami quests
        run: |
          for quest_file in knowledge/canon/lore/_03-lore/timeline-author/quests/america/miami/2020-2029/quest-*.yaml; do
            if [ -f "$quest_file" ]; then
              echo "Importing $quest_file"
              python3 scripts/import-quest.py "$quest_file"
            fi
          done

      - name: Import Detroit quests
        run: |
          for quest_file in knowledge/canon/lore/_03-lore/timeline-author/quests/america/detroit/2020-2029/quest-*.yaml; do
            if [ -f "$quest_file" ]; then
              echo "Importing $quest_file"
              python3 scripts/import-quest.py "$quest_file"
            fi
          done

      - name: Import Mexico City quests
        run: |
          for quest_file in knowledge/canon/lore/_03-lore/timeline-author/quests/america/mexico-city/2020-2029/quest-*.yaml; do
            if [ -f "$quest_file" ]; then
              echo "Importing $quest_file"
              python3 scripts/import-quest.py "$quest_file"
            fi
          done

      - name: Verify imported quests
        run: |
          count=$(PGPASSWORD=postgres psql -h localhost -U postgres -d necpgame -t -c "SELECT COUNT(*) FROM gameplay.quest_definitions WHERE id LIKE 'quest-%';")
          echo "Imported $count quests"

          if [ "$count" -lt 6 ]; then
            echo "‚ùå Expected at least 6 quests, got $count"
            exit 1
          else
            echo "OK Successfully imported $count quests"
          fi

  build-and-test:
    needs: test-quest-import
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build gameplay service
        run: |
          cd services/gameplay-service-go
          go mod download
          go build -o gameplay-service .

      - name: Run tests
        run: |
          cd services/gameplay-service-go
          go test ./... -v -coverprofile=coverage.out

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./services/gameplay-service-go/coverage.out
          flags: quest-system

  deploy-staging:
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying quest system to staging environment"
          # Add actual deployment commands here

  deploy-production:
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to production
        run: |
          echo "üéØ Deploying quest system to production environment"
          # Add actual deployment commands here

