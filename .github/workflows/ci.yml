name: Monorepo CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      openapi: ${{ steps.filter.outputs.openapi }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'services/backend/**'
            frontend:
              - 'services/frontend/**'
            openapi:
              - 'services/openapi/**'

  structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check architecture health
        run: pwsh -File pipeline/scripts/check-architecture-health.ps1 -RootPath $PWD
      - name: Detect markdown in knowledge
        run: pwsh -File pipeline/scripts/check-knowledge-markdown.ps1
      - name: Validate knowledge review dates
        run: pwsh -File pipeline/scripts/check-knowledge-review.ps1
      - name: Validate queues
        shell: pwsh
        run: |
          Get-ChildItem shared/trackers/queues -Recurse -Filter '*.yaml' |
            ForEach-Object {
              pwsh -File pipeline/scripts/check-queue-yaml.ps1 -File $_.FullName
            }

  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install yamllint
        run: pip install yamllint
      - name: Run yamllint
        run: yamllint . -c .yamllint

  spectral:
    needs: [changes]
    if: needs.changes.outputs.openapi == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli
      - name: Lint OpenAPI specs
        run: spectral lint "services/openapi/**/*.yaml" -c .spectral.yaml

  activity-log:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch base ref
        if: github.event_name == 'pull_request' && github.base_ref != ''
        run: git fetch origin ${{ github.base_ref }} --depth=1
      - name: Check Activity Log coverage
        shell: pwsh
        run: |
          $base = if ("${{ github.event_name }}" -eq "pull_request" -and "${{ github.base_ref }}") { "origin/${{ github.base_ref }}" } else { $null }
          if ($base) {
            pwsh -File pipeline/scripts/check-activity-log.ps1 -BaseRef $base
          } else {
            pwsh -File pipeline/scripts/check-activity-log.ps1
          }

  openapi:
    needs: [changes]
    if: needs.changes.outputs.openapi == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate OpenAPI specs
        run: pwsh -File pipeline/scripts/validate-swagger.ps1 -ApiDirectory services/openapi/api/v1

  backend:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check backend structure
        run: pwsh -File pipeline/scripts/check-backend-structure.ps1 -ProjectRoot services/backend

  frontend:
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check frontend structure
        run: pwsh -File pipeline/scripts/check-frontend-structure.ps1 -ProjectRoot services/frontend
  pr-main-validation:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    needs:
      - changes
      - structure
      - openapi
      - backend
      - frontend
      - yamllint
      - spectral
      - activity-log
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run precommit suite
        run: pwsh -File pipeline/scripts/run-precommit.ps1
      - name: Validate knowledge schema
        run: pwsh -File pipeline/scripts/check-knowledge-schema.ps1 -KnowledgeRoot shared/docs/knowledge
      - name: Ensure automation module available
        shell: pwsh
        run: |
          $modulePath = Join-Path (Resolve-Path pipeline/scripts/modules) 'Pipeline.Automation.psm1'
          Import-Module -Name $modulePath -ErrorAction Stop
          Write-Output "Loaded Pipeline.Automation from $modulePath"
      - name: Placeholder backend tests
        if: ${{ needs.changes.outputs.backend == 'true' }}
        run: |
          echo "TODO: добавить mvn test / gradle test"
      - name: Placeholder frontend tests
        if: ${{ needs.changes.outputs.frontend == 'true' }}
        run: |
          echo "TODO: добавить npm test"
