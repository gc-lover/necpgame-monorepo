name: Monorepo CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      openapi: ${{ steps.filter.outputs.openapi }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'services/backend/**'
            frontend:
              - 'services/frontend/**'
            openapi:
              - 'services/openapi/**'

  structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check architecture health
        run: pwsh -File pipeline/scripts/check-architecture-health.ps1 -RootPath $PWD
      - name: Detect markdown in knowledge
        run: pwsh -File pipeline/scripts/check-knowledge-markdown.ps1
      - name: Validate knowledge review dates
        run: pwsh -File pipeline/scripts/check-knowledge-review.ps1
      - name: Validate queues
        shell: pwsh
        run: |
          Get-ChildItem shared/trackers/queues -Recurse -Filter '*.yaml' |
            ForEach-Object {
              pwsh -File pipeline/scripts/check-queue-yaml.ps1 -File $_.FullName
            }

  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install yamllint
        run: pip install yamllint
      - name: Run yamllint
        run: yamllint . -c .yamllint

  spectral:
    needs: [changes]
    if: needs.changes.outputs.openapi == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli
      - name: Lint OpenAPI specs
        run: spectral lint "services/openapi/**/*.yaml" -c .spectral.yaml

  activity-log:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch base ref
        if: github.event_name == 'pull_request' && github.base_ref != ''
        run: git fetch origin ${{ github.base_ref }} --depth=1
      - name: Check Activity Log coverage
        shell: pwsh
        run: |
          $base = if ("${{ github.event_name }}" -eq "pull_request" -and "${{ github.base_ref }}") { "origin/${{ github.base_ref }}" } else { $null }
          if ($base) {
            pwsh -File pipeline/scripts/check-activity-log.ps1 -BaseRef $base
          } else {
            pwsh -File pipeline/scripts/check-activity-log.ps1
          }

  openapi:
    needs: [changes]
    if: needs.changes.outputs.openapi == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate OpenAPI specs
        run: pwsh -File pipeline/scripts/validate-swagger.ps1 -ApiDirectory services/openapi/api/v1

  backend:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check backend structure
        run: pwsh -File pipeline/scripts/check-backend-structure.ps1 -ProjectRoot services/backend

  frontend:
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check frontend structure
        run: pwsh -File pipeline/scripts/check-frontend-structure.ps1 -ProjectRoot services/frontend
  pr-main-validation:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    needs:
      - changes
      - structure
      - yamllint
      - activity-log
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check backend and frontend job status
        uses: actions/github-script@v7
        id: check-jobs
        with:
          script: |
            const core = require('@actions/core');
            const github = require('@actions/github');
            
            const backendChanged = '${{ needs.changes.outputs.backend }}' === 'true';
            const frontendChanged = '${{ needs.changes.outputs.frontend }}' === 'true';
            
            if (!backendChanged && !frontendChanged) {
              core.info('No backend or frontend changes detected, skipping job status check');
              return;
            }
            
            let backendFailed = false;
            let frontendFailed = false;
            
            const maxAttempts = 30;
            const delayMs = 2000;
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              try {
                const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: context.runId
                });
                
                let allJobsCompleted = true;
                
                if (backendChanged) {
                  const backendJob = jobs.jobs.find(job => job.name === 'backend');
                  if (backendJob) {
                    if (backendJob.status !== 'completed') {
                      allJobsCompleted = false;
                    } else if (backendJob.conclusion === 'failure') {
                      backendFailed = true;
                      core.error('Backend job failed');
                    }
                  } else {
                    core.warning('Backend job not found in workflow run');
                  }
                }
                
                if (frontendChanged) {
                  const frontendJob = jobs.jobs.find(job => job.name === 'frontend');
                  if (frontendJob) {
                    if (frontendJob.status !== 'completed') {
                      allJobsCompleted = false;
                    } else if (frontendJob.conclusion === 'failure') {
                      frontendFailed = true;
                      core.error('Frontend job failed');
                    }
                  } else {
                    core.warning('Frontend job not found in workflow run');
                  }
                }
                
                if (allJobsCompleted) {
                  break;
                }
                
                if (attempt < maxAttempts - 1) {
                  await new Promise(resolve => setTimeout(resolve, delayMs));
                }
              } catch (error) {
                core.warning(`Failed to check job status (attempt ${attempt + 1}/${maxAttempts}): ${error.message}`);
                if (attempt < maxAttempts - 1) {
                  await new Promise(resolve => setTimeout(resolve, delayMs));
                }
              }
            }
            
            if (backendFailed || frontendFailed) {
              const errors = [];
              if (backendFailed) {
                errors.push('Backend job failed');
              }
              if (frontendFailed) {
                errors.push('Frontend job failed');
              }
              core.setFailed(errors.join(', '));
            }
      - name: Run precommit suite
        run: pwsh -File pipeline/scripts/run-precommit.ps1
      - name: Validate knowledge schema
        run: pwsh -File pipeline/scripts/check-knowledge-schema.ps1 -KnowledgeRoot shared/docs/knowledge
      - name: Ensure automation module available
        shell: pwsh
        run: |
          $modulePath = Join-Path (Resolve-Path pipeline/scripts/modules) 'Pipeline.Automation.psm1'
          Import-Module -Name $modulePath -ErrorAction Stop
          Write-Output "Loaded Pipeline.Automation from $modulePath"
      - name: Placeholder backend tests
        if: ${{ needs.changes.outputs.backend == 'true' }}
        run: |
          echo "TODO: добавить mvn test / gradle test"
      - name: Placeholder frontend tests
        if: ${{ needs.changes.outputs.frontend == 'true' }}
        run: |
          echo "TODO: добавить npm test"
