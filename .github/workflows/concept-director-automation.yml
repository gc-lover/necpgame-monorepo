name: Concept Director Automation

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  concept-director:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up PowerShell
        uses: actions/setup-powershell@v1
        with:
          pwsh-version: '7.4'
      
      - name: Create lock directory
        run: |
          mkdir -p shared/trackers/locks
          echo "Lock directory created"
      
      - name: Check for existing lock
        id: check_lock
        run: |
          if [ -f "shared/trackers/locks/concept-director.lock" ]; then
            LOCK_AGE=$(($(date +%s) - $(stat -c %Y shared/trackers/locks/concept-director.lock 2>/dev/null || echo 0)))
            if [ $LOCK_AGE -gt 3600 ]; then
              echo "lock_stale=true" >> $GITHUB_OUTPUT
              echo "Stale lock detected (age: ${LOCK_AGE}s)"
            else
              echo "lock_stale=false" >> $GITHUB_OUTPUT
              echo "Active lock detected (age: ${LOCK_AGE}s)"
            fi
          else
            echo "lock_stale=false" >> $GITHUB_OUTPUT
            echo "No lock file found"
          fi
      
      - name: Acquire lock
        id: acquire_lock
        if: steps.check_lock.outputs.lock_stale == 'false'
        run: |
          LOCK_FILE="shared/trackers/locks/concept-director.lock"
          RUN_ID="${{ github.run_id }}"
          echo "$RUN_ID" > "$LOCK_FILE"
          echo "Lock acquired: $RUN_ID"
          echo "lock_acquired=true" >> $GITHUB_OUTPUT
      
      - name: Remove stale lock
        if: steps.check_lock.outputs.lock_stale == 'true'
        run: |
          rm -f shared/trackers/locks/concept-director.lock
          echo "Stale lock removed"
      
      - name: Run Concept Director automation
        id: run_automation
        if: steps.acquire_lock.outputs.lock_acquired == 'true' || steps.check_lock.outputs.lock_stale == 'true'
        continue-on-error: true
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            DRY_RUN_FLAG="-DryRun"
            echo "Running in dry-run mode"
          fi
          
          if [ -f "pipeline/scripts/modules/Pipeline.Automation.psm1" ]; then
            pwsh -Command "Import-Module ./pipeline/scripts/modules/Pipeline.Automation.psm1; Start-ConceptDirectorAutomation $DRY_RUN_FLAG"
          else
            echo "Pipeline.Automation.psm1 not found, skipping automation"
            echo "automation_status=skipped" >> $GITHUB_OUTPUT
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "automation_status=completed" >> $GITHUB_OUTPUT
      
      - name: Release lock
        if: always() && (steps.acquire_lock.outputs.lock_acquired == 'true' || steps.check_lock.outputs.lock_stale == 'true')
        run: |
          LOCK_FILE="shared/trackers/locks/concept-director.lock"
          RUN_ID="${{ github.run_id }}"
          if [ -f "$LOCK_FILE" ] && [ "$(cat $LOCK_FILE)" == "$RUN_ID" ]; then
            rm -f "$LOCK_FILE"
            echo "Lock released: $RUN_ID"
          fi
      
      - name: Log telemetry
        if: always()
        run: |
          mkdir -p shared/trackers/logs
          TELEMETRY_FILE="shared/trackers/logs/automation-telemetry.yaml"
          
          cat >> "$TELEMETRY_FILE" << EOF
          - run_id: ${{ github.run_id }}
            workflow: ${{ github.workflow }}
            event: ${{ github.event_name }}
            started_at: ${{ steps.run_automation.outputs.start_time }}
            completed_at: ${{ steps.run_automation.outputs.end_time }}
            duration_seconds: ${{ steps.run_automation.outputs.duration }}
            status: ${{ steps.run_automation.outputs.automation_status }}
            commit: ${{ github.sha }}
            branch: ${{ github.ref }}
          EOF
          
          echo "Telemetry logged to $TELEMETRY_FILE"
      
      - name: Check for errors
        if: steps.run_automation.outcome == 'failure'
        run: |
          echo "Automation failed. Check logs above."
          exit 1
      
      - name: Commit changes
        if: steps.run_automation.outputs.automation_status == 'completed' && github.event_name != 'schedule'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[automation] Concept Director automation run ${{ github.run_id }}"
          file_pattern: 'shared/trackers/**'

