name: Concept Director Lock Cleanup

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  cleanup-locks:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Cleanup stale locks
        run: |
          LOCK_DIR="shared/trackers/locks"
          STALE_AGE=3600
          
          if [ -d "$LOCK_DIR" ]; then
            find "$LOCK_DIR" -name "*.lock" -type f -mmin +$((STALE_AGE / 60)) -delete
            echo "Stale locks cleaned up"
          else
            echo "Lock directory not found, creating..."
            mkdir -p "$LOCK_DIR"
          fi
      
      - name: Report lock status
        run: |
          LOCK_DIR="shared/trackers/locks"
          if [ -d "$LOCK_DIR" ]; then
            LOCK_COUNT=$(find "$LOCK_DIR" -name "*.lock" -type f | wc -l)
            echo "Active locks: $LOCK_COUNT"
            
            if [ $LOCK_COUNT -gt 0 ]; then
              echo "Lock files:"
              find "$LOCK_DIR" -name "*.lock" -type f -exec ls -lh {} \;
            fi
          fi

