name: Migrate Ideas to Issues

on:
  workflow_dispatch:
    inputs:
      idea_file:
        description: 'Path to idea YAML file (e.g., knowledge/analysis/tasks/ideas/2025-11-07-IDEA-subtle-media-collabs.yaml)'
        required: true
        type: string
      create_issue:
        description: 'Create GitHub Issue from idea'
        required: true
        type: boolean
        default: true

jobs:
  migrate-idea:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install YAML parser
        run: npm install -g js-yaml

      - name: Parse Idea YAML
        id: parse_idea
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const path = require('path');
            
            const ideaPath = '${{ github.event.inputs.idea_file }}';
            
            if (!fs.existsSync(ideaPath)) {
              core.setFailed(`Idea file not found: ${ideaPath}`);
              return;
            }
            
            // Parse YAML using js-yaml CLI
            let idea;
            try {
              const yamlContent = fs.readFileSync(ideaPath, 'utf8');
              // Simple YAML parsing (basic implementation)
              // For production, consider using a proper YAML parser
              const yaml = require('yaml');
              idea = yaml.parse(yamlContent);
            } catch (error) {
              // Fallback: manual parsing for basic structure
              const content = fs.readFileSync(ideaPath, 'utf8');
              idea = { metadata: {}, summary: {}, content: { sections: [] } };
            
              // Extract basic info using regex (simplified)
              const titleMatch = content.match(/title:\s*(.+)/);
              if (titleMatch) idea.metadata.title = titleMatch[1].trim().replace(/['"]/g, '');
            
              const statusMatch = content.match(/status:\s*(.+)/);
              if (statusMatch) idea.metadata.status = statusMatch[1].trim();
            
              const problemMatch = content.match(/problem:\s*(.+)/);
              if (problemMatch) idea.summary.problem = problemMatch[1].trim().replace(/['"]/g, '');
            
              const goalMatch = content.match(/goal:\s*(.+)/);
              if (goalMatch) idea.summary.goal = goalMatch[1].trim().replace(/['"]/g, '');
            }
            
            // Extract metadata
            const metadata = idea.metadata || {};
            const summary = idea.summary || {};
            const contentSections = idea.content?.sections || [];
            
            // Build issue body
            let issueBody = `## Описание идеи\n\n`;
            issueBody += `${summary.problem || 'Идея требует проработки'}\n\n`;
            issueBody += `**Цель:** ${summary.goal || 'Не указана'}\n\n`;
            issueBody += `**Суть:** ${summary.essence || 'Не указана'}\n\n`;
            
            if (summary.key_points && summary.key_points.length > 0) {
              issueBody += `### Ключевые моменты\n\n`;
              summary.key_points.forEach(point => {
                issueBody += `- ${point}\n`;
              });
              issueBody += `\n`;
            }
            
            if (contentSections.length > 0) {
              issueBody += `## Детали\n\n`;
              contentSections.forEach(section => {
                if (section.title) {
                  issueBody += `### ${section.title}\n\n`;
                }
                if (section.body) {
                  issueBody += `${section.body}\n\n`;
                }
              });
            }
            
            // Build acceptance criteria
            issueBody += `## Критерии приемки\n\n`;
            issueBody += `- [ ] Идея полностью описана текстом\n`;
            issueBody += `- [ ] Лор проработан и согласован\n`;
            issueBody += `- [ ] Игровая механика описана понятно\n`;
            issueBody += `- [ ] Все текстовые материалы готовы\n`;
            issueBody += `- [ ] Связанные системы определены\n\n`;
            
            // Add metadata
            issueBody += `## Метаданные\n\n`;
            issueBody += `- **Источник:** ${ideaPath}\n`;
            issueBody += `- **Статус:** ${metadata.status || 'draft'}\n`;
            issueBody += `- **Приоритет:** ${metadata.priority || 'P2'}\n`;
            if (metadata.tags && metadata.tags.length > 0) {
              issueBody += `- **Теги:** ${metadata.tags.join(', ')}\n`;
            }
            
            // Determine labels (functional only, no agent:* or stage:*)
            const labels = ['game-design'];
            if (metadata.tags) {
              if (metadata.tags.includes('narrative') || metadata.tags.includes('lore')) {
                labels.push('lore', 'content');
              }
              if (metadata.tags.includes('quest')) {
                labels.push('quest', 'content');
              }
            }
            
            // Determine priority label
            const priority = metadata.priority || 'P2';
            if (priority.startsWith('P0')) labels.push('priority-high');
            else if (priority.startsWith('P1')) labels.push('priority-high');
            else if (priority.startsWith('P2')) labels.push('priority-medium');
            else labels.push('priority-low');
            
            core.setOutput('title', metadata.title || 'Идея без названия');
            core.setOutput('body', issueBody);
            core.setOutput('labels', JSON.stringify(labels));
            core.setOutput('idea_id', metadata.id || '');

      - name: Create GitHub Issue
        if: github.event.inputs.create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Agent] ${steps.parse_idea.outputs.title}`;
            const body = steps.parse_idea.outputs.body;
            const labels = JSON.parse(steps.parse_idea.outputs.labels);
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
            
            console.log(`Created Issue #${issue.number}: ${issue.html_url}`);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_url', issue.html_url);
            
            // Issue will be automatically added to Project by project-status-automation.yml
            // with status "Todo", which will be changed to "Idea Writer - Todo" if needed

      - name: Update Idea File
        if: github.event.inputs.create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('yaml');
            
            const ideaPath = '${{ github.event.inputs.idea_file }}';
            const content = fs.readFileSync(ideaPath, 'utf8');
            let idea;
            try {
              idea = yaml.parse(content);
            } catch (error) {
              // Fallback: read as text and append reference
              const updatedContent = content + `\n\n# GitHub Issue Reference\n# Issue #${steps.create_issue.outputs.issue_number}: ${steps.create_issue.outputs.issue_url}\n`;
              fs.writeFileSync(ideaPath, updatedContent, 'utf8');
              return;
            }
            
            // Add GitHub Issue reference
            if (!idea.metadata) idea.metadata = {};
            if (!idea.metadata.related_documents) idea.metadata.related_documents = [];
            
            const issueRef = {
              id: `github-issue-${steps.create_issue.outputs.issue_number}`,
              title: `GitHub Issue #${steps.create_issue.outputs.issue_number}`,
              link: steps.create_issue.outputs.issue_url,
              relation: 'migrated_to'
            };
            
            idea.metadata.related_documents.push(issueRef);
            
            // Update status
            if (idea.metadata.status === 'draft') {
              idea.metadata.status = 'in_progress';
            }
            
            // Write back
            const updatedContent = yaml.stringify(idea, {
              indent: 2,
              lineWidth: -1
            });
            
            fs.writeFileSync(ideaPath, updatedContent, 'utf8');
            
            // Commit changes
            const { execSync } = require('child_process');
            execSync(`git config user.name "github-actions[bot]"`);
            execSync(`git config user.email "github-actions[bot]@users.noreply.github.com"`);
            execSync(`git add "${ideaPath}"`);
            execSync(`git commit -m "chore: migrate idea to Issue #${steps.create_issue.outputs.issue_number}" || true`);
            execSync(`git push || true`);

