name: Project Status Automation

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, ready_for_review]

env:
  PROJECT_NUMBER: 1

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
      projects: write
    steps:
      - name: Get Project ID
        id: project
        uses: actions/github-script@v7
        with:
          script: |
            const { data: projects } = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            if (projects.length === 0) {
              core.setOutput('project_id', '');
              core.setOutput('project_node_id', '');
              return;
            }
            
            const project = projects.find(p => p.number == ${{ env.PROJECT_NUMBER }}) || projects[0];
            core.setOutput('project_id', project.id);
            core.setOutput('project_number', project.number);
            
            const { data: projectV2 } = await github.graphql(`
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                  }
                }
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              number: ${{ env.PROJECT_NUMBER }}
            });
            
            const projectNodeId = projectV2.organization?.projectV2?.id || 
                                  projectV2.user?.projectV2?.id || '';
            
            if (projectNodeId) {
              core.setOutput('project_node_id', projectNodeId);
            } else {
              core.setOutput('project_node_id', '');
            }

      - name: Add Issue to Project
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const issueNumber = context.payload.issue.number;
            
            if (!projectNodeId || !issueNumber) {
              console.log('Skipping: missing project or issue');
              return;
            }
            
            const { data: issue } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            if (issue.repository.issue) {
              await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: issue.repository.issue.id
              });
              
              console.log(`Added issue #${issueNumber} to project`);
            }

      - name: Get Development Stage Field
        id: stage_field
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            if (!projectNodeId) {
              core.setOutput('field_id', '');
              return;
            }
            
            const { data: fields } = await github.graphql(`
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { projectId: projectNodeId });
            
            const stageField = fields?.node?.fields?.nodes?.find(f => f.name === 'Developmen Stage' || f.name === 'Development Stage');
            if (stageField) {
              core.setOutput('field_id', stageField.id);
            }

      - name: Determine Stage from Labels
        id: determine_stage
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue?.labels || context.payload.pull_request?.labels || [];
            const labelNames = labels.map(l => l.name);
            
            let stage = '';
            let agent = '';
            
            if (labelNames.some(l => l.includes('content-writer') || l.includes('content'))) {
              stage = 'content-writer';
              agent = 'content-writer';
            } else if (labelNames.some(l => l.includes('idea-writer') || l.includes('idea'))) {
              stage = 'idea-writer';
              agent = 'idea-writer';
            } else if (labelNames.some(l => l.includes('architect') || l.includes('architecture'))) {
              stage = 'architect';
              agent = 'architect';
            } else if (labelNames.some(l => l.includes('database'))) {
              stage = 'database-dev';
              agent = 'database';
            } else if (labelNames.some(l => l.includes('api-designer') || l.includes('api'))) {
              stage = 'api-designer';
              agent = 'api-designer';
            } else if (labelNames.some(l => l.includes('backend'))) {
              stage = 'backend-dev';
              agent = 'backend';
            } else if (labelNames.some(l => l.includes('network'))) {
              stage = 'network-dev';
              agent = 'network';
            } else if (labelNames.some(l => l.includes('security'))) {
              stage = 'security';
              agent = 'security';
            } else if (labelNames.some(l => l.includes('devops'))) {
              stage = 'devops';
              agent = 'devops';
            } else if (labelNames.some(l => l.includes('performance'))) {
              stage = 'performance';
              agent = 'performance';
            } else if (labelNames.some(l => l.includes('ue5') || l.includes('client'))) {
              stage = 'ue5-dev';
              agent = 'ue5';
            } else if (labelNames.some(l => l.includes('qa') || l.includes('testing'))) {
              stage = 'testing';
              agent = 'qa';
            } else if (labelNames.some(l => l.includes('game-balance'))) {
              stage = 'game-balance';
              agent = 'game-balance';
            } else if (labelNames.some(l => l.includes('release'))) {
              stage = 'release';
              agent = 'release';
            }
            
            core.setOutput('stage', stage);
            core.setOutput('agent', agent);

      - name: Update Project Item Status
        if: steps.determine_stage.outputs.stage != ''
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const fieldId = '${{ steps.stage_field.outputs.field_id }}';
            const stage = '${{ steps.determine_stage.outputs.stage }}';
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            
            if (!projectNodeId || !fieldId || !issueNumber) {
              console.log('Missing required data:', { projectNodeId, fieldId, issueNumber });
              return;
            }
            
            const { data: project } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issueOrPullRequest(number: $number) {
                    ... on Issue {
                      id
                    }
                    ... on PullRequest {
                      id
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            const itemId = project.repository.issueOrPullRequest.id;
            
            const { data: projectV2 } = await github.graphql(`
              query($projectId: ID!, $itemId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                          }
                          ... on PullRequest {
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              projectId: projectNodeId,
              itemId: itemId
            });
            
            const projectItem = projectV2.node.items.nodes.find(item => 
              item.content && item.content.number === issueNumber
            );
            
            if (!projectItem) {
              console.log(`Issue #${issueNumber} not found in project, adding...`);
              await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: itemId
              });
              
              const { data: newProjectV2 } = await github.graphql(`
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: itemId
              });
              
              const newItem = newProjectV2.node.items.nodes.find(item => 
                item.content && item.content.number === issueNumber
              );
              
              if (newItem) {
                const { data: fieldOptions } = await github.graphql(`
                  query($projectId: ID!, $fieldId: ID!) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        field(id: $fieldId) {
                          ... on ProjectV2SingleSelectField {
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                `, {
                  projectId: projectNodeId,
                  fieldId: fieldId
                });
                
                const option = fieldOptions.node.field.options.find(opt => 
                  opt.name.toLowerCase().replace(/\s+/g, '-') === stage
                );
                
                if (option) {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(
                        input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: {
                            singleSelectOptionId: $optionId
                          }
                        }
                      ) {
                        clientMutationId
                      }
                    }
                  `, {
                    projectId: projectNodeId,
                    itemId: newItem.id,
                    fieldId: fieldId,
                    optionId: option.id
                  });
                  
                  console.log(`Added and updated issue #${issueNumber} to stage: ${stage}`);
                }
              }
              return;
            }
            
            const { data: fieldOptions } = await github.graphql(`
              query($projectId: ID!, $fieldId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    field(id: $fieldId) {
                      ... on ProjectV2SingleSelectField {
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `, {
              projectId: projectNodeId,
              fieldId: fieldId
            });
            
            const option = fieldOptions.node.field.options.find(opt => 
              opt.name.toLowerCase().replace(/\s+/g, '-') === stage
            );
            
            if (option) {
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }
                  ) {
                    clientMutationId
                  }
                }
              `, {
                projectId: projectNodeId,
                itemId: projectItem.id,
                fieldId: fieldId,
                optionId: option.id
              });
              
              console.log(`Updated project item ${projectItem.id} to stage: ${stage}`);
            }

      - name: Add Agent Label
        if: steps.determine_stage.outputs.agent != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            const agent = '${{ steps.determine_stage.outputs.agent }}';
            const stage = '${{ steps.determine_stage.outputs.stage }}';
            
            if (issueNumber && agent) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [`agent:${agent}`]
              });
              
              const agentNames = {
                'idea-writer': 'üé® Idea Writer',
                'content-writer': '‚úçÔ∏è Content Writer',
                'architect': 'üìê Architect',
                'api-designer': 'üìã API Designer',
                'backend': '‚öôÔ∏è Backend Developer',
                'network': 'üåê Network Engineer',
                'devops': 'üê≥ DevOps',
                'performance': '‚ö° Performance Engineer',
                'ue5': 'üéÆ UE5 Developer',
                'qa': 'üß™ QA/Testing',
                'release': 'üöÄ Release Manager'
              };
              
              const agentName = agentNames[agent] || agent;
              
              const comment = '## OK –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –∞–≥–µ–Ω—Ç—É: ' + agentName + '\n\n' +
                '**–≠—Ç–∞–ø:** `' + stage + '`\n\n' +
                '–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∞–≥–µ–Ω—Ç—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ê–≥–µ–Ω—Ç –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç—É —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤ `.cursor/rules/agent-' + agent + '.mdc`.\n\n' +
                '**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n' +
                '- –ê–≥–µ–Ω—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É\n' +
                '- –í—ã–ø–æ–ª–Ω–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è\n' +
                '- –û–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É\n\n' +
                '---\n' +
                '*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤*';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: comment
              });
            }

      - name: Check Task Readiness
        if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '[x]') || contains(github.event.comment.body, '- [x]')
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) return;
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const body = issue.body || '';
            const checkboxes = body.match(/- \[([ x])\]/g) || [];
            const checked = checkboxes.filter(cb => cb.includes('x')).length;
            const total = checkboxes.length;
            
            if (total > 0 && checked === total) {
              const labels = issue.labels.map(l => l.name);
              const labelNames = labels.map(l => l.name);
              
              const hasContentLabels = labelNames.some(l => ['canon', 'lore', 'quest'].includes(l));
              const isContentQuest = hasContentLabels && (labelNames.some(l => l.includes('idea-writer')) || labelNames.some(l => l.includes('content')));
              
              const stageTransitions = {
                'idea-writer': isContentQuest ? 'content-writer' : 'architect',
                'content-writer': 'testing',
                'architect': 'database-dev',
                'database-dev': 'api-designer',
                'api-designer': 'backend-dev',
                'backend-dev': 'network-dev',
                'network-dev': 'security',
                'security': 'devops',
                'devops': 'ue5-dev',
                'ue5-dev': 'testing',
                'testing': 'game-balance',
                'game-balance': 'release',
                'performance': null
              };
              
              let currentStage = '';
              if (labelNames.some(l => l.includes('content-writer') || l.includes('content'))) currentStage = 'content-writer';
              else if (labelNames.some(l => l.includes('idea-writer'))) currentStage = 'idea-writer';
              else if (labelNames.some(l => l.includes('architect'))) currentStage = 'architect';
              else if (labelNames.some(l => l.includes('database'))) currentStage = 'database-dev';
              else if (labelNames.some(l => l.includes('api-designer'))) currentStage = 'api-designer';
              else if (labelNames.some(l => l.includes('backend'))) currentStage = 'backend-dev';
              else if (labelNames.some(l => l.includes('network'))) currentStage = 'network-dev';
              else if (labelNames.some(l => l.includes('security'))) currentStage = 'security';
              else if (labelNames.some(l => l.includes('devops'))) currentStage = 'devops';
              else if (labelNames.some(l => l.includes('ue5') || l.includes('client'))) currentStage = 'ue5-dev';
              else if (labelNames.some(l => l.includes('testing') || l.includes('qa'))) currentStage = 'testing';
              else if (labelNames.some(l => l.includes('game-balance'))) currentStage = 'game-balance';
              
              const nextStage = stageTransitions[currentStage];
              
              if (nextStage) {
                const nextAgentLabels = {
                  'content-writer': ['agent:content-writer', 'stage:content'],
                  'architect': ['agent:architect', 'stage:design'],
                  'database-dev': ['agent:database', 'stage:database'],
                  'api-designer': ['agent:api-designer', 'stage:api-design'],
                  'backend-dev': ['agent:backend', 'stage:backend-dev'],
                  'network-dev': ['agent:network', 'stage:network'],
                  'security': ['agent:security', 'stage:security'],
                  'devops': ['agent:devops', 'stage:infrastructure'],
                  'ue5-dev': ['agent:ue5', 'stage:client-dev'],
                  'testing': ['agent:qa', 'stage:testing'],
                  'game-balance': ['agent:game-balance', 'stage:balance'],
                  'release': ['agent:release', 'stage:release']
                };
                
                const nextLabels = nextAgentLabels[nextStage] || [`stage:${nextStage}`];
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: nextLabels
                });
                
                const agentNames = {
                  'content-writer': '‚úçÔ∏è Content Writer',
                  'architect': 'üìê Architect',
                  'database-dev': 'üóÑÔ∏è Database Engineer',
                  'api-designer': 'üìã API Designer',
                  'backend-dev': '‚öôÔ∏è Backend Developer',
                  'network-dev': 'üåê Network Engineer',
                  'security': 'üîí Security Agent',
                  'devops': 'üê≥ DevOps',
                  'ue5-dev': 'üéÆ UE5 Developer',
                  'testing': 'üß™ QA/Testing',
                  'game-balance': '‚öñÔ∏è Game Balance Agent',
                  'release': 'üöÄ Release Manager'
                };
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: '## OK –í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!\n\n' +
                    '**–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** `' + currentStage + '` ‚Üí **–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** `' + nextStage + '`\n\n' +
                    '–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É: **' + (agentNames[nextStage] || nextStage) + '**\n\n' +
                    '---\n' +
                    '*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤*'
                });
              }
            }

      - name: Auto-transition on PR Merge
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels || [];
            const labelNames = labels.map(l => l.name);
            
                const stageTransitions = {
              'backend': 'network-dev',
              'network': 'security',
              'security': 'devops',
              'devops': 'ue5-dev',
              'ue5': 'testing',
              'client': 'testing',
              'api': 'backend-dev',
              'database': 'api-designer'
            };
            
            let nextStage = '';
            for (const [key, value] of Object.entries(stageTransitions)) {
              if (labelNames.some(l => l.includes(key))) {
                nextStage = value;
                break;
              }
            }
            
            if (nextStage) {
              const linkedIssues = context.payload.pull_request.body?.match(/#\d+/g) || [];
              const nextAgentLabels = {
                'network-dev': ['agent:network', 'stage:network'],
                'security': ['agent:security', 'stage:security'],
                'devops': ['agent:devops', 'stage:infrastructure'],
                'ue5-dev': ['agent:ue5', 'stage:client-dev'],
                'testing': ['agent:qa', 'stage:testing'],
                'backend-dev': ['agent:backend', 'stage:backend-dev'],
                'api-designer': ['agent:api-designer', 'stage:api-design']
              };
              
              const nextLabels = nextAgentLabels[nextStage] || [`stage:${nextStage}`];
              
              for (const issueRef of linkedIssues) {
                const issueNumber = parseInt(issueRef.replace('#', ''));
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: nextLabels
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: '## OK PR –æ–±—ä–µ–¥–∏–Ω–µ–Ω, –∑–∞–¥–∞—á–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É\n\n' +
                    '**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** `' + nextStage + '`\n\n' +
                    '–°–≤—è–∑–∞–Ω–Ω—ã–π PR #' + context.payload.pull_request.number + ' –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω. –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É.\n\n' +
                    '---\n' +
                    '*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤*'
                });
              }
            }

