name: Project Status Automation

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, ready_for_review]

env:
  PROJECT_NUMBER: 1

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Get Project Info
        id: project
        uses: actions/github-script@v7
        with:
          script: |
            const { data: projectV2 } = await github.graphql(`
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              number: ${{ env.PROJECT_NUMBER }}
            });
            
            const project = projectV2.organization?.projectV2 || projectV2.user?.projectV2;
            
            if (!project) {
              core.setOutput('project_node_id', '');
              core.setOutput('status_field_id', '');
              return;
            }
            
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const statusFieldId = statusField?.id || '';
            
            core.setOutput('project_node_id', project.id);
            core.setOutput('status_field_id', statusFieldId);
            
            const statusOptions = {};
            if (statusField && statusField.options) {
              statusField.options.forEach(opt => {
                statusOptions[opt.name] = opt.id;
              });
            }
            
            core.setOutput('status_options', JSON.stringify(statusOptions));

      - name: Add Issue to Project
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const statusFieldId = '${{ steps.project.outputs.status_field_id }}';
            const statusOptions = JSON.parse('${{ steps.project.outputs.status_options }}' || '{}');
            const issueNumber = context.payload.issue.number;
            
            if (!projectNodeId || !issueNumber) {
              console.log('Skipping: missing project or issue');
              return;
            }
            
            const { data: issue } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            if (!issue.repository.issue) {
              console.log(`Issue #${issueNumber} not found`);
              return;
            }
            
            const issueNodeId = issue.repository.issue.id;
            
            let projectItemId;
            try {
              const { data: addResult } = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: issueNodeId
              });
              
              projectItemId = addResult?.addProjectV2ItemById?.item?.id;
              
              if (!projectItemId) {
                console.log(`Failed to add issue #${issueNumber} to project`);
                return;
              }
            } catch (error) {
              console.error(`Error adding issue to project: ${error.message}`);
              return;
            }
            
            if (statusFieldId && statusOptions['Todo'] && projectItemId) {
              try {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $valueId
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: projectNodeId,
                  itemId: projectItemId,
                  fieldId: statusFieldId,
                  valueId: statusOptions['Todo']
                });
                
                console.log(`Added issue #${issueNumber} to project with status: Todo`);
              } catch (error) {
                console.error(`Error setting status: ${error.message}`);
              }
            } else {
              console.log(`Added issue #${issueNumber} to project`);
            }

      - name: Check Task Readiness and Transition
        if: github.event_name == 'issue_comment' && (contains(github.event.comment.body, '[x]') || contains(github.event.comment.body, '- [x]'))
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const statusFieldId = '${{ steps.project.outputs.status_field_id }}';
            const statusOptions = JSON.parse('${{ steps.project.outputs.status_options }}' || '{}');
            const issueNumber = context.payload.issue?.number;
            
            if (!projectNodeId || !issueNumber) return;
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const body = issue.body || '';
            const checkboxes = body.match(/- \[([ x])\]/g) || [];
            const checked = checkboxes.filter(cb => cb.includes('x')).length;
            const total = checkboxes.length;
            
            if (total === 0 || checked !== total) return;
            
            const { data: issueNode } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            const issueNodeId = issueNode.repository.issue.id;
            
            const { data: projectItem } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    projectItems(first: 20) {
                      nodes {
                        id
                        project {
                          ... on ProjectV2 {
                            number
                            id
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            const projectItems = projectItem.repository.issue.projectItems.nodes || [];
            
            if (projectItems.length === 0) {
              console.log(`Issue #${issueNumber} has no project items`);
              return;
            }
            
            console.log(`Found ${projectItems.length} project item(s) for issue #${issueNumber}`);
            console.log(`Looking for project ID: ${projectNodeId}`);
            
            const item = projectItems.find(
              i => i.project && i.project.id === projectNodeId
            );
            
            if (!item) {
              console.log(`Issue #${issueNumber} not found in project ${projectNodeId}`);
              console.log(`Available projects: ${projectItems.map(i => i.project?.id || 'no-id').join(', ')}`);
              return;
            }
            
            const currentStatusValue = item.fieldValues.nodes.find(
              fv => fv.field.name === 'Status'
            );
            const currentStatus = currentStatusValue?.name || '';
            
            const hasContentLabels = issue.labels.some(l => ['canon', 'lore', 'quest'].includes(l.name));
            
            const statusTransitions = {
              'Idea Writer - Review': hasContentLabels ? 'Content Writer - Todo' : 'Architect - Todo',
              'Content Writer - Review': 'Backend - Todo',
              'Architect - Review': 'Database - Todo',
              'Database - Review': 'API Designer - Todo',
              'API Designer - Review': 'Backend - Todo',
              'Backend - Review': hasContentLabels ? 'QA - Todo' : 'Network - Todo',
              'Network - Review': 'Security - Todo',
              'Security - Review': 'DevOps - Todo',
              'DevOps - Review': 'UE5 - Todo',
              'UE5 - Review': 'QA - Todo',
              'QA - Review': 'Game Balance - Todo',
              'Game Balance - Review': 'Release - Todo'
            };
            
            const nextStatus = statusTransitions[currentStatus];
            
            if (!nextStatus || !statusOptions[nextStatus]) {
              console.log(`No transition found for status: ${currentStatus}`);
              return;
            }
            
            try {
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      singleSelectOptionId: $valueId
                    }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                itemId: item.id,
                fieldId: statusFieldId,
                valueId: statusOptions[nextStatus]
              });
            } catch (error) {
              console.error(`Error updating status: ${error.message}`);
              return;
            }
            
            const agentNames = {
              'Content Writer - Todo': '‚úçÔ∏è Content Writer',
              'Architect - Todo': 'üìê Architect',
              'Database - Todo': 'üóÑÔ∏è Database Engineer',
              'API Designer - Todo': 'üìã API Designer',
              'Backend - Todo': '‚öôÔ∏è Backend Developer',
              'Network - Todo': 'üåê Network Engineer',
              'Security - Todo': 'üîí Security Agent',
              'DevOps - Todo': 'üê≥ DevOps',
              'UE5 - Todo': 'üéÆ UE5 Developer',
              'QA - Todo': 'üß™ QA/Testing',
              'Game Balance - Todo': '‚öñÔ∏è Game Balance Agent',
              'Release - Todo': 'üöÄ Release Manager'
            };
            
            const agentName = agentNames[nextStatus] || nextStatus;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '## OK –í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!\n\n' +
                '**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** `' + currentStatus + '` ‚Üí **–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:** `' + nextStatus + '`\n\n' +
                '–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É: **' + agentName + '**\n\n' +
                '---\n' +
                '*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤*'
            });
            
            console.log(`Transitioned issue #${issueNumber} from ${currentStatus} to ${nextStatus}`);
