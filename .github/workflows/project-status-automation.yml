name: Project Status Automation

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, ready_for_review]

env:
  PROJECT_NUMBER: 1

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Get Project Info
        id: project
        uses: actions/github-script@v7
        with:
          script: |
            const { data: projectV2 } = await github.graphql(`
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              number: ${{ env.PROJECT_NUMBER }}
            });
            
            const project = projectV2.organization?.projectV2 || projectV2.user?.projectV2;
            
            if (!project) {
              core.setOutput('project_node_id', '');
              core.setOutput('status_field_id', '');
              return;
            }
            
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const statusFieldId = statusField?.id || '';
            
            core.setOutput('project_node_id', project.id);
            core.setOutput('status_field_id', statusFieldId);
            
            const statusOptions = {};
            if (statusField && statusField.options) {
              statusField.options.forEach(opt => {
                statusOptions[opt.name] = opt.id;
              });
            }
            
            core.setOutput('status_options', JSON.stringify(statusOptions));

      - name: Add Issue to Project
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const projectNodeId = '${{ steps.project.outputs.project_node_id }}';
            const statusFieldId = '${{ steps.project.outputs.status_field_id }}';
            const statusOptions = JSON.parse('${{ steps.project.outputs.status_options }}' || '{}');
            const issueNumber = context.payload.issue.number;
            
            if (!projectNodeId || !issueNumber) {
              console.log('Skipping: missing project or issue');
              return;
            }
            
            const { data: issue } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issueNumber
            });
            
            if (!issue.repository.issue) {
              console.log(`Issue #${issueNumber} not found`);
              return;
            }
            
            const issueNodeId = issue.repository.issue.id;
            
            let projectItemId;
            try {
              const { data: addResult } = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId: projectNodeId,
                contentId: issueNodeId
              });
              
              projectItemId = addResult?.addProjectV2ItemById?.item?.id;
              
              if (!projectItemId) {
                console.log(`Failed to add issue #${issueNumber} to project`);
                return;
              }
            } catch (error) {
              console.error(`Error adding issue to project: ${error.message}`);
              return;
            }
            
            if (statusFieldId && statusOptions['Todo'] && projectItemId) {
              try {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $valueId
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: projectNodeId,
                  itemId: projectItemId,
                  fieldId: statusFieldId,
                  valueId: statusOptions['Todo']
                });
                
                console.log(`Added issue #${issueNumber} to project with status: Todo`);
              } catch (error) {
                console.error(`Error setting status: ${error.message}`);
              }
            } else {
              console.log(`Added issue #${issueNumber} to project`);
            }

