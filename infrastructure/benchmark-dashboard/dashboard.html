<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Dashboard - NECPGAME</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .summary-card.improving { border-left-color: #10b981; }
        .summary-card.degrading { border-left-color: #ef4444; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #1a1f3a;
            padding: 10px;
            border-radius: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .service-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2a2f4a;
        }

        .service-card h3 {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trend-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
        }

        .trend-badge.improving {
            background: #10b981;
            color: white;
        }

        .trend-badge.degrading {
            background: #ef4444;
            color: white;
        }

        .trend-badge.stable {
            background: #6b7280;
            color: white;
        }

        .controls {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        select, button {
            padding: 10px 15px;
            background: #2a2f4a;
            border: 1px solid #3a3f5a;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1em;
            cursor: pointer;
        }

        select:hover, button:hover {
            background: #3a3f5a;
        }

        button {
            background: #667eea;
            border: none;
            font-weight: 600;
        }

        button:hover {
            background: #764ba2;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .table-container {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2f4a;
        }

        th {
            background: #2a2f4a;
            color: #667eea;
            font-weight: 600;
        }

        tr:hover {
            background: #2a2f4a;
        }

        .trend-up {
            color: #ef4444;
        }

        .trend-down {
            color: #10b981;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Benchmark Dashboard</h1>
        <p>Performance metrics across all microservices</p>
    </div>

    <div id="error-container"></div>

    <div class="controls">
        <div class="control-group">
            <label>Service</label>
            <select id="service-select">
                <option value="">All Services</option>
            </select>
        </div>
        <div class="control-group">
            <label>Benchmark</label>
            <select id="benchmark-select">
                <option value="">All Benchmarks</option>
            </select>
        </div>
        <div class="control-group">
            <label>Time Range</label>
            <select id="time-range">
                <option value="all">All Time</option>
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
            </select>
        </div>
        <button onclick="refreshData()">ðŸ”„ Refresh</button>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('benchmarks')">Benchmarks</button>
        <button class="tab" onclick="showTab('trends')">Trends</button>
    </div>

    <div id="overview" class="tab-content active">
        <div id="summary-cards" class="summary-cards"></div>
        <div id="services-grid" class="services-grid"></div>
    </div>

    <div id="benchmarks" class="tab-content">
        <div id="stats" class="stats"></div>
        <div id="charts" class="charts"></div>
        <div id="table-container" class="table-container"></div>
    </div>

    <div id="trends" class="tab-content">
        <div id="trends-content"></div>
    </div>

    <script>
        let dashboardData = null;
        let charts = {};

        async function loadData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error('Failed to load data');
                dashboardData = await response.json();
                renderDashboard();
                return Promise.resolve();
            } catch (error) {
                showError('Failed to load benchmark data: ' + error.message);
                return Promise.reject(error);
            }
        }

        function renderDashboard() {
            if (!dashboardData) return;

            populateSelects();
            renderStats();
            renderCharts();
            renderTable();
            
            // Load new features
            loadSummary();
            loadServices();
        }

        function populateSelects() {
            const serviceSelect = document.getElementById('service-select');
            const benchmarkSelect = document.getElementById('benchmark-select');

            serviceSelect.innerHTML = '<option value="">All Services</option>';
            benchmarkSelect.innerHTML = '<option value="">All Benchmarks</option>';

            dashboardData.services.forEach(svc => {
                const option = document.createElement('option');
                option.value = svc;
                option.textContent = svc;
                serviceSelect.appendChild(option);
            });

            const selectedService = serviceSelect.value;
            const benchmarks = new Set();
            
            Object.keys(dashboardData.benchmarks).forEach(key => {
                const [service, benchmark] = key.split('/', 2);
                if (!selectedService || service === selectedService) {
                    benchmarks.add(benchmark);
                }
            });

            Array.from(benchmarks).sort().forEach(bench => {
                const option = document.createElement('option');
                option.value = bench;
                option.textContent = bench;
                benchmarkSelect.appendChild(option);
            });
        }

        async function loadSummary() {
            try {
                const response = await fetch('/api/summary');
                const summary = await response.json();
                
                const summaryCards = document.getElementById('summary-cards');
                summaryCards.innerHTML = `
                    <div class="summary-card">
                        <h3>Total Services</h3>
                        <div class="value">${summary.total_services || 0}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Runs</h3>
                        <div class="value">${summary.total_runs || 0}</div>
                    </div>
                    <div class="summary-card improving">
                        <h3>Improving</h3>
                        <div class="value">${summary.services_improving || 0}</div>
                    </div>
                    <div class="summary-card degrading">
                        <h3>Degrading</h3>
                        <div class="value">${summary.services_degrading || 0}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Avg Performance</h3>
                        <div class="value">${summary.avg_performance ? summary.avg_performance.toFixed(1) : '-'} ns/op</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load summary:', error);
                const summaryCards = document.getElementById('summary-cards');
                if (summaryCards) {
                    summaryCards.innerHTML = '<div class="loading">Failed to load summary</div>';
                }
            }
        }

        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();
                
                const servicesGrid = document.getElementById('services-grid');
                servicesGrid.innerHTML = services.map(svc => `
                    <div class="service-card">
                        <h3>
                            ${svc.name}
                            ${svc.benchmark_trend ? `<span class="trend-badge ${svc.benchmark_trend}">${svc.benchmark_trend}</span>` : ''}
                        </h3>
                        <div style="margin-top: 10px;">
                            <div style="font-size: 0.9em; opacity: 0.7;">Last Benchmark:</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${svc.last_benchmark ? svc.last_benchmark.toFixed(1) : '-'} ns/op</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load services:', error);
                const servicesGrid = document.getElementById('services-grid');
                if (servicesGrid) {
                    servicesGrid.innerHTML = '<div class="loading">Failed to load services</div>';
                }
            }
        }

        async function loadTrends() {
            try {
                const response = await fetch('/api/trends');
                const trends = await response.json();
                
                const trendsContent = document.getElementById('trends-content');
                const trendsList = Object.values(trends);
                
                trendsContent.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Benchmark</th>
                                    <th>Trend</th>
                                    <th>Change</th>
                                    <th>Last Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trendsList.map(t => `
                                    <tr>
                                        <td>${t.service}</td>
                                        <td>${t.benchmark}</td>
                                        <td><span class="trend-badge ${t.direction}">${t.direction}</span></td>
                                        <td>${t.change > 0 ? '+' : ''}${t.change.toFixed(1)}%</td>
                                        <td>${t.points.length > 0 ? t.points[t.points.length - 1].ns_per_op.toFixed(1) : '-'} ns/op</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load trends:', error);
                const trendsContent = document.getElementById('trends-content');
                if (trendsContent) {
                    trendsContent.innerHTML = '<div class="loading">Failed to load trends</div>';
                }
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'overview') {
                loadSummary();
                loadServices();
            } else if (tabName === 'trends') {
                loadTrends();
            }
        }

        function renderStats() {
            const statsContainer = document.getElementById('stats');
            const selectedService = document.getElementById('service-select').value;
            
            let totalRuns = dashboardData.runs.length;
            let totalServices = dashboardData.services.length;
            let totalBenchmarks = Object.keys(dashboardData.benchmarks).length;

            if (selectedService) {
                totalBenchmarks = Object.keys(dashboardData.benchmarks)
                    .filter(k => k.startsWith(selectedService + '/')).length;
            }

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Total Runs</h3>
                    <div class="value">${totalRuns}</div>
                </div>
                <div class="stat-card">
                    <h3>Services</h3>
                    <div class="value">${totalServices}</div>
                </div>
                <div class="stat-card">
                    <h3>Benchmarks</h3>
                    <div class="value">${totalBenchmarks}</div>
                </div>
            `;
        }

        function renderCharts() {
            const chartsContainer = document.getElementById('charts');
            const selectedService = document.getElementById('service-select').value;
            const selectedBenchmark = document.getElementById('benchmark-select').value;

            Object.keys(charts).forEach(key => {
                charts[key].destroy();
            });
            charts = {};

            const filtered = Object.entries(dashboardData.benchmarks)
                .filter(([key]) => {
                    const [service, benchmark] = key.split('/', 2);
                    if (selectedService && service !== selectedService) return false;
                    if (selectedBenchmark && benchmark !== selectedBenchmark) return false;
                    return true;
                });

            if (filtered.length === 0) {
                chartsContainer.innerHTML = '<div class="loading">No data to display</div>';
                return;
            }

            chartsContainer.innerHTML = '';

            filtered.slice(0, 6).forEach(([key, points]) => {
                const [service, benchmark] = key.split('/', 2);
                const chartId = `chart-${key.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <h3>${service} - ${benchmark}</h3>
                    <canvas id="${chartId}"></canvas>
                `;
                chartsContainer.appendChild(chartDiv);

                const ctx = document.getElementById(chartId).getContext('2d');
                charts[key] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: points.map(p => p.timestamp.substring(0, 10)),
                        datasets: [{
                            label: 'ns/op',
                            data: points.map(p => p.ns_per_op),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: { color: '#e0e0e0' },
                                grid: { color: '#2a2f4a' }
                            },
                            x: {
                                ticks: { color: '#e0e0e0' },
                                grid: { color: '#2a2f4a' }
                            }
                        }
                    }
                });
            });
        }

        function renderTable() {
            const tableContainer = document.getElementById('table-container');
            const selectedService = document.getElementById('service-select').value;

            const latestRun = dashboardData.runs[0];
            if (!latestRun) {
                tableContainer.innerHTML = '<div class="loading">No data available</div>';
                return;
            }

            fetch(`/api/run/${latestRun.file}`)
                .then(r => r.json())
                .then(data => {
                    let html = '<h3>Latest Run: ' + latestRun.date + '</h3><table><thead><tr>';
                    html += '<th>Service</th><th>Benchmark</th><th>ns/op</th><th>allocs/op</th><th>bytes/op</th></tr></thead><tbody>';

                    data.services.forEach(svc => {
                        if (selectedService && svc.service !== selectedService) return;
                        
                        svc.benchmarks.forEach(bench => {
                            html += `<tr>
                                <td>${svc.service}</td>
                                <td>${bench.name}</td>
                                <td>${bench.ns_per_op.toFixed(2)}</td>
                                <td>${bench.allocs_per_op}</td>
                                <td>${bench.bytes_per_op}</td>
                            </tr>`;
                        });
                    });

                    html += '</tbody></table>';
                    tableContainer.innerHTML = html;
                })
                .catch(err => {
                    tableContainer.innerHTML = '<div class="error">Failed to load latest run data</div>';
                });
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function refreshData() {
            loadData();
        }

        document.getElementById('service-select').addEventListener('change', renderDashboard);
        document.getElementById('benchmark-select').addEventListener('change', renderDashboard);
        document.getElementById('time-range').addEventListener('change', renderDashboard);

        loadData();
        setInterval(loadData, 60000);
    </script>
</body>
</html>

