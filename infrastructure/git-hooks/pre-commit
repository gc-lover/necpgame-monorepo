#!/bin/bash
# Issue: #1858
# Git pre-commit hook for NECPGAME quality validation
# Automatically validates code quality before commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$HOOK_DIR")"

log_error() {
    echo -e "${RED}‚ùå PRE-COMMIT ERROR: $1${NC}" >&2
}

log_warning() {
    echo -e "${YELLOW}WARNING  PRE-COMMIT WARNING: $1${NC}"
}

log_success() {
    echo -e "${GREEN}OK $1${NC}"
}

# Function to run quick validation on staged files
validate_staged_files() {
    echo "üîç Running pre-commit validation on staged files..."

    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only)

    if [ -z "$STAGED_FILES" ]; then
        log_success "No files staged for commit"
        return 0
    fi

    echo "Staged files:"
    echo "$STAGED_FILES" | while read -r file; do
        echo "  - $file"
    done

    # Check for large files
    echo "$STAGED_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt 10485760 ]; then # 10MB
                log_error "Staged file $file is too large ($size bytes > 10MB)"
                exit 1
            fi
        fi
    done

    # Validate Go files
    echo "$STAGED_FILES" | grep "\.go$" | while read -r file; do
        if [ -f "$file" ]; then
            # Quick syntax check
            if ! go fmt "$file" >/dev/null 2>&1; then
                log_error "Go file $file has formatting issues"
                exit 1
            fi

            # Check for basic issues
            if grep -q "fmt\.Print" "$file" && ! grep -q "logrus\|zap" "$file"; then
                log_warning "File $file uses fmt.Print instead of structured logging"
            fi
        fi
    done

    # Validate YAML files
    echo "$STAGED_FILES" | grep "\.yaml$" | while read -r file; do
        if [ -f "$file" ]; then
            # Basic YAML syntax check
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                log_error "YAML file $file has invalid syntax"
                exit 1
            fi
        fi
    done

    # Check for sensitive data
    echo "$STAGED_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            if grep -q -i "password\|secret\|private.*key" "$file"; then
                if [[ "$file" != *"test"* ]] && [[ "$file" != *"config"* ]]; then
                    log_warning "File $file may contain sensitive data"
                fi
            fi
        fi
    done
}

# Function to run full validation (optional, based on config)
run_full_validation() {
    local run_full=${RUN_FULL_VALIDATION:-false}

    if [ "$run_full" = "true" ]; then
        echo "üîç Running full validation suite..."

        # Run architecture validation
        if [ -f "$REPO_ROOT/infrastructure/scripts/validate-architecture.sh" ]; then
            if ! bash "$REPO_ROOT/infrastructure/scripts/validate-architecture.sh"; then
                log_error "Architecture validation failed"
                exit 1
            fi
        fi

        # Run file structure validation
        if [ -f "$REPO_ROOT/infrastructure/scripts/validate-file-structure.sh" ]; then
            if ! bash "$REPO_ROOT/infrastructure/scripts/validate-file-structure.sh"; then
                log_error "File structure validation failed"
                exit 1
            fi
        fi

        # Run OpenAPI validation
        if [ -f "$REPO_ROOT/infrastructure/scripts/validate-openapi.sh" ]; then
            if ! bash "$REPO_ROOT/infrastructure/scripts/validate-openapi.sh"; then
                log_error "OpenAPI validation failed"
                exit 1
            fi
        fi
    fi
}

# Function to check commit message format
validate_commit_message() {
    # Skip if this is an amend or rebase
    if [ "$GIT_AUTHOR_EMAIL" = "noreply@github.com" ]; then
        return 0
    fi

    # Get the commit message
    COMMIT_MSG_FILE=$(git rev-parse --git-dir)/COMMIT_EDITMSG
    if [ -f "$COMMIT_MSG_FILE" ]; then
        COMMIT_MSG=$(head -1 "$COMMIT_MSG_FILE")

        # Check for Issue reference
        if ! echo "$COMMIT_MSG" | grep -q "#[0-9]"; then
            log_warning "Commit message missing Issue reference (e.g., #123)"
        fi

        # Check message length
        if [ ${#COMMIT_MSG} -gt 100 ]; then
            log_warning "Commit message is very long (${#COMMIT_MSG} chars)"
        fi
    fi
}

# Main hook execution
main() {
    echo "ü™ù NECPGAME Pre-commit Hook"
    echo "==========================="

    validate_staged_files
    run_full_validation
    validate_commit_message

    echo ""
    log_success "Pre-commit validation completed successfully!"
    echo ""
    echo "üí° Tips:"
    echo "  - Set RUN_FULL_VALIDATION=true to run complete validation suite"
    echo "  - Use 'git commit --no-verify' to skip validation (not recommended)"
}

# Run main function
main "$@"