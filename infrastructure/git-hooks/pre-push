#!/bin/bash
# Issue: #1858
# Git pre-push hook for NECPGAME quality validation
# Validates code quality before pushing to remote repository

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$HOOK_DIR")"

log_error() {
    echo -e "${RED}‚ùå PRE-PUSH ERROR: $1${NC}" >&2
}

log_warning() {
    echo -e "${YELLOW}WARNING  PRE-PUSH WARNING: $1${NC}"
}

log_success() {
    echo -e "${GREEN}OK $1${NC}"
}

# Function to validate commits being pushed
validate_push_commits() {
    echo "üîç Validating commits being pushed..."

    # Get the commits being pushed
    while read -r local_ref local_sha remote_ref remote_sha; do
        if [ "$local_sha" = "$remote_sha" ]; then
            log_success "No new commits to push"
            continue
        fi

        # Get list of commits to be pushed
        if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
            # New branch, check all commits
            commits=$(git log --oneline "$local_sha")
        else
            # Existing branch, check new commits
            commits=$(git log --oneline "$remote_sha..$local_sha")
        fi

        # Validate each commit
        echo "$commits" | while read -r commit_line; do
            commit_hash=$(echo "$commit_line" | cut -d' ' -f1)
            commit_msg=$(echo "$commit_line" | cut -d' ' -f2-)

            # Check for Issue reference
            if ! echo "$commit_msg" | grep -q "#[0-9]"; then
                log_warning "Commit $commit_hash missing Issue reference: $commit_msg"
            fi

            # Check commit message length
            if [ ${#commit_msg} -gt 100 ]; then
                log_warning "Commit $commit_hash has very long message (${#commit_msg} chars)"
            fi
        done

        log_success "Validated commits for $local_ref -> $remote_ref"
    done
}

# Function to run security checks on pushed code
run_security_checks() {
    echo "üîí Running security checks..."

    # Check for accidentally committed secrets
    if git log --oneline -10 | grep -q -i "secret\|password\|key"; then
        log_warning "Recent commits contain sensitive keywords - please verify"
    fi

    # Check for large binary files
    large_files=$(git ls-files --stage | while read -r mode object size filename; do
        if [ "$size" -gt 10485760 ]; then # 10MB
            echo "$filename ($size bytes)"
        fi
    done)

    if [ -n "$large_files" ]; then
        log_error "Large files detected in repository:"
        echo "$large_files"
        log_error "Consider using Git LFS for large files"
        exit 1
    fi
}

# Function to validate branch naming
validate_branch_name() {
    echo "üåø Validating branch name..."

    current_branch=$(git rev-parse --abbrev-ref HEAD)

    # Skip validation for main/master branches
    if [[ "$current_branch" =~ ^(main|master)$ ]]; then
        return 0
    fi

    # Check branch naming convention
    if [[ ! "$current_branch" =~ ^(feature|bugfix|hotfix|release)/ ]]; then
        log_warning "Branch '$current_branch' doesn't follow naming convention (feature/, bugfix/, hotfix/, release/)"
    fi

    # Check for issue number in branch name
    if ! echo "$current_branch" | grep -q "#[0-9]"; then
        log_warning "Branch '$current_branch' missing issue number (e.g., #123)"
    fi
}

# Function to check if CI will pass
check_ci_readiness() {
    echo "üîÑ Checking CI readiness..."

    # Check if all required files are committed
    required_files=(
        "go.mod"
        "go.sum"
        "Dockerfile"
        "Makefile"
    )

    for file in "${required_files[@]}"; do
        if find "$REPO_ROOT" -name "$file" | grep -q .; then
            log_success "Required file type '$file' found"
        else
            log_warning "No '$file' files found in repository"
        fi
    done

    # Check for proper test coverage
    test_files=$(find "$REPO_ROOT" -name "*_test.go" | wc -l)
    if [ "$test_files" -eq 0 ]; then
        log_warning "No test files found in repository"
    else
        log_success "Found $test_files test files"
    fi
}

# Main hook execution
main() {
    echo "ü™ù NECPGAME Pre-push Hook"
    echo "========================="

    # Read stdin for push information
    validate_push_commits
    run_security_checks
    validate_branch_name
    check_ci_readiness

    echo ""
    log_success "Pre-push validation completed successfully!"
    echo ""
    echo "üöÄ Pushing to remote repository..."
}

# Run main function with stdin
main