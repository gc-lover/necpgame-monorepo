# Kafka Security Secrets - DevOps Infrastructure Setup
# Issue: #2237 - Implements secure secrets management for Kafka Event-Driven Architecture
# Agent: DevOps - Fixes Security audit critical issues: secrets exposure, credential management

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-admin-credentials
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: admin-credentials
    security-level: critical
    managed-by: devops-agent
  annotations:
    description: "Kafka admin user credentials for cluster management"
    last-rotated: "2026-01-06"
    rotation-policy: "90-days"
    security-classification: "restricted"
type: Opaque
data:
  # Base64 encoded credentials - CHANGE THESE IN PRODUCTION!
  username: YWRtaW4=  # admin
  password: <BASE64_ENCODED_STRONG_PASSWORD>  # Generate with: openssl rand -base64 32
  scram-sha-512-password: <BASE64_ENCODED_SCRAM_PASSWORD>  # SCRAM-SHA-512 format

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-service-accounts
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: service-accounts
    security-level: high
    managed-by: devops-agent
  annotations:
    description: "Service account credentials for Kafka clients"
    services: "combat-service,economy-service,social-service,system-service"
type: Opaque
data:
  # Combat Service (HOT PATH - 20k EPS)
  combat-service-username: Y29tYmF0LXNlcnZpY2U=  # combat-service
  combat-service-password: <BASE64_ENCODED_STRONG_PASSWORD>
  combat-service-scram-password: <BASE64_ENCODED_SCRAM_PASSWORD>

  # Economy Service (High throughput)
  economy-service-username: ZWNvbm9teS1zZXJ2aWNl  # economy-service
  economy-service-password: <BASE64_ENCODED_STRONG_PASSWORD>
  economy-service-scram-password: <BASE64_ENCODED_SCRAM_PASSWORD>

  # Social Service (Medium throughput)
  social-service-username: c29jaWFsLXNlcnZpY2U=  # social-service
  social-service-password: <BASE64_ENCODED_STRONG_PASSWORD>
  social-service-scram-password: <BASE64_ENCODED_SCRAM_PASSWORD>

  # System Service (Monitoring/Audit)
  system-service-username: c3lzdGVtLXNlcnZpY2U=  # system-service
  system-service-password: <BASE64_ENCODED_STRONG_PASSWORD>
  system-service-scram-password: <BASE64_ENCODED_SCRAM_PASSWORD>

  # Analytics Service (Read-only consumer)
  analytics-service-username: YW5hbHl0aWNzLXNlcnZpY2U=  # analytics-service
  analytics-service-password: <BASE64_ENCODED_STRONG_PASSWORD>
  analytics-service-scram-password: <BASE64_ENCODED_SCRAM_PASSWORD>

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-tls-certificates
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: tls-certificates
    security-level: critical
    certificate-type: mTLS
    managed-by: devops-agent
  annotations:
    description: "mTLS certificates for Kafka cluster encryption"
    issuer: "necpgame-ca"
    validity-period: "365-days"
    auto-renewal: "true"
    last-renewed: "2026-01-06"
type: kubernetes.io/tls
data:
  # CA Certificate
  ca.crt: <BASE64_ENCODED_CA_CERTIFICATE>

  # Server Certificate (for Kafka brokers)
  tls.crt: <BASE64_ENCODED_SERVER_CERTIFICATE>
  tls.key: <BASE64_ENCODED_SERVER_PRIVATE_KEY>

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-truststore
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: truststore
    security-level: high
    keystore-type: jks
    managed-by: devops-agent
  annotations:
    description: "Java Truststore for Kafka client connections"
    format: "JKS"
    last-updated: "2026-01-06"
type: Opaque
data:
  truststore.jks: <BASE64_ENCODED_JKS_TRUSTSTORE>
  truststore.password: <BASE64_ENCODED_TRUSTSTORE_PASSWORD>

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-keystore
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: keystore
    security-level: critical
    keystore-type: jks
    managed-by: devops-agent
  annotations:
    description: "Java Keystore for Kafka server certificates"
    format: "JKS"
    last-updated: "2026-01-06"
type: Opaque
data:
  keystore.jks: <BASE64_ENCODED_JKS_KEYSTORE>
  keystore.password: <BASE64_ENCODED_KEYSTORE_PASSWORD>
  key.password: <BASE64_ENCODED_KEY_PASSWORD>

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-acl-config
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: acl-configuration
    security-level: high
    managed-by: devops-agent
  annotations:
    description: "ACL configuration for Kafka topic access control"
    last-updated: "2026-01-06"
    compliance: "zero-trust-security-model"
type: Opaque
data:
  # ACL Rules in JSON format for automation
  acl-rules.json: <BASE64_ENCODED_ACL_CONFIGURATION>

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-monitoring-credentials
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: monitoring
    security-level: medium
    managed-by: devops-agent
  annotations:
    description: "Credentials for Kafka monitoring and metrics collection"
    services: "prometheus,jmx-exporter"
type: Opaque
data:
  jmx-username: bW9uaXRvcmluZw==  # monitoring
  jmx-password: <BASE64_ENCODED_MONITORING_PASSWORD>

---
# Certificate rotation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kafka-certificate-rotator
  namespace: necpgame-infrastructure
  labels:
    app: kafka
    component: certificate-rotation
    security-level: high
    managed-by: devops-agent
  annotations:
    description: "Automated certificate rotation for Kafka mTLS"
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kafka-admin-sa
          containers:
          - name: cert-rotator
            image: necpgame/kafka-cert-rotator:v1.0.0
            env:
            - name: VAULT_ADDR
              value: "https://vault.necpgame.internal:8200"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-token
                  key: token
            securityContext:
              allowPrivilegeEscalation: false
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL
          restartPolicy: OnFailure





