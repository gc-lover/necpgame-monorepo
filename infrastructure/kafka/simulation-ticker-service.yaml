# Simulation Ticker Service for Event-Driven Architecture
# Issue: #2281 - Generates hourly and daily ticks for simulation services
# Agent: DevOps - Creates infrastructure for event-driven simulation ticks

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: simulation-ticker-service
  namespace: necpgame-infrastructure
  labels:
    app: simulation-ticker-service
    component: ticker
    domain: simulation
    managed-by: devops-agent
  annotations:
    description: "Event-driven simulation ticker - generates hourly/daily ticks"
    performance-targets: "Low latency tick generation"
    security-classification: "internal"
spec:
  schedule: "0 * * * *"  # Run every hour at minute 0
  concurrencyPolicy: Forbid  # Don't allow concurrent runs
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: simulation-ticker-service
            job-type: simulation-tick
        spec:
          restartPolicy: OnFailure
          activeDeadlineSeconds: 300  # 5 minutes timeout
          containers:
          - name: ticker
            image: necpgame/simulation-ticker-service:latest
            command: ["/simulation-ticker", "tick"]
            env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              value: "necpgame-kafka-cluster-kafka-bootstrap:9093"
            - name: KAFKA_SECURITY_PROTOCOL
              value: "SASL_SSL"
            - name: KAFKA_SASL_MECHANISM
              value: "SCRAM-SHA-512"
            - name: KAFKA_SASL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: kafka-service-accounts
                  key: simulation-ticker-service-username
            - name: KAFKA_SASL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kafka-service-accounts
                  key: simulation-ticker-service-scram-password
            - name: LOG_LEVEL
              value: "info"
            resources:
              requests:
                memory: 128Mi
                cpu: 50m
              limits:
                memory: 256Mi
                cpu: 100m
            securityContext:
              allowPrivilegeEscalation: false
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL

---
# Separate CronJob for daily ticks
apiVersion: batch/v1
kind: CronJob
metadata:
  name: simulation-ticker-daily
  namespace: necpgame-infrastructure
  labels:
    app: simulation-ticker-service
    component: ticker
    domain: simulation
    tick-type: daily
    managed-by: devops-agent
  annotations:
    description: "Daily simulation ticks for diplomacy evaluation"
spec:
  schedule: "0 0 * * *"  # Run daily at midnight
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: simulation-ticker-service
            job-type: simulation-tick
            tick-type: daily
        spec:
          restartPolicy: OnFailure
          activeDeadlineSeconds: 300
          containers:
          - name: ticker
            image: necpgame/simulation-ticker-service:latest
            command: ["/simulation-ticker", "tick", "--type", "daily"]
            env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              value: "necpgame-kafka-cluster-kafka-bootstrap:9093"
            - name: KAFKA_SECURITY_PROTOCOL
              value: "SASL_SSL"
            - name: KAFKA_SASL_MECHANISM
              value: "SCRAM-SHA-512"
            - name: KAFKA_SASL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: kafka-service-accounts
                  key: simulation-ticker-service-username
            - name: KAFKA_SASL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kafka-service-accounts
                  key: simulation-ticker-service-scram-password
            - name: LOG_LEVEL
              value: "info"
            resources:
              requests:
                memory: 128Mi
                cpu: 50m
              limits:
                memory: 256Mi
                cpu: 100m
            securityContext:
              allowPrivilegeEscalation: false
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL