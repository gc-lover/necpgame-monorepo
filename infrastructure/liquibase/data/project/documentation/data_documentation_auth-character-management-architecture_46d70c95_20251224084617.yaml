databaseChangeLog:
- changeSet:
    id: documentation-auth-character-management-architecture-46d70c95
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-924051603096755'
        - column:
            name: doc_id
            value: auth-character-management-architecture
        - column:
            name: title
            value: Архитектура Auth & Character Management
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-23 16:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - auth
            - characters
            - progression
            - backend
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - auth-service
            - character-service
            - gameplay-service
            - session-service
            - economy-service
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "analysis-2025-11-09-auth-characters-package", "relation":
              "implements"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "auth-character-management-architecture",
              "title": "Архитектура Auth & Character Management", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-11-23T16:00:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "auth", "characters", "progression", "backend"], "related_systems":
              ["auth-service", "character-service", "gameplay-service", "session-service",
              "economy-service", "analytics-service"], "related_documents": [{"id":
              "analysis-2025-11-09-auth-characters-package", "relation": "implements"}],
              "github_issue": 153, "visibility": "internal", "audience": ["architect",
              "backend", "api-designer"]}, "summary": {"problem": "Требуется спроектировать
              архитектуру систем аутентификации и управления персонажами,\nвключая
              интеграцию с прогрессией, сессиями и экономикой.\n", "goal": "Создать
              архитектурную схему Auth & Character Management с определением:\n- Компонентов
              для аутентификации и управления персонажами\n- REST, WebSocket и Event
              Bus контрактов\n- Интеграций между сервисами\n- Структуры БД\n- Технического
              задания для реализации\n", "essence": "Объединенная архитектура аутентификации,
              управления персонажами и прогрессии\nс поддержкой REST API, WebSocket
              и Event Bus коммуникации.\n"}, "architecture": {"overview": "Архитектура
              Auth & Character Management состоит из следующих компонентов:\n1. Auth
              Service - аутентификация и авторизация\n2. Character Service - управление
              персонажами\n3. Progression Service - прогрессия персонажей\n4. Session
              Service - управление сессиями\n5. Интеграции с Economy, Analytics и
              другими сервисами\n", "microservices": [{"name": "auth-service", "port":
              8081, "responsibility": "Аутентификация и авторизация:\n- Регистрация
              и вход\n- JWT/Refresh токены\n- OAuth интеграция\n- Управление ролями
              и правами\n- Управление паролями\n", "components": [{"authentication-manager":
              "управление аутентификацией"}, {"jwt-service": "генерация и валидация
              JWT токенов"}, {"oauth-handler": "обработка OAuth провайдеров"}, {"role-manager":
              "управление ролями и правами"}, {"password-manager": "управление паролями"},
              {"session-tracker": "отслеживание сессий"}], "endpoints": ["POST /api/v1/auth/register
              - регистрация", "POST /api/v1/auth/login - вход", "POST /api/v1/auth/logout
              - выход", "POST /api/v1/auth/refresh - обновление токенов", "POST /api/v1/auth/password/forgot
              - запрос сброса пароля", "POST /api/v1/auth/password/reset - сброс пароля",
              "GET /api/v1/auth/roles - список ролей", "POST /api/v1/auth/oauth/{provider}/callback
              - OAuth callback", "POST /api/v1/auth/roles/{roleId}/permissions - управление
              правами"], "websocket_channels": ["wss://api.necp.game/v1/auth/sessions/{accountId}
              - статусы сессий, события входа/выхода"], "events_published": [{"ACCOUNT_CREATED":
              "создание аккаунта"}, {"LOGIN_SUCCESS": "успешный вход"}, {"LOGOUT":
              "выход из системы"}, {"ROLE_UPDATED": "обновление роли"}]}, {"name":
              "character-service", "port": 8082, "responsibility": "Управление персонажами:\n-
              Создание и удаление персонажей\n- Управление слотами персонажей\n- Переключение
              между персонажами\n- Восстановление удаленных персонажей\n- Аудит действий
              персонажей\n", "components": [{"character-manager": "управление персонажами"},
              {"slot-manager": "управление слотами"}, {"character-switcher": "переключение
              персонажей"}, {"character-recovery": "восстановление персонажей"}, {"character-audit":
              "аудит действий"}], "endpoints": ["POST /api/v1/players/{accountId}/characters
              - создание персонажа", "DELETE /api/v1/players/{accountId}/characters/{characterId}
              - удаление персонажа", "POST /api/v1/players/{accountId}/characters/{characterId}/restore
              - восстановление", "POST /api/v1/players/{accountId}/switch - переключение
              персонажа", "POST /api/v1/players/{accountId}/slots/purchase - покупка
              слота", "GET /api/v1/players/{accountId}/activity - аудит действий"],
              "websocket_channels": ["wss://api.necp.game/v1/characters/{accountId}
              - список персонажей, слоты, активный персонаж"], "events_published":
              [{"CharacterCreated": "создание персонажа"}, {"CharacterDeleted": "удаление
              персонажа"}, {"CharacterSwitched": "переключение персонажа"}, {"CharacterSlotPurchased":
              "покупка слота"}]}, {"name": "progression-service", "port": 8087, "responsibility":
              "Прогрессия персонажей:\n- Начисление опыта\n- Управление уровнями\n-
              Управление навыками\n- Распределение атрибутов\n- Снимки состояния прогрессии\n",
              "components": [{"experience-manager": "управление опытом"}, {"level-manager":
              "управление уровнями"}, {"skill-manager": "управление навыками"}, {"attribute-manager":
              "управление атрибутами"}, {"snapshot-manager": "управление снимками
              состояния"}], "endpoints": ["POST /api/v1/gameplay/progression/experience
              - начисление опыта", "POST /api/v1/gameplay/progression/skills - обновление
              навыков", "POST /api/v1/gameplay/progression/attributes - распределение
              атрибутов", "GET /api/v1/gameplay/progression/{characterId} - состояние
              прогрессии"], "websocket_channels": ["wss://api.necp.game/v1/progression/{characterId}
              - level-up, skill-up, начисление атрибутов"], "events_published": [{"character:level-up":
              "повышение уровня"}, {"character:skill-leveled": "повышение навыка"},
              {"character:attribute-allocated": "распределение атрибутов"}]}, {"name":
              "session-service", "port": 8090, "responsibility": "Управление сессиями:\n-
              Отслеживание активных сессий\n- Управление сессионными данными\n- Интеграция
              с Auth Service\n", "components": [{"session-manager": "управление сессиями"},
              {"session-storage": "хранение сессий"}, {"session-validator": "валидация
              сессий"}], "integrations": [{"auth-service": "получение данных о сессиях"},
              {"character-service": "переключение персонажей в сессии"}]}], "data_flows":
              {"registration_flow": "1. Клиент отправляет POST /api/v1/auth/register\n2.
              Auth Service валидирует данные\n3. Auth Service создает аккаунт в БД\n4.
              Auth Service отправляет email для подтверждения\n5. Auth Service публикует
              событие ACCOUNT_CREATED\n6. Character Service получает событие и инициализирует
              слоты\n7. Analytics Service логирует регистрацию\n8. Notification Service
              отправляет приветственное сообщение\n", "login_flow": "1. Клиент отправляет
              POST /api/v1/auth/login\n2. Auth Service проверяет учетные данные\n3.
              Auth Service проверяет антибрютфорс защиту\n4. Auth Service генерирует
              JWT и Refresh токены\n5. Auth Service сохраняет сессию в account_sessions\n6.
              Auth Service публикует событие LOGIN_SUCCESS\n7. Session Service обновляет
              активные сессии\n8. Analytics Service логирует вход\n9. Auth Service
              возвращает токены клиенту\n", "character_creation_flow": "1. Клиент
              отправляет POST /api/v1/players/{accountId}/characters\n2. Character
              Service проверяет доступные слоты\n3. Character Service валидирует данные
              персонажа\n4. Character Service создает персонажа в БД\n5. Character
              Service инициализирует прогрессию через Progression Service\n6. Character
              Service публикует событие CharacterCreated\n7. Gameplay Service инициализирует
              игровые данные\n8. Inventory Service создает начальный инвентарь\n9.
              Analytics Service логирует создание персонажа\n", "character_switch_flow":
              "1. Клиент отправляет POST /api/v1/players/{accountId}/switch\n2. Character
              Service проверяет существование персонажа\n3. Character Service обновляет
              активного персонажа\n4. Character Service сохраняет снимок состояния
              предыдущего персонажа\n5. Character Service публикует событие CharacterSwitched\n6.
              Session Service обновляет сессию с новым персонажем\n7. Gameplay Service
              загружает данные нового персонажа\n8. Realtime Gateway отправляет обновление
              клиенту\n", "progression_flow": "1. Игрок выполняет действие (бой, квест,
              крафт)\n2. Соответствующий сервис публикует событие с опытом\n3. Progression
              Service получает событие\n4. Progression Service начисляет опыт через
              POST /api/v1/gameplay/progression/experience\n5. Progression Service
              проверяет повышение уровня\n6. Если уровень повышен, Progression Service
              публикует character:level-up\n7. Progression Service обновляет навыки
              при необходимости\n8. Progression Service создает снимок состояния\n9.
              Realtime Gateway отправляет обновление прогрессии клиенту\n"}, "database_structure":
              {"tables": [{"name": "accounts", "description": "Учетные записи", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"email": "VARCHAR(255) UNIQUE"}, {"password_hash":
              "VARCHAR(255)"}, {"email_verified": "BOOLEAN"}, {"created_at": "TIMESTAMP"},
              {"updated_at": "TIMESTAMP"}, {"deleted_at": "TIMESTAMP (soft delete)"}]},
              {"name": "account_oauth", "description": "OAuth привязки", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"account_id": "UUID FOREIGN KEY"}, {"provider":
              "VARCHAR(50)"}, {"provider_user_id": "VARCHAR(255)"}, {"linked_at":
              "TIMESTAMP"}, {"last_used": "TIMESTAMP"}]}, {"name": "account_sessions",
              "description": "Сессии аккаунтов", "columns": [{"id": "UUID PRIMARY
              KEY"}, {"account_id": "UUID FOREIGN KEY"}, {"jwt_token": "TEXT"}, {"refresh_token":
              "VARCHAR(255)"}, {"ip_address": "VARCHAR(45)"}, {"user_agent": "TEXT"},
              {"expires_at": "TIMESTAMP"}, {"created_at": "TIMESTAMP"}, {"last_activity":
              "TIMESTAMP"}]}, {"name": "account_security_audit", "description": "Аудит
              безопасности", "columns": [{"id": "UUID PRIMARY KEY"}, {"account_id":
              "UUID FOREIGN KEY"}, {"event_type": "VARCHAR(100)"}, {"ip_address":
              "VARCHAR(45)"}, {"user_agent": "TEXT"}, {"risk_score": "INTEGER"}, {"timestamp":
              "TIMESTAMP"}]}, {"name": "roles", "description": "Роли", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"name": "VARCHAR(100) UNIQUE"}, {"description":
              "TEXT"}, {"created_at": "TIMESTAMP"}]}, {"name": "role_permissions",
              "description": "Права ролей", "columns": [{"id": "UUID PRIMARY KEY"},
              {"role_id": "UUID FOREIGN KEY"}, {"permission": "VARCHAR(100)"}, {"created_at":
              "TIMESTAMP"}]}, {"name": "account_roles", "description": "Роли аккаунтов",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"account_id": "UUID FOREIGN
              KEY"}, {"role_id": "UUID FOREIGN KEY"}, {"assigned_at": "TIMESTAMP"}]},
              {"name": "players", "description": "Игроки (связь аккаунт-персонаж)",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"account_id": "UUID FOREIGN
              KEY"}, {"active_character_id": "UUID FOREIGN KEY (nullable)"}, {"total_slots":
              "INTEGER"}, {"purchased_slots": "INTEGER"}, {"created_at": "TIMESTAMP"}]},
              {"name": "characters", "description": "Персонажи", "columns": [{"id":
              "UUID PRIMARY KEY"}, {"player_id": "UUID FOREIGN KEY"}, {"name": "VARCHAR(255)"},
              {"origin": "VARCHAR(100)"}, {"class": "VARCHAR(100)"}, {"created_at":
              "TIMESTAMP"}, {"deleted_at": "TIMESTAMP (soft delete)"}, {"can_restore_until":
              "TIMESTAMP"}]}, {"name": "character_slots", "description": "Слоты персонажей",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"player_id": "UUID FOREIGN
              KEY"}, {"slot_number": "INTEGER"}, {"character_id": "UUID FOREIGN KEY
              (nullable)"}, {"purchased": "BOOLEAN"}, {"purchased_at": "TIMESTAMP
              (nullable)"}]}, {"name": "character_state_snapshots", "description":
              "Снимки состояния персонажей", "columns": [{"id": "UUID PRIMARY KEY"},
              {"character_id": "UUID FOREIGN KEY"}, {"snapshot_data": "JSONB"}, {"created_at":
              "TIMESTAMP"}]}, {"name": "character_progression", "description": "Прогрессия
              персонажей", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"level": "INTEGER"}, {"experience": "BIGINT"},
              {"experience_to_next_level": "BIGINT"}, {"updated_at": "TIMESTAMP"}]},
              {"name": "skill_experience", "description": "Опыт навыков", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"character_id": "UUID FOREIGN KEY"}, {"skill_type":
              "VARCHAR(100)"}, {"experience": "BIGINT"}, {"level": "INTEGER"}, {"updated_at":
              "TIMESTAMP"}]}, {"name": "progression_audit", "description": "Аудит
              прогрессии", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"event_type": "VARCHAR(100)"}, {"event_data":
              "JSONB"}, {"timestamp": "TIMESTAMP"}]}]}, "integrations": {"auth_to_character":
              "- Событие ACCOUNT_CREATED инициализирует слоты персонажей\n- Событие
              LOGIN_SUCCESS обновляет активные сессии\n- Character Service проверяет
              права доступа через Auth Service\n", "character_to_progression": "-
              Событие CharacterCreated инициализирует прогрессию\n- Character Service
              запрашивает начальные данные прогрессии\n- Progression Service обновляет
              прогрессию при переключении персонажа\n", "progression_to_gameplay":
              "- Progression Service публикует события level-up и skill-leveled\n-
              Gameplay Service использует данные прогрессии для игрового процесса\n-
              Gameplay Service начисляет опыт через Progression Service\n", "economy_integration":
              "- Character Service запрашивает покупку слотов через Economy Service\n-
              Economy Service обрабатывает транзакцию\n- Character Service получает
              подтверждение и обновляет слоты\n", "analytics_integration": "- Все
              сервисы публикуют события для Analytics Service\n- Analytics Service
              собирает метрики регистрации, входа, создания персонажей\n- Analytics
              Service отслеживает прогрессию и активность\n", "session_integration":
              "- Auth Service управляет сессиями через Session Service\n- Character
              Service обновляет сессии при переключении персонажей\n- Session Service
              валидирует сессии для всех запросов\n"}}, "technical_specification":
              {"subtasks": [{"id": "auth-service-core", "title": "Реализация основного
              функционала Auth Service", "description": "Реализация Authentication
              Manager, JWT Service, OAuth Handler\nс поддержкой регистрации, входа,
              обновления токенов.\n", "dependencies": [], "estimated_effort": "5 days"},
              {"id": "auth-security", "title": "Реализация безопасности Auth Service",
              "description": "Реализация Role Manager, Password Manager, антибрютфорс
              защиты\nи аудита безопасности.\n", "dependencies": ["auth-service-core"],
              "estimated_effort": "4 days"}, {"id": "character-service-core", "title":
              "Реализация основного функционала Character Service", "description":
              "Реализация Character Manager, Slot Manager, Character Switcher\nс поддержкой
              создания, удаления и переключения персонажей.\n", "dependencies": [],
              "estimated_effort": "5 days"}, {"id": "character-advanced", "title":
              "Реализация расширенного функционала Character Service", "description":
              "Реализация Character Recovery, Character Audit и интеграции\nс Economy
              Service для покупки слотов.\n", "dependencies": ["character-service-core"],
              "estimated_effort": "3 days"}, {"id": "progression-service-core", "title":
              "Реализация основного функционала Progression Service", "description":
              "Реализация Experience Manager, Level Manager, Skill Manager\nс поддержкой
              начисления опыта и управления навыками.\n", "dependencies": [], "estimated_effort":
              "5 days"}, {"id": "progression-advanced", "title": "Реализация расширенного
              функционала Progression Service", "description": "Реализация Attribute
              Manager, Snapshot Manager и аудита прогрессии\nс поддержкой откатов.\n",
              "dependencies": ["progression-service-core"], "estimated_effort": "3
              days"}, {"id": "session-service", "title": "Реализация Session Service",
              "description": "Реализация Session Manager, Session Storage, Session
              Validator\nс интеграцией с Auth и Character Service.\n", "dependencies":
              ["auth-service-core"], "estimated_effort": "3 days"}, {"id": "websocket-channels",
              "title": "Реализация WebSocket каналов", "description": "Реализация
              WebSocket каналов для Auth, Character и Progression\nс поддержкой realtime
              обновлений.\n", "dependencies": ["auth-service-core", "character-service-core",
              "progression-service-core"], "estimated_effort": "4 days"}, {"id": "event-bus-integration",
              "title": "Интеграция с Event Bus", "description": "Реализация публикации
              и подписки на события через Kafka\nдля всех сервисов Auth & Character
              Management.\n", "dependencies": ["auth-service-core", "character-service-core",
              "progression-service-core"], "estimated_effort": "3 days"}, {"id": "database-schema",
              "title": "Создание схемы БД", "description": "Создание таблиц БД для
              Auth, Character и Progression\nс миграциями Liquibase.\n", "dependencies":
              [], "estimated_effort": "2 days"}]}, "diagrams": {"component_diagram":
              "```mermaid\ngraph TB\n    Client[UE5 Client] --> Gateway[API Gateway]\n\n    Gateway
              --> AuthService[Auth Service<br/>8081]\n    Gateway --> CharacterService[Character
              Service<br/>8082]\n    Gateway --> ProgressionService[Progression Service<br/>8087]\n\n    AuthService
              --> AuthDB[(Auth DB)]\n    CharacterService --> CharacterDB[(Character
              DB)]\n    ProgressionService --> ProgressionDB[(Progression DB)]\n\n    AuthService
              --> SessionService[Session Service<br/>8090]\n    CharacterService -->
              SessionService\n\n    AuthService --> Keycloak[Keycloak<br/>OAuth]\n    AuthService
              --> Redis[(Redis<br/>Sessions)]\n\n    AuthService --> EventBus[Event
              Bus<br/>Kafka]\n    CharacterService --> EventBus\n    ProgressionService
              --> EventBus\n\n    EventBus --> EconomyService[Economy Service]\n    EventBus
              --> AnalyticsService[Analytics Service]\n    EventBus --> GameplayService[Gameplay
              Service]\n    EventBus --> InventoryService[Inventory Service]\n    EventBus
              --> NotificationService[Notification Service]\n\n    Client --> WSAuth[WebSocket<br/>Auth
              Sessions]\n    Client --> WSChar[WebSocket<br/>Characters]\n    Client
              --> WSProg[WebSocket<br/>Progression]\n\n    WSAuth --> AuthService\n    WSChar
              --> CharacterService\n    WSProg --> ProgressionService\n```\n", "auth_flow_diagram":
              "```mermaid\nsequenceDiagram\n    participant C as Client\n    participant
              AS as Auth Service\n    participant SS as Session Service\n    participant
              DB as Database\n    participant EB as Event Bus\n    participant CS
              as Character Service\n\n    C->>AS: POST /auth/register\n    AS->>DB:
              Create account\n    AS->>EB: Publish ACCOUNT_CREATED\n    AS-->>C: Registration
              success\n\n    EB->>CS: ACCOUNT_CREATED\n    CS->>CS: Initialize character
              slots\n\n    C->>AS: POST /auth/login\n    AS->>DB: Validate credentials\n    AS->>AS:
              Check brute-force protection\n    AS->>DB: Create session\n    AS->>SS:
              Update active sessions\n    AS->>EB: Publish LOGIN_SUCCESS\n    AS-->>C:
              JWT + Refresh tokens\n\n    C->>AS: POST /auth/refresh\n    AS->>DB:
              Validate refresh token\n    AS->>DB: Generate new tokens\n    AS-->>C:
              New JWT + Refresh tokens\n```\n", "character_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              C as Client\n    participant CS as Character Service\n    participant
              PS as Progression Service\n    participant GS as Gameplay Service\n    participant
              IS as Inventory Service\n    participant EB as Event Bus\n\n    C->>CS:
              POST /players/{id}/characters\n    CS->>CS: Check available slots\n    CS->>CS:
              Validate character data\n    CS->>CS: Create character\n    CS->>PS:
              Initialize progression\n    CS->>EB: Publish CharacterCreated\n    CS-->>C:
              Character created\n\n    EB->>GS: CharacterCreated\n    GS->>GS: Initialize
              gameplay data\n\n    EB->>IS: CharacterCreated\n    IS->>IS: Create
              initial inventory\n\n    C->>CS: POST /players/{id}/switch\n    CS->>CS:
              Update active character\n    CS->>CS: Save snapshot\n    CS->>EB: Publish
              CharacterSwitched\n    CS-->>C: Character switched\n\n    EB->>GS: CharacterSwitched\n    GS->>GS:
              Load new character data\n```\n"}}'
        - column:
            name: metadata
            value: '{"id": "auth-character-management-architecture", "title": "Архитектура
              Auth & Character Management", "document_type": "architecture", "category":
              "systems", "status": "draft", "version": "1.0.0", "last_updated": "2025-11-23T16:00:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "auth", "characters", "progression", "backend"],
              "related_systems": ["auth-service", "character-service", "gameplay-service",
              "session-service", "economy-service", "analytics-service"], "related_documents":
              [{"id": "analysis-2025-11-09-auth-characters-package", "relation": "implements"}],
              "github_issue": 153, "visibility": "internal", "audience": ["architect",
              "backend", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\auth-character-management-architecture.yaml
