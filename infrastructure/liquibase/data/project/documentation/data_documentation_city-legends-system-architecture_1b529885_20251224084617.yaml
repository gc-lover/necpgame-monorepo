databaseChangeLog:
- changeSet:
    id: documentation-city-legends-system-architecture-1b529885
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '8366033180935474'
        - column:
            name: doc_id
            value: city-legends-system-architecture
        - column:
            name: title
            value: Архитектура системы городских легенд для игроков
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-XXT00:00:00Z
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - social
            - legends
            - npc
            - reputation
            - content-generation
            - world-building
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - social-service
            - npc-service
            - achievement-service
            - world-service
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "reputation-system-architecture", "relation": "extends"},
              {"id": "achievement-system-architecture", "relation": "extends"}, {"id":
              "npc-dialogue-system", "relation": "integrates"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - social
            - npc
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "city-legends-system-architecture", "title":
              "Архитектура системы городских легенд для игроков", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-12-XXT00:00:00Z", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "social", "legends", "npc", "reputation", "content-generation", "world-building"],
              "related_systems": ["social-service", "npc-service", "achievement-service",
              "world-service", "analytics-service"], "related_documents": [{"id":
              "reputation-system-architecture", "relation": "extends"}, {"id": "achievement-system-architecture",
              "relation": "extends"}, {"id": "npc-dialogue-system", "relation": "integrates"}],
              "github_issue": 1464, "visibility": "internal", "audience": ["architect",
              "backend", "social", "npc", "api-designer"]}, "summary": {"problem":
              "В текущей системе репутации есть уровень \"Legendary\" (+76 to +100),
              но отсутствует механика,\nкоторая бы делала игроков настоящими городскими
              легендами - объектами слухов и баек,\nкоторые NPC рассказывают друг
              другу. Это упущенная возможность для создания атмосферы\nи социального
              взаимодействия.\n", "goal": "Создать архитектурную схему системы городских
              легенд с определением:\n- Компонентов для управления статусом легенды\n-
              Системы генерации баек на основе действий игроков\n- Интеграции с NPC
              диалоговой системой\n- Системы шаблонов и вариативности баек\n- Механизма
              распространения легенд между NPC\n- Системы триггеров и контекстной
              активации\n- REST, WebSocket и Event Bus контрактов\n- Структуры БД\n-
              Технического задания для реализации\n", "essence": "Объединенная архитектура
              системы городских легенд, которая делает игроков частью лора\nи нарратива
              через байки, распространяемые NPC, создавая атмосферу живого мира.\n"},
              "architecture": {"overview": "Архитектура системы городских легенд состоит
              из следующих компонентов:\n1. Legend Status Manager - управление статусом
              легенды игрока\n2. Legend Story Generator - генерация баек на основе
              действий\n3. Story Template Engine - обработка шаблонов баек\n4. Story
              Variant Generator - генерация вариантов баек\n5. Legend Spreader - распространение
              легенд между NPC\n6. Trigger Manager - управление триггерами активации\n7.
              Context Analyzer - анализ контекста для активации\n8. Dialogue Integration
              Manager - интеграция с диалогами NPC\n9. Knowledge Network Manager -
              управление сетью знаний NPC\n10. Legend Analytics - аналитика легенд\n",
              "microservices": [{"name": "social-service", "port": 8084, "responsibility":
              "Управление статусом легенды:\n- Определение условий получения статуса\n-
              Отслеживание активности игрока\n- Управление жизненным циклом легенды\n-
              Интеграция с системой репутации\n", "components": [{"legend-status-manager":
              "управление статусом легенды"}, {"legend-eligibility-checker": "проверка
              условий получения статуса"}, {"legend-activity-tracker": "отслеживание
              активности"}, {"legend-lifecycle-manager": "управление жизненным циклом"}]},
              {"name": "legend-service", "port": 8090, "responsibility": "Основной
              сервис для работы с легендами:\n- Генерация баек на основе действий\n-
              Управление шаблонами и вариативностью\n- Распространение легенд между
              NPC\n- Управление триггерами активации\n- Интеграция с диалогами NPC\n",
              "components": [{"legend-story-generator": "генерация баек"}, {"story-template-engine":
              "обработка шаблонов"}, {"story-variant-generator": "генерация вариантов"},
              {"legend-spreader": "распространение легенд"}, {"trigger-manager": "управление
              триггерами"}, {"context-analyzer": "анализ контекста"}, {"dialogue-integration-manager":
              "интеграция с диалогами"}, {"knowledge-network-manager": "управление
              сетью знаний"}, {"legend-analytics": "аналитика"}]}], "legend_status":
              {"eligibility_conditions": {"reputation_threshold": "- Репутация Legendary
              (+76 to +100) с минимум 3 фракциями\n- Или комбинация: репутация Honored+
              с уникальными достижениями\n", "achievement_triggers": "- Уникальные
              достижения (\"Один против армии\", \"Тень в ночи\", \"Король арены\")\n-
              Специфические действия (1000 убийств определенного типа врагов)\n- Социальные
              достижения (помощь X игрокам, создание клана)\n", "temporal_factor":
              "- Статус не постоянный - требует поддержания активности\n- Если игрок
              неактивен >30 дней, статус теряется\n- Можно восстановить через новые
              достижения\n"}, "legend_types": [{"type": "combat", "description": "Боевые
              легенды", "examples": ["Тот, кто выжил в одиночку против отряда корпоратов",
              "Тень, которая никогда не промахивается", "Берсерк, который не знает
              страха"], "sources": [{"achievement_service": "боевые достижения"},
              {"analytics_service": "статистика убийств"}, {"combat_service": "уникальные
              боевые действия"}]}, {"type": "social", "description": "Социальные легенды",
              "examples": ["Тот, кто помог тысяче новичков", "Легенда баров, знающий
              все тайны города", "Посредник, который всегда находит решение"], "sources":
              [{"achievement_service": "социальные достижения"}, {"analytics_service":
              "статистика помощи игрокам"}, {"social_service": "репутация и отношения"}]},
              {"type": "economic", "description": "Экономические легенды", "examples":
              ["Торговец, который никогда не обманывает", "Коллекционер редчайших
              артефактов", "Магнат, контролирующий рынок"], "sources": [{"achievement_service":
              "экономические достижения"}, {"analytics_service": "статистика транзакций"},
              {"economy_service": "торговые паттерны"}]}, {"type": "exploration",
              "description": "Исследовательские легенды", "examples": ["Тот, кто нашел
              все секреты города", "Археолог, раскопавший древние тайны", "Хакер,
              проникший в недоступные системы"], "sources": [{"achievement_service":
              "исследовательские достижения"}, {"analytics_service": "статистика открытий"},
              {"world_service": "открытые локации"}]}]}, "story_generation": {"data_sources":
              [{"achievement_service": "- Уникальные достижения (тип, описание, дата
              получения)\n- Редкие достижения (процент игроков, получивших)\n- Цепочки
              достижений (связанные события)\n"}, {"analytics_service": "- Количество
              убийств по типам врагов\n- Уникальные комбинации действий\n- Рекорды
              (максимальный урон, время выживания)\n- Социальные метрики (помощь другим
              игрокам)\n"}, {"social_service": "- Уровень репутации с каждой фракцией\n-
              Изменения репутации (резкие скачки)\n- Конфликты между фракциями\n"},
              {"economy_service": "- Крупные транзакции\n- Редкие предметы в инвентаре\n-
              Торговые паттерны\n"}, {"inventory_service": "- Уникальные предметы\n-
              Коллекции редких артефактов\n"}], "template_structure": "Template {\n  id:
              unique_identifier\n  type: legend_type (combat, social, economic, exploration)\n  category:
              event_category\n  base_template: \"текст с {переменными}\"\n  variables:
              [variable_definitions]\n  conditions: [activation_conditions]\n  variants:
              [alternative_templates]\n}\n", "variable_types": [{"player_name": "имя
              игрока"}, {"action_verb": "глагол действия (убил, победил, нашел)"},
              {"enemy_type": "тип врага (корпораты, бандиты, роботы)"}, {"location":
              "локация события"}, {"number": "числовое значение (1000, 50, 3)"}, {"time_context":
              "временной контекст (вчера, на прошлой неделе)"}, {"faction": "название
              фракции"}, {"emotion": "эмоциональная окраска (страх, восхищение, уважение)"}],
              "generation_algorithm": "1. Сбор данных из различных источников\n2.
              Выбор релевантных событий (фильтрация по важности)\n3. Выбор шаблона
              по типу легенды\n4. Заполнение переменных из данных игрока\n5. Генерация
              3-5 вариантов байки\n6. Валидация и сохранение в БД\n", "variability_levels":
              [{"basic": "Простая подстановка переменных"}, {"medium": "Вариация формулировок
              и структуры"}, {"high": "Полная переформулировка с сохранением смысла"}]},
              "story_spreading": {"spread_mechanism": "Легенды начинаются с NPC-свидетелей
              событий и распространяются по сети\nсоциальных связей между NPC. Со
              временем информация искажается, обрастая\nдеталями и преувеличениями.\n",
              "knowledge_sources": [{"direct_witnesses": "- NPC, которые видели событие
              лично\n- Высокая точность информации\n- Множество деталей\n"}, {"secondary_sources":
              "- NPC, которые узнали от свидетелей\n- Средняя точность\n- Меньше деталей\n"},
              {"tertiary_sources": "- NPC, которые узнали от других\n- Низкая точность\n-
              Искаженная информация\n"}], "spread_channels": [{"direct_communication":
              "NPC встречаются и разговаривают"}, {"gathering_places": "бары, рынки,
              общественные места"}, {"faction_channels": "информация внутри фракций"},
              {"random_encounters": "случайные NPC делятся информацией"}], "distortion_factors":
              "distortion = base_distortion + (time_factor * time_passed) +\n             (distance_factor
              * hops) + (importance_factor * event_importance)\naccuracy = 1.0 - min(1.0,
              distortion)\n", "temporal_model": "- Рождение: событие происходит, свидетели
              знают\n- Распространение: информация распространяется (1-7 дней)\n-
              Пик популярности: максимальное распространение (7-30 дней)\n- Затухание:
              информация забывается (30+ дней)\n- Забвение: легенда исчезает или становится
              мифом\n"}, "trigger_system": {"trigger_types": [{"spatial": "- Игрок
              входит в определенную локацию\n- Игрок находится рядом с NPC-рассказчиком\n-
              Игрок посещает место, связанное с легендой\n"}, {"temporal": "- Определенное
              время суток\n- Определенный день недели\n- Специальные события (праздники,
              события мира)\n"}, {"event_based": "- Завершение квеста, связанного
              с легендой\n- Достижение игроком определенного статуса\n- События мира,
              связанные с легендой\n"}, {"dialogue": "- Игрок задает вопрос про легенду\n-
              Тема разговора релевантна легенде\n- Игрок упоминает имя легендарного
              игрока\n"}, {"social": "- Присутствие легендарного игрока в локации\n-
              Встреча с другими игроками, знающими легенду\n- Изменение репутации
              игрока\n"}, {"combined": "- Комбинация нескольких факторов\n- Условия
              \"И\" и \"ИЛИ\"\n- Приоритеты триггеров\n"}], "priority_levels": [{"critical":
              "байка активируется немедленно (присутствие легенды)"}, {"high": "байка
              активируется при первом подходящем моменте"}, {"medium": "байка активируется
              при наличии времени"}, {"low": "байка активируется в фоновом режиме"}],
              "relevance_calculation": "relevance_score = (location_weight * location_match)
              +\n                  (faction_weight * faction_match) +\n                  (time_weight
              * time_match) +\n                  (event_weight * event_match)\n",
              "spam_prevention": "- Кулердауны между активациями\n- Лимиты на количество
              баек в час/день\n- Уникальность (одна байка не повторяется в короткий
              период)\n"}, "dialogue_integration": {"integration_types": [{"active_dialogues":
              "- NPC сам начинает рассказывать байку при встрече\n- Триггер: игрок-легенда
              входит в локацию\n"}, {"reactive_dialogues": "- Игрок спрашивает про
              легендарного игрока\n- Триггер: вопрос в диалоге\n"}, {"background_conversations":
              "- NPC разговаривают между собой про легенд\n- Триггер: игрок находится
              рядом, но не взаимодействует\n"}, {"contextual_mentions": "- Байка упоминается
              в контексте другого диалога\n- Триггер: релевантная тема в разговоре\n"}],
              "dialogue_node_types": "- Legend Story Node: новый тип узла с ссылкой
              на байку\n- Conditional Node: условный узел (проверка наличия легенды)\n-
              Dynamic Node: динамическая вставка баек в существующие диалоги\n", "npc_knowledge_levels":
              "- direct_knowledge: \"NPC видел событие лично\"\n- rumors: \"NPC слышал
              от других\"\n- legends: \"NPC знает только мифы и преувеличения\"\n"},
              "data_models": [{"name": "PlayerLegend", "fields": [{"id": "UUID"},
              {"player_id": "UUID"}, {"legend_type": "enum (combat, social, economic,
              exploration)"}, {"status": "enum (active, inactive, lost)"}, {"reputation_requirement":
              "json"}, {"achievement_triggers": "array<UUID>"}, {"created_at": "timestamp"},
              {"last_active_at": "timestamp"}, {"expires_at": "timestamp"}, {"created_by":
              "string (achievement, reputation, manual)"}]}, {"name": "LegendStory",
              "fields": [{"id": "UUID"}, {"player_legend_id": "UUID"}, {"template_id":
              "UUID"}, {"story_text": "text"}, {"variant_id": "UUID"}, {"context":
              "json (location, faction, time)"}, {"generated_at": "timestamp"}, {"accuracy":
              "float (0.0-1.0)"}, {"distortion_level": "float"}, {"popularity_score":
              "float"}]}, {"name": "StoryTemplate", "fields": [{"id": "UUID"}, {"type":
              "enum (combat, social, economic, exploration)"}, {"base_template": "text"},
              {"variables": "json"}, {"conditions": "json"}, {"variants": "array<text>"},
              {"cultural_adaptations": "json"}]}, {"name": "NPCLegendKnowledge", "fields":
              [{"id": "UUID"}, {"npc_id": "UUID"}, {"legend_story_id": "UUID"}, {"knowledge_level":
              "enum (direct, secondary, tertiary)"}, {"accuracy": "float"}, {"learned_from":
              "UUID (npc_id или null для прямых свидетелей)"}, {"learned_at": "timestamp"},
              {"last_told_at": "timestamp"}]}, {"name": "LegendTrigger", "fields":
              [{"id": "UUID"}, {"legend_story_id": "UUID"}, {"trigger_type": "enum
              (spatial, temporal, event, dialogue, social, combined)"}, {"conditions":
              "json"}, {"priority": "enum (critical, high, medium, low)"}, {"cooldown_seconds":
              "int"}, {"max_activations_per_hour": "int"}]}, {"name": "TriggerActivation",
              "fields": [{"id": "UUID"}, {"trigger_id": "UUID"}, {"npc_id": "UUID"},
              {"player_id": "UUID"}, {"activated_at": "timestamp"}, {"context": "json"}]},
              {"name": "NPCSocialNetwork", "fields": [{"id": "UUID"}, {"npc_id": "UUID"},
              {"connected_npc_id": "UUID"}, {"connection_type": "enum (friend, colleague,
              acquaintance, enemy)"}, {"connection_strength": "float"}, {"location_proximity":
              "boolean"}]}], "api_endpoints": {"legend_management": ["GET /api/v1/legends/player/{playerId}
              - получение легенд игрока", "GET /api/v1/legends/player/{playerId}/status
              - статус легенды", "POST /api/v1/legends/player/{playerId}/check-eligibility
              - проверка условий", "GET /api/v1/legends/player/{playerId}/stories
              - байки игрока", "GET /api/v1/legends/story/{storyId} - детали байки"],
              "story_generation": ["POST /api/v1/legends/generate-story - генерация
              новой байки", "GET /api/v1/legends/templates - список шаблонов", "GET
              /api/v1/legends/templates/{templateId} - детали шаблона", "POST /api/v1/legends/templates
              - создание шаблона"], "npc_integration": ["GET /api/v1/legends/npc/{npcId}/knowledge
              - знания NPC о легендах", "GET /api/v1/legends/npc/{npcId}/available-stories
              - доступные байки для NPC", "POST /api/v1/legends/npc/{npcId}/learn-story
              - NPC узнает байку", "GET /api/v1/legends/npc/{npcId}/social-network
              - социальная сеть NPC"], "trigger_management": ["GET /api/v1/legends/triggers
              - список триггеров", "POST /api/v1/legends/triggers - создание триггера",
              "POST /api/v1/legends/triggers/{triggerId}/activate - активация триггера",
              "GET /api/v1/legends/triggers/{triggerId}/activations - история активаций"]},
              "websocket_events": ["legend:status-changed - изменение статуса легенды",
              "legend:story-generated - новая байка сгенерирована", "legend:story-told
              - NPC рассказал байку", "legend:knowledge-spread - знание распространилось
              между NPC"], "event_bus_topics": ["legend:player-became-legend - игрок
              стал легендой", "legend:player-lost-legend - игрок потерял статус",
              "legend:story-generated - байка сгенерирована", "legend:story-told -
              байка рассказана NPC", "legend:knowledge-spread - знание распространилось",
              "legend:trigger-activated - триггер активирован"], "data_synchronization":
              {"tick_rate": "- Статус легенды: проверка каждые 1 час\n- Генерация
              баек: асинхронно при событиях\n- Распространение знаний: пакетная обработка
              каждые 15 минут\n- Проверка триггеров: при событиях (вход в локацию,
              диалог)\n", "network_load": "- Генерация баек: низкая нагрузка (асинхронно)\n-
              Распространение знаний: средняя нагрузка (пакетная обработка)\n- Проверка
              триггеров: средняя нагрузка (при событиях)\n- Запросы знаний NPC: высокая
              нагрузка (кэширование обязательно)\n", "caching_strategy": "- Активные
              легенды: кэш на 1 час\n- Байки игрока: кэш на 30 минут\n- Знания NPC:
              кэш на 15 минут\n- Шаблоны: кэш на 24 часа\n"}, "integrations": {"with_social_service":
              "- Получение данных репутации для определения легенды\n- Подписка на
              изменения репутации\n- Интеграция с системой репутации\n", "with_achievement_service":
              "- Подписка на события новых достижений\n- Запрос данных о достижениях
              игрока\n- Использование достижений для генерации баек\n", "with_analytics_service":
              "- Получение статистики действий игрока\n- Анализ паттернов поведения\n-
              Метрики для определения легенды\n", "with_npc_service": "- Интеграция
              с диалоговой системой NPC\n- Управление знаниями NPC\n- Реакции NPC
              на легендарных игроков\n", "with_world_service": "- Получение данных
              о локациях\n- Подписка на события мира\n- Распространение легенд по
              локациям\n", "with_inventory_service": "- Проверка редких предметов\n-
              Анализ коллекций\n"}, "technical_tasks": [{"task": "Создать legend-service
              микросервис", "description": "Новый микросервис для управления легендами
              с компонентами:\n- Legend Story Generator\n- Story Template Engine\n-
              Legend Spreader\n- Trigger Manager\n- Dialogue Integration Manager\n",
              "estimated_lines": 400}, {"task": "Расширить social-service для управления
              статусом легенды", "description": "Добавить компоненты в social-service:\n-
              Legend Status Manager\n- Legend Eligibility Checker\n- Legend Activity
              Tracker\n", "estimated_lines": 300}, {"task": "Создать структуру БД
              для легенд", "description": "Создать таблицы:\n- player_legends\n- legend_stories\n-
              story_templates\n- npc_legend_knowledge\n- legend_triggers\n- trigger_activations\n-
              npc_social_network\n", "estimated_lines": 200}, {"task": "Интегрировать
              с NPC диалоговой системой", "description": "Расширить диалоговую систему
              новыми типами узлов:\n- Legend Story Node\n- Conditional Legend Node\n-
              Dynamic Legend Node\n", "estimated_lines": 250}, {"task": "Реализовать
              систему распространения знаний", "description": "Создать механизм распространения
              легенд между NPC:\n- Knowledge Network Manager\n- Distortion Engine\n-
              Temporal Manager\n- Geographic Manager\n", "estimated_lines": 350},
              {"task": "Реализовать систему триггеров", "description": "Создать систему
              триггеров активации:\n- Trigger Manager\n- Context Analyzer\n- Relevance
              Calculator\n- Cooldown Manager\n", "estimated_lines": 300}, {"task":
              "Создать API endpoints", "description": "Реализовать REST API для управления
              легендами:\n- Legend Management endpoints\n- Story Generation endpoints\n-
              NPC Integration endpoints\n- Trigger Management endpoints\n", "estimated_lines":
              400}, {"task": "Интегрировать с Event Bus", "description": "Подписка
              на события и публикация событий легенд:\n- Подписка на achievement:unlocked\n-
              Подписка на reputation:changed\n- Публикация legend:* событий\n", "estimated_lines":
              200}]}}'
        - column:
            name: metadata
            value: '{"id": "city-legends-system-architecture", "title": "Архитектура
              системы городских легенд для игроков", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-12-XXT00:00:00Z", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "social", "legends",
              "npc", "reputation", "content-generation", "world-building"], "related_systems":
              ["social-service", "npc-service", "achievement-service", "world-service",
              "analytics-service"], "related_documents": [{"id": "reputation-system-architecture",
              "relation": "extends"}, {"id": "achievement-system-architecture", "relation":
              "extends"}, {"id": "npc-dialogue-system", "relation": "integrates"}],
              "github_issue": 1464, "visibility": "internal", "audience": ["architect",
              "backend", "social", "npc", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\city-legends-system-architecture.yaml
