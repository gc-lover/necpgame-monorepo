databaseChangeLog:
- changeSet:
    id: documentation-combat-ai-enemies-architecture-56efd4a7
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-733560725947709'
        - column:
            name: doc_id
            value: combat-ai-enemies-architecture
        - column:
            name: title
            value: Архитектура системы боевого AI врагов
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-23 18:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - combat
            - ai
            - enemies
            - raids
            - telemetry
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - gameplay-service
            - world-service
            - analytics-service
            - economy-service
            - social-service
        - column:
            name: related_documents
            value: '[{"id": "mechanics-combat-ai-enemies", "relation": "implements"},
              {"id": "analysis-2025-11-09-combat-ai-package", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - gameplay
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "combat-ai-enemies-architecture", "title":
              "Архитектура системы боевого AI врагов", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-11-23T18:00:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "combat", "ai", "enemies",
              "raids", "telemetry"], "related_systems": ["gameplay-service", "world-service",
              "analytics-service", "economy-service", "social-service"], "related_documents":
              [{"id": "mechanics-combat-ai-enemies", "relation": "implements"}, {"id":
              "analysis-2025-11-09-combat-ai-package", "relation": "extends"}], "github_issue":
              157, "visibility": "internal", "audience": ["architect", "backend",
              "gameplay", "api-designer"]}, "summary": {"problem": "Требуется спроектировать
              архитектуру системы боевого AI врагов, включающую:\n- Профили AI врагов
              с различными слоями сложности (Street, Tactical, Mythic, Raid)\n- Рейдовые
              сценарии с фазами и механиками боссов\n- Телеметрию и балансировку AI\n-
              Интеграцию с combat session, world events и аналитикой\n", "goal": "Создать
              архитектурную схему системы боевого AI с определением:\n- Компонентов
              для управления AI врагами\n- REST, WebSocket и Event Bus контрактов\n-
              Интеграций с другими системами\n- Структуры БД\n- Технического задания
              для реализации\n", "essence": "Объединенная архитектура системы боевого
              AI с поддержкой профилей врагов,\nрейдовых сценариев, телеметрии и балансировки.\n"},
              "architecture": {"overview": "Архитектура системы боевого AI состоит
              из следующих компонентов:\n1. AI Profile Manager - управление профилями
              AI врагов\n2. AI Behavior Engine - движок поведения AI (Behaviour Tree
              + Utility AI)\n3. Raid Manager - управление рейдовыми сценариями\n4.
              Boss Phase Controller - управление фазами боссов\n5. AI Telemetry Collector
              - сбор телеметрии AI\n6. AI Balance Tuner - автотюнинг баланса AI\n7.
              Encounter Manager - управление встречами с врагами\n", "microservices":
              [{"name": "gameplay-service", "port": 8083, "responsibility": "Обработка
              боевого AI:\n- Управление профилями AI врагов\n- Обработка поведения
              AI\n- Управление рейдами и фазами боссов\n- Сбор телеметрии\n- Балансировка
              AI\n", "components": [{"ai-profile-manager": "управление профилями AI"},
              {"ai-behavior-engine": "движок поведения AI"}, {"raid-manager": "управление
              рейдами"}, {"boss-phase-controller": "управление фазами боссов"}, {"ai-telemetry-collector":
              "сбор телеметрии"}, {"ai-balance-tuner": "автотюнинг баланса"}, {"encounter-manager":
              "управление встречами"}], "endpoints": ["GET /api/v1/gameplay/combat/ai/profiles
              - список профилей AI", "GET /api/v1/gameplay/combat/ai/profiles/{id}
              - информация о профиле", "GET /api/v1/gameplay/combat/ai/profiles/{id}/telemetry
              - телеметрия профиля", "POST /api/v1/gameplay/combat/raids/{raidId}/phase
              - переход фазы рейда", "POST /api/v1/gameplay/combat/ai/encounter -
              создание встречи", "GET /api/v1/gameplay/combat/ai/encounter/{encounterId}
              - информация о встрече", "POST /api/v1/gameplay/combat/ai/encounter/{encounterId}/start
              - старт встречи", "POST /api/v1/gameplay/combat/ai/encounter/{encounterId}/end
              - завершение встречи"], "websocket_channels": ["wss://api.necp.game/v1/gameplay/raid/{raidId}
              - события рейда (PhaseStart, MechanicTrigger, PlayerDown, CheckRequired)"],
              "events_published": [{"combat.ai.state": "состояние AI врага"}, {"world.events.trigger":
              "триггер мирового события"}, {"raid.telemetry": "телеметрия рейда"},
              {"raid.phase.started": "начало фазы рейда"}, {"raid.phase.completed":
              "завершение фазы рейда"}, {"raid.boss.defeated": "поражение босса"},
              {"encounter.started": "начало встречи"}, {"encounter.completed": "завершение
              встречи"}]}], "difficulty_layers": [{"name": "street", "description":
              "Уличные враги", "skill_level": "1-10", "characteristics": "Базовые
              навыки, простая тактика, стандартное оружие\n", "unique_abilities":
              [], "lore_events": []}, {"name": "tactical", "description": "Тактические
              враги", "skill_level": "11-20", "characteristics": "Продвинутая тактика,
              сканы, адаптация, уникальные навыки фракций\n", "unique_abilities":
              ["Urban Sweep", "Sync Burst", "Faction-specific abilities (Arasaka,
              Militech, Kang Tao, NetWatch, Voodoo Boys)"], "lore_events": []}, {"name":
              "mythic", "description": "Мифические враги", "skill_level": "21-30",
              "characteristics": "Легендарные способности, сложные механики, уникальные
              сценарии\n", "unique_abilities": ["Reality Tear", "Legendary combos"],
              "lore_events": []}, {"name": "raid", "description": "Рейдовые враги",
              "skill_level": "31+", "characteristics": "Многофазовые боссы, координация
              команды, уникальные механики рейдов\n", "unique_abilities": ["Blackwall
              Expedition mechanics", "Corpo Tower Assault mechanics"], "lore_events":
              ["Blackwall Expedition", "Corpo Tower Assault"]}], "data_flows": {"ai_encounter_flow":
              "1. Игрок входит в зону с врагами\n2. Encounter Manager создает встречу
              через POST /api/v1/gameplay/combat/ai/encounter\n3. AI Profile Manager
              загружает профили врагов\n4. AI Behavior Engine инициализирует поведение\n5.
              Encounter Manager запускает встречу через POST /api/v1/gameplay/combat/ai/encounter/{id}/start\n6.
              AI Behavior Engine обрабатывает поведение врагов\n7. Combat Session
              обрабатывает боевые действия\n8. AI Telemetry Collector собирает данные\n9.
              При завершении Encounter Manager завершает встречу\n10. Gameplay Service
              публикует событие encounter.completed\n", "raid_flow": "1. Команда игроков
              входит в рейд\n2. Raid Manager создает рейдовую сессию\n3. Boss Phase
              Controller инициализирует первую фазу\n4. Raid Manager публикует событие
              raid.phase.started\n5. Realtime Gateway отправляет событие PhaseStart
              через WebSocket\n6. Игроки сражаются с боссом\n7. Boss Phase Controller
              отслеживает прогресс фазы\n8. При выполнении условий Boss Phase Controller
              переходит к следующей фазе\n9. Raid Manager публикует событие raid.phase.completed\n10.
              При поражении босса Raid Manager публикует raid.boss.defeated\n11. Economy
              Service выдает награды\n12. Analytics Service логирует рейд\n", "ai_behavior_flow":
              "1. AI Behavior Engine получает состояние боя\n2. AI Behavior Engine
              оценивает ситуацию через Utility AI\n3. AI Behavior Engine выбирает
              действие через Behaviour Tree\n4. AI Behavior Engine выполняет действие
              (атака, способность, перемещение)\n5. Combat Session обрабатывает действие\n6.
              AI Behavior Engine обновляет состояние AI\n7. AI Telemetry Collector
              записывает действие\n8. Gameplay Service публикует событие combat.ai.state\n9.
              Realtime Gateway отправляет обновление клиентам\n", "balance_tuning_flow":
              "1. AI Telemetry Collector собирает данные за 24 часа\n2. AI Balance
              Tuner анализирует метрики (урон, время до падения, skill tests)\n3.
              AI Balance Tuner определяет дисбалансы\n4. AI Balance Tuner рассчитывает
              новые коэффициенты\n5. AI Balance Tuner обновляет профили AI\n6. AI
              Balance Tuner публикует событие ai.balance.updated\n7. Analytics Service
              логирует изменения баланса\n"}, "database_structure": {"tables": [{"name":
              "enemy_ai_profiles", "description": "Профили AI врагов", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"name": "VARCHAR(255)"}, {"difficulty_layer":
              "ENUM (street, tactical, mythic, raid)"}, {"skill_level_min": "INTEGER"},
              {"skill_level_max": "INTEGER"}, {"behavior_tree": "JSONB"}, {"utility_weights":
              "JSONB"}, {"abilities": "JSONB"}, {"loot_table_id": "UUID"}, {"faction_id":
              "UUID (nullable)"}, {"world_influence": "JSONB"}, {"created_at": "TIMESTAMP"}]},
              {"name": "enemy_ai_abilities", "description": "Способности AI врагов",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"profile_id": "UUID FOREIGN
              KEY"}, {"ability_name": "VARCHAR(255)"}, {"ability_type": "VARCHAR(100)"},
              {"cooldown": "INTEGER"}, {"damage": "INTEGER"}, {"effects": "JSONB"},
              {"requirements": "JSONB"}]}, {"name": "raid_boss_phases", "description":
              "Фазы рейдовых боссов", "columns": [{"id": "UUID PRIMARY KEY"}, {"raid_id":
              "UUID FOREIGN KEY"}, {"phase_number": "INTEGER"}, {"phase_name": "VARCHAR(255)"},
              {"boss_profile_id": "UUID FOREIGN KEY"}, {"mechanics": "JSONB"}, {"health_threshold":
              "INTEGER"}, {"transition_conditions": "JSONB"}, {"rewards": "JSONB"}]},
              {"name": "raid_sessions", "description": "Сессии рейдов", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"raid_id": "UUID FOREIGN KEY"}, {"current_phase":
              "INTEGER"}, {"started_at": "TIMESTAMP"}, {"completed_at": "TIMESTAMP
              (nullable)"}, {"status": "ENUM (in_progress, completed, failed)"}, {"participants":
              "JSONB"}]}, {"name": "ai_encounters", "description": "Встречи с AI врагами",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"encounter_type": "VARCHAR(100)"},
              {"profile_ids": "JSONB"}, {"zone_id": "UUID"}, {"started_at": "TIMESTAMP"},
              {"completed_at": "TIMESTAMP (nullable)"}, {"result": "ENUM (victory,
              defeat, abandoned)"}]}, {"name": "ai_telemetry", "description": "Телеметрия
              AI", "columns": [{"id": "UUID PRIMARY KEY"}, {"profile_id": "UUID FOREIGN
              KEY"}, {"encounter_id": "UUID FOREIGN KEY (nullable)"}, {"raid_id":
              "UUID FOREIGN KEY (nullable)"}, {"damage_dealt": "INTEGER"}, {"damage_taken":
              "INTEGER"}, {"time_to_defeat": "INTEGER"}, {"skill_tests_passed": "INTEGER"},
              {"skill_tests_failed": "INTEGER"}, {"abilities_used": "JSONB"}, {"timestamp":
              "TIMESTAMP"}]}, {"name": "ai_balance_coefficients", "description": "Коэффициенты
              баланса AI", "columns": [{"id": "UUID PRIMARY KEY"}, {"profile_id":
              "UUID FOREIGN KEY"}, {"coefficient_type": "VARCHAR(100)"}, {"value":
              "DECIMAL(10,4)"}, {"updated_at": "TIMESTAMP"}, {"tuning_reason": "TEXT"}]}]},
              "integrations": {"combat_session": "- AI враги участвуют в combat session\n-
              Обработка урона и способностей через Combat Session\n- Синхронизация
              состояния боя\n", "world_service": "- Триггеры мировых событий при поражении
              боссов\n- Влияние на состояние мира через world.events.trigger\n- Интеграция
              с фракциями и территориями\n", "economy_service": "- Генерация лута
              через loot tables\n- Выдача наград за рейды\n- Экономические модификаторы
              для AI\n", "analytics_service": "- Сбор телеметрии всех встреч\n- Анализ
              баланса и метрик\n- Детект эксплойтов и аномалий\n", "social_service":
              "- Координация команд в рейдах\n- Социальные бонусы для командных рейдов\n-
              Интеграция с гильдиями\n", "progression_service": "- Проверка требований
              для рейдов\n- Начисление опыта за победы\n- Обновление навыков на основе
              встреч\n", "realtime_gateway": "- Отправка realtime событий рейдов\n-
              Синхронизация состояния AI\n- Уведомления о фазах и механиках\n"}},
              "technical_specification": {"subtasks": [{"id": "ai-profile-manager",
              "title": "Реализация менеджера профилей AI", "description": "Реализация
              AI Profile Manager с загрузкой профилей, фильтрацией по слоям сложности\nи
              управлением способностями врагов.\n", "dependencies": [], "estimated_effort":
              "4 days"}, {"id": "ai-behavior-engine", "title": "Реализация движка
              поведения AI", "description": "Реализация AI Behavior Engine с комбинацией
              Behaviour Tree и Utility AI,\nобработкой действий и синхронизацией с
              Combat Session.\n", "dependencies": ["ai-profile-manager"], "estimated_effort":
              "7 days"}, {"id": "raid-manager", "title": "Реализация менеджера рейдов",
              "description": "Реализация Raid Manager с управлением рейдовыми сессиями,
              координацией игроков\nи интеграцией с World Service.\n", "dependencies":
              ["ai-profile-manager"], "estimated_effort": "6 days"}, {"id": "boss-phase-controller",
              "title": "Реализация контроллера фаз боссов", "description": "Реализация
              Boss Phase Controller с управлением фазами, механиками боссов\nи переходами
              между фазами.\n", "dependencies": ["raid-manager", "ai-behavior-engine"],
              "estimated_effort": "5 days"}, {"id": "encounter-manager", "title":
              "Реализация менеджера встреч", "description": "Реализация Encounter
              Manager с созданием встреч, управлением жизненным циклом\nи интеграцией
              с AI Behavior Engine.\n", "dependencies": ["ai-behavior-engine"], "estimated_effort":
              "4 days"}, {"id": "ai-telemetry-collector", "title": "Реализация сборщика
              телеметрии", "description": "Реализация AI Telemetry Collector с сбором
              метрик, логированием действий\nи интеграцией с Analytics Service.\n",
              "dependencies": ["ai-behavior-engine", "encounter-manager"], "estimated_effort":
              "3 days"}, {"id": "ai-balance-tuner", "title": "Реализация автотюнера
              баланса", "description": "Реализация AI Balance Tuner с анализом метрик,
              расчетом коэффициентов\nи автоматическим обновлением баланса каждые
              24 часа.\n", "dependencies": ["ai-telemetry-collector"], "estimated_effort":
              "5 days"}, {"id": "websocket-channels", "title": "Реализация WebSocket
              каналов", "description": "Реализация WebSocket каналов для realtime
              событий рейдов\nс поддержкой PhaseStart, MechanicTrigger, PlayerDown,
              CheckRequired.\n", "dependencies": ["raid-manager", "boss-phase-controller"],
              "estimated_effort": "3 days"}, {"id": "event-bus-integration", "title":
              "Интеграция с Event Bus", "description": "Реализация публикации и подписки
              на события через Kafka\nдля всех компонентов системы AI.\n", "dependencies":
              ["ai-behavior-engine", "raid-manager", "encounter-manager"], "estimated_effort":
              "2 days"}, {"id": "database-schema", "title": "Создание схемы БД", "description":
              "Создание таблиц БД для AI профилей, способностей, рейдов, встреч, телеметрии\nи
              баланса с миграциями Liquibase.\n", "dependencies": [], "estimated_effort":
              "2 days"}]}, "diagrams": {"component_diagram": "```mermaid\ngraph TB\n    Client[UE5
              Client] --> Gateway[API Gateway]\n\n    Gateway --> GameplayService[Gameplay
              Service<br/>8083]\n\n    GameplayService --> APM[AI Profile Manager]\n    GameplayService
              --> ABE[AI Behavior Engine]\n    GameplayService --> RM[Raid Manager]\n    GameplayService
              --> BPC[Boss Phase Controller]\n    GameplayService --> EMC[Encounter
              Manager]\n    GameplayService --> ATC[AI Telemetry Collector]\n    GameplayService
              --> ABT[AI Balance Tuner]\n\n    ABE --> APM\n    BPC --> RM\n    EMC
              --> ABE\n    ATC --> ABE\n    ABT --> ATC\n\n    GameplayService -->
              CombatSession[Combat Session]\n    GameplayService --> WorldService[World
              Service]\n    GameplayService --> EconomyService[Economy Service]\n    GameplayService
              --> AnalyticsService[Analytics Service]\n    GameplayService --> SocialService[Social
              Service]\n    GameplayService --> ProgressionService[Progression Service]\n\n    GameplayService
              --> EventBus[Event Bus<br/>Kafka]\n    EventBus --> RealtimeGateway[Realtime
              Gateway]\n\n    GameplayService --> DB[(Gameplay DB)]\n\n    Client
              --> WSRaid[WebSocket<br/>Raid Events]\n    WSRaid --> GameplayService\n```\n",
              "raid_flow_diagram": "```mermaid\nsequenceDiagram\n    participant C
              as Client\n    participant RM as Raid Manager\n    participant BPC as
              Boss Phase Controller\n    participant ABE as AI Behavior Engine\n    participant
              WS as World Service\n    participant EB as Event Bus\n    participant
              RG as Realtime Gateway\n\n    C->>RM: Enter raid\n    RM->>RM: Create
              raid session\n    RM->>BPC: Initialize phase 1\n    BPC->>ABE: Load
              boss AI profile\n    RM->>EB: Publish raid.phase.started\n    EB->>RG:
              Notify clients\n    RG->>C: PhaseStart event\n\n    Note over C,RG:
              Players fight boss\n\n    ABE->>ABE: Process boss behavior\n    ABE->>BPC:
              Update phase progress\n    BPC->>BPC: Check phase conditions\n\n    alt
              Phase conditions met\n        BPC->>BPC: Transition to next phase\n        BPC->>EB:
              Publish raid.phase.completed\n        EB->>RG: Notify clients\n        RG->>C:
              PhaseStart (next phase)\n    end\n\n    alt Boss defeated\n        BPC->>RM:
              Boss defeated\n        RM->>EB: Publish raid.boss.defeated\n        RM->>WS:
              Trigger world event\n        RM->>RM: Complete raid session\n        EB->>RG:
              Notify clients\n        RG->>C: Raid completed\n    end\n```\n", "ai_behavior_diagram":
              "```mermaid\nsequenceDiagram\n    participant ABE as AI Behavior Engine\n    participant
              APM as AI Profile Manager\n    participant CS as Combat Session\n    participant
              ATC as AI Telemetry Collector\n    participant EB as Event Bus\n\n    ABE->>APM:
              Load AI profile\n    APM-->>ABE: Profile data\n\n    loop Combat loop\n        ABE->>ABE:
              Evaluate situation (Utility AI)\n        ABE->>ABE: Select action (Behaviour
              Tree)\n        ABE->>CS: Execute action\n        CS->>CS: Process combat
              action\n        CS-->>ABE: Action result\n        ABE->>ABE: Update
              AI state\n        ABE->>ATC: Record action\n        ABE->>EB: Publish
              combat.ai.state\n    end\n```\n"}}'
        - column:
            name: metadata
            value: '{"id": "combat-ai-enemies-architecture", "title": "Архитектура
              системы боевого AI врагов", "document_type": "architecture", "category":
              "systems", "status": "draft", "version": "1.0.0", "last_updated": "2025-11-23T18:00:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "combat", "ai", "enemies", "raids", "telemetry"],
              "related_systems": ["gameplay-service", "world-service", "analytics-service",
              "economy-service", "social-service"], "related_documents": [{"id": "mechanics-combat-ai-enemies",
              "relation": "implements"}, {"id": "analysis-2025-11-09-combat-ai-package",
              "relation": "extends"}], "github_issue": 157, "visibility": "internal",
              "audience": ["architect", "backend", "gameplay", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\combat-ai-enemies-architecture.yaml
