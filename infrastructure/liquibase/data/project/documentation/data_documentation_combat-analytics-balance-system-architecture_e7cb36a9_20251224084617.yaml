databaseChangeLog:
- changeSet:
    id: documentation-combat-analytics-balance-system-architecture-e7cb36a9
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '2592912187901799'
        - column:
            name: doc_id
            value: combat-analytics-balance-system-architecture
        - column:
            name: title
            value: Архитектура системы сбора статистики и балансировки боевых механик
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-XXT00:00:00Z
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - combat
            - analytics
            - balance
            - statistics
            - telemetry
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - analytics-service
            - gameplay-service
            - combat-sessions-service
            - combat-abilities-service
            - combat-ai-service
        - column:
            name: related_documents
            value: '[{"id": "combat-analytics-balance-idea", "relation": "implements"},
              {"id": "combat-shooting-architecture", "relation": "extends"}, {"id":
              "combat-ai-enemies-architecture", "relation": "extends"}, {"id": "faction-analytics-balance",
              "relation": "references"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - analytics
            - combat
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "combat-analytics-balance-system-architecture",
              "title": "Архитектура системы сбора статистики и балансировки боевых
              механик", "document_type": "architecture", "category": "systems", "status":
              "draft", "version": "1.0.0", "last_updated": "2025-12-XXT00:00:00Z",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "combat", "analytics", "balance", "statistics",
              "telemetry"], "related_systems": ["analytics-service", "gameplay-service",
              "combat-sessions-service", "combat-abilities-service", "combat-ai-service"],
              "related_documents": [{"id": "combat-analytics-balance-idea", "relation":
              "implements"}, {"id": "combat-shooting-architecture", "relation": "extends"},
              {"id": "combat-ai-enemies-architecture", "relation": "extends"}, {"id":
              "faction-analytics-balance", "relation": "references"}], "github_issue":
              1518, "visibility": "internal", "audience": ["architect", "backend",
              "analytics", "combat", "api-designer"]}, "summary": {"problem": "В проекте
              отсутствует единая система для сбора статистики по всем боевым механикам.\nКаждая
              система (стрельба, способности, AI, паркур) собирает свою телеметрию
              отдельно,\nчто затрудняет анализ баланса навыков и боевых механик. Нет
              централизованного места\nдля запросов статистики и автоматической балансировки
              на основе данных.\n", "goal": "Создать архитектурную схему системы сбора
              статистики и балансировки боевых механик с определением:\n- Микросервисов
              для управления аналитикой боевых систем\n- Компонентов для сбора телеметрии,
              агрегации метрик, анализа баланса\n- API endpoints (высокоуровнево)\n-
              Интеграций с существующими боевыми системами\n- Структуры БД для хранения
              телеметрии и метрик\n- Технического задания для реализации\n", "essence":
              "Система собирает телеметрию от всех боевых систем, агрегирует метрики
              и предоставляет\nинструменты для анализа баланса. Позволяет автоматически
              корректировать параметры\nнавыков и боевых механик на основе реальной
              статистики использования и эффективности.\n"}, "architecture": {"overview":
              "Система состоит из следующих компонентов:\n1. Combat Telemetry Collector
              - сбор событий от всех боевых систем\n2. Combat Metrics Aggregator -
              агрегация метрик по различным измерениям\n3. Combat Balance Analyzer
              - анализ баланса и выявление дисбалансов\n4. Combat Balance Tuner -
              автоматическая корректировка параметров баланса\n5. Combat Analytics
              API - REST API для запросов статистики\n6. Combat Analytics Cache Manager
              - кэширование агрегированных данных\n", "microservices": [{"name": "analytics-service",
              "location": "services/analytics-service", "responsibility": "Расширение
              существующего analytics-service для боевой аналитики:\n- Сбор телеметрии
              от всех боевых систем\n- Агрегация метрик для балансировки\n- Анализ
              баланса и выявление проблем\n- Автоматическая балансировка (опционально)\n-
              API для запросов статистики\n", "components": ["Combat Telemetry Collector",
              "Combat Metrics Aggregator", "Combat Balance Analyzer", "Combat Balance
              Tuner", "Combat Analytics API Gateway", "Combat Analytics Cache Manager"],
              "endpoints": ["GET /api/v1/analytics/combat/overview - общая статистика",
              "GET /api/v1/analytics/combat/metrics - метрики с фильтрами", "GET /api/v1/analytics/combat/trends
              - тренды по времени", "GET /api/v1/analytics/combat/shooting/stats -
              статистика стрельбы", "GET /api/v1/analytics/combat/shooting/ttk - TTK
              метрики", "GET /api/v1/analytics/combat/shooting/weapons - статистика
              по оружию", "GET /api/v1/analytics/combat/abilities/stats - статистика
              способностей", "GET /api/v1/analytics/combat/abilities/usage - использование
              способностей", "GET /api/v1/analytics/combat/abilities/effectiveness
              - эффективность", "GET /api/v1/analytics/combat/implants/stats - статистика
              имплантов", "GET /api/v1/analytics/combat/implants/usage - использование
              имплантов", "GET /api/v1/analytics/combat/combos/stats - статистика
              комбо", "GET /api/v1/analytics/combat/combos/popular - популярные комбо",
              "GET /api/v1/analytics/combat/balance/issues - проблемы баланса", "GET
              /api/v1/analytics/combat/balance/recommendations - рекомендации", "POST
              /api/v1/analytics/combat/balance/apply - применить изменения"]}], "components":
              [{"name": "Combat Telemetry Collector", "location": "analytics-service",
              "responsibility": "Сбор телеметрии от всех боевых систем:\n- Подписка
              на события от боевых систем через Event Bus\n- Сохранение событий в
              БД\n- Валидация и нормализация данных\n- Партиционирование данных по
              времени\n", "methods": ["collectShootingEvent(event)", "collectAbilityEvent(event)",
              "collectImplantEvent(event)", "collectComboEvent(event)", "collectHackingEvent(event)",
              "collectFreerunEvent(event)", "collectAIEvent(event)", "collectSessionEvent(event)",
              "storeTelemetryEvent(event)"]}, {"name": "Combat Metrics Aggregator",
              "location": "analytics-service", "responsibility": "Агрегация метрик
              по различным измерениям:\n- Агрегация по временным измерениям (час,
              день, неделя, месяц)\n- Агрегация по игровым измерениям (режим, зона,
              уровень, класс, лига)\n- Агрегация по боевым измерениям (оружие, способности,
              импланты, комбо)\n- Расчет TTK, DPS, точности, эффективности\n- Кэширование
              агрегированных данных\n", "methods": ["aggregateByTime(metricType, timeBucket,
              filters)", "aggregateByGameDimension(metricType, dimension, filters)",
              "aggregateByCombatDimension(metricType, dimension, filters)", "calculateTTKMetrics(weaponId,
              mode, filters)", "calculateDPSMetrics(abilityId, filters)", "calculateEffectivenessMetrics(skillId,
              filters)", "cacheAggregatedMetrics(metrics)"]}, {"name": "Combat Balance
              Analyzer", "location": "analytics-service", "responsibility": "Анализ
              баланса и выявление дисбалансов:\n- Выявление сверхэффективных навыков\n-
              Выявление слабоэффективных навыков\n- Анализ дисбалансов между классами\n-
              Генерация рекомендаций по балансировке\n- Определение приоритета проблем\n",
              "methods": ["analyzeSkillBalance(skillId, timeRange)", "detectOverpoweredSkills(thresholds)",
              "detectUnderpoweredSkills(thresholds)", "analyzeClassBalance(classId,
              timeRange)", "generateRecommendations(issueId)", "prioritizeIssues(issues)"]},
              {"name": "Combat Balance Tuner", "location": "analytics-service", "responsibility":
              "Автоматическая корректировка параметров баланса:\n- Применение рекомендаций
              (с подтверждением)\n- Режимы работы (ручной/полуавтоматический/автоматический)\n-
              Правила автоматической балансировки\n- Откат изменений при ухудшении
              метрик\n- История изменений баланса\n", "methods": ["applyBalanceChange(change,
              mode)", "validateChange(change)", "rollbackChange(changeId, reason)",
              "monitorChangeImpact(changeId)", "getChangeHistory(skillId)"]}, {"name":
              "Combat Analytics API Gateway", "location": "analytics-service", "responsibility":
              "API Gateway для боевой аналитики:\n- Маршрутизация запросов\n- Агрегация
              данных из разных источников\n- Форматирование ответов\n- Применение
              фильтров\n- Кэширование ответов\n", "methods": ["routeRequest(endpoint,
              parameters)", "aggregateData(sources)", "formatResponse(data, format)",
              "applyFilters(data, filters)", "cacheResponse(endpoint, parameters,
              data)"]}, {"name": "Combat Analytics Cache Manager", "location": "analytics-service",
              "responsibility": "Кэширование агрегированных данных:\n- Кэширование
              метрик\n- Кэширование статистики\n- Кэширование рекомендаций\n- Инвалидация
              кэша при обновлении данных\n", "methods": ["cacheMetrics(metricType,
              filters, data)", "getCachedMetrics(metricType, filters)", "cacheStatistics(endpoint,
              parameters, data)", "invalidateCache(pattern)", "clearExpiredCache()"]}],
              "data_flow": {"telemetry_collection": "1. Боевая система публикует событие
              в Event Bus\n2. Combat Telemetry Collector подписывается на событие\n3.
              Collector валидирует и нормализует данные\n4. Collector сохраняет событие
              в БД (combat_telemetry_events)\n5. Collector публикует событие analytics.combat.telemetry.collected\n",
              "metrics_aggregation": "1. Combat Metrics Aggregator периодически запускается
              (каждый час)\n2. Aggregator читает события из combat_telemetry_events
              за период\n3. Aggregator агрегирует данные по измерениям\n4. Aggregator
              рассчитывает метрики (TTK, DPS, эффективность)\n5. Aggregator сохраняет
              агрегированные данные в combat_metrics_aggregated\n6. Aggregator кэширует
              данные через Cache Manager\n7. Aggregator публикует событие analytics.combat.metrics.aggregated\n",
              "balance_analysis": "1. Combat Balance Analyzer периодически запускается
              (каждый день)\n2. Analyzer читает агрегированные метрики\n3. Analyzer
              анализирует баланс и выявляет проблемы\n4. Analyzer генерирует рекомендации\n5.
              Analyzer сохраняет проблемы в combat_balance_issues\n6. Analyzer публикует
              событие analytics.combat.balance.issue.detected\n", "balance_tuning":
              "1. Баланс-команда или система запрашивает применение изменения\n2.
              Combat Balance Tuner валидирует изменение\n3. Tuner применяет изменение
              (в зависимости от режима)\n4. Tuner сохраняет изменение в combat_balance_changes\n5.
              Tuner публикует событие analytics.combat.balance.change.applied\n6.
              Tuner мониторит влияние изменения\n7. При ухудшении метрик Tuner может
              откатить изменение\n", "api_request": "1. Клиент запрашивает статистику
              через Combat Analytics API Gateway\n2. API Gateway проверяет кэш через
              Cache Manager\n3. Если данных нет: API Gateway запрашивает данные из
              Aggregator\n4. Aggregator читает данные из БД или пересчитывает\n5.
              API Gateway форматирует ответ\n6. API Gateway кэширует ответ\n7. API
              Gateway возвращает данные клиенту\n"}, "integrations": {"with_gameplay_service":
              "- Подписка на события combat.shooting.*\n- Подписка на события combat.ability.*\n-
              Подписка на события combat.combo.*\n- Подписка на события combat.session.*\n",
              "with_combat_ai_service": "- Подписка на события combat.ai.*\n- Получение
              данных о встречах с AI\n", "with_combat_abilities_service": "- Подписка
              на события combat.ability.*\n- Получение данных о способностях\n", "with_combat_sessions_service":
              "- Подписка на события combat.session.*\n- Получение данных о сессиях\n",
              "with_character_service": "- Получение данных о персонажах для фильтрации\n-
              Получение данных о классах и уровнях\n", "with_event_bus": "- Подписка
              на события от всех боевых систем\n- Публикация аналитических событий\n"},
              "event_bus_events": {"published": ["analytics.combat.telemetry.collected",
              "analytics.combat.metrics.aggregated", "analytics.combat.balance.issue.detected",
              "analytics.combat.balance.recommendation.generated", "analytics.combat.balance.change.applied",
              "analytics.combat.balance.change.reverted"], "subscribed": ["combat.shooting.*
              (события стрельбы)", "combat.ability.* (события способностей)", "combat.implant.*
              (события имплантов)", "combat.combo.* (события комбо)", "combat.hacking.*
              (события хакинга)", "combat.freerun.* (события паркура)", "combat.ai.*
              (события AI)", "combat.session.* (события сессий)"]}, "database_schema":
              {"tables": [{"name": "combat_telemetry_events", "description": "Сырые
              события от боевых систем", "fields": [{"id": "UUID (PK)"}, {"event_type":
              "VARCHAR(100) NOT NULL"}, {"system_type": "VARCHAR(50) NOT NULL (shooting,
              ability, implant, combo, hacking, freerun, ai, session)"}, {"character_id":
              "UUID"}, {"session_id": "UUID"}, {"zone_id": "UUID"}, {"mode": "VARCHAR(50)
              (PvE, PvP, Arena)"}, {"data": "JSONB NOT NULL"}, {"timestamp": "TIMESTAMPTZ
              NOT NULL"}], "indexes": ["event_type, system_type, timestamp", "character_id,
              timestamp", "session_id", "timestamp (для партиционирования)"]}, {"name":
              "combat_metrics_aggregated", "description": "Агрегированные метрики",
              "fields": [{"id": "UUID (PK)"}, {"metric_type": "VARCHAR(100) NOT NULL
              (ttk, dps, accuracy, effectiveness, usage)"}, {"metric_name": "VARCHAR(100)
              NOT NULL"}, {"dimension_type": "VARCHAR(50) (time, mode, zone, level,
              class, league, weapon, ability, implant)"}, {"dimension_value": "VARCHAR(100)"},
              {"time_bucket": "TIMESTAMPTZ NOT NULL"}, {"value": "NUMERIC(15,4) NOT
              NULL"}, {"sample_count": "INTEGER NOT NULL"}, {"metadata": "JSONB"},
              {"created_at": "TIMESTAMPTZ NOT NULL DEFAULT NOW()"}], "indexes": ["metric_type,
              metric_name, dimension_type, dimension_value, time_bucket (UNIQUE)",
              "time_bucket", "metric_type, metric_name"]}, {"name": "combat_balance_issues",
              "description": "Выявленные проблемы баланса", "fields": [{"id": "UUID
              (PK)"}, {"issue_type": "VARCHAR(100) NOT NULL (overpowered, underpowered,
              class_imbalance)"}, {"skill_id": "VARCHAR(100)"}, {"severity": "VARCHAR(50)
              (low, medium, high, critical)"}, {"description": "TEXT"}, {"metrics":
              "JSONB"}, {"recommendations": "JSONB"}, {"status": "VARCHAR(50) DEFAULT
              ''open'' (open, in_review, resolved, dismissed)"}, {"created_at": "TIMESTAMPTZ
              NOT NULL DEFAULT NOW()"}, {"resolved_at": "TIMESTAMPTZ"}], "indexes":
              ["status, severity", "skill_id", "issue_type"]}, {"name": "combat_balance_changes",
              "description": "История изменений баланса", "fields": [{"id": "UUID
              (PK)"}, {"skill_id": "VARCHAR(100) NOT NULL"}, {"parameter_name": "VARCHAR(100)
              NOT NULL"}, {"old_value": "NUMERIC(15,4)"}, {"new_value": "NUMERIC(15,4)"},
              {"change_reason": "TEXT"}, {"applied_by": "VARCHAR(100)"}, {"applied_at":
              "TIMESTAMPTZ NOT NULL DEFAULT NOW()"}, {"reverted_at": "TIMESTAMPTZ"},
              {"revert_reason": "TEXT"}], "indexes": ["skill_id, applied_at", "applied_at"]}]},
              "implementation_phases": {"phase_1": {"title": "Базовая инфраструктура",
              "tasks": ["Создание таблиц БД (Liquibase миграции)", "Базовый Combat
              Telemetry Collector", "Подписка на события от основных систем (shooting,
              ability, session)", "Базовое API для запросов статистики (overview,
              metrics)"], "estimated_time": "5-7 дней"}, "phase_2": {"title": "Агрегация
              метрик", "tasks": ["Combat Metrics Aggregator", "Агрегация по временным
              измерениям", "Агрегация по игровым измерениям", "Кэширование агрегированных
              данных", "Расширенное API (shooting, abilities, implants)"], "estimated_time":
              "7-10 дней"}, "phase_3": {"title": "Анализ баланса", "tasks": ["Combat
              Balance Analyzer", "Выявление проблем баланса", "Генерация рекомендаций",
              "API для проблем баланса и рекомендаций", "Базовый дашборд для просмотра
              статистики"], "estimated_time": "7-10 дней"}, "phase_4": {"title": "Автоматическая
              балансировка", "tasks": ["Combat Balance Tuner", "Режимы работы (ручной/полуавтоматический/автоматический)",
              "Правила автоматической балансировки", "Система отката изменений", "Мониторинг
              влияния изменений"], "estimated_time": "10-14 дней"}, "phase_5": {"title":
              "Расширенная аналитика", "tasks": ["ML модели для предсказания баланса
              (опционально)", "A/B тестирование изменений", "Интеграция с дашбордами",
              "Расширенные отчеты"], "estimated_time": "14-21 день"}}, "total_estimated_effort":
              "43-62 дня"}, "diagrams": {"component_diagram": "```mermaid\ngraph TB\n    subgraph
              \"Analytics Service\"\n        CTC[Combat Telemetry Collector]\n        CMA[Combat
              Metrics Aggregator]\n        CBA[Combat Balance Analyzer]\n        CBT[Combat
              Balance Tuner]\n        CAAG[Combat Analytics API Gateway]\n        CACM[Combat
              Analytics Cache Manager]\n    end\n\n    subgraph \"Database\"\n        DB[(PostgreSQL<br/>combat_telemetry_events<br/>combat_metrics_aggregated<br/>combat_balance_issues<br/>combat_balance_changes)]\n    end\n\n    subgraph
              \"Cache\"\n        REDIS[(Redis Cache)]\n    end\n\n    subgraph \"Event
              Bus\"\n        EB[Kafka/Event Bus]\n    end\n\n    subgraph \"Combat
              Systems\"\n        GS[Gameplay Service]\n        CAS[Combat Abilities
              Service]\n        CAIS[Combat AI Service]\n        CSS[Combat Sessions
              Service]\n    end\n\n    subgraph \"External Services\"\n        CS[Character
              Service]\n    end\n\n    CAAG --> CMA\n    CAAG --> CBA\n    CAAG -->
              CBT\n    CAAG --> CACM\n    CMA --> CTC\n    CMA --> CACM\n    CBA -->
              CMA\n    CBT --> CBA\n    CTC --> EB\n    CTC --> DB\n    CMA --> DB\n    CBA
              --> DB\n    CBT --> DB\n    CACM --> REDIS\n    EB --> GS\n    EB -->
              CAS\n    EB --> CAIS\n    EB --> CSS\n    CAAG --> CS\n```\n", "data_flow_diagram":
              "```mermaid\nsequenceDiagram\n    participant CS as Combat System\n    participant
              EB as Event Bus\n    participant CTC as Telemetry Collector\n    participant
              DB as Database\n    participant CMA as Metrics Aggregator\n    participant
              CBA as Balance Analyzer\n    participant CAAG as API Gateway\n    participant
              Client as Client\n\n    CS->>EB: Publish combat event\n    EB->>CTC:
              Subscribe to event\n    CTC->>CTC: Validate & normalize\n    CTC->>DB:
              Store event\n    CTC->>EB: Publish collected event\n\n    Note over
              CMA: Periodic (hourly)\n    CMA->>DB: Read events\n    CMA->>CMA: Aggregate
              metrics\n    CMA->>DB: Store aggregated\n    CMA->>EB: Publish aggregated\n\n    Note
              over CBA: Periodic (daily)\n    CBA->>DB: Read metrics\n    CBA->>CBA:
              Analyze balance\n    CBA->>DB: Store issues\n    CBA->>EB: Publish issue
              detected\n\n    Client->>CAAG: Request statistics\n    CAAG->>CMA: Get
              metrics\n    CMA->>DB: Read aggregated\n    CMA->>CAAG: Return metrics\n    CAAG->>Client:
              Return statistics\n```\n"}}'
        - column:
            name: metadata
            value: '{"id": "combat-analytics-balance-system-architecture", "title":
              "Архитектура системы сбора статистики и балансировки боевых механик",
              "document_type": "architecture", "category": "systems", "status": "draft",
              "version": "1.0.0", "last_updated": "2025-12-XXT00:00:00Z", "owners":
              [{"role": "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "combat", "analytics", "balance", "statistics", "telemetry"], "related_systems":
              ["analytics-service", "gameplay-service", "combat-sessions-service",
              "combat-abilities-service", "combat-ai-service"], "related_documents":
              [{"id": "combat-analytics-balance-idea", "relation": "implements"},
              {"id": "combat-shooting-architecture", "relation": "extends"}, {"id":
              "combat-ai-enemies-architecture", "relation": "extends"}, {"id": "faction-analytics-balance",
              "relation": "references"}], "github_issue": 1518, "visibility": "internal",
              "audience": ["architect", "backend", "analytics", "combat", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\combat-analytics-balance-system-architecture.yaml
