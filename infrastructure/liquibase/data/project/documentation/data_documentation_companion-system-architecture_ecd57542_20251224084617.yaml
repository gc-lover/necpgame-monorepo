databaseChangeLog:
- changeSet:
    id: documentation-companion-system-architecture-ecd57542
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '5604008036566596'
        - column:
            name: doc_id
            value: companion-system-architecture
        - column:
            name: title
            value: Архитектура системы компаньонов
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.1.0
        - column:
            name: last_updated
            value: 2025-11-30 20:45:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - gameplay
            - companions
            - pets
            - drones
            - combat
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - companion-service
            - combat-service
            - inventory-service
            - character-service
            - economy-service
            - realtime-gateway
        - column:
            name: related_documents
            value: '[{"id": "backend-companion-system", "relation": "implements"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - gameplay
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "companion-system-architecture", "title":
              "Архитектура системы компаньонов", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.1.0", "last_updated":
              "2025-11-30T20:45:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "gameplay", "companions",
              "pets", "drones", "combat"], "related_systems": ["companion-service",
              "combat-service", "inventory-service", "character-service", "economy-service",
              "realtime-gateway"], "related_documents": [{"id": "backend-companion-system",
              "relation": "implements"}], "github_issue": 314, "visibility": "internal",
              "audience": ["architect", "backend", "gameplay", "api-designer"]}, "summary":
              {"problem": "Требуется спроектировать полную архитектуру системы компаньонов,
              включающую:\n- Управление боевыми дронами, утилитарными помощниками
              и питомцами\n- Систему призыва/отзыва компаньонов\n- Систему прогрессии
              компаньонов (уровни, опыт, статы)\n- Систему способностей (активные
              и пассивные)\n- Систему кастомизации\n- Интеграции с боёвкой, инвентарем
              и экономикой\n", "goal": "Создать архитектурную схему системы компаньонов
              с определением:\n- Компонентов для управления компаньонами\n- REST,
              WebSocket и Event Bus контрактов\n- Интеграций с другими системами\n-
              Структуры БД\n- Технического задания для реализации\n", "essence": "Полная
              архитектура системы компаньонов с поддержкой призыва, прогрессии,\nспособностей
              и кастомизации.\n"}, "architecture": {"overview": "Архитектура системы
              компаньонов состоит из следующих компонентов:\n1. Companion Manager
              - управление системой компаньонов\n2. Companion Catalog Manager - управление
              каталогом компаньонов\n3. Companion Ownership Manager - управление владением
              компаньонами\n4. Companion Summon Manager - управление призывом/отзывом\n5.
              Companion Progression Manager - управление прогрессией\n6. Companion
              Ability Manager - управление способностями\n7. Companion Customization
              Manager - управление кастомизацией\n8. Companion Stats Calculator -
              расчет статистики компаньонов\n9. Companion Effects Applier - применение
              эффектов компаньонов\n10. Companion Telemetry Collector - сбор телеметрии\n",
              "microservices": [{"name": "companion-service", "port": 8091, "responsibility":
              "Обработка системы компаньонов:\n- Управление системой компаньонов\n-
              Управление каталогом компаньонов\n- Управление владением компаньонами\n-
              Управление призывом/отзывом\n- Управление прогрессией\n- Управление
              способностями\n- Управление кастомизацией\n- Расчет статистики\n- Применение
              эффектов\n- Сбор телеметрии\n", "components": [{"companion-manager":
              "управление системой компаньонов"}, {"companion-catalog-manager": "управление
              каталогом компаньонов"}, {"companion-ownership-manager": "управление
              владением компаньонами"}, {"companion-summon-manager": "управление призывом/отзывом"},
              {"companion-progression-manager": "управление прогрессией"}, {"companion-ability-manager":
              "управление способностями"}, {"companion-customization-manager": "управление
              кастомизацией"}, {"companion-stats-calculator": "расчет статистики компаньонов"},
              {"companion-effects-applier": "применение эффектов компаньонов"}, {"companion-telemetry-collector":
              "сбор телеметрии"}], "endpoints": ["GET /api/v1/companion/catalog -
              каталог доступных компаньонов", "GET /api/v1/companion/catalog/{companionTypeId}
              - информация о типе компаньона", "POST /api/v1/companion/purchase -
              покупка компаньона", "GET /api/v1/companion/{characterId}/companions
              - список компаньонов персонажа", "GET /api/v1/companion/{characterId}/companions/{companionId}
              - информация о компаньоне", "POST /api/v1/companion/{characterId}/companions/{companionId}/summon
              - призыв компаньона", "POST /api/v1/companion/{characterId}/companions/{companionId}/dismiss
              - отзыв компаньона", "GET /api/v1/companion/{characterId}/active - активный
              компаньон", "POST /api/v1/companion/{characterId}/companions/{companionId}/rename
              - переименование компаньона", "GET /api/v1/companion/{characterId}/companions/{companionId}/stats
              - статистика компаньона", "POST /api/v1/companion/{characterId}/companions/{companionId}/abilities/{abilityId}/activate
              - активация способности", "GET /api/v1/companion/{characterId}/companions/{companionId}/abilities
              - список способностей", "POST /api/v1/companion/{characterId}/companions/{companionId}/customize
              - кастомизация компаньона", "GET /api/v1/companion/{characterId}/companions/{companionId}/progression
              - прогрессия компаньона"], "websocket_channels": ["wss://api.necp.game/v1/companion/{characterId}
              - поток обновлений компаньонов персонажа"], "events_published": [{"companion.purchased":
              "куплен компаньон"}, {"companion.summoned": "призван компаньон"}, {"companion.dismissed":
              "отозван компаньон"}, {"companion.level-up": "повышение уровня компаньона"},
              {"companion.ability-activated": "активирована способность"}, {"companion.customized":
              "кастомизирован компаньон"}, {"companion.stats-updated": "обновлена
              статистика"}, {"companion.effects-applied": "применены эффекты"}], "events_subscribed":
              [{"character.created": "создан персонаж"}, {"character.level-up": "повышение
              уровня персонажа"}, {"combat.enemy-killed": "убийство врага"}, {"quest.completed":
              "завершение квеста"}, {"economy.transaction": "транзакция в экономике"},
              {"inventory.item-added": "добавлен предмет в инвентарь"}]}], "companion_types":
              [{"name": "combat_drone", "description": "Боевые дроны - атакующие,
              поддерживающие и разведывательные", "categories": [{"attack": "атакующие
              дроны"}, {"support": "поддерживающие дроны"}, {"recon": "разведывательные
              дроны"}], "stats": [{"health": "здоровье"}, {"damage": "урон"}, {"armor":
              "броня"}, {"speed": "скорость"}, {"range": "дальность атаки"}]}, {"name":
              "utility", "description": "Утилитарные помощники - сбор лута, хакерство,
              крафт", "categories": [{"loot_collector": "сборщик лута"}, {"hacking_assistant":
              "помощник по хакерству"}, {"crafting_bot": "бот для крафта"}], "stats":
              [{"efficiency": "эффективность"}, {"speed": "скорость работы"}, {"capacity":
              "вместимость"}]}, {"name": "social_pet", "description": "Социальные
              питомцы - кошки, собаки, дрон-птицы", "categories": [{"cat": "кошка"},
              {"dog": "собака"}, {"drone_bird": "дрон-птица"}], "stats": [{"happiness":
              "счастье"}, {"loyalty": "лояльность"}, {"social_bonus": "социальный
              бонус"}]}], "summon_system": {"process": [{"ownership_check": "проверка
              владения компаньоном"}, {"active_companion_dismiss": "отзыв активного
              компаньона (если есть)"}, {"summon_validation": "валидация призыва (зона,
              условия)"}, {"companion_spawn": "спавн компаньона в мире"}, {"effects_application":
              "применение эффектов компаньона"}, {"status_update": "обновление статуса
              призыва"}], "restrictions": [{"zone_restrictions": "ограничения по зонам"},
              {"cooldown": "кулдаун между призывами"}, {"max_active": "максимум активных
              компаньонов (обычно 1)"}, {"level_requirements": "требования по уровню"}]},
              "progression_system": {"levels": [{"max_level": 50}, {"xp_per_level":
              "опыт для повышения уровня"}, {"stat_growth": "рост статистики за уровень"}],
              "xp_sources": [{"combat": "участие в бою"}, {"quests": "выполнение квестов"},
              {"activities": "активности с компаньоном"}], "stat_improvements": [{"health":
              "улучшение здоровья"}, {"damage": "улучшение урона"}, {"efficiency":
              "улучшение эффективности"}, {"happiness": "улучшение счастья"}]}, "abilities":
              {"active_abilities": [{"attack_command": "команда атаки"}, {"defensive_mode":
              "оборонительный режим"}, {"support_heal": "лечение поддержки"}, {"recon_scan":
              "разведывательное сканирование"}, {"loot_collect": "сбор лута"}, {"hack_assist":
              "помощь в хакерстве"}], "passive_abilities": [{"auto_collect": "автоматический
              сбор"}, {"combat_assistance": "боевая помощь"}, {"stat_bonus": "бонус
              к статистике"}, {"social_bonus": "социальный бонус"}], "cooldowns":
              [{"ability_cooldown": "кулдаун способности"}, {"global_cooldown": "глобальный
              кулдаун"}], "effects": [{"damage": "урон"}, {"heal": "лечение"}, {"buff":
              "бафф"}, {"debuff": "дебафф"}, {"utility": "утилитарный эффект"}]},
              "customization": {"options": [{"name": "имя компаньона"}, {"appearance":
              "внешний вид"}, {"colors": "цвета"}, {"accessories": "аксессуары"},
              {"skins": "скины"}], "restrictions": [{"ownership": "требуется владение"},
              {"level": "требования по уровню"}, {"currency": "требуется валюта"}]},
              "data_flows": {"purchase_flow": "1. Игрок запрашивает покупку компаньона\n2.
              Companion Catalog Manager проверяет доступность\n3. Economy Service
              проверяет баланс\n4. Economy Service списывает валюту\n5. Companion
              Ownership Manager создает запись владения\n6. Companion Service публикует
              событие companion.purchased\n7. Realtime Gateway отправляет обновление
              клиенту\n", "summon_flow": "1. Игрок запрашивает призыв компаньона\n2.
              Companion Summon Manager проверяет владение\n3. Companion Summon Manager
              отзывает активного компаньона (если есть)\n4. Companion Summon Manager
              проверяет ограничения зоны\n5. Companion Summon Manager спавнит компаньона
              в мире\n6. Companion Effects Applier применяет эффекты\n7. Companion
              Service публикует событие companion.summoned\n8. Realtime Gateway отправляет
              обновление клиенту\n", "progression_flow": "1. Компаньон получает опыт
              (бой, квест, активность)\n2. Companion Progression Manager проверяет
              достаточность опыта\n3. Companion Progression Manager повышает уровень\n4.
              Companion Stats Calculator пересчитывает статистику\n5. Companion Effects
              Applier обновляет эффекты\n6. Companion Service публикует событие companion.level-up\n7.
              Realtime Gateway отправляет обновление клиенту\n", "ability_activation_flow":
              "1. Игрок активирует способность компаньона\n2. Companion Ability Manager
              проверяет доступность\n3. Companion Ability Manager проверяет кулдаун\n4.
              Companion Ability Manager активирует способность\n5. Companion Effects
              Applier применяет эффекты способности\n6. Companion Service публикует
              событие companion.ability-activated\n7. Realtime Gateway отправляет
              обновление клиенту\n"}, "data_consistency": {"strategy": "Strong Consistency
              (ACID транзакции) для критичных операций (покупка, призыв, прогрессия)",
              "mechanisms": ["ACID транзакции для покупки компаньонов, призыва/отзыва,
              прогрессии и активации способностей", "Оптимистичные блокировки (versioning)
              для предотвращения конфликтов при обновлении статистики", "Валидация
              перед покупкой компаньона, призывом и активацией способностей", "Синхронизация
              с другими сервисами через Event Bus", "Outbox Pattern для гарантированной
              доставки событий", "Saga Pattern для распределенных операций (покупка
              компаньона, призыв, применение эффектов)"]}, "data_synchronization":
              {"event_sourcing": "Все изменения состояния компаньонов (покупка, призыв,
              отзыв, прогрессия, активация способностей,\nкастомизация, применение
              эффектов) записываются как события в Event Store.\nЭто обеспечивает
              полный аудит, возможность восстановления состояния и \"time travel\"
              для отладки.\nПримеры событий: CompanionPurchasedEvent, CompanionSummonedEvent,
              CompanionDismissedEvent, CompanionLevelUpEvent, CompanionAbilityActivatedEvent,
              CompanionCustomizedEvent.\n", "cqrs_pattern": "Разделение команд (покупка
              компаньона, призыв, активация способностей, кастомизация) и запросов\n(получение
              каталога, получение списка компаньонов, получение статистики) для оптимизации
              производительности\nи масштабируемости. Read-модели могут быть кэшированы
              в Redis для быстрых запросов.\n", "saga_pattern": "Для распределенных
              транзакций, таких как покупка компаньона (проверка баланса, списание
              валюты,\nсоздание записи владения, уведомление игрока) или призыв компаньона
              (проверка владения, отзыв активного,\nспавн в мире, применение эффектов,
              уведомление игрока), используется Saga Pattern\nдля обеспечения атомарности
              операций между Companion Service, Economy Service, World Service, Combat
              Service и Notification Service.\n", "outbox_pattern": "Для гарантированной
              доставки событий в Event Bus используется Outbox Pattern,\nкоторый записывает
              события в транзакционную таблицу перед публикацией.\n"}, "tickrate_specification":
              {"companion_operations": {"tickrate": "Event-based (on-demand)", "network_load":
              "- Покупка компаньона: event-based, ~0.001-0.01 events/sec на игрока\n-
              Получение каталога: event-based, ~0.01-0.02 requests/sec на игрока\n-
              Получение списка компаньонов: event-based, ~0.01-0.05 requests/sec на
              игрока\n- Общий трафик: ~0.1-0.3 KB/sec на игрока для операций компаньонов\n",
              "latency_requirements": "< 200-300ms для покупки компаньона, < 30-100ms
              для получения каталога", "sync_strategy": "Strong Consistency (ACID
              транзакции) для покупки компаньонов"}, "summon_operations": {"tickrate":
              "Event-based (on-demand)", "network_load": "- Призыв компаньона: event-based,
              ~0.01-0.05 events/sec на игрока\n- Отзыв компаньона: event-based, ~0.01-0.05
              events/sec на игрока\n- Получение активного компаньона: event-based,
              ~0.01-0.05 requests/sec на игрока\n- Общий трафик: ~0.2-0.5 KB/sec на
              игрока для операций призыва\n", "latency_requirements": "< 100-200ms
              для призыва/отзыва компаньона, < 30-100ms для получения активного",
              "sync_strategy": "Strong Consistency (ACID транзакции) для призыва/отзыва"},
              "progression_operations": {"tickrate": "Event-based (on-demand при получении
              опыта) + 1-5 Hz для обновления статистики", "network_load": "- Получение
              опыта: event-based, ~0.01-0.1 events/sec на игрока\n- Повышение уровня:
              event-based, ~0.001-0.01 events/sec на игрока\n- Получение прогрессии:
              event-based, ~0.01-0.02 requests/sec на игрока\n- Общий трафик: ~0.1-0.3
              KB/sec на игрока для операций прогрессии\n", "latency_requirements":
              "< 50-100ms для получения опыта, < 30-100ms для получения прогрессии",
              "sync_strategy": "Strong Consistency (ACID транзакции) для прогрессии"},
              "ability_operations": {"tickrate": "Event-based (on-demand)", "network_load":
              "- Активация способности: event-based, ~0.01-0.1 events/sec на игрока\n-
              Получение списка способностей: event-based, ~0.01-0.02 requests/sec
              на игрока\n- Обновление кулдаунов: event-based + 1-5 Hz, ~0.01-0.05
              events/sec на игрока\n- Общий трафик: ~0.2-0.5 KB/sec на игрока для
              операций способностей\n", "latency_requirements": "< 50-100ms для активации
              способности, < 30-100ms для получения списка", "sync_strategy": "Strong
              Consistency (ACID транзакции) для активации способностей"}, "customization_operations":
              {"tickrate": "Event-based (on-demand)", "network_load": "- Кастомизация
              компаньона: event-based, ~0.001-0.01 events/sec на игрока\n- Переименование:
              event-based, ~0.001-0.01 events/sec на игрока\n- Получение кастомизации:
              event-based, ~0.01-0.02 requests/sec на игрока\n- Общий трафик: ~0.1-0.3
              KB/sec на игрока для операций кастомизации\n", "latency_requirements":
              "< 100-200ms для кастомизации, < 30-100ms для получения кастомизации",
              "sync_strategy": "Strong Consistency (ACID транзакции) для кастомизации"},
              "stats_operations": {"tickrate": "Event-based (on-demand при изменении)
              + 1-5 Hz для обновления статистики", "network_load": "- Расчет статистики:
              event-based, ~0.01-0.05 events/sec на игрока\n- Получение статистики:
              event-based, ~0.01-0.05 requests/sec на игрока\n- Обновление статистики:
              1-5 Hz, ~0.01-0.05 events/sec на игрока\n- Общий трафик: ~0.1-0.3 KB/sec
              на игрока для операций статистики\n", "latency_requirements": "< 50-100ms
              для расчета статистики, < 30-100ms для получения статистики", "sync_strategy":
              "Strong Consistency (ACID транзакции) для расчета статистики"}, "effects_operations":
              {"tickrate": "Event-based (on-demand при призыве/отзыве/активации способностей)
              + 20-60 Hz для активных эффектов в бою", "network_load": "- Применение
              эффектов: event-based, ~0.01-0.05 events/sec на игрока\n- Обновление
              эффектов в бою: 20-60 Hz, ~0.5-2 KB/sec на игрока\n- Получение эффектов:
              event-based, ~0.01-0.02 requests/sec на игрока\n- Общий трафик: ~0.2-0.5
              KB/sec на игрока для операций эффектов (без боя), ~0.5-2 KB/sec в бою\n",
              "latency_requirements": "< 50-100ms для применения эффектов, < 10-50ms
              для обновления эффектов в бою", "sync_strategy": "Strong Consistency
              (ACID транзакции) для применения эффектов, Eventual Consistency для
              обновлений в бою"}, "event_handling": {"tickrate": "Event-based (on-demand)",
              "network_load": "- Публикация событий компаньонов: event-based, ~0.1-0.5
              events/sec\n- Подписка на события: event-based, ~0.05-0.2 events/sec\n-
              Общий трафик: ~0.2-0.7 KB/sec для событий\n", "latency_requirements":
              "< 100-300ms для публикации событий", "sync_strategy": "Eventual Consistency
              для событий (через Event Bus)"}}, "database_structure": {"tables": [{"name":
              "companion_types", "description": "Типы компаньонов", "columns": [{"id":
              "UUID PRIMARY KEY"}, {"code": "VARCHAR(50) UNIQUE"}, {"name": "VARCHAR(255)"},
              {"category": "ENUM (combat_drone, utility, social_pet)"}, {"subcategory":
              "VARCHAR(50)"}, {"description": "TEXT"}, {"base_stats": "JSONB"}, {"abilities":
              "JSONB"}, {"cost": "JSONB"}, {"requirements": "JSONB"}, {"created_at":
              "TIMESTAMP"}, {"updated_at": "TIMESTAMP"}]}, {"name": "player_companions",
              "description": "Компаньоны игроков", "columns": [{"id": "UUID PRIMARY
              KEY"}, {"character_id": "UUID FOREIGN KEY"}]}]}}}'
        - column:
            name: metadata
            value: '{"id": "companion-system-architecture", "title": "Архитектура
              системы компаньонов", "document_type": "architecture", "category": "systems",
              "status": "draft", "version": "1.1.0", "last_updated": "2025-11-30T20:45:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "gameplay", "companions", "pets", "drones",
              "combat"], "related_systems": ["companion-service", "combat-service",
              "inventory-service", "character-service", "economy-service", "realtime-gateway"],
              "related_documents": [{"id": "backend-companion-system", "relation":
              "implements"}], "github_issue": 314, "visibility": "internal", "audience":
              ["architect", "backend", "gameplay", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\companion-system-architecture.yaml
