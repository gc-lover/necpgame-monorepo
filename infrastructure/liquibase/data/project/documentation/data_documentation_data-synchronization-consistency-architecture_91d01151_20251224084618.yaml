databaseChangeLog:
- changeSet:
    id: documentation-data-synchronization-consistency-architecture-91d01151
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '3353493726981285'
        - column:
            name: doc_id
            value: data-synchronization-consistency-architecture
        - column:
            name: title
            value: Архитектура синхронизации данных и консистентности
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-29 12:30:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - data-synchronization
            - consistency
            - infrastructure
            - microservices
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - character-service-go
            - inventory-service-go
            - world-service-go
            - realtime-gateway-go
            - event-bus
        - column:
            name: related_documents
            value: '[{"id": "data-synchronization-consistency-guide", "relation":
              "implements"}, {"id": "realtime-server-system-architecture", "relation":
              "extends"}, {"id": "global-state-system-architecture", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - infrastructure
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "data-synchronization-consistency-architecture",
              "title": "Архитектура синхронизации данных и консистентности", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-11-29T12:30:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "data-synchronization", "consistency", "infrastructure", "microservices"],
              "related_systems": ["character-service-go", "inventory-service-go",
              "world-service-go", "realtime-gateway-go", "event-bus"], "related_documents":
              [{"id": "data-synchronization-consistency-guide", "relation": "implements"},
              {"id": "realtime-server-system-architecture", "relation": "extends"},
              {"id": "global-state-system-architecture", "relation": "extends"}],
              "github_issue": 1521, "visibility": "internal", "audience": ["architect",
              "backend", "infrastructure", "api-designer"]}, "summary": {"problem":
              "Требуется спроектировать архитектуру синхронизации данных между различными
              слоями\n(клиент, сервер, база данных) и механиками игры (инвентарь,
              персонаж, квесты, боевая система)\nдля обеспечения консистентности данных
              в распределенной микросервисной архитектуре.\n", "goal": "Создать архитектурную
              схему системы синхронизации данных с определением:\n- Компонентов для
              синхронизации между слоями и механиками\n- Паттернов синхронизации (Event
              Bus, Outbox, Saga)\n- Стратегий консистентности (Strong vs Eventual)\n-
              Механизмов разрешения конфликтов\n- Интеграций с существующими системами\n-
              Структуры БД для синхронизации\n- Технического задания для реализации\n",
              "essence": "Комплексная архитектура синхронизации данных с использованием
              событийной архитектуры,\nпаттернов распределенных систем и стратегий
              консистентности для MMORPG.\n"}, "architecture": {"overview": "Архитектура
              синхронизации данных состоит из следующих компонентов:\n1. Event Bus
              Manager - управление Event Bus (Kafka)\n2. Outbox Pattern Processor
              - гарантированная доставка событий\n3. Saga Orchestrator - координация
              распределенных транзакций\n4. State Synchronization Manager - синхронизация
              состояния между сервисами\n5. Conflict Resolution Engine - разрешение
              конфликтов\n6. Consistency Monitor - мониторинг консистентности\n7.
              Data Validation Service - валидация данных\n8. Sync Analytics Collector
              - сбор аналитики синхронизации\n", "microservices": [{"name": "sync-service",
              "port": 8090, "responsibility": "Центральный сервис для синхронизации
              данных:\n- Управление Event Bus\n- Обработка Outbox Pattern\n- Оркестрация
              Saga транзакций\n- Синхронизация состояния\n- Разрешение конфликтов\n-
              Мониторинг консистентности\n", "components": [{"event-bus-manager":
              "управление Event Bus"}, {"outbox-processor": "обработка Outbox Pattern"},
              {"saga-orchestrator": "оркестрация Saga транзакций"}, {"state-sync-manager":
              "синхронизация состояния"}, {"conflict-resolver": "разрешение конфликтов"},
              {"consistency-monitor": "мониторинг консистентности"}, {"data-validator":
              "валидация данных"}, {"sync-analytics": "сбор аналитики"}]}], "components":
              [{"name": "Event Bus Manager", "location": "sync-service", "responsibility":
              "Управление Event Bus (Kafka):\n- Создание и управление топиками\n-
              Публикация событий\n- Подписка на события\n- Гарантия доставки (at-least-once,
              exactly-once)\n- Управление партициями\n- Мониторинг производительности\n",
              "events_categories": [{"character.*": "события персонажа"}, {"inventory.*":
              "события инвентаря"}, {"quest.*": "события квестов"}, {"combat.*": "события
              боевой системы"}, {"economy.*": "события экономики"}, {"world.*": "события
              мира"}]}, {"name": "Outbox Pattern Processor", "location": "sync-service",
              "responsibility": "Гарантированная доставка событий из транзакций:\n-
              Чтение событий из таблицы Outbox\n- Публикация в Event Bus\n- Удаление
              обработанных событий\n- Retry при ошибках\n- Дедупликация событий\n",
              "flow": "1. Сервис выполняет транзакцию и записывает событие в Outbox\n2.
              Outbox Processor читает событие из Outbox\n3. Outbox Processor публикует
              событие в Event Bus\n4. После успешной публикации событие удаляется
              из Outbox\n"}, {"name": "Saga Orchestrator", "location": "sync-service",
              "responsibility": "Оркестрация распределенных транзакций:\n- Определение
              шагов Saga\n- Выполнение шагов последовательно\n- Компенсация при ошибках\n-
              Отслеживание состояния Saga\n- Retry и rollback\n", "saga_types": [{"choreography":
              "каждый сервис знает следующий шаг"}, {"orchestration": "центральный
              координатор управляет процессом"}], "example_saga": "Покупка предмета:\n1.
              InventoryService: резервирование слота\n2. CharacterService: проверка
              денег\n3. CharacterService: списание денег\n4. InventoryService: добавление
              предмета\n5. При ошибке → компенсирующие транзакции\n"}, {"name": "State
              Synchronization Manager", "location": "sync-service", "responsibility":
              "Синхронизация состояния между сервисами:\n- Server-wide синхронизация
              (мировые данные)\n- Player-specific синхронизация (персональные данные)\n-
              Phased синхронизация (сюжетные фазы)\n- Redis pub/sub для realtime обновлений\n-
              WebSocket каналы для клиентов\n- Инвалидация кэша\n", "sync_strategies":
              [{"strong_consistency": "для критичных данных"}, {"eventual_consistency":
              "для некритичных данных"}, {"hybrid": "комбинация стратегий"}]}, {"name":
              "Conflict Resolution Engine", "location": "sync-service", "responsibility":
              "Разрешение конфликтов при одновременных изменениях:\n- Last Write Wins
              (LWW) для некритичных данных\n- Vector Clocks для распределенных систем\n-
              Operational Transformation (OT) для совместного редактирования\n- CRDT
              для автоматического разрешения конфликтов\n- Voting для критичных изменений\n",
              "conflict_types": [{"timestamp_conflict": "конфликт по времени"}, {"version_conflict":
              "конфликт версий"}, {"data_conflict": "конфликт данных"}]}, {"name":
              "Consistency Monitor", "location": "sync-service", "responsibility":
              "Мониторинг консистентности данных:\n- Отслеживание времени синхронизации\n-
              Обнаружение неконсистентных данных\n- Метрики консистентности\n- Алерты
              при проблемах\n- Валидация данных между сервисами\n"}, {"name": "Data
              Validation Service", "location": "sync-service", "responsibility": "Валидация
              данных при синхронизации:\n- Референсная целостность (foreign keys)\n-
              Бизнес-правила\n- Согласованность между сервисами\n- Проверка версий
              данных\n- Валидация событий\n"}], "consistency_strategies": {"strong_consistency":
              {"application": "Критичные данные, требующие мгновенной консистентности:\n-
              Инвентарь (предметы, слоты)\n- Деньги (валюта, баланс)\n- Персонаж (статы,
              уровни)\n- Квесты (прогресс, награды)\n", "implementation": "- ACID
              транзакции (PostgreSQL)\n- Pessimistic locking для торговли\n- Optimistic
              locking для обновлений\n- Ссылочная целостность (foreign keys)\n- Уровни
              изоляции транзакций\n"}, "eventual_consistency": {"application": "Некритичные
              данные, где допустимы временные несоответствия:\n- Статистика игроков\n-
              Логи активности\n- Аналитика\n- Кэшируемые данные\n", "implementation":
              "- Асинхронная обработка через Event Bus\n- Event Sourcing для аудита\n-
              CQRS для чтения\n- Redis для кэширования\n"}}, "tickrate_and_network_requirements":
              {"overview": "Требования к тикрейту и сетевой нагрузке для синхронизации
              данных между механиками.\nРазные механики требуют разной частоты обновлений
              и пропускной способности.\n", "combat_mechanics": {"tickrate": "60-128
              Hz", "network_load": "- Позиции персонажей: 60-128 updates/sec\n- Боевые
              события (урон, лечение): event-based, до 100 events/sec\n- Состояние
              здоровья: 60-128 updates/sec\n- Способности: event-based, до 50 events/sec\n-
              Общий трафик: ~10-20 KB/sec на игрока\n", "sync_strategy": "Strong Consistency
              для урона/здоровья, Eventual для статистики"}, "inventory_mechanics":
              {"tickrate": "Event-based (on-demand)", "network_load": "- Изменения
              инвентаря: event-based, ~5-10 events/sec\n- Синхронизация состояния:
              при изменении, ~1-2 updates/sec\n- Общий трафик: ~0.5-1 KB/sec на игрока\n",
              "sync_strategy": "Strong Consistency (ACID транзакции)"}, "economy_mechanics":
              {"tickrate": "Event-based (on-demand)", "network_load": "- Транзакции:
              event-based, ~2-5 events/sec\n- Обновление баланса: при транзакции,
              ~1-2 updates/sec\n- Торговля: event-based, ~1-3 events/sec\n- Общий
              трафик: ~0.3-0.5 KB/sec на игрока\n", "sync_strategy": "Strong Consistency
              (Saga Pattern для распределенных транзакций)"}, "quest_mechanics": {"tickrate":
              "Event-based (on-demand)", "network_load": "- Прогресс квестов: event-based,
              ~1-2 events/sec\n- Завершение квестов: event-based, ~0.1-0.5 events/sec\n-
              Обновление состояния: при изменении, ~0.5-1 updates/sec\n- Общий трафик:
              ~0.2-0.4 KB/sec на игрока\n", "sync_strategy": "Strong Consistency для
              прогресса, Eventual для статистики"}, "world_mechanics": {"tickrate":
              "20-30 Hz", "network_load": "- Позиции NPC: 20-30 updates/sec\n- Мировые
              события: event-based, ~5-10 events/sec\n- Состояние мира: 1-5 updates/sec\n-
              Общий трафик: ~2-5 KB/sec на зону\n", "sync_strategy": "Hybrid (Strong
              для критичных, Eventual для некритичных)"}, "social_mechanics": {"tickrate":
              "Event-based (on-demand)", "network_load": "- Сообщения чата: event-based,
              ~10-50 events/sec\n- Друзья/гильдии: event-based, ~0.1-1 events/sec\n-
              Обновления статуса: event-based, ~1-2 events/sec\n- Общий трафик: ~1-3
              KB/sec на игрока\n", "sync_strategy": "Eventual Consistency (не критично)"},
              "event_bus_load": {"kafka_throughput": "- Character events: ~1000-5000
              events/sec (все игроки)\n- Inventory events: ~500-2000 events/sec\n-
              Combat events: ~2000-10000 events/sec (пиковая нагрузка)\n- Economy
              events: ~200-1000 events/sec\n- Quest events: ~100-500 events/sec\n-
              World events: ~500-2000 events/sec\n- Общая нагрузка: ~5000-20000 events/sec
              (пиковая)\n", "kafka_partitions": "- По сервисам: character-events (10
              партиций), inventory-events (5 партиций)\n- По игрокам: sharding по
              character_id для балансировки\n- Retry топики: отдельные партиции для
              failed events\n"}, "outbox_processing": {"tickrate": "10-20 Hz (polling)",
              "network_load": "- Чтение из Outbox: 10-20 polls/sec на сервис\n- Публикация
              в Kafka: batch до 100 events за раз\n- Общий трафик: зависит от количества
              событий\n", "sync_strategy": "Guaranteed delivery через Outbox Pattern"}},
              "synchronization_patterns": {"event_bus": {"description": "Централизованная
              шина событий для обмена сообщениями", "implementation": "Kafka", "guarantees":
              "at-least-once delivery", "topics": ["character-events", "inventory-events",
              "quest-events", "combat-events", "economy-events", "world-events"]},
              "outbox_pattern": {"description": "Гарантированная доставка событий
              из транзакций", "implementation": "Таблица Outbox в каждой БД сервиса:\n-
              event_id (UUID)\n- event_type (string)\n- payload (JSONB)\n- created_at
              (timestamp)\n- processed_at (timestamp)\n- status (pending, processed,
              failed)\n"}, "saga_pattern": {"description": "Управление распределенными
              транзакциями", "implementation": "Orchestration-based Saga:\n- Центральный
              координатор (Saga Orchestrator)\n- Шаги Saga с компенсацией\n- Отслеживание
              состояния\n- Retry и rollback\n"}, "idempotency": {"description": "Идемпотентность
              операций", "implementation": "- Уникальные ID для операций\n- Проверка
              выполнения перед повторным выполнением\n- Кэширование результатов\n"}},
              "api_endpoints": {"event_bus": ["POST /api/v1/sync/events/publish -
              публикация события", "GET /api/v1/sync/events/{event_id} - получение
              события", "GET /api/v1/sync/events - список событий с фильтрацией"],
              "outbox": ["GET /api/v1/sync/outbox/pending - список ожидающих событий",
              "POST /api/v1/sync/outbox/{event_id}/retry - повторная обработка", "GET
              /api/v1/sync/outbox/stats - статистика Outbox"], "saga": ["POST /api/v1/sync/saga/start
              - запуск Saga", "GET /api/v1/sync/saga/{saga_id} - состояние Saga",
              "POST /api/v1/sync/saga/{saga_id}/compensate - компенсация"], "state_sync":
              ["POST /api/v1/sync/state/sync - синхронизация состояния", "GET /api/v1/sync/state/{key}
              - получение состояния", "POST /api/v1/sync/state/batch - пакетная синхронизация"],
              "conflict_resolution": ["POST /api/v1/sync/conflicts/resolve - разрешение
              конфликта", "GET /api/v1/sync/conflicts - список конфликтов", "POST
              /api/v1/sync/conflicts/{conflict_id}/resolve - разрешение"], "consistency":
              ["GET /api/v1/sync/consistency/check - проверка консистентности", "GET
              /api/v1/sync/consistency/metrics - метрики консистентности", "POST /api/v1/sync/consistency/fix
              - исправление неконсистентности"]}, "websocket_channels": ["wss://api.necp.game/v1/sync/state/{sessionId}
              - поток синхронизации состояния", "wss://api.necp.game/v1/sync/events/{sessionId}
              - поток событий", "wss://api.necp.game/v1/sync/conflicts/{sessionId}
              - поток конфликтов"], "event_bus_events": {"published": [{"sync.state.updated":
              "обновление состояния"}, {"sync.conflict.detected": "обнаружение конфликта"},
              {"sync.conflict.resolved": "разрешение конфликта"}, {"sync.consistency.violation":
              "нарушение консистентности"}, {"sync.saga.started": "запуск Saga"},
              {"sync.saga.completed": "завершение Saga"}, {"sync.saga.failed": "ошибка
              Saga"}, {"sync.outbox.processed": "обработка Outbox события"}], "subscribed":
              [{"character.*": "события персонажа"}, {"inventory.*": "события инвентаря"},
              {"quest.*": "события квестов"}, {"combat.*": "события боевой системы"},
              {"economy.*": "события экономики"}, {"world.*": "события мира"}]}, "data_flows":
              {"client_server_sync": "1. Клиент отправляет действие через WebSocket\n2.
              Realtime Gateway валидирует действие\n3. Realtime Gateway отправляет
              в Gameplay Service\n4. Gameplay Service обрабатывает действие\n5. Gameplay
              Service записывает событие в Outbox\n6. Outbox Processor публикует событие
              в Event Bus\n7. Сервисы-подписчики получают событие\n8. Realtime Gateway
              получает обновление состояния\n9. Realtime Gateway отправляет обновление
              клиенту\n", "inter_service_sync": "1. Сервис A выполняет транзакцию\n2.
              Сервис A записывает событие в Outbox\n3. Outbox Processor публикует
              событие в Event Bus\n4. Сервис B подписан на событие\n5. Сервис B обрабатывает
              событие\n6. Сервис B обновляет свое состояние\n7. Сервис B может опубликовать
              новое событие\n", "saga_execution": "1. Saga Orchestrator запускает
              Saga\n2. Saga Orchestrator выполняет шаг 1 (Сервис A)\n3. Если успешно
              → шаг 2 (Сервис B)\n4. Если ошибка → компенсирующие транзакции\n5. После
              всех шагов → Saga завершена\n"}, "database_structure": {"outbox_table":
              "CREATE TABLE outbox (\n  event_id UUID PRIMARY KEY,\n  event_type VARCHAR(255)
              NOT NULL,\n  payload JSONB NOT NULL,\n  created_at TIMESTAMP NOT NULL
              DEFAULT NOW(),\n  processed_at TIMESTAMP,\n  status VARCHAR(50) NOT
              NULL DEFAULT ''pending'',\n  retry_count INT DEFAULT 0,\n  error_message
              TEXT\n);\n", "saga_table": "CREATE TABLE saga (\n  saga_id UUID PRIMARY
              KEY,\n  saga_type VARCHAR(255) NOT NULL,\n  status VARCHAR(50) NOT NULL,\n  current_step
              INT NOT NULL,\n  steps JSONB NOT NULL,\n  created_at TIMESTAMP NOT NULL
              DEFAULT NOW(),\n  updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n",
              "sync_state_table": "CREATE TABLE sync_state (\n  key VARCHAR(255) PRIMARY
              KEY,\n  category VARCHAR(100) NOT NULL,\n  value JSONB NOT NULL,\n  version
              INT NOT NULL,\n  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),\n  updated_by
              UUID\n);\n", "conflict_table": "CREATE TABLE conflicts (\n  conflict_id
              UUID PRIMARY KEY,\n  key VARCHAR(255) NOT NULL,\n  conflict_type VARCHAR(100)
              NOT NULL,\n  old_value JSONB,\n  new_value JSONB,\n  detected_at TIMESTAMP
              NOT NULL DEFAULT NOW(),\n  resolved_at TIMESTAMP,\n  resolution_strategy
              VARCHAR(100)\n);\n", "consistency_check_table": "CREATE TABLE consistency_checks
              (\n  check_id UUID PRIMARY KEY,\n  service_name VARCHAR(255) NOT NULL,\n  check_type
              VARCHAR(100) NOT NULL,\n  status VARCHAR(50) NOT NULL,\n  violations
              JSONB,\n  checked_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n"}, "integrations":
              [{"service": "character-service-go", "integration": "- Подписка на события
              персонажа\n- Публикация событий изменений персонажа\n- Использование
              Outbox Pattern\n- Участие в Saga транзакциях\n"}, {"service": "inventory-service-go",
              "integration": "- Подписка на события инвентаря\n- Публикация событий
              изменений инвентаря\n- Использование Outbox Pattern\n- Участие в Saga
              транзакциях\n"}, {"service": "world-service-go", "integration": "- Подписка
              на события мира\n- Публикация событий изменений мира\n- Использование
              State Synchronization Manager\n- Участие в Saga транзакциях\n"}, {"service":
              "realtime-gateway-go", "integration": "- WebSocket синхронизация с клиентами\n-
              Подписка на события для realtime обновлений\n- Публикация событий от
              клиентов\n"}, {"service": "event-bus (Kafka)", "integration": "- Управление
              топиками\n- Публикация и подписка на события\n- Гарантия доставки\n"}],
              "technical_specification": {"reference": "data-synchronization-consistency-architecture-spec.yaml"},
              "diagrams": {"reference": "data-synchronization-consistency-architecture-spec.yaml"}}}'
        - column:
            name: metadata
            value: '{"id": "data-synchronization-consistency-architecture", "title":
              "Архитектура синхронизации данных и консистентности", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-11-29T12:30:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "data-synchronization", "consistency", "infrastructure", "microservices"],
              "related_systems": ["character-service-go", "inventory-service-go",
              "world-service-go", "realtime-gateway-go", "event-bus"], "related_documents":
              [{"id": "data-synchronization-consistency-guide", "relation": "implements"},
              {"id": "realtime-server-system-architecture", "relation": "extends"},
              {"id": "global-state-system-architecture", "relation": "extends"}],
              "github_issue": 1521, "visibility": "internal", "audience": ["architect",
              "backend", "infrastructure", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\data-synchronization-consistency-architecture.yaml
