databaseChangeLog:
- changeSet:
    id: documentation-economy-contracts-system-architecture-0ecab9fa
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-481195101552698'
        - column:
            name: doc_id
            value: economy-contracts-system-architecture
        - column:
            name: title
            value: Архитектура системы контрактов и сделок
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-23 15:30:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - economy
            - contracts
            - escrow
            - trading
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - economy-service
            - inventory-service
            - wallet-service
            - reputation-service
            - logistics-service
        - column:
            name: related_documents
            value: '[{"id": "economy-contracts", "relation": "extends"}, {"id": "game-mechanics-systems-architecture",
              "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - economy
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "economy-contracts-system-architecture", "title":
              "Архитектура системы контрактов и сделок", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-11-23T15:30:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "economy", "contracts",
              "escrow", "trading"], "related_systems": ["economy-service", "inventory-service",
              "wallet-service", "reputation-service", "logistics-service"], "related_documents":
              [{"id": "economy-contracts", "relation": "extends"}, {"id": "game-mechanics-systems-architecture",
              "relation": "extends"}], "github_issue": 217, "visibility": "internal",
              "audience": ["architect", "backend", "economy", "api-designer"]}, "summary":
              {"problem": "Требуется спроектировать архитектуру системы контрактов
              и сделок для безопасных P2P транзакций\nс поддержкой эскроу, залогов,
              арбитража и различных типов контрактов (обмен, доставка, крафт, сервисы).\n",
              "goal": "Создать архитектурную схему системы контрактов с определением:\n-
              Микросервисов для управления контрактами\n- Компонентов для эскроу,
              залогов, арбитража\n- API endpoints (высокоуровнево)\n- Интеграций с
              другими экономическими системами\n- Структуры БД для хранения контрактов
              и их состояния\n- Технического задания для реализации\n", "essence":
              "Система контрактов обеспечивает безопасные P2P сделки через эскроу
              и залоги,\nподдерживает различные типы контрактов, арбитраж при спорах
              и интеграцию\nс inventory-service, wallet-service, reputation-service
              и logistics-service.\n"}, "architecture": {"overview": "Система контрактов
              состоит из следующих компонентов:\n1. Contract Manager - управление
              контрактами и их жизненным циклом\n2. Contract Negotiation Manager -
              управление переговорами\n3. Escrow Manager - управление эскроу\n4. Collateral
              Manager - управление залогами\n5. Arbitration Manager - управление арбитражем
              и спорами\n6. Contract Validator - валидация контрактов и правил\n7.
              Contract Execution Engine - исполнение контрактов\n8. Contract Analytics
              Collector - сбор аналитики по контрактам\n", "microservices": [{"name":
              "contract-service", "location": "services/contract-service", "responsibility":
              "Основной сервис для управления контрактами:\n- CRUD операции с контрактами\n-
              Управление жизненным циклом контрактов\n- Управление переговорами\n-
              Интеграция с эскроу и залогами\n", "components": ["Contract Manager",
              "Contract Negotiation Manager", "Contract Execution Engine", "Contract
              Validator"], "endpoints": ["POST /api/v1/contracts - создание контракта",
              "GET /api/v1/contracts/{id} - детали контракта", "PUT /api/v1/contracts/{id}
              - обновление контракта", "DELETE /api/v1/contracts/{id} - отмена контракта",
              "POST /api/v1/contracts/{id}/negotiate - переговоры по контракту", "POST
              /api/v1/contracts/{id}/accept - принятие контракта", "POST /api/v1/contracts/{id}/reject
              - отклонение контракта", "POST /api/v1/contracts/{id}/execute - исполнение
              контракта", "POST /api/v1/contracts/{id}/complete - завершение контракта",
              "GET /api/v1/contracts - список контрактов (с фильтрами)", "GET /api/v1/contracts/active
              - активные контракты игрока"]}, {"name": "escrow-service", "location":
              "services/escrow-service", "responsibility": "Управление эскроу и залогами:\n-
              Блокировка активов в эскроу\n- Управление залогами\n- Освобождение эскроу
              при завершении\n- Распределение эскроу при спорах\n", "components":
              ["Escrow Manager", "Collateral Manager"], "endpoints": ["POST /api/v1/escrow/create
              - создание эскроу", "GET /api/v1/escrow/{id} - детали эскроу", "POST
              /api/v1/escrow/{id}/release - освобождение эскроу", "POST /api/v1/escrow/{id}/distribute
              - распределение эскроу", "POST /api/v1/collateral/create - создание
              залога", "GET /api/v1/collateral/{id} - детали залога"]}, {"name": "arbitration-service",
              "location": "services/arbitration-service", "responsibility": "Управление
              арбитражем и спорами:\n- Создание споров\n- Сбор доказательств\n- AI-модерация
              споров\n- Принятие решений по спорам\n", "components": ["Arbitration
              Manager", "Dispute Processor"], "endpoints": ["POST /api/v1/arbitration/disputes
              - создание спора", "GET /api/v1/arbitration/disputes/{id} - детали спора",
              "POST /api/v1/arbitration/disputes/{id}/evidence - добавление доказательств",
              "POST /api/v1/arbitration/disputes/{id}/resolve - разрешение спора"]}],
              "components": [{"name": "Contract Manager", "location": "contract-service",
              "responsibility": "Управление контрактами и их жизненным циклом:\n-
              Создание, обновление, отмена контрактов\n- Управление состояниями (DRAFT
              → NEGOTIATION → ESCROW_PENDING → ACTIVE → COMPLETED/CANCELLED/DISPUTED)\n-
              Валидация контрактов\n- Интеграция с другими компонентами\n", "methods":
              ["createContract(contractData)", "updateContract(contractId, contractData)",
              "cancelContract(contractId)", "getContract(contractId)", "listContracts(filters)",
              "transitionState(contractId, newState)"]}, {"name": "Contract Negotiation
              Manager", "location": "contract-service", "responsibility": "Управление
              переговорами по контрактам:\n- Инициация переговоров\n- Обмен предложениями\n-
              Принятие/отклонение условий\n- Финализация контракта\n", "methods":
              ["startNegotiation(contractId)", "submitProposal(contractId, proposal)",
              "acceptProposal(contractId, proposalId)", "rejectProposal(contractId,
              proposalId)", "finalizeContract(contractId)"]}, {"name": "Escrow Manager",
              "location": "escrow-service", "responsibility": "Управление эскроу:\n-
              Создание эскроу для контракта\n- Блокировка активов (предметы, валюта)\n-
              Освобождение эскроу при завершении\n- Распределение эскроу при спорах\n",
              "methods": ["createEscrow(contractId, assets)", "lockAssets(escrowId,
              assets)", "releaseEscrow(escrowId)", "distributeEscrow(escrowId, distribution)"]},
              {"name": "Collateral Manager", "location": "escrow-service", "responsibility":
              "Управление залогами:\n- Создание залога для контракта\n- Блокировка
              залога\n- Частичное удержание при нарушениях\n- Возврат залога при выполнении\n",
              "methods": ["createCollateral(contractId, amount)", "lockCollateral(collateralId,
              amount)", "forfeitCollateral(collateralId, amount)", "releaseCollateral(collateralId)"]},
              {"name": "Arbitration Manager", "location": "arbitration-service", "responsibility":
              "Управление арбитражем и спорами:\n- Создание споров\n- Сбор доказательств
              от сторон\n- AI-модерация споров\n- Принятие решений и распределение
              эскроу\n", "methods": ["createDispute(contractId, reason, evidence)",
              "addEvidence(disputeId, evidence)", "moderateDispute(disputeId)", "resolveDispute(disputeId,
              decision)", "distributeEscrowOnDispute(disputeId, distribution)"]},
              {"name": "Contract Validator", "location": "contract-service", "responsibility":
              "Валидация контрактов и правил:\n- Проверка требований по уровню\n-
              KYC проверки\n- Проверка лимитов collateral\n- Ограничение параллельных
              контрактов\n- Проверки на мошенничество\n", "methods": ["validateContract(contractData)",
              "checkLevelRequirements(playerId, contractType)", "checkKYCRequirements(playerId)",
              "checkCollateralLimits(playerId, amount)", "checkConcurrentContracts(playerId)",
              "detectFraud(contractData)"]}, {"name": "Contract Execution Engine",
              "location": "contract-service", "responsibility": "Исполнение контрактов:\n-
              Выполнение условий контракта\n- Интеграция с inventory-service для обмена
              предметами\n- Интеграция с wallet-service для переводов\n- Интеграция
              с logistics-service для доставки\n- Интеграция с crafting-service для
              крафта\n", "methods": ["executeContract(contractId)", "executeItemExchange(contractId)",
              "executeCurrencyTransfer(contractId)", "executeDelivery(contractId)",
              "executeCrafting(contractId)", "executeService(contractId)"]}, {"name":
              "Contract Analytics Collector", "location": "analytics-service", "responsibility":
              "Сбор аналитики по контрактам:\n- Сбор метрик контрактов\n- Анализ успешности
              контрактов\n- Отчёты по спорам\n- Интеграция с analytics-service\n",
              "methods": ["collectContractMetrics(playerId, timeRange)", "analyzeSuccessRate(contractType,
              timeRange)", "generateDisputeReport(timeRange)"]}], "data_flow": {"contract_creation":
              "1. Игрок создаёт контракт через Contract Manager\n2. Contract Validator
              валидирует контракт (уровень, KYC, лимиты)\n3. Контракт сохраняется
              в БД со статусом DRAFT\n4. Игрок отправляет контракт другой стороне\n5.
              Контракт переходит в статус NEGOTIATION\n6. Событие публикуется в Event
              Bus (contract.created)\n", "contract_negotiation": "1. Contract Negotiation
              Manager инициирует переговоры\n2. Стороны обмениваются предложениями\n3.
              При принятии предложения: контракт финализируется\n4. Контракт переходит
              в статус ESCROW_PENDING\n5. Событие публикуется в Event Bus (contract.negotiated)\n",
              "escrow_setup": "1. Escrow Manager создаёт эскроу для контракта\n2.
              Collateral Manager создаёт залоги для сторон (если требуется)\n3. Inventory
              Service блокирует предметы в эскроу\n4. Wallet Service блокирует валюту
              в эскроу\n5. Контракт переходит в статус ACTIVE\n6. Событие публикуется
              в Event Bus (contract.escrow.locked)\n", "contract_execution": "1. Contract
              Execution Engine начинает исполнение контракта\n2. Выполняются условия
              контракта:\n   - Обмен предметами через inventory-service\n   - Перевод
              валюты через wallet-service\n   - Доставка через logistics-service\n   -
              Крафт через crafting-service\n3. События публикуются в Event Bus (contract.executing)\n",
              "contract_completion": "1. Все условия контракта выполнены\n2. Contract
              Execution Engine завершает исполнение\n3. Escrow Manager освобождает
              эскроу\n4. Collateral Manager возвращает залоги\n5. Inventory Service
              и Wallet Service получают активы\n6. Контракт переходит в статус COMPLETED\n7.
              Reputation Service обновляет репутацию сторон\n8. Событие публикуется
              в Event Bus (contract.completed)\n", "contract_dispute": "1. Одна из
              сторон создаёт спор через Arbitration Manager\n2. Контракт переходит
              в статус DISPUTED\n3. Стороны добавляют доказательства\n4. AI-модератор
              анализирует спор\n5. Arbitration Manager принимает решение\n6. Escrow
              Manager распределяет эскроу согласно решению\n7. Collateral Manager
              удерживает залоги при нарушениях\n8. Контракт переходит в статус COMPLETED
              или CANCELLED\n9. Событие публикуется в Event Bus (contract.disputed,
              contract.dispute.resolved)\n"}, "integrations": {"with_inventory_service":
              "- Блокировка предметов в эскроу\n- Обмен предметами при исполнении\n-
              Освобождение предметов при завершении\n", "with_wallet_service": "-
              Блокировка валюты в эскроу\n- Перевод валюты при исполнении\n- Освобождение
              валюты при завершении\n", "with_reputation_service": "- Обновление репутации
              при завершении контракта\n- Влияние споров на репутацию\n- Рейтинги
              контрагентов\n", "with_logistics_service": "- Создание доставки для
              контрактов на доставку\n- Отслеживание доставки\n- Завершение доставки\n",
              "with_crafting_service": "- Создание заказа на крафт для контрактов
              на крафт\n- Отслеживание крафта\n- Завершение крафта\n", "with_notification_service":
              "- Уведомления о создании контракта\n- Уведомления о переговорах\n-
              Уведомления об исполнении\n- Уведомления о спорах\n"}, "event_bus_events":
              {"published": ["contract.created", "contract.negotiated", "contract.accepted",
              "contract.rejected", "contract.escrow.locked", "contract.executing",
              "contract.completed", "contract.cancelled", "contract.disputed", "contract.dispute.resolved",
              "contract.escrow.released", "contract.collateral.forfeited"], "subscribed":
              ["inventory.item.locked (для эскроу)", "wallet.balance.locked (для эскроу)",
              "logistics.delivery.completed (для контрактов на доставку)", "crafting.order.completed
              (для контрактов на крафт)"]}, "database_schema": {"tables": [{"name":
              "player_contracts", "description": "Контракты игроков", "fields": [{"id":
              "UUID (PK)"}, {"contract_type": "ENUM (item_exchange, delivery, crafting,
              service)"}, {"initiator_id": "UUID (FK accounts)"}, {"counterparty_id":
              "UUID (FK accounts)"}, {"status": "ENUM (DRAFT, NEGOTIATION, ESCROW_PENDING,
              ACTIVE, COMPLETED, CANCELLED, DISPUTED)"}, {"terms": "JSONB (условия
              контракта)"}, {"initiator_assets": "JSONB (активы инициатора)"}, {"counterparty_assets":
              "JSONB (активы контрагента)"}, {"escrow_id": "UUID (FK escrows, nullable)"},
              {"initiator_collateral_id": "UUID (FK collaterals, nullable)"}, {"counterparty_collateral_id":
              "UUID (FK collaterals, nullable)"}, {"deadline": "TIMESTAMP"}, {"completed_at":
              "TIMESTAMP (nullable)"}, {"cancelled_at": "TIMESTAMP (nullable)"}, {"dispute_id":
              "UUID (FK disputes, nullable)"}, {"created_at": "TIMESTAMP"}, {"updated_at":
              "TIMESTAMP"}], "indexes": ["initiator_id, status", "counterparty_id,
              status", "contract_type, status", "status, deadline"]}, {"name": "contract_negotiations",
              "description": "Переговоры по контрактам", "fields": [{"id": "UUID (PK)"},
              {"contract_id": "UUID (FK player_contracts)"}, {"proposal": "JSONB (предложение)"},
              {"proposer_id": "UUID (FK accounts)"}, {"status": "ENUM (pending, accepted,
              rejected)"}, {"created_at": "TIMESTAMP"}, {"responded_at": "TIMESTAMP
              (nullable)"}], "indexes": ["contract_id, status", "proposer_id"]}, {"name":
              "escrows", "description": "Эскроу для контрактов"}]}}}'
        - column:
            name: metadata
            value: '{"id": "economy-contracts-system-architecture", "title": "Архитектура
              системы контрактов и сделок", "document_type": "architecture", "category":
              "systems", "status": "draft", "version": "1.0.0", "last_updated": "2025-11-23T15:30:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "economy", "contracts", "escrow", "trading"],
              "related_systems": ["economy-service", "inventory-service", "wallet-service",
              "reputation-service", "logistics-service"], "related_documents": [{"id":
              "economy-contracts", "relation": "extends"}, {"id": "game-mechanics-systems-architecture",
              "relation": "extends"}], "github_issue": 217, "visibility": "internal",
              "audience": ["architect", "backend", "economy", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\economy-contracts-system-architecture.yaml
