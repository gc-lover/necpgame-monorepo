databaseChangeLog:
- changeSet:
    id: documentation-economy-investments-system-architecture-47b0dad8
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '3597974660714987'
        - column:
            name: doc_id
            value: economy-investments-system-architecture
        - column:
            name: title
            value: Архитектура системы инвестиций
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-23 14:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - economy
            - investments
            - portfolio
            - stock-exchange
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - economy-service
            - stock-exchange-service
            - housing-system
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "economy-investments", "relation": "extends"}, {"id":
              "game-mechanics-systems-architecture", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - economy
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "economy-investments-system-architecture",
              "title": "Архитектура системы инвестиций", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-11-23T14:00:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "economy", "investments",
              "portfolio", "stock-exchange"], "related_systems": ["economy-service",
              "stock-exchange-service", "housing-system", "analytics-service"], "related_documents":
              [{"id": "economy-investments", "relation": "extends"}, {"id": "game-mechanics-systems-architecture",
              "relation": "extends"}], "github_issue": 228, "visibility": "internal",
              "audience": ["architect", "backend", "economy", "api-designer"]}, "summary":
              {"problem": "Требуется спроектировать архитектуру системы инвестиций
              для распределения капитала игроков\nв различные активы (акции, облигации,
              недвижимость, производственные доли, спекуляции)\nс управлением портфелем,
              анализом рисков и долгосрочным доходом.\n", "goal": "Создать архитектурную
              схему системы инвестиций с определением:\n- Микросервисов для управления
              инвестициями\n- Компонентов для портфеля, рисков, аналитики\n- API endpoints
              (высокоуровнево)\n- Интеграций с другими экономическими системами\n-
              Структуры БД для хранения инвестиций и портфелей\n- Технического задания
              для реализации\n", "essence": "Система инвестиций управляет портфелями
              игроков, обрабатывает различные типы инвестиций,\nанализирует риски,
              предоставляет рекомендации по ребалансировке и интегрируется с биржей,\nнедвижимостью
              и экономическими событиями.\n"}, "architecture": {"overview": "Система
              инвестиций состоит из следующих компонентов:\n1. Investment Manager
              - управление инвестициями и портфелями\n2. Investment Product Catalog
              - каталог инвестиционных продуктов\n3. Portfolio Manager - управление
              портфелями игроков\n4. Risk Analyzer - анализ рисков инвестиций\n5.
              Portfolio Rebalancer - рекомендации по ребалансировке\n6. Dividend Calculator
              - расчёт дивидендов и выплат\n7. Investment Analytics Collector - сбор
              аналитики по инвестициям\n8. Investment Lifecycle Manager - управление
              жизненным циклом инвестиций\n", "microservices": [{"name": "economy-service",
              "location": "services/economy-service", "responsibility": "Основной
              сервис для управления инвестициями:\n- CRUD операции с инвестициями\n-
              Управление портфелями\n- Расчёт доходности\n- Интеграция с другими экономическими
              системами\n", "components": ["Investment Manager", "Portfolio Manager",
              "Investment Lifecycle Manager"], "endpoints": ["GET /api/v1/investments/products
              - каталог инвестиционных продуктов", "GET /api/v1/investments/products/{id}
              - детали продукта", "POST /api/v1/investments/positions - создание инвестиционной
              позиции", "GET /api/v1/investments/positions - список позиций игрока",
              "GET /api/v1/investments/positions/{id} - детали позиции", "DELETE /api/v1/investments/positions/{id}
              - закрытие позиции", "GET /api/v1/investments/portfolio - портфель игрока",
              "GET /api/v1/investments/portfolio/analytics - аналитика портфеля",
              "POST /api/v1/investments/portfolio/rebalance - ребалансировка портфеля",
              "GET /api/v1/investments/transactions - история транзакций", "POST /api/v1/investments/transactions
              - создание транзакции"]}, {"name": "stock-exchange-service", "location":
              "services/stock-exchange-service", "responsibility": "Интеграция с биржей
              для акций:\n- Получение данных об акциях\n- Синхронизация цен\n- Обработка
              дивидендов\n", "components": ["Stock Integration Manager"], "endpoints":
              ["GET /api/v1/stock-exchange/stocks/{id} - данные об акции", "GET /api/v1/stock-exchange/stocks/{id}/dividends
              - дивиденды акции"]}, {"name": "housing-service", "location": "services/housing-service",
              "responsibility": "Интеграция с недвижимостью:\n- Получение данных о
              недвижимости\n- Синхронизация доходности\n- Управление инвестициями
              в недвижимость\n", "components": ["Real Estate Integration Manager"],
              "endpoints": ["GET /api/v1/housing/properties/{id} - данные о недвижимости",
              "GET /api/v1/housing/properties/{id}/yield - доходность недвижимости"]},
              {"name": "analytics-service", "location": "services/analytics-service",
              "responsibility": "Аналитика по инвестициям:\n- Сбор метрик портфеля\n-
              Анализ рисков\n- Рекомендации по ребалансировке\n- Прогнозы доходности\n",
              "components": ["Investment Analytics Collector", "Risk Analyzer", "Portfolio
              Rebalancer"], "endpoints": ["GET /api/v1/analytics/investments/portfolio/{player_id}
              - аналитика портфеля", "GET /api/v1/analytics/investments/risk-analysis
              - анализ рисков", "GET /api/v1/analytics/investments/recommendations
              - рекомендации"]}], "components": [{"name": "Investment Manager", "location":
              "economy-service", "responsibility": "Управление инвестициями и их жизненным
              циклом:\n- Создание, обновление, закрытие инвестиционных позиций\n-
              Управление транзакциями\n- Валидация инвестиций\n- Интеграция с различными
              типами активов\n", "methods": ["createPosition(investmentData)", "updatePosition(positionId,
              investmentData)", "closePosition(positionId)", "getPosition(positionId)",
              "listPositions(playerId, filters)"]}, {"name": "Investment Product Catalog",
              "location": "economy-service", "responsibility": "Каталог инвестиционных
              продуктов:\n- Управление продуктами (акции, облигации, недвижимость,
              производственные доли, спекуляции)\n- Характеристики продуктов (доходность,
              риски, минимальная сумма)\n- Доступность продуктов\n", "methods": ["getProducts(productType,
              filters)", "getProductDetails(productId)", "checkAvailability(productId)",
              "updateProduct(productId, productData)"]}, {"name": "Portfolio Manager",
              "location": "economy-service", "responsibility": "Управление портфелями
              игроков:\n- Создание и управление портфелями\n- Распределение капитала\n-
              Балансировка риск/доходность\n- Шаблоны диверсификации\n", "methods":
              ["getPortfolio(playerId)", "createPortfolio(playerId, portfolioData)",
              "updatePortfolio(playerId, portfolioData)", "calculatePortfolioValue(playerId)",
              "getPortfolioDistribution(playerId)"]}, {"name": "Risk Analyzer", "location":
              "analytics-service", "responsibility": "Анализ рисков инвестиций:\n-
              Расчёт уровней риска\n- Анализ диверсификации\n- Контроль рисков (suitability,
              margin, tax withholding)\n- Предупредительные события (margin call,
              KYC)\n", "methods": ["analyzeRisk(positionId)", "analyzePortfolioRisk(playerId)",
              "checkSuitability(playerId, productId)", "checkMarginRequirements(playerId)",
              "generateRiskAlerts(playerId)"]}, {"name": "Portfolio Rebalancer", "location":
              "analytics-service", "responsibility": "Рекомендации по ребалансировке
              портфеля:\n- Анализ текущего распределения\n- Рекомендации по ребалансировке\n-
              Шаблоны диверсификации\n- Автоматическая ребалансировка (опционально)\n",
              "methods": ["analyzeRebalancing(playerId)", "generateRecommendations(playerId)",
              "applyRebalancing(playerId, recommendations)", "getDiversificationTemplates()"]},
              {"name": "Dividend Calculator", "location": "economy-service", "responsibility":
              "Расчёт дивидендов и выплат:\n- Расчёт дивидендов по акциям\n- Расчёт
              доходности облигаций\n- Расчёт доходности недвижимости\n- Начисление
              выплат\n", "methods": ["calculateDividends(positionId)", "calculateBondYield(positionId)",
              "calculateRealEstateYield(positionId)", "processPayouts(playerId)"]},
              {"name": "Investment Analytics Collector", "location": "analytics-service",
              "responsibility": "Сбор аналитики по инвестициям:\n- Сбор метрик портфеля\n-
              Анализ доходности\n- Прогнозы\n- Интеграция с analytics-service\n",
              "methods": ["collectPortfolioMetrics(playerId)", "analyzeReturns(playerId,
              timeRange)", "generateForecasts(playerId)", "generateReports(playerId)"]},
              {"name": "Investment Lifecycle Manager", "location": "economy-service",
              "responsibility": "Управление жизненным циклом инвестиций:\n- Discovery
              (обнаружение продуктов)\n- Research (исследование)\n- Purchase (покупка)\n-
              Hold (удержание)\n- Rebalance (ребалансировка)\n- Exit (выход)\n", "methods":
              ["discoverProducts(playerId, criteria)", "researchProduct(productId)",
              "purchaseInvestment(playerId, productId, amount)", "holdInvestment(positionId)",
              "exitInvestment(positionId, exitStrategy)"]}], "data_flow": {"investment_discovery":
              "1. Игрок запрашивает каталог инвестиционных продуктов\n2. Investment
              Product Catalog возвращает доступные продукты\n3. Игрок исследует продукт
              (research)\n4. Risk Analyzer анализирует риски для игрока\n5. Игрок
              получает рекомендации\n", "investment_purchase": "1. Игрок создаёт инвестиционную
              позицию через Investment Manager\n2. Investment Manager проверяет доступность
              продукта\n3. Risk Analyzer проверяет suitability и margin requirements\n4.
              Portfolio Manager обновляет портфель игрока\n5. Транзакция создаётся
              и сохраняется в БД\n6. Событие публикуется в Event Bus (economy.investment.purchased)\n7.
              Investment Lifecycle Manager переводит статус в HOLD\n", "dividend_payout":
              "1. Dividend Calculator рассчитывает дивиденды для позиций\n2. Начисление
              выплат в wallet игрока\n3. Транзакция создаётся\n4. Событие публикуется
              в Event Bus (economy.investment.dividend_paid)\n5. Investment Analytics
              Collector обновляет метрики\n", "portfolio_rebalancing": "1. Portfolio
              Rebalancer анализирует текущее распределение портфеля\n2. Генерируются
              рекомендации по ребалансировке\n3. Игрок применяет рекомендации (или
              автоматически)\n4. Investment Manager создаёт новые позиции или закрывает
              существующие\n5. Portfolio Manager обновляет портфель\n6. Событие публикуется
              в Event Bus (economy.investment.rebalanced)\n", "investment_exit": "1.
              Игрок запрашивает выход из инвестиции\n2. Investment Manager закрывает
              позицию\n3. Расчёт прибыли/убытка\n4. Выплата средств в wallet игрока\n5.
              Транзакция создаётся\n6. Investment Lifecycle Manager переводит статус
              в EXIT\n7. Событие публикуется в Event Bus (economy.investment.exited)\n"},
              "integrations": {"with_stock_exchange": "- Получение данных об акциях\n-
              Синхронизация цен\n- Обработка дивидендов\n- Интеграция с биржевыми
              событиями\n", "with_housing_system": "- Получение данных о недвижимости\n-
              Синхронизация доходности\n- Управление инвестициями в недвижимость\n",
              "with_economy_events": "- Получение активных экономических событий\n-
              Влияние событий на доходность инвестиций\n- Влияние событий на риски\n",
              "with_analytics_service": "- Отправка метрик портфеля\n- Получение аналитики
              и рекомендаций\n- Генерация отчетов\n", "with_wallet_service": "- Списание
              средств при покупке\n- Начисление выплат (дивиденды, доходность)\n-
              Возврат средств при выходе\n"}, "event_bus_events": {"published": ["economy.investment.product.discovered",
              "economy.investment.purchased", "economy.investment.position.updated",
              "economy.investment.dividend_paid", "economy.investment.rebalanced",
              "economy.investment.exited", "economy.investment.risk_alert", "economy.investment.margin_call"],
              "subscribed": ["economy.event.active (для влияния на доходность)", "stock-exchange.price.updated
              (для синхронизации цен акций)", "housing.yield.updated (для синхронизации
              доходности недвижимости)"]}, "database_schema": {"tables": [{"name":
              "investment_products", "description": "Инвестиционные продукты", "fields":
              [{"id": "UUID (PK)"}, {"product_type": "ENUM (stock, bond, real_estate,
              production_share, commodity_speculation)"}, {"name": "VARCHAR(255)"},
              {"description": "TEXT"}, {"issuer_id": "UUID (FK corporations/factions,
              nullable)"}, {"base_yield_percentage": "DECIMAL(5,2)"}, {"risk_level":
              "ENUM (low, medium, high, very_high)"}, {"min_investment_amount": "DECIMAL(10,2)"},
              {"max_investment_amount": "DECIMAL(10,2) (nullable)"}, {"liquidity":
              "ENUM (high, medium, low)"}, {"maturity_days": "INTEGER (nullable, для
              облигаций)"}, {"available": "BOOLEAN"}, {"created_at": "TIMESTAMP"},
              {"updated_at": "TIMESTAMP"}], "indexes": ["product_type, available",
              "issuer_id", "risk_level"]}, {"name": "player_investment_positions",
              "description": "Инвестиционные позиции игроков", "fields": [{"id": "UUID
              (PK)"}, {"player_id": "UUID (FK accounts)"}, {"product_id": "UUID (FK
              investment_products)"}, {"position_type": "ENUM (long, short, nullable)"},
              {"amount": "DECIMAL(10,2)"}, {"purchase_price": "DECIMAL(10,2)"}, {"current_price":
              "DECIMAL(10,2)"}, {"current_value": "DECIMAL(10,2)"}, {"profit_loss":
              "DECIMAL(10,2)"}, {"profit_loss_percentage": "DECIMAL(5,2)"}, {"status":
              "ENUM (active, closed, suspended)"}, {"purchased_at": "TIMESTAMP"},
              {"closed_at": "TIMESTAMP (nullable)"}, {"created_at": "TIMESTAMP"},
              {"updated_at": "TIMESTAMP"}], "indexes": ["player_id, status", "product_id,
              status", "purchased_at"]}, {"name": "investment_transactions", "description":
              "Транзакции по инвестициям", "fields": [{"id": "UUID (PK)"}, {"player_id":
              "UUID (FK accounts)"}, {"position_id": "UUID (FK player_investment_positions,
              nullable)"}, {"transaction_type": "ENUM (purchase, sale, dividend, interest,
              fee, tax)"}, {"product_id": "UUID (FK investment_products)"}, {"amount":
              "DECIMAL(10,2)"}, {"price": "DECIMAL(10,2) (nullable)"}, {"total": "DECIMAL(10,2)"},
              {"currency": "VARCHAR(10)"}, {"status": "ENUM (pending, completed, failed,
              cancelled)"}, {"executed_at": "TIMESTAMP"}, {"created_at": "TIMESTAMP"}],
              "indexes": ["player_id, executed_at", "position_id"]}]}}}'
        - column:
            name: metadata
            value: '{"id": "economy-investments-system-architecture", "title": "Архитектура
              системы инвестиций", "document_type": "architecture", "category": "systems",
              "status": "draft", "version": "1.0.0", "last_updated": "2025-11-23T14:00:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "economy", "investments", "portfolio", "stock-exchange"],
              "related_systems": ["economy-service", "stock-exchange-service", "housing-system",
              "analytics-service"], "related_documents": [{"id": "economy-investments",
              "relation": "extends"}, {"id": "game-mechanics-systems-architecture",
              "relation": "extends"}], "github_issue": 228, "visibility": "internal",
              "audience": ["architect", "backend", "economy", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\economy-investments-system-architecture.yaml
