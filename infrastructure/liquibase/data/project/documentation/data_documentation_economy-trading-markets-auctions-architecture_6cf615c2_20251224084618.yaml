databaseChangeLog:
- changeSet:
    id: documentation-economy-trading-markets-auctions-architecture-6cf615c2
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '5072338543417231'
        - column:
            name: doc_id
            value: economy-trading-markets-auctions-architecture
        - column:
            name: title
            value: Архитектура экономической системы - торговля, рынки, аукционы,
              биржа
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-01 00:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - economy
            - trading
            - markets
            - auctions
            - stock-exchange
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - economy-service
            - inventory-service
            - wallet-service
            - social-service
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "economy-overview", "relation": "implements"}, {"id":
              "economy-trading", "relation": "implements"}, {"id": "player-market-core",
              "relation": "implements"}, {"id": "auction-house-mechanics", "relation":
              "implements"}, {"id": "stock-exchange-overview", "relation": "implements"},
              {"id": "trade-system-architecture", "relation": "extends"}, {"id": "stock-exchange-core",
              "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - economy
            - api-designer
            - network
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"<!-- Issue": null, "metadata": {"id": "economy-trading-markets-auctions-architecture",
              "title": "Архитектура экономической системы - торговля, рынки, аукционы,
              биржа", "document_type": "architecture", "category": "systems", "status":
              "draft", "version": "1.0.0", "last_updated": "2025-12-01T00:00:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "economy", "trading", "markets", "auctions",
              "stock-exchange"], "related_systems": ["economy-service", "inventory-service",
              "wallet-service", "social-service", "analytics-service"], "related_documents":
              [{"id": "economy-overview", "relation": "implements"}, {"id": "economy-trading",
              "relation": "implements"}, {"id": "player-market-core", "relation":
              "implements"}, {"id": "auction-house-mechanics", "relation": "implements"},
              {"id": "stock-exchange-overview", "relation": "implements"}, {"id":
              "trade-system-architecture", "relation": "extends"}, {"id": "stock-exchange-core",
              "relation": "extends"}], "github_issue": 42, "visibility": "internal",
              "audience": ["architect", "backend", "economy", "api-designer", "network"]},
              "summary": {"problem": "Требуется спроектировать архитектуру экономической
              системы, объединяющую\nторговлю, игровой рынок, аукционы и биржу. Все
              механики должны быть интегрированы\nс economy-service и обеспечивать
              стабильную игровую экономику.\n", "goal": "Создать архитектурную схему
              экономической системы с определением:\n- Компонентов для управления
              торговлей, рынками, аукционами и биржей\n- REST, WebSocket и Event Bus
              контрактов\n- Синхронизации данных между слоями (Event Sourcing, CQRS)\n-
              Тикрейта и требований к сетевой нагрузке\n- Интеграций между компонентами\n-
              Структуры БД\n- Технического задания для реализации\n", "essence": "Объединенная
              архитектура экономической системы, интегрирующая торговлю,\nигровой
              рынок, аукционы и биржу в единую систему с поддержкой стабильной\nигровой
              экономики и realtime синхронизации.\n"}, "architecture": {"overview":
              "Архитектура экономической системы состоит из следующих компонентов:\n1.
              Trading System - P2P торговля между игроками\n2. Player Market System
              - игровой рынок с фиксированными ценами\n3. Auction House System - аукционный
              дом со ставками\n4. Stock Exchange System - фондовая биржа\n5. Economy
              Orchestrator - оркестратор экономических операций\n6. Economy Analytics
              System - аналитика экономики\n", "microservices": [{"name": "economy-service",
              "port": 8085, "responsibility": "Обработка экономических механик:\n-
              P2P торговля между игроками\n- Игровой рынок (Player Market)\n- Аукционный
              дом (Auction House)\n- Фондовая биржа (Stock Exchange)\n- Оркестрация
              экономических операций\n", "components": [{"trading-system": "P2P торговля"},
              {"player-market-system": "игровой рынок"}, {"auction-house-system":
              "аукционный дом"}, {"stock-exchange-system": "фондовая биржа"}, {"economy-orchestrator":
              "оркестратор операций"}, {"economy-analytics-system": "аналитика экономики"}],
              "endpoints": ["POST /api/v1/economy/trade/sessions - создание торговой
              сессии", "GET /api/v1/economy/trade/sessions/{id} - получение сессии",
              "POST /api/v1/economy/market/listings - создание объявления", "GET /api/v1/economy/market/listings
              - поиск объявлений", "POST /api/v1/economy/market/purchase - покупка
              предмета", "POST /api/v1/economy/auctions/create - создание лота", "POST
              /api/v1/economy/auctions/bid - размещение ставки", "POST /api/v1/economy/auctions/buyout
              - мгновенный выкуп", "GET /api/v1/economy/stock/orders - получение ордеров",
              "POST /api/v1/economy/stock/orders - создание ордера", "GET /api/v1/economy/stock/prices
              - получение цен"], "websocket_channels": ["wss://api.necp.game/v1/economy/trade/{sessionId}
              - live события торговли", "wss://api.necp.game/v1/economy/market/{characterId}
              - обновления рынка", "wss://api.necp.game/v1/economy/auctions/{auctionId}
              - события аукциона", "wss://api.necp.game/v1/economy/stock/prices -
              цены акций в реальном времени"], "events_published": [{"economy.trade.session-created":
              "создание торговой сессии"}, {"economy.trade.completed": "завершение
              торговли"}, {"economy.market.listing-created": "создание объявления"},
              {"economy.market.purchase-completed": "покупка предмета"}, {"economy.auction.created":
              "создание лота"}, {"economy.auction.bid-placed": "размещение ставки"},
              {"economy.auction.completed": "завершение аукциона"}, {"economy.stock.order-placed":
              "размещение ордера"}, {"economy.stock.trade-executed": "исполнение сделки"},
              {"economy.stock.price-updated": "обновление цены"}], "events_subscribed":
              [{"inventory.item-moved": "перемещение предмета"}, {"wallet.balance-updated":
              "обновление баланса"}, {"social.reputation-updated": "обновление репутации"}]}],
              "data_synchronization": {"strategy": "Event Sourcing + CQRS", "event_store":
              "Все события экономики сохраняются в Event Store:\n- economy.trade.session-created\n-
              economy.trade.completed\n- economy.market.listing-created\n- economy.market.purchase-completed\n-
              economy.auction.created\n- economy.auction.bid-placed\n- economy.auction.completed\n-
              economy.stock.order-placed\n- economy.stock.trade-executed\n- economy.stock.price-updated\n",
              "command_side": "Command Side (Write Model):\n- economy-service: обработка
              команд торговли, рынка, аукционов, биржи\n", "query_side": "Query Side
              (Read Model):\n- economy-service: получение статуса операций, цен, объявлений\n",
              "saga_pattern": "Saga для экономических операций:\n1. Start Economy
              Operation Saga\n2. Validate Resources (предметы, валюта)\n3. Reserve
              Resources (блокировка)\n4. Execute Operation (торговля/покупка/ставка/ордер)\n5.
              Update Balances (обновление балансов)\n6. If failure: Compensate (rollback,
              возврат ресурсов)\n", "consistency": "Strong Consistency для критичных
              операций:\n- Создание торговых сессий\n- Покупка предметов\n- Размещение
              ставок\n- Исполнение ордеров\n- Обновление балансов\nEventual Consistency
              для:\n- Поиск объявлений\n- Статистика рынка\n- Аналитика экономики\n"},
              "network_requirements": {"tick_rate": {"trading_sessions": "- Протокол:
              WebSocket (TCP)\n- Тикрейт: 10-20 Hz\n- Задержка: <100 мс\n- Игроков:
              2 (P2P)\n", "market_listings": "- Протокол: HTTP REST + WebSocket\n-
              Тикрейт: on-demand (при изменении)\n- Задержка: <200 мс\n- Оптимизация:
              Кэширование, пагинация\n", "auction_bidding": "- Протокол: WebSocket
              (TCP)\n- Тикрейт: 5-10 Hz (при активных торгах)\n- Задержка: <150 мс\n-
              Оптимизация: Батчинг ставок\n", "stock_exchange": "- Протокол: WebSocket
              (TCP) для цен\n- Тикрейт: 1-5 Hz (цены), on-demand (ордера)\n- Задержка:
              <100 мс\n- Оптимизация: Кэширование цен, агрегация обновлений\n"}, "bandwidth_optimization":
              "- Кэширование объявлений и цен\n- Пагинация результатов поиска (50
              на страницу)\n- Агрегация обновлений цен для биржи\n- Сжатие данных
              для WebSocket\n- Rate limiting для предотвращения злоупотреблений\n"},
              "data_flows": {"trading_session_flow": "1. Игрок создает торговую сессию\n2.
              Trading System проверяет расстояние между игроками\n3. Trading System
              блокирует предметы и валюту\n4. Оба игрока подтверждают обмен\n5. Trading
              System выполняет обмен\n6. Economy Service публикует событие economy.trade.completed\n7.
              Realtime Gateway отправляет обновление клиентам\n", "market_listing_flow":
              "1. Игрок создает объявление на рынке\n2. Player Market System проверяет
              лимиты (20 объявлений)\n3. Player Market System блокирует предмет в
              инвентаре\n4. Player Market System рассчитывает комиссию (1%)\n5. Economy
              Service публикует событие economy.market.listing-created\n6. Realtime
              Gateway отправляет обновление клиентам\n", "market_purchase_flow": "1.
              Игрок покупает предмет на рынке\n2. Player Market System проверяет наличие
              и баланс\n3. Player Market System списывает валюту и комиссию\n4. Player
              Market System передает предмет покупателю\n5. Player Market System выплачивает
              продавцу (за вычетом комиссии)\n6. Economy Service публикует событие
              economy.market.purchase-completed\n7. Realtime Gateway отправляет обновление
              клиентам\n", "auction_bidding_flow": "1. Игрок размещает ставку на аукционе\n2.
              Auction House System проверяет минимальную ставку (+5%)\n3. Auction
              House System резервирует валюту\n4. Auction House System возвращает
              предыдущему лидеру\n5. Auction House System продлевает таймер (если
              <5 минут)\n6. Economy Service публикует событие economy.auction.bid-placed\n7.
              Realtime Gateway отправляет обновление клиентам\n", "stock_order_flow":
              "1. Игрок размещает ордер на бирже\n2. Stock Exchange System добавляет
              ордер в order book\n3. Stock Exchange System пытается выполнить matching\n4.
              Stock Exchange System обновляет цены при исполнении\n5. Economy Service
              публикует событие economy.stock.order-placed или trade-executed\n6.
              Realtime Gateway отправляет обновление цен клиентам\n"}, "database_structure":
              {"tables": [{"name": "trade_sessions", "description": "Торговые сессии
              P2P", "columns": [{"id": "UUID PRIMARY KEY"}, {"initiator_id": "UUID
              FOREIGN KEY"}, {"recipient_id": "UUID FOREIGN KEY"}, {"status": "ENUM
              (created, active, confirmed, completed, cancelled)"}, {"initiator_items":
              "JSONB"}, {"recipient_items": "JSONB"}, {"initiator_currency": "JSONB"},
              {"recipient_currency": "JSONB"}, {"created_at": "TIMESTAMP"}, {"expires_at":
              "TIMESTAMP"}, {"completed_at": "TIMESTAMP (nullable)"}]}, {"name": "market_listings",
              "description": "Объявления на игровом рынке", "columns": [{"id": "UUID
              PRIMARY KEY"}, {"seller_id": "UUID FOREIGN KEY"}, {"item_id": "UUID
              FOREIGN KEY"}, {"price": "DECIMAL(15,2)"}, {"quantity": "INTEGER"},
              {"status": "ENUM (active, sold, expired, cancelled)"}, {"expires_at":
              "TIMESTAMP"}, {"created_at": "TIMESTAMP"}, {"sold_at": "TIMESTAMP (nullable)"}]},
              {"name": "auction_lots", "description": "Лоты аукционного дома", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"seller_id": "UUID FOREIGN KEY"}, {"item_id":
              "UUID FOREIGN KEY"}, {"start_price": "DECIMAL(15,2)"}, {"buyout_price":
              "DECIMAL(15,2)"}, {"current_bid": "DECIMAL(15,2)"}, {"bidder_id": "UUID
              FOREIGN KEY (nullable)"}, {"bid_count": "INTEGER DEFAULT 0"}, {"status":
              "ENUM (active, sold, expired, cancelled)"}, {"duration_hours": "INTEGER"},
              {"expires_at": "TIMESTAMP"}, {"created_at": "TIMESTAMP"}, {"completed_at":
              "TIMESTAMP (nullable)"}]}, {"name": "stock_orders", "description": "Ордера
              на бирже", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"stock_symbol": "VARCHAR(20)"}, {"order_type":
              "ENUM (buy, sell)"}, {"order_side": "ENUM (market, limit)"}, {"quantity":
              "INTEGER"}, {"price": "DECIMAL(15,2) (nullable)"}, {"status": "ENUM
              (pending, filled, partially_filled, cancelled)"}, {"filled_quantity":
              "INTEGER DEFAULT 0"}, {"created_at": "TIMESTAMP"}, {"executed_at": "TIMESTAMP
              (nullable)"}]}, {"name": "stock_trades", "description": "Исполненные
              сделки на бирже", "columns": [{"id": "UUID PRIMARY KEY"}, {"buy_order_id":
              "UUID FOREIGN KEY"}, {"sell_order_id": "UUID FOREIGN KEY"}, {"stock_symbol":
              "VARCHAR(20)"}, {"quantity": "INTEGER"}, {"price": "DECIMAL(15,2)"},
              {"executed_at": "TIMESTAMP"}]}, {"name": "economy_operations_log", "description":
              "Лог всех экономических операций", "columns": [{"id": "UUID PRIMARY
              KEY"}, {"operation_type": "ENUM (trade, market_purchase, auction_bid,
              stock_order)"}, {"character_id": "UUID FOREIGN KEY"}, {"operation_data":
              "JSONB"}, {"result": "JSONB"}, {"created_at": "TIMESTAMP"}]}]}, "integrations":
              {"inventory_service": "Проверка владения предметами, блокировка предметов,
              передача предметов\n", "wallet_service": "Проверка баланса, резервирование
              валюты, списание/начисление валюты\n", "social_service": "Получение
              репутации продавцов, обновление репутации после сделок\n", "analytics_service":
              "Логирование всех операций, сбор метрик экономики, антифрод мониторинг\n",
              "realtime_service": "Синхронизация цен и событий в реальном времени\n"}},
              "technical_specification": {"subtasks": [{"id": "trading-system", "title":
              "Реализация системы P2P торговли", "description": "Реализация Trading
              System с управлением торговыми сессиями,\nпроверкой расстояния, блокировкой
              предметов и двойным подтверждением.\n", "dependencies": [], "estimated_effort":
              "5 days"}, {"id": "player-market-system", "title": "Реализация игрового
              рынка", "description": "Реализация Player Market System с созданием
              объявлений, поиском,\nпокупкой предметов и управлением лимитами.\n",
              "dependencies": [], "estimated_effort": "6 days"}, {"id": "auction-house-system",
              "title": "Реализация аукционного дома", "description": "Реализация Auction
              House System с созданием лотов, размещением ставок,\nлогикой buyout
              и продлением таймеров.\n", "dependencies": [], "estimated_effort": "6
              days"}, {"id": "stock-exchange-system", "title": "Реализация фондовой
              биржи", "description": "Реализация Stock Exchange System с order book,
              matching ордеров,\nобновлением цен и управлением портфелями.\n", "dependencies":
              [], "estimated_effort": "7 days"}, {"id": "economy-orchestrator", "title":
              "Реализация оркестратора экономики", "description": "Реализация Economy
              Orchestrator с координацией всех экономических\nопераций и управлением
              сагами.\n", "dependencies": ["trading-system", "player-market-system",
              "auction-house-system", "stock-exchange-system"], "estimated_effort":
              "5 days"}, {"id": "economy-analytics-system", "title": "Реализация аналитики
              экономики", "description": "Реализация Economy Analytics System с логированием
              операций,\nсбором метрик и антифрод мониторингом.\n", "dependencies":
              ["economy-orchestrator"], "estimated_effort": "4 days"}, {"id": "websocket-channels",
              "title": "Реализация WebSocket каналов", "description": "Реализация
              WebSocket каналов для realtime обновлений торговли,\nрынка, аукционов
              и биржи.\n", "dependencies": ["economy-orchestrator"], "estimated_effort":
              "3 days"}, {"id": "event-bus-integration", "title": "Интеграция с Event
              Bus", "description": "Реализация публикации и подписки на события через
              Kafka\nдля всех компонентов экономической системы.\n", "dependencies":
              ["economy-orchestrator"], "estimated_effort": "2 days"}, {"id": "database-schema",
              "title": "Создание схемы БД", "description": "Создание таблиц БД для
              торговли, рынка, аукционов, биржи\nи логов операций с миграциями Liquibase.\n",
              "dependencies": [], "estimated_effort": "3 days"}]}, "diagrams": {"component_diagram":
              "```mermaid\ngraph TB\n    Client[UE5 Client] --> Gateway[API Gateway]\n\n    Gateway
              --> EconomyService[Economy Service<br/>8085]\n\n    EconomyService -->
              TS[Trading System]\n    EconomyService --> PMS[Player Market System]\n    EconomyService
              --> AHS[Auction House System]\n    EconomyService --> SES[Stock Exchange
              System]\n    EconomyService --> EO[Economy Orchestrator]\n    EconomyService
              --> EAS[Economy Analytics System]\n\n    TS --> PMS\n    PMS --> AHS\n    AHS
              --> SES\n\n    EconomyService --> InventoryService[Inventory Service]\n    EconomyService
              --> WalletService[Wallet Service]\n    EconomyService --> SocialService[Social
              Service]\n    EconomyService --> AnalyticsService[Analytics Service]\n    EconomyService
              --> RealtimeService[Realtime Service]\n\n    EconomyService --> EventBus[Event
              Bus<br/>Kafka]\n    EventBus --> RealtimeGateway[Realtime Gateway]\n\n    EconomyService
              --> DB[(Economy DB)]\n\n    Client --> WSEcon[WebSocket<br/>Economy]\n    WSEcon
              --> EconomyService\n```\n", "trading_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              P1 as Player 1\n    participant TS as Trading System\n    participant
              IS as Inventory Service\n    participant WS as Wallet Service\n    participant
              P2 as Player 2\n\n    P1->>TS: Create trade session\n    TS->>IS: Validate
              items\n    TS->>TS: Block items\n    TS->>P2: Notify trade offer\n    P2->>TS:
              Accept trade\n    P2->>TS: Add items\n    TS->>IS: Validate items\n    TS->>TS:
              Block items\n    P1->>TS: Confirm trade\n    P2->>TS: Confirm trade\n    TS->>IS:
              Transfer items\n    TS->>WS: Transfer currency\n    TS->>TS: Complete
              trade\n    TS->>P1: Trade completed\n    TS->>P2: Trade completed\n```\n"}}'
        - column:
            name: metadata
            value: '{"id": "economy-trading-markets-auctions-architecture", "title":
              "Архитектура экономической системы - торговля, рынки, аукционы, биржа",
              "document_type": "architecture", "category": "systems", "status": "draft",
              "version": "1.0.0", "last_updated": "2025-12-01T00:00:00+00:00", "owners":
              [{"role": "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "economy", "trading", "markets", "auctions", "stock-exchange"], "related_systems":
              ["economy-service", "inventory-service", "wallet-service", "social-service",
              "analytics-service"], "related_documents": [{"id": "economy-overview",
              "relation": "implements"}, {"id": "economy-trading", "relation": "implements"},
              {"id": "player-market-core", "relation": "implements"}, {"id": "auction-house-mechanics",
              "relation": "implements"}, {"id": "stock-exchange-overview", "relation":
              "implements"}, {"id": "trade-system-architecture", "relation": "extends"},
              {"id": "stock-exchange-core", "relation": "extends"}], "github_issue":
              42, "visibility": "internal", "audience": ["architect", "backend", "economy",
              "api-designer", "network"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\economy-trading-markets-auctions-architecture.yaml
