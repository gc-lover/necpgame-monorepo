databaseChangeLog:
- changeSet:
    id: documentation-guild-system-architecture-a448b83a
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-626756164773364'
        - column:
            name: doc_id
            value: guild-system-architecture
        - column:
            name: title
            value: Архитектура системы гильдий
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: approved
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-14 12:00:00+00:00
        - column:
            name: concept_approved
            value: true
        - column:
            name: concept_reviewed_at
            value: ''
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - guilds
            - architecture
            - backend
            - social
            - economy
            - world
        - column:
            name: topics
            value:
            - membership
            - ranks
            - wars
            - territories
            - bank
        - column:
            name: related_systems
            value:
            - social-service
            - economy-service
            - world-service
            - combat-service
            - notification-service
        - column:
            name: related_documents
            value: '[{"id": "guild-system-backend", "relation": "extends"}, {"id":
              "guilds-overview", "relation": "references"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - concept
        - column:
            name: risk_level
            value: high
        - column:
            name: content
            value: '{"metadata": {"id": "guild-system-architecture", "title": "Архитектура
              системы гильдий", "document_type": "architecture", "category": "systems",
              "status": "approved", "version": "1.0.0", "last_updated": "2025-12-14T12:00:00+00:00",
              "concept_approved": true, "concept_reviewed_at": "", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["guilds",
              "architecture", "backend", "social", "economy", "world"], "topics":
              ["membership", "ranks", "wars", "territories", "bank"], "related_systems":
              ["social-service", "economy-service", "world-service", "combat-service",
              "notification-service"], "related_documents": [{"id": "guild-system-backend",
              "relation": "extends"}, {"id": "guilds-overview", "relation": "references"}],
              "source": "", "visibility": "internal", "audience": ["architect", "backend",
              "concept"], "risk_level": "high"}, "review": {"chain": [{"role": "architect",
              "reviewer": "", "reviewed_at": "", "status": "pending"}], "next_actions":
              []}, "summary": {"problem": "Отсутствует полная архитектурная документация
              системы гильдий для управления участниками, рангами, банком, войнами
              и территорией.", "goal": "Спроектировать полную техническую архитектуру
              системы гильдий с определением компонентов, API, потоков данных, структуры
              БД и систем управления.", "essence": "Микросервисная архитектура с выделенными
              сервисами для управления гильдиями, банком, войнами и территориями,
              интегрированная с существующими системами.", "key_points": ["Микросервисная
              архитектура с 4 основными сервисами", "Полная структура БД с оптимизированными
              индексами", "Системы управления рангами, банком и войнами", "API endpoints
              для всех операций", "Потоки данных и интеграции между сервисами"]},
              "content": {"sections": [{"id": "overview", "title": "Обзор архитектуры",
              "body": "Система гильдий построена на микросервисной архитектуре и состоит
              из 4 основных сервисов:\n\n1. **guild-core-service** - основной сервис
              управления гильдиями\n2. **guild-bank-service** - сервис банка гильдии\n3.
              **guild-war-service** - сервис гильдейских войн\n4. **guild-territory-service**
              - сервис территорий и собственности\n\nВсе сервисы интегрируются с существующими
              системами (social, economy, world, combat, notification).\n", "mechanics_links":
              [], "assets": []}, {"id": "components", "title": "Компоненты системы",
              "body": "## guild-core-service (порт 8084)\nОсновной сервис управления
              гильдиями:\n- Создание/удаление гильдий\n- Управление членством (приглашения,
              исключения)\n- Система рангов и прав\n- Базовые настройки гильдии\n-
              Статистика и метрики\n\n## guild-bank-service (порт 8085)\nСервис банковских
              операций гильдии:\n- Управление общим банком\n- Вклады и снятия средств\n-
              Налоги и сборы\n- Экономические транзакции\n\n## guild-war-service (порт
              8086)\nСервис гильдейских войн:\n- Объявление и управление войнами\n-
              Система очков войны\n- Бонусы за участие\n- Статистика войн\n\n## guild-territory-service
              (порт 8087)\nСервис территорий и собственности:\n- Захват и защита территорий\n-
              Управление собственностью\n- Территориальные войны\n- Экономические
              бонусы территорий\n", "mechanics_links": [], "assets": []}, {"id": "database",
              "title": "Структура базы данных", "body": "## Основные таблицы\n\n###
              guilds\n```sql\nCREATE TABLE guilds (\n  guild_id UUID PRIMARY KEY,\n  name
              VARCHAR(100) NOT NULL UNIQUE,\n  tag VARCHAR(10) NOT NULL UNIQUE,\n  description
              TEXT,\n  leader_id UUID NOT NULL REFERENCES players(player_id),\n  level
              INTEGER DEFAULT 1,\n  experience BIGINT DEFAULT 0,\n  max_members INTEGER
              DEFAULT 50,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at
              TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\nCREATE INDEX idx_guilds_name
              ON guilds(name);\nCREATE INDEX idx_guilds_tag ON guilds(tag);\nCREATE
              INDEX idx_guilds_leader ON guilds(leader_id);\n```\n\n### guild_members\n```sql\nCREATE
              TABLE guild_members (\n  guild_id UUID REFERENCES guilds(guild_id),\n  player_id
              UUID REFERENCES players(player_id),\n  rank_id INTEGER REFERENCES guild_ranks(rank_id),\n  joined_at
              TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  contribution_points BIGINT
              DEFAULT 0,\n  PRIMARY KEY (guild_id, player_id)\n);\n\nCREATE INDEX
              idx_guild_members_player ON guild_members(player_id);\nCREATE INDEX
              idx_guild_members_rank ON guild_members(rank_id);\n```\n\n### guild_ranks\n```sql\nCREATE
              TABLE guild_ranks (\n  rank_id SERIAL PRIMARY KEY,\n  guild_id UUID
              REFERENCES guilds(guild_id),\n  name VARCHAR(50) NOT NULL,\n  level
              INTEGER NOT NULL,\n  permissions JSONB,\n  created_at TIMESTAMP WITH
              TIME ZONE DEFAULT NOW()\n);\n```\n\n### guild_bank\n```sql\nCREATE TABLE
              guild_bank (\n  guild_id UUID PRIMARY KEY REFERENCES guilds(guild_id),\n  balance
              JSONB DEFAULT ''{}'', -- Валюты и ресурсы\n  tax_rate DECIMAL(3,2) DEFAULT
              0.05,\n  last_transaction_at TIMESTAMP WITH TIME ZONE,\n  created_at
              TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n```\n\n### guild_wars\n```sql\nCREATE
              TABLE guild_wars (\n  war_id UUID PRIMARY KEY,\n  attacker_guild_id
              UUID REFERENCES guilds(guild_id),\n  defender_guild_id UUID REFERENCES
              guilds(guild_id),\n  territory_id UUID,\n  status VARCHAR(20) DEFAULT
              ''active'',\n  points_attacker BIGINT DEFAULT 0,\n  points_defender
              BIGINT DEFAULT 0,\n  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  ended_at
              TIMESTAMP WITH TIME ZONE\n);\n```\n\n### guild_territories\n```sql\nCREATE
              TABLE guild_territories (\n  territory_id UUID PRIMARY KEY,\n  guild_id
              UUID REFERENCES guilds(guild_id),\n  name VARCHAR(100) NOT NULL,\n  type
              VARCHAR(50),\n  coordinates JSONB,\n  bonuses JSONB,\n  controlled_since
              TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n```\n", "mechanics_links":
              [], "assets": []}, {"id": "api-endpoints", "title": "API Endpoints",
              "body": "## Guild Core API (guild-core-service)\n\n### Управление гильдиями\n```\nPOST   /api/v1/guilds              -
              Создать гильдию\nGET    /api/v1/guilds/{id}         - Получить информацию
              о гильдии\nPUT    /api/v1/guilds/{id}         - Обновить гильдию\nDELETE
              /api/v1/guilds/{id}         - Распустить гильдию\nGET    /api/v1/guilds/search       -
              Поиск гильдий\n```\n\n### Управление членством\n```\nPOST   /api/v1/guilds/{id}/invite  -
              Пригласить игрока\nPOST   /api/v1/guilds/{id}/join    - Принять приглашение\nDELETE
              /api/v1/guilds/{id}/leave   - Покинуть гильдию\nDELETE /api/v1/guilds/{id}/kick    -
              Исключить игрока\n```\n\n### Управление рангами\n```\nPOST   /api/v1/guilds/{id}/ranks       -
              Создать ранг\nPUT    /api/v1/guilds/{id}/ranks/{rid} - Обновить ранг\nDELETE
              /api/v1/guilds/{id}/ranks/{rid} - Удалить ранг\nPUT    /api/v1/guilds/{id}/members/{pid}/rank
              - Изменить ранг участника\n```\n\n## Guild Bank API (guild-bank-service)\n\n###
              Банковские операции\n```\nGET    /api/v1/guilds/{id}/bank          -
              Получить баланс банка\nPOST   /api/v1/guilds/{id}/bank/deposit   - Внести
              средства\nPOST   /api/v1/guilds/{id}/bank/withdraw  - Снять средства\nPUT    /api/v1/guilds/{id}/bank/tax       -
              Изменить налог\nGET    /api/v1/guilds/{id}/bank/history   - История
              транзакций\n```\n\n## Guild War API (guild-war-service)\n\n### Управление
              войнами\n```\nPOST   /api/v1/guilds/{id}/wars           - Объявить войну\nGET    /api/v1/guilds/{id}/wars           -
              Список войн\nGET    /api/v1/wars/{wid}                 - Детали войны\nPUT    /api/v1/wars/{wid}/end             -
              Завершить войну\nPOST   /api/v1/wars/{wid}/points          - Добавить
              очки\n```\n\n## Guild Territory API (guild-territory-service)\n\n###
              Управление территориями\n```\nGET    /api/v1/territories                -
              Список территорий\nPOST   /api/v1/territories/{tid}/claim    - Захватить
              территорию\nDELETE /api/v1/territories/{tid}/claim    - Отказаться от
              территории\nGET    /api/v1/guilds/{id}/territories     - Территории
              гильдии\n```\n", "mechanics_links": [], "assets": []}, {"id": "data-flows",
              "title": "Потоки данных", "body": "## Создание гильдии\n1. Игрок отправляет
              запрос в guild-core-service\n2. Валидация данных и проверка прав\n3.
              Создание записи в БД\n4. Публикация события `guild:created`\n5. Уведомление
              через notification-service\n\n## Вступление в гильдию\n1. Приглашение
              через guild-core-service\n2. Игрок принимает приглашение\n3. Обновление
              guild_members\n4. Публикация `guild:member-joined`\n5. Обновление социальных
              связей в social-service\n\n## Банковская транзакция\n1. Запрос в guild-bank-service\n2.
              Валидация баланса через economy-service\n3. Выполнение транзакции\n4.
              Обновление guild_bank\n5. Публикация `guild:bank-transaction`\n\n##
              Гильдейская война\n1. Объявление войны через guild-war-service\n2. Создание
              записи в guild_wars\n3. Уведомление участников\n4. Интеграция с combat-service
              для боев\n5. Обновление очков и завершение войны\n", "mechanics_links":
              [], "assets": []}, {"id": "rank-system", "title": "Система рангов и
              прав", "body": "## Структура рангов\nКаждый ранг имеет уровень (1-10)
              и набор разрешений:\n\n### Основные ранги (автоматические)\n- **Глава**
              (level 10): Полный доступ ко всем функциям\n- **Заместитель** (level
              8): Управление членами, банком, войнами\n- **Офицер** (level 6): Приглашения,
              исключения, управление рангами\n- **Ветеран** (level 4): Доступ к банку,
              участие в войнах\n- **Член** (level 2): Базовые права, вклад в банк\n-
              **Рекрут** (level 1): Минимальные права\n\n## Разрешения\n```json\n{\n  \"invite_members\":
              true,\n  \"kick_members\": true,\n  \"manage_ranks\": true,\n  \"manage_bank\":
              true,\n  \"declare_war\": true,\n  \"manage_territories\": true,\n  \"edit_guild_info\":
              true,\n  \"view_bank_history\": true\n}\n```\n\n## Прогрессия рангов\n-
              Автоматическое повышение при достижении contribution_points\n- Ручное
              повышение офицерами и выше\n- Минимальный срок в ранге перед повышением\n",
              "mechanics_links": [], "assets": []}, {"id": "bank-system", "title":
              "Система банка гильдии", "body": "## Структура банка\nБанк хранит различные
              валюты и ресурсы в JSONB формате:\n\n```json\n{\n  \"credits\": 150000,\n  \"premium_currency\":
              2500,\n  \"resources\": {\n    \"metal\": 5000,\n    \"energy\": 3000,\n    \"rare_materials\":
              150\n  }\n}\n```\n\n## Типы транзакций\n- **Вклады**: Игроки вносят
              средства в банк гильдии\n- **Снятия**: Авторизованные участники снимают
              средства\n- **Налоги**: Автоматический сбор с активностей участников\n-
              **Награды**: Распределение от войн и территорий\n\n## Налоговые ставки\n-
              Базовая ставка: 5% от наград\n- Настраиваемая главой гильдии\n- Автоматическое
              применение при получении наград\n\n## Интеграция с экономикой\n- Валидация
              балансов через economy-service\n- Атомарные транзакции\n- Аудит всех
              операций\n", "mechanics_links": [], "assets": []}, {"id": "war-system",
              "title": "Система гильдейских войн", "body": "## Типы войн\n- **Территориальные
              войны**: Захват территорий\n- **Рейтинговые войны**: За позицию в таблице
              лидеров\n- **Ресурсные войны**: Контроль над ресурсными точками\n\n##
              Механика войны\n1. Объявление войны (требует разрешения офицера+)\n2.
              Период подготовки (24 часа)\n3. Активная фаза (7 дней)\n4. Подведение
              итогов\n\n## Система очков\n- Убийство противника: +10 очков\n- Захват
              цели: +50 очков\n- Защита территории: +25 очков\n- Командные бонусы
              за участие\n\n## Награды победителям\n- Репутация гильдии\n- Экономические
              бонусы\n- Территориальные преимущества\n- Персональные награды участникам\n\n##
              Интеграция с боевой системой\n- Регистрация боев через combat-service\n-
              Автоматический подсчет очков\n- Бонусы за гильдейские бои\n", "mechanics_links":
              [], "assets": []}, {"id": "integration", "title": "Интеграции с другими
              системами", "body": "## Social Service\n- Управление социальными связями
              участников\n- Чат гильдии\n- Уведомления о событиях\n\n## Economy Service\n-
              Валидация транзакций\n- Курсы валют\n- Экономические события\n\n## World
              Service\n- Территории и зоны контроля\n- Мировые события\n- Географические
              данные\n\n## Combat Service\n- Регистрация боев в войнах\n- Бонусы за
              гильдейские бои\n- Статистика PvP\n\n## Notification Service\n- Уведомления
              о событиях гильдии\n- Приглашения и объявления\n- Еженедельные отчеты\n",
              "mechanics_links": [], "assets": []}, {"id": "technical-spec", "title":
              "Техническое задание", "body": "## Требования к производительности\n-
              P99 latency <50ms для основных операций\n- Поддержка 1000+ одновременных
              гильдий\n- Масштабируемость до 100k+ участников\n\n## Безопасность\n-
              Валидация всех разрешений\n- Аудит критических операций\n- Защита от
              эксплойтов\n\n## Мониторинг\n- Метрики производительности\n- Логи всех
              операций\n- Алерты на аномалии\n\n## Тестирование\n- Unit тесты для
              всех компонентов\n- Integration тесты API\n- Load тесты для высокой
              нагрузки\n", "mechanics_links": [], "assets": []}, {"id": "implementation-plan",
              "title": "План реализации", "body": "## Фаза 1: Базовая функциональность
              (2 недели)\n- guild-core-service с CRUD операциями\n- Базовая структура
              БД\n- API для создания и управления гильдиями\n- Система членства\n\n##
              Фаза 2: Ранги и права (1 неделя)\n- Система рангов\n- Управление разрешениями\n-
              API для рангов\n\n## Фаза 3: Банк гильдии (1 неделя)\n- guild-bank-service\n-
              Интеграция с economy-service\n- Налоги и транзакции\n\n## Фаза 4: Войны
              (2 недели)\n- guild-war-service\n- Система очков\n- Интеграция с combat-service\n\n##
              Фаза 5: Территории (2 недели)\n- guild-territory-service\n- Захват территорий\n-
              Экономические бонусы\n\n## Фаза 6: Оптимизация и тестирование (1 неделя)\n-
              Производительность\n- Безопасность\n- Полное тестирование\n", "mechanics_links":
              [], "assets": []}]}, "appendix": {"glossary": [{"term": "Guild", "definition":
              "Организация игроков с общими целями, ресурсами и территорией"}, {"term":
              "Rank", "definition": "Уровень прав и ответственности участника в гильдии"},
              {"term": "Territory", "definition": "Контролируемая область мира с экономическими
              бонусами"}], "references": [], "decisions": [{"id": "adr-guild-architecture",
              "summary": "Утверждена микросервисная архитектура системы гильдий с
              4 выделенными сервисами"}]}, "implementation": {"needs_task": false,
              "github_issue": 1856, "queue_reference": [], "blockers": []}, "history":
              [{"version": "1.0.0", "date": "2025-12-14", "author": "Backend Agent",
              "changes": "Создана полная архитектурная документация системы гильдий"}],
              "validation": {"checksum": "", "schema_version": "1.0"}}'
        - column:
            name: metadata
            value: '{"id": "guild-system-architecture", "title": "Архитектура системы
              гильдий", "document_type": "architecture", "category": "systems", "status":
              "approved", "version": "1.0.0", "last_updated": "2025-12-14T12:00:00+00:00",
              "concept_approved": true, "concept_reviewed_at": "", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["guilds",
              "architecture", "backend", "social", "economy", "world"], "topics":
              ["membership", "ranks", "wars", "territories", "bank"], "related_systems":
              ["social-service", "economy-service", "world-service", "combat-service",
              "notification-service"], "related_documents": [{"id": "guild-system-backend",
              "relation": "extends"}, {"id": "guilds-overview", "relation": "references"}],
              "source": "", "visibility": "internal", "audience": ["architect", "backend",
              "concept"], "risk_level": "high"}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\guild-system-architecture.yaml
