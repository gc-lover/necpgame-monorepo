databaseChangeLog:
- changeSet:
    id: documentation-investments-system-architecture-0d65056f
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '6760349649937136'
        - column:
            name: doc_id
            value: investments-system-architecture
        - column:
            name: title
            value: Архитектура системы инвестиций
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-30 19:30:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - investments
            - backend
            - economy
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - economy-service-go
            - stock-exchange
            - housing-system-go
        - column:
            name: related_documents
            value: '[{"id": "economy-investments", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "investments-system-architecture", "title":
              "Архитектура системы инвестиций", "document_type": "architecture", "category":
              "systems", "status": "draft", "version": "1.0.0", "last_updated": "2025-11-30T19:30:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "investments", "backend", "economy"], "related_systems":
              ["economy-service-go", "stock-exchange", "housing-system-go"], "related_documents":
              [{"id": "economy-investments", "relation": "extends"}], "github_issue":
              228, "visibility": "internal", "audience": ["architect", "backend",
              "api-designer"]}, "summary": {"problem": "Требуется спроектировать полную
              техническую архитектуру системы инвестиций\nдля управления инвестиционными
              продуктами, портфелями игроков, анализом рисков\nи интеграцией с stock-exchange,
              housing-system и другими сервисами.\n", "goal": "Создать архитектурную
              схему системы инвестиций с определением:\n- Компонентов системы (микросервисы,
              модули)\n- API endpoints (высокоуровнево)\n- Потоков данных и интеграций\n-
              Технического задания для реализации\n", "essence": "Система управления
              инвестициями с поддержкой различных типов активов (акции, облигации,\nнедвижимость,
              производственные доли), управления портфелем, анализа рисков и интеграции\nс
              экономическими сервисами.\n"}, "architecture": {"overview": "Система
              инвестиций состоит из следующих компонентов:\n1. Investment Manager
              - управление инвестициями и транзакциями\n2. Portfolio Manager - управление
              портфелями игроков\n3. Product Manager - управление инвестиционными
              продуктами\n4. Risk Manager - анализ рисков и контроль\n5. Analytics
              Manager - аналитика портфеля и рекомендации\n6. Integration Handler
              - интеграция с другими сервисами\n", "components": [{"name": "Investment
              Manager", "location": "economy-service-go (модуль investments)", "responsibility":
              "- Управление инвестиционными транзакциями (покупка, продажа)\n- Валидация
              инвестиций\n- Управление жизненным циклом инвестиций\n- Начисление дивидендов
              и выплат\n- Интеграция с wallet-service для операций\n", "port": "8085
              (economy-service-go)", "endpoints": ["POST /api/v1/economy/investments/buy
              - покупка инвестиции", "POST /api/v1/economy/investments/sell - продажа
              инвестиции", "GET /api/v1/economy/investments/positions - позиции игрока",
              "GET /api/v1/economy/investments/transactions - история транзакций"]},
              {"name": "Portfolio Manager", "location": "economy-service-go (модуль
              investments)", "responsibility": "- Управление портфелями игроков\n-
              Диверсификация активов\n- Ребалансировка портфеля\n- Шаблоны портфелей\n-
              Расчет доходности портфеля\n", "endpoints": ["GET /api/v1/economy/investments/portfolio
              - портфель игрока", "POST /api/v1/economy/investments/portfolio/rebalance
              - ребалансировка", "GET /api/v1/economy/investments/portfolio/templates
              - шаблоны портфелей", "POST /api/v1/economy/investments/portfolio/apply-template
              - применить шаблон"]}, {"name": "Product Manager", "location": "economy-service-go
              (модуль investments)", "responsibility": "- Управление инвестиционными
              продуктами\n- Каталог продуктов (акции, облигации, недвижимость, производственные
              доли)\n- Характеристики продуктов (доходность, риски)\n- Обновление
              продуктов\n", "endpoints": ["GET /api/v1/economy/investments/products
              - каталог продуктов", "GET /api/v1/economy/investments/products/{product_id}
              - продукт", "POST /api/v1/economy/investments/products - создание продукта
              (admin)"]}, {"name": "Risk Manager", "location": "economy-service-go
              (модуль investments)", "responsibility": "- Анализ рисков инвестиций\n-
              Контроль suitability (соответствие профилю игрока)\n- Margin call обработка\n-
              KYC ограничения\n- Предупреждения о рисках\n", "integration": "Интегрируется
              с character-service для проверки профиля игрока\nПубликует предупреждения
              через Event Bus\n"}, {"name": "Analytics Manager", "location": "economy-service-go
              (модуль investments)", "responsibility": "- Аналитика портфеля\n- Прогнозы
              доходности\n- Рекомендации по ребалансировке\n- Распределение активов\n-
              История доходности\n", "integration": "Интегрируется с analytics-service
              для метрик\nИспользует данные от stock-exchange и housing-system\n"},
              {"name": "Integration Handler", "location": "economy-service-go (модуль
              investments)", "responsibility": "- Интеграция с stock-exchange\n- Интеграция
              с housing-system\n- Интеграция с economy-events\n- Интеграция с guild-system\n-
              Публикация событий через Event Bus\n", "integration": "Публикует события
              через Event Bus для других сервисов\nПодписывается на события от других
              сервисов\n"}], "microservices": [{"name": "economy-service-go", "port":
              8085, "responsibility": "Основной сервис для инвестиций:\n- Управление
              инвестициями и транзакциями\n- Управление портфелями\n- Управление продуктами\n-
              Анализ рисков\n- Аналитика портфеля\n- Интеграция с другими сервисами\n",
              "components": ["Investment Manager", "Portfolio Manager", "Product Manager",
              "Risk Manager", "Analytics Manager", "Integration Handler"]}], "database_schema":
              {"tables": [{"name": "investment_products", "description": "Хранит инвестиционные
              продукты\n", "columns": ["product_id (UUID, PK)", "product_type (VARCHAR,
              NOT NULL) -- ''STOCK'', ''BOND'', ''REAL_ESTATE'', ''PRODUCTION_SHARE'',
              ''COMMODITY''", "name (VARCHAR, NOT NULL)", "description (TEXT)", "issuer_id
              (UUID) -- корпорация, фракция, etc.", "expected_return (DECIMAL) --
              ожидаемая доходность", "risk_level (VARCHAR) -- ''LOW'', ''MEDIUM'',
              ''HIGH'', ''VERY_HIGH''", "min_investment (DECIMAL) -- минимальная сумма
              инвестиции", "max_investment (DECIMAL) -- максимальная сумма инвестиции",
              "dividend_rate (DECIMAL) -- ставка дивидендов", "maturity_date (TIMESTAMP)
              -- для облигаций", "status (VARCHAR, NOT NULL) -- ''ACTIVE'', ''SUSPENDED'',
              ''CLOSED''", "created_at (TIMESTAMP)", "updated_at (TIMESTAMP)"], "indexes":
              ["idx_product_type (product_type)", "idx_issuer_id (issuer_id)", "idx_status
              (status)"]}, {"name": "player_investment_positions", "description":
              "Хранит позиции игроков в инвестициях\n", "columns": ["position_id (UUID,
              PK)", "character_id (UUID, FK, NOT NULL)", "product_id (UUID, FK, NOT
              NULL)", "amount (DECIMAL, NOT NULL) -- сумма инвестиции", "quantity
              (DECIMAL) -- количество (для акций)", "purchase_price (DECIMAL, NOT
              NULL)", "current_value (DECIMAL)", "total_return (DECIMAL) -- общая
              доходность", "purchased_at (TIMESTAMP, NOT NULL)", "updated_at (TIMESTAMP)"],
              "indexes": ["idx_character_id (character_id)", "idx_product_id (product_id)",
              "idx_purchased_at (purchased_at)"]}, {"name": "investment_transactions",
              "description": "Хранит историю транзакций инвестиций\n", "columns":
              ["transaction_id (UUID, PK)", "character_id (UUID, FK, NOT NULL)", "product_id
              (UUID, FK, NOT NULL)", "transaction_type (VARCHAR, NOT NULL) -- ''BUY'',
              ''SELL'', ''DIVIDEND'', ''INTEREST''", "amount (DECIMAL, NOT NULL)",
              "quantity (DECIMAL)", "price (DECIMAL)", "fee (DECIMAL) -- комиссия",
              "executed_at (TIMESTAMP, NOT NULL)"], "indexes": ["idx_character_id
              (character_id)", "idx_product_id (product_id)", "idx_executed_at (executed_at)"]},
              {"name": "portfolio_snapshots", "description": "Хранит снимки портфелей
              для аналитики\n", "columns": ["snapshot_id (UUID, PK)", "character_id
              (UUID, FK, NOT NULL)", "total_value (DECIMAL, NOT NULL)", "total_return
              (DECIMAL)", "asset_allocation (JSONB) -- распределение активов", "risk_score
              (DECIMAL)", "recorded_at (TIMESTAMP, NOT NULL)"], "indexes": ["idx_character_id
              (character_id)", "idx_recorded_at (recorded_at)"]}]}, "data_consistency":
              {"strategy": "Strong Consistency (ACID транзакции) для критичных операций",
              "mechanisms": ["ACID транзакции для покупки/продажи инвестиций", "Оптимистичные
              блокировки (versioning) для предотвращения конфликтов", "Валидация перед
              инвестированием", "Синхронизация с другими сервисами через Event Bus",
              "Outbox Pattern для гарантированной доставки событий", "Saga Pattern
              для распределенных операций (покупка инвестиции, блокировка средств,
              начисление)"]}, "data_synchronization": {"event_sourcing": "Все изменения
              состояния инвестиций (покупка, продажа, начисление дивидендов)\nзаписываются
              как события в Event Store. Это обеспечивает полный аудит,\nвозможность
              восстановления состояния и \"time travel\" для отладки.\nПримеры событий:
              InvestmentPurchasedEvent, InvestmentSoldEvent, DividendPaidEvent.\n",
              "cqrs_pattern": "Разделение команд (покупка/продажа инвестиций) и запросов
              (получение портфеля,\nистория транзакций) для оптимизации производительности
              и масштабируемости.\nRead-модели могут быть кэшированы в Redis для быстрых
              запросов.\n", "saga_pattern": "Для распределенных транзакций, таких
              как покупка инвестиции (блокировка средств,\nсоздание позиции, начисление),
              используется Saga Pattern для обеспечения\nатомарности операций между
              Investment Service, Wallet Service и Stock Exchange.\n", "outbox_pattern":
              "Для гарантированной доставки событий в Event Bus используется Outbox
              Pattern,\nкоторый записывает события в транзакционную таблицу перед
              публикацией.\n"}, "tickrate_specification": {"investment_operations":
              {"tickrate": "Event-based (on-demand) + 1-5 Hz для обновления цен",
              "network_load": "- Покупка/продажа инвестиций: event-based, ~0.1-0.3
              events/sec\n- Обновление цен: 1-5 Hz, ~0.2-0.5 KB/sec на игрока\n- Начисление
              дивидендов: event-based, ~0.01-0.1 events/sec\n- Общий трафик: ~0.3-1
              KB/sec на игрока\n", "latency_requirements": "< 50-200ms для операций
              с инвестициями", "sync_strategy": "Strong Consistency (ACID транзакции)
              для транзакций, Eventual Consistency для цен"}}, "scalability_requirements":
              ["Горизонтальное масштабирование через economy-service", "Распределение
              нагрузки на обработку инвестиций", "Оптимизация запросов к БД (batch,
              индексы)", "Кэширование портфелей в Redis", "Периодическое обновление
              цен"]}, "subtasks": {"phase_1": {"name": "Investment Manager и Product
              Manager", "tasks": ["Реализация Investment Manager", "Реализация Product
              Manager", "CRUD операции с продуктами", "Покупка/продажа инвестиций",
              "Интеграция с wallet-service"], "estimated_effort": "5 days"}, "phase_2":
              {"name": "Portfolio Manager", "tasks": ["Реализация Portfolio Manager",
              "Управление портфелями", "Диверсификация активов", "Ребалансировка портфеля",
              "Шаблоны портфелей"], "estimated_effort": "4 days"}, "phase_3": {"name":
              "Risk Manager", "tasks": ["Реализация Risk Manager", "Анализ рисков",
              "Suitability проверки", "Margin call обработка", "KYC ограничения"],
              "estimated_effort": "4 days"}, "phase_4": {"name": "Analytics Manager",
              "tasks": ["Реализация Analytics Manager", "Аналитика портфеля", "Прогнозы
              доходности", "Рекомендации", "Интеграция с analytics-service"], "estimated_effort":
              "4 days"}, "phase_5": {"name": "Integration Handler и начисления", "tasks":
              ["Реализация Integration Handler", "Интеграция с stock-exchange", "Интеграция
              с housing-system", "Начисление дивидендов", "Публикация событий"], "estimated_effort":
              "4 days"}, "phase_6": {"name": "Тестирование и оптимизация", "tasks":
              ["Нагрузочное тестирование", "Оптимизация запросов", "Мониторинг и алерты"],
              "estimated_effort": "3 days"}, "total_estimated_effort": "24 days"},
              "diagrams": {"component_diagram": "```mermaid\ngraph TB\n    subgraph
              \"Economy Service\"\n        IM[Investment Manager]\n        PM[Portfolio
              Manager]\n        PRM[Product Manager]\n        RM[Risk Manager]\n        AM[Analytics
              Manager]\n        IH[Integration Handler]\n    end\n\n    subgraph \"Database\"\n        DB[(PostgreSQL<br/>investment_products<br/>player_investment_positions<br/>investment_transactions<br/>portfolio_snapshots)]\n    end\n\n    subgraph
              \"External Services\"\n        WS[Wallet Service]\n        SE[Stock
              Exchange]\n        HS[Housing System]\n        ES[Economy Events]\n        GS[Guild
              System]\n        AS[Analytics Service]\n        RG[Realtime Gateway]\n        EB[Event
              Bus]\n    end\n\n    subgraph \"Client\"\n        CL[UE5 Client]\n    end\n\n    CL
              -->|API requests| IM\n    CL -->|API requests| PM\n    IM --> PRM\n    IM
              --> RM\n    PM --> AM\n    PM --> RM\n    IM -->|store| DB\n    PM -->|store|
              DB\n    IM -->|transactions| WS\n    IH --> SE\n    IH --> HS\n    IH
              --> ES\n    IH --> GS\n    AM --> AS\n    IH --> EB\n    IH --> RG\n    RG
              -->|push updates| CL\n```\n", "data_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              CL as Client\n    participant IM as Investment Manager\n    participant
              PM as Portfolio Manager\n    participant RM as Risk Manager\n    participant
              WS as Wallet Service\n    participant SE as Stock Exchange\n    participant
              RG as Realtime Gateway\n\n    CL->>IM: Buy investment\n    IM->>RM:
              Check risk\n    RM->>IM: Risk OK\n    IM->>WS: Block funds\n    WS->>IM:
              Funds blocked\n    IM->>SE: Create position\n    SE->>IM: Position created\n    IM->>PM:
              Update portfolio\n    PM->>RG: Notify client\n    RG->>CL: Push update\n```\n",
              "investment_lifecycle": "```mermaid\nstateDiagram-v2\n    [*] --> Discovery:
              Product Available\n    Discovery --> Research: Player Interested\n    Research
              --> Purchase: Investment Decision\n    Purchase --> Active: Investment
              Made\n    Active --> Monitoring: Position Active\n    Monitoring -->
              Rebalance: Rebalance Needed\n    Monitoring --> Exit: Sell Decision\n    Rebalance
              --> Active: Rebalanced\n    Exit --> [*]: Investment Sold\n    Active
              --> Dividend: Dividend Paid\n    Dividend --> Active: Dividend Received\n```\n"},
              "decisions": [{"id": "adr-investments-architecture", "title": "Централизованная
              модель системы инвестиций", "status": "approved", "rationale": "Обеспечивает
              единый контроль инвестиций, портфелей и рисков.\nУпрощает интеграцию
              с другими экономическими сервисами.\n"}], "history": [{"version": "1.0.0",
              "date": "2025-11-30", "author": "Architect Agent", "changes": "Создана
              полная архитектура системы инвестиций:\n- Определены компоненты (Investment
              Manager, Portfolio Manager, Product Manager, Risk Manager, Analytics
              Manager, Integration Handler)\n- Описаны API endpoints (высокоуровнево)\n-
              Спроектированы потоки данных\n- Определена структура БД (investment_products,
              player_investment_positions, investment_transactions, portfolio_snapshots)\n-
              Спроектирована система управления портфелем\n- Спроектирована система
              анализа рисков\n- Добавлена детальная синхронизация данных (Event Sourcing,
              CQRS, Saga Pattern, Outbox Pattern)\n- Добавлена спецификация тикрейта
              для операций с инвестициями\n- Создано техническое задание\n- Разбито
              на подзадачи\n"}]}'
        - column:
            name: metadata
            value: '{"id": "investments-system-architecture", "title": "Архитектура
              системы инвестиций", "document_type": "architecture", "category": "systems",
              "status": "draft", "version": "1.0.0", "last_updated": "2025-11-30T19:30:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "investments", "backend", "economy"], "related_systems":
              ["economy-service-go", "stock-exchange", "housing-system-go"], "related_documents":
              [{"id": "economy-investments", "relation": "extends"}], "github_issue":
              228, "visibility": "internal", "audience": ["architect", "backend",
              "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\investments-system-architecture.yaml
