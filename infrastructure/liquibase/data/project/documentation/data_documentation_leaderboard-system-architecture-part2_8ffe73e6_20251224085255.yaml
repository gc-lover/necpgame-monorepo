databaseChangeLog:
- changeSet:
    id: documentation-leaderboard-system-architecture-part2-8ffe73e6
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-623886632940950'
        - column:
            name: doc_id
            value: leaderboard-system-architecture
        - column:
            name: title
            value: Архитектура системы лидербордов (Leaderboard System)
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.1.0
        - column:
            name: last_updated
            value: 2025-11-30 19:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - leaderboard
            - backend
            - world
            - rankings
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - world-service-go
            - social-service-go
            - character-service-go
            - achievement-service-go
            - gameplay-service-go
        - column:
            name: related_documents
            value: '[{"id": "backend-leaderboard-system", "relation": "extends"},
              {"id": "implementation-leaderboard-core", "relation": "references"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"<!-- Issue": null, "metadata": {"id": "leaderboard-system-architecture",
              "title": "Архитектура системы лидербордов (Leaderboard System)", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.1.0", "last_updated": "2025-11-30T19:00:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "leaderboard", "backend", "world", "rankings"], "related_systems": ["world-service-go",
              "social-service-go", "character-service-go", "achievement-service-go",
              "gameplay-service-go"], "related_documents": [{"id": "backend-leaderboard-system",
              "relation": "extends"}, {"id": "implementation-leaderboard-core", "relation":
              "references"}], "github_issue": 140, "visibility": "internal", "audience":
              ["architect", "backend", "api-designer"]}, "summary": {"problem": "Требуется
              спроектировать полную техническую архитектуру системы лидербордов\nдля
              управления глобальными, сезонными, дружественными и гильдийными рейтингами\n    -
              leaderboard-ranking (обновление позиций)\n    - leaderboard-seasons
              (управление сезонами)\n    - leaderboard-cache (кэширование)\n- Интеграция
              с Redis для hot data\n- Интеграция с PostgreSQL для персистентности\n-
              Периодическая синхронизация Redis ↔ PostgreSQL\n- Оптимизация запросов
              (индексы, кэширование)\n", "performance_requirements": ["Получение топ-100
              < 10ms (из Redis)", "Получение позиции игрока < 5ms (из Redis)", "Обновление
              позиции < 50ms", "Поддержка до 1M игроков в глобальных рейтингах", "Поддержка
              до 10K активных лидербордов"], "scalability_requirements": ["Горизонтальное
              масштабирование через world-service", "Распределение нагрузки на Redis
              кластер", "Оптимизация запросов к БД (batch, индексы)", "Кэширование
              активных лидербордов в Redis"], "caching_strategy": ["Redis для hot
              data (топ-1000, активные позиции)", "PostgreSQL для полных данных и
              истории", "Периодическая синхронизация (каждые 5 минут)", "Инвалидация
              кэша при обновлениях"], "data_consistency": {"strategy": "Eventual Consistency
              (Redis) + Strong Consistency (PostgreSQL)", "mechanisms": ["Redis для
              hot data с периодической синхронизацией", "PostgreSQL для персистентного
              хранения с ACID транзакциями", "Оптимистичные блокировки для обновления
              позиций", "Outbox Pattern для гарантированной доставки событий", "Saga
              Pattern для сезонных операций (multi-service)"]}, "data_synchronization":
              {"event_sourcing": "Все изменения рейтингов записываются как события:\n-
              ScoreUpdatedEvent - очки обновлены\n- RankChangedEvent - позиция изменена\n-
              SeasonStartedEvent - сезон начался\n- SeasonEndedEvent - сезон завершен\n\nСобытия
              хранятся в Event Store (Kafka topics) для:\n- Восстановления состояния
              рейтингов\n- Аудит-лога операций\n- Синхронизации с другими сервисами\n-
              Аналитики и мониторинга\n", "cqrs_pattern": "Разделение команд и запросов:\n-
              Write Model: Ranking Engine обрабатывает команды (update score, update
              rank)\n- Read Model: Оптимизированные представления для быстрого чтения
              рейтингов\n- Projections: Материализованные представления для частых
              запросов\n- Event Handlers: Обработка событий для обновления read-моделей\n",
              "saga_pattern": "Для сезонных операций:\n- Season Reset Saga: координация
              между world, achievement, economy сервисами\n- Reward Distribution Saga:
              распределение наград по тирам\n\nКомпенсирующие транзакции:\n- Откат
              сезонных изменений при ошибках\n- Восстановление состояния при сбоях\n",
              "outbox_pattern": "Гарантированная доставка событий:\n- Запись событий
              в outbox таблицу в той же транзакции\n- Outbox Processor публикует события
              в Event Bus\n- Retry механизм для failed событий\n- Идемпотентность
              обработки событий\n"}, "tickrate_specification": {"leaderboard_operations":
              {"tickrate": "Event-based (on-demand) + 1-5 Hz для синхронизации", "description":
              "Операции с лидербордами выполняются по требованию (event-based),\nно
              требуется периодическая синхронизация Redis ↔ PostgreSQL.\n", "network_load":
              "- Обновление очков: event-based, ~10-50 events/sec на сервер\n- Синхронизация
              Redis ↔ PostgreSQL: 1-5 updates/sec\n- Запросы лидербордов: on-demand,
              ~5-20 requests/sec\n- Общий трафик: ~0.5-1 KB/sec на игрока\n", "sync_strategy":
              "Eventual Consistency (Redis) + Strong Consistency (PostgreSQL)", "latency_requirements":
              "- Получение топ-100: < 10ms (из Redis)\n- Получение позиции игрока:
              < 5ms (из Redis)\n- Обновление позиции: < 50ms\n- Синхронизация Redis
              ↔ PostgreSQL: < 200ms (асинхронно)\n"}}}, "subtasks": [{"id": "leaderboard-manager-module",
              "title": "Реализация модуля Leaderboard Manager", "description": "Создание
              модуля управления лидербордами\nCRUD операции для лидербордов\nПолучение
              рейтингов и позиций\n", "priority": "high", "estimated_time": "3-4 дня"},
              {"id": "score-calculator-implementation", "title": "Реализация Score
              Calculator", "description": "Реализация функций расчёта очков\nИнтеграция
              с другими сервисами\nОптимизация расчётов\n", "priority": "high", "estimated_time":
              "3-4 дня"}, {"id": "ranking-engine-development", "title": "Реализация
              Ranking Engine", "description": "Обновление позиций игроков\nСинхронизация
              Redis ↔ PostgreSQL\nБатчевая обработка обновлений\n", "priority": "high",
              "estimated_time": "4-5 дней"}, {"id": "season-manager-implementation",
              "title": "Реализация Season Manager", "description": "Управление сезонами\nСезонные
              сбросы и архивация\nРаспределение наград\n", "priority": "high", "estimated_time":
              "3-4 дня"}, {"id": "cache-manager-development", "title": "Реализация
              Cache Manager", "description": "Управление кэшированием в Redis\nОперации
              с sorted sets\nИнвалидация кэша\n", "priority": "high", "estimated_time":
              "2-3 дня"}, {"id": "redis-postgresql-sync", "title": "Синхронизация
              Redis ↔ PostgreSQL", "description": "Периодическая синхронизация данных\nБатчевая
              запись в PostgreSQL\nОбработка конфликтов\n", "priority": "high", "estimated_time":
              "2-3 дня"}, {"id": "database-optimization", "title": "Оптимизация БД
              и запросов", "description": "Создание индексов\nОптимизация запросов\nМатериализованные
              представления\n", "priority": "medium", "estimated_time": "1-2 дня"},
              {"id": "api-endpoints", "title": "Реализация REST API endpoints", "description":
              "Создание всех endpoints для лидербордов\nИнтеграция с существующим
              API world-service\n", "priority": "high", "estimated_time": "2-3 дня"},
              {"id": "integration-testing", "title": "Интеграционное тестирование",
              "description": "Тесты управления лидербордами\nТесты расчёта очков\nТесты
              синхронизации Redis ↔ PostgreSQL\nТесты сезонных сбросов\n", "priority":
              "high", "estimated_time": "2-3 дня"}], "diagrams": {"component_diagram":
              "```mermaid\ngraph TB\n    subgraph \"World Service\"\n        LM[Leaderboard
              Manager]\n        SC[Score Calculator]\n        RE[Ranking Engine]\n        SM[Season
              Manager]\n        CM[Cache Manager]\n    end\n\n    subgraph \"Storage\"\n        Redis[(Redis<br/>Sorted
              Sets)]\n        DB[(PostgreSQL<br/>leaderboards<br/>leaderboard_entries<br/>leaderboard_snapshots)]\n    end\n\n    subgraph
              \"External Services\"\n        CS[Character Service]\n        AS[Achievement
              Service]\n        ES[Economy Service]\n        SS[Social Service]\n        GS[Gameplay
              Service]\n        RG[Realtime Gateway]\n    end\n\n    subgraph \"Client\"\n        CL[UE5
              Client]\n    end\n\n    CL -->|API requests| LM\n    LM --> CM\n    LM
              --> RE\n    RE --> CM\n    RE --> SC\n    SC --> CS\n    SC --> AS\n    SC
              --> ES\n    SC --> GS\n    CM -->|read/write| Redis\n    RE -->|sync|
              DB\n    SM -->|snapshots| DB\n    LM -->|friends/guilds| SS\n    RE
              -->|updates| RG\n    RG -->|push events| CL\n```\n", "data_flow_diagram":
              "```mermaid\nsequenceDiagram\n    participant E as Event\n    participant
              SC as Score Calculator\n    participant RE as Ranking Engine\n    participant
              CM as Cache Manager\n    participant R as Redis\n    participant DB
              as PostgreSQL\n    participant RG as Realtime Gateway\n    participant
              C as Client\n\n    E->>SC: Game event\n    SC->>SC: Calculate score\n    SC->>RE:
              Update ranking\n    RE->>CM: Update cache\n    CM->>R: ZADD score\n    RE->>DB:
              Batch sync\n    RE->>RG: Notify change\n    RG->>C: Push update\n\n    C->>CM:
              Query leaderboard\n    CM->>R: ZRANGE top-100\n    R->>CM: Return data\n    CM->>C:
              Return leaderboard\n```\n", "season_lifecycle": "```mermaid\ngraph LR\n    subgraph
              \"Season Lifecycle\"\n        S1[Season Start]\n        S2[Active Season]\n        S3[Season
              End]\n        S4[Snapshot Created]\n        S5[Rewards Distributed]\n        S6[Archived]\n    end\n\n    S1
              -->|start| S2\n    S2 -->|end date| S3\n    S3 -->|create snapshot|
              S4\n    S4 -->|distribute rewards| S5\n    S5 -->|archive| S6\n    S6
              -->|new season| S1\n```\n"}, "decisions": [{"id": "adr-leaderboard-architecture",
              "summary": "Выбрана модульная архитектура внутри world-service-go для
              обеспечения\nтесной интеграции с мировыми системами и глобальными данными.\n"},
              {"id": "adr-redis-postgresql", "summary": "Использование Redis для hot
              data (топ-1000, активные позиции) и PostgreSQL\nдля персистентного хранения
              обеспечивает баланс между производительностью\nи надёжностью.\n"}, {"id":
              "adr-scoring-functions", "summary": "Модульная система расчёта очков
              позволяет легко добавлять новые метрики\nи типы лидербордов без изменения
              основной архитектуры.\n"}, {"id": "adr-seasonal-resets", "summary":
              "Сезонные сбросы с архивацией и наградами обеспечивают долгосрочную\nмотивацию
              игроков и справедливое соревнование.\n"}, {"id": "adr-realtime-updates",
              "summary": "Real-time обновления через Realtime Gateway обеспечивают
              актуальность\nданных для игроков и повышают вовлечённость.\n"}], "validation":
              {"architecture_complete": true, "components_defined": true, "microservices_identified":
              true, "api_endpoints_described": true, "technical_specification_ready":
              true, "subtasks_defined": true}, "next_steps": ["Передача задачи агенту
              API Designer для создания OpenAPI спецификации", "Детализация API endpoints",
              "Создание request/response схем", "Определение стратегии кэширования"],
              "history": [{"version": "1.1.0", "date": "2025-11-30", "author": "Architect
              Agent", "changes": "Обновлена архитектура системы лидербордов:\n- Добавлена
              детальная синхронизация данных (Event Sourcing, CQRS, Saga Pattern,
              Outbox Pattern)\n- Добавлена спецификация тикрейта для операций с лидербордами\n-
              Расширен раздел data_consistency с механизмами синхронизации\n- Добавлены
              требования к задержке для операций\n"}, {"version": "1.0.0", "date":
              "2025-11-22", "author": "Architect Agent", "changes": "Создана полная
              архитектура системы лидербордов:\n- Определены компоненты (Leaderboard
              Manager, Score Calculator, Ranking Engine, Season Manager, Cache Manager)\n-
              Описаны API endpoints (высокоуровнево)\n- Спроектированы потоки данных\n-
              Определена структура БД и Redis\n- Спроектирована система обновления
              рейтингов\n- Определена стратегия кэширования\n- Создано техническое
              задание\n- Разбито на подзадачи\n"}]}'
        - column:
            name: metadata
            value: '{"id": "leaderboard-system-architecture", "title": "Архитектура
              системы лидербордов (Leaderboard System)", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.1.0", "last_updated":
              "2025-11-30T19:00:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "leaderboard", "backend",
              "world", "rankings"], "related_systems": ["world-service-go", "social-service-go",
              "character-service-go", "achievement-service-go", "gameplay-service-go"],
              "related_documents": [{"id": "backend-leaderboard-system", "relation":
              "extends"}, {"id": "implementation-leaderboard-core", "relation": "references"}],
              "github_issue": 140, "visibility": "internal", "audience": ["architect",
              "backend", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\leaderboard-system-architecture-part2.yaml
