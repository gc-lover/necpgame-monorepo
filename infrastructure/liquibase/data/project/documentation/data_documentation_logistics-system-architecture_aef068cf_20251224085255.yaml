databaseChangeLog:
- changeSet:
    id: documentation-logistics-system-architecture-aef068cf
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '5934424675461529'
        - column:
            name: doc_id
            value: logistics-system-architecture
        - column:
            name: title
            value: Архитектура системы логистики и перевозок
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-11-30 19:35:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - logistics
            - backend
            - economy
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - economy-service-go
            - logistics-service-go
            - insurance-service-go
        - column:
            name: related_documents
            value: '[{"id": "economy-logistics", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "logistics-system-architecture", "title":
              "Архитектура системы логистики и перевозок", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-11-30T19:35:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "logistics", "backend",
              "economy"], "related_systems": ["economy-service-go", "logistics-service-go",
              "insurance-service-go"], "related_documents": [{"id": "economy-logistics",
              "relation": "extends"}], "github_issue": 230, "visibility": "internal",
              "audience": ["architect", "backend", "api-designer"]}, "summary": {"problem":
              "Требуется спроектировать полную техническую архитектуру системы логистики\nдля
              перемещения товаров между регионами с учётом рисков, страхования,\nэскорта
              и мониторинга SLA.\n", "goal": "Создать архитектурную схему системы
              логистики с определением:\n- Компонентов системы (микросервисы, модули)\n-
              API endpoints (высокоуровнево)\n- Потоков данных и интеграций\n- Технического
              задания для реализации\n", "essence": "Система управления логистикой
              с поддержкой различных типов транспорта, маршрутов,\nуправления рисками,
              страхования, эскорта и мониторинга SLA.\n"}, "architecture": {"overview":
              "Система логистики состоит из следующих компонентов:\n1. Shipment Manager
              - управление перевозками и их жизненным циклом\n2. Route Manager - управление
              маршрутами и расчет стоимости\n3. Transport Manager - управление типами
              транспорта\n4. Risk Engine - обработка рисков и инцидентов\n5. Insurance
              Manager - управление страхованием\n6. Escort Manager - управление эскортом
              и конвоями\n7. SLA Monitor - мониторинг SLA и уведомления\n8. Integration
              Handler - интеграция с другими сервисами\n", "components": [{"name":
              "Shipment Manager", "location": "logistics-service-go (модуль shipments)",
              "responsibility": "- Управление жизненным циклом перевозок (DRAFT, SCHEDULED,
              IN_TRANSIT, DELAYED, DELIVERED, LOST)\n- CRUD операции с перевозками\n-
              Валидация перевозок\n- Трекинг перевозок\n- Интеграция с wallet-service
              для оплаты\n", "port": "8088 (logistics-service-go)", "endpoints": ["POST
              /api/v1/logistics/shipments/quote - расчет стоимости перевозки", "POST
              /api/v1/logistics/shipments - создание перевозки", "GET /api/v1/logistics/shipments/{shipment_id}
              - получение перевозки", "GET /api/v1/logistics/shipments - список перевозок
              игрока", "PUT /api/v1/logistics/shipments/{shipment_id} - обновление
              перевозки", "DELETE /api/v1/logistics/shipments/{shipment_id} - отмена
              перевозки", "GET /api/v1/logistics/shipments/{shipment_id}/track - трекинг
              перевозки"]}, {"name": "Route Manager", "location": "logistics-service-go
              (модуль routes)", "responsibility": "- Управление маршрутами (локальные,
              региональные, глобальные)\n- Расчет расстояний и времени доставки\n-
              Расчет стоимости перевозки\n- Оптимизация маршрутов\n- Динамическая
              смена маршрутов при рисках\n", "endpoints": ["GET /api/v1/logistics/routes
              - список маршрутов", "GET /api/v1/logistics/routes/{route_id} - маршрут",
              "POST /api/v1/logistics/routes/calculate - расчет маршрута"]}, {"name":
              "Transport Manager", "location": "logistics-service-go (модуль transport)",
              "responsibility": "- Управление типами транспорта (наземный, воздушный,
              железнодорожный, курьерский)\n- Характеристики транспорта (скорость,
              вместимость, стоимость)\n- Доступность транспорта\n- Бронирование транспорта\n"},
              {"name": "Risk Engine", "location": "logistics-service-go (модуль risks)",
              "responsibility": "- Обработка рисков перевозки (атаки бандитов, аварии,
              таможенные задержки, погода)\n- Вероятностные модели рисков\n- Обработка
              инцидентов\n- Расчет вероятности успешной доставки\n- Интеграция с economy-events
              для динамических рисков\n", "integration": "Интегрируется с economy-events
              для получения информации о рисках\nПубликует события инцидентов через
              Event Bus\n"}, {"name": "Insurance Manager", "location": "logistics-service-go
              (модуль insurance)", "responsibility": "- Управление страховыми планами
              (basic, premium, full)\n- Расчет стоимости страхования\n- Обработка
              страховых выплат\n- Интеграция с insurance-service\n", "integration":
              "Интегрируется с insurance-service для обработки страховых выплат\n"},
              {"name": "Escort Manager", "location": "logistics-service-go (модуль
              escort)", "responsibility": "- Управление эскортом и конвоями\n- Расчет
              стоимости эскорта\n- Влияние эскорта на вероятность атак\n- Бронированный
              транспорт\n", "integration": "Интегрируется с character-service для
              найма эскорта\n"}, {"name": "SLA Monitor", "location": "logistics-service-go
              (модуль monitoring)", "responsibility": "- Мониторинг SLA перевозок\n-
              KPI метрики (время доставки, успешность, задержки)\n- Алерты при отклонениях
              SLA\n- Отчеты о перевозках\n", "integration": "Интегрируется с analytics-service
              для метрик\nПубликует события мониторинга через Event Bus\n"}, {"name":
              "Integration Handler", "location": "logistics-service-go (модуль integration)",
              "responsibility": "- Интеграция с economy-service\n- Интеграция с insurance-service\n-
              Интеграция с economy-events\n- Интеграция с character-service\n- Публикация
              событий через Event Bus\n", "integration": "Публикует события через
              Event Bus для других сервисов\nПодписывается на события от других сервисов\n"}],
              "microservices": [{"name": "logistics-service-go", "port": 8088, "responsibility":
              "Основной сервис для логистики:\n- Управление перевозками и их жизненным
              циклом\n- Управление маршрутами и транспортом\n- Обработка рисков и
              инцидентов\n- Управление страхованием и эскортом\n- Мониторинг SLA\n-
              Интеграция с другими сервисами\n", "components": ["Shipment Manager",
              "Route Manager", "Transport Manager", "Risk Engine", "Insurance Manager",
              "Escort Manager", "SLA Monitor", "Integration Handler"]}], "database_schema":
              {"tables": [{"name": "transport_shipments", "description": "Хранит перевозки
              товаров\n", "columns": ["shipment_id (UUID, PK)", "character_id (UUID,
              FK, NOT NULL)", "route_id (UUID, FK, NOT NULL)", "transport_type (VARCHAR,
              NOT NULL) -- ''GROUND'', ''AIR'', ''RAIL'', ''COURIER'', ''PLAYER_PICKUP''",
              "cargo_items (JSONB, NOT NULL) -- список товаров", "cargo_weight (DECIMAL,
              NOT NULL)", "cargo_value (DECIMAL, NOT NULL)", "origin_location (VARCHAR,
              NOT NULL)", "destination_location (VARCHAR, NOT NULL)", "insurance_plan
              (VARCHAR) -- ''BASIC'', ''PREMIUM'', ''FULL''", "escort_level (VARCHAR)
              -- ''NONE'', ''BASIC'', ''ARMORED''", "status (VARCHAR, NOT NULL) --
              ''DRAFT'', ''SCHEDULED'', ''IN_TRANSIT'', ''DELAYED'', ''DELIVERED'',
              ''LOST''", "estimated_delivery (TIMESTAMP)", "actual_delivery (TIMESTAMP)",
              "cost (DECIMAL, NOT NULL)", "insurance_cost (DECIMAL)", "escort_cost
              (DECIMAL)", "created_at (TIMESTAMP)", "updated_at (TIMESTAMP)"], "indexes":
              ["idx_character_id (character_id)", "idx_route_id (route_id)", "idx_status
              (status)", "idx_estimated_delivery (estimated_delivery)"]}, {"name":
              "transport_routes", "description": "Хранит маршруты перевозок\n", "columns":
              ["route_id (UUID, PK)", "origin_location (VARCHAR, NOT NULL)", "destination_location
              (VARCHAR, NOT NULL)", "route_type (VARCHAR, NOT NULL) -- ''LOCAL'',
              ''REGIONAL'', ''GLOBAL''", "distance (DECIMAL, NOT NULL)", "base_cost
              (DECIMAL, NOT NULL)", "base_risk (DECIMAL, NOT NULL)", "estimated_time
              (INTEGER) -- в минутах", "available_transports (JSONB) -- доступные
              типы транспорта", "created_at (TIMESTAMP)", "updated_at (TIMESTAMP)"],
              "indexes": ["idx_origin_destination (origin_location, destination_location)",
              "idx_route_type (route_type)"]}, {"name": "shipment_incidents", "description":
              "Хранит инциденты перевозок\n", "columns": ["incident_id (UUID, PK)",
              "shipment_id (UUID, FK, NOT NULL)", "incident_type (VARCHAR, NOT NULL)
              -- ''BANDIT_ATTACK'', ''ACCIDENT'', ''CUSTOMS_DELAY'', ''WEATHER''",
              "severity (VARCHAR, NOT NULL) -- ''LOW'', ''MEDIUM'', ''HIGH'', ''CRITICAL''",
              "damage_amount (DECIMAL)", "resolved_at (TIMESTAMP)", "created_at (TIMESTAMP,
              NOT NULL)"], "indexes": ["idx_shipment_id (shipment_id)", "idx_incident_type
              (incident_type)", "idx_created_at (created_at)"]}, {"name": "shipment_tracking",
              "description": "Хранит историю трекинга перевозок\n", "columns": ["tracking_id
              (UUID, PK)", "shipment_id (UUID, FK, NOT NULL)", "location (VARCHAR,
              NOT NULL)", "status (VARCHAR, NOT NULL)", "timestamp (TIMESTAMP, NOT
              NULL)"], "indexes": ["idx_shipment_id (shipment_id)", "idx_timestamp
              (timestamp)"]}]}, "data_consistency": {"strategy": "Strong Consistency
              (ACID транзакции) для критичных операций", "mechanisms": ["ACID транзакции
              для создания и обновления перевозок", "Оптимистичные блокировки (versioning)
              для предотвращения конфликтов", "Валидация перед созданием перевозки",
              "Синхронизация с другими сервисами через Event Bus", "Outbox Pattern
              для гарантированной доставки событий", "Saga Pattern для распределенных
              операций (создание перевозки, оплата, страхование)"]}, "data_synchronization":
              {"event_sourcing": "Все изменения состояния перевозок (создание, обновление
              статуса, инциденты)\nзаписываются как события в Event Store. Это обеспечивает
              полный аудит,\nвозможность восстановления состояния и \"time travel\"
              для отладки.\nПримеры событий: ShipmentCreatedEvent, ShipmentStatusChangedEvent,
              IncidentOccurredEvent.\n", "cqrs_pattern": "Разделение команд (создание
              перевозки, обновление статуса) и запросов (получение перевозки,\nтрекинг)
              для оптимизации производительности и масштабируемости.\nRead-модели
              могут быть кэшированы в Redis для быстрых запросов.\n", "saga_pattern":
              "Для распределенных транзакций, таких как создание перевозки (блокировка
              средств,\nсоздание перевозки, оплата страхования, бронирование транспорта),
              используется\nSaga Pattern для обеспечения атомарности операций между
              Logistics Service,\nWallet Service и Insurance Service.\n", "outbox_pattern":
              "Для гарантированной доставки событий в Event Bus используется Outbox
              Pattern,\nкоторый записывает события в транзакционную таблицу перед
              публикацией.\n"}, "tickrate_specification": {"logistics_operations":
              {"tickrate": "Event-based (on-demand) + 1-5 Hz для обновления статусов",
              "network_load": "- Создание/обновление перевозок: event-based, ~0.1-0.3
              events/sec\n- Обновление статусов: 1-5 Hz, ~0.2-0.5 KB/sec на игрока\n-
              Трекинг перевозок: 1-5 Hz, ~0.1-0.3 KB/sec на игрока\n- Общий трафик:
              ~0.4-1.1 KB/sec на игрока\n", "latency_requirements": "< 50-200ms для
              операций с перевозками", "sync_strategy": "Strong Consistency (ACID
              транзакции) для создания перевозок, Eventual Consistency для трекинга"}},
              "scalability_requirements": ["Горизонтальное масштабирование через logistics-service",
              "Распределение нагрузки на обработку перевозок", "Оптимизация запросов
              к БД (batch, индексы)", "Кэширование маршрутов в Redis", "WebSocket
              для realtime трекинга"]}, "subtasks": {"phase_1": {"name": "Shipment
              Manager и Route Manager", "tasks": ["Реализация Shipment Manager", "Реализация
              Route Manager", "CRUD операции с перевозками", "Расчет маршрутов и стоимости",
              "Управление жизненным циклом перевозок"], "estimated_effort": "5 days"},
              "phase_2": {"name": "Transport Manager и Risk Engine", "tasks": ["Реализация
              Transport Manager", "Реализация Risk Engine", "Обработка рисков", "Вероятностные
              модели", "Интеграция с economy-events"], "estimated_effort": "5 days"},
              "phase_3": {"name": "Insurance Manager и Escort Manager", "tasks": ["Реализация
              Insurance Manager", "Реализация Escort Manager", "Интеграция с insurance-service",
              "Расчет стоимости страхования и эскорта"], "estimated_effort": "4 days"},
              "phase_4": {"name": "SLA Monitor и трекинг", "tasks": ["Реализация SLA
              Monitor", "Трекинг перевозок", "KPI метрики", "Алерты и уведомления",
              "WebSocket для realtime обновлений"], "estimated_effort": "4 days"},
              "phase_5": {"name": "Integration Handler и оптимизация", "tasks": ["Реализация
              Integration Handler", "Интеграция с другими сервисами", "Публикация
              событий", "Оптимизация маршрутов"], "estimated_effort": "4 days"}, "phase_6":
              {"name": "Тестирование и оптимизация", "tasks": ["Нагрузочное тестирование",
              "Оптимизация запросов", "Мониторинг и алерты"], "estimated_effort":
              "3 days"}, "total_estimated_effort": "25 days"}, "diagrams": {"component_diagram":
              "```mermaid\ngraph TB\n    subgraph \"Logistics Service\"\n        SM[Shipment
              Manager]\n        RM[Route Manager]\n        TM[Transport Manager]\n        RE[Risk
              Engine]\n        IM[Insurance Manager]\n        EM[Escort Manager]\n        SLAM[SLA
              Monitor]\n        IH[Integration Handler]\n    end\n\n    subgraph \"Database\"\n        DB[(PostgreSQL<br/>transport_shipments<br/>transport_routes<br/>shipment_incidents<br/>shipment_tracking)]\n    end\n\n    subgraph
              \"External Services\"\n        ES[Economy Service]\n        IS[Insurance
              Service]\n        CS[Character Service]\n        WS[Wallet Service]\n        EES[Economy
              Events]\n        AS[Analytics Service]\n        RG[Realtime Gateway]\n        EB[Event
              Bus]\n    end\n\n    subgraph \"Client\"\n        CL[UE5 Client]\n    end\n\n    CL
              -->|API requests| SM\n    SM --> RM\n    SM --> TM\n    SM --> RE\n    SM
              --> IM\n    SM --> EM\n    SLAM --> SM\n    SM -->|store| DB\n    RM
              -->|store| DB\n    SM -->|transactions| WS\n    IM --> IS\n    EM -->
              CS\n    RE --> EES\n    SLAM --> AS\n    IH --> EB\n    IH --> RG\n    RG
              -->|push updates| CL\n```\n", "data_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              CL as Client\n    participant SM as Shipment Manager\n    participant
              RM as Route Manager\n    participant RE as Risk Engine\n    participant
              WS as Wallet Service\n    participant IS as Insurance Service\n    participant
              RG as Realtime Gateway\n\n    CL->>SM: Create shipment\n    SM->>RM:
              Calculate route\n    RM->>SM: Route calculated\n    SM->>RE: Check risks\n    RE->>SM:
              Risks assessed\n    SM->>IS: Calculate insurance\n    IS->>SM: Insurance
              cost\n    SM->>WS: Block funds\n    WS->>SM: Funds blocked\n    SM->>SM:
              Create shipment\n    SM->>RG: Notify client\n    RG->>CL: Push update\n```\n",
              "shipment_lifecycle": "```mermaid\nstateDiagram-v2\n    [*] --> DRAFT:
              Shipment Created\n    DRAFT --> SCHEDULED: Scheduled\n    SCHEDULED
              --> IN_TRANSIT: Started\n    IN_TRANSIT --> DELIVERED: Delivered\n    IN_TRANSIT
              --> DELAYED: Delayed\n    DELAYED --> IN_TRANSIT: Resumed\n    DELAYED
              --> LOST: Lost\n    IN_TRANSIT --> LOST: Lost\n    DELIVERED --> [*]\n    LOST
              --> [*]\n```\n"}, "decisions": [{"id": "adr-logistics-architecture",
              "title": "Централизованная модель системы логистики", "status": "approved",
              "rationale": "Обеспечивает единый контроль перевозок, маршрутов и рисков.\nУпрощает
              интеграцию с другими экономическими сервисами.\n"}], "history": [{"version":
              "1.0.0", "date": "2025-11-30", "author": "Architect Agent", "changes":
              "Создана полная архитектура системы логистики:\n- Определены компоненты
              (Shipment Manager, Route Manager, Transport Manager, Risk Engine, Insurance
              Manager, Escort Manager, SLA Monitor, Integration Handler)\n- Описаны
              API endpoints (высокоуровнево)\n- Спроектированы потоки данных\n- Определена
              структура БД (transport_shipments, transport_routes, shipment_incidents,
              shipment_tracking)\n- Спроектирована система управления перевозками\n-
              Спроектирована система обработки рисков\n- Добавлена детальная синхронизация
              данных (Event Sourcing, CQRS, Saga Pattern, Outbox Pattern)\n- Добавлена
              спецификация тикрейта для операций с логистикой\n- Создано техническое
              задание\n- Разбито на подзадачи\n"}]}'
        - column:
            name: metadata
            value: '{"id": "logistics-system-architecture", "title": "Архитектура
              системы логистики и перевозок", "document_type": "architecture", "category":
              "systems", "status": "draft", "version": "1.0.0", "last_updated": "2025-11-30T19:35:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "logistics", "backend", "economy"], "related_systems":
              ["economy-service-go", "logistics-service-go", "insurance-service-go"],
              "related_documents": [{"id": "economy-logistics", "relation": "extends"}],
              "github_issue": 230, "visibility": "internal", "audience": ["architect",
              "backend", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\logistics-system-architecture.yaml
