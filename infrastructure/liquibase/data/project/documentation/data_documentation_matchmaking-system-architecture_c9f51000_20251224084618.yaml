databaseChangeLog:
- changeSet:
    id: documentation-matchmaking-system-architecture-c9f51000
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '5907021213606407'
        - column:
            name: doc_id
            value: matchmaking-system-architecture
        - column:
            name: title
            value: Архитектура системы матчмейкинга (Matchmaking System)
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.1.0
        - column:
            name: last_updated
            value: 2025-11-30 19:40:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - matchmaking
            - backend
            - gameplay
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - matchmaking-go
            - gameplay-service-go
            - character-service-go
            - party-service-go
        - column:
            name: related_documents
            value: '[{"id": "backend-matchmaking-queue", "relation": "extends"}, {"id":
              "backend-matchmaking-algorithm", "relation": "extends"}, {"id": "backend-matchmaking-rating",
              "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "matchmaking-system-architecture", "title":
              "Архитектура системы матчмейкинга (Matchmaking System)", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.1.0", "last_updated": "2025-11-30T19:40:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "matchmaking", "backend", "gameplay"], "related_systems": ["matchmaking-go",
              "gameplay-service-go", "character-service-go", "party-service-go"],
              "related_documents": [{"id": "backend-matchmaking-queue", "relation":
              "extends"}, {"id": "backend-matchmaking-algorithm", "relation": "extends"},
              {"id": "backend-matchmaking-rating", "relation": "extends"}], "github_issue":
              150, "visibility": "internal", "audience": ["architect", "backend",
              "api-designer"]}, "summary": {"problem": "Требуется спроектировать полную
              техническую архитектуру системы матчмейкинга\nдля подбора игроков в
              PvP, PvE и рейды с учётом рейтинга, очередей, алгоритмов\nподбора и
              балансировки команд.\n", "goal": "Создать архитектурную схему системы
              матчмейкинга с определением:\n- Компонентов системы (микросервисы, модули)\n-
              API endpoints (высокоуровнево)\n- Потоков данных и интеграций\n- Системы
              очередей\n- Алгоритмов подбора\n- Системы рейтинга\n- Технического задания
              для реализации\n", "essence": "Система матчмейкинга для подбора игроков
              в различные игровые режимы с учётом\nрейтинга, ролей, балансировки команд
              и качества матча.\n"}, "architecture": {"overview": "Система матчмейкинга
              состоит из семи основных компонентов:\n1. Queue Manager - управление
              очередями\n2. Matchmaking Engine - алгоритмы подбора\n3. Rating System
              - система рейтинга\n4. Team Balancer - балансировка команд\n5. Match
              Quality Calculator - расчёт качества матча\n6. Anti-Smurf Detector -
              обнаружение смурфов\n7. Session Creator - создание игровых сессий\n",
              "components": [{"name": "Queue Manager", "location": "matchmaking-go
              (модуль queue)", "responsibility": "- Управление очередями матчмейкинга\n-
              Добавление/удаление игроков из очереди\n- Расширение диапазона поиска\n-
              Приоритеты ожидания\n- Интеграция с Redis для hot data\n", "queue_types":
              "- PvP: подбор для PvP матчей\n- PvE: подбор для PvE контента\n- Raid:
              подбор для рейдов\n- Ranked: ранговые матчи\n- Casual: казуальные матчи\n",
              "endpoints": ["POST /api/v1/matchmaking/queue/join - вход в очередь",
              "DELETE /api/v1/matchmaking/queue/leave - выход из очереди", "GET /api/v1/matchmaking/queue/status
              - статус очереди", "GET /api/v1/matchmaking/queue/estimate - оценка
              времени ожидания"]}, {"name": "Matchmaking Engine", "location": "matchmaking-go
              (модуль matching)", "responsibility": "- Алгоритмы подбора игроков\n-
              Поиск кандидатов по рейтингу\n- Проверка совместимости\n- Формирование
              команд\n- Обработка различных режимов\n", "matching_algorithms": "-
              PvP: подбор по рейтингу с балансировкой\n- PvE: подбор с обязательными
              ролями\n- Raid: подбор больших групп\n- Party: подбор для существующих
              групп\n", "endpoints": ["POST /api/v1/matchmaking/match/find - поиск
              матча", "GET /api/v1/matchmaking/match/{match_id} - информация о матче",
              "POST /api/v1/matchmaking/match/{match_id}/accept - принятие матча",
              "POST /api/v1/matchmaking/match/{match_id}/decline - отклонение матча"]},
              {"name": "Rating System", "location": "matchmaking-go (модуль rating)",
              "responsibility": "- Управление рейтингами игроков\n- Расчёт MMR/ELO\n-
              Обновление рейтинга после матча\n- Управление сезонными рейтингами\n-
              Определение лиг и тиров\n", "rating_formula": "- ELO формула с K-факторами\n-
              Учёт силы противника\n- Streak бонусы/штрафы\n- Сезонные сбросы\n",
              "rating_tiers": "- Bronze, Silver, Gold, Platinum, Diamond, Master,
              Grandmaster\n", "endpoints": ["GET /api/v1/matchmaking/rating/{player_id}
              - рейтинг игрока", "GET /api/v1/matchmaking/rating/leaderboard - лидерборд
              рейтинга", "POST /api/v1/matchmaking/rating/update - обновление рейтинга"]},
              {"name": "Team Balancer", "location": "matchmaking-go (модуль balancing)",
              "responsibility": "- Балансировка команд\n- Snake draft алгоритм\n-
              Распределение ролей\n- Проверка баланса силы команд\n- Оптимизация состава
              команд\n", "balancing_strategies": "- Snake draft: поочерёдный выбор\n-
              Role-based: по ролям\n- Rating-based: по рейтингу\n- Skill-based: по
              навыкам\n", "endpoints": ["POST /api/v1/matchmaking/balance/calculate
              - расчёт баланса", "POST /api/v1/matchmaking/balance/redistribute -
              перераспределение"]}, {"name": "Match Quality Calculator", "location":
              "matchmaking-go (модуль quality)", "responsibility": "- Расчёт качества
              матча\n- Match Quality Score (MQS)\n- Учёт различных факторов\n- Оптимизация
              качества подбора\n", "quality_factors": "- Разброс рейтинга\n- Время
              ожидания\n- Латентность игроков\n- Баланс команд\n- Роли и композиция\n",
              "endpoints": ["GET /api/v1/matchmaking/quality/{match_id} - качество
              матча", "POST /api/v1/matchmaking/quality/calculate - расчёт качества"]},
              {"name": "Anti-Smurf Detector", "location": "matchmaking-go (модуль
              anti-smurf)", "responsibility": "- Обнаружение смурфов\n- Анализ статистики
              игрока\n- Проверка подозрительных паттернов\n- Применение ограничений\n",
              "detection_methods": "- Анализ винрейта\n- Проверка времени игры\n-
              Сравнение с ожидаемым рейтингом\n- Выявление аномалий\n", "endpoints":
              ["POST /api/v1/matchmaking/anti-smurf/check - проверка игрока", "GET
              /api/v1/matchmaking/anti-smurf/status/{player_id} - статус проверки"]},
              {"name": "Session Creator", "location": "matchmaking-go (модуль session)",
              "responsibility": "- Создание игровых сессий\n- Интеграция с gameplay-service\n-
              Настройка параметров матча\n- Уведомление игроков\n", "session_features":
              "- Создание игровой сессии\n- Настройка параметров\n- Приглашение игроков\n-
              Обработка подключений\n", "endpoints": ["POST /api/v1/matchmaking/session/create
              - создание сессии", "GET /api/v1/matchmaking/session/{session_id} -
              информация о сессии"]}], "data_flow": {"queue_join": "1. Игрок запрашивает
              вход в очередь\n2. Queue Manager проверяет требования\n3. Игрок добавляется
              в очередь (Redis)\n4. Matchmaking Engine начинает поиск\n5. Находятся
              кандидаты по рейтингу\n6. Team Balancer балансирует команды\n7. Match
              Quality Calculator оценивает качество\n8. Создаётся матч\n9. Session
              Creator создаёт игровую сессию\n10. Игроки уведомляются\n", "match_found":
              "1. Matchmaking Engine находит подходящих игроков\n2. Team Balancer
              балансирует команды\n3. Match Quality Calculator рассчитывает качество\n4.
              Если качество приемлемо - создаётся матч\n5. Игроки получают уведомление\n6.
              Игроки принимают/отклоняют матч\n7. При принятии всеми - создаётся сессия\n8.
              Игроки подключаются к сессии\n", "rating_update": "1. Матч завершается\n2.
              Gameplay Service отправляет результаты\n3. Rating System получает результаты\n4.
              Рассчитывается изменение рейтинга\n5. Обновляется рейтинг всех участников\n6.
              Обновляются лиги и тиры\n7. Обновляется лидерборд\n"}, "integrations":
              {"with_gameplay_service": "- Получение результатов матчей\n- Создание
              игровых сессий\n- Интеграция с боевыми системами\n", "with_character_service":
              "- Получение данных персонажей\n- Роли и классы\n- Статистика игрока\n",
              "with_party_service": "- Подбор для групп\n- Информация о составе группы\n-
              Групповые очереди\n", "with_realtime_gateway": "- Уведомления о найденном
              матче\n- Обновления статуса очереди\n- Синхронизация состояния\n"},
              "data_consistency": {"strategy": "Eventual Consistency (Redis) + Strong
              Consistency (PostgreSQL) для критичных операций", "mechanisms": ["ACID
              транзакции для обновления рейтинга и создания матчей", "Оптимистичные
              блокировки (versioning) для предотвращения конфликтов", "Валидация перед
              созданием матча", "Синхронизация с другими сервисами через Event Bus",
              "Outbox Pattern для гарантированной доставки событий", "Saga Pattern
              для распределенных операций (создание матча, обновление рейтинга)"]},
              "data_synchronization": {"event_sourcing": "Все изменения состояния
              матчмейкинга (вход в очередь, найденный матч, обновление рейтинга)\nзаписываются
              как события в Event Store. Это обеспечивает полный аудит,\nвозможность
              восстановления состояния и \"time travel\" для отладки.\nПримеры событий:
              PlayerJoinedQueueEvent, MatchFoundEvent, MatchAcceptedEvent, RatingUpdatedEvent.\n",
              "cqrs_pattern": "Разделение команд (вход в очередь, принятие матча,
              обновление рейтинга) и запросов\n(получение статуса очереди, рейтинг
              игрока, история матчей) для оптимизации производительности\nи масштабируемости.
              Read-модели могут быть кэшированы в Redis для быстрых запросов.\n",
              "saga_pattern": "Для распределенных транзакций, таких как создание матча
              (создание матча, уведомление игроков,\nсоздание игровой сессии), используется
              Saga Pattern для обеспечения атомарности операций\nмежду Matchmaking
              Service и Gameplay Service.\n", "outbox_pattern": "Для гарантированной
              доставки событий в Event Bus используется Outbox Pattern,\nкоторый записывает
              события в транзакционную таблицу перед публикацией.\n"}, "tickrate_specification":
              {"queue_operations": {"tickrate": "Event-based (on-demand) + 1-5 Hz
              для обновления статуса очереди", "network_load": "- Вход в очередь:
              event-based, ~0.1-0.3 events/sec на игрока\n- Выход из очереди: event-based,
              ~0.1-0.2 events/sec на игрока\n- Обновление статуса очереди: 1-5 Hz,
              ~0.1-0.3 KB/sec на игрока\n- Общий трафик: ~0.2-0.5 KB/sec на игрока\n",
              "latency_requirements": "< 50-200ms для операций с очередью", "sync_strategy":
              "Eventual Consistency для очереди (Redis), Strong Consistency для рейтинга"},
              "matchmaking_operations": {"tickrate": "Event-based (on-demand) + 1-10
              Hz для поиска матчей", "network_load": "- Поиск матча: event-based,
              ~0.1-0.5 events/sec на игрока\n- Найденный матч: event-based, ~0.1-0.2
              events/sec на игрока\n- Принятие/отклонение матча: event-based, ~0.1-0.2
              events/sec на игрока\n- Обновление статуса матча: 1-10 Hz, ~0.2-0.5
              KB/sec на игрока\n- Общий трафик: ~0.3-0.7 KB/sec на игрока\n", "latency_requirements":
              "< 100-500ms для поиска матча", "sync_strategy": "Eventual Consistency
              для поиска, Strong Consistency для создания матча"}, "rating_operations":
              {"tickrate": "Event-based (on-demand)", "network_load": "- Обновление
              рейтинга: event-based, ~0.1-0.2 events/sec на игрока\n- Получение рейтинга:
              event-based, ~0.1-0.3 requests/sec на игрока\n- Обновление лидерборда:
              event-based, ~0.1-0.2 events/sec\n- Общий трафик: ~0.1-0.3 KB/sec на
              игрока\n", "latency_requirements": "< 50-200ms для обновления рейтинга",
              "sync_strategy": "Strong Consistency (ACID транзакции) для обновления
              рейтинга"}}, "database_schema": {"tables": [{"name": "matchmaking_queues",
              "description": "Очереди матчмейкинга", "fields": [{"id": "UUID (PK)"},
              {"player_id": "UUID (FK accounts)"}, {"queue_type": "ENUM (pvp, pve,
              raid, ranked, casual)"}, {"game_mode": "VARCHAR(100)"}, {"rating": "INTEGER"},
              {"role": "VARCHAR(50) (nullable)"}, {"party_id": "UUID (FK parties,
              nullable)"}, {"status": "ENUM (waiting, matched, cancelled)"}, {"search_range":
              {"INTEGER (default": "100)"}}, {"priority": {"INTEGER (default": "0)"}},
              {"joined_at": "TIMESTAMP"}, {"matched_at": "TIMESTAMP (nullable)"}],
              "indexes": ["queue_type, status, rating", "player_id, status", "status,
              joined_at"]}, {"name": "player_ratings", "description": "Рейтинги игроков",
              "fields": [{"id": "UUID (PK)"}, {"player_id": "UUID (FK accounts)"},
              {"queue_type": "ENUM (pvp, pve, raid)"}, {"rating": {"INTEGER (default":
              "1000)"}}, {"peak_rating": "INTEGER"}, {"games_played": {"INTEGER (default":
              "0)"}}, {"wins": {"INTEGER (default": "0)"}}, {"losses": {"INTEGER (default":
              "0)"}}, {"win_streak": {"INTEGER (default": "0)"}}, {"loss_streak":
              {"INTEGER (default": "0)"}}, {"tier": "ENUM (bronze, silver, gold, platinum,
              diamond, master, grandmaster)"}, {"league": "INTEGER"}, {"season_id":
              "UUID (FK seasons, nullable)"}, {"updated_at": "TIMESTAMP"}], "indexes":
              ["player_id, queue_type (unique)", "queue_type, rating", "tier, league"]},
              {"name": "matchmaking_matches", "description": "Найденные матчи", "fields":
              [{"id": "UUID (PK)"}, {"queue_type": "ENUM (pvp, pve, raid)"}, {"game_mode":
              "VARCHAR(100)"}, {"status": "ENUM (pending, accepted, rejected, started,
              completed)"}, {"team1_players": "UUID[] (массив player_id)"}, {"team2_players":
              "UUID[] (nullable, для PvP)"}, {"match_quality_score": "DECIMAL(5,2)"},
              {"created_at": "TIMESTAMP"}, {"started_at": "TIMESTAMP (nullable)"},
              {"completed_at": "TIMESTAMP (nullable)"}], "indexes": ["status, created_at",
              "queue_type, status"]}, {"name": "matchmaking_match_players", "description":
              "Игроки в матчах", "fields": [{"id": "UUID (PK)"}, {"match_id": "UUID
              (FK matchmaking_matches)"}, {"player_id": "UUID (FK accounts)"}, {"team":
              "INTEGER (1 или 2)"}, {"role": "VARCHAR(50)"}, {"accepted": {"BOOLEAN
              (default": "false)"}}, {"accepted_at": "TIMESTAMP (nullable)"}], "indexes":
              ["match_id, player_id (unique)", "match_id, team"]}, {"name": "matchmaking_sessions",
              "description": "Игровые сессии матчмейкинга", "fields": [{"id": "UUID
              (PK)"}, {"match_id": "UUID (FK matchmaking_matches)"}, {"session_id":
              "UUID (FK game_sessions)"}, {"status": "ENUM (created, active, completed)"},
              {"created_at": "TIMESTAMP"}], "indexes": ["match_id", "session_id"]}]}},
              "technical_specification": {"backend_requirements": [{"Реализация модулей
              в matchmaking-go": ["queue (управление очередями)", "matching (алгоритмы
              подбора)", "rating (система рейтинга)", "balancing (балансировка команд)",
              "quality (качество матча)", "anti-smurf (обнаружение смурфов)", "session
              (создание сессий)"]}]}}'
        - column:
            name: metadata
            value: '{"id": "matchmaking-system-architecture", "title": "Архитектура
              системы матчмейкинга (Matchmaking System)", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.1.0", "last_updated":
              "2025-11-30T19:40:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "matchmaking", "backend",
              "gameplay"], "related_systems": ["matchmaking-go", "gameplay-service-go",
              "character-service-go", "party-service-go"], "related_documents": [{"id":
              "backend-matchmaking-queue", "relation": "extends"}, {"id": "backend-matchmaking-algorithm",
              "relation": "extends"}, {"id": "backend-matchmaking-rating", "relation":
              "extends"}], "github_issue": 150, "visibility": "internal", "audience":
              ["architect", "backend", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\matchmaking-system-architecture.yaml
