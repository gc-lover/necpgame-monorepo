databaseChangeLog:
- changeSet:
    id: documentation-progression-system-architecture-bf54ff13
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '1536764285352416'
        - column:
            name: doc_id
            value: progression-system-architecture
        - column:
            name: title
            value: Архитектура системы прогрессии (Progression System)
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-14 15:25:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - progression
            - gameplay
            - backend
        - column:
            name: topics
            value:
            - experience-system
            - level-system
            - skill-progression
            - attribute-system
        - column:
            name: related_systems
            value:
            - gameplay-service
            - character-service
            - achievement-service
            - notification-service
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "progression-backend", "relation": "implements"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - backend
            - gameplay
            - architect
        - column:
            name: risk_level
            value: medium
        - column:
            name: content
            value: '{"metadata": {"id": "progression-system-architecture", "title":
              "Архитектура системы прогрессии (Progression System)", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-12-14T15:25:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "progression", "gameplay", "backend"], "topics": ["experience-system",
              "level-system", "skill-progression", "attribute-system"], "related_systems":
              ["gameplay-service", "character-service", "achievement-service", "notification-service",
              "analytics-service"], "related_documents": [{"id": "progression-backend",
              "relation": "implements"}], "visibility": "internal", "audience": ["backend",
              "gameplay", "architect"], "risk_level": "medium"}, "summary": {"problem":
              "Необходима полная архитектурная документация для системы прогрессии
              персонажей", "goal": "Спроектировать масштабируемую систему прогрессии
              с опытом, уровнями и распределением очков", "essence": "Микросервисная
              архитектура с event-driven интеграциями для обработки опыта и прогрессии",
              "key_points": ["Модульная архитектура с разделением ответственности",
              "Event-driven система для обработки опыта из различных источников",
              "Экспоненциальные формулы расчёта опыта и уровней", "Валидация распределения
              очков с ограничениями"]}, "content": {"sections": [{"id": "system-overview",
              "title": "Обзор системы", "body": "Система прогрессии отвечает за обработку
              опыта, повышение уровней персонажей,\nраспределение очков атрибутов
              и навыков. Система интегрируется с боевой системой,\nквестами и достижениями
              для комплексного управления прогрессией игрока.\n\n**Ключевые компоненты:**\n-
              Experience Calculator: Расчёт и начисление опыта\n- Level Manager: Управление
              уровнями и требованиями\n- Point Distributor: Распределение очков атрибутов
              и навыков\n- Progression Tracker: Отслеживание прогресса и статистики\n"},
              {"id": "microservices-architecture", "title": "Микросервисная архитектура",
              "body": "**Основной сервис: gameplay-service**\n- Порт: 8083\n- Базовый
              путь: `/api/v1/gameplay/progression/`\n- Отвечает за всю логику прогрессии\n\n**Интеграции:**\n-
              character-service: Обновление параметров персонажа\n- achievement-service:
              Проверка достижений\n- notification-service: Уведомления игроку\n- analytics-service:
              Статистика прогрессии\n- inventory-service: Награды за уровни\n"}, {"id":
              "modules-structure", "title": "Структура модулей", "body": "**Core Modules:**\n-
              `progression/calculator`: Расчёт опыта и формулы\n- `progression/level`:
              Управление уровнями\n- `progression/points`: Распределение очков\n-
              `progression/tracker`: Отслеживание прогресса\n- `progression/events`:
              Публикация событий\n- `progression/validation`: Валидация операций\n\n**Supporting
              Modules:**\n- `progression/cache`: Кэширование данных прогрессии\n-
              `progression/metrics`: Метрики производительности\n- `progression/migration`:
              Миграции БД\n"}, {"id": "api-endpoints", "title": "API Endpoints (высокоуровнево)",
              "body": "**Experience Management:**\n- `POST /api/v1/gameplay/progression/experience/award`
              - Начисление опыта\n- `GET /api/v1/gameplay/progression/experience/{characterId}`
              - Получение текущего опыта\n\n**Level Management:**\n- `GET /api/v1/gameplay/progression/level/{characterId}`
              - Текущий уровень\n- `GET /api/v1/gameplay/progression/level/requirements/{level}`
              - Требования к уровню\n\n**Points Distribution:**\n- `POST /api/v1/gameplay/progression/points/attribute`
              - Распределение очков атрибутов\n- `POST /api/v1/gameplay/progression/points/skill`
              - Распределение очков навыков\n- `GET /api/v1/gameplay/progression/points/available/{characterId}`
              - Доступные очки\n\n**Progression Stats:**\n- `GET /api/v1/gameplay/progression/stats/{characterId}`
              - Статистика прогрессии\n- `GET /api/v1/gameplay/progression/history/{characterId}`
              - История изменений\n"}, {"id": "data-flows", "title": "Потоки данных
              и интеграции", "body": "**Event-Driven Architecture:**\n- Подписка на
              события: `combat:enemy-killed`, `quest:completed`, `skill:used`\n- Публикация
              событий: `character:level-up`, `character:skill-leveled`, `character:attribute-increased`\n\n**Data
              Flow:**\n1. Источник опыта → Experience Calculator\n2. Расчёт опыта
              → Level Manager (проверка уровня)\n3. Повышение уровня → Point Distributor
              (выдача очков)\n4. Обновление персонажа → Character Service\n5. Уведомления
              → Notification Service\n6. Достижения → Achievement Service\n\n**Caching
              Strategy:**\n- Redis для текущего состояния прогрессии\n- PostgreSQL
              для исторических данных\n- TTL: 5 минут для активных сессий\n"}, {"id":
              "database-schema", "title": "Структура базы данных", "body": "**character_progression:**\n```sql\nCREATE
              TABLE character_progression (\n    character_id UUID PRIMARY KEY,\n    current_level
              INTEGER NOT NULL DEFAULT 1,\n    current_experience BIGINT NOT NULL
              DEFAULT 0,\n    total_experience BIGINT NOT NULL DEFAULT 0,\n    experience_to_next
              BIGINT NOT NULL,\n    available_attribute_points INTEGER NOT NULL DEFAULT
              0,\n    available_skill_points INTEGER NOT NULL DEFAULT 0,\n    created_at
              TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL\n);\n```\n\n**character_attributes:**\n```sql\nCREATE
              TABLE character_attributes (\n    character_id UUID NOT NULL,\n    attribute_type
              VARCHAR(50) NOT NULL,\n    base_value INTEGER NOT NULL DEFAULT 0,\n    bonus_value
              INTEGER NOT NULL DEFAULT 0,\n    total_value INTEGER NOT NULL DEFAULT
              0,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT
              NULL,\n    PRIMARY KEY (character_id, attribute_type)\n);\n```\n\n**character_skills:**\n```sql\nCREATE
              TABLE character_skills (\n    character_id UUID NOT NULL,\n    skill_id
              VARCHAR(100) NOT NULL,\n    current_level INTEGER NOT NULL DEFAULT 0,\n    current_experience
              BIGINT NOT NULL DEFAULT 0,\n    experience_to_next BIGINT NOT NULL,\n    created_at
              TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    PRIMARY
              KEY (character_id, skill_id)\n);\n```\n\n**experience_sources:**\n```sql\nCREATE
              TABLE experience_sources (\n    id UUID PRIMARY KEY,\n    character_id
              UUID NOT NULL,\n    source_type VARCHAR(50) NOT NULL, -- combat, quest,
              skill, etc.\n    source_id VARCHAR(100), -- enemy_id, quest_id, etc.\n    experience_amount
              BIGINT NOT NULL,\n    awarded_at TIMESTAMP NOT NULL,\n    metadata JSONB\n);\n```\n\n**Индексы:**\n-
              character_progression(character_id)\n- character_attributes(character_id)\n-
              character_skills(character_id, skill_id)\n- experience_sources(character_id,
              awarded_at)\n"}, {"id": "experience-calculation", "title": "Система
              расчёта опыта", "body": "**Exponential Formula:**\n```\nexperience_required(level)
              = base_experience * (growth_rate ^ (level - 1))\n```\n\n**Parameters:**\n-
              base_experience: 1000 (опыт для 1 уровня)\n- growth_rate: 1.15 (15%
              рост на уровень)\n- max_level: 100\n\n**Experience Sources:**\n- Combat:
              enemy_level * base_multiplier * difficulty_modifier\n- Quests: quest_difficulty
              * completion_bonus\n- Skills: skill_usage * skill_level_multiplier\n-
              Exploration: discovery_points * rarity_multiplier\n\n**Modifiers:**\n-
              First-time bonus: +25%\n- Group size penalty: -10% per additional member\n-
              Time bonus: +50% for speed runs\n"}, {"id": "level-up-system", "title":
              "Система повышения уровня", "body": "**Level Up Process:**\n1. Проверка
              достижения порога опыта\n2. Блокировка операций прогрессии\n3. Расчёт
              выдаваемых очков\n4. Обновление уровня и статистики\n5. Публикация события
              level-up\n6. Отправка уведомления игроку\n\n**Points Awarded:**\n- Attribute
              Points: 5 per level\n- Skill Points: 3 per level (every 2nd level)\n-
              Bonus Points: Special events/milestones\n\n**Validation:**\n- Максимальный
              уровень: 100\n- Минимальный опыт для уровня\n- Проверка на дублирование
              операций\n"}, {"id": "points-distribution", "title": "Система распределения
              очков", "body": "**Attribute Points:**\n- Strength, Agility, Intelligence,
              Vitality\n- Base cap: 100 per attribute\n- Soft cap scaling: +10 per
              10 levels\n- Validation: Available points >= requested\n\n**Skill Points:**\n-
              Tree-based skill system\n- Prerequisites for advanced skills\n- Level
              caps per skill tier\n- Refund mechanism: 50% experience back\n\n**Distribution
              Rules:**\n- Atomic operations (all or nothing)\n- Race condition prevention\n-
              Audit logging for all changes\n- Real-time validation\n"}, {"id": "error-handling",
              "title": "Обработка ошибок и отказоустойчивость", "body": "**Circuit
              Breaker Pattern:**\n- DB failures: Fallback to cached data\n- External
              service failures: Queue operations\n- Validation failures: Detailed
              error messages\n\n**Retry Logic:**\n- Exponential backoff: 1s, 2s, 4s,
              8s\n- Max retries: 3 attempts\n- Dead letter queue for permanent failures\n\n**Data
              Consistency:**\n- ACID transactions for point distribution\n- Eventual
              consistency for cross-service updates\n- Compensation transactions for
              rollbacks\n"}, {"id": "performance-optimization", "title": "Оптимизации
              производительности", "body": "**Caching Strategy:**\n- Redis: Character
              progression data (TTL: 5min)\n- In-memory: Experience formulas (no TTL)\n-
              CDN: Static progression tables\n\n**Batch Operations:**\n- Bulk experience
              awards\n- Mass level calculations\n- Batch notifications\n\n**Async
              Processing:**\n- Event publishing (Kafka/RabbitMQ)\n- Background analytics
              updates\n- Scheduled cleanup tasks\n\n**Performance Targets:**\n- Experience
              award: <10ms P95\n- Level up check: <5ms P95\n- Point distribution:
              <20ms P95\n"}, {"id": "monitoring-analytics", "title": "Мониторинг и
              аналитика", "body": "**Metrics:**\n- Experience awarded per minute\n-
              Level up events per hour\n- Point distribution success rate\n- Cache
              hit/miss ratios\n\n**Analytics:**\n- Player progression velocity\n-
              Popular skill/attribute choices\n- Experience source effectiveness\n-
              Bottleneck identification\n\n**Alerts:**\n- Failed experience awards\n-
              Invalid level up attempts\n- High error rates\n"}]}, "appendix": {"glossary":
              [{"term": "Experience Points (XP)", "definition": "Валюта прогрессии,
              получаемая из различных игровых активностей"}, {"term": "Attribute Points",
              "definition": "Очки для улучшения базовых характеристик персонажа"},
              {"term": "Skill Points", "definition": "Очки для изучения и улучшения
              навыков"}, {"term": "Level Cap", "definition": "Максимальный уровень,
              который может достичь персонаж"}], "references": [{"type": "api", "path":
              "/api/v1/gameplay/progression/"}, {"type": "database", "path": "infrastructure/liquibase/migrations/gameplay/progression/"},
              {"type": "events", "path": "knowledge/implementation/backend/events/progression-events.yaml"}],
              "decisions": [{"id": "adr-progression-architecture", "summary": "Одобрена
              event-driven архитектура с разделением на микросервисы"}, {"id": "adr-experience-formula",
              "summary": "Выбрана экспоненциальная формула роста опыта с коэффициентом
              1.15"}, {"id": "adr-points-system", "summary": "Реализовано разделение
              на attribute points и skill points с валидацией"}]}, "implementation":
              {"needs_task": false, "github_issue": 164, "subtasks": [{"id": "progression-service-implementation",
              "title": "Реализация основного сервиса прогрессии", "description": "Создание
              базового сервиса с обработкой опыта и уровней", "estimated_hours": 40,
              "dependencies": []}, {"id": "progression-database-migration", "title":
              "Миграции базы данных для прогрессии", "description": "Создание таблиц
              и индексов для хранения данных прогрессии", "estimated_hours": 8, "dependencies":
              []}, {"id": "progression-api-implementation", "title": "Реализация REST
              API для прогрессии", "description": "Создание HTTP endpoints для управления
              прогрессией", "estimated_hours": 24, "dependencies": ["progression-service-implementation"]},
              {"id": "progression-event-system", "title": "Система событий прогрессии",
              "description": "Публикация и подписка на события изменения прогрессии",
              "estimated_hours": 16, "dependencies": ["progression-service-implementation"]},
              {"id": "progression-points-system", "title": "Система распределения
              очков", "description": "Логика распределения и валидации очков атрибутов
              и навыков", "estimated_hours": 20, "dependencies": ["progression-service-implementation"]},
              {"id": "progression-cache-integration", "title": "Интеграция кэширования",
              "description": "Добавление Redis кэширования для производительности",
              "estimated_hours": 12, "dependencies": ["progression-service-implementation"]},
              {"id": "progression-testing", "title": "Тестирование системы прогрессии",
              "description": "Unit, integration и load тестирование", "estimated_hours":
              16, "dependencies": ["progression-service-implementation", "progression-api-implementation"]},
              {"id": "progression-documentation", "title": "Документация API и интеграций",
              "description": "Создание OpenAPI спецификаций и документации", "estimated_hours":
              8, "dependencies": ["progression-api-implementation"]}], "blockers":
              [], "priority": "high"}, "history": [{"version": "1.0.0", "date": "2025-12-14",
              "author": "Architect Agent", "changes": "Создана полная архитектурная
              документация системы прогрессии"}], "validation": {"checksum": "", "schema_version":
              "1.0"}}'
        - column:
            name: metadata
            value: '{"id": "progression-system-architecture", "title": "Архитектура
              системы прогрессии (Progression System)", "document_type": "architecture",
              "category": "systems", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-12-14T15:25:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "progression", "gameplay",
              "backend"], "topics": ["experience-system", "level-system", "skill-progression",
              "attribute-system"], "related_systems": ["gameplay-service", "character-service",
              "achievement-service", "notification-service", "analytics-service"],
              "related_documents": [{"id": "progression-backend", "relation": "implements"}],
              "visibility": "internal", "audience": ["backend", "gameplay", "architect"],
              "risk_level": "medium"}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\progression-system-architecture.yaml
