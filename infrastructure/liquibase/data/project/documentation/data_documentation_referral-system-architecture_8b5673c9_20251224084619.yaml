databaseChangeLog:
- changeSet:
    id: documentation-referral-system-architecture-8b5673c9
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-564092594526030'
        - column:
            name: doc_id
            value: referral-system-architecture
        - column:
            name: title
            value: Архитектура реферальной системы
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.1.0
        - column:
            name: last_updated
            value: 2025-11-30 20:40:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - growth
            - referral
            - rewards
            - social
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - referral-service
            - reward-service
            - notification-service
            - character-service
            - economy-service
            - analytics-service
        - column:
            name: related_documents
            value: '[{"id": "backend-referral-system", "relation": "implements"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - growth
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "referral-system-architecture", "title": "Архитектура
              реферальной системы", "document_type": "architecture", "category": "systems",
              "status": "draft", "version": "1.1.0", "last_updated": "2025-11-30T20:40:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "growth", "referral", "rewards", "social"],
              "related_systems": ["referral-service", "reward-service", "notification-service",
              "character-service", "economy-service", "analytics-service"], "related_documents":
              [{"id": "backend-referral-system", "relation": "implements"}], "github_issue":
              312, "visibility": "internal", "audience": ["architect", "backend",
              "growth", "api-designer"]}, "summary": {"problem": "Требуется спроектировать
              полную архитектуру реферальной системы, включающую:\n- Генерацию уникальных
              реферальных кодов\n- Регистрацию новых игроков по коду\n- Трекинг рефералов
              и их активности\n- Систему milestone наград (5/10/25/50/100 рефералов)\n-
              Лидерборд рефералов\n- Выдачу наград рефереру и рефералу\n- Интеграции
              с другими системами\n", "goal": "Создать архитектурную схему реферальной
              системы с определением:\n- Компонентов для управления рефералами\n-
              REST, WebSocket и Event Bus контрактов\n- Интеграций с другими системами\n-
              Структуры БД\n- Технического задания для реализации\n", "essence": "Полная
              архитектура реферальной системы с поддержкой генерации кодов,\nрегистрации,
              трекинга, milestone наград и лидерборда.\n"}, "architecture": {"overview":
              "Архитектура реферальной системы состоит из следующих компонентов:\n1.
              Referral Manager - управление реферальной системой\n2. Code Generator
              - генерация уникальных реферальных кодов\n3. Code Validator - валидация
              реферальных кодов\n4. Registration Handler - обработка регистрации по
              коду\n5. Referral Tracker - трекинг рефералов и их активности\n6. Milestone
              Manager - управление milestone наградами\n7. Reward Distributor - распределение
              наград\n8. Leaderboard Manager - управление лидербордом\n9. Referral
              Analytics Collector - сбор аналитики\n10. Referral Telemetry Collector
              - сбор телеметрии\n", "microservices": [{"name": "referral-service",
              "port": 8090, "responsibility": "Обработка реферальной системы:\n- Управление
              реферальной системой\n- Генерация уникальных кодов\n- Валидация кодов\n-
              Обработка регистрации по коду\n- Трекинг рефералов\n- Управление milestone
              наградами\n- Распределение наград\n- Управление лидербордом\n- Сбор
              аналитики\n- Сбор телеметрии\n", "components": [{"referral-manager":
              "управление реферальной системой"}, {"code-generator": "генерация уникальных
              кодов"}, {"code-validator": "валидация реферальных кодов"}, {"registration-handler":
              "обработка регистрации по коду"}, {"referral-tracker": "трекинг рефералов
              и их активности"}, {"milestone-manager": "управление milestone наградами"},
              {"reward-distributor": "распределение наград"}, {"leaderboard-manager":
              "управление лидербордом"}, {"referral-analytics-collector": "сбор аналитики"},
              {"referral-telemetry-collector": "сбор телеметрии"}], "endpoints": ["GET
              /api/v1/referral/code/{characterId} - получение реферального кода персонажа",
              "POST /api/v1/referral/code/generate - генерация нового кода", "POST
              /api/v1/referral/code/validate - валидация кода", "POST /api/v1/referral/register
              - регистрация по реферальному коду", "GET /api/v1/referral/{characterId}/referrals
              - список рефералов", "GET /api/v1/referral/{characterId}/stats - статистика
              рефералов", "GET /api/v1/referral/{characterId}/milestones - достигнутые
              milestones", "POST /api/v1/referral/{characterId}/milestones/{milestoneId}/claim
              - получение milestone награды", "GET /api/v1/referral/leaderboard -
              лидерборд рефералов", "GET /api/v1/referral/leaderboard/{characterId}
              - позиция в лидерборде", "GET /api/v1/referral/rewards/{characterId}
              - доступные награды", "POST /api/v1/referral/rewards/{rewardId}/claim
              - получение награды"], "websocket_channels": ["wss://api.necp.game/v1/referral/{characterId}
              - поток обновлений реферальной системы"], "events_published": [{"referral.code-generated":
              "сгенерирован реферальный код"}, {"referral.code-validated": "код валидирован"},
              {"referral.registration-completed": "регистрация по коду завершена"},
              {"referral.referral-created": "создан реферал"}, {"referral.referral-level-reached":
              "реферал достиг уровня 10"}, {"referral.milestone-reached": "достигнут
              milestone"}, {"referral.milestone-reward-claimed": "получена milestone
              награда"}, {"referral.reward-distributed": "награда распределена"},
              {"referral.leaderboard-updated": "обновлен лидерборд"}], "events_subscribed":
              [{"character.created": "создан персонаж"}, {"character.level-up": "повышение
              уровня персонажа"}, {"economy.transaction": "транзакция в экономике"},
              {"achievement.unlocked": "разблокировано достижение"}]}], "code_generation":
              {"algorithm": "Генерация уникального кода:\n1. Генерация случайной строки
              (8-12 символов)\n2. Проверка уникальности в БД\n3. Если не уникален
              - повторная генерация\n4. Сохранение кода в БД\n", "format": "Формат
              кода: [PREFIX]-[RANDOM]\nПримеры: REF-ABC123XY, REF-XYZ789AB\n", "validation":
              [{"uniqueness": "уникальность кода"}, {"length": "длина 8-12 символов"},
              {"characters": "только буквы и цифры"}, {"expiration": "срок действия
              кода (опционально)"}]}, "registration_process": {"steps": [{"code_input":
              "ввод реферального кода при регистрации"}, {"code_validation": "валидация
              кода"}, {"referral_creation": "создание записи реферала"}, {"welcome_reward":
              "выдача приветственного бонуса новому игроку"}, {"notification": "уведомление
              реферера о новом реферале"}], "welcome_reward": [{"new_player": "награда
              новому игроку"}, {"referrer": "награда рефереру (опционально)"}]}, "referral_tracking":
              {"tracked_events": [{"registration": "регистрация по коду"}, {"level_10":
              "достижение уровня 10"}, {"milestone": "достижение milestone"}, {"activity":
              "активность реферала"}], "statuses": [{"pending": "ожидает активации"},
              {"active": "активный реферал"}, {"milestone_reached": "достиг milestone"},
              {"inactive": "неактивный реферал"}]}, "milestones": {"levels": [{"milestone":
              5, "description": "5 рефералов достигли уровня 10", "rewards": [{"referrer":
              "награда рефереру"}, {"bonus": "бонусная награда"}]}, {"milestone":
              10, "description": "10 рефералов достигли уровня 10", "rewards": [{"referrer":
              "награда рефереру"}, {"bonus": "бонусная награда"}]}, {"milestone":
              25, "description": "25 рефералов достигли уровня 10", "rewards": [{"referrer":
              "награда рефереру"}, {"bonus": "бонусная награда"}]}, {"milestone":
              50, "description": "50 рефералов достигли уровня 10", "rewards": [{"referrer":
              "награда рефереру"}, {"bonus": "бонусная награда"}]}, {"milestone":
              100, "description": "100 рефералов достигли уровня 10", "rewards": [{"referrer":
              "награда рефереру"}, {"bonus": "бонусная награда"}]}], "reward_types":
              [{"currency": "валюта (эдди, премиум валюта)"}, {"items": "предметы"},
              {"cosmetics": "косметика"}, {"experience": "опыт"}, {"reputation": "репутация"}]},
              "leaderboard": {"types": [{"total_referrals": "общее количество рефералов"},
              {"active_referrals": "количество активных рефералов"}, {"milestone_referrals":
              "количество рефералов, достигших milestone"}, {"rewards_earned": "заработанные
              награды"}], "ranking": [{"calculation": "расчет позиции на основе метрик"},
              {"update_frequency": "частота обновления (ежедневно, еженедельно)"},
              {"caching": "кэширование для производительности"}], "display": [{"top_n":
              "топ N игроков"}, {"player_position": "позиция конкретного игрока"},
              {"surrounding_players": "окружающие игроки"}]}, "rewards": {"types":
              [{"welcome_reward": "приветственная награда новому игроку"}, {"level_10_reward":
              "награда за достижение уровня 10 рефералом"}, {"milestone_reward": "награда
              за достижение milestone"}, {"bonus_reward": "бонусная награда"}], "distribution":
              [{"automatic": "автоматическая выдача"}, {"manual_claim": "ручное получение"},
              {"notification": "уведомление о доступной награде"}]}, "data_flows":
              {"code_generation_flow": "1. Игрок запрашивает реферальный код\n2. Code
              Generator генерирует уникальный код\n3. Code Generator проверяет уникальность\n4.
              Code Generator сохраняет код в БД\n5. Referral Service публикует событие
              referral.code-generated\n6. Realtime Gateway отправляет код клиенту\n",
              "registration_flow": "1. Новый игрок вводит реферальный код при регистрации\n2.
              Code Validator проверяет код\n3. Registration Handler создает запись
              реферала\n4. Reward Distributor выдает приветственную награду новому
              игроку\n5. Referral Tracker обновляет статистику реферера\n6. Referral
              Service публикует событие referral.registration-completed\n7. Notification
              Service отправляет уведомление рефереру\n8. Realtime Gateway отправляет
              обновление клиентам\n", "milestone_flow": "1. Реферал достигает уровня
              10\n2. Referral Tracker обновляет статус реферала\n3. Milestone Manager
              проверяет достижение milestone\n4. Milestone Manager создает milestone
              награду\n5. Reward Distributor выдает награду рефереру\n6. Leaderboard
              Manager обновляет лидерборд\n7. Referral Service публикует событие referral.milestone-reached\n8.
              Notification Service отправляет уведомление рефереру\n9. Realtime Gateway
              отправляет обновление клиентам\n", "leaderboard_update_flow": "1. Происходит
              событие, влияющее на лидерборд\n2. Leaderboard Manager пересчитывает
              позиции\n3. Leaderboard Manager обновляет кэш\n4. Referral Service публикует
              событие referral.leaderboard-updated\n5. Realtime Gateway отправляет
              обновление клиентам\n"}, "data_consistency": {"strategy": "Strong Consistency
              (ACID транзакции) для критичных операций (регистрация, milestone, награды)",
              "mechanisms": ["ACID транзакции для регистрации по коду, создания реферала,
              выдачи наград и обновления milestone", "Оптимистичные блокировки (versioning)
              для предотвращения конфликтов при обновлении лидерборда", "Валидация
              перед регистрацией по коду и выдачей наград", "Синхронизация с другими
              сервисами через Event Bus", "Outbox Pattern для гарантированной доставки
              событий", "Saga Pattern для распределенных операций (регистрация по
              коду, выдача наград, обновление лидерборда)"]}, "data_synchronization":
              {"event_sourcing": "Все изменения состояния реферальной системы (генерация
              кода, регистрация по коду, создание реферала,\nдостижение milestone,
              выдача наград, обновление лидерборда) записываются как события в Event
              Store.\nЭто обеспечивает полный аудит, возможность восстановления состояния
              и \"time travel\" для отладки.\nПримеры событий: ReferralCodeGeneratedEvent,
              ReferralRegisteredEvent, MilestoneReachedEvent, RewardDistributedEvent,
              LeaderboardUpdatedEvent.\n", "cqrs_pattern": "Разделение команд (генерация
              кода, регистрация по коду, выдача наград) и запросов\n(получение кода,
              получение списка рефералов, получение лидерборда) для оптимизации производительности\nи
              масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых
              запросов.\n", "saga_pattern": "Для распределенных транзакций, таких
              как регистрация по коду (валидация кода, создание реферала,\nвыдача
              приветственной награды, уведомление реферера) или выдача milestone награды
              (проверка milestone,\nсоздание награды, выдача награды, обновление лидерборда,
              уведомление реферера), используется Saga Pattern\nдля обеспечения атомарности
              операций между Referral Service, Character Service, Economy Service,
              Reward Service и Notification Service.\n", "outbox_pattern": "Для гарантированной
              доставки событий в Event Bus используется Outbox Pattern,\nкоторый записывает
              события в транзакционную таблицу перед публикацией.\n"}, "tickrate_specification":
              {"code_operations": {"tickrate": "Event-based (on-demand)", "network_load":
              "- Генерация кода: event-based, ~0.001-0.01 events/sec на игрока\n-
              Валидация кода: event-based, ~0.001-0.01 events/sec на игрока\n- Получение
              кода: event-based, ~0.01-0.05 requests/sec на игрока\n- Общий трафик:
              ~0.1-0.3 KB/sec на игрока для операций кодов\n", "latency_requirements":
              "< 50-100ms для генерации кода, < 30-50ms для валидации кода", "sync_strategy":
              "Strong Consistency (ACID транзакции) для генерации и валидации кодов"},
              "registration_operations": {"tickrate": "Event-based (on-demand)", "network_load":
              "- Регистрация по коду: event-based, ~0.001-0.01 events/sec на игрока\n-
              Создание реферала: event-based, ~0.001-0.01 events/sec на игрока\n-
              Выдача приветственной награды: event-based, ~0.001-0.01 events/sec на
              игрока\n- Общий трафик: ~0.2-0.5 KB/sec на игрока для операций регистрации\n",
              "latency_requirements": "< 200-300ms для регистрации по коду, < 100-200ms
              для создания реферала", "sync_strategy": "Strong Consistency (ACID транзакции)
              для регистрации по коду"}, "tracking_operations": {"tickrate": "Event-based
              (on-demand при событиях персонажа) + 1-5 Hz для обновления статусов",
              "network_load": "- Обновление статуса реферала: event-based, ~0.01-0.05
              events/sec на игрока\n- Получение списка рефералов: event-based, ~0.01-0.02
              requests/sec на игрока\n- Получение статистики: event-based, ~0.01-0.02
              requests/sec на игрока\n- Общий трафик: ~0.1-0.3 KB/sec на игрока для
              операций трекинга\n", "latency_requirements": "< 50-100ms для обновления
              статуса, < 30-100ms для получения списка", "sync_strategy": "Strong
              Consistency (ACID транзакции) для обновления статуса, Eventual Consistency
              для статистики"}, "milestone_operations": {"tickrate": "Event-based
              (on-demand при достижении уровня 10)", "network_load": "- Проверка milestone:
              event-based, ~0.001-0.01 events/sec на игрока\n- Создание milestone
              награды: event-based, ~0.001-0.01 events/sec на игрока\n- Получение
              milestone: event-based, ~0.01-0.02 requests/sec на игрока\n- Общий трафик:
              ~0.1-0.3 KB/sec на игрока для операций milestone\n", "latency_requirements":
              "< 100-200ms для проверки milestone, < 50-150ms для создания награды",
              "sync_strategy": "Strong Consistency (ACID транзакции) для milestone
              операций"}, "reward_operations": {"tickrate": "Event-based (on-demand)",
              "network_load": "- Выдача награды: event-based, ~0.001-0.01 events/sec
              на игрока\n- Получение награды: event-based, ~0.001-0.01 events/sec
              на игрока\n- Получение списка наград: event-based, ~0.01-0.02 requests/sec
              на игрока\n- Общий трафик: ~0.1-0.3 KB/sec на игрока для операций наград\n",
              "latency_requirements": "< 200-300ms для выдачи награды, < 50-150ms
              для получения награды", "sync_strategy": "Strong Consistency (ACID транзакции)
              для выдачи наград"}, "leaderboard_operations": {"tickrate": "Event-based
              (on-demand при изменениях) + 1-5 Hz для обновления лидерборда", "network_load":
              "- Обновление лидерборда: 1-5 Hz, ~0.05-0.2 KB/sec\n- Получение лидерборда:
              event-based, ~0.01-0.05 requests/sec на игрока\n- Получение позиции:
              event-based, ~0.01-0.02 requests/sec на игрока\n- Общий трафик: ~0.1-0.3
              KB/sec на игрока для операций лидерборда\n", "latency_requirements":
              "< 50-100ms для обновления лидерборда, < 30-100ms для получения лидерборда",
              "sync_strategy": "Eventual Consistency для лидерборда (кэширование в
              Redis)"}, "event_handling": {"tickrate": "Event-based (on-demand)",
              "network_load": "- Публикация событий реферальной системы: event-based,
              ~0.1-0.5 events/sec\n- Подписка на события: event-based, ~0.05-0.2 events/sec\n-
              Общий трафик: ~0.2-0.7 KB/sec для событий\n", "latency_requirements":
              "< 100-300ms для публикации событий", "sync_strategy": "Eventual Consistency
              для событий (через Event Bus)"}}, "database_structure": {"tables": [{"name":
              "referral_codes", "description": "Реферальные коды", "columns": [{"id":
              "UUID PRIMARY KEY"}, {"character_id": "UUID FOREIGN KEY"}, {"code":
              "VARCHAR(20) UNIQUE"}, {"prefix": "VARCHAR(10)"}, {"created_at": "TIMESTAMP"},
              {"expires_at": "TIMESTAMP"}, {"is_active": "BOOLEAN"}, {"usage_count":
              "INTEGER"}, {"max_usage": "INTEGER"}]}, {"name": "referrals", "description":
              "Рефералы", "columns": [{"id": "UUID PRIMARY KEY"}, {"referrer_id":
              "UUID FOREIGN KEY"}, {"referred_id": "UUID FOREIGN KEY"}, {"referral_code":
              "VARCHAR(20)"}, {"status": "ENUM (pending, active, milestone_reached,
              inactive)"}, {"registered_at": "TIMESTAMP"}, {"level_10_reached_at":
              "TIMESTAMP"}, {"milestone_reached_at": "TIMESTAMP"}, {"welcome_reward_claimed":
              "BOOLEAN"}, {"level_10_reward_claimed": "BOOLEAN"}, {"milestone_reward_claimed":
              "BOOLEAN"}, {"created_at": "TIMESTAMP"}, {"updated_at": "TIMESTAMP"}]},
              {"name": "referral_milestones", "description": "Milestone рефералов",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id": "UUID FOREIGN
              KEY"}, {"milestone_level": "INTEGER"}]}]}}}'
        - column:
            name: metadata
            value: '{"id": "referral-system-architecture", "title": "Архитектура реферальной
              системы", "document_type": "architecture", "category": "systems", "status":
              "draft", "version": "1.1.0", "last_updated": "2025-11-30T20:40:00+00:00",
              "owners": [{"role": "architect", "contact": "architect@necp.game"}],
              "tags": ["architecture", "growth", "referral", "rewards", "social"],
              "related_systems": ["referral-service", "reward-service", "notification-service",
              "character-service", "economy-service", "analytics-service"], "related_documents":
              [{"id": "backend-referral-system", "relation": "implements"}], "github_issue":
              312, "visibility": "internal", "audience": ["architect", "backend",
              "growth", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\referral-system-architecture.yaml
