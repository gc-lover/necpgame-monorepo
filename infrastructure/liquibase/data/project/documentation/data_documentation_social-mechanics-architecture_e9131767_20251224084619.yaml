databaseChangeLog:
- changeSet:
    id: documentation-social-mechanics-architecture-e9131767
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-439183220928048'
        - column:
            name: doc_id
            value: social-mechanics-architecture
        - column:
            name: title
            value: Архитектура социальных механик - отношения, заказы, найм NPC
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: systems
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-01 00:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - social
            - relationships
            - player-orders
            - npc-hiring
            - reputation
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - social-service
            - narrative-service
            - economy-service
            - npc-service
            - reputation-service
        - column:
            name: related_documents
            value: '[{"id": "npc-relationships-system", "relation": "implements"},
              {"id": "family-relationships-system", "relation": "implements"}, {"id":
              "mentorship-mechanics", "relation": "implements"}, {"id": "player-orders-system-detailed",
              "relation": "implements"}, {"id": "npc-hiring-system", "relation": "implements"},
              {"id": "reputation-formulas", "relation": "implements"}, {"id": "relationships-system-architecture",
              "relation": "extends"}, {"id": "player-orders-core", "relation": "extends"},
              {"id": "npc-hiring-system-architecture", "relation": "extends"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - social
            - api-designer
            - network
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"<!-- Issue": null, "metadata": {"id": "social-mechanics-architecture",
              "title": "Архитектура социальных механик - отношения, заказы, найм NPC",
              "document_type": "architecture", "category": "systems", "status": "draft",
              "version": "1.0.0", "last_updated": "2025-12-01T00:00:00+00:00", "owners":
              [{"role": "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "social", "relationships", "player-orders", "npc-hiring", "reputation"],
              "related_systems": ["social-service", "narrative-service", "economy-service",
              "npc-service", "reputation-service"], "related_documents": [{"id": "npc-relationships-system",
              "relation": "implements"}, {"id": "family-relationships-system", "relation":
              "implements"}, {"id": "mentorship-mechanics", "relation": "implements"},
              {"id": "player-orders-system-detailed", "relation": "implements"}, {"id":
              "npc-hiring-system", "relation": "implements"}, {"id": "reputation-formulas",
              "relation": "implements"}, {"id": "relationships-system-architecture",
              "relation": "extends"}, {"id": "player-orders-core", "relation": "extends"},
              {"id": "npc-hiring-system-architecture", "relation": "extends"}], "github_issue":
              43, "visibility": "internal", "audience": ["architect", "backend", "social",
              "api-designer", "network"]}, "summary": {"problem": "Требуется спроектировать
              архитектуру социальных механик, объединяющую\nотношения с NPC, семейные
              отношения, наставничество, заказы игроков и найм NPC.\nВсе механики
              должны быть интегрированы с social-service и narrative-service.\n",
              "goal": "Создать архитектурную схему социальных механик с определением:\n-
              Компонентов для управления отношениями, заказами и наймом\n- REST, WebSocket
              и Event Bus контрактов\n- Синхронизации данных между слоями (Event Sourcing,
              CQRS)\n- Тикрейта и требований к сетевой нагрузке\n- Интеграций между
              компонентами\n- Структуры БД\n- Технического задания для реализации\n",
              "essence": "Объединенная архитектура социальных механик, интегрирующая
              отношения,\nзаказы игроков и найм NPC в единую систему с поддержкой
              narrative-service\nи realtime синхронизации.\n"}, "architecture": {"overview":
              "Архитектура социальных механик состоит из следующих компонентов:\n1.
              Relationship System - система отношений (NPC, семейные, наставничество)\n2.
              Player Orders System - система заказов от игроков\n3. NPC Hiring System
              - система найма NPC\n4. Reputation System - система репутации\n5. Social
              Orchestrator - оркестратор социальных механик\n6. Narrative Integration
              - интеграция с narrative-service\n", "microservices": [{"name": "social-service",
              "port": 8084, "responsibility": "Обработка социальных механик:\n- Управление
              отношениями с NPC\n- Управление семейными отношениями\n- Управление
              наставничеством\n- Управление заказами игроков\n- Управление наймом
              NPC\n- Управление репутацией\n- Оркестрация социальных механик\n", "components":
              [{"relationship-system": "система отношений"}, {"player-orders-system":
              "система заказов"}, {"npc-hiring-system": "система найма NPC"}, {"reputation-system":
              "система репутации"}, {"social-orchestrator": "оркестратор механик"},
              {"narrative-integration": "интеграция с narrative"}], "endpoints": ["GET
              /api/v1/social/relationships/{characterId} - отношения персонажа", "POST
              /api/v1/social/relationships/{characterId}/set - установка отношения",
              "GET /api/v1/social/relationships/family/{characterId} - семейные отношения",
              "POST /api/v1/social/relationships/mentorship/create - создание наставничества",
              "GET /api/v1/social/orders - получение заказов", "POST /api/v1/social/orders
              - создание заказа", "POST /api/v1/social/orders/{orderId}/accept - принятие
              заказа", "POST /api/v1/social/orders/{orderId}/complete - выполнение
              заказа", "GET /api/v1/social/npc-hiring/candidates - поиск кандидатов
              для найма", "POST /api/v1/social/npc-hiring/contract/create - создание
              контракта найма", "GET /api/v1/social/npc-hiring/contracts - список
              контрактов", "GET /api/v1/social/reputation/{characterId} - репутация
              персонажа"], "websocket_channels": ["wss://api.necp.game/v1/social/relationships/{characterId}
              - обновления отношений", "wss://api.necp.game/v1/social/orders/{orderId}
              - события заказа", "wss://api.necp.game/v1/social/npc-hiring/{contractId}
              - события найма"], "events_published": [{"social.relationship.updated":
              "обновление отношения"}, {"social.relationship.family-updated": "обновление
              семейного отношения"}, {"social.relationship.mentorship-created": "создание
              наставничества"}, {"social.order.created": "создание заказа"}, {"social.order.accepted":
              "принятие заказа"}, {"social.order.completed": "выполнение заказа"},
              {"social.npc-hiring.contract-created": "создание контракта найма"},
              {"social.npc-hiring.contract-updated": "обновление контракта"}, {"social.reputation.updated":
              "обновление репутации"}], "events_subscribed": [{"quest.completed":
              "завершение квеста"}, {"economy.trade.completed": "завершение торговли"},
              {"combat.session.completed": "завершение боевой сессии"}]}], "data_synchronization":
              {"strategy": "Event Sourcing + CQRS", "event_store": "Все события социальных
              механик сохраняются в Event Store:\n- social.relationship.updated\n-
              social.relationship.family-updated\n- social.relationship.mentorship-created\n-
              social.order.created\n- social.order.accepted\n- social.order.completed\n-
              social.npc-hiring.contract-created\n- social.npc-hiring.contract-updated\n-
              social.reputation.updated\n", "command_side": "Command Side (Write Model):\n-
              social-service: обработка команд отношений, заказов, найма, репутации\n",
              "query_side": "Query Side (Read Model):\n- social-service: получение
              статуса отношений, заказов, контрактов, репутации\n", "saga_pattern":
              "Saga для социальных операций:\n1. Start Social Operation Saga\n2. Validate
              Requirements (репутация, уровень, ресурсы)\n3. Reserve Resources (валюты,
              предметы)\n4. Execute Operation (отношение/заказ/найм)\n5. Update Reputation
              (обновление репутации)\n6. If failure: Compensate (rollback, возврат
              ресурсов)\n", "consistency": "Strong Consistency для критичных операций:\n-
              Установка отношений\n- Создание заказов\n- Принятие заказов\n- Создание
              контрактов найма\n- Обновление репутации\nEventual Consistency для:\n-
              Поиск заказов\n- Поиск кандидатов для найма\n- Статистика отношений\n"},
              "network_requirements": {"tick_rate": {"relationship_updates": "- Протокол:
              HTTP REST + WebSocket\n- Тикрейт: on-demand (при изменении)\n- Задержка:
              <200 мс\n- Оптимизация: Кэширование отношений\n", "order_updates": "-
              Протокол: WebSocket (TCP)\n- Тикрейт: 5-10 Hz (при активных заказах)\n-
              Задержка: <150 мс\n- Оптимизация: Батчинг обновлений\n", "npc_hiring_updates":
              "- Протокол: HTTP REST + WebSocket\n- Тикрейт: on-demand (при изменении)\n-
              Задержка: <200 мс\n- Оптимизация: Кэширование контрактов\n", "reputation_updates":
              "- Протокол: HTTP REST\n- Тикрейт: on-demand (при изменении)\n- Задержка:
              <300 мс\n- Оптимизация: Батчинг обновлений репутации\n"}, "bandwidth_optimization":
              "- Кэширование отношений и репутации\n- Пагинация результатов поиска\n-
              Агрегация обновлений\n- Сжатие данных для WebSocket\n- Rate limiting
              для предотвращения злоупотреблений\n"}, "data_flows": {"relationship_update_flow":
              "1. Игрок взаимодействует с NPC или игроком\n2. Relationship System
              рассчитывает изменение отношения\n3. Relationship System обновляет уровень
              отношения\n4. Relationship System применяет эффекты отношения\n5. Social
              Service публикует событие social.relationship.updated\n6. Narrative
              Service получает событие для обновления диалогов\n7. Realtime Gateway
              отправляет обновление клиентам\n", "order_creation_flow": "1. Игрок
              создает заказ\n2. Player Orders System проверяет требования (уровень,
              репутация)\n3. Player Orders System резервирует награду\n4. Player Orders
              System публикует заказ\n5. Social Service публикует событие social.order.created\n6.
              Realtime Gateway отправляет обновление клиентам\n", "order_execution_flow":
              "1. Исполнитель принимает заказ\n2. Player Orders System проверяет доступность
              заказа\n3. Player Orders System блокирует заказ\n4. Исполнитель выполняет
              заказ\n5. Player Orders System проверяет выполнение\n6. Player Orders
              System выплачивает награду\n7. Player Orders System обновляет репутацию\n8.
              Social Service публикует событие social.order.completed\n9. Realtime
              Gateway отправляет обновление клиентам\n", "npc_hiring_flow": "1. Игрок
              ищет кандидатов для найма\n2. NPC Hiring System фильтрует кандидатов
              по требованиям\n3. Игрок начинает переговоры\n4. NPC Hiring System рассчитывает
              условия контракта\n5. Игрок создает контракт\n6. NPC Hiring System резервирует
              ресурсы\n7. NPC Hiring System активирует контракт\n8. Social Service
              публикует событие social.npc-hiring.contract-created\n9. Narrative Service
              получает событие для обновления диалогов\n10. Realtime Gateway отправляет
              обновление клиентам\n", "reputation_update_flow": "1. Происходит событие,
              влияющее на репутацию\n2. Reputation System рассчитывает изменение репутации\n3.
              Reputation System обновляет уровень репутации\n4. Reputation System
              проверяет пороговые значения\n5. Reputation System применяет эффекты
              репутации\n6. Social Service публикует событие social.reputation.updated\n7.
              Realtime Gateway отправляет обновление клиентам\n"}, "database_structure":
              {"tables": [{"name": "character_relationships", "description": "Отношения
              между персонажами", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"target_id": "UUID FOREIGN KEY"}, {"target_type":
              "ENUM (player, npc)"}, {"relationship_type": "ENUM (friend, close_ally,
              pact, enemy, nemesis, family, mentor, student)"}, {"relationship_level":
              "INTEGER"}, {"trust_level": "INTEGER"}, {"created_at": "TIMESTAMP"},
              {"updated_at": "TIMESTAMP"}]}, {"name": "family_relationships", "description":
              "Семейные отношения", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"family_member_id": "UUID FOREIGN KEY"}, {"relationship_type":
              "ENUM (parent, child, sibling, spouse, extended)"}, {"relationship_quality":
              "DECIMAL(3,2)"}, {"created_at": "TIMESTAMP"}, {"updated_at": "TIMESTAMP"}]},
              {"name": "mentorship_relationships", "description": "Отношения наставничества",
              "columns": [{"id": "UUID PRIMARY KEY"}, {"mentor_id": "UUID FOREIGN
              KEY"}, {"student_id": "UUID FOREIGN KEY"}, {"status": "ENUM (active,
              completed, terminated)"}, {"progress": "DECIMAL(5,2)"}, {"started_at":
              "TIMESTAMP"}, {"completed_at": "TIMESTAMP (nullable)"}]}, {"name": "player_orders",
              "description": "Заказы от игроков", "columns": [{"id": "UUID PRIMARY
              KEY"}, {"creator_id": "UUID FOREIGN KEY"}, {"executor_id": "UUID FOREIGN
              KEY (nullable)"}, {"order_type": "ENUM (combat, hacking, trade, political,
              research, social)"}, {"status": "ENUM (open, accepted, in_progress,
              completed, cancelled, failed)"}, {"reward": "JSONB"}, {"requirements":
              "JSONB"}, {"created_at": "TIMESTAMP"}, {"expires_at": "TIMESTAMP"},
              {"completed_at": "TIMESTAMP (nullable)"}]}, {"name": "npc_hiring_contracts",
              "description": "Контракты найма NPC", "columns": [{"id": "UUID PRIMARY
              KEY"}, {"character_id": "UUID FOREIGN KEY"}, {"npc_id": "UUID FOREIGN
              KEY"}, {"contract_type": "ENUM (merchant, fixer, bodyguard, mercenary,
              diplomat, engineer, hacker)"}, {"salary": "JSONB"}, {"duration": "INTEGER"},
              {"status": "ENUM (active, completed, terminated)"}, {"started_at": "TIMESTAMP"},
              {"expires_at": "TIMESTAMP"}, {"created_at": "TIMESTAMP"}]}, {"name":
              "character_reputation", "description": "Репутация персонажей", "columns":
              [{"id": "UUID PRIMARY KEY"}, {"character_id": "UUID FOREIGN KEY"}, {"faction_id":
              "UUID FOREIGN KEY (nullable)"}, {"reputation_level": "DECIMAL(5,2)"},
              {"reputation_points": "INTEGER"}, {"last_update": "TIMESTAMP"}, {"created_at":
              "TIMESTAMP"}]}]}, "integrations": {"narrative_service": "Получение событий
              для обновления диалогов, интеграция с квестами\n", "economy_service":
              "Проверка баланса, резервирование валюты, выплата наград\n", "npc_service":
              "Получение данных о NPC, обновление состояния NPC\n", "reputation_service":
              "Получение и обновление репутации, применение эффектов репутации\n",
              "world_service": "Получение данных о мире, влияние на мир\n", "quest_service":
              "Интеграция заказов с квестами, триггеры квестов\n"}}, "technical_specification":
              {"subtasks": [{"id": "relationship-system", "title": "Реализация системы
              отношений", "description": "Реализация Relationship System с управлением
              отношениями с NPC,\nсемейными отношениями и наставничеством.\n", "dependencies":
              [], "estimated_effort": "6 days"}, {"id": "player-orders-system", "title":
              "Реализация системы заказов игроков", "description": "Реализация Player
              Orders System с созданием, принятием и выполнением заказов,\nуправлением
              рейтингами и репутацией.\n", "dependencies": [], "estimated_effort":
              "7 days"}, {"id": "npc-hiring-system", "title": "Реализация системы
              найма NPC", "description": "Реализация NPC Hiring System с поиском кандидатов,
              переговорами,\nсозданием контрактов и управлением персоналом.\n", "dependencies":
              [], "estimated_effort": "6 days"}, {"id": "reputation-system", "title":
              "Реализация системы репутации", "description": "Реализация Reputation
              System с расчетом репутации, применением эффектов\nи интеграцией с другими
              системами.\n", "dependencies": [], "estimated_effort": "4 days"}, {"id":
              "social-orchestrator", "title": "Реализация оркестратора социальных
              механик", "description": "Реализация Social Orchestrator с координацией
              всех социальных механик\nи управлением сагами.\n", "dependencies": ["relationship-system",
              "player-orders-system", "npc-hiring-system", "reputation-system"], "estimated_effort":
              "5 days"}, {"id": "narrative-integration", "title": "Интеграция с narrative-service",
              "description": "Реализация Narrative Integration с отправкой событий
              в narrative-service\nдля обновления диалогов и квестов.\n", "dependencies":
              ["social-orchestrator"], "estimated_effort": "3 days"}, {"id": "websocket-channels",
              "title": "Реализация WebSocket каналов", "description": "Реализация
              WebSocket каналов для realtime обновлений отношений,\nзаказов и найма.\n",
              "dependencies": ["social-orchestrator"], "estimated_effort": "3 days"},
              {"id": "event-bus-integration", "title": "Интеграция с Event Bus", "description":
              "Реализация публикации и подписки на события через Kafka\nдля всех компонентов
              социальных механик.\n", "dependencies": ["social-orchestrator"], "estimated_effort":
              "2 days"}, {"id": "database-schema", "title": "Создание схемы БД", "description":
              "Создание таблиц БД для отношений, заказов, найма и репутации\nс миграциями
              Liquibase.\n", "dependencies": [], "estimated_effort": "3 days"}]},
              "diagrams": {"component_diagram": "```mermaid\ngraph TB\n    Client[UE5
              Client] --> Gateway[API Gateway]\n\n    Gateway --> SocialService[Social
              Service<br/>8084]\n\n    SocialService --> RS[Relationship System]\n    SocialService
              --> POS[Player Orders System]\n    SocialService --> NHS[NPC Hiring
              System]\n    SocialService --> RepS[Reputation System]\n    SocialService
              --> SO[Social Orchestrator]\n    SocialService --> NI[Narrative Integration]\n\n    SO
              --> RS\n    SO --> POS\n    SO --> NHS\n    SO --> RepS\n\n    SocialService
              --> NarrativeService[Narrative Service]\n    SocialService --> EconomyService[Economy
              Service]\n    SocialService --> NPCService[NPC Service]\n    SocialService
              --> ReputationService[Reputation Service]\n    SocialService --> WorldService[World
              Service]\n    SocialService --> QuestService[Quest Service]\n\n    SocialService
              --> EventBus[Event Bus<br/>Kafka]\n    EventBus --> RealtimeGateway[Realtime
              Gateway]\n\n    SocialService --> DB[(Social DB)]\n\n    Client -->
              WSSocial[WebSocket<br/>Social]\n    WSSocial --> SocialService\n```\n",
              "relationship_update_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              P as Player\n    participant RS as Relationship System\n    participant
              RepS as Reputation System\n    participant NS as Narrative Service\n    participant
              EB as Event Bus\n\n    P->>RS: Interact with NPC\n    RS->>RS: Calculate
              relationship change\n    RS->>RS: Update relationship level\n    RS->>RepS:
              Update reputation\n    RepS->>RepS: Calculate reputation change\n    RS->>EB:
              Publish social.relationship.updated\n    EB->>NS: social.relationship.updated\n    NS->>NS:
              Update dialogues\n    RS->>P: Relationship updated\n```\n"}}'
        - column:
            name: metadata
            value: '{"id": "social-mechanics-architecture", "title": "Архитектура
              социальных механик - отношения, заказы, найм NPC", "document_type":
              "architecture", "category": "systems", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-12-01T00:00:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "social", "relationships", "player-orders", "npc-hiring", "reputation"],
              "related_systems": ["social-service", "narrative-service", "economy-service",
              "npc-service", "reputation-service"], "related_documents": [{"id": "npc-relationships-system",
              "relation": "implements"}, {"id": "family-relationships-system", "relation":
              "implements"}, {"id": "mentorship-mechanics", "relation": "implements"},
              {"id": "player-orders-system-detailed", "relation": "implements"}, {"id":
              "npc-hiring-system", "relation": "implements"}, {"id": "reputation-formulas",
              "relation": "implements"}, {"id": "relationships-system-architecture",
              "relation": "extends"}, {"id": "player-orders-core", "relation": "extends"},
              {"id": "npc-hiring-system-architecture", "relation": "extends"}], "github_issue":
              43, "visibility": "internal", "audience": ["architect", "backend", "social",
              "api-designer", "network"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\social-mechanics-architecture.yaml
