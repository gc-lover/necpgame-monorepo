databaseChangeLog:
- changeSet:
    id: documentation-weapon-advanced-mechanics-architecture-e4aa0206
    author: content-migration-generator
    changes:
    - insert:
        tableName: project.documentation
        columns:
        - column:
            name: id
            value: '-834810246118783'
        - column:
            name: doc_id
            value: weapon-advanced-mechanics-architecture
        - column:
            name: title
            value: Архитектура системы дополнительных механик оружия
        - column:
            name: document_type
            value: architecture
        - column:
            name: category
            value: combat
        - column:
            name: status
            value: draft
        - column:
            name: version
            value: 1.0.0
        - column:
            name: last_updated
            value: 2025-12-06 21:00:00+00:00
        - column:
            name: concept_approved
            value: false
        - column:
            name: concept_reviewed_at
            value: null
        - column:
            name: owners
            value: '[{"role": "architect", "contact": "architect@necp.game"}]'
        - column:
            name: tags
            value:
            - architecture
            - combat
            - weapons
            - mechanics
            - advanced
        - column:
            name: topics
            value: []
        - column:
            name: related_systems
            value:
            - weapon-system
            - combat-engine
            - projectile-system
            - effect-system
        - column:
            name: related_documents
            value: '[{"id": "weapon-special-mechanics-working", "relation": "implements"}]'
        - column:
            name: source
            value: ''
        - column:
            name: visibility
            value: internal
        - column:
            name: audience
            value:
            - architect
            - backend
            - gameplay
            - api-designer
        - column:
            name: risk_level
            value: ''
        - column:
            name: content
            value: '{"metadata": {"id": "weapon-advanced-mechanics-architecture",
              "title": "Архитектура системы дополнительных механик оружия", "document_type":
              "architecture", "category": "combat", "status": "draft", "version":
              "1.0.0", "last_updated": "2025-12-06T21:00:00+00:00", "owners": [{"role":
              "architect", "contact": "architect@necp.game"}], "tags": ["architecture",
              "combat", "weapons", "mechanics", "advanced"], "related_systems": ["weapon-system",
              "combat-engine", "projectile-system", "effect-system"], "related_documents":
              [{"id": "weapon-special-mechanics-working", "relation": "implements"}],
              "github_issue": 1556, "visibility": "internal", "audience": ["architect",
              "backend", "gameplay", "api-designer"]}, "summary": {"problem": "Требуется
              спроектировать архитектуру системы дополнительных механик оружия,\nвключающую
              разделение снарядов, рикошеты, замедление и маркировку целей.\nСистема
              должна обеспечивать высокую производительность и интеграцию с боевой
              системой.\n", "goal": "Создать архитектурную схему с определением компонентов,
              API, потоков данных\nи оптимизаций для системы дополнительных механик
              оружия.\n", "essence": "Полная архитектура дополнительных механик оружия
              с поддержкой расширенных\nтактических возможностей и высокой производительностью.\n"},
              "architecture": {"overview": "Архитектура системы дополнительных механик
              оружия состоит из следующих компонентов:\n1. Projectile Split Manager
              - управление разделением снарядов\n2. Ricochet Calculator - расчет траекторий
              рикошетов\n3. Slowdown Effect Applier - применение эффектов замедления\n4.
              Target Marker - система маркировки целей\n5. Advanced Mechanics Processor
              - обработка всех механик\n6. Mechanics Telemetry Collector - сбор метрик
              и телеметрии\n", "microservices": [{"name": "weapon-mechanics-service",
              "port": 8101, "responsibility": "Обработка дополнительных механик оружия:\n-
              Разделение снарядов\n- Расчет рикошетов\n- Применение замедления\n-
              Маркировка целей\n- Сбор телеметрии\n", "components": [{"projectile-split-manager":
              "управление разделением снарядов"}, {"ricochet-calculator": "расчет
              траекторий рикошетов"}, {"slowdown-effect-applier": "применение эффектов
              замедления"}, {"target-marker": "система маркировки целей"}, {"advanced-mechanics-processor":
              "обработка всех механик"}, {"mechanics-telemetry-collector": "сбор метрик"}],
              "endpoints": ["POST /api/v1/weapon-mechanics/projectile/split - разделение
              снаряда", "POST /api/v1/weapon-mechanics/ricochet/calculate - расчет
              рикошета", "POST /api/v1/weapon-mechanics/slowdown/apply - применение
              замедления", "POST /api/v1/weapon-mechanics/target/mark - маркировка
              цели", "GET /api/v1/weapon-mechanics/{characterId}/active - активные
              механики"], "websocket_channels": ["wss://api.necp.game/v1/weapon-mechanics/{characterId}
              - обновления механик"], "events_published": [{"weapon.projectile_split":
              "разделение снаряда"}, {"weapon.ricochet_calculated": "расчет рикошета"},
              {"weapon.slowdown_applied": "применение замедления"}, {"weapon.target_marked":
              "маркировка цели"}, {"weapon.mechanics_processed": "обработка механики"}],
              "events_subscribed": [{"weapon.fired": "выстрел оружия"}, {"projectile.hit":
              "попадание снаряда"}, {"target.damaged": "повреждение цели"}, {"combat.round_end":
              "окончание раунда"}]}], "mechanics_types": {"projectile_split": {"description":
              "Разделение снарядов на несколько частей", "types": [{"temporal_split":
              "разделение по времени (с задержкой)"}, {"spatial_split": "разделение
              в пространстве (в разных направлениях)"}, {"conditional_split": "разделение
              при определенных условиях"}], "stats": [{"split_count": "количество
              частей"}, {"split_delay": "задержка разделения"}, {"split_angle": "угол
              разделения"}, {"damage_reduction": "снижение урона на часть"}]}, "ricochet_mechanics":
              {"description": "Расширенная система рикошетов", "types": [{"surface_ricochet":
              "рикошет от поверхностей"}, {"target_ricochet": "рикошет между целями"},
              {"smart_ricochet": "умный выбор траектории"}, {"chain_ricochet": "цепная
              реакция рикошетов"}], "stats": [{"max_ricochets": "максимальное количество
              рикошетов"}, {"ricochet_damage": "урон при рикошете (%)"}, {"ricochet_range":
              "дальность рикошета"}, {"surface_types": "типы поверхностей для рикошета"}]},
              "slowdown_effects": {"description": "Эффекты замедления движения и атак",
              "types": [{"movement_slowdown": "замедление движения"}, {"attack_slowdown":
              "замедление атак"}, {"stacking_slowdown": "накопление эффекта"}, {"area_slowdown":
              "замедление в области"}], "stats": [{"slowdown_percentage": "процент
              замедления"}, {"slowdown_duration": "длительность эффекта"}, {"slowdown_radius":
              "радиус действия"}, {"stacking_limit": "лимит накопления"}]}, "target_marking":
              {"description": "Система маркировки целей", "types": [{"damage_boost_mark":
              "увеличение урона по отмеченной цели"}, {"tracking_mark": "отслеживание
              цели"}, {"reveal_mark": "раскрытие невидимых целей"}, {"synergy_mark":
              "синергия с союзниками"}], "stats": [{"mark_duration": "длительность
              маркировки"}, {"damage_multiplier": "множитель урона"}, {"tracking_range":
              "дальность отслеживания"}, {"mark_limit": "лимит одновременных меток"}]}},
              "data_flows": {"projectile_split_flow": "1. Weapon fires projectile
              with split mechanics\n2. Projectile Split Manager receives projectile
              data\n3. Split conditions are evaluated (distance, time, hit)\n4. Split
              Manager creates child projectiles\n5. Child projectiles inherit parent
              properties with modifications\n6. Advanced Mechanics Processor updates
              projectile registry\n7. Event weapon.projectile_split is published\n",
              "ricochet_calculation_flow": "1. Projectile hits surface/target\n2.
              Ricochet Calculator evaluates ricochet conditions\n3. Surface analysis
              determines reflection angle\n4. Trajectory calculation for new path\n5.
              Damage and velocity modifications applied\n6. Projectile updated with
              new trajectory\n7. Event weapon.ricochet_calculated is published\n",
              "slowdown_application_flow": "1. Projectile with slowdown effect hits
              target\n2. Slowdown Effect Applier evaluates effect parameters\n3. Target
              stats modified (movement speed, attack speed)\n4. Effect duration timer
              started\n5. Visual effects applied to target\n6. Event weapon.slowdown_applied
              is published\n", "target_marking_flow": "1. Weapon ability activates
              marking\n2. Target Marker validates marking conditions\n3. Target marked
              with specified properties\n4. Mark duration timer started\n5. Visual
              marker applied to target\n6. Event weapon.target_marked is published\n"},
              "data_consistency": {"strategy": "Eventual Consistency для механик,
              Strong Consistency для критичных операций", "mechanisms": ["Event Sourcing
              для всех изменений состояния механик", "Versioning для предотвращения
              конфликтов", "Validation перед применением эффектов", "Saga Pattern
              для комплексных механик (split + ricochet + slowdown)"]}, "performance_optimizations":
              {"memory_optimization": {"object_pooling": {"projectile_pool": "size
              10000, reuse projectile objects", "effect_pool": "size 5000, reuse effect
              instances", "marker_pool": "size 1000, reuse marker objects"}, "struct_alignment":
              {"projectile_struct": ["id(uuid)", "position(vec3)", "velocity(vec3)",
              "mechanics_flags(uint32)"], "effect_struct": ["target_id(uuid)", "effect_type(uint16)",
              "duration(int32)", "strength(float32)"], "marker_struct": ["target_id(uuid)",
              "mark_type(uint16)", "duration(int32)", "multiplier(float32)"]}}, "computation_optimization":
              {"spatial_partitioning": "grid-based projectile tracking for collision
              detection", "batch_processing": "group similar mechanics operations",
              "lazy_evaluation": "calculate complex trajectories on-demand", "caching":
              "cache ricochet calculations for common surface types"}, "network_optimization":
              {"delta_compression": "send only changed mechanics state", "interest_management":
              "send mechanics updates only to affected players", "batch_events": "group
              multiple mechanics events into single message"}}, "tickrate_specification":
              {"mechanics_processing": {"tickrate": "60 Hz для активных механик, Event-based
              для активации", "network_load": "- Projectile split events: ~0.5-2 KB/sec
              per active mechanic\n- Ricochet calculations: ~0.1-0.5 KB/sec per projectile\n-
              Slowdown updates: ~0.2-1 KB/sec per affected target\n- Target marking:
              ~0.1-0.3 KB/sec per mark\n- Total mechanics traffic: ~1-4 KB/sec per
              player in combat\n", "latency_requirements": "< 50ms для применения
              эффектов, < 100ms для расчетов"}}, "database_structure": {"tables":
              [{"name": "weapon_mechanics_definitions", "description": "Определения
              механик оружия", "columns": [{"id": "UUID PRIMARY KEY"}, {"mechanic_type":
              "ENUM (split, ricochet, slowdown, marking)"}, {"mechanic_subtype": "VARCHAR(50)"},
              {"parameters": "JSONB"}, {"compatibility_rules": "JSONB"}, {"performance_cost":
              "JSONB"}]}, {"name": "active_weapon_mechanics", "description": "Активные
              механики в бою", "columns": [{"id": "UUID PRIMARY KEY"}, {"character_id":
              "UUID FOREIGN KEY"}, {"weapon_instance_id": "UUID FOREIGN KEY"}, {"mechanic_type":
              "VARCHAR(50)"}, {"mechanic_data": "JSONB"}, {"activated_at": "TIMESTAMP"},
              {"expires_at": "TIMESTAMP"}]}, {"name": "mechanics_telemetry", "description":
              "Телеметрия механик", "columns": [{"id": "UUID PRIMARY KEY"}, {"event_type":
              "VARCHAR(50)"}, {"character_id": "UUID FOREIGN KEY"}, {"weapon_id":
              "UUID FOREIGN KEY"}, {"mechanic_type": "VARCHAR(50)"}, {"performance_metrics":
              "JSONB"}, {"created_at": "TIMESTAMP"}]}]}, "integrations": {"combat_service":
              "- Получение событий выстрелов и попаданий\n- Применение эффектов к
              целям\n- Синхронизация состояния механик\n- Расчет урона с учетом механик\n",
              "projectile_system": "- Создание дочерних снарядов при разделении\n-
              Обновление траекторий при рикошетах\n- Управление временем жизни снарядов\n-
              Оптимизация рендеринга снарядов\n", "effect_system": "- Применение визуальных
              эффектов замедления\n- Управление маркерами целей\n- Синхронизация эффектов
              между клиентами\n- Управление длительностью эффектов\n", "character_service":
              "- Проверка доступности механик для персонажа\n- Обновление статистики
              использования\n- Валидация уровней и требований\n- Управление инвентарем
              оружия\n"}}, "technical_specification": {"subtasks": [{"id": "projectile-split-manager",
              "title": "Реализация менеджера разделения снарядов", "description":
              "Реализация Projectile Split Manager с логикой разделения,\nсозданием
              дочерних снарядов и управлением параметрами.\n", "dependencies": [],
              "estimated_effort": "3 days"}, {"id": "ricochet-calculator", "title":
              "Реализация калькулятора рикошетов", "description": "Реализация Ricochet
              Calculator с расчетом траекторий,\nанализом поверхностей и оптимизацией
              производительности.\n", "dependencies": [], "estimated_effort": "4 days"},
              {"id": "slowdown-effect-applier", "title": "Реализация применения эффектов
              замедления", "description": "Реализация Slowdown Effect Applier с модификацией
              статов целей,\nуправлением длительностью и визуальными эффектами.\n",
              "dependencies": [], "estimated_effort": "3 days"}, {"id": "target-marker",
              "title": "Реализация системы маркировки целей", "description": "Реализация
              Target Marker с логиком маркировки,\nуправлением длительностью и синергиями.\n",
              "dependencies": [], "estimated_effort": "3 days"}, {"id": "advanced-mechanics-processor",
              "title": "Реализация процессора механик", "description": "Реализация
              Advanced Mechanics Processor с координацией всех механик,\nоптимизацией
              и телеметрией.\n", "dependencies": ["projectile-split-manager", "ricochet-calculator",
              "slowdown-effect-applier", "target-marker"], "estimated_effort": "4
              days"}, {"id": "mechanics-telemetry-collector", "title": "Реализация
              сборщика телеметрии", "description": "Реализация Mechanics Telemetry
              Collector с логированием,\nметриками и аналитикой производительности.\n",
              "dependencies": ["advanced-mechanics-processor"], "estimated_effort":
              "2 days"}, {"id": "database-schema-mechanics", "title": "Создание схемы
              БД для механик", "description": "Создание таблиц для определений механик,
              активных эффектов\nи телеметрии с индексами и миграциями.\n", "dependencies":
              [], "estimated_effort": "2 days"}]}, "diagrams": {"component_diagram":
              "```mermaid\ngraph TB\n    Client[UE5 Client] --> Gateway[API Gateway]\n\n    Gateway
              --> WeaponMechanicsService[Weapon Mechanics Service<br/>8101]\n\n    WeaponMechanicsService
              --> PSM[Projectile Split Manager]\n    WeaponMechanicsService --> RC[Ricochet
              Calculator]\n    WeaponMechanicsService --> SEA[Slowdown Effect Applier]\n    WeaponMechanicsService
              --> TM[Target Marker]\n    WeaponMechanicsService --> AMP[Advanced Mechanics
              Processor]\n    WeaponMechanicsService --> MTC[Mechanics Telemetry Collector]\n\n    PSM
              --> AMP\n    RC --> AMP\n    SEA --> AMP\n    TM --> AMP\n\n    WeaponMechanicsService
              --> CombatService[Combat Service]\n    WeaponMechanicsService --> ProjectileSystem[Projectile
              System]\n    WeaponMechanicsService --> EffectSystem[Effect System]\n    WeaponMechanicsService
              --> CharacterService[Character Service]\n\n    WeaponMechanicsService
              --> EventBus[Event Bus<br/>Kafka]\n    EventBus --> RealtimeGateway[Realtime
              Gateway]\n\n    WeaponMechanicsService --> DB[(Weapon Mechanics DB)]\n```\n",
              "mechanics_flow_diagram": "```mermaid\nsequenceDiagram\n    participant
              W as Weapon\n    participant PSM as Projectile Split Manager\n    participant
              RC as Ricochet Calculator\n    participant SEA as Slowdown Effect Applier\n    participant
              TM as Target Marker\n    participant AMP as Advanced Mechanics Processor\n\n    W->>PSM:
              Fire projectile with split mechanics\n    PSM->>PSM: Evaluate split
              conditions\n    PSM->>AMP: Create child projectiles\n    AMP->>RC: Check
              ricochet conditions\n\n    RC->>RC: Calculate new trajectory\n    RC->>AMP:
              Update projectile path\n\n    AMP->>SEA: Apply slowdown on hit\n    SEA->>SEA:
              Modify target stats\n\n    AMP->>TM: Mark target if applicable\n    TM->>TM:
              Apply visual marker\n```\n"}, "history": [{"version": "1.0.0", "date":
              "2025-12-06", "author": "Architect Agent", "changes": "Создана полная
              архитектура системы дополнительных механик оружия:\n- Определены компоненты
              (Projectile Split Manager, Ricochet Calculator, Slowdown Effect Applier,
              Target Marker, Advanced Mechanics Processor, Mechanics Telemetry Collector)\n-
              Спроектированы типы механик (разделение, рикошеты, замедление, маркировка)\n-
              Определены API endpoints и WebSocket каналы\n- Спроектированы потоки
              данных и интеграции\n- Добавлены оптимизации производительности и спецификации
              тикрейта\n- Создан план подзадач и диаграммы архитектуры\n- Определена
              структура БД для механик\n"}]}'
        - column:
            name: metadata
            value: '{"id": "weapon-advanced-mechanics-architecture", "title": "Архитектура
              системы дополнительных механик оружия", "document_type": "architecture",
              "category": "combat", "status": "draft", "version": "1.0.0", "last_updated":
              "2025-12-06T21:00:00+00:00", "owners": [{"role": "architect", "contact":
              "architect@necp.game"}], "tags": ["architecture", "combat", "weapons",
              "mechanics", "advanced"], "related_systems": ["weapon-system", "combat-engine",
              "projectile-system", "effect-system"], "related_documents": [{"id":
              "weapon-special-mechanics-working", "relation": "implements"}], "github_issue":
              1556, "visibility": "internal", "audience": ["architect", "backend",
              "gameplay", "api-designer"]}'
        - column:
            name: source_file
            value: knowledge\implementation\architecture\weapon-advanced-mechanics-architecture.yaml
