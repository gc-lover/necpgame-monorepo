<!-- Issue: #169 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================================================ -->
    <!-- COMBAT SESSIONS SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Combat Sessions Table -->
    <changeSet id="create-combat-sessions-table" author="backend-engineer">
        <createTable tableName="combat_sessions" schemaName="combat">
            <column name="session_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_ids" type="UUID[]" defaultValue="{}">
                <constraints nullable="false"/>
            </column>
            <column name="zone_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="difficulty" type="VARCHAR(20)" defaultValue="normal">
                <constraints nullable="false"/>
            </column>
            <column name="mission_type" type="VARCHAR(20)" defaultValue="raid">
                <constraints nullable="false"/>
            </column>
            <column name="score" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="max_score" type="INTEGER"/>
            <column name="time_limit_seconds" type="INTEGER"/>
            <column name="time_elapsed_seconds" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="enemies_spawned" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="enemies_remaining" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="objectives_completed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="objectives_total" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="session_data" type="JSONB"/>
            <column name="anti_cheat_flags" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="ended_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_combat_sessions_status" tableName="combat_sessions" schemaName="combat">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_combat_sessions_player" tableName="combat_sessions" schemaName="combat">
            <column name="player_ids"/>
        </createIndex>

        <createIndex indexName="idx_combat_sessions_zone" tableName="combat_sessions" schemaName="combat">
            <column name="zone_id"/>
        </createIndex>

        <createIndex indexName="idx_combat_sessions_created" tableName="combat_sessions" schemaName="combat">
            <column name="created_at"/>
        </createIndex>

        <!-- Partial index for active sessions -->
        <createIndex indexName="idx_combat_sessions_active" tableName="combat_sessions" schemaName="combat">
            <column name="status"/>
            <column name="updated_at"/>
            <where>status = 'active'</where>
        </createIndex>

        <comment>Combat Sessions table - core session management</comment>
    </changeSet>

    <!-- Combat Session Players Table -->
    <changeSet id="create-combat-session-players-table" author="backend-engineer">
        <createTable tableName="combat_session_players" schemaName="combat">
            <column name="session_player_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="player_status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="joined_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="left_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="final_score" type="INTEGER"/>
            <column name="kills" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deaths" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="damage_dealt" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="damage_taken" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="accuracy" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="player_metrics" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="combat_session_players"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_session_players_session"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_session_players_session" tableName="combat_session_players" schemaName="combat">
            <column name="session_id"/>
        </createIndex>

        <createIndex indexName="idx_session_players_player" tableName="combat_session_players" schemaName="combat">
            <column name="player_id"/>
        </createIndex>

        <createIndex indexName="idx_session_players_character" tableName="combat_session_players" schemaName="combat">
            <column name="character_id"/>
        </createIndex>

        <comment>Combat Session Players table - player participation tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- AI SYSTEM -->
    <!-- ============================================================================ -->

    <!-- AI Profiles Table -->
    <changeSet id="create-ai-profiles-table" author="backend-engineer">
        <createTable tableName="ai_profiles" schemaName="combat">
            <column name="profile_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ai_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="difficulty" type="VARCHAR(20)" defaultValue="normal">
                <constraints nullable="false"/>
            </column>
            <column name="base_health" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="damage" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="speed" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="detection_range" type="DECIMAL(7,2)">
                <constraints nullable="false"/>
            </column>
            <column name="attack_range" type="DECIMAL(7,2)">
                <constraints nullable="false"/>
            </column>
            <column name="behavior_patterns" type="JSONB"/>
            <column name="loot_table" type="JSONB"/>
            <column name="weaknesses" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_ai_profiles_type" tableName="ai_profiles" schemaName="combat">
            <column name="ai_type"/>
        </createIndex>

        <createIndex indexName="idx_ai_profiles_difficulty" tableName="ai_profiles" schemaName="combat">
            <column name="difficulty"/>
        </createIndex>

        <createIndex indexName="idx_ai_profiles_active" tableName="ai_profiles" schemaName="combat">
            <column name="is_active"/>
        </createIndex>

        <comment>AI Profiles table - enemy AI configurations</comment>
    </changeSet>

    <!-- AI Instances Table -->
    <changeSet id="create-ai-instances-table" author="backend-engineer">
        <createTable tableName="ai_instances" schemaName="combat">
            <column name="instance_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="profile_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="current_health" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="max_health" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="position_y" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="position_z" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="rotation" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="current_state" type="VARCHAR(20)" defaultValue="idle">
                <constraints nullable="false"/>
            </column>
            <column name="target_player_id" type="UUID"/>
            <column name="threat_level" type="DECIMAL(3,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="last_damage_taken" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="last_attack_time" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="behavior_data" type="JSONB"/>
            <column name="spawned_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="destroyed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="ai_instances"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_ai_instances_session"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="ai_instances"
            baseColumnNames="profile_id"
            referencedTableSchemaName="combat"
            referencedTableName="ai_profiles"
            referencedColumnNames="profile_id"
            constraintName="fk_ai_instances_profile"
            onDelete="RESTRICT"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_ai_instances_session" tableName="ai_instances" schemaName="combat">
            <column name="session_id"/>
        </createIndex>

        <createIndex indexName="idx_ai_instances_profile" tableName="ai_instances" schemaName="combat">
            <column name="profile_id"/>
        </createIndex>

        <createIndex indexName="idx_ai_instances_state" tableName="ai_instances" schemaName="combat">
            <column name="session_id"/>
            <column name="current_state"/>
        </createIndex>

        <createIndex indexName="idx_ai_instances_position" tableName="ai_instances" schemaName="combat">
            <column name="session_id"/>
            <column name="position_x"/>
            <column name="position_y"/>
            <column name="position_z"/>
        </createIndex>

        <comment>AI Instances table - active AI enemies in combat sessions</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- ABILITIES SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Abilities Catalog Table -->
    <changeSet id="create-abilities-catalog-table" author="backend-engineer">
        <createTable tableName="abilities_catalog" schemaName="combat">
            <column name="ability_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ability_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ability_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="cooldown_seconds" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="duration_seconds" type="INTEGER"/>
            <column name="energy_cost" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="range" type="DECIMAL(7,2)"/>
            <column name="effects" type="JSONB"/>
            <column name="requirements" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_abilities_catalog_type" tableName="abilities_catalog" schemaName="combat">
            <column name="ability_type"/>
        </createIndex>

        <createIndex indexName="idx_abilities_catalog_active" tableName="abilities_catalog" schemaName="combat">
            <column name="is_active"/>
        </createIndex>

        <comment>Abilities Catalog table - available player abilities</comment>
    </changeSet>

    <!-- Player Abilities Table -->
    <changeSet id="create-player-abilities-table" author="backend-engineer">
        <createTable tableName="player_abilities" schemaName="combat">
            <column name="player_ability_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="ability_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="unlocked_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_used_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="cooldown_remaining" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="is_equipped" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="ability_data" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="player_abilities"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_abilities_character"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="player_abilities"
            baseColumnNames="ability_id"
            referencedTableSchemaName="combat"
            referencedTableName="abilities_catalog"
            referencedColumnNames="ability_id"
            constraintName="fk_player_abilities_ability"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_player_abilities_character" tableName="player_abilities" schemaName="combat">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_player_abilities_ability" tableName="player_abilities" schemaName="combat">
            <column name="ability_id"/>
        </createIndex>

        <createIndex indexName="idx_player_abilities_equipped" tableName="player_abilities" schemaName="combat">
            <column name="character_id"/>
            <column name="is_equipped"/>
        </createIndex>

        <comment>Player Abilities table - abilities owned by players</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- SHOOTING SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Weapons Catalog Table -->
    <changeSet id="create-weapons-catalog-table" author="backend-engineer">
        <createTable tableName="weapons_catalog" schemaName="combat">
            <column name="weapon_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="weapon_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="weapon_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="damage" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="fire_rate_rpm" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="magazine_size" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="reload_time_seconds" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="range_meters" type="DECIMAL(7,2)">
                <constraints nullable="false"/>
            </column>
            <column name="accuracy" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="recoil_pattern" type="JSONB"/>
            <column name="ballistics" type="JSONB"/>
            <column name="ammo_types" type="JSONB"/>
            <column name="attachments" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_weapons_catalog_type" tableName="weapons_catalog" schemaName="combat">
            <column name="weapon_type"/>
        </createIndex>

        <createIndex indexName="idx_weapons_catalog_active" tableName="weapons_catalog" schemaName="combat">
            <column name="is_active"/>
        </createIndex>

        <comment>Weapons Catalog table - available weapons</comment>
    </changeSet>

    <!-- Combat Hits Table -->
    <changeSet id="create-combat-hits-table" author="backend-engineer">
        <createTable tableName="combat_hits" schemaName="combat">
            <column name="hit_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="shooter_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="target_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="weapon_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="hit_position_x" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="hit_position_y" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="hit_position_z" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="damage_dealt" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="hit_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="was_critical" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="armor_penetration" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="distance" type="DECIMAL(7,2)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="validation_data" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="combat_hits"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_combat_hits_session"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_combat_hits_session" tableName="combat_hits" schemaName="combat">
            <column name="session_id"/>
            <column name="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_combat_hits_shooter" tableName="combat_hits" schemaName="combat">
            <column name="shooter_id"/>
        </createIndex>

        <createIndex indexName="idx_combat_hits_target" tableName="combat_hits" schemaName="combat">
            <column name="target_id"/>
        </createIndex>

        <createIndex indexName="idx_combat_hits_weapon" tableName="combat_hits" schemaName="combat">
            <column name="weapon_id"/>
        </createIndex>

        <comment>Combat Hits table - validated hit events</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- COMBOS SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Combos Catalog Table -->
    <changeSet id="create-combos-catalog-table" author="backend-engineer">
        <createTable tableName="combos_catalog" schemaName="combat">
            <column name="combo_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="combo_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="combo_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="required_sequence" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="time_window_seconds" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="damage_multiplier" type="DECIMAL(3,2)" defaultValue="1.00">
                <constraints nullable="false"/>
            </column>
            <column name="stamina_cost" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="cooldown_seconds" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="synergies" type="JSONB"/>
            <column name="effects" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_combos_catalog_type" tableName="combos_catalog" schemaName="combat">
            <column name="combo_type"/>
        </createIndex>

        <createIndex indexName="idx_combos_catalog_active" tableName="combos_catalog" schemaName="combat">
            <column name="is_active"/>
        </createIndex>

        <comment>Combos Catalog table - available combo sequences</comment>
    </changeSet>

    <!-- Player Combos Table -->
    <changeSet id="create-player-combos-table" author="backend-engineer">
        <createTable tableName="player_combos" schemaName="combat">
            <column name="player_combo_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="combo_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="unlocked_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_executed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="success_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="failure_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="best_time_seconds" type="DECIMAL(5,2)"/>
            <column name="is_equipped" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="player_combos"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_combos_character"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="player_combos"
            baseColumnNames="combo_id"
            referencedTableSchemaName="combat"
            referencedTableName="combos_catalog"
            referencedColumnNames="combo_id"
            constraintName="fk_player_combos_combo"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_player_combos_character" tableName="player_combos" schemaName="combat">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_player_combos_combo" tableName="player_combos" schemaName="combat">
            <column name="combo_id"/>
        </createIndex>

        <createIndex indexName="idx_player_combos_equipped" tableName="player_combos" schemaName="combat">
            <column name="character_id"/>
            <column name="is_equipped"/>
        </createIndex>

        <comment>Player Combos table - combos learned by players</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- FREERUN SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Freerun Moves Catalog Table -->
    <changeSet id="create-freerun-moves-catalog-table" author="backend-engineer">
        <createTable tableName="freerun_moves_catalog" schemaName="combat">
            <column name="move_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="move_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="move_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="stamina_cost" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="cooldown_seconds" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="momentum_gain" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="height_gain_max" type="DECIMAL(5,2)"/>
            <column name="distance_max" type="DECIMAL(5,2)"/>
            <column name="requirements" type="JSONB"/>
            <column name="effects" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_freerun_moves_type" tableName="freerun_moves_catalog" schemaName="combat">
            <column name="move_type"/>
        </createIndex>

        <createIndex indexName="idx_freerun_moves_active" tableName="freerun_moves_catalog" schemaName="combat">
            <column name="is_active"/>
        </createIndex>

        <comment>Freerun Moves Catalog table - available parkour moves</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- HACKING SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Hacking Targets Catalog Table -->
    <changeSet id="create-hacking-targets-catalog-table" author="backend-engineer">
        <createTable tableName="hacking_targets_catalog" schemaName="combat">
            <column name="target_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="target_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="target_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="difficulty_level" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="base_hack_time_seconds" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="detection_risk" type="DECIMAL(3,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="effects" type="JSONB"/>
            <column name="countermeasures" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_hacking_targets_type" tableName="hacking_targets_catalog" schemaName="combat">
            <column name="target_type"/>
        </createIndex>

        <createIndex indexName="idx_hacking_targets_difficulty" tableName="hacking_targets_catalog" schemaName="combat">
            <column name="difficulty_level"/>
        </createIndex>

        <comment>Hacking Targets Catalog table - hackable targets</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- STEALTH SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Stealth States Table -->
    <changeSet id="create-stealth-states-table" author="backend-engineer">
        <createTable tableName="stealth_states" schemaName="combat">
            <column name="stealth_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="visibility_level" type="DECIMAL(3,2)" defaultValue="1.00">
                <constraints nullable="false"/>
            </column>
            <column name="detection_risk" type="DECIMAL(3,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="current_action" type="VARCHAR(50)" defaultValue="standing">
                <constraints nullable="false"/>
            </column>
            <column name="cover_status" type="VARCHAR(20)" defaultValue="exposed">
                <constraints nullable="false"/>
            </column>
            <column name="noise_level" type="DECIMAL(3,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="nearby_enemies" type="UUID[]" defaultValue="{}">
                <constraints nullable="false"/>
            </column>
            <column name="last_detected_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="last_action_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="stealth_data" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="stealth_states"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_stealth_states_character"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="stealth_states"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_stealth_states_session"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stealth_states_character" tableName="stealth_states" schemaName="combat">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_stealth_states_session" tableName="stealth_states" schemaName="combat">
            <column name="session_id"/>
        </createIndex>

        <createIndex indexName="idx_stealth_states_visibility" tableName="stealth_states" schemaName="combat">
            <column name="session_id"/>
            <column name="visibility_level"/>
        </createIndex>

        <comment>Stealth States table - player stealth status tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- EXTRACTION SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Extractions Table -->
    <changeSet id="create-extractions-table" author="backend-engineer">
        <createTable tableName="extractions" schemaName="combat">
            <column name="extraction_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="extraction_point_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="initiator_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="team_members" type="UUID[]" defaultValue="{}">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="preparing">
                <constraints nullable="false"/>
            </column>
            <column name="time_limit_seconds" type="INTEGER"/>
            <column name="time_remaining_seconds" type="INTEGER"/>
            <column name="progress_percentage" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="enemies_remaining" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="objectives_completed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="loot_items" type="UUID[]" defaultValue="{}">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="extraction_data" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="extractions"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_extractions_session"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_extractions_session" tableName="extractions" schemaName="combat">
            <column name="session_id"/>
        </createIndex>

        <createIndex indexName="idx_extractions_status" tableName="extractions" schemaName="combat">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_extractions_initiator" tableName="extractions" schemaName="combat">
            <column name="initiator_id"/>
        </createIndex>

        <comment>Extractions table - mission completion tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- ARENA SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Arena Matches Table -->
    <changeSet id="create-arena-matches-table" author="backend-engineer">
        <createTable tableName="arena_matches" schemaName="combat">
            <column name="match_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_ids" type="UUID[]" defaultValue="{}">
                <constraints nullable="false"/>
            </column>
            <column name="arena_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="ruleset" type="VARCHAR(50)" defaultValue="standard">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="waiting">
                <constraints nullable="false"/>
            </column>
            <column name="max_players" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="time_limit_seconds" type="INTEGER"/>
            <column name="score_limit" type="INTEGER"/>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="ended_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="winner_id" type="UUID"/>
            <column name="final_scores" type="JSONB"/>
            <column name="match_data" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_arena_matches_status" tableName="arena_matches" schemaName="combat">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_arena_matches_type" tableName="arena_matches" schemaName="combat">
            <column name="arena_type"/>
        </createIndex>

        <createIndex indexName="idx_arena_matches_created" tableName="arena_matches" schemaName="combat">
            <column name="created_at"/>
        </createIndex>

        <comment>Arena Matches table - PvP arena combat tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- CYBERSPACE SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Cyberspace Sessions Table -->
    <changeSet id="create-cyberspace-sessions-table" author="backend-engineer">
        <createTable tableName="cyberspace_sessions" schemaName="combat">
            <column name="cyberspace_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="entry_point_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="implant_level" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="connection_strength" type="DECIMAL(3,2)" defaultValue="1.00">
                <constraints nullable="false"/>
            </column>
            <column name="time_limit_seconds" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="time_remaining_seconds" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="current_node_id" type="UUID"/>
            <column name="data_collected" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="hacks_performed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="detection_alerts" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="ended_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="cyberspace_data" type="JSONB"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="cyberspace_sessions"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_cyberspace_sessions_character"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_cyberspace_sessions_character" tableName="cyberspace_sessions" schemaName="combat">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_cyberspace_sessions_status" tableName="cyberspace_sessions" schemaName="combat">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_cyberspace_sessions_started" tableName="cyberspace_sessions" schemaName="combat">
            <column name="started_at"/>
        </createIndex>

        <comment>Cyberspace Sessions table - digital realm interactions</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- TELEMETRY AND ANALYTICS -->
    <!-- ============================================================================ -->

    <!-- Combat Telemetry Table -->
    <changeSet id="create-combat-telemetry-table" author="backend-engineer">
        <createTable tableName="combat_telemetry" schemaName="combat">
            <column name="telemetry_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="event_data" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="DECIMAL(10,2)"/>
            <column name="position_y" type="DECIMAL(10,2)"/>
            <column name="position_z" type="DECIMAL(10,2)"/>
            <column name="timestamp" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="processed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="combat"
            baseTableName="combat_telemetry"
            baseColumnNames="session_id"
            referencedTableSchemaName="combat"
            referencedTableName="combat_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_combat_telemetry_session"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_combat_telemetry_session" tableName="combat_telemetry" schemaName="combat">
            <column name="session_id"/>
            <column name="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_combat_telemetry_player" tableName="combat_telemetry" schemaName="combat">
            <column name="player_id"/>
            <column name="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_combat_telemetry_event" tableName="combat_telemetry" schemaName="combat">
            <column name="event_type"/>
            <column name="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_combat_telemetry_unprocessed" tableName="combat_telemetry" schemaName="combat">
            <column name="processed"/>
            <column name="timestamp"/>
            <where>processed = false</where>
        </createIndex>

        <!-- Partitioning by timestamp for performance -->
        <sql>
            CREATE TABLE combat_telemetry_y2025 PARTITION OF combat_telemetry
            FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
        </sql>

        <comment>Combat Telemetry table - performance and analytics data</comment>
    </changeSet>

</databaseChangeLog>
