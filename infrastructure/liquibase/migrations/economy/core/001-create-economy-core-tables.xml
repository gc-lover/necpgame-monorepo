<!-- Issue: #171 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================================================ -->
    <!-- INVENTORY SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Inventory Slots Table -->
    <changeSet id="create-inventory-slots-table" author="database-engineer">
        <createTable tableName="inventory_slots" schemaName="economy">
            <column name="slot_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="slot_type" type="VARCHAR(20)" defaultValue="inventory">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="position_y" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID"/>
            <column name="is_locked" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_inventory_slots_character" tableName="inventory_slots" schemaName="economy">
            <column name="character_id"/>
            <column name="slot_type"/>
        </createIndex>

        <createIndex indexName="idx_inventory_slots_item" tableName="inventory_slots" schemaName="economy">
            <column name="item_id"/>
        </createIndex>

        <createIndex indexName="idx_inventory_slots_position" tableName="inventory_slots" schemaName="economy">
            <column name="character_id"/>
            <column name="position_x"/>
            <column name="position_y"/>
        </createIndex>

        <createIndex indexName="idx_inventory_slots_locked" tableName="inventory_slots" schemaName="economy">
            <column name="character_id"/>
            <column name="is_locked"/>
        </createIndex>

        <!-- Unique constraint for slot positions -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="inventory_slots"
            columnNames="character_id, slot_type, position_x, position_y"
            constraintName="uq_inventory_slots_position"/>

        <comment>Inventory Slots table - grid-based inventory storage</comment>
    </changeSet>

    <!-- Inventory Items Table -->
    <changeSet id="create-inventory-items-table" author="database-engineer">
        <createTable tableName="inventory_items" schemaName="economy">
            <column name="item_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="template_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER" defaultValue="1">
                <constraints nullable="false" checkConstraint="quantity > 0"/>
            </column>
            <column name="quality" type="VARCHAR(20)" defaultValue="common">
                <constraints nullable="false"/>
            </column>
            <column name="durability" type="INTEGER"/>
            <column name="max_durability" type="INTEGER"/>
            <column name="custom_properties" type="JSONB"/>
            <column name="is_bound" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="bound_on" type="VARCHAR(20)"/>
            <column name="bound_timestamp" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_inventory_items_character" tableName="inventory_items" schemaName="economy">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_inventory_items_template" tableName="inventory_items" schemaName="economy">
            <column name="template_id"/>
        </createIndex>

        <createIndex indexName="idx_inventory_items_quality" tableName="inventory_items" schemaName="economy">
            <column name="quality"/>
        </createIndex>

        <createIndex indexName="idx_inventory_items_bound" tableName="inventory_items" schemaName="economy">
            <column name="is_bound"/>
        </createIndex>

        <!-- Partial index for bound items -->
        <createIndex indexName="idx_inventory_items_bound_on" tableName="inventory_items" schemaName="economy">
            <column name="bound_on"/>
            <where>is_bound = true</where>
        </createIndex>

        <comment>Inventory Items table - item instances with properties</comment>
    </changeSet>

    <!-- Item Templates Table -->
    <changeSet id="create-item-templates-table" author="database-engineer">
        <createTable tableName="item_templates" schemaName="economy">
            <column name="template_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="template_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="subcategory" type="VARCHAR(50)"/>
            <column name="base_value" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="weight" type="DECIMAL(8,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="stack_size" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="durability" type="INTEGER"/>
            <column name="properties" type="JSONB"/>
            <column name="requirements" type="JSONB"/>
            <column name="is_tradable" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="is_stackable" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="rarity" type="VARCHAR(20)" defaultValue="common">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_item_templates_category" tableName="item_templates" schemaName="economy">
            <column name="category"/>
            <column name="subcategory"/>
        </createIndex>

        <createIndex indexName="idx_item_templates_tradable" tableName="item_templates" schemaName="economy">
            <column name="is_tradable"/>
        </createIndex>

        <createIndex indexName="idx_item_templates_rarity" tableName="item_templates" schemaName="economy">
            <column name="rarity"/>
        </createIndex>

        <createIndex indexName="idx_item_templates_active" tableName="item_templates" schemaName="economy">
            <column name="is_active"/>
        </createIndex>

        <comment>Item Templates table - reusable item definitions</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- EQUIPMENT SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Equipment Slots Table -->
    <changeSet id="create-equipment-slots-table" author="database-engineer">
        <createTable tableName="equipment_slots" schemaName="economy">
            <column name="equipment_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="slot_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID"/>
            <column name="is_equipped" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="equipped_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="requirements_met" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="stat_bonuses" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_equipment_slots_character" tableName="equipment_slots" schemaName="economy">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_equipment_slots_item" tableName="equipment_slots" schemaName="economy">
            <column name="item_id"/>
        </createIndex>

        <createIndex indexName="idx_equipment_slots_type" tableName="equipment_slots" schemaName="economy">
            <column name="character_id"/>
            <column name="slot_type"/>
        </createIndex>

        <createIndex indexName="idx_equipment_slots_equipped" tableName="equipment_slots" schemaName="economy">
            <column name="character_id"/>
            <column name="is_equipped"/>
        </createIndex>

        <!-- Unique constraint: one item per equipment slot -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="equipment_slots"
            columnNames="character_id, slot_type, is_equipped"
            constraintName="uq_equipment_slots_equipped"/>

        <comment>Equipment Slots table - character equipment management</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- STASH SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Stash Pages Table -->
    <changeSet id="create-stash-pages-table" author="database-engineer">
        <createTable tableName="stash_pages" schemaName="economy">
            <column name="page_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="page_number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="is_unlocked" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="unlock_cost" type="INTEGER"/>
            <column name="unlocked_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stash_pages_character" tableName="stash_pages" schemaName="economy">
            <column name="character_id"/>
            <column name="page_number"/>
        </createIndex>

        <createIndex indexName="idx_stash_pages_unlocked" tableName="stash_pages" schemaName="economy">
            <column name="character_id"/>
            <column name="is_unlocked"/>
        </createIndex>

        <!-- Unique constraint for page numbers per character -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="stash_pages"
            columnNames="character_id, page_number"
            constraintName="uq_stash_pages_number"/>

        <comment>Stash Pages table - extended storage pages</comment>
    </changeSet>

    <!-- Stash Slots Table -->
    <changeSet id="create-stash-slots-table" author="database-engineer">
        <createTable tableName="stash_slots" schemaName="economy">
            <column name="slot_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="page_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="position_y" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stash_slots_page" tableName="stash_slots" schemaName="economy">
            <column name="page_id"/>
        </createIndex>

        <createIndex indexName="idx_stash_slots_item" tableName="stash_slots" schemaName="economy">
            <column name="item_id"/>
        </createIndex>

        <createIndex indexName="idx_stash_slots_position" tableName="stash_slots" schemaName="economy">
            <column name="page_id"/>
            <column name="position_x"/>
            <column name="position_y"/>
        </createIndex>

        <!-- Unique constraint for slot positions per page -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="stash_slots"
            columnNames="page_id, position_x, position_y"
            constraintName="uq_stash_slots_position"/>

        <comment>Stash Slots table - stash grid storage</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- TRADE SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Trade Sessions Table -->
    <changeSet id="create-trade-sessions-table" author="database-engineer">
        <createTable tableName="trade_sessions" schemaName="economy">
            <column name="session_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="initiator_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="target_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(30)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
            <column name="initiator_items" type="JSONB" defaultValue="[]">
                <constraints nullable="false"/>
            </column>
            <column name="target_items" type="JSONB" defaultValue="[]">
                <constraints nullable="false"/>
            </column>
            <column name="initiator_credits" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="target_credits" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="timeout_seconds" type="INTEGER" defaultValue="120">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="confirmed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="cancelled_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="anti_fraud_token" type="VARCHAR(255)"/>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_trade_sessions_initiator" tableName="trade_sessions" schemaName="economy">
            <column name="initiator_id"/>
        </createIndex>

        <createIndex indexName="idx_trade_sessions_target" tableName="trade_sessions" schemaName="economy">
            <column name="target_id"/>
        </createIndex>

        <createIndex indexName="idx_trade_sessions_status" tableName="trade_sessions" schemaName="economy">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_trade_sessions_created" tableName="trade_sessions" schemaName="economy">
            <column name="created_at"/>
        </createIndex>

        <createIndex indexName="idx_trade_sessions_expires" tableName="trade_sessions" schemaName="economy">
            <column name="expires_at"/>
            <where>status = 'pending' OR status = 'active'</where>
        </createIndex>

        <createIndex indexName="idx_trade_sessions_participants" tableName="trade_sessions" schemaName="economy">
            <column name="initiator_id"/>
            <column name="target_id"/>
            <column name="status"/>
        </createIndex>

        <comment>Trade Sessions table - P2P trade session management</comment>
    </changeSet>

    <!-- Trade Offers Table -->
    <changeSet id="create-trade-offers-table" author="database-engineer">
        <createTable tableName="trade_offers" schemaName="economy">
            <column name="offer_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="participant_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="items" type="JSONB" defaultValue="[]">
                <constraints nullable="false"/>
            </column>
            <column name="credits" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="offered_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_trade_offers_session" tableName="trade_offers" schemaName="economy">
            <column name="session_id"/>
        </createIndex>

        <createIndex indexName="idx_trade_offers_participant" tableName="trade_offers" schemaName="economy">
            <column name="participant_id"/>
        </createIndex>

        <createIndex indexName="idx_trade_offers_offered" tableName="trade_offers" schemaName="economy">
            <column name="offered_at"/>
        </createIndex>

        <comment>Trade Offers table - trade session offer history</comment>
    </changeSet>

    <!-- Trade Audit Table -->
    <changeSet id="create-trade-audit-table" author="database-engineer">
        <createTable tableName="trade_audit" schemaName="economy">
            <column name="audit_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="action_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="actor_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="old_data" type="JSONB"/>
            <column name="new_data" type="JSONB"/>
            <column name="action_timestamp" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="ip_address" type="INET"/>
            <column name="user_agent" type="TEXT"/>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_trade_audit_session" tableName="trade_audit" schemaName="economy">
            <column name="session_id"/>
            <column name="action_timestamp"/>
        </createIndex>

        <createIndex indexName="idx_trade_audit_actor" tableName="trade_audit" schemaName="economy">
            <column name="actor_id"/>
            <column name="action_timestamp"/>
        </createIndex>

        <createIndex indexName="idx_trade_audit_action" tableName="trade_audit" schemaName="economy">
            <column name="action_type"/>
            <column name="action_timestamp"/>
        </createIndex>

        <!-- Partitioning by timestamp for performance -->
        <sql>
            CREATE TABLE trade_audit_y2025 PARTITION OF trade_audit
            FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
        </sql>

        <comment>Trade Audit table - trade action audit trail</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- FOREIGN KEY CONSTRAINTS -->
    <!-- ============================================================================ -->

    <!-- Inventory Slots FK -->
    <changeSet id="add-inventory-slots-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="inventory_slots"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_inventory_slots_character"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Inventory Items FKs -->
    <changeSet id="add-inventory-items-fks" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="inventory_items"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_inventory_items_character"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="inventory_items"
            baseColumnNames="template_id"
            referencedTableSchemaName="economy"
            referencedTableName="item_templates"
            referencedColumnNames="template_id"
            constraintName="fk_inventory_items_template"
            onDelete="RESTRICT"/>
    </changeSet>

    <!-- Equipment Slots FKs -->
    <changeSet id="add-equipment-slots-fks" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="equipment_slots"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_equipment_slots_character"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Stash Slots FK -->
    <changeSet id="add-stash-slots-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stash_slots"
            baseColumnNames="page_id"
            referencedTableSchemaName="economy"
            referencedTableName="stash_pages"
            referencedColumnNames="page_id"
            constraintName="fk_stash_slots_page"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Stash Pages FK -->
    <changeSet id="add-stash-pages-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stash_pages"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_stash_pages_character"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Trade Sessions FKs -->
    <changeSet id="add-trade-sessions-fks" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="trade_sessions"
            baseColumnNames="initiator_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_trade_sessions_initiator"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="trade_sessions"
            baseColumnNames="target_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_trade_sessions_target"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Trade Offers FK -->
    <changeSet id="add-trade-offers-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="trade_offers"
            baseColumnNames="session_id"
            referencedTableSchemaName="economy"
            referencedTableName="trade_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_trade_offers_session"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Trade Audit FK -->
    <changeSet id="add-trade-audit-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="trade_audit"
            baseColumnNames="session_id"
            referencedTableSchemaName="economy"
            referencedTableName="trade_sessions"
            referencedColumnNames="session_id"
            constraintName="fk_trade_audit_session"
            onDelete="CASCADE"/>
    </changeSet>

</databaseChangeLog>
