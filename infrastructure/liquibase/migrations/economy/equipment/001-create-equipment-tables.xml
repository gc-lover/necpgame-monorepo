<!-- Issue: #62 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Equipment Catalog Table -->
    <changeSet id="create-equipment-catalog-table" author="database-engineer">
        <createTable tableName="equipment_catalog" schemaName="economy">
            <column name="equipment_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="equipment_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="equipment_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rarity" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="tier" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="slot" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="base_stats" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="mod_slots" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="price_ed" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="level_required" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="manufacturer" type="VARCHAR(100)"/>
            <column name="description" type="TEXT"/>
            <column name="is_iconic" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_procedural" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="generation_seed" type="VARCHAR(100)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_equipment_catalog_type" tableName="equipment_catalog" schemaName="economy">
            <column name="equipment_type"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_category" tableName="equipment_catalog" schemaName="economy">
            <column name="category"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_rarity" tableName="equipment_catalog" schemaName="economy">
            <column name="rarity"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_tier" tableName="equipment_catalog" schemaName="economy">
            <column name="tier"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_slot" tableName="equipment_catalog" schemaName="economy">
            <column name="slot"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_iconic" tableName="equipment_catalog" schemaName="economy">
            <column name="is_iconic"/>
        </createIndex>

        <createIndex indexName="idx_equipment_catalog_procedural" tableName="equipment_catalog" schemaName="economy">
            <column name="is_procedural"/>
        </createIndex>

        <!-- Composite index for search -->
        <createIndex indexName="idx_equipment_catalog_search" tableName="equipment_catalog" schemaName="economy">
            <column name="equipment_type"/>
            <column name="category"/>
            <column name="rarity"/>
            <column name="tier"/>
        </createIndex>

        <comment>Equipment Catalog table - all available equipment</comment>
    </changeSet>

    <!-- Iconic Equipment Timeline Table -->
    <changeSet id="create-iconic-equipment-timeline-table" author="database-engineer">
        <createTable tableName="iconic_equipment_timeline" schemaName="economy">
            <column name="timeline_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="equipment_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="year_from" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="year_to" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="owner_character" type="VARCHAR(255)"/>
            <column name="lore_description" type="TEXT"/>
            <column name="notable_events" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="iconic_equipment_timeline"
            baseColumnNames="equipment_id"
            referencedTableSchemaName="economy"
            referencedTableName="equipment_catalog"
            referencedColumnNames="equipment_id"
            constraintName="fk_iconic_equipment_timeline_equipment"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_iconic_equipment_timeline_equipment" tableName="iconic_equipment_timeline" schemaName="economy">
            <column name="equipment_id"/>
        </createIndex>

        <createIndex indexName="idx_iconic_equipment_timeline_years" tableName="iconic_equipment_timeline" schemaName="economy">
            <column name="year_from"/>
            <column name="year_to"/>
        </createIndex>

        <comment>Iconic Equipment Timeline table - timeline history for iconic items</comment>
    </changeSet>

    <!-- Equipment Matrix Table (Procedural Generation) -->
    <changeSet id="create-equipment-matrix-table" author="database-engineer">
        <createTable tableName="equipment_matrix" schemaName="economy">
            <column name="matrix_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="equipment_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="tier" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="stat_ranges" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="mod_slots_range" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="price_range_ed" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="generation_rules" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_equipment_matrix_type_tier" tableName="equipment_matrix" schemaName="economy">
            <column name="equipment_type"/>
            <column name="tier"/>
        </createIndex>

        <createIndex indexName="idx_equipment_matrix_active" tableName="equipment_matrix" schemaName="economy">
            <column name="is_active"/>
        </createIndex>

        <!-- Unique constraint: one matrix per type/tier -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="equipment_matrix"
            columnNames="equipment_type, tier"
            constraintName="uq_equipment_matrix_type_tier"/>

        <comment>Equipment Matrix table - procedural generation rules</comment>
    </changeSet>

    <!-- Equipment Analytics Table -->
    <changeSet id="create-equipment-analytics-table" author="database-engineer">
        <createTable tableName="equipment_analytics" schemaName="economy">
            <column name="analytics_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="equipment_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="total_crafted" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_sold" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_equipped" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="average_price_ed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="popularity_score" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="last_crafted_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="last_sold_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="equipment_analytics"
            baseColumnNames="equipment_id"
            referencedTableSchemaName="economy"
            referencedTableName="equipment_catalog"
            referencedColumnNames="equipment_id"
            constraintName="fk_equipment_analytics_equipment"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_equipment_analytics_equipment" tableName="equipment_analytics" schemaName="economy">
            <column name="equipment_id"/>
        </createIndex>

        <createIndex indexName="idx_equipment_analytics_popularity" tableName="equipment_analytics" schemaName="economy">
            <column name="popularity_score" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_equipment_analytics_total_sold" tableName="equipment_analytics" schemaName="economy">
            <column name="total_sold" descending="true"/>
        </createIndex>

        <comment>Equipment Analytics table - usage statistics for equipment</comment>
    </changeSet>

</databaseChangeLog>
