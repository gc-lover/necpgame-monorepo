<?xml version="1.0" encoding="UTF-8"?>
<!-- Issue: #142 -->
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001-create-loot-tables-table" author="database-engineer">
        <createTable tableName="loot_tables">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="source_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="source_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="drop_chance" type="DECIMAL(5,4)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_min" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_max" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="rarity" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="required_level" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="currency_type" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="currency_min" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="currency_max" type="INTEGER">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex indexName="idx_loot_source" tableName="loot_tables">
            <column name="source_type"/>
            <column name="source_id"/>
        </createIndex>

        <createIndex indexName="idx_loot_rarity" tableName="loot_tables">
            <column name="rarity"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-create-world-drops-table" author="database-engineer">
        <createTable tableName="world_drops">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="location_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="DECIMAL(10,2)">
                <constraints nullable="true"/>
            </column>
            <column name="position_y" type="DECIMAL(10,2)">
                <constraints nullable="true"/>
            </column>
            <column name="position_z" type="DECIMAL(10,2)">
                <constraints nullable="true"/>
            </column>
            <column name="items" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="JSONB">
                <constraints nullable="true"/>
            </column>
            <column name="drop_status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="UUID">
                <constraints nullable="true"/>
            </column>
            <column name="party_id" type="UUID">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="picked_up_at" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
            <column name="picked_up_by" type="UUID">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex indexName="idx_world_drops_location" tableName="world_drops">
            <column name="location_id"/>
            <column name="drop_status"/>
        </createIndex>

        <createIndex indexName="idx_world_drops_expires" tableName="world_drops">
            <column name="expires_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-loot-rolls-table" author="database-engineer">
        <createTable tableName="loot_rolls">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="world_drop_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_roll_drop" references="world_drops(id)"/>
            </column>
            <column name="party_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="roll_results" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="winner_id" type="UUID">
                <constraints nullable="true"/>
            </column>
            <column name="roll_status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex indexName="idx_loot_rolls_party" tableName="loot_rolls">
            <column name="party_id"/>
            <column name="roll_status"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-player-loot-history-table" author="database-engineer">
        <createTable tableName="player_loot_history">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="item_rarity" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="source_type" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="received_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="idx_loot_history_player" tableName="player_loot_history">
            <column name="player_id"/>
            <column name="received_at" order="DESC"/>
        </createIndex>

        <createIndex indexName="idx_loot_history_legendary" tableName="player_loot_history">
            <column name="player_id"/>
            <column name="item_rarity"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>































