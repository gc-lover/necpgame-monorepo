<!-- Issue: #63 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Stocks Table -->
    <changeSet id="create-stocks-table" author="database-engineer">
        <createTable tableName="stocks" schemaName="economy">
            <column name="stock_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ticker" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="company_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="sector" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="current_price" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="previous_close" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="day_high" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="day_low" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="volume_24h" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="market_cap" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="shares_outstanding" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="is_trading" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="is_halted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="halt_reason" type="TEXT"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stocks_ticker" tableName="stocks" schemaName="economy">
            <column name="ticker"/>
        </createIndex>

        <createIndex indexName="idx_stocks_sector" tableName="stocks" schemaName="economy">
            <column name="sector"/>
        </createIndex>

        <createIndex indexName="idx_stocks_is_trading" tableName="stocks" schemaName="economy">
            <column name="is_trading"/>
        </createIndex>

        <createIndex indexName="idx_stocks_market_cap" tableName="stocks" schemaName="economy">
            <column name="market_cap" descending="true"/>
        </createIndex>

        <comment>Stocks table - available stocks for trading</comment>
    </changeSet>

    <!-- Player Portfolios Table -->
    <changeSet id="create-player-portfolios-table" author="database-engineer">
        <createTable tableName="player_portfolios" schemaName="economy">
            <column name="portfolio_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="total_value_ed" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_invested_ed" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_profit_ed" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="positions_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="player_portfolios"
            baseColumnNames="player_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_portfolios_player"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_player_portfolios_player" tableName="player_portfolios" schemaName="economy">
            <column name="player_id"/>
        </createIndex>

        <createIndex indexName="idx_player_portfolios_total_value" tableName="player_portfolios" schemaName="economy">
            <column name="total_value_ed" descending="true"/>
        </createIndex>

        <comment>Player Portfolios table - aggregate portfolio stats</comment>
    </changeSet>

    <!-- Stock Positions Table -->
    <changeSet id="create-stock-positions-table" author="database-engineer">
        <createTable tableName="stock_positions" schemaName="economy">
            <column name="position_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="stock_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="shares_owned" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="average_price" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_invested_ed" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="current_value_ed" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="unrealized_profit_ed" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_positions"
            baseColumnNames="portfolio_id"
            referencedTableSchemaName="economy"
            referencedTableName="player_portfolios"
            referencedColumnNames="portfolio_id"
            constraintName="fk_stock_positions_portfolio"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_positions"
            baseColumnNames="stock_id"
            referencedTableSchemaName="economy"
            referencedTableName="stocks"
            referencedColumnNames="stock_id"
            constraintName="fk_stock_positions_stock"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stock_positions_portfolio" tableName="stock_positions" schemaName="economy">
            <column name="portfolio_id"/>
        </createIndex>

        <createIndex indexName="idx_stock_positions_stock" tableName="stock_positions" schemaName="economy">
            <column name="stock_id"/>
        </createIndex>

        <!-- Unique constraint: one position per portfolio/stock -->
        <addUniqueConstraint
            schemaName="economy"
            tableName="stock_positions"
            columnNames="portfolio_id, stock_id"
            constraintName="uq_stock_positions_portfolio_stock"/>

        <comment>Stock Positions table - player stock holdings</comment>
    </changeSet>

    <!-- Stock Orders Table -->
    <changeSet id="create-stock-orders-table" author="database-engineer">
        <createTable tableName="stock_orders" schemaName="economy">
            <column name="order_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="stock_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="order_type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="side" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="price_ed" type="DECIMAL(15,2)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
            <column name="filled_quantity" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="average_fill_price" type="DECIMAL(15,2)"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="filled_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="cancelled_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_orders"
            baseColumnNames="player_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_stock_orders_player"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_orders"
            baseColumnNames="stock_id"
            referencedTableSchemaName="economy"
            referencedTableName="stocks"
            referencedColumnNames="stock_id"
            constraintName="fk_stock_orders_stock"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stock_orders_player" tableName="stock_orders" schemaName="economy">
            <column name="player_id"/>
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_stock_orders_stock" tableName="stock_orders" schemaName="economy">
            <column name="stock_id"/>
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_stock_orders_status" tableName="stock_orders" schemaName="economy">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_stock_orders_created_at" tableName="stock_orders" schemaName="economy">
            <column name="created_at" descending="true"/>
        </createIndex>

        <!-- Composite index for order book -->
        <createIndex indexName="idx_stock_orders_book" tableName="stock_orders" schemaName="economy">
            <column name="stock_id"/>
            <column name="side"/>
            <column name="status"/>
            <column name="price_ed"/>
        </createIndex>

        <comment>Stock Orders table - buy/sell orders</comment>
    </changeSet>

    <!-- Stock Transactions Table -->
    <changeSet id="create-stock-transactions-table" author="database-engineer">
        <createTable tableName="stock_transactions" schemaName="economy">
            <column name="transaction_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="buyer_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="seller_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="price_per_share" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_price_ed" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="commission_ed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_type" type="VARCHAR(20)" defaultValue="trade">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_transactions"
            baseColumnNames="stock_id"
            referencedTableSchemaName="economy"
            referencedTableName="stocks"
            referencedColumnNames="stock_id"
            constraintName="fk_stock_transactions_stock"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_transactions"
            baseColumnNames="buyer_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_stock_transactions_buyer"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="economy"
            baseTableName="stock_transactions"
            baseColumnNames="seller_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_stock_transactions_seller"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_stock_transactions_stock" tableName="stock_transactions" schemaName="economy">
            <column name="stock_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_stock_transactions_buyer" tableName="stock_transactions" schemaName="economy">
            <column name="buyer_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_stock_transactions_seller" tableName="stock_transactions" schemaName="economy">
            <column name="seller_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_stock_transactions_created_at" tableName="stock_transactions" schemaName="economy">
            <column name="created_at" descending="true"/>
        </createIndex>

        <comment>Stock Transactions table - completed trades</comment>
    </changeSet>

</databaseChangeLog>

