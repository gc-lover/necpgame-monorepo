<?xml version="1.0" encoding="UTF-8"?>
<!-- Issue: #1515 -->
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="000-create-gameplay-schema-if-missing" author="backend">
        <comment>Ensure gameplay schema exists for affix tables</comment>
        <sql>CREATE SCHEMA IF NOT EXISTS gameplay;</sql>
    </changeSet>

    <changeSet id="001-create-affixes-table" author="backend">
        <createTable tableName="affixes" schemaName="gameplay">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="mechanics" type="JSONB"/>
            <column name="visual_effects" type="JSONB"/>
            <column name="reward_modifier" type="DOUBLE PRECISION" defaultValueNumeric="1.0">
                <constraints nullable="false"/>
            </column>
            <column name="difficulty_modifier" type="DOUBLE PRECISION" defaultValueNumeric="1.0">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_affixes_category" tableName="affixes" schemaName="gameplay">
            <column name="category"/>
        </createIndex>
        <addUniqueConstraint tableName="affixes" schemaName="gameplay" columnNames="name" constraintName="uk_affixes_name"/>
    </changeSet>

    <changeSet id="002-create-affix-rotations-tables" author="backend">
        <createTable tableName="affix_rotations" schemaName="gameplay">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="week_start" type="TIMESTAMPTZ">
                <constraints nullable="false"/>
            </column>
            <column name="week_end" type="TIMESTAMPTZ">
                <constraints nullable="false"/>
            </column>
            <column name="seasonal_affix_id" type="UUID">
                <constraints nullable="true" foreignKeyName="fk_affix_rotations_seasonal_affix" references="gameplay.affixes(id)"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="affix_rotations" schemaName="gameplay" columnNames="week_start" constraintName="uk_affix_rotations_week_start"/>

        <createTable tableName="affix_rotation_affixes" schemaName="gameplay">
            <column name="rotation_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_affix_rotation_affixes_rotation" references="gameplay.affix_rotations(id)" deleteCascade="true"/>
            </column>
            <column name="affix_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_affix_rotation_affixes_affix" references="gameplay.affixes(id)" deleteCascade="true"/>
            </column>
            <constraints primaryKey="true" primaryKeyName="pk_affix_rotation_affixes" primaryKeyColumnNames="rotation_id, affix_id"/>
        </createTable>

        <createIndex indexName="idx_affix_rotations_week_start" tableName="affix_rotations" schemaName="gameplay">
            <column name="week_start"/>
        </createIndex>
        <createIndex indexName="idx_affix_rotation_affixes_affix" tableName="affix_rotation_affixes" schemaName="gameplay">
            <column name="affix_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-instance-affixes-table" author="backend">
        <createTable tableName="instance_affixes" schemaName="gameplay">
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="affix_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_instance_affixes_affix" references="gameplay.affixes(id)" deleteCascade="true"/>
            </column>
            <column name="applied_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <constraints primaryKey="true" primaryKeyName="pk_instance_affixes" primaryKeyColumnNames="instance_id, affix_id"/>
        </createTable>

        <createIndex indexName="idx_instance_affixes_instance" tableName="instance_affixes" schemaName="gameplay">
            <column name="instance_id"/>
        </createIndex>
        <createIndex indexName="idx_instance_affixes_applied_at" tableName="instance_affixes" schemaName="gameplay">
            <column name="applied_at"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
