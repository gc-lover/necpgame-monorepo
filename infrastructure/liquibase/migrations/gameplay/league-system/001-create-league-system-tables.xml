<!-- Issue: #44 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- League Seasons Table -->
    <changeSet id="create-league-seasons-table" author="database-engineer">
        <createTable tableName="league_seasons" schemaName="gameplay">
            <column name="season_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="season_number" type="INTEGER">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="season_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="upcoming">
                <constraints nullable="false"/>
            </column>
            <column name="starts_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="ends_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="duration_days" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="meta_rewards" type="JSONB"/>
            <column name="season_theme" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_league_seasons_status" tableName="league_seasons" schemaName="gameplay">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_league_seasons_starts_at" tableName="league_seasons" schemaName="gameplay">
            <column name="starts_at"/>
        </createIndex>

        <createIndex indexName="idx_league_seasons_ends_at" tableName="league_seasons" schemaName="gameplay">
            <column name="ends_at"/>
        </createIndex>

        <comment>League Seasons table - seasonal periods</comment>
    </changeSet>

    <!-- Player League Progress Table -->
    <changeSet id="create-player-league-progress-table" author="database-engineer">
        <createTable tableName="player_league_progress" schemaName="gameplay">
            <column name="progress_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="season_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="league_tier" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="league_points" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="rank" type="INTEGER"/>
            <column name="achievements" type="JSONB"/>
            <column name="rewards_claimed" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="player_league_progress"
            baseColumnNames="season_id"
            referencedTableSchemaName="gameplay"
            referencedTableName="league_seasons"
            referencedColumnNames="season_id"
            constraintName="fk_player_league_progress_season"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="player_league_progress"
            baseColumnNames="player_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_league_progress_player"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_player_league_progress_season" tableName="player_league_progress" schemaName="gameplay">
            <column name="season_id"/>
        </createIndex>

        <createIndex indexName="idx_player_league_progress_player" tableName="player_league_progress" schemaName="gameplay">
            <column name="player_id"/>
        </createIndex>

        <createIndex indexName="idx_player_league_progress_tier" tableName="player_league_progress" schemaName="gameplay">
            <column name="league_tier"/>
        </createIndex>

        <createIndex indexName="idx_player_league_progress_points" tableName="player_league_progress" schemaName="gameplay">
            <column name="league_points" descending="true"/>
        </createIndex>

        <!-- Composite index for leaderboard -->
        <createIndex indexName="idx_player_league_progress_leaderboard" tableName="player_league_progress" schemaName="gameplay">
            <column name="season_id"/>
            <column name="league_tier"/>
            <column name="league_points" descending="true"/>
        </createIndex>

        <!-- Unique constraint: one progress per player per season -->
        <addUniqueConstraint
            schemaName="gameplay"
            tableName="player_league_progress"
            columnNames="season_id, player_id"
            constraintName="uq_player_league_progress_season_player"/>

        <comment>Player League Progress table - player progress in each season</comment>
    </changeSet>

    <!-- Meta Progression Table -->
    <changeSet id="create-meta-progression-table" author="database-engineer">
        <createTable tableName="meta_progression" schemaName="gameplay">
            <column name="meta_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="legacy_points" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="legacy_tier" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_seasons" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="best_rank" type="INTEGER"/>
            <column name="best_tier" type="VARCHAR(20)"/>
            <column name="permanent_bonuses" type="JSONB"/>
            <column name="unlocked_content" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="meta_progression"
            baseColumnNames="player_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_meta_progression_player"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_meta_progression_legacy_points" tableName="meta_progression" schemaName="gameplay">
            <column name="legacy_points" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_meta_progression_legacy_tier" tableName="meta_progression" schemaName="gameplay">
            <column name="legacy_tier" descending="true"/>
        </createIndex>

        <comment>Meta Progression table - permanent progression across seasons</comment>
    </changeSet>

    <!-- League Events Table -->
    <changeSet id="create-league-events-table" author="database-engineer">
        <createTable tableName="league_events" schemaName="gameplay">
            <column name="event_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="season_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="event_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="rewards" type="JSONB"/>
            <column name="starts_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="ends_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="upcoming">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="league_events"
            baseColumnNames="season_id"
            referencedTableSchemaName="gameplay"
            referencedTableName="league_seasons"
            referencedColumnNames="season_id"
            constraintName="fk_league_events_season"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_league_events_season" tableName="league_events" schemaName="gameplay">
            <column name="season_id"/>
        </createIndex>

        <createIndex indexName="idx_league_events_status" tableName="league_events" schemaName="gameplay">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_league_events_starts_at" tableName="league_events" schemaName="gameplay">
            <column name="starts_at"/>
        </createIndex>

        <comment>League Events table - special events within seasons</comment>
    </changeSet>

    <!-- Hall of Fame Table -->
    <changeSet id="create-hall-of-fame-table" author="database-engineer">
        <createTable tableName="hall_of_fame" schemaName="gameplay">
            <column name="fame_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="season_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="achievement_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="achievement_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="achievement_value" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="rank" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="metadata" type="JSONB"/>
            <column name="achieved_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="hall_of_fame"
            baseColumnNames="season_id"
            referencedTableSchemaName="gameplay"
            referencedTableName="league_seasons"
            referencedColumnNames="season_id"
            constraintName="fk_hall_of_fame_season"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="gameplay"
            baseTableName="hall_of_fame"
            baseColumnNames="player_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_hall_of_fame_player"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_hall_of_fame_season" tableName="hall_of_fame" schemaName="gameplay">
            <column name="season_id"/>
        </createIndex>

        <createIndex indexName="idx_hall_of_fame_player" tableName="hall_of_fame" schemaName="gameplay">
            <column name="player_id"/>
        </createIndex>

        <createIndex indexName="idx_hall_of_fame_type" tableName="hall_of_fame" schemaName="gameplay">
            <column name="achievement_type"/>
        </createIndex>

        <createIndex indexName="idx_hall_of_fame_rank" tableName="hall_of_fame" schemaName="gameplay">
            <column name="rank"/>
        </createIndex>

        <comment>Hall of Fame table - top achievements per season</comment>
    </changeSet>

</databaseChangeLog>
