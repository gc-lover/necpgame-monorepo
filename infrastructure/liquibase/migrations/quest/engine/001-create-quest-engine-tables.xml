<!-- Issue: #176 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================================================ -->
    <!-- QUEST TEMPLATES SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Templates Table -->
    <changeSet id="create-quest-templates-table" author="database-engineer">
        <createTable tableName="quest_templates" schemaName="quest">
            <column name="template_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="template_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="template_description" type="TEXT"/>
            <column name="quest_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="quest_category" type="VARCHAR(50)"/>
            <column name="difficulty_level" type="VARCHAR(20)" defaultValue="normal">
                <constraints nullable="false"/>
            </column>
            <column name="estimated_duration_minutes" type="INTEGER"/>
            <column name="max_participants" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="is_repeatable" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="repeat_cooldown_hours" type="INTEGER"/>
            <column name="prerequisites" type="JSONB"/>
            <column name="quest_flow" type="JSONB"/>
            <column name="reward_structure" type="JSONB"/>
            <column name="branching_logic" type="JSONB"/>
            <column name="dialogue_tree" type="JSONB"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_templates_type" tableName="quest_templates" schemaName="quest">
            <column name="quest_type"/>
        </createIndex>

        <createIndex indexName="idx_quest_templates_category" tableName="quest_templates" schemaName="quest">
            <column name="quest_category"/>
        </createIndex>

        <createIndex indexName="idx_quest_templates_difficulty" tableName="quest_templates" schemaName="quest">
            <column name="difficulty_level"/>
        </createIndex>

        <createIndex indexName="idx_quest_templates_active" tableName="quest_templates" schemaName="quest">
            <column name="is_active"/>
        </createIndex>

        <comment>Quest Templates table - reusable quest definitions</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- QUEST INSTANCES SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Instances Table -->
    <changeSet id="create-quest-instances-table" author="database-engineer">
        <createTable tableName="quest_instances" schemaName="quest">
            <column name="instance_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="template_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(30)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="current_branch" type="VARCHAR(100)"/>
            <column name="progress_percentage" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="time_spent_seconds" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="objectives_completed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="objectives_total" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="quest_data" type="JSONB"/>
            <column name="player_choices" type="JSONB"/>
            <column name="completion_data" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_instances_template" tableName="quest_instances" schemaName="quest">
            <column name="template_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_instances_character" tableName="quest_instances" schemaName="quest">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_instances_status" tableName="quest_instances" schemaName="quest">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_quest_instances_started" tableName="quest_instances" schemaName="quest">
            <column name="started_at"/>
        </createIndex>

        <createIndex indexName="idx_quest_instances_expires" tableName="quest_instances" schemaName="quest">
            <column name="expires_at"/>
            <where>status IN ('active', 'paused') AND expires_at IS NOT NULL</where>
        </createIndex>

        <createIndex indexName="idx_quest_instances_character_status" tableName="quest_instances" schemaName="quest">
            <column name="character_id"/>
            <column name="status"/>
        </createIndex>

        <!-- Partial index for active quests -->
        <createIndex indexName="idx_quest_instances_active" tableName="quest_instances" schemaName="quest">
            <column name="character_id"/>
            <column name="updated_at"/>
            <where>status = 'active'</where>
        </createIndex>

        <comment>Quest Instances table - active quest instances per character</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- QUEST OBJECTIVES SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Objectives Table -->
    <changeSet id="create-quest-objectives-table" author="database-engineer">
        <createTable tableName="quest_objectives" schemaName="quest">
            <column name="objective_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="template_objective_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="objective_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="objective_description" type="TEXT"/>
            <column name="progress_current" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="progress_required" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="is_completed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_optional" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="completion_time_seconds" type="INTEGER"/>
            <column name="reward_xp" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="reward_items" type="JSONB"/>
            <column name="conditions" type="JSONB"/>
            <column name="progress_metadata" type="JSONB"/>
            <column name="activated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_objectives_instance" tableName="quest_objectives" schemaName="quest">
            <column name="instance_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_objectives_template" tableName="quest_objectives" schemaName="quest">
            <column name="template_objective_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_objectives_type" tableName="quest_objectives" schemaName="quest">
            <column name="objective_type"/>
        </createIndex>

        <createIndex indexName="idx_quest_objectives_completed" tableName="quest_objectives" schemaName="quest">
            <column name="is_completed"/>
        </createIndex>

        <createIndex indexName="idx_quest_objectives_active" tableName="quest_objectives" schemaName="quest">
            <column name="is_active"/>
        </createIndex>

        <createIndex indexName="idx_quest_objectives_instance_active" tableName="quest_objectives" schemaName="quest">
            <column name="instance_id"/>
            <column name="is_active"/>
            <column name="is_completed"/>
        </createIndex>

        <comment>Quest Objectives table - objective progress tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- DIALOGUE SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Dialogue States Table -->
    <changeSet id="create-quest-dialogue-states-table" author="database-engineer">
        <createTable tableName="quest_dialogue_states" schemaName="quest">
            <column name="dialogue_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="npc_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="current_node_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="dialogue_context" type="VARCHAR(100)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_interaction_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="choices_made" type="JSONB"/>
            <column name="dialogue_metadata" type="JSONB"/>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_dialogue_states_instance" tableName="quest_dialogue_states" schemaName="quest">
            <column name="instance_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_dialogue_states_npc" tableName="quest_dialogue_states" schemaName="quest">
            <column name="npc_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_dialogue_states_active" tableName="quest_dialogue_states" schemaName="quest">
            <column name="is_active"/>
        </createIndex>

        <createIndex indexName="idx_quest_dialogue_states_current_node" tableName="quest_dialogue_states" schemaName="quest">
            <column name="current_node_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_dialogue_states_last_interaction" tableName="quest_dialogue_states" schemaName="quest">
            <column name="last_interaction_at"/>
            <where>is_active = true</where>
        </createIndex>

        <comment>Quest Dialogue States table - dialogue interaction tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- SKILL TESTS SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Skill Tests Table -->
    <changeSet id="create-quest-skill-tests-table" author="database-engineer">
        <createTable tableName="quest_skill_tests" schemaName="quest">
            <column name="skill_test_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="objective_id" type="UUID"/>
            <column name="skill_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="difficulty" type="VARCHAR(20)" defaultValue="medium">
                <constraints nullable="false"/>
            </column>
            <column name="target_number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="roll_result" type="INTEGER"/>
            <column name="final_result" type="INTEGER"/>
            <column name="modifiers_applied" type="JSONB"/>
            <column name="success" type="BOOLEAN"/>
            <column name="critical_success" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="critical_failure" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="test_context" type="VARCHAR(255)"/>
            <column name="tested_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_skill_tests_instance" tableName="quest_skill_tests" schemaName="quest">
            <column name="instance_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_skill_tests_objective" tableName="quest_skill_tests" schemaName="quest">
            <column name="objective_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_skill_tests_skill_type" tableName="quest_skill_tests" schemaName="quest">
            <column name="skill_type"/>
        </createIndex>

        <createIndex indexName="idx_quest_skill_tests_success" tableName="quest_skill_tests" schemaName="quest">
            <column name="success"/>
        </createIndex>

        <createIndex indexName="idx_quest_skill_tests_tested_at" tableName="quest_skill_tests" schemaName="quest">
            <column name="tested_at"/>
        </createIndex>

        <comment>Quest Skill Tests table - skill/attribute test results</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- QUEST REWARDS SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Rewards History Table -->
    <changeSet id="create-quest-rewards-history-table" author="database-engineer">
        <createTable tableName="quest_rewards_history" schemaName="quest">
            <column name="reward_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="reward_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="reward_source" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="base_amount" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="multiplier" type="DECIMAL(5,2)" defaultValue="1.00">
                <constraints nullable="false"/>
            </column>
            <column name="final_amount" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="item_ids" type="UUID[]"/>
            <column name="is_claimed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="claimed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="reward_metadata" type="JSONB"/>
            <column name="granted_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_rewards_history_instance" tableName="quest_rewards_history" schemaName="quest">
            <column name="instance_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_rewards_history_character" tableName="quest_rewards_history" schemaName="quest">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_quest_rewards_history_type" tableName="quest_rewards_history" schemaName="quest">
            <column name="reward_type"/>
        </createIndex>

        <createIndex indexName="idx_quest_rewards_history_claimed" tableName="quest_rewards_history" schemaName="quest">
            <column name="is_claimed"/>
        </createIndex>

        <createIndex indexName="idx_quest_rewards_history_expires" tableName="quest_rewards_history" schemaName="quest">
            <column name="expires_at"/>
            <where>is_claimed = false AND expires_at IS NOT NULL</where>
        </createIndex>

        <createIndex indexName="idx_quest_rewards_history_granted" tableName="quest_rewards_history" schemaName="quest">
            <column name="granted_at"/>
        </createIndex>

        <!-- Partial index for unclaimed rewards -->
        <createIndex indexName="idx_quest_rewards_history_unclaimed" tableName="quest_rewards_history" schemaName="quest">
            <column name="character_id"/>
            <column name="is_claimed"/>
            <where>is_claimed = false</where>
        </createIndex>

        <comment>Quest Rewards History table - quest reward tracking and claiming</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- QUEST BRANCHING SYSTEM -->
    <!-- ============================================================================ -->

    <!-- Quest Branching History Table -->
    <changeSet id="create-quest-branching-history-table" author="database-engineer">
        <createTable tableName="quest_branching_history" schemaName="quest">
            <column name="branch_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instance_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="branch_trigger" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="old_branch" type="VARCHAR(100)"/>
            <column name="new_branch" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="trigger_condition" type="VARCHAR(255)"/>
            <column name="player_choice" type="VARCHAR(255)"/>
            <column name="branch_effects" type="JSONB"/>
            <column name="branched_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_quest_branching_history_instance" tableName="quest_branching_history" schemaName="quest">
            <column name="instance_id"/>
            <column name="branched_at"/>
        </createIndex>

        <createIndex indexName="idx_quest_branching_history_trigger" tableName="quest_branching_history" schemaName="quest">
            <column name="branch_trigger"/>
        </createIndex>

        <createIndex indexName="idx_quest_branching_history_new_branch" tableName="quest_branching_history" schemaName="quest">
            <column name="new_branch"/>
        </createIndex>

        <comment>Quest Branching History table - quest branching decision tracking</comment>
    </changeSet>

    <!-- ============================================================================ -->
    <!-- FOREIGN KEY CONSTRAINTS -->
    <!-- ============================================================================ -->

    <!-- Quest Instances FKs -->
    <changeSet id="add-quest-instances-fks" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_instances"
            baseColumnNames="template_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_templates"
            referencedColumnNames="template_id"
            constraintName="fk_quest_instances_template"
            onDelete="RESTRICT"/>

        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_instances"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_quest_instances_character"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Quest Objectives FK -->
    <changeSet id="add-quest-objectives-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_objectives"
            baseColumnNames="instance_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_instances"
            referencedColumnNames="instance_id"
            constraintName="fk_quest_objectives_instance"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Quest Dialogue States FK -->
    <changeSet id="add-quest-dialogue-states-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_dialogue_states"
            baseColumnNames="instance_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_instances"
            referencedColumnNames="instance_id"
            constraintName="fk_quest_dialogue_states_instance"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Quest Skill Tests FKs -->
    <changeSet id="add-quest-skill-tests-fks" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_skill_tests"
            baseColumnNames="instance_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_instances"
            referencedColumnNames="instance_id"
            constraintName="fk_quest_skill_tests_instance"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_skill_tests"
            baseColumnNames="objective_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_objectives"
            referencedColumnNames="objective_id"
            constraintName="fk_quest_skill_tests_objective"
            onDelete="SET NULL"/>
    </changeSet>

    <!-- Quest Rewards History FK -->
    <changeSet id="add-quest-rewards-history-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_rewards_history"
            baseColumnNames="instance_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_instances"
            referencedColumnNames="instance_id"
            constraintName="fk_quest_rewards_history_instance"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- Quest Branching History FK -->
    <changeSet id="add-quest-branching-history-fk" author="database-engineer">
        <addForeignKeyConstraint
            baseTableSchemaName="quest"
            baseTableName="quest_branching_history"
            baseColumnNames="instance_id"
            referencedTableSchemaName="quest"
            referencedTableName="quest_instances"
            referencedColumnNames="instance_id"
            constraintName="fk_quest_branching_history_instance"
            onDelete="CASCADE"/>
    </changeSet>

</databaseChangeLog>