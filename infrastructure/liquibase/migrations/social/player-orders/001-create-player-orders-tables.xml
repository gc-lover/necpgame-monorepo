<!-- Issue: #43 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Player Orders Table -->
    <changeSet id="create-player-orders-table" author="database-engineer">
        <createTable tableName="player_orders" schemaName="social">
            <column name="order_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="creator_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="order_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="reward_ed" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="reward_items" type="JSONB"/>
            <column name="reward_rep" type="INTEGER" defaultValue="0"/>
            <column name="requirements" type="JSONB"/>
            <column name="objectives" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="available">
                <constraints nullable="false"/>
            </column>
            <column name="executor_id" type="UUID"/>
            <column name="max_executors" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="current_executors" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="region" type="VARCHAR(100)"/>
            <column name="difficulty" type="VARCHAR(20)"/>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="player_orders"
            baseColumnNames="creator_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_orders_creator"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="player_orders"
            baseColumnNames="executor_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_player_orders_executor"
            onDelete="SET NULL"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_player_orders_creator" tableName="player_orders" schemaName="social">
            <column name="creator_id"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_executor" tableName="player_orders" schemaName="social">
            <column name="executor_id"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_type" tableName="player_orders" schemaName="social">
            <column name="order_type"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_status" tableName="player_orders" schemaName="social">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_region" tableName="player_orders" schemaName="social">
            <column name="region"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_expires_at" tableName="player_orders" schemaName="social">
            <column name="expires_at"/>
            <column name="status"/>
        </createIndex>

        <!-- Composite indexes for common queries -->
        <createIndex indexName="idx_player_orders_active" tableName="player_orders" schemaName="social">
            <column name="status"/>
            <column name="order_type"/>
            <column name="region"/>
        </createIndex>

        <createIndex indexName="idx_player_orders_search" tableName="player_orders" schemaName="social">
            <column name="order_type"/>
            <column name="difficulty"/>
            <column name="reward_ed"/>
        </createIndex>

        <comment>Player Orders table - orders created by players</comment>
    </changeSet>

    <!-- Order Executors Table (for multi-executor orders) -->
    <changeSet id="create-order-executors-table" author="database-engineer">
        <createTable tableName="order_executors" schemaName="social">
            <column name="executor_entry_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="executor_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="accepted">
                <constraints nullable="false"/>
            </column>
            <column name="progress" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="accepted_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="order_executors"
            baseColumnNames="order_id"
            referencedTableSchemaName="social"
            referencedTableName="player_orders"
            referencedColumnNames="order_id"
            constraintName="fk_order_executors_order"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="order_executors"
            baseColumnNames="executor_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_order_executors_executor"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_order_executors_order" tableName="order_executors" schemaName="social">
            <column name="order_id"/>
        </createIndex>

        <createIndex indexName="idx_order_executors_executor" tableName="order_executors" schemaName="social">
            <column name="executor_id"/>
            <column name="status"/>
        </createIndex>

        <!-- Unique constraint: one executor entry per order -->
        <addUniqueConstraint
            schemaName="social"
            tableName="order_executors"
            columnNames="order_id, executor_id"
            constraintName="uq_order_executors_order_executor"/>

        <comment>Order Executors table - executors for multi-executor orders</comment>
    </changeSet>

    <!-- Order Reviews Table -->
    <changeSet id="create-order-reviews-table" author="database-engineer">
        <createTable tableName="order_reviews" schemaName="social">
            <column name="review_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="reviewer_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="reviewee_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="INTEGER">
                <constraints nullable="false" checkConstraint="rating BETWEEN 1 AND 5"/>
            </column>
            <column name="comment" type="TEXT"/>
            <column name="review_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="order_reviews"
            baseColumnNames="order_id"
            referencedTableSchemaName="social"
            referencedTableName="player_orders"
            referencedColumnNames="order_id"
            constraintName="fk_order_reviews_order"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="order_reviews"
            baseColumnNames="reviewer_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_order_reviews_reviewer"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="order_reviews"
            baseColumnNames="reviewee_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_order_reviews_reviewee"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_order_reviews_order" tableName="order_reviews" schemaName="social">
            <column name="order_id"/>
        </createIndex>

        <createIndex indexName="idx_order_reviews_reviewer" tableName="order_reviews" schemaName="social">
            <column name="reviewer_id"/>
        </createIndex>

        <createIndex indexName="idx_order_reviews_reviewee" tableName="order_reviews" schemaName="social">
            <column name="reviewee_id"/>
        </createIndex>

        <!-- Unique constraint: one review per order -->
        <addUniqueConstraint
            schemaName="social"
            tableName="order_reviews"
            columnNames="order_id, reviewer_id, reviewee_id"
            constraintName="uq_order_reviews_order_reviewer_reviewee"/>

        <comment>Order Reviews table - reputation system for orders</comment>
    </changeSet>

</databaseChangeLog>

