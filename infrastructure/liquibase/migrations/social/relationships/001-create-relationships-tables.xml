<!-- Issue: #43 -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Relationships Table -->
    <changeSet id="create-relationships-table" author="database-engineer">
        <createTable tableName="relationships" schemaName="social">
            <column name="relationship_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_a_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="character_b_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="relationship_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="trust_level" type="INTEGER" defaultValue="0">
                <constraints nullable="false" checkConstraint="trust_level BETWEEN -100 AND 100"/>
            </column>
            <column name="affinity" type="INTEGER" defaultValue="0">
                <constraints nullable="false" checkConstraint="affinity BETWEEN 0 AND 100"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="metadata" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="relationships"
            baseColumnNames="character_a_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_relationships_character_a"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="relationships"
            baseColumnNames="character_b_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_relationships_character_b"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_relationships_character_a" tableName="relationships" schemaName="social">
            <column name="character_a_id"/>
        </createIndex>

        <createIndex indexName="idx_relationships_character_b" tableName="relationships" schemaName="social">
            <column name="character_b_id"/>
        </createIndex>

        <createIndex indexName="idx_relationships_type" tableName="relationships" schemaName="social">
            <column name="relationship_type"/>
        </createIndex>

        <createIndex indexName="idx_relationships_status" tableName="relationships" schemaName="social">
            <column name="status"/>
        </createIndex>

        <!-- Composite index for common queries -->
        <createIndex indexName="idx_relationships_active" tableName="relationships" schemaName="social">
            <column name="character_a_id"/>
            <column name="relationship_type"/>
            <column name="status"/>
        </createIndex>

        <!-- Unique constraint: one relationship per pair -->
        <addUniqueConstraint
            schemaName="social"
            tableName="relationships"
            columnNames="character_a_id, character_b_id, relationship_type"
            constraintName="uq_relationships_pair_type"/>

        <comment>Relationships table - social connections between characters</comment>
    </changeSet>

    <!-- Family Relationships Table -->
    <changeSet id="create-family-relationships-table" author="database-engineer">
        <createTable tableName="family_relationships" schemaName="social">
            <column name="family_relation_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="relative_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="relation_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="is_blood_related" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="family_relationships"
            baseColumnNames="character_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_family_relationships_character"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="family_relationships"
            baseColumnNames="relative_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_family_relationships_relative"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_family_relationships_character" tableName="family_relationships" schemaName="social">
            <column name="character_id"/>
        </createIndex>

        <createIndex indexName="idx_family_relationships_relative" tableName="family_relationships" schemaName="social">
            <column name="relative_id"/>
        </createIndex>

        <!-- Unique constraint: one family relationship per pair -->
        <addUniqueConstraint
            schemaName="social"
            tableName="family_relationships"
            columnNames="character_id, relative_id, relation_type"
            constraintName="uq_family_relationships_pair_type"/>

        <comment>Family Relationships table - family connections</comment>
    </changeSet>

    <!-- Mentorship Table -->
    <changeSet id="create-mentorship-table" author="database-engineer">
        <createTable tableName="mentorship" schemaName="social">
            <column name="mentorship_id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="mentor_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="student_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="skill_category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="skill_level" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="lessons_completed" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="progress_percent" type="INTEGER" defaultValue="0">
                <constraints nullable="false" checkConstraint="progress_percent BETWEEN 0 AND 100"/>
            </column>
            <column name="started_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="mentorship"
            baseColumnNames="mentor_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_mentorship_mentor"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableSchemaName="social"
            baseTableName="mentorship"
            baseColumnNames="student_id"
            referencedTableSchemaName="character"
            referencedTableName="characters"
            referencedColumnNames="character_id"
            constraintName="fk_mentorship_student"
            onDelete="CASCADE"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_mentorship_mentor" tableName="mentorship" schemaName="social">
            <column name="mentor_id"/>
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_mentorship_student" tableName="mentorship" schemaName="social">
            <column name="student_id"/>
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_mentorship_skill" tableName="mentorship" schemaName="social">
            <column name="skill_category"/>
        </createIndex>

        <comment>Mentorship table - mentor-student relationships</comment>
    </changeSet>

</databaseChangeLog>
