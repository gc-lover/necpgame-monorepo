# Issue: #142109960
# Network Security Configuration
# Network Engineer - Security settings for network connections

network_security_config:
  version: "1.0.0"
  last_updated: "2025-11-30"
  description: |
    Конфигурация сетевой безопасности для гибридной сетевой архитектуры.
    Включает rate limiting, CORS, защиту от DDoS и другие меры безопасности.

  rate_limiting:
    websocket_connections:
      max_connections_per_ip: 10
      window_seconds: 60
      burst: 5
      action_on_exceed: "reject"
    
    websocket_messages:
      max_messages_per_second: 60
      window_seconds: 1
      burst: 10
      action_on_exceed: "throttle"
    
    udp_connections:
      max_connections_per_ip: 5
      window_seconds: 60
      burst: 2
      action_on_exceed: "reject"
    
    udp_packets:
      max_packets_per_second: 128
      window_seconds: 1
      burst: 20
      action_on_exceed: "drop"
    
    http_requests:
      max_requests_per_minute: 100
      window_seconds: 60
      burst: 20
      action_on_exceed: "throttle"

  connection_limits:
    websocket:
      max_concurrent_connections: 10000
      max_connections_per_ip: 10
      connection_timeout_seconds: 300
      idle_timeout_seconds: 60
    
    udp:
      max_concurrent_connections: 10000
      max_connections_per_ip: 5
      connection_timeout_seconds: 60
      idle_timeout_seconds: 30
    
    global:
      max_total_connections: 20000
      max_connections_per_ip: 15

  cors_configuration:
    enabled: true
    allowed_origins:
      - "https://necpgame.com"
      - "https://www.necpgame.com"
      - "https://game.necpgame.com"
      - "http://localhost:3000"
      - "http://localhost:8080"
    
    allowed_methods:
      - "GET"
      - "POST"
      - "OPTIONS"
      - "PUT"
      - "DELETE"
    
    allowed_headers:
      - "Content-Type"
      - "Authorization"
      - "X-Requested-With"
      - "X-Session-Token"
    
    exposed_headers:
      - "X-Session-Token"
      - "X-Request-ID"
    
    max_age_seconds: 3600
    allow_credentials: true

  tls_configuration:
    websocket:
      enabled: true
      min_version: "TLSv1.2"
      cipher_suites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
      cert_file: "/etc/ssl/certs/necpgame.crt"
      key_file: "/etc/ssl/private/necpgame.key"
    
    udp:
      enabled: false
      description: |
        UDP не поддерживает TLS напрямую.
        Используется DTLS для защиты UDP соединений (если требуется).

  ddos_protection:
    enabled: true
    ip_whitelist:
      enabled: false
      allowed_ips: []
    
    ip_blacklist:
      enabled: true
      auto_blacklist: true
      blacklist_duration_minutes: 60
      blacklist_threshold:
        connection_attempts: 100
        window_seconds: 60
    
    connection_syn_flood_protection:
      enabled: true
      max_syn_requests_per_second: 50
      syn_timeout_seconds: 30
    
    packet_flood_protection:
      enabled: true
      max_packets_per_second: 1000
      window_seconds: 1

  input_validation:
    websocket:
      max_message_size_bytes: 65536
      min_message_size_bytes: 1
      allowed_message_types:
        - "text"
        - "binary"
      validate_json: true
      validate_protobuf: true
    
    udp:
      max_packet_size_bytes: 1472
      min_packet_size_bytes: 1
      validate_protobuf: true
      validate_sequence_numbers: true
    
    http:
      max_request_size_bytes: 1048576
      max_headers_size_bytes: 8192
      max_url_length: 2048

  authentication:
    session_token:
      required: true
      validation_method: "jwt"
      token_expiry_seconds: 3600
      refresh_threshold_seconds: 300
    
    rate_limiting:
      max_authentication_attempts: 5
      window_seconds: 300
      lockout_duration_seconds: 900

  logging:
    enabled: true
    log_level: "info"
    log_connections: true
    log_disconnections: true
    log_errors: true
    log_rate_limit_violations: true
    log_security_events: true
    log_sensitive_data: false

  monitoring:
    enabled: true
    metrics:
      - "connections_total"
      - "connections_active"
      - "messages_per_second"
      - "packets_per_second"
      - "rate_limit_violations"
      - "security_events"
      - "ddos_attacks_blocked"
    
    alerts:
      - name: "high_connection_rate"
        threshold: 1000
        window_seconds: 60
        severity: "warning"
      
      - name: "ddos_detected"
        threshold: 5000
        window_seconds: 10
        severity: "critical"
      
      - name: "rate_limit_exceeded"
        threshold: 100
        window_seconds: 60
        severity: "info"

  envoy_configuration:
    rate_limit_service:
      enabled: true
      grpc_service:
        timeout_ms: 20
        cluster_name: "rate_limit_service"
    
    filters:
      - name: "envoy.filters.http.ratelimit"
        config:
          domain: "network_security"
          failure_mode_deny: false
      
      - name: "envoy.filters.http.cors"
        config:
          allow_origin_string_match:
            - prefix: "*"
          allow_methods: "GET, POST, OPTIONS, PUT, DELETE"
          allow_headers: "Content-Type, Authorization, X-Requested-With, X-Session-Token"
          expose_headers: "X-Session-Token, X-Request-ID"
          max_age: "3600"
          allow_credentials: true
      
      - name: "envoy.filters.network.connection_limit"
        config:
          max_connections: 10000
          delay_ms: 100
    
    listener_filters:
      - name: "envoy.filters.listener.original_dst"
      
      - name: "envoy.filters.listener.tls_inspector"
        config:
          enabled: true

  implementation_notes:
    envoy_integration:
      - "Rate limiting через external rate limit service"
      - "CORS через envoy.filters.http.cors"
      - "Connection limits через envoy.filters.network.connection_limit"
      - "TLS termination на уровне Envoy"
    
    application_integration:
      - "Session token validation в GatewayHandler"
      - "Rate limiting на уровне WebSocket/UDP handlers"
      - "IP blacklist через Redis"
      - "Security events logging в централизованный лог"

