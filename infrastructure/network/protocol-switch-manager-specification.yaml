# Issue: #142109960
# Protocol Switch Manager Specification
# Network Engineer - Specification for dynamic protocol switching (WebSocket ↔ UDP)

protocol_switch_manager_specification:
  version: "1.0.0"
  last_updated: "2025-11-30"
  description: |
    Спецификация модуля Protocol Switch Manager для управления
    динамическим переключением протоколов WebSocket ↔ UDP только
    в открытом мире для бесшовной миграции между PvE и PvP режимами.

  scope:
    supported_switches:
      - from: "WebSocket (TCP)"
        to: "UDP"
        zone_type: "Open world zones"
        trigger: "Player enters combat or PvP zone"
      
      - from: "UDP"
        to: "WebSocket (TCP)"
        zone_type: "Open world zones"
        trigger: "Player leaves combat or PvP zone"
    
    not_supported:
      - "Safe zones (always WebSocket)"
      - "Dedicated PvP zones (always UDP)"

  switching_triggers:
    websocket_to_udp:
      - name: "Combat engagement"
        description: "Игрок вступает в бой с другим игроком"
        detection_method: "Zone Manager or Game Server event"
        priority: "high"
        delay_ms: 0-100
      
      - name: "PvP zone entry"
        description: "Игрок входит в PvP-активную зону"
        detection_method: "Zone Manager zone type check"
        priority: "high"
        delay_ms: 0-200
      
      - name: "Player proximity"
        description: "Игрок находится вблизи других игроков в PvP зоне"
        detection_method: "Spatial Partitioning Engine"
        priority: "medium"
        delay_ms: 200-500
      
      - name: "Manual switch request"
        description: "Игрок запрашивает переключение вручную"
        detection_method: "Client request"
        priority: "low"
        delay_ms: 0
    
    udp_to_websocket:
      - name: "Combat end"
        description: "Игрок выходит из боя (нет противников 5+ секунд)"
        detection_method: "Game Server combat state"
        priority: "high"
        delay_ms: 5000
      
      - name: "Safe zone entry"
        description: "Игрок входит в безопасную зону"
        detection_method: "Zone Manager zone type check"
        priority: "high"
        delay_ms: 0-200
      
      - name: "Low activity"
        description: "Низкая активность в PvP зоне (нет противников в радиусе)"
        detection_method: "Spatial Partitioning Engine"
        priority: "medium"
        delay_ms: 10000
      
      - name: "Manual switch request"
        description: "Игрок запрашивает переключение вручную"
        detection_method: "Client request"
        priority: "low"
        delay_ms: 0

  switching_process:
    phases:
      phase_1_preparation:
        name: "Preparation"
        description: "Подготовка к переключению протокола"
        steps:
          - "Validate switch request (triggers, session state)"
          - "Notify Session Manager about pending switch"
          - "Get current session state and critical data"
          - "Prepare target protocol connection parameters"
        duration_ms: 50-100
      
      phase_2_synchronization:
        name: "State Synchronization"
        description: "Синхронизация критических данных между протоколами"
        steps:
          - "Extract critical game state (position, health, inventory)"
          - "Serialize critical data to Protobuf"
          - "Send critical state via current protocol"
          - "Verify client received critical state"
        duration_ms: 100-200
        critical_data:
          - "Player position (x, y, z)"
          - "Player rotation"
          - "Player health and shields"
          - "Active status effects"
          - "Equipped items"
          - "Current zone and coordinates"
      
      phase_3_overlap:
        name: "Overlap Period"
        description: "Период одновременной работы обоих протоколов"
        steps:
          - "Establish connection via target protocol"
          - "Send updates via both protocols simultaneously"
          - "Monitor connection quality for target protocol"
          - "Verify client is ready to switch"
        duration_ms: 1000-2000
        min_duration_ms: 1000
        max_duration_ms: 5000
        update_frequency:
          source_protocol: "Normal tickrate"
          target_protocol: "Normal tickrate"
      
      phase_4_switchover:
        name: "Switchover"
        description: "Переключение на новый протокол"
        steps:
          - "Client confirms target protocol ready"
          - "Update Session Manager (new protocol active)"
          - "Stop sending updates via source protocol"
          - "Close or idle source protocol connection"
          - "Mark switch complete"
        duration_ms: 50-100
      
      phase_5_cleanup:
        name: "Cleanup"
        description: "Очистка после переключения"
        steps:
          - "Clean up source protocol resources"
          - "Update metrics and logs"
          - "Notify monitoring systems"
        duration_ms: 100-500

    total_duration_ms: 1200-2900

  fallback_mechanism:
    scenarios:
      - name: "Target protocol connection failed"
        action: "Remain on source protocol"
        retry_after_ms: 5000
        max_retries: 3
        notify_client: true
      
      - name: "State synchronization failed"
        action: "Cancel switch, remain on source protocol"
        retry_after_ms: 10000
        max_retries: 2
        notify_client: true
      
      - name: "Client timeout during overlap"
        action: "Cancel switch, close target connection"
        retry_after_ms: 30000
        max_retries: 1
        notify_client: true
      
      - name: "Network error during switch"
        action: "Rollback to source protocol"
        recovery_time_ms: 1000
        notify_client: true
    
    rollback_procedure:
      steps:
        - "Stop target protocol updates"
        - "Resume source protocol updates"
        - "Update Session Manager (switch cancelled)"
        - "Clean up target protocol connection"
        - "Log rollback reason"
      duration_ms: 200-500

  state_management:
    switch_states:
      - name: "idle"
        description: "Нет активного переключения"
      
      - name: "preparing"
        description: "Подготовка к переключению"
      
      - name: "synchronizing"
        description: "Синхронизация состояния"
      
      - name: "overlapping"
        description: "Период overlap (оба протокола активны)"
      
      - name: "switching"
        description: "Активное переключение"
      
      - name: "completed"
        description: "Переключение завершено"
      
      - name: "failed"
        description: "Переключение не удалось"
      
      - name: "rollback"
        description: "Откат переключения"
    
    state_transitions:
      - from: "idle"
        to: "preparing"
        trigger: "Switch trigger detected"
      
      - from: "preparing"
        to: "synchronizing"
        trigger: "Preparation complete"
      
      - from: "synchronizing"
        to: "overlapping"
        trigger: "State sync complete"
      
      - from: "overlapping"
        to: "switching"
        trigger: "Client confirms ready"
      
      - from: "switching"
        to: "completed"
        trigger: "Switchover complete"
      
      - from: "any"
        to: "failed"
        trigger: "Error during switch"
      
      - from: "failed"
        to: "idle"
        trigger: "Cleanup complete"
      
      - from: "any"
        to: "rollback"
        trigger: "Rollback required"

  integration:
    with_session_manager:
      methods:
        - "GetSessionState(session_id) -> SessionState"
        - "UpdateSessionProtocol(session_id, protocol)"
        - "NotifySwitchStart(session_id, switch_info)"
        - "NotifySwitchComplete(session_id, new_protocol)"
        - "NotifySwitchFailed(session_id, error)"
      
      session_state_updates:
        - "protocol_switching = true/false"
        - "current_protocol = websocket/udp"
        - "switch_start_time"
        - "switch_status"
    
    with_zone_manager:
      methods:
        - "GetZoneProtocol(zone_id) -> protocol"
        - "GetZoneType(zone_id) -> zone_type"
        - "CanSwitchProtocol(zone_id) -> bool"
        - "GetZoneConfig(zone_id) -> ZoneConfig"
    
    with_websocket_gateway:
      methods:
        - "GetConnectionState(session_id) -> ConnectionState"
        - "SendCriticalState(session_id, state_data)"
        - "CloseConnection(session_id, graceful)"
        - "PauseUpdates(session_id)"
        - "ResumeUpdates(session_id)"
    
    with_udp_gateway:
      methods:
        - "CreateConnection(session_id, config) -> ConnectionInfo"
        - "GetConnectionState(session_id) -> ConnectionState"
        - "SendCriticalState(session_id, state_data)"
        - "CloseConnection(session_id, graceful)"
        - "PauseUpdates(session_id)"
        - "ResumeUpdates(session_id)"

  endpoints:
    http_endpoints:
      - method: "POST"
        path: "/api/v1/protocol/switch/request"
        request: "ProtocolSwitchRequest"
        response: "ProtocolSwitchResponse"
        purpose: "Запрос на переключение протокола"
      
      - method: "GET"
        path: "/api/v1/protocol/switch/status/{session_id}"
        response: "ProtocolSwitchStatus"
        purpose: "Статус переключения протокола"
      
      - method: "POST"
        path: "/api/v1/protocol/switch/cancel/{session_id}"
        response: "ProtocolSwitchResponse"
        purpose: "Отмена переключения протокола"
    
    websocket_endpoints:
      - path: "/ws/protocol/switch"
        purpose: "Уведомления о переключении протокола"
        messages:
          - "ProtocolSwitchStatusUpdate"
          - "ProtocolSwitchComplete"
          - "ProtocolSwitchFailed"

  performance_requirements:
    switch_latency:
      p50_ms: 1500
      p95_ms: 2500
      p99_ms: 3000
      max_ms: 5000
    
    concurrent_switches:
      max_per_server: 100
      max_per_zone: 50
    
    state_sync_size:
      max_bytes: 10240
      compression: "optional gzip"

  error_handling:
    validation_errors:
      - name: "Invalid session"
        action: "Reject switch, return error"
      
      - name: "Zone does not support switching"
        action: "Reject switch, return error"
      
      - name: "Switch already in progress"
        action: "Return current switch status"
    
    network_errors:
      - name: "Source protocol connection lost"
        action: "Cancel switch, attempt recovery"
      
      - name: "Target protocol connection failed"
        action: "Rollback, remain on source"
    
    timeout_errors:
      - name: "State sync timeout"
        action: "Cancel switch, retry later"
      
      - name: "Client confirmation timeout"
        action: "Cancel switch, close target connection"

  monitoring:
    metrics:
      switch_metrics:
        - "switches_initiated_total"
        - "switches_completed_total"
        - "switches_failed_total"
        - "switch_duration_seconds"
        - "switch_duration_by_phase_seconds"
      
      success_rate:
        - "switch_success_rate_percent"
        - "switch_failure_rate_percent"
        - "switch_rollback_rate_percent"
      
      latency_metrics:
        - "switch_latency_p50_ms"
        - "switch_latency_p95_ms"
        - "switch_latency_p99_ms"
    
    logging:
      log_level: "info"
      log_all_switches: true
      log_failures: true
      log_performance: true
      log_state_transitions: false

  security:
    validation:
      - "Session token validation"
      - "Zone access validation"
      - "Rate limiting (max 1 switch per 10 seconds)"
    
    protection:
      - "Prevent switch spam"
      - "Validate switch triggers"
      - "Audit all switch attempts"

