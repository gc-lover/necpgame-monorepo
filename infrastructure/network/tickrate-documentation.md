# Документация требований к тикрейту и сетевой нагрузке

**Issue:** #142109960  
**Агент:** Network Engineer  
**Версия:** 1.0.0  
**Дата:** 2025-11-30

## Обзор

Данная документация описывает требования к тикрейту (tick rate) для различных типов активностей игры, расчеты сетевой нагрузки и оптимизации для обеспечения оптимальной производительности.

## Типы зон и требования к тикрейту

### 1. PvE зоны (MMORPG)

**Протокол:** WebSocket (TCP)  
**Тикрейт:** 20-30 Hz  
**Задержка:** <100 мс  
**Игроков:** 100-500  

#### Характеристики:
- Надежный протокол TCP для стабильности
- Умеренная частота обновлений
- Фокус на стабильность, а не минимальную задержку
- Поддержка большого количества игроков

#### Сетевая нагрузка:
- **На игрока:** 10-20 KB/sec
- **На зону (500 игроков):** 5-10 MB/sec
- **Боевые действия:** 10-15 KB/sec на игрока
- **Движение:** 2-5 KB/sec на игрока

### 2. PvP small (5-20 игроков)

**Протокол:** UDP  
**Тикрейт:** 60-128 Hz  
**Задержка:** <30 мс  
**Игроков:** 5-20  

#### Характеристики:
- Высокая частота обновлений для отзывчивости
- Минимальная задержка критична
- Полная синхронизация (все видят всех)
- Spatial partitioning не используется (мало игроков)

#### Сетевая нагрузка:
- **На игрока:** 20-30 KB/sec
- **На зону (20 игроков):** 400-600 KB/sec
- **Боевые действия:** 15-25 KB/sec на игрока
- **Движение:** 5-10 KB/sec на игрока

### 3. GvG 200 (100v100)

**Протокол:** UDP  
**Тикрейт:** 60-80 Hz  
**Задержка:** <40 мс  
**Игроков:** 200  

#### Характеристики:
- Spatial partitioning для оптимизации (80-90% снижение трафика)
- Средняя частота обновлений
- Видимость ограничена 3x3 сеткой (своя ячейка + 8 соседних)
- Максимум 50 видимых игроков на клиент

#### Сетевая нагрузка:
- **На игрока:** 15-25 KB/sec (с оптимизацией)
- **На зону (200 игроков):** 3-5 MB/sec
- **Оптимизация:** Spatial partitioning, grid 100x100 метров

### 4. GvG 400 (200v200)

**Протокол:** UDP  
**Тикрейт:** 40-60 Hz  
**Задержка:** <50 мс  
**Игроков:** 400  

#### Характеристики:
- Spatial sharding для масштабирования (2-4 shards)
- Более низкая частота обновлений
- Разделение зоны на shards по координатам
- Синхронизация между shards на границах

#### Сетевая нагрузка:
- **На игрока:** 12-20 KB/sec (с sharding)
- **На зону (400 игроков):** 4.8-8 MB/sec
- **Оптимизация:** Spatial sharding, event aggregation

### 5. Massive war (2000+ игроков)

**Протокол:** UDP  
**Тикрейт:** 20-40 Hz  
**Задержка:** <100 мс  
**Игроков:** 2000+  

#### Характеристики:
- Кластерная архитектура (5-10 серверов)
- Низкая частота обновлений
- LOD система для дальних объектов
- Event aggregation для снижения трафика

#### Сетевая нагрузка:
- **На игрока:** 8-15 KB/sec (с оптимизацией)
- **На зону (2000 игроков):** 16-30 MB/sec
- **Оптимизация:** Cluster, sharding, LOD, event aggregation

## Расчеты сетевой нагрузки

### По типам механик

#### Gameplay механики:
- **Боевые действия:** 60-128 updates/sec
- **Способности:** event-based, 5-10 events/sec
- **Импланты:** event-based, 0.1-0.5 events/sec
- **Паркур:** 60-128 updates/sec
- **Общий трафик:** 10-20 KB/sec на игрока

#### Economy механики:
- **Торговля:** event-based, 0.5-2 events/sec
- **Крафт:** event-based, 0.1-0.5 events/sec
- **Инвентарь:** event-based, 1-3 events/sec
- **Рынок:** event-based, 0.5-1 events/sec
- **Общий трафик:** 0.5-2 KB/sec на игрока

#### Social механики:
- **Отношения:** event-based, 0.1-0.3 events/sec
- **Найм NPC:** event-based, 0.05-0.1 events/sec
- **Заказы:** event-based, 0.1-0.5 events/sec
- **Репутация:** event-based, 0.1-0.3 events/sec
- **Общий трафик:** 0.3-0.8 KB/sec на игрока

#### World механики:
- **Мировые события:** 1-10 Hz
- **Рейды:** event-based, 0.1-0.5 events/sec
- **Боссы (в бою):** 20-30 Hz
- **Состояние мира:** 1-5 Hz
- **Общий трафик:** 1-3 KB/sec на игрока

## Оптимизации для снижения нагрузки

### 1. Spatial Partitioning (для средних битв)

**Применение:** GvG 200, открытый мир PvP  
**Эффективность:** 80-90% снижение трафика

#### Технические детали:
- Разделение зоны на сетку 100x100 метров
- Видимость ограничена 3x3 ячейками (своя + 8 соседних)
- Максимум 50 видимых игроков на клиент
- Обновления отправляются только для видимых игроков

#### Расчет трафика:
- **Без оптимизации:** 200 игроков × 20 KB/sec = 4 MB/sec на игрока
- **С оптимизацией:** 50 видимых × 20 KB/sec = 1 MB/sec на игрока
- **Снижение:** 75%

### 2. Spatial Sharding (для больших битв)

**Применение:** GvG 400, Massive war  
**Эффективность:** 85-90% снижение трафика

#### Технические детали:
- Разделение зоны на shards (серверы)
- Игроки видят только свой shard + граничные зоны
- Синхронизация между shards на границах (edge buffer)
- Shard size: 200-300 метров

#### Расчет трафика:
- **Без оптимизации:** 400 игроков × 20 KB/sec = 8 MB/sec на игрока
- **С оптимизацией:** 100 игроков в shard × 20 KB/sec = 2 MB/sec на игрока
- **Снижение:** 75%

### 3. Event Aggregation (батчинг)

**Применение:** GvG 400, Massive war  
**Эффективность:** 60-70% снижение трафика

#### Технические детали:
- Группировка событий в батчи
- Окно батчинга: 100-200 мс
- Максимум 50-100 событий в батче
- Применяется к некритичным событиям

#### Расчет трафика:
- **Без оптимизации:** 100 событий/сек × 100 байт = 10 KB/sec
- **С оптимизацией:** 10 батчей/сек × 500 байт = 5 KB/sec
- **Снижение:** 50%

### 4. LOD система (Level of Detail)

**Применение:** Massive war  
**Эффективность:** 50-70% снижение трафика

#### Технические детали:
- Разные уровни детализации по расстоянию
- Близкие объекты (0-50 м): полная детализация, 40 Hz
- Средние объекты (50-100 м): сниженная детализация, 30 Hz
- Дальние объекты (100-200 м): минимальная детализация, 20 Hz

#### Расчет трафика:
- **Без оптимизации:** 100 игроков × 20 KB/sec = 2 MB/sec
- **С оптимизацией:** 20 близких × 20 KB + 30 средних × 10 KB + 50 дальних × 5 KB = 1.05 MB/sec
- **Снижение:** 47%

## Адаптивный тикрейт

### Принцип работы

Адаптивный тикрейт автоматически снижается при большом количестве игроков и повышается для критичных механик.

### Факторы влияния

1. **Количество игроков (вес: 60%)**
   - 0-50 игроков: 100% от базового тикрейта
   - 50-100 игроков: 100% от базового тикрейта
   - 100-200 игроков: 80% от базового тикрейта
   - 200-400 игроков: 60% от базового тикрейта
   - 400-1000 игроков: 50% от базового тикрейта
   - 1000+ игроков: 40% от базового тикрейта

2. **Сетевая задержка (вес: 30%)**
   - 0-50 мс: 100% от базового тикрейта
   - 50-100 мс: 90% от базового тикрейта
   - 100-200 мс: 70% от базового тикрейта
   - 200+ мс: 50% от базового тикрейта

3. **Загрузка CPU (вес: 10%)**
   - 0-50%: 100% от базового тикрейта
   - 50-70%: 95% от базового тикрейта
   - 70-90%: 80% от базового тикрейта
   - 90%+: 60% от базового тикрейта

### Приоритетные механики

Следующие механики имеют приоритет и не снижаются:
- Боевые действия (combat)
- Движение (movement)
- Здоровье (health)

### Защищенные механики

Следующие механики используют фиксированный тикрейт:
- Инвентарь (inventory)
- Торговля (trading)
- Квесты (quests)

## Рекомендации по реализации

### 1. Конфигурация тикрейта

Все значения тикрейта должны быть конфигурируемыми через файлы конфигурации:
- `infrastructure/network/tickrate-config.yaml` - runtime конфигурация
- `infrastructure/network/tickrate-specification.yaml` - спецификация

### 2. Мониторинг

Необходимо отслеживать:
- Текущий тикрейт по зонам
- Сетевая задержка
- Загрузка CPU/памяти
- Количество игроков в зоне
- Использование bandwidth

### 3. Метрики

Ключевые метрики для мониторинга:
- `tickrate_current` - текущий тикрейт
- `tickrate_target` - целевой тикрейт
- `network_latency_ms` - задержка сети
- `cpu_usage_percent` - загрузка CPU
- `players_in_zone` - количество игроков
- `bandwidth_usage_kbps` - использование bandwidth

### 4. Адаптация

Адаптация тикрейта должна происходить:
- Каждые 5 секунд
- При изменении количества игроков > 10%
- При изменении задержки > 20 мс
- При изменении загрузки CPU > 10%

## Примеры использования

### Пример 1: PvE зона

```yaml
zone_type: safe_zones
protocol: websocket
tickrate: 30 Hz
players: 150
network_load: 15 KB/sec на игрока
```

### Пример 2: PvP small

```yaml
zone_type: pvp_small
protocol: udp
tickrate: 128 Hz
players: 12
network_load: 25 KB/sec на игрока
```

### Пример 3: GvG 200

```yaml
zone_type: gvg_200
protocol: udp
tickrate: 80 Hz
players: 200
spatial_partitioning: enabled
network_load: 18 KB/sec на игрока (с оптимизацией)
```

### Пример 4: Massive war

```yaml
zone_type: massive_war
protocol: udp
tickrate: 40 Hz
players: 1500
cluster: enabled (8 servers)
spatial_sharding: enabled (10 shards)
lod_system: enabled
network_load: 10 KB/sec на игрока (с оптимизацией)
```

## Заключение

Данная документация определяет требования к тикрейту для всех типов активностей игры. Следование этим требованиям обеспечит оптимальную производительность и игровой опыт для всех сценариев игры.

