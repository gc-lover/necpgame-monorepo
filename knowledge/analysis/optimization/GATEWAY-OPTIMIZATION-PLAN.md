# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ WebSocket Gateway –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä

## [SEARCH] –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (BroadcastToClients)**
    - –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
    - –ü—Ä–∏ 100 –∫–ª–∏–µ–Ω—Ç–∞—Ö: 100 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö WriteMessage –≤—ã–∑–æ–≤–æ–≤
    - –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å—Ç–µ—Ç –ª–∏–Ω–µ–π–Ω–æ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤

2. **–ú–∞–ª–µ–Ω—å–∫–∏–µ –±—É—Ñ–µ—Ä—ã**
    - `ReadBufferSize: 4096` –∏ `WriteBufferSize: 4096` –±–∞–π—Ç
    - –î–ª—è 60 Hz –∏–≥—Ä —ç—Ç–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

3. **–ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
    - `WriteMessage` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—É
    - –ù–µ—Ç –ø—É–ª–∞ –≥–æ—Ä—É—Ç–∏–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞—Ç—á–∏–Ω–≥–∞**
    - –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
    - –ù–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

5. **–ù–µ—Ç –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏**
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π snapshot –∫–∞–∂–¥—ã–µ 16 –º—Å
    - –ú–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö

---

## [TARGET] –û—Å–Ω–æ–≤–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è MMORPG

### 1. **–°–µ—Ç–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

#### 1.1 –î–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (Delta Compression)

**–ß—Ç–æ —ç—Ç–æ**: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –°–Ω–∏–∂–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ 60-90%
- –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
type DeltaState struct {
    LastTick    int64
    LastState   map[string]*EntityState
    ChangedKeys []string
}

func CalculateDelta(old, new *GameState) *DeltaState {
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∏ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –†–∞–∑–º–µ—Ä GameState: —Å 200 –±–∞–π—Ç –¥–æ 50-80 –±–∞–π—Ç (60% —ç–∫–æ–Ω–æ–º–∏–∏)
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: —Å 200 KB/s –¥–æ 80 KB/s –¥–ª—è 100 –∫–ª–∏–µ–Ω—Ç–æ–≤

#### 1.2 –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (Adaptive Update Rate)

**–ß—Ç–æ —ç—Ç–æ**: –†–∞–∑–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–ª–∏–∑–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –ë–ª–∏–∑–∫–∏–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥–Ω—ã —á–µ—Ç—á–µ ‚Üí –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–∞—â–µ (60 Hz)
- –î–∞–ª—å–Ω–∏–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥–Ω—ã —Ö—É–∂–µ ‚Üí –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ä–µ–∂–µ (10-20 Hz)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
type UpdatePriority struct {
    PlayerID  string
    Distance  float32
    UpdateHz  int  // 60, 30, 10 Hz
    LastUpdate time.Time
}

func CalculateUpdatePriority(player, target *PlayerState) UpdatePriority {
    distance := CalculateDistance(player, target)
    if distance < 100 { return UpdatePriority{UpdateHz: 60} }
    if distance < 500 { return UpdatePriority{UpdateHz: 30} }
    return UpdatePriority{UpdateHz: 10}
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 40-60% –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–æ–Ω
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤

#### 1.3 Spatial Partitioning (–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ)

**–ß—Ç–æ —ç—Ç–æ**: –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Å–≤–æ–µ–º —Å–µ–∫—Ç–æ—Ä–µ

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –ò–≥—Ä–æ–∫ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –æ–±—ä–µ–∫—Ç—ã
- –ù–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–∞–ª–µ–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
type SpatialGrid struct {
    CellSize  float32
    Grid      map[GridCoord]*Cell
}

type Cell struct {
    Players []*PlayerState
}

func (grid *SpatialGrid) GetRelevantPlayers(player *PlayerState) []*PlayerState {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö —è—á–µ–π–∫–∞—Ö
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 70-90% –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–æ–Ω
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 1000+ –∏–≥—Ä–æ–∫–æ–≤

#### 1.4 –ë–∞—Ç—á–∏–Ω–≥ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ (Batching)

**–ß—Ç–æ —ç—Ç–æ**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –æ–¥–∏–Ω –ø–∞–∫–µ—Ç

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –°–Ω–∏–∂–∞–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
- –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
type MessageBatch struct {
    Messages []*GameState
    MaxSize  int
    MaxDelay time.Duration
}

func (batch *MessageBatch) Add(message *GameState) {
    batch.Messages = append(batch.Messages, message)
    if len(batch.Messages) >= batch.MaxSize {
        batch.Flush()
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ 30-50%
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ CPU –Ω–∞–≥—Ä—É–∑–∫–∏

---

### 2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞**

#### 2.1 –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (Parallel Broadcast) [OK] –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ–∫—É—â–∏–π `BroadcastToClients` –æ—Ç–ø—Ä–∞–≤–ª—è–ª –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

**–†–µ—à–µ–Ω–∏–µ**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ –≥–æ—Ä—É—Ç–∏–Ω—ã + mutex –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `services/realtime-gateway-go/server/handler.go`

```go
func (h *GatewayHandler) BroadcastToClientsParallel(data []byte) {
    // –°–æ–∑–¥–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    h.clientConnsMu.RLock()
    clients := make([]*ClientConnection, 0, len(h.clientConns))
    for _, clientConn := range h.clientConns {
        clients = append(clients, clientConn)
    }
    h.clientConnsMu.RUnlock()
    
    deadline := h.getWriteDeadline()
    var wg sync.WaitGroup
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç concurrent write
    for _, clientConn := range clients {
        wg.Add(1)
        go func(cc *ClientConnection) {
            defer wg.Done()
            cc.mu.Lock()  // –ó–∞—â–∏—Ç–∞ –æ—Ç concurrent write –Ω–∞ –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            defer cc.mu.Unlock()
            cc.conn.SetWriteDeadline(deadline)
            cc.conn.WriteMessage(websocket.BinaryMessage, data)
        }(clientConn)
    }
    wg.Wait()
}
```

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç**:

- [OK] –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: **11,467 msg/s** –ø—Ä–∏ 190 –∫–ª–∏–µ–Ω—Ç–∞—Ö
- [OK] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —Å **0% –æ—à–∏–±–æ–∫** (10-190 –∫–ª–∏–µ–Ω—Ç–æ–≤)
- [OK] –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π
- [OK] –õ–∏–Ω–µ–π–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (~60 msg/s –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞)

**–í–∞–∂–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:

- [WARNING] –î–æ–±–∞–≤–ª–µ–Ω `ClientConnection` —Å mutex –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è concurrent write panic
- [WARNING] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `DialContext` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

#### 2.2 –ü—É–ª –≥–æ—Ä—É—Ç–∏–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≥–æ—Ä—É—Ç–∏–Ω—É

**–†–µ—à–µ–Ω–∏–µ**: –ü—É–ª –≥–æ—Ä—É—Ç–∏–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```go
type WorkerPool struct {
    workers  int
    jobQueue chan *MessageJob
}

type MessageJob struct {
    Conn *websocket.Conn
    Data []byte
}

func (pool *WorkerPool) Start() {
    for i := 0; i < pool.workers; i++ {
        go pool.worker()
    }
}

func (pool *WorkerPool) worker() {
    for job := range pool.jobQueue {
        job.Conn.WriteMessage(websocket.BinaryMessage, job.Data)
    }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –ö–æ–Ω—Ç—Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Ä—É—Ç–∏–Ω

#### 2.3 –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ [OK] –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: –ë—É—Ñ–µ—Ä—ã 4096 –±–∞–π—Ç —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ

**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–µ–Ω—ã –±—É—Ñ–µ—Ä—ã –¥–æ 32 KB

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `services/realtime-gateway-go/server/websocket_server.go`

```go
upgrader: websocket.Upgrader{
    ReadBufferSize:  32 * 1024,  // 32 KB
    WriteBufferSize: 32 * 1024,  // 32 KB
}
```

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç**:

- [OK] –ú–µ–Ω—å—à–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- [OK] –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [OK] –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (190 –∫–ª–∏–µ–Ω—Ç–æ–≤)

#### 2.4 Write Deadline –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è [OK] –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π deadline 10 —Å–µ–∫—É–Ω–¥

**–†–µ—à–µ–Ω–∏–µ**: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π deadline –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `services/realtime-gateway-go/server/handler.go`

```go
func (h *GatewayHandler) getWriteDeadline() time.Time {
    if h.tickRate > 0 {
        return time.Now().Add(time.Duration(1000/h.tickRate) * time.Millisecond)
    }
    return time.Now().Add(16 * time.Millisecond)  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 Hz
}
```

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç**:

- [OK] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏
- [OK] Deadline –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (60 Hz = ~16 –º—Å)

---

### 3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏**

#### 3.1 Object Pooling

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤

```go
var messagePool = sync.Pool{
    New: func() interface{} {
        return &GameStateData{
            Entities: make([]EntityState, 0, 100),
        }
    },
}

func getMessage() *GameStateData {
    return messagePool.Get().(*GameStateData)
}

func putMessage(msg *GameStateData) {
    msg.Entities = msg.Entities[:0]
    messagePool.Put(msg)
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GC
- –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 10-20%

#### 3.2 Pre-allocated slices

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–ª–∞–π—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

```go
entities := make([]EntityState, 0, 100)  // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ 100
```

---

### 4. **–ü—Ä–æ—Ç–æ–∫–æ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

#### 4.1 –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ß—Ç–æ —ç—Ç–æ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–∂–∞—Ç–∏—è (gzip, zstd, snappy)

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- Protobuf —É–∂–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω, –Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
import "github.com/klauspost/compress/s2"

func CompressGameState(data []byte) []byte {
    return s2.Encode(nil, data)
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- –°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ 30-50% –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –î–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ —É –Ω–∞—Å) —ç—Ñ—Ñ–µ–∫—Ç –º–µ–Ω—å—à–µ (5-15%)

#### 4.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Protobuf: –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (Coordinate Quantization) [SYMBOL] –í –ü–õ–ê–ù–ê–•

**–ß—Ç–æ —ç—Ç–æ**: –ó–∞–º–µ–Ω–∞ float32 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ sint32 —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- Float32 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–Ω–∏–º–∞—é—Ç 5 –±–∞–π—Ç (tag + 4 –±–∞–π—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏—è)
- Sint32 varint –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–Ω–∏–º–∞—é—Ç 3-4 –±–∞–π—Ç–∞ (tag + 2-3 –±–∞–π—Ç–∞ varint)
- –≠–∫–æ–Ω–æ–º–∏—è: 20-40% —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**:

- –ò—Å–ø–æ–ª—å–∑—É–µ–º float32 –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (X, Y, Z, VX, VY, VZ, Yaw) = 7 –ø–æ–ª–µ–π √ó 5 –±–∞–π—Ç = 35 –±–∞–π—Ç
- –î–ª—è EntityState: ~38-46 –±–∞–π—Ç –Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å
- PlayerInput (MoveX, MoveY, AimX, AimY) = 4 –ø–æ–ª—è √ó 5 –±–∞–π—Ç = 20 –±–∞–π—Ç

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ: sint32 —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º 0.1 —Å–º**

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
// proto_handler.go
type EntityState struct {
    ID  string
    X   int32   // sint32: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ 0.1 —Å–º (–≤–º–µ—Å—Ç–æ float32)
    Y   int32   // sint32: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ 0.1 —Å–º
    Z   int32   // sint32: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ 0.1 —Å–º
    VX  int32   // sint32: —Å–∫–æ—Ä–æ—Å—Ç—å –≤ 0.1 —Å–º/—Å
    VY  int32   // sint32: —Å–∫–æ—Ä–æ—Å—Ç—å –≤ 0.1 —Å–º/—Å
    VZ  int32   // sint32: —Å–∫–æ—Ä–æ—Å—Ç—å –≤ 0.1 —Å–º/—Å
    Yaw int32   // sint32: —É–≥–æ–ª –≤ 0.1 –≥—Ä–∞–¥—É—Å–∞
}

// UE5 ‚Üí Protobuf (–æ—Ç–ø—Ä–∞–≤–∫–∞):
Entity.X = FMath::RoundToInt(Location.X * 10.0f);  // —Å–º ‚Üí 0.1 —Å–º

// Protobuf ‚Üí UE5 (–ø—Ä–∏–µ–º):
Location.X = Entity.X / 10.0f;  // 0.1 —Å–º ‚Üí —Å–º
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- EntityState: 35 –±–∞–π—Ç ‚Üí 21 –±–∞–π—Ç (—ç–∫–æ–Ω–æ–º–∏—è: 14 –±–∞–π—Ç, 40%)
- PlayerInput: 20 –±–∞–π—Ç ‚Üí 12 –±–∞–π—Ç (—ç–∫–æ–Ω–æ–º–∏—è: 8 –±–∞–π—Ç, 40%)
- –î–ª—è 390 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ 60 Hz:
    - PlayerInput: ~183 KB/s —ç–∫–æ–Ω–æ–º–∏–∏
    - GameState: ~320 KB/s —ç–∫–æ–Ω–æ–º–∏–∏
    - **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è: ~500 KB/s** –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö

**–ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏**:

- –¢–µ–∫—É—â–∞—è: ¬±0.01 —Å–º (0.1 –º–º) - —Ç–æ—á–Ω–æ—Å—Ç—å float32
- –ü–æ—Å–ª–µ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è: ¬±0.1 —Å–º (1 –º–º) - —Ç–æ—á–Ω–æ—Å—Ç—å sint32 (0.1 —Å–º)
- –ü–æ—Ç–µ—Ä—è: 10x —Ç–æ—á–Ω–æ—Å—Ç–∏
- –í–ª–∏—è–Ω–∏–µ: –ù–µ –∑–∞–º–µ—Ç–Ω–æ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ (1 –º–º = 0.1 –º–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏ 1920x1080)

**–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏**:

- CS:GO: ~1 —Å–º —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
- Quake 3: ~0.1 —Å–º (1 –º–º) - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞
- Valorant: ~0.5-1 —Å–º - –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ + –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü† –í—ã—Å–æ–∫–∏–π (—ç–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ 40% –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `knowledge/analysis/optimization/COORDINATE-QUANTIZATION-ANALYSIS.md`

#### 4.3 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Protobuf: –ò–Ω–¥–µ–∫—Å—ã –∏–≥—Ä–æ–∫–æ–≤ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫ [SYMBOL] –í –ü–õ–ê–ù–ê–•

**–ß—Ç–æ —ç—Ç–æ**: –ó–∞–º–µ–Ω–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö PlayerID/EntityID –Ω–∞ —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –°—Ç—Ä–æ–∫–æ–≤—ã–µ ID –∑–∞–Ω–∏–º–∞—é—Ç 3-11 –±–∞–π—Ç (tag + length + data)
    - –¢–µ–∫—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç: "p00000001" = 9 –±–∞–π—Ç
    - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: "p1" = 2 –±–∞–π—Ç–∞ (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –ß–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∑–∞–Ω–∏–º–∞—é—Ç 1-2 –±–∞–π—Ç–∞ (varint uint32)
    - –î–ª—è 390 –∫–ª–∏–µ–Ω—Ç–æ–≤: uint16 (1-2 –±–∞–π—Ç–∞ varint) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
    - –≠–∫–æ–Ω–æ–º–∏—è: 1-7 –±–∞–π—Ç –Ω–∞ ID (50-80%)

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**:

- PlayerID –≤ PlayerInput: "p00000001" (9 –±–∞–π—Ç) ‚Üí —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–æ "p1" (2 –±–∞–π—Ç–∞)
- EntityID –≤ EntityState: "p1" (2 –±–∞–π—Ç–∞) ‚Üí –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ uint16 (1-2 –±–∞–π—Ç–∞)

**–†–µ—à–µ–Ω–∏–µ: –ß–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏–≥—Ä–æ–∫–æ–≤**

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```go
// –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: –º–∞–ø–ø–∏–Ω–≥ ID ‚Üí –∏–Ω–¥–µ–∫—Å
type PlayerIndexMap struct {
    IDToIndex map[string]uint16  // "p1" ‚Üí 1
    IndexToID map[uint16]string  // 1 ‚Üí "p1"
    nextIndex uint16
    mu        sync.RWMutex
}

// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞:
func (m *PlayerIndexMap) RegisterPlayer(id string) uint16 {
    m.mu.Lock()
    defer m.mu.Unlock()
    if idx, exists := m.IDToIndex[id]; exists {
        return idx
    }
    idx := m.nextIndex
    m.nextIndex++
    m.IDToIndex[id] = idx
    m.IndexToID[idx] = id
    return idx
}

// –í Protobuf:
type PlayerInputData struct {
    PlayerIndex uint16  // –≤–º–µ—Å—Ç–æ PlayerID string
    Tick        int64
    MoveX       float32  // –∏–ª–∏ int32 –ø–æ—Å–ª–µ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è
    // ...
}

type EntityState struct {
    Index uint16  // –≤–º–µ—Å—Ç–æ ID string
    X     int32   // –ø–æ—Å–ª–µ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è
    // ...
}
```

**–ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ –∏–Ω–¥–µ–∫—Å–∞–º–∏**:

```go
// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤
type PlayerIndexMapping struct {
    PlayerID    string
    PlayerIndex uint16
}

// –ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –ª–æ–∫–∞–ª—å–Ω–æ
// –ü—Ä–∏ –ø—Ä–∏–µ–º–µ EntityState: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:

- EntityID: 2 –±–∞–π—Ç–∞ ‚Üí 1-2 –±–∞–π—Ç–∞ varint (—ç–∫–æ–Ω–æ–º–∏—è: 0-1 –±–∞–π—Ç, 0-50%)
- PlayerID: 2 –±–∞–π—Ç–∞ ‚Üí 1-2 –±–∞–π—Ç–∞ varint (—ç–∫–æ–Ω–æ–º–∏—è: 0-1 –±–∞–π—Ç, 0-50%)
- –î–ª—è 390 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ 60 Hz:
    - PlayerInput: 390 √ó 60 √ó 1 –±–∞–π—Ç = ~23 KB/s —ç–∫–æ–Ω–æ–º–∏–∏
    - GameState (390 —Å—É—â–Ω–æ—Å—Ç–µ–π): 390 √ó 60 √ó 1 –±–∞–π—Ç = ~23 KB/s —ç–∫–æ–Ω–æ–º–∏–∏
    - **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è: ~46 KB/s** –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:

- [OK] –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (—ç–∫–æ–Ω–æ–º–∏—è 0-1 –±–∞–π—Ç –Ω–∞ ID)
- [OK] –ë—ã—Å—Ç—Ä–µ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (uint16 –≤–º–µ—Å—Ç–æ string)
- [OK] –ú–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- [OK] –õ–µ–≥—á–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ –º–∞—Å—Å–∏–≤–∞—Ö

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:

- [WARNING] –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- [WARNING] –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∏–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
- [WARNING] –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞ (–Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å ‚Üí ID –¥–ª—è –ª–æ–≥–æ–≤)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ ID**

- –¢–µ–∫—É—â–∏–π: "p1" (2 –±–∞–π—Ç–∞) - —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π ("1" = 1 –±–∞–π—Ç)
- –ù–æ: —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤—Å–µ —Ä–∞–≤–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π (—ç–∫–æ–Ω–æ–º–∏—è –º–µ–Ω—å—à–µ, —á–µ–º –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

---

### 5. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

#### 5.1 –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∑–æ–Ω–∞–º (Zone-based)

**–ß—Ç–æ —ç—Ç–æ**: –†–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã/–ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 5.2 Rate Limiting

**–ß—Ç–æ —ç—Ç–æ**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**:

- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∞—Ç–∞–∫

```go
type RateLimiter struct {
    limits map[string]*TokenBucket
}

func (rl *RateLimiter) Allow(playerID string) bool {
    bucket := rl.limits[playerID]
    return bucket.Allow()
}
```

---

## [SYMBOL] –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–±–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):

- **–ú–∞–∫—Å–∏–º—É–º –∫–ª–∏–µ–Ω—Ç–æ–≤**: 10-20 —Å—Ç–∞–±–∏–ª—å–Ω–æ (–ø—Ä–∏ –±–æ–ª—å—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∏ –ø–∞–¥–µ–Ω–∏—è)
- **–í—Ä–µ–º—è —Ä–∞—Å—Å—ã–ª–∫–∏**: 50-100 –º—Å –¥–ª—è 10 –∫–ª–∏–µ–Ω—Ç–æ–≤
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: ~23 KB/s
- **–†–∞–∑–º–µ—Ä GameState**: 200 –±–∞–π—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
- **–ü—Ä–æ–±–ª–µ–º—ã**: Concurrent write panic –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–µ

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è           | –£–ª—É—á—à–µ–Ω–∏–µ                                                     | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç         |
|-----------------------|---------------------------------------------------------------|-------------------|
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ | 5-10x —Å–∫–æ—Ä–æ—Å—Ç—å                                                | [SYMBOL] –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤    | 2-3x –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å                                       | [SYMBOL] –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –î–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è     | 60% —ç–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞                                          | üü† –í—ã—Å–æ–∫–∏–π        |
| –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç | 40% —ç–∫–æ–Ω–æ–º–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (~500 KB/s –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö) | üü† –í—ã—Å–æ–∫–∏–π        |
| –ò–Ω–¥–µ–∫—Å—ã –∏–≥—Ä–æ–∫–æ–≤       | 50-80% —ç–∫–æ–Ω–æ–º–∏—è ID (~46 KB/s –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö)                | üü° –°—Ä–µ–¥–Ω–∏–π        |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞    | 40-60% —ç–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞                                       | üü† –í—ã—Å–æ–∫–∏–π        |
| Spatial Partitioning  | 70-90% –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–æ–Ω                                        | üü° –°—Ä–µ–¥–Ω–∏–π        |
| –ë–∞—Ç—á–∏–Ω–≥               | 30-50% —Å–Ω–∏–∂–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤                                       | üü° –°—Ä–µ–¥–Ω–∏–π        |
| Object Pooling        | 10-20% CPU                                                    | üü¢ –ù–∏–∑–∫–∏–π         |

### –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π):

- **–ú–∞–∫—Å–∏–º—É–º –∫–ª–∏–µ–Ω—Ç–æ–≤**: 200-500 —Å—Ç–∞–±–∏–ª—å–Ω–æ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
- **–í—Ä–µ–º—è —Ä–∞—Å—Å—ã–ª–∫–∏**: 5-10 –º—Å –¥–ª—è 100 –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: 150-200 KB/s (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
- **–†–∞–∑–º–µ—Ä GameState**: 50-80 –±–∞–π—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–µ–ª—å—Ç–∞) (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)

### –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –§–∞–∑—ã 1:

- **–ú–∞–∫—Å–∏–º—É–º –∫–ª–∏–µ–Ω—Ç–æ–≤**: [OK] **190 —Å—Ç–∞–±–∏–ª—å–Ω–æ** (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ)
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: [OK] **11,467 msg/s** –ø—Ä–∏ 190 –∫–ª–∏–µ–Ω—Ç–∞—Ö (60 Hz)
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: [OK] **~4.4 MB/s** –ø—Ä–∏ 190 –∫–ª–∏–µ–Ω—Ç–∞—Ö
- **–û—à–∏–±–∫–∏**: [OK] **0%** –≤–æ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∞—Ö (10-190 –∫–ª–∏–µ–Ω—Ç–æ–≤)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: [OK] –õ–∏–Ω–µ–π–Ω–∞—è (~60 msg/s –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞)

---

## [ROCKET] –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã)

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ [OK] –í–´–ü–û–õ–ù–ï–ù–û

1. [OK] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (`BroadcastToClientsParallel`)
    - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `services/realtime-gateway-go/server/handler.go`
    - –î–æ–±–∞–≤–ª–µ–Ω mutex –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è concurrent write panic
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ –≥–æ—Ä—É—Ç–∏–Ω—ã —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
2. [OK] –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ (32 KB)
    - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `services/realtime-gateway-go/server/websocket_server.go`
    - –ë—É—Ñ–µ—Ä—ã —É–≤–µ–ª–∏—á–µ–Ω—ã —Å 4 KB –¥–æ 32 KB
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–µ–Ω—å—à–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –ª—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
3. [OK] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Write Deadline
    - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `services/realtime-gateway-go/server/handler.go` (–º–µ—Ç–æ–¥ `getWriteDeadline()`)
    - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π deadline –Ω–∞ –æ—Å–Ω–æ–≤–µ tickRate (–¥–ª—è 60 Hz: ~16 –º—Å)
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:

- [OK] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **190 –∫–ª–∏–µ–Ω—Ç–æ–≤** —Å—Ç–∞–±–∏–ª—å–Ω–æ (0% –æ—à–∏–±–æ–∫)
- [OK] –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: **11,467 msg/s** –ø—Ä–∏ 190 –∫–ª–∏–µ–Ω—Ç–∞—Ö (60 Hz)
- [OK] –õ–∏–Ω–µ–π–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: ~60 msg/s –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
- [OK] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å 0% –æ—à–∏–±–æ–∫

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

- `services/realtime-gateway-go/cmd/loadtest/main.go` - –ë–∞–∑–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `services/realtime-gateway-go/cmd/findlimit/main.go` - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–µ–ª–∞ Gateway
- `scripts/testing/run-loadtest.ps1` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- `scripts/testing/run-findlimit.ps1` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–µ–ª–∞
- `scripts/testing/README-LOADTEST.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- `scripts/testing/README-FINDLIMIT.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É –ø—Ä–µ–¥–µ–ª–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (findlimit)**:

```
[OK] RECOMMENDED LIMIT: 190 clients (with error threshold: 1.00%)

Clients    | Success    | Input (msg/s) | Errors | Error % | Latency (ms)
---------------------------------------------------------------------------------------
10         | [OK] PASS     | 621.14       | 0      | 0.00    | 0.00        
30         | [OK] PASS     | 1849.56      | 0      | 0.00    | 0.00        
50         | [OK] PASS     | 3106.82      | 0      | 0.00    | 0.00        
70         | [OK] PASS     | 4296.80      | 0      | 0.00    | 0.00        
90         | [OK] PASS     | 5534.96      | 0      | 0.00    | 0.00        
110        | [OK] PASS     | 6664.02      | 0      | 0.00    | 0.00        
130        | [OK] PASS     | 7838.91      | 0      | 0.00    | 0.00        
150        | [OK] PASS     | 8898.29      | 0      | 0.00    | 0.00        
170        | [OK] PASS     | 10286.40     | 0      | 0.00    | 0.00        
190        | [OK] PASS     | 11467.21     | 0      | 0.00    | 0.00        
```

**–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:

- [WARNING] Concurrent write panic –±—ã–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º mutex –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

### –§–∞–∑–∞ 2: –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ [OK] –í–´–ü–û–õ–ù–ï–ù–û

4. [OK] –î–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è GameState
    - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `services/realtime-gateway-go/server/delta_compression.go`
    - –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–æ 60%
5. ‚è≥ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–æ—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ –§–∞–∑—É 3)
6. [OK] Object Pooling –¥–ª—è GameState
    - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `services/realtime-gateway-go/server/delta_compression.go`
    - –ü—É–ª –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è GameStateData
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GC –Ω–∞ 10-20%

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:

- [OK] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **390 –∫–ª–∏–µ–Ω—Ç–æ–≤** —Å—Ç–∞–±–∏–ª—å–Ω–æ (0% –æ—à–∏–±–æ–∫, 95%+ –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)
- [OK] –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: **23,075 msg/s** –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö (60 Hz)
- [OK] –£–¥–≤–æ–µ–Ω–∏–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –§–∞–∑–æ–π 1 (190 ‚Üí 390 –∫–ª–∏–µ–Ω—Ç–æ–≤)
- [OK] –£–¥–≤–æ–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (11,467 ‚Üí 23,075 msg/s)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

- 330-390 –∫–ª–∏–µ–Ω—Ç–æ–≤: [OK] PASSED (0% –æ—à–∏–±–æ–∫, 95-100% –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)
- 410-450 –∫–ª–∏–µ–Ω—Ç–æ–≤: [ERROR] FAILED (–ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç –¥–æ 75-87%)
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—Ä–µ–¥–µ–ª**: 390 –∫–ª–∏–µ–Ω—Ç–æ–≤

**–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:

- `services/realtime-gateway-go/server/delta_compression.go` - –º–æ–¥—É–ª—å –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏ Object Pooling

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:

- `services/realtime-gateway-go/server/handler.go` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –≤ BroadcastGameStateWithDelta
- `services/realtime-gateway-go/server/proto_handler.go` - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ GameState –¥–ª—è –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** (–æ–±–Ω–æ–≤–ª–µ–Ω—ã):

- –£–ª—É—á—à–µ–Ω `findlimit`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º 95% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π)

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (3-5 –¥–Ω–µ–π) [SYMBOL] –í –ü–õ–ê–ù–ê–•

7. ‚è≥ –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (sint32 —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º 0.1 —Å–º)
    - –ó–∞–º–µ–Ω–∞ float32 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ sint32 –≤ Protobuf
    - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ UE5 –∏ Gateway
    - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
    - –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: ~500 KB/s —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö (40% –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
8. ‚è≥ –ò–Ω–¥–µ–∫—Å—ã –∏–≥—Ä–æ–∫–æ–≤ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö ID
    - –ú–∞–ø–ø–∏–Ω–≥ PlayerID ‚Üí uint16 –∏–Ω–¥–µ–∫—Å
    - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    - –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: ~46 KB/s —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö (50-80% ID –¥–∞–Ω–Ω—ã—Ö)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:

- –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞: ~546 KB/s –ø—Ä–∏ 390 –∫–ª–∏–µ–Ω—Ç–∞—Ö
- –†–∞–∑–º–µ—Ä EntityState: —Å 38-46 –±–∞–π—Ç –¥–æ 24-32 –±–∞–π—Ç
- –†–∞–∑–º–µ—Ä PlayerInput: —Å ~37 –±–∞–π—Ç –¥–æ ~29 –±–∞–π—Ç

### –§–∞–∑–∞ 4: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (5-7 –¥–Ω–µ–π) [SYMBOL] –í –ü–õ–ê–ù–ê–•

9. ‚è≥ Spatial Partitioning
10. ‚è≥ –ë–∞—Ç—á–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π
11. ‚è≥ Rate Limiting

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 500+ –∫–ª–∏–µ–Ω—Ç–æ–≤, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ GvG –±–∏—Ç–≤–∞–º

---

## [BOOK] –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Å—Ç–∞—Ç—å–∏:

1. **MMORPG Network Optimization**: –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è MMORPG
2. **TCM (Tunneling, Compressing and Multiplexing)**: –¢–µ—Ö–Ω–∏–∫–∞ —Å–Ω–∏–∂–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ MMORPG –Ω–∞ 60%
3. **Delta Compression**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ WoW, EVE Online)

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

- **Gorilla WebSocket**: –¢–µ–∫—É—â–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, —Ö–æ—Ä–æ—à–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- **Snappy/S2**: –ë—ã—Å—Ç—Ä–æ–µ —Å–∂–∞—Ç–∏–µ —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **pprof**: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ Go –∫–æ–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç

---

## [WARNING] –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ò–∑–º–µ—Ä—è–π—Ç–µ –¥–æ –∏ –ø–æ—Å–ª–µ**: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: –ù–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –≤—Å–µ —Å—Ä–∞–∑—É, –¥–µ–ª–∞–π—Ç–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏
3. **–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ pprof –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É–∑–∫–∏—Ö –º–µ—Å—Ç
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ Prometheus –≤–æ –≤—Ä–µ–º—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

---

## [TARGET] –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### [OK] –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. [OK] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –§–∞–∑–∞ 1 (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
2. [OK] –ü—Ä–æ–≤–µ–¥–µ–Ω–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (10-190 –∫–ª–∏–µ–Ω—Ç–æ–≤)
3. [OK] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã (190 –∫–ª–∏–µ–Ω—Ç–æ–≤, 0% –æ—à–∏–±–æ–∫)
4. [OK] –°–æ–∑–¥–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–µ–ª–∞ (`findlimit`)

### [SYMBOL] –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:

1. [OK] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –§–∞–∑—É 2 (–¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è GameState) - –í–´–ü–û–õ–ù–ï–ù–û
2. [OK] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π - –í–´–ü–û–õ–ù–ï–ù–û
3. [OK] –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ/–ø–æ—Å–ª–µ –¥–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ - –í–´–ü–û–õ–ù–ï–ù–û
4. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–§–∞–∑–∞ 3)
5. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏–≥—Ä–æ–∫–æ–≤ (–§–∞–∑–∞ 3)
6. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–§–∞–∑–∞ 4)

## [SYMBOL] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–±–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):

- –ú–∞–∫—Å–∏–º—É–º –∫–ª–∏–µ–Ω—Ç–æ–≤: **10-20** (—Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ)
- –û—à–∏–±–∫–∏: –ü–∞–¥–µ–Ω–∏—è –∏ concurrent write panic –ø—Ä–∏ 10+ –∫–ª–∏–µ–Ω—Ç–∞—Ö
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ~**23 KB/s**

### –ü–æ—Å–ª–µ –§–∞–∑—ã 1 (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):

- –ú–∞–∫—Å–∏–º—É–º –∫–ª–∏–µ–Ω—Ç–æ–≤: [OK] **190** (—Å—Ç–∞–±–∏–ª—å–Ω–æ, 0% –æ—à–∏–±–æ–∫)
- –û—à–∏–±–∫–∏: [OK] **0%** –≤–æ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∞—Ö
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: [OK] **11,467 msg/s** (~**4.4 MB/s**) –ø—Ä–∏ 190 –∫–ª–∏–µ–Ω—Ç–∞—Ö
- –£–ª—É—á—à–µ–Ω–∏–µ: [OK] **~8x** –ø–æ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- –£–ª—É—á—à–µ–Ω–∏–µ: [OK] **~19x** –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–ª–∏–µ–Ω—Ç–æ–≤

## [SYMBOL] –°—Å—ã–ª–∫–∏ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

- **loadtest**: `services/realtime-gateway-go/cmd/loadtest/main.go` - –ë–∞–∑–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **findlimit**: `services/realtime-gateway-go/cmd/findlimit/main.go` - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–µ–ª–∞ Gateway

### –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞:

- **run-loadtest.ps1**: `scripts/testing/run-loadtest.ps1` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- **run-findlimit.ps1**: `scripts/testing/run-findlimit.ps1` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–µ–ª–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- **README-LOADTEST.md**: `scripts/testing/README-LOADTEST.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- **README-FINDLIMIT.md**: `scripts/testing/README-FINDLIMIT.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É –ø—Ä–µ–¥–µ–ª–∞
- **QUICK-START-LOADTEST.md**: `scripts/testing/QUICK-START-LOADTEST.md` - –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É
  —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- **QUICK-START-FINDLIMIT.md**: `scripts/testing/QUICK-START-FINDLIMIT.md` - –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–æ–∏—Å–∫—É –ø—Ä–µ–¥–µ–ª–∞
- **COORDINATE-QUANTIZATION-ANALYSIS.md**: `knowledge/analysis/optimization/COORDINATE-QUANTIZATION-ANALYSIS.md` -
  –ê–Ω–∞–ª–∏–∑ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- **TICK-AND-DATA-TYPES.md**: `knowledge/analysis/optimization/TICK-AND-DATA-TYPES.md` - –ê–Ω–∞–ª–∏–∑ —Ç–∏–∫–æ–≤ –∏ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **PROTOBUF-SIZE-OPTIMIZATION.md**: `knowledge/analysis/optimization/PROTOBUF-SIZE-OPTIMIZATION.md` - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
  —Ä–∞–∑–º–µ—Ä–∞ Protobuf —Å–æ–æ–±—â–µ–Ω–∏–π

### –ö–æ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

- **handler.go**: `services/realtime-gateway-go/server/handler.go` - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π deadline
- **websocket_server.go**: `services/realtime-gateway-go/server/websocket_server.go` - –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä—ã
- **delta_compression.go**: `services/realtime-gateway-go/server/delta_compression.go` - –î–µ–ª—å—Ç–∞-–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –∏ Object
  Pooling

