# In-Memory Data Calculations для AAA MMO RPG FPS

## Issue: #142109960

**Цель:** Детальные технические расчеты для in-memory хранения данных игрового состояния с учетом требований к производительности AAA игры.

**Последнее обновление:** 2025-11-30

**WARNING ВАЖНО:** Это **MMO FPS RPG** игра - в первую очередь это **ШУТЕР** в онлайн мире! Все расчеты ориентированы на стрельбу как основной геймплей.

---

## 1. Размеры структур данных в памяти

### 1.1 Базовый Player State (Movement + Position)

**Структура данных (Go):**
```go
type PlayerState struct {
    ID         string     // UUID: 36 байт
    X          float32    // 4 байта
    Y          float32    // 4 байта
    Z          float32    // 4 байта
    VX         float32    // 4 байта
    VY         float32    // 4 байта
    VZ         float32    // 4 байта
    Yaw        float32    // 4 байта
    LastUpdate time.Time  // 24 байта (time.Time структура)
}
```

**Расчет размера:**
- String (ID): 36 байт (UUID) + 8 байт (header Go string) = **44 байта**
- 7x float32: 7 × 4 = **28 байт**
- time.Time: **24 байта**
- Overhead Go struct: **16 байт** (выравнивание)
- **Итого: ~112 байт на игрока**

### 1.2 Shooting State (Состояние стрельбы) - КРИТИЧНО для FPS!

**Структура данных (MMOFPS - стрельба приоритет №1):**
```go
type ShootingState struct {
    PlayerID          string      // 44 байта
    ActiveWeaponID    string      // 44 байта
    IsAiming          bool        // 1 байт
    AimX              float32     // 4 байта (направление прицеливания)
    AimY              float32     // 4 байта
    AimZ              float32     // 4 байта
    RecoilX           float32     // 4 байта (текущая отдача)
    RecoilY           float32     // 4 байта
    RecoilPattern     []float32   // 24 байта (slice) + данные
    CurrentSpread     float32     // 4 байта (текущий разброс)
    FireRate          float32     // 4 байта (скорострельность)
    LastShotTime      time.Time   // 24 байта
    ReloadProgress    float32     // 4 байта (0-1)
    IsReloading       bool        // 1 байт
    MagazineAmmo      int32       // 4 байта
    ReserveAmmo       int32       // 4 байта
    WeaponStats       WeaponStats // Структура с характеристиками
}
```

**Расчет размера:**
- Базовые поля: 44 + 44 + 1 + 9×4 + 2×1 + 24 + 4 = **145 байт**
- RecoilPattern (10 последних значений): 10 × 4 = **40 байт**
- WeaponStats структура: ~64 байта (урон, дальность, точность)
- Overhead: **16 байт**
- **Итого: ~265 байт**

### 1.3 Shot History (История выстрелов для античита)

**Структура данных (FPS требует валидацию выстрелов):**
```go
type ShotHistory struct {
    PlayerID          string      // 44 байта
    Shots             []Shot      // 24 байта (slice header) + данные
    MaxHistorySize    int         // 8 байт
}

type Shot struct {
    ShotID            string      // 44 байта (UUID)
    Tick              int64       // 8 байт
    WeaponID          string      // 44 байта
    OriginX           float32     // 4 байта
    OriginY           float32     // 4 байта
    OriginZ           float32     // 4 байта
    DirectionX        float32     // 4 байта
    DirectionY        float32     // 4 байта
    DirectionZ        float32     // 4 байта
    HitTargetID       string      // 44 байта (nullable)
    HitBodyPart       string      // 20 байт (enum string)
    Damage            int32       // 4 байта
    ServerValidated   bool        // 1 байт
    Timestamp         time.Time   // 24 байта
}
```

**Расчет размера:**
- Базовые поля: 44 + 24 + 8 = **76 байт**
- Shot структура: 44 + 8 + 44 + 6×4 + 44 + 20 + 4 + 1 + 24 = **221 байт**
- **История последних 64 выстрелов** (стандарт для античита): 64 × 221 = **14,144 байта**
- **Итого: ~14.2 KB на игрока**

### 1.4 Weapon State (Состояние оружия)

**Структура данных:**
```go
type WeaponState struct {
    WeaponID          string      // 44 байта
    WeaponType        string      // 20 байт
    CurrentAmmo       int32       // 4 байта
    ReserveAmmo       int32       // 4 байта
    FireMode          string      // 20 байт (single/burst/auto)
    RecoilMultiplier  float32     // 4 байта
    SpreadMultiplier  float32     // 4 байта
    ReloadTime        float32     // 4 байта
    LastShotTick      int64       // 8 байт
    BarrelHeat        float32     // 4 байта (для некоторых типов оружия)
    Attachments       []string    // 24 байта (slice) + данные
}
```

**Расчет размера:**
- Базовые поля: 44 + 20 + 4×4 + 20 + 2×4 + 4 + 8 + 4 = **132 байта**
- Attachments (5 модов среднее): 5 × (8 + 20) = **140 байт**
- Overhead: **16 байт**
- **Итого: ~288 байт**

### 1.5 Combat State (Боевое состояние)

**Структура данных:**
```go
type CombatState struct {
    PlayerID          string      // 44 байта
    Health            int32       // 4 байта
    MaxHealth         int32       // 4 байта
    Shield            int32       // 4 байта
    MaxShield         int32       // 4 байта
    StatusEffects     []StatusEffect // 24 байта (slice header) + данные
    ActiveAbilities   []Ability   // 24 байта (slice header) + данные
    ActiveImplants    []Implant   // 24 байта (slice header) + данные
    LoadoutID         string      // 44 байта
    Ammo              map[string]int32 // 8 байт (map header) + данные
}
```

**Расчет размера:**
- Базовые поля: 44 + 4×4 = **60 байт**
- Slice headers (3 шт): 3 × 24 = **72 байта**
- Map header: **8 байт**
- Overhead: **16 байт**
- **Базовый размер: ~156 байт**

**Динамические данные (средние значения):**
- StatusEffects: 5 эффектов × 32 байта = **160 байт**
- ActiveAbilities: 3 способности × 48 байт = **144 байта**
- ActiveImplants: 3 импланта × 64 байта = **192 байта**
- Ammo (5 типов): 5 × (8 + 8 + 4) = **100 байт**

**Итого Combat State: ~752 байта на игрока**

### 1.6 Hit Detection Buffer (Буфер попаданий для realtime FPS)

**Структура данных (для валидации попаданий в реальном времени):**
```go
type HitDetectionBuffer struct {
    PlayerID          string      // 44 байта
    PendingHits       []Hit       // 24 байта (slice) + данные
    ValidatedHits     []Hit       // 24 байта (slice) + данные
}

type Hit struct {
    HitID             string      // 44 байта
    ShotID            string      // 44 байта
    TargetID          string      // 44 байта
    BodyPart          string      // 20 байт
    HitPositionX      float32     // 4 байта
    HitPositionY      float32     // 4 байта
    HitPositionZ      float32     // 4 байта
    Damage            int32       // 4 байта
    DamageType        string      // 20 байт
    Timestamp         time.Time   // 24 байта
}
```

**Расчет размера:**
- Базовые поля: 44 + 24 + 24 = **92 байта**
- Hit структура: 44 + 44 + 44 + 20 + 3×4 + 4 + 20 + 24 = **212 байт**
- **PendingHits (до 10 попаданий в очереди):** 10 × 212 = **2,120 байт**
- **ValidatedHits (последние 20 попаданий):** 20 × 212 = **4,240 байт**
- **Итого: ~6.5 KB на игрока**

### 1.7 Inventory State (Состояние инвентаря)

**Структура данных:**
```go
type InventoryState struct {
    PlayerID      string           // 44 байта
    Items         []InventoryItem  // 24 байта (slice) + данные
    EquippedItems map[string]UUID  // 8 байт (map) + данные
    QuickSlots    [8]UUID          // 8 × 36 = 288 байт
}
```

**Расчет размера:**
- Базовые поля: **76 байт**
- Items (100 предметов среднее): 100 × 48 байт = **4,800 байт**
- EquippedItems (10 слотов): 10 × (8 + 36) = **440 байт**
- QuickSlots: **288 байт**
- Overhead: **32 байта**

**Итого Inventory State: ~5,636 байт (~5.5 KB) на игрока**

### 1.8 Active Combat Zone State (Состояние активной боевой зоны - FPS!)

**Структура данных (real-time боевая зона, не turn-based!):**
```go
type ActiveCombatZoneState struct {
    ZoneID            string      // 44 байта
    ZoneType          string      // 20 байт (pve/pvp/gvg/massive)
    ActivePlayers     map[string]*PlayerCombatState // 8 байт (map) + данные
    ActiveProjectiles []Projectile // 24 байта (slice) + данные
    ZoneBounds        BoundingBox // ~48 байт
    TickRate          int32       // 4 байта (20-128 Hz)
    CurrentTick       int64       // 8 байт
    LastTickTime      time.Time   // 24 байта
}

type PlayerCombatState struct {
    PlayerID          string      // 44 байта
    Position          Vector3     // 12 байт
    Health            int32       // 4 байта
    Shield            int32       // 4 байта
    ActiveWeaponID    string      // 44 байта
    IsAlive           bool        // 1 байт
    TeamID            int32       // 4 байта
    LastUpdateTick    int64       // 8 байт
}
```

**Расчет размера (базовый):**
- Базовые поля: 44 + 20 + 8 + 24 + 48 + 4 + 8 + 24 = **180 байт**
- PlayerCombatState: 44 + 12 + 4 + 4 + 44 + 1 + 4 + 8 = **121 байт**
- ActivePlayers (20 игроков в зоне): 20 × (8 + 121) = **2,580 байт**
- ActiveProjectiles (до 50 снарядов): 50 × 64 байт = **3,200 байт**
- Overhead: **32 байта**
- **Итого: ~6 KB на зону**

**Примечание:** Это НЕ turn-based система! Все происходит в реальном времени с тикрейтом 20-128 Hz.

### 1.9 Session State (Боевая сессия - устаревшее, для справки)

**Структура данных:**
```go
type CombatSessionState struct {
    SessionID     string          // 44 байта
    SessionType   string          // 20 байт (enum string)
    Status        string          // 20 байт
    CreatedAt     time.Time       // 24 байта
    StartedAt     *time.Time      // 8 байт (pointer) + 24 байта
    Participants  []Participant   // 24 байта (slice) + данные
    TurnOrder     []UUID          // 24 байта (slice) + данные
    CurrentTurn   int32           // 4 байта
    Settings      map[string]interface{} // 8 байт + данные
}
```

**Расчет размера:**
- Базовые поля: **144 байта**
- Participants (20 участников): 20 × 120 байт = **2,400 байт**
- TurnOrder: 20 × 36 = **720 байт**
- Settings (JSON): **256 байт**
- Overhead: **32 байта**

**Итого Session State: ~3,552 байта (~3.5 KB) на сессию**

**WARNING ВАЖНО:** Для FPS игры используется **ActiveCombatZoneState**, а не turn-based сессии!

### 1.10 Полный In-Memory State на игрока (FPS приоритет!)

**Суммарный расчет для активного игрока в FPS боевой зоне:**

| Компонент | Размер | Описание |
|-----------|--------|----------|
| PlayerState (Movement) | 112 байт | Базовая позиция и движение |
| **ShootingState** | **265 байт** | **Состояние стрельбы (FPS приоритет!)** |
| **ShotHistory (64 выстрела)** | **14.2 KB** | **История для античита** |
| **WeaponState** | **288 байт** | **Состояние активного оружия** |
| **HitDetectionBuffer** | **6.5 KB** | **Буфер попаданий для валидации** |
| CombatState | 752 байта | Боевое состояние (здоровье, эффекты) |
| InventoryState (активное) | 500 байт | Только активные предметы |
| ConnectionState | 128 байт | WebSocket/UDP соединение |
| Overhead (Go runtime) | 512 байт | GC, метаданные (увеличено для FPS) |

**Итого на игрока: ~23.2 KB**

**Оптимизация для PvP (128 Hz - критично!):**
- ShotHistory можно уменьшить до 32 выстрелов: **7.1 KB** (экономия 7.1 KB)
- HitDetectionBuffer можно уменьшить: **3.2 KB** (экономия 3.3 KB)
- **Итого оптимизированный: ~12.8 KB на игрока**

---

## 2. Расчет объемов памяти по сценариям

### 2.1 PvE Зона (500 игроков, 30 Hz)

**Данные:**
- Игроков: 500
- Тикрейт: 30 Hz (PvE не требует такой высокой частоты)
- Протокол: WebSocket (TCP)
- **FPS в PvE режиме (меньше стрельбы, больше исследования)**

**Расчет памяти:**

| Компонент | Размер на игрока | Всего |
|-----------|------------------|-------|
| PlayerState | 112 байт | 500 × 112 = 56 KB |
| **ShootingState (упрощенный)** | **150 байт** | **500 × 150 = 75 KB** |
| **ShotHistory (8 выстрелов)** | **1.8 KB** | **500 × 1.8 = 900 KB** |
| **WeaponState** | **288 байт** | **500 × 288 = 144 KB** |
| CombatState (частичный) | 400 байт | 500 × 400 = 200 KB |
| InventoryState (кэш активного) | 500 байт | 500 × 500 = 250 KB |
| ConnectionState | 128 байт | 500 × 128 = 64 KB |
| GameState Snapshot | - | ~150 KB (с базовой стрельбой) |
| Overhead | - | ~60 KB |

**Итого: ~1.74 MB (~1.7 MB) для 500 игроков**

**С учетом буферов и резерва (×1.3): ~2.3 MB**

### 2.2 PvP Small (20 игроков, 128 Hz) - FPS КРИТИЧНО!

**Данные:**
- Игроков: 20
- Тикрейт: **128 Hz** (стрельба и движение!)
- Протокол: UDP
- **Это FPS - стрельба приоритет №1!**

**Расчет памяти:**

| Компонент | Размер на игрока | Всего |
|-----------|------------------|-------|
| PlayerState | 112 байт | 20 × 112 = 2.2 KB |
| **ShootingState** | **265 байт** | **20 × 265 = 5.3 KB** |
| **ShotHistory (32 выстрела)** | **7.1 KB** | **20 × 7.1 = 142 KB** |
| **WeaponState** | **288 байт** | **20 × 288 = 5.8 KB** |
| **HitDetectionBuffer** | **3.2 KB** | **20 × 3.2 = 64 KB** |
| CombatState (полный) | 752 байта | 20 × 752 = 15 KB |
| InventoryState (активные) | 500 байт | 20 × 500 = 10 KB |
| ConnectionState | 128 байт | 20 × 128 = 2.6 KB |
| ActiveCombatZoneState | - | ~6 KB (зона) |
| ActiveProjectiles (50 снарядов) | - | ~3.2 KB |
| GameState Snapshot | - | ~8 KB (включая стрельбу) |
| History Buffer (64 ticks для античита) | - | 64 × 8 KB = 512 KB |
| Overhead | - | ~15 KB |

**Итого: ~791 KB (~0.79 MB) для 20 игроков**

**С учетом буферов и резерва (×1.3): ~1.03 MB**

**Важно:** История выстрелов (ShotHistory) критична для античита и валидации попаданий!

### 2.3 GvG 200 (200 игроков, 60-80 Hz) - FPS боевая система!

**Данные:**
- Игроков: 200
- Тикрейт: **60-80 Hz** (стрельба!)
- Протокол: UDP с spatial partitioning
- **FPS с большим количеством игроков**

**Расчет памяти:**

| Компонент | Размер на игрока | Всего |
|-----------|------------------|-------|
| PlayerState | 112 байт | 200 × 112 = 22.4 KB |
| **ShootingState** | **265 байт** | **200 × 265 = 53 KB** |
| **ShotHistory (16 выстрелов)** | **3.6 KB** | **200 × 3.6 = 720 KB** |
| **WeaponState** | **288 байт** | **200 × 288 = 57.6 KB** |
| **HitDetectionBuffer** | **2 KB** | **200 × 2 = 400 KB** |
| CombatState (полный) | 752 байта | 200 × 752 = 150 KB |
| InventoryState (активные) | 500 байт | 200 × 500 = 100 KB |
| ConnectionState | 128 байт | 200 × 128 = 25.6 KB |
| Spatial Partition Grid | - | ~50 KB (100×100м сетка) |
| ActiveProjectiles (100 снарядов) | - | ~6.4 KB |
| GameState Snapshot | - | ~80 KB (с стрельбой) |
| History Buffer (32 ticks) | - | 32 × 80 KB = 2.56 MB |
| Overhead | - | ~40 KB |

**Итого: ~4.7 MB для 200 игроков**

**С учетом буферов и резерва (×1.3): ~6.1 MB**

### 2.4 GvG 400 (400 игроков, 40-60 Hz) - FPS массовые битвы!

**Данные:**
- Игроков: 400
- Тикрейт: **40-60 Hz** (стрельба с оптимизацией!)
- Протокол: UDP с spatial sharding (4 shards)
- **FPS с spatial optimization**

**Расчет памяти (на shard, ~100 игроков):**

| Компонент | Размер на игрока | Всего на shard |
|-----------|------------------|----------------|
| PlayerState | 112 байт | 100 × 112 = 11.2 KB |
| **ShootingState** | **265 байт** | **100 × 265 = 26.5 KB** |
| **ShotHistory (8 выстрелов)** | **1.8 KB** | **100 × 1.8 = 180 KB** |
| **WeaponState** | **288 байт** | **100 × 288 = 28.8 KB** |
| **HitDetectionBuffer** | **1.5 KB** | **100 × 1.5 = 150 KB** |
| CombatState | 752 байта | 100 × 752 = 75.2 KB |
| InventoryState | 500 байт | 100 × 500 = 50 KB |
| ConnectionState | 128 байт | 100 × 128 = 12.8 KB |
| Spatial Shard Grid | - | ~25 KB |
| ActiveProjectiles (50 снарядов) | - | ~3.2 KB |
| GameState Snapshot | - | ~60 KB (с стрельбой) |
| History Buffer (16 ticks) | - | 16 × 60 KB = 960 KB |
| Overhead | - | ~25 KB |

**Итого на shard: ~1.55 MB**

**На все 4 shards: 4 × 1.55 MB = ~6.2 MB**

**Координация между shards: ~300 KB**

**Итого: ~6.5 MB для 400 игроков**

**С учетом буферов (×1.2): ~7.8 MB**

### 2.5 Massive War (2000 игроков, 20-40 Hz) - FPS масштабные войны!

**Данные:**
- Игроков: 2000
- Тикрейт: **20-40 Hz** (стрельба с LOD оптимизацией!)
- Протокол: UDP с кластером (8 серверов)
- Spatial sharding: 10 shards
- **FPS с максимальной оптимизацией**

**Расчет памяти (на сервер, ~250 игроков, ~125 на shard):**

| Компонент | Размер на игрока | Всего на shard |
|-----------|------------------|----------------|
| PlayerState (LOD) | 80 байт | 125 × 80 = 10 KB |
| **ShootingState (LOD)** | **120 байт** | **125 × 120 = 15 KB** |
| **ShotHistory (4 выстрела)** | **0.9 KB** | **125 × 0.9 = 112.5 KB** |
| **WeaponState (минимальный)** | **150 байт** | **125 × 150 = 18.75 KB** |
| **HitDetectionBuffer (упрощенный)** | **0.8 KB** | **125 × 0.8 = 100 KB** |
| CombatState (упрощенный) | 400 байт | 125 × 400 = 50 KB |
| InventoryState (минимальный) | 200 байт | 125 × 200 = 25 KB |
| ConnectionState | 128 байт | 125 × 128 = 16 KB |
| Spatial Shard Grid | - | ~30 KB |
| ActiveProjectiles (25 снарядов) | - | ~1.6 KB |
| GameState Snapshot (LOD) | - | ~35 KB (с минимальной стрельбой) |
| History Buffer (8 ticks) | - | 8 × 35 KB = 280 KB |
| LOD System Data | - | ~50 KB |
| Overhead | - | ~35 KB |

**Итого на shard: ~739 KB**

**На 10 shards: 10 × 739 KB = ~7.4 MB**

**Координация между серверами: ~800 KB**

**Итого на сервер: ~8.2 MB для 250 игроков**

**На все 8 серверов: 8 × 8.2 MB = ~65.6 MB**

**Центральный координатор: ~3 MB**

**Итого: ~68.6 MB для 2000 игроков**

**С учетом буферов (×1.2): ~82 MB**

---

## 3. Capacity Planning

### 3.1 Максимальное количество игроков на сервер инстанс

**Расчет на основе доступной памяти:**

**Предположения:**
- Сервер: 32 GB RAM
- Использование памяти: 60% для игровых данных (безопасный порог)
- Доступная память: 32 GB × 0.6 = **19.2 GB**

#### PvE Зона (30 Hz) - FPS в PvE режиме
- Память на игрока: **~4.6 KB** (с буферами и базовой стрельбой)
- Максимум игроков: 19.2 GB / 4.6 KB = **~4.2 миллиона игроков** (теоретически)
- **Реальные лимиты (CPU/Network): 500-1000 игроков на инстанс**
- **Примечание:** В PvE меньше стрельбы, можно уменьшить ShotHistory!

#### PvP Small (128 Hz) - FPS КРИТИЧНО!
- Память на игрока: **~51.5 KB** (с буферами и историей выстрелов)
- Максимум игроков: 19.2 GB / 51.5 KB = **~372,000 игроков** (теоретически)
- **Реальные лимиты (CPU/Network): 20-50 игроков на инстанс**
- **Примечание:** История выстрелов критична для FPS античита!

#### GvG 200 (60-80 Hz) - FPS боевая система!
- Память на игрока: **~30.5 KB** (с буферами и стрельбой)
- Максимум игроков: 19.2 GB / 30.5 KB = **~630,000 игроков** (теоретически)
- **Реальные лимиты (CPU/Network): 150-250 игроков на инстанс**
- **Примечание:** Стрельба требует дополнительной памяти для валидации!

#### GvG 400 (40-60 Hz) - FPS с оптимизацией!
- Память на игрока: **~19.5 KB** (с буферами и оптимизированной стрельбой)
- Максимум игроков: 19.2 GB / 19.5 KB = **~985,000 игроков** (теоретически)
- **Реальные лимиты (CPU/Network): 300-500 игроков на инстанс**
- **Примечание:** Spatial sharding позволяет уменьшить ShotHistory!

#### Massive War (20-40 Hz) - FPS с LOD оптимизацией!
- Память на игрока: **~41 KB** (с кластером и минимальной стрельбой)
- Максимум игроков: 19.2 GB / 41 KB = **~468,000 игроков** (теоретически)
- **Реальные лимиты (CPU/Network): 200-300 игроков на сервер, 2000+ с кластером**
- **Примечание:** LOD система уменьшает ShotHistory до минимума (4 выстрела)!

### 3.2 Рекомендации по ресурсам серверов

#### PvE Зона Server
- **CPU:** 8-16 cores (Intel Xeon или AMD EPYC)
- **RAM:** 32 GB (достаточно для 1000 игроков)
- **Network:** 10 Gbps (для 500 игроков × 20 KB/s = 10 MB/s)
- **Рекомендуемый лимит:** 500-1000 игроков на инстанс

#### PvP Small Server
- **CPU:** 16-32 cores (высокая частота, для 128 Hz)
- **RAM:** 16 GB (достаточно для 50 игроков)
- **Network:** 1 Gbps (для 20 игроков × 25 KB/s = 500 KB/s)
- **Рекомендуемый лимит:** 20-50 игроков на инстанс

#### GvG Server
- **CPU:** 16-32 cores
- **RAM:** 64 GB (для 400 игроков)
- **Network:** 10 Gbps (для 400 игроков × 15 KB/s = 6 MB/s)
- **Рекомендуемый лимит:** 300-500 игроков на инстанс

#### Massive War Cluster Server
- **CPU:** 32-64 cores
- **RAM:** 128 GB (для координации)
- **Network:** 25 Gbps (для высокого трафика между серверами)
- **Рекомендуемый лимит:** 200-300 игроков на сервер

### 3.3 Масштабирование через горизонтальное развертывание

**Стратегия масштабирования:**

1. **PvE Зоны:** Легко масштабируются, каждая зона на отдельном инстансе
2. **PvP Matches:** Один матч на инстанс (стандарт индустрии)
3. **GvG:** Spatial sharding для распределения нагрузки
4. **Massive War:** Cluster из 8-10 серверов с центральным координатором

**Горизонтальное масштабирование:**
- Автоматическое создание новых инстансов при достижении лимитов
- Load balancing через API Gateway
- Динамическое распределение игроков по инстансам

---

## 4. Стратегия хранения данных

### 4.1 In-Memory (Активные данные)

**Что хранить в памяти:**
- OK **Активные боевые зоны (FPS real-time!)** - НЕ turn-based сессии!
- OK **Состояние стрельбы (ShootingState)** - прицеливание, отдача, оружие
- OK **История выстрелов (ShotHistory)** - последние 4-64 выстрела для античита
- OK **Буфер попаданий (HitDetectionBuffer)** - валидация попаданий в реальном времени
- OK Позиции игроков в активных зонах
- OK Текущее состояние здоровья, способностей
- OK WebSocket/UDP соединения
- OK История последних N тиков (для delta compression)
- OK **Активные снаряды (Projectiles)** - для трассировки и валидации

**Время жизни:** До завершения сессии/зоны

**Требования:**
- Низкая задержка (<50ms для PvP, <100ms для PvE)
- Высокая частота обновлений (20-128 Hz)
- Быстрый доступ (O(1) для поиска по ID)

### 4.2 Redis (Кэш и сессии)

**Что хранить в Redis:**
- OK Кэш данных персонажей (характеристики, статы)
- OK Активные сессии (TTL: 30 минут)
- OK Лоадауты игроков
- OK Кэш инвентаря (активные предметы)
- OK Leaderboards (real-time)
- OK Игровые события (для Event Bus)

**Время жизни:**
- Персонажи: TTL 1 час
- Сессии: TTL 30 минут
- Leaderboards: постоянное хранение

**Размер данных:**
- Персонаж (кэш): ~2 KB
- Сессия: ~500 байт
- Лоадаут: ~1 KB

**Расчет для 10,000 активных игроков:**
- Персонажи: 10,000 × 2 KB = 20 MB
- Сессии: 10,000 × 500 байт = 5 MB
- Лоадауты: 10,000 × 1 KB = 10 MB
- Leaderboards: ~10 MB
- **Итого: ~45 MB в Redis**

### 4.3 PostgreSQL (Персистентность)

**Что хранить в PostgreSQL:**
- OK Персонажи (полные данные)
- OK Инвентарь (все предметы)
- OK История боевых сессий
- OK Прогресс квестов
- OK Экономика (транзакции, рынок)
- OK Социальные данные (друзья, гильдии)

**Время жизни:** Постоянное хранение

**Синхронизация:**
- Из In-Memory → PostgreSQL: Асинхронно (после завершения сессии)
- Из Redis → PostgreSQL: Периодически (каждые 5 минут)
- Критичные операции: Синхронно (деньги, инвентарь)

### 4.4 Поток данных

```
[Client] 
    ↓
[Realtime Gateway] ← In-Memory (активное состояние)
    ↓
[Gameplay Service] ← In-Memory (боевая логика)
    ↓
[Redis] ← Кэш персонажей, сессий
    ↓
[PostgreSQL] ← Персистентность
```

**Оптимизации:**
1. Batch writes в PostgreSQL (каждые 5-10 секунд)
2. Event Bus (Kafka) для асинхронной синхронизации
3. Transactional Outbox для гарантированной доставки
4. Read replicas PostgreSQL для масштабирования чтения

---

## 5. Тикрейты для AAA игры

### 5.1 Сравнение с индустрией

| Игра | Тип | Игроков | Tick Rate | Latency |
|------|-----|---------|-----------|---------|
| **VALORANT** | Tactical FPS | 10 (5v5) | 128 Hz | <30ms |
| **CS:GO / CS2** | Tactical FPS | 10 (5v5) | 64-128 Hz | <30ms |
| **Overwatch** | Hero Shooter | 12 (6v6) | 60-128 Hz | <30ms |
| **Battlefield 2042** | Large-scale FPS | 128 | 60 Hz | <50ms |
| **PlanetSide 2** | MMOFPS | 450 | 20-30 Hz | <100ms |
| **Guild Wars 2 WvW** | MMORPG PvP | 100-200 | ~30 Hz | <100ms |

### 5.2 Наши требования (AAA уровень)

#### PvP Small (Competitive)
- **Тикрейт:** 128 Hz OK (как VALORANT)
- **Latency:** <30ms OK
- **Игроков:** 20 OK
- **Протокол:** UDP OK

#### GvG (Large-scale PvP)
- **Тикрейт:** 60-80 Hz OK (как Battlefield 2042)
- **Latency:** <50ms OK
- **Игроков:** 200-400 OK
- **Протокол:** UDP с spatial partitioning OK

#### Massive War (MMO-scale)
- **Тикрейт:** 20-40 Hz OK (как PlanetSide 2)
- **Latency:** <100ms OK
- **Игроков:** 2000+ OK
- **Протокол:** UDP с кластером OK

### 5.3 Рекомендации по тикрейтам для каждой механики

#### Combat / Shooting (Боевая система / Стрельба - FPS ПРИОРИТЕТ!)
| Сценарий | Тикрейт | Приоритет | Описание |
|----------|---------|-----------|----------|
| **PvP Small** | **128 Hz** | **Highest** | **Стрельба и движение на 128 Hz!** |
| **GvG 200** | **80 Hz** | **High** | **Стрельба на 80 Hz с spatial partitioning** |
| **GvG 400** | **60 Hz** | **High** | **Стрельба на 60 Hz с sharding** |
| **Massive War** | **40 Hz** | **High** | **Стрельба на 40 Hz с LOD** |
| **PvE** | **30 Hz** | **Medium** | **Базовая стрельба в PvE** |

**Важно:** Стрельба - это основной геймплей FPS! Все тикрейты ориентированы на стрельбу.

#### Movement (Движение)
| Сценарий | Тикрейт | Приоритет | Описание |
|----------|---------|-----------|----------|
| PvP Small | 128 Hz | Highest | Синхронизация с стрельбой |
| GvG 200 | 80 Hz | High | Синхронизация с стрельбой |
| GvG 400 | 60 Hz | High | Синхронизация с стрельбой |
| Massive War | 30 Hz | Medium | LOD оптимизация |
| PvE | 30 Hz | Medium | Базовая синхронизация |

**Примечание:** Движение синхронизируется с частотой стрельбы для точности FPS!

#### Shooting Mechanics (Механики стрельбы - FPS КРИТИЧНО!)
| Механика | Тикрейт | Приоритет | Описание |
|----------|---------|-----------|----------|
| **Прицеливание (Aim)** | **60-128 Hz** | **Highest** | Синхронизация направления взгляда |
| **Отдача (Recoil)** | **60-128 Hz** | **Highest** | Синхронизация отдачи оружия |
| **Выстрелы (Shots)** | **Event-based** | **Highest** | Обработка каждого выстрела (<16ms) |
| **Попадания (Hits)** | **Event-based** | **Highest** | Валидация попаданий (<10ms) |
| **Снаряды (Projectiles)** | **60-128 Hz** | **High** | Трассировка пуль/снарядов |

**Важно для FPS:**
- Задержка выстрела: **<16 мс** (как VALORANT/CS:GO)
- Валидация попаданий: **<10 мс** (server-side validation)
- Синхронизация прицеливания: **60-128 Hz** (для точности)

#### Abilities (Способности)
- **Event-based** с частотой синхронизации:
  - PvP Small: 128 Hz (синхронизация с стрельбой)
  - GvG: 60-80 Hz (синхронизация с стрельбой)
  - Massive War: 20-40 Hz
  - PvE: Event-based (on-demand)

#### Inventory (Инвентарь)
- **Event-based** (on-demand)
- **Синхронизация:** При изменениях (Strong Consistency)
- **Тикрейт:** N/A (не требует периодических обновлений)

#### Trading (Торговля)
- **Event-based** (on-demand)
- **Синхронизация:** При транзакциях (ACID)
- **Тикрейт:** N/A

### 5.4 Адаптивный тикрейт

**Факторы снижения тикрейта:**

1. **Количество игроков** (вес: 0.6)
   - 0-50 игроков: 100% тикрейт
   - 100 игроков: 80% тикрейт
   - 200 игроков: 60% тикрейт
   - 400 игроков: 50% тикрейт
   - 1000+ игроков: 40% тикрейт

2. **Network Latency** (вес: 0.3)
   - 0-50ms: 100% тикрейт
   - 50-100ms: 90% тикрейт
   - 100-200ms: 70% тикрейт
   - 200+ms: 50% тикрейт

3. **CPU Usage** (вес: 0.1)
   - 0-50%: 100% тикрейт
   - 50-70%: 95% тикрейт
   - 70-90%: 80% тикрейт
   - 90%+: 60% тикрейт

**Минимальный тикрейт:** 20 Hz (ниже недопустимо для игры)

**Максимальный тикрейт:** 128 Hz (для PvP)

---

## 6. Итоговые рекомендации

### 6.1 Размеры данных (FPS приоритет!)

| Структура | Размер | Оптимизация | FPS Критичность |
|-----------|--------|-------------|-----------------|
| PlayerState (базовый) | 112 байт | OK Оптимально | ⭐⭐⭐ Высокая |
| **ShootingState** | **265 байт** | OK Оптимально | ⭐⭐⭐ **КРИТИЧНО!** |
| **ShotHistory (32 выстрела)** | **7.1 KB** | Можно 16 для экономии | ⭐⭐⭐ **КРИТИЧНО!** |
| **WeaponState** | **288 байт** | OK Оптимально | ⭐⭐⭐ **КРИТИЧНО!** |
| **HitDetectionBuffer** | **3.2 KB** | Можно 1.5 KB | ⭐⭐⭐ **КРИТИЧНО!** |
| CombatState (полный) | 752 байта | Можно уменьшить до 400 байт (LOD) | ⭐⭐ Средняя |
| InventoryState (полный) | 5.6 KB | Кэшировать только активные (~500 байт) | ⭐ Низкая |
| **Итого (FPS оптимизированный)** | **~12.8 KB** | OK Рекомендуется | **FPS приоритет!** |

**Важно:** Для FPS игры стрельба - приоритет №1! Нельзя уменьшать ShotHistory ниже 8 выстрелов (античит).

### 6.2 Объем памяти по сценариям (FPS приоритет!)

| Сценарий | Игроков | Память | Рекомендация | FPS Особенности |
|----------|---------|--------|--------------|-----------------|
| PvE Зона | 500 | 2.3 MB | OK Достаточно 32 GB сервер | Базовая стрельба |
| **PvP Small** | **20** | **1.03 MB** | OK Достаточно 16 GB сервер | **128 Hz стрельба!** |
| **GvG 200** | **200** | **6.1 MB** | OK Достаточно 64 GB сервер | **80 Hz стрельба!** |
| **GvG 400** | **400** | **7.8 MB** | OK Достаточно 64 GB сервер | **60 Hz стрельба!** |
| **Massive War** | **2000** | **82 MB** | OK Достаточно 128 GB кластер | **40 Hz стрельба с LOD!** |

**Увеличение памяти связано с:**
- OK ShotHistory (история выстрелов для античита)
- OK HitDetectionBuffer (валидация попаданий)
- OK ShootingState (состояние стрельбы)
- OK ActiveProjectiles (активные снаряды)

**Это критично для FPS игры!**

### 6.3 Capacity Planning

| Сценарий | Реальный лимит | Обоснование |
|----------|----------------|-------------|
| PvE Зона | 500-1000 игроков | CPU/Network ограничения |
| PvP Small | 20-50 игроков | CPU (128 Hz) ограничения |
| GvG 200 | 150-250 игроков | CPU/Network ограничения |
| GvG 400 | 300-500 игроков | CPU/Network ограничения |
| Massive War | 200-300 на сервер | Кластер из 8-10 серверов |

### 6.4 Стратегия хранения

1. **In-Memory:** Только активные данные (боевые сессии, realtime состояние)
2. **Redis:** Кэш персонажей, сессий, leaderboards (TTL 1 час)
3. **PostgreSQL:** Персистентность (персонажи, инвентарь, история)

**Синхронизация:**
- In-Memory → PostgreSQL: Асинхронно (Event Bus)
- Redis → PostgreSQL: Периодически (каждые 5 минут)
- Критичные операции: Синхронно (ACID транзакции)

### 6.5 Тикрейты для AAA игры

OK **Соответствие индустрии:**
- PvP Small: 128 Hz (как VALORANT) OK
- GvG: 60-80 Hz (как Battlefield 2042) OK
- Massive War: 20-40 Hz (как PlanetSide 2) OK

OK **Адаптивный тикрейт:** Реализован для оптимизации нагрузки

---

## 7. Особенности FPS архитектуры

### 7.1 Real-Time vs Turn-Based

**WARNING КРИТИЧНО:** Это **НЕ turn-based система!** Все происходит в **реальном времени**:

- OK **Выстрелы обрабатываются event-based** с задержкой <16 мс
- OK **Состояние стрельбы синхронизируется на 60-128 Hz** (каждые 7.8-16.6 мс)
- OK **Попадания валидируются server-side** в реальном времени
- OK **Нет пошаговой системы** - все действия происходят одновременно

### 7.2 Server-Side Validation (Критично для FPS!)

**Все выстрелы валидируются на сервере:**

1. **Client Prediction:** Клиент предсказывает попадание (instant feedback)
2. **Server Validation:** Сервер проверяет траекторию и попадание (<10 мс)
3. **Reconciliation:** Клиент корректирует при расхождении
4. **Anti-Cheat:** История выстрелов хранится для анализа

**Структура данных для валидации:**
```go
type ShotValidation struct {
    ShotID            string      // 44 байта
    PlayerID          string      // 44 байта
    Origin            Vector3     // 12 байт
    Direction         Vector3     // 12 байт
    WeaponID          string      // 44 байта
    ServerTime        time.Time   // 24 байта
    ClientTime        time.Time   // 24 байта
    Validated         bool        // 1 байт
    HitTargetID       string      // 44 байта
    HitPosition       Vector3     // 12 байт
}
```

**Размер:** ~221 байт на выстрел
**История:** 32-64 выстрела = 7-14 KB на игрока

### 7.3 Hit Detection в Real-Time

**Попадания проверяются на каждом тике (60-128 Hz):**

- Raycast проверка от сервера для каждого выстрела
- Spatial partitioning для оптимизации (только видимые цели)
- Латентность проверки: <10 мс (критично для FPS!)

**Память для hit detection:**
- Active raycasts: ~50 байт каждый
- До 10 одновременных проверок = ~500 байт на игрока
- Результаты попаданий: ~212 байт каждое
- Буфер последних 20 попаданий = ~4.2 KB

### 7.4 Оптимизации для FPS

**Spatial Partitioning для стрельбы:**
- Игроки видят только цели в радиусе 100-200м
- Raycast проверяется только для видимых целей
- Экономия: 80-90% вычислений

**ShotHistory оптимизация:**
- PvP Small: 32-64 выстрела (полная история)
- GvG: 16 выстрелов (достаточно для валидации)
- Massive War: 4-8 выстрелов (минимум для античита)

**Projectile pooling:**
- Переиспользование структур для снарядов
- Экономия: ~30% памяти на активные снаряды

---

## 8. Заключение

Данные расчеты показывают, что:
1. OK **Память все еще не критична** - даже для 2000 игроков требуется ~82 MB (в 2 раза больше, но приемлемо)
2. OK **CPU и Network являются основными ограничениями** - тикрейт и пропускная способность
3. OK **Стратегия хранения оптимальна:** In-Memory для активных данных (стрельба!), Redis для кэша, PostgreSQL для персистентности
4. OK **Тикрейты соответствуют AAA FPS играм** - 128 Hz для PvP (как VALORANT), 60-80 Hz для GvG (как Battlefield 2042), 20-40 Hz для Massive War (как PlanetSide 2)

**КРИТИЧНО для FPS:**
- OK **ShootingState и ShotHistory обязательны** - без них нет валидации стрельбы
- OK **HitDetectionBuffer критичен** - server-side validation попаданий
- OK **История выстрелов для античита** - минимум 8-32 выстрела в памяти
- OK **Задержка выстрела <16 мс** - как в VALORANT/CS:GO

**Рекомендации:**
- Фокус на оптимизацию CPU и Network, а не памяти
- **ShotHistory можно оптимизировать:** 32 выстрела для PvP, 8-16 для GvG, 4 для Massive War
- Использование spatial partitioning/sharding для масштабирования
- **Адаптивный тикрейт для стрельбы:** 128 Hz для PvP, снижение для больших сражений
- Горизонтальное масштабирование через кластеры серверов
- **Server-side validation всех выстрелов** - критично для FPS!

