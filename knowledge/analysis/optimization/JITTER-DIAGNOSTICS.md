# Диагностика дёргания персонажа

## [SEARCH] Проблема

Персонаж другого игрока дёргается при движении, несмотря на исправления интерполяции и рефакторинг по SOLID.

## [SYMBOL] Выполненные исправления

### 1. Исправлена интерполяция Pitch (вскидывание оружия)
- [OK] Интерполируется только Yaw
- [OK] Pitch и Roll сохраняются из текущего состояния

### 2. Исправлен краш UObject hash table
- [OK] Предварительный сбор контроллеров
- [OK] Безопасная итерация

### 3. Рефакторинг по SOLID
- [OK] Разделение на 6 классов
- [OK] Зависимости через интерфейсы

### 4. Убрана двойная интерполяция
- [OK] Убран VInterpTo после Lerp
- [OK] Применение напрямую интерполированных значений

### 5. Отключено автономное движение
- [OK] StopMovementImmediately() перед применением позиции
- [OK] Обнуление Velocity для предотвращения конфликтов

## [SYMBOL] Возможные причины дёргания

### 1. Частота обновлений от сервера
**Проблема**: Если сервер отправляет обновления реже, чем клиент обновляет кадры, возникают скачки.

**Проверка**: 
- Как часто приходят GameState сообщения?
- Есть ли логи о получении GameState?

**Решение**: 
- Увеличить частоту отправки с сервера
- Или увеличить InterpolationDelay для большего буфера

### 2. Конфликт с CharacterMovementComponent
**Проблема**: CharacterMovementComponent может продолжать обновлять позицию на основе Velocity или физики.

**Проверка**: 
- Действительно ли StopMovementImmediately() отключает движение?
- Не обновляется ли позиция в других местах?

**Решение**: 
- Отключить Tick для CharacterMovementComponent для удалённых персонажей
- Использовать SetComponentTickEnabled(false)

### 3. Квантование координат
**Проблема**: Квантование координат (sint32 с масштабированием 0.1 см) может вызывать видимые скачки.

**Проверка**: 
- Размер скачков соответствует точности квантования?
- Можно ли увеличить точность?

**Решение**: 
- Увеличить QuantizationScale (уменьшить точность квантования)
- Или улучшить сглаживание для компенсации

### 4. Потеря пакетов
**Проблема**: При потере пакетов экстраполяция может быть недостаточной.

**Проверка**: 
- Есть ли потери пакетов в логах?
- Работает ли экстраполяция?

**Решение**: 
- Увеличить MaxExtrapolationTime
- Улучшить экстраполяцию на основе ускорения

### 5. Конфликт с анимациями
**Проблема**: Локальные анимации могут конфликтовать с сетевыми обновлениями.

**Проверка**: 
- Дёргается ли только позиция или также анимации?
- Есть ли конфликты в логах?

**Решение**: 
- Отключить локальные анимации для удалённых персонажей
- Или синхронизировать анимации через сеть

## [TRANSPORT]️ Рекомендуемые шаги диагностики

### Шаг 1: Добавить логирование
```cpp
UE_LOG(LogLyra, Log, TEXT("ApplyInterpolatedSnapshot: EntityId=%s, Alpha=%.3f, LocationDelta=%.2f"), 
    *EntityId, Alpha, LocationDistance);
```

### Шаг 2: Проверить частоту обновлений
- Логировать время получения каждого GameState
- Проверить, соответствует ли частота ожидаемой

### Шаг 3: Проверить конфликты
- Логировать все вызовы SetActorLocation
- Проверить, не вызывается ли из других мест

### Шаг 4: Профилирование
- Использовать Unreal Insights для профилирования
- Проверить, нет ли проблем с производительностью

## [NOTE] Параметры для настройки

### Текущие параметры:
- `InterpolationDelay = 0.1f` (100 мс)
- `MaxExtrapolationTime = 0.1f` (100 мс)
- `YawInterpolationSpeed = 25.0f`
- `LocationThreshold = 5.0f`

### Рекомендуемые изменения для тестирования:

1. **Увеличить InterpolationDelay до 0.15f** (150 мс)
   - Больше буфера для интерполяции
   - Меньше дёргания при потере пакетов

2. **Увеличить YawInterpolationSpeed до 40.0f**
   - Более быстрое сглаживание поворота
   - Меньше видимой задержки

3. **Уменьшить LocationThreshold до 2.0f**
   - Более чувствительное применение движения
   - Более плавное движение

4. **Увеличить MaxExtrapolationTime до 0.15f**
   - Больше времени для экстраполяции
   - Плавнее при потере пакетов

## [WARNING] Важные замечания

1. **StopMovementImmediately()** может влиять на физику (падение, гравитация)
2. **Увеличенная задержка** может увеличить видимую задержку
3. **Тестирование** нужно проводить с несколькими игроками одновременно

