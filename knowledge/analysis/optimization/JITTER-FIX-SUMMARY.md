# Итоговое исправление дёргания персонажа

## [OK] Выполненные исправления

### 1. Исправлена интерполяция Pitch (вскидывание оружия)
- [OK] Интерполируется только Yaw между снимками
- [OK] Pitch и Roll всегда сохраняются из текущего состояния персонажа
- [OK] Нет конфликтов с локальными анимациями оружия

### 2. Исправлен краш UObject hash table
- [OK] Предварительный сбор контроллеров в TMap
- [OK] Безопасная итерация без обращения к UObject во время итерации
- [OK] Проверки валидности перед обращением к UObject

### 3. Рефакторинг по SOLID
- [OK] Разделение на 6 классов с одной ответственностью
- [OK] Зависимости через интерфейсы (DIP)
- [OK] Легко расширять через интерфейсы (OCP)

### 4. Убрана двойная интерполяция
- [OK] Убран VInterpTo после Lerp в ApplyInterpolatedSnapshot
- [OK] Применение напрямую интерполированных значений
- [OK] Упрощена логика применения движения

### 5. Отключено автономное движение CharacterMovementComponent
- [OK] StopMovementImmediately() перед применением позиции
- [OK] Обнуление Velocity для предотвращения конфликтов
- [OK] Применение позиции напрямую без дополнительных интерполяций

### 6. Добавлена проверка минимального изменения
- [OK] Применение позиции только если изменение > 0.1 см
- [OK] Предотвращает микро-дёргание от квантования

### 7. Оптимизированы параметры
- [OK] InterpolationDelay = 0.1f (100 мс) - больше буфера
- [OK] YawInterpolationSpeed = 25.0f - быстрее сглаживание
- [OK] LocationThreshold = 5.0f - более чувствительное применение

## [SEARCH] Возможные причины сохраняющегося дёргания

### 1. Частота обновлений от сервера
**Симптомы**: Дёргание происходит периодически, не постоянно
**Решение**: Проверить частоту отправки GameState с сервера, возможно увеличить

### 2. Потеря пакетов
**Симптомы**: Резкие скачки при движении
**Решение**: Увеличить MaxExtrapolationTime или улучшить экстраполяцию

### 3. Квантование координат
**Симптомы**: Мелкие дёргания при каждом обновлении
**Решение**: Увеличить точность квантования (уменьшить QuantizationScale)

### 4. Конфликт с другими системами
**Симптомы**: Дёргание в определённых ситуациях (стрельба, прыжки)
**Решение**: Проверить, не обновляется ли позиция из других мест

## [TRANSPORT]️ Рекомендации для диагностики

### Добавить логирование
```cpp
UE_LOG(LogLyra, VeryVerbose, TEXT("ApplyInterpolatedSnapshot: EntityId=%s, Alpha=%.3f, LocationDelta=%.2f, TimeSinceLastUpdate=%.3f"), 
    *EntityId, Alpha, LocationDistance, TimeSinceLastUpdate);
```

### Проверить частоту обновлений
- Логировать время получения каждого GameState
- Проверить интервал между обновлениями

### Профилирование
- Использовать Unreal Insights
- Проверить производительность TickComponent

## [SYMBOL] Текущие параметры

```cpp
InterpolationDelay = 0.1f;           // 100 мс задержка
MaxExtrapolationTime = 0.1f;        // 100 мс экстраполяция
YawInterpolationSpeed = 25.0f;      // Скорость интерполяции Yaw
LocationThreshold = 5.0f;           // Порог применения позиции
MinYawDelta = 2.0f;                 // Минимальное изменение Yaw
```

## [WARNING] Важные замечания

1. **StopMovementImmediately()** отключает автономное движение, но может влиять на физику
2. **Обнуление Velocity** предотвращает конфликты, но может влиять на анимации
3. **Увеличенная задержка** уменьшает дёргание, но увеличивает видимую задержку
4. **Проверка минимального изменения** предотвращает микро-дёргание, но может вызывать задержку при маленьких изменениях

## [TARGET] Следующие шаги

Если дёргание сохраняется:
1. Добавить детальное логирование
2. Проверить частоту обновлений от сервера
3. Профилировать производительность
4. Проверить конфликты с другими системами
5. Рассмотреть использование Network Smoothing Mode в CharacterMovementComponent

