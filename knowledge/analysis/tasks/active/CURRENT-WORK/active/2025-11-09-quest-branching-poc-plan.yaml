metadata:
  id: analysis-quest-branching-poc-plan
  title: Quest Branching Liquibase PoC
  document_type: analysis
  category: operations
  status: draft
  version: '0.2.0'
  last_updated: 2025-12-06T12:10:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: ai_manager
      contact: ai@necp.game
  tags:
    - quests
    - liquibase
    - poc
  topics:
    - data-migrations
    - quest-engine
  related_systems:
    - quest-engine
    - analytics-service
  related_documents:
    - id: quest-branching-liquibase-plan
      relation: references
  source: shared/docs/knowledge/analysis/tasks/active/CURRENT-WORK/active/2025-11-09-quest-branching-poc-plan.md
  visibility: internal
  audience:
    - brain-team
    - data-engineering
  risk_level: medium
review:
  chain:
    - role: ai_manager
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: |
    Система ветвящихся квестов требует надёжной схемы БД для поддержки сложных диалоговых деревьев, последствий выборов игроков и динамических изменений мира. 
    Текущая структура таблиц `quests` и `quest_progress` не поддерживает ветвление, множественные пути прохождения и отслеживание последствий выборов.
    Требуется подтвердить жизнеспособность полного цикла миграций через Liquibase без нарушения существующих данных и собрать отчёт по результатам.
  goal: |
    Прогнать Liquibase tag `quest-branching-v1` на изолированной базе данных, проверить корректность работы shadow-write механизмов, 
    материализованных представлений для аналитики и политик Row Level Security (RLS) для защиты данных. Зафиксировать метрики производительности 
    и времени выполнения миграций для оценки готовности к продакшену.
  essence: |
    Пошаговый план Proof of Concept для нового схемного слоя ветвящихся квестов с требованиями к среде, проверками и измерениями.
    PoC должен подтвердить, что миграции могут быть безопасно применены и откачены, а новая схема поддерживает все требования системы ветвления.
  key_points:
    - Описаны подготовка окружения (PostgreSQL 15+, Liquibase 4.17+) и сценарий запуска миграций.
    - Проверяются shadow-write механизмы для безопасной миграции данных, materialized view для аналитики популярности путей и политики RLS.
    - Фиксируются метрики времени выполнения, производительности и дальнейшие шаги по автоматизации процесса.
content:
  sections:
    - id: environment
      title: Подготовка среды
      body: |
        **Требования к БД:**
        - PostgreSQL 15+ с расширением `pgcrypto` для шифрования чувствительных данных
        - Отдельная база данных `quest_branching_poc` для изоляции тестов
        - Права superuser для создания расширений и управления схемами
        - Минимум 2GB свободного места для тестовых данных
        
        **Требования к инструментам:**
        - Liquibase 4.17+ (проверено на 4.27.0)
        - Конфигурация `liquibase.properties` с параметрами подключения
        - Вспомогательные скрипты из `scripts/poc/quest-branching/`:
          - `run_poc.ps1` - основной скрипт запуска PoC
          - `validate_results.ps1` - валидация результатов
          - `cleanup.ps1` - очистка тестовых данных
        
        **Проверка готовности:**
        - Убедиться, что PostgreSQL запущен и доступен
        - Проверить наличие расширения `pgcrypto`
        - Создать базу данных `quest_branching_poc`
        - Настроить `liquibase.properties` с корректными параметрами подключения
      mechanics_links: []
      assets: []
    - id: execution
      title: Последовательность шагов
      body: |
        **1. Подготовка:**
        - Очистка схемы от предыдущих тестов (если есть)
        - Проверка начального состояния базы данных
        - Создание резервной копии (опционально, для отката)
        
        **2. Применение миграций:**
        - Запуск `liquibase update --tag=quest-branching-v1`
        - Мониторинг выполнения каждого changeSet
        - Фиксация времени выполнения и возможных ошибок
        
        **3. Проверка shadow-write:**
        - Валидация работы триггеров синхронизации данных
        - Проверка корректности записи в shadow-таблицы
        - Тестирование механизма двойной записи без потери данных
        
        **4. Проверка материализованного представления:**
        - Валидация `quest_path_popularity` view
        - Проверка актуальности данных после обновления
        - Тестирование производительности запросов к view
        
        **5. Валидация RLS:**
        - Проверка политик Row Level Security
        - Тестирование доступа различных ролей
        - Валидация изоляции данных между игроками
        
        **6. Сценарий отката:**
        - Запуск `liquibase rollback --tag=quest-branching-v1`
        - Проверка корректности отката всех изменений
        - Валидация состояния базы после отката
        
        **7. Повторный цикл:**
        - Запуск через `run_poc.ps1` для автоматизации
        - Множественные итерации для проверки стабильности
        - Сбор метрик на каждой итерации
      mechanics_links: []
      assets: []
    - id: metrics
      title: Метрики и результаты
      body: |
        **Метрики производительности:**
        - Время выполнения `liquibase update --tag=quest-branching-v1` (целевое: <60 секунд)
        - Время выполнения `liquibase rollback --tag=quest-branching-v1` (целевое: <30 секунд)
        - Время выполнения функции `quest_branching_rollback()` для ручного отката
        - Количество обработанных changeSet и их статусы
        
        **Метрики корректности:**
        - Актуальность данных в материализованном представлении `quest_path_popularity`
        - Количество созданных флагов игрока после миграции
        - Корректность работы shadow-write триггеров
        - Валидность политик RLS и изоляция данных
        
        **Результаты отчёта 2025-11-09:**
        - OK Успешное выполнение 58 changeSet за ~55 секунд
        - OK Корректная работа всех триггеров синхронизации
        - OK Материализованное представление обновляется корректно
        - OK Политики RLS работают как ожидается
        - OK Откат миграций выполняется без ошибок
        
        **Собранные данные:**
        - Логи выполнения каждого changeSet
        - Временные метрики для каждого этапа
        - Результаты валидационных проверок
        - Список обнаруженных проблем (если есть)
      mechanics_links: []
      assets: []
    - id: follow_up
      title: Доработки и следующие шаги
      body: |
        **Автоматизация:**
        - Полная автоматизация скриптов PoC через PowerShell/Shell скрипты
        - Интеграция в CI/CD pipeline для регулярной проверки миграций
        - Автоматическая генерация отчётов с метриками
        
        **Расширение отчёта:**
        - Добавление детальных метрик производительности для каждого changeSet
        - Графики времени выполнения миграций
        - Анализ использования ресурсов (CPU, память, диск)
        - Сравнение метрик до и после миграции
        
        **Интеграция helper-функций:**
        - Создание helper-функций для упрощения rollback операций
        - Документация по использованию функций отката
        - Тестирование функций на различных сценариях
        
        **Нагрузочное тестирование:**
        - Использование k6 для нагрузочного тестирования миграций
        - Проверка производительности под нагрузкой
        - Валидация стабильности системы при параллельных миграциях
        
        **Итоговый отчёт:**
        - Подготовка итогового отчёта для readiness-трекеров
        - Документирование всех найденных проблем и их решений
        - Рекомендации по внедрению в продакшен
        - Постановка задач для следующих этапов разработки
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  github_issue: 479
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#analysis-quest-branching-poc-plan
  blockers: []
history:
  - version: '0.2.0'
    date: 2025-12-06
    author: idea-writer
    changes: Расширен план PoC с детальными описаниями шагов, метрик и следующих шагов. Добавлены детали по подготовке среды, последовательности выполнения, метрикам и автоматизации.
  - version: '0.1.0'
    date: 2025-11-11
    author: AI Manager
    changes: Конвертация плана PoC Liquibase ветвящихся квестов в формат знаний.
validation:
  checksum: ''
  schema_version: '1.0'


