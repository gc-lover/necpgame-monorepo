metadata:
  id: analysis-2025-11-09-quest-branching-validation
  title: "Проверка БД ветвления квестов"
  document_type: analysis
  category: quest-backend
  status: in-review
  version: '0.1.0'
  last_updated: 2025-11-09T12:49:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: brain_manager
      contact: brain.manager@necp.game
  tags:
    - quests
    - database
    - migration
    - caching
  topics:
    - quest-engine
    - branching
    - data-platform
  related_systems:
    - gameplay-service
    - world-service
    - analytics-service
    - cache-cluster
  related_documents: []
  source: shared/docs/knowledge/analysis/tasks/active/CURRENT-WORK/active/2025-11-09-quest-branching-validation.md
  visibility: internal
  audience:
    - concept
    - backend
    - data
  risk_level: high
review:
  chain:
    - role: brain_manager
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: "Нужно подтвердить пригодность новой схемы ветвления квестов под MMO-нагрузку."
  goal: "Зафиксировать решения по партиционированию, кэшу, миграциям, API и синхронизации мирового состояния."
  essence: "Документ описывает план перехода на новую БД ветвящихся квестов с Shadow-write, Redis кэшем и Kafka событиями."
  key_points:
    - "Партиционирование таблиц player_quest_choices, world_state_history и player_quest_consequences."
    - "Redis кластер используется для кэширования диалогов, флагов и мирового состояния."
    - "Миграция выполняется через Liquibase, shadow-write триггеры и Reprocess скрипты."
    - "Определены REST маршруты, целевые SLA и стратегия синхронизации world-state через Kafka."
content:
  sections:
    - id: storage_partitioning
      title: "Партиционирование и хранение"
      body: |
        Определены стратегии RANGE и LIST для ключевых таблиц (`player_quest_choices`, `world_state_history`,
        `player_quest_consequences`). Исторические данные архивируются в cold storage и схему `history_archive`.
      mechanics_links: []
      assets: []
    - id: caching_plan
      title: "Кэширование"
      body: |
        Redis кластер 3×3 обслуживает диалоговые деревья, активные флаги игрока и агрегированное
        мировое состояние. Используются TTL и pub/sub инвалидация, а также Streams для аналитики решений.
      mechanics_links: []
      assets: []
    - id: migration_strategy
      title: "Миграция и shadow-write"
      body: |
        Внедряется комбинированный план: Liquibase bootstrap, shadow-write триггеры, reprocess JSON
        сценариев и cut-over с materialized view `quests_legacy`. Завершение — удаление триггеров.
      mechanics_links: []
      assets: []
    - id: api_surface
      title: "API и SLA"
      body: |
        Перечислены REST конечные точки (graph, choices, flags, world-state, analytics) с целями по
        latency (<120 мс чтение, <80 мс запись) и рекомендациями по индексам и connection pooling.
      mechanics_links: []
      assets: []
    - id: world_sync
      title: "Синхронизация мирового состояния"
      body: |
        Используется event sourcing: события пишутся в `world_state_history` и Kafka `world-state-events`,
        серверы применяют изменения с задержкой до 3 секунд, конфликты решаются last-write-wins.
      mechanics_links: []
      assets: []
    - id: action_plan
      title: "План действий"
      body: |
        Liquibase миграции, генератор SQL из JSON (`tools/quest-importer`), тестовый датасет, нагрузочное
        тестирование k6 и настройка мониторинга Grafana.
      mechanics_links: []
      assets: []
    - id: risks
      title: "Риски и митигирующие меры"
      body: |
        Обработаны риски объёма данных, инвалидации кэша, ошибок shadow-write и задержек Kafka с
        fallback стратегиями и административными endpoint-ами.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references:
    - shared/docs/knowledge/analysis/tasks/active/CURRENT-WORK/active/2025-11-09-quest-engine-package.yaml
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#analysis-2025-11-09-quest-branching-validation
  blockers: []
history:
  - version: '0.1.0'
    date: 2025-11-09
    author: brain_manager
    changes: "Конвертировано из 2025-11-09-quest-branching-validation.md; зафиксированы решения по БД, кэшу и API."
validation:
  checksum: ''
  schema_version: '1.0'

