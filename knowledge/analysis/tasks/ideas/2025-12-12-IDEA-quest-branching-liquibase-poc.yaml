# Issue: #479
metadata:
  id: analysis-idea-quest-branching-liquibase-poc
  title: Quest Branching Liquibase PoC
  document_type: analysis
  category: ideas
  status: draft
  version: '1.0.0'
  last_updated: 2025-12-12T00:00:00Z
  github_issue_number: 479
  owners:
    - role: analysis_lead
      contact: brain@necp.game
  tags:
    - quests
    - liquibase
    - poc
  topics:
    - branching
    - migrations
  related_systems:
    - quest-service
    - liquibase
    - db-schema
  related_documents:
    - knowledge/analysis/tasks/active/CURRENT-WORK/active/2025-11-09-quest-branching-poc-plan.yaml
  source: https://github.com/gc-lover/necpgame-monorepo/issues/479
summary:
  problem: Нужен PoC для ветвления квестов через Liquibase с сохранением веток и откатов.
  goal: Определить схему миграций и минимальный сет таблиц/триггеров для хранения веток и выборов.
  essence: Минимальный прототип Liquibase для branch_state, choice_log и связок с quest_nodes.
  key_points:
    - Схема веток (quest_nodes, quest_branches, quest_choices).
    - Лог выборов и откаты через Liquibase changeSets.
    - Примеры миграций и откатов.
    - Метрики времени применения миграций и размера данных.
content:
  scope:
    tables:
      - quest_nodes
      - quest_branches
      - quest_choices
      - player_choice_log
    change_sets:
      - add_branch_state
      - add_choice_log_indexes
      - rollback_example
  success_criteria:
    - миграции применяются < 3s на dev db
    - откат восстанавливает предыдущее состояние данных
    - выборы игрока логируются и читаются в одном запросе
  telemetry:
    events:
      - name: liquibase_apply
        fields: [duration_ms, change_set]
      - name: liquibase_rollback
        fields: [duration_ms, change_set]
risks:
  - раздувание changeLog без dry-run
  - конкурирующие миграции при параллельной разработке
  - откаты могут потерять выборы без архивной таблицы

