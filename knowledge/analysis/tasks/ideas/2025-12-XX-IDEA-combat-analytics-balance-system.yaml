metadata:
  id: analysis-ideas-2025-12-combat-analytics-balance
  title: Система сбора статистики и балансировки боевых механик
  document_type: analysis
  category: combat
  status: in_progress
  version: '0.1.0'
  last_updated: 2025-12-XXT00:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  processed_by: idea-writer
  processed_at: 2025-12-XXT00:00:00Z
  github_issue_number: 1518
  owners:
    - role: analytics_lead
      contact: analytics@necp.game
    - role: combat_director
      contact: combat@necp.game
  tags:
    - combat-analytics
    - balance
    - statistics
    - telemetry
    - combat
  topics:
    - combat-balance
    - analytics
    - data-collection
    - skill-balancing
  related_systems:
    - analytics-service
    - gameplay-service
    - combat-sessions-service
    - combat-abilities-service
    - combat-ai-service
  related_documents:
    - id: github-issue-1518
      title: GitHub Issue #1518
      link: https://github.com/gc-lover/necpgame-monorepo/issues/1518
      relation: migrated_to
      migrated_at: 2025-12-XXT00:00:00Z
    - id: combat-shooting-architecture
      relation: extends
    - id: combat-ai-enemies-architecture
      relation: extends
    - id: combat-abilities-architecture
      relation: extends
    - id: faction-analytics-balance
      relation: references
  source: knowledge/analysis/tasks/ideas/2025-12-XX-IDEA-combat-analytics-balance-system.yaml
  visibility: internal
  audience:
    - analytics
    - combat
    - systems
    - gameplay
  risk_level: medium
review:
  chain:
    - role: analytics_lead
      reviewer: ''
      reviewed_at: ''
      status: pending
    - role: combat_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: |
    В проекте отсутствует единая система для сбора статистики по всем боевым механикам.
    Каждая система (стрельба, способности, AI, паркур) собирает свою телеметрию отдельно,
    что затрудняет анализ баланса навыков и боевых механик. Нет централизованного места
    для запросов статистики и автоматической балансировки на основе данных.
  goal: |
    Создать единую систему Combat Analytics & Balance System для:
    - Сбора статистики по всем боевым механикам (стрельба, способности, импланты, комбо, хакинг, паркур)
    - Агрегации метрик для балансировки (TTK, DPS, использование навыков, эффективность)
    - Предоставления API для запросов статистики
    - Автоматической балансировки на основе собранных данных
  essence: |
    Система собирает телеметрию от всех боевых систем, агрегирует метрики и предоставляет
    инструменты для анализа баланса. Позволяет автоматически корректировать параметры
    навыков и боевых механик на основе реальной статистики использования и эффективности.
  key_points:
    - Единая точка сбора статистики от всех боевых систем
    - Агрегация метрик для анализа баланса
    - API для запросов статистики и аналитики
    - Автоматическая балансировка на основе данных
    - Интеграция с существующими телеметрическими коллекторами
content:
  sections:
    - id: concept_overview
      title: Концепция системы
      body: |
        Combat Analytics & Balance System - это централизованная система для сбора, хранения
        и анализа статистики по всем боевым механикам игры. Система интегрируется с существующими
        телеметрическими коллекторами и предоставляет единый API для запросов статистики.
        
        ## Основные компоненты
        
        1. **Combat Telemetry Collector** - собирает события от всех боевых систем
        2. **Combat Metrics Aggregator** - агрегирует метрики по различным измерениям
        3. **Combat Balance Analyzer** - анализирует баланс и выявляет дисбалансы
        4. **Combat Balance Tuner** - автоматически корректирует параметры баланса
        5. **Combat Analytics API** - REST API для запросов статистики
        
        ## Принцип работы
        
        1. Все боевые системы публикуют события в Event Bus
        2. Combat Telemetry Collector подписывается на события и сохраняет в БД
        3. Combat Metrics Aggregator периодически агрегирует данные
        4. Combat Balance Analyzer анализирует метрики и выявляет проблемы
        5. Combat Balance Tuner корректирует параметры (опционально, с подтверждением)
        6. API предоставляет доступ к статистике для дашбордов и инструментов
      mechanics_links:
        - mechanics/combat/combat-shooter-core.yaml
        - mechanics/combat/combat-abilities.yaml
        - mechanics/combat/combat-ai-enemies.yaml
        - implementation/analytics/faction-analytics-balance.yaml
      assets: []
    
    - id: data_collection
      title: Сбор данных
      body: |
        Система собирает статистику от следующих боевых механик:
        
        ## Стрельба (Shooting)
        - Количество выстрелов, попаданий, промахов
        - TTK (Time To Kill) по режимам и оружию
        - DPS (Damage Per Second)
        - Точность стрельбы
        - Использование оружия по типам
        - Эффективность модификаций оружия
        
        ## Способности (Abilities)
        - Использование способностей по типам
        - Эффективность способностей (урон, хил, баффы)
        - Время перезарядки и кулдауны
        - Комбинации способностей
        - Использование ультимейтов
        
        ## Импланты (Implants)
        - Использование имплантов по типам
        - Эффективность имплантов
        - Уровень киберпсихоза
        - Взаимодействие имплантов с другими системами
        
        ## Комбо (Combos)
        - Использование комбо-последовательностей
        - Эффективность комбо
        - Популярные комбинации
        - Синергии между способностями
        
        ## Хакинг (Hacking)
        - Использование хаков по типам
        - Успешность хаков
        - Время на взлом
        - Эффективность против различных целей
        
        ## Паркур (Freerun)
        - Использование паркур-действий
        - Эффективность в бою
        - Комбинации с боевыми действиями
        
        ## AI враги
        - Урон нанесенный/полученный
        - Время до поражения
        - Использование способностей AI
        - Эффективность против различных тактик
      mechanics_links:
        - implementation/architecture/combat-shooting-architecture.yaml
        - implementation/architecture/combat-abilities-architecture.yaml
        - implementation/architecture/combat-ai-enemies-architecture.yaml
        - implementation/architecture/combat-freerun-architecture.yaml
      assets: []
    
    - id: metrics_aggregation
      title: Агрегация метрик
      body: |
        Система агрегирует метрики по следующим измерениям:
        
        ## Временные измерения
        - По часам (для анализа пиковых нагрузок)
        - По дням (для трендов)
        - По неделям (для сезонных изменений)
        - По месяцам (для долгосрочных трендов)
        
        ## Игровые измерения
        - По режимам (PvE, PvP, Arena)
        - По зонам/локациям
        - По уровням персонажей
        - По классам персонажей
        - По лигам/рейтингам
        
        ## Боевые измерения
        - По типам оружия
        - По типам способностей
        - По типам имплантов
        - По комбинациям навыков
        
        ## Ключевые метрики для балансировки
        
        ### TTK метрики
        - Средний TTK по оружию и режимам
        - Медианный TTK
        - Процентили TTK (25%, 50%, 75%, 95%)
        - Распределение TTK
        
        ### DPS метрики
        - Средний DPS по способностям
        - Пиковый DPS
        - Устойчивый DPS
        - DPS по типам целей
        
        ### Использование
        - Популярность навыков/оружия
        - Частота использования
        - Процент игроков использующих
        - Тренды использования
        
        ### Эффективность
        - Win rate с различными билдами
        - K/D ratio по оружию/способностям
        - Успешность комбо
        - Эффективность против различных целей
      mechanics_links:
        - implementation/analytics/faction-analytics-balance.yaml
      assets: []
    
    - id: balance_analysis
      title: Анализ баланса
      body: |
        Система анализирует баланс и выявляет дисбалансы:
        
        ## Выявление проблем
        
        ### Сверхэффективные навыки
        - Навыки с аномально высоким win rate
        - Навыки с аномально низким TTK
        - Навыки с аномально высоким DPS
        - Навыки используемые >80% игроков
        
        ### Слабоэффективные навыки
        - Навыки с аномально низким win rate
        - Навыки используемые <5% игроков
        - Навыки с низкой эффективностью
        
        ### Дисбалансы между классами
        - Разница в эффективности классов
        - Доминирование одного класса
        - Недостаточное разнообразие билдов
        
        ## Автоматические рекомендации
        
        Система генерирует рекомендации по балансировке:
        - Увеличение/уменьшение урона
        - Изменение кулдаунов
        - Корректировка стоимости ресурсов
        - Изменение параметров способностей
        
        Рекомендации требуют подтверждения от баланс-команды перед применением.
      mechanics_links: []
      assets: []
    
    - id: automatic_balancing
      title: Автоматическая балансировка
      body: |
        Система может автоматически корректировать параметры баланса:
        
        ## Режимы работы
        
        ### Ручной режим (по умолчанию)
        - Система только генерирует рекомендации
        - Изменения применяются вручную баланс-командой
        
        ### Полуавтоматический режим
        - Система применяет изменения с подтверждением
        - Баланс-команда проверяет и подтверждает изменения
        
        ### Автоматический режим (опционально)
        - Система применяет изменения автоматически
        - Только для некритичных параметров
        - С ограничениями на величину изменений
        
        ## Правила автоматической балансировки
        
        - Максимальное изменение параметра за раз: ±10%
        - Минимальный интервал между изменениями: 24 часа
        - Требуется минимум 1000 использований для анализа
        - Изменения применяются только в тестовой среде сначала
        
        ## Откат изменений
        
        Система отслеживает влияние изменений и может автоматически откатывать
        если метрики ухудшились после балансировки.
      mechanics_links: []
      assets: []
    
    - id: api_design
      title: API для статистики
      body: |
        REST API для запросов статистики:
        
        ## Endpoints
        
        ### Общая статистика
        - `GET /api/v1/analytics/combat/overview` - общая статистика по боевым механикам
        - `GET /api/v1/analytics/combat/metrics` - метрики с фильтрами
        - `GET /api/v1/analytics/combat/trends` - тренды по времени
        
        ### Статистика по стрельбе
        - `GET /api/v1/analytics/combat/shooting/stats` - статистика стрельбы
        - `GET /api/v1/analytics/combat/shooting/ttk` - TTK метрики
        - `GET /api/v1/analytics/combat/shooting/weapons` - статистика по оружию
        
        ### Статистика по способностям
        - `GET /api/v1/analytics/combat/abilities/stats` - статистика способностей
        - `GET /api/v1/analytics/combat/abilities/usage` - использование способностей
        - `GET /api/v1/analytics/combat/abilities/effectiveness` - эффективность
        
        ### Статистика по имплантам
        - `GET /api/v1/analytics/combat/implants/stats` - статистика имплантов
        - `GET /api/v1/analytics/combat/implants/usage` - использование имплантов
        
        ### Статистика по комбо
        - `GET /api/v1/analytics/combat/combos/stats` - статистика комбо
        - `GET /api/v1/analytics/combat/combos/popular` - популярные комбо
        
        ### Балансировка
        - `GET /api/v1/analytics/combat/balance/issues` - выявленные проблемы баланса
        - `GET /api/v1/analytics/combat/balance/recommendations` - рекомендации
        - `POST /api/v1/analytics/combat/balance/apply` - применить изменения баланса
        
        ## Фильтры
        
        Все endpoints поддерживают фильтры:
        - `time_range` - временной диапазон
        - `mode` - режим игры (PvE, PvP, Arena)
        - `zone_id` - зона/локация
        - `min_level`, `max_level` - диапазон уровней
        - `class` - класс персонажа
        - `league` - лига/рейтинг
      mechanics_links:
        - implementation/architecture/economy-analytics-system-architecture.yaml
      assets: []
    
    - id: database_structure
      title: Структура базы данных
      body: |
        ## Основные таблицы
        
        ### combat_telemetry_events
        Хранит все события от боевых систем:
        ```sql
        CREATE TABLE combat_telemetry_events (
            id UUID PRIMARY KEY,
            event_type VARCHAR(100) NOT NULL,
            system_type VARCHAR(50) NOT NULL,
            character_id UUID,
            session_id UUID,
            zone_id UUID,
            mode VARCHAR(50),
            data JSONB NOT NULL,
            timestamp TIMESTAMPTZ NOT NULL,
            INDEX idx_event_type (event_type),
            INDEX idx_system_type (system_type),
            INDEX idx_timestamp (timestamp),
            INDEX idx_character_id (character_id)
        );
        ```
        
        ### combat_metrics_aggregated
        Агрегированные метрики:
        ```sql
        CREATE TABLE combat_metrics_aggregated (
            id UUID PRIMARY KEY,
            metric_type VARCHAR(100) NOT NULL,
            metric_name VARCHAR(100) NOT NULL,
            dimension_type VARCHAR(50),
            dimension_value VARCHAR(100),
            time_bucket TIMESTAMPTZ NOT NULL,
            value NUMERIC(15,4) NOT NULL,
            sample_count INTEGER NOT NULL,
            metadata JSONB,
            created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
            UNIQUE(metric_type, metric_name, dimension_type, dimension_value, time_bucket)
        );
        ```
        
        ### combat_balance_issues
        Выявленные проблемы баланса:
        ```sql
        CREATE TABLE combat_balance_issues (
            id UUID PRIMARY KEY,
            issue_type VARCHAR(100) NOT NULL,
            skill_id VARCHAR(100),
            severity VARCHAR(50),
            description TEXT,
            metrics JSONB,
            recommendations JSONB,
            status VARCHAR(50) DEFAULT 'open',
            created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
            resolved_at TIMESTAMPTZ
        );
        ```
        
        ### combat_balance_changes
        История изменений баланса:
        ```sql
        CREATE TABLE combat_balance_changes (
            id UUID PRIMARY KEY,
            skill_id VARCHAR(100) NOT NULL,
            parameter_name VARCHAR(100) NOT NULL,
            old_value NUMERIC(15,4),
            new_value NUMERIC(15,4),
            change_reason TEXT,
            applied_by VARCHAR(100),
            applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
            reverted_at TIMESTAMPTZ,
            revert_reason TEXT
        );
        ```
      mechanics_links: []
      assets: []
    
    - id: integrations
      title: Интеграции
      body: |
        ## Интеграция с существующими системами
        
        ### Shooting Telemetry Collector
        - Подписка на события `combat.shooting.*`
        - Сбор данных о выстрелах, попаданиях, TTK
        
        ### AI Telemetry Collector
        - Подписка на события `combat.ai.*`
        - Сбор данных о встречах с AI, уроне, времени до поражения
        
        ### Freerun Telemetry Collector
        - Подписка на события `combat.freerun.*`
        - Сбор данных о паркур-действиях в бою
        
        ### Combat Session
        - Подписка на события `combat.session.*`
        - Сбор данных о сессиях, участниках, результатах
        
        ### Ability Service
        - Подписка на события `combat.ability.*`
        - Сбор данных об использовании способностей
        
        ### Implant Service
        - Подписка на события `combat.implant.*`
        - Сбор данных об использовании имплантов
        
        ## Event Bus события
        
        ### Публикуемые события
        - `analytics.combat.metric.updated` - обновление метрики
        - `analytics.combat.balance.issue.detected` - выявлена проблема баланса
        - `analytics.combat.balance.recommendation.generated` - сгенерирована рекомендация
        - `analytics.combat.balance.change.applied` - применено изменение баланса
        
        ### Подписываемые события
        - `combat.shooting.*` - события стрельбы
        - `combat.ability.*` - события способностей
        - `combat.implant.*` - события имплантов
        - `combat.combo.*` - события комбо
        - `combat.hacking.*` - события хакинга
        - `combat.freerun.*` - события паркура
        - `combat.ai.*` - события AI
        - `combat.session.*` - события сессий
      mechanics_links:
        - implementation/architecture/combat-shooting-architecture.yaml
        - implementation/architecture/combat-ai-enemies-architecture.yaml
        - implementation/architecture/combat-freerun-architecture.yaml
      assets: []
    
    - id: implementation_phases
      title: Этапы реализации
      body: |
        ## Фаза 1: Базовая инфраструктура
        - Создание таблиц БД
        - Базовый Combat Telemetry Collector
        - Подписка на события от основных систем
        - Базовое API для запросов статистики
        
        ## Фаза 2: Агрегация метрик
        - Combat Metrics Aggregator
        - Агрегация по временным измерениям
        - Агрегация по игровым измерениям
        - Кэширование агрегированных данных
        
        ## Фаза 3: Анализ баланса
        - Combat Balance Analyzer
        - Выявление проблем баланса
        - Генерация рекомендаций
        - Дашборд для просмотра статистики
        
        ## Фаза 4: Автоматическая балансировка
        - Combat Balance Tuner
        - Режимы работы (ручной/полуавтоматический/автоматический)
        - Правила автоматической балансировки
        - Система отката изменений
        
        ## Фаза 5: Расширенная аналитика
        - ML модели для предсказания баланса
        - A/B тестирование изменений
        - Интеграция с дашбордами
        - Расширенные отчеты
      mechanics_links: []
      assets: []
    
    - id: risks
      title: Риски и ограничения
      body: |
        ## Технические риски
        
        - **Производительность**: Большой объем данных может замедлить систему
          - Решение: Агрегация данных, партиционирование таблиц, индексы
        
        - **Хранение данных**: Данные могут занимать много места
          - Решение: Архивация старых данных, сжатие, удаление через N дней
        
        - **Точность метрик**: Неточные метрики могут привести к неправильной балансировке
          - Решение: Валидация данных, проверка выбросов, минимум выборки
        
        ## Игровые риски
        
        - **Неправильная балансировка**: Автоматическая балансировка может ухудшить баланс
          - Решение: Ручное подтверждение, постепенные изменения, откат
        
        - **Мета-сдвиги**: Изменения баланса могут создать новые проблемы
          - Решение: Мониторинг после изменений, быстрый откат
        
        ## Ограничения
        
        - Требуется минимум данных для анализа (1000+ использований)
        - Изменения применяются постепенно
        - Автоматическая балансировка только для некритичных параметров
        - Требуется подтверждение для значительных изменений
      mechanics_links: []
      assets: []
appendix:
  glossary:
    - term: TTK
      definition: Time To Kill - время до убийства цели
    - term: DPS
      definition: Damage Per Second - урон в секунду
    - term: Telemetry
      definition: Телеметрия - сбор данных о событиях в игре
    - term: Aggregation
      definition: Агрегация - объединение данных для получения метрик
  references:
    - title: Combat Shooting Architecture
      link: knowledge/implementation/architecture/combat-shooting-architecture.yaml
    - title: Combat AI Enemies Architecture
      link: knowledge/implementation/architecture/combat-ai-enemies-architecture.yaml
    - title: Faction Analytics Balance
      link: knowledge/implementation/analytics/faction-analytics-balance.yaml
  decisions: []
implementation:
  needs_task: true
  queue_reference: []
  blockers: []
history:
  - version: '0.1.0'
    date: 2025-12-XX
    author: idea-writer
    changes: Создана концепция системы сбора статистики и балансировки боевых механик
validation:
  checksum: ''
  schema_version: '1.0'

