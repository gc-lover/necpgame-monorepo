<!-- Issue: #1466 -->
# Интеграция баек городских легенд с NPC диалоговой системой - Концепция

## Обзор

Система интеграции баек с NPC диалогами обеспечивает естественное вплетение легенд в игровой опыт. NPC получают доступ к базе баек и могут рассказывать их в подходящих моментах диалогов, создавая ощущение живого мира, где информация передаётся естественным образом.

## Лор в мире Cyberpunk 2077

### Контекст интеграции с диалогами

В мире NECPGAME NPC живут своей жизнью, общаются друг с другом и с игроками. Когда игрок становится легендой, его истории становятся частью разговоров NPC, естественно вплетаясь в диалоги без нарушения игрового опыта.

**Как работают байки в диалогах:**
- NPC сами начинают рассказывать байки при встрече с легендарным игроком
- Игрок может спросить про легенду, и NPC расскажет байку
- NPC разговаривают между собой про легенд, когда игрок рядом
- Байки упоминаются в контексте других диалогов

**Атмосфера:**
- Естественные разговоры, не выглядящие как скрипты
- Разные стили подачи для разных типов NPC
- Эмоциональная окраска зависит от отношения к легенде
- Контекстные упоминания создают ощущение живого мира

## Типы интеграции баек

### Активные диалоги

**Лор:**
NPC сами начинают рассказывать байку при встрече с легендарным игроком. Это создаёт ощущение, что легенда действительно известна в мире.

**Механика:**
- NPC сам начинает рассказывать байку при встрече с игроком-легендой
- Триггер: игрок-легенда входит в локацию или начинает взаимодействие
- Формат: "О, это же {name}! Слышал про него..."
- Приоритет: высокий (активируется при первом подходящем моменте)

**Примеры:**
- Бармен Afterlife: "О, это же {name}! Слышал, ты вынес тысячу корпоратов Arasaka. Что будешь пить, легенда?"
- Уличный информатор: "Вижу, {name} здесь. Говорят, ты помог пятистам новичкам. Нужна информация?"
- Торговец: "{name}? Тот самый честный торговец? Добро пожаловать в мой магазин!"

**Визуальный стиль:**
- NPC визуально реагируют на присутствие легенды (взгляд, жесты)
- Диалоговые окна с особым оформлением для легенд
- Визуальные эффекты (опционально: аура, голограммы)

### Реактивные диалоги

**Лор:**
Игрок может спросить NPC про легендарного игрока, и NPC расскажет байку, если знает её. Это даёт игроку контроль над получением информации.

**Механика:**
- Игрок задаёт вопрос про легенду в диалоге
- Триггер: вопрос в диалоге, упоминание имени легенды
- Формат: "Ты спрашиваешь про {name}? Да, я слышал..."
- Приоритет: средний (активируется при наличии времени)

**Примеры:**
- Игрок: "Ты знаешь кого-то, кто может помочь с Arasaka?"
- NPC: "Ты спрашиваешь про {legend_name}? Да, я слышал, он вынес тысячу корпоратов Arasaka. Может, он поможет?"
- Игрок: "Слышал про {legend_name}?"
- NPC: "Да, {legend_name} - легенда. Говорят, он помог пятистам новичкам выжить."

**Визуальный стиль:**
- Диалоговые опции для вопросов про легенд
- Реакции NPC на вопросы (задумчивость, улыбка, страх)
- Визуальные эффекты при рассказе байки (голограммы, проекции)

### Фоновые разговоры

**Лор:**
NPC разговаривают между собой про легенд, когда игрок находится рядом, но не взаимодействует. Это создаёт ощущение живого мира, где информация распространяется естественно.

**Механика:**
- NPC разговаривают между собой про легенд
- Триггер: игрок находится рядом, но не взаимодействует
- Формат: "Слышал новое про {name}? Говорят..."
- Приоритет: низкий (активируется в фоновом режиме)

**Примеры:**
- NPC1: "Слышал новое про {name}?"
- NPC2: "Да, говорят, он вынес тысячу корпоратов Arasaka. Невероятно!"
- *(Игрок слышит разговор, находясь рядом)*

**Визуальный стиль:**
- NPC визуально разговаривают друг с другом (жесты, мимика)
- Игрок слышит разговор, находясь в радиусе слышимости
- Визуальные индикаторы разговора (опционально)

### Контекстные упоминания

**Лор:**
Байка упоминается в контексте другого диалога, создавая естественные связи между темами. Это делает диалоги более живыми и релевантными.

**Механика:**
- Байка упоминается в контексте другого диалога
- Триггер: релевантная тема в разговоре
- Формат: "Как {name} когда-то сделал..."
- Приоритет: средний (активируется при наличии времени)

**Примеры:**
- Игрок: "Как пройти к Arasaka Tower?"
- NPC: "Осторожно там. Как {legend_name} когда-то сделал, можно попасть в беду."
- Игрок: "Где найти хорошее оружие?"
- NPC: "Попробуй у торговца {legend_name}. Он всегда честен."

**Визуальный стиль:**
- Контекстные упоминания выглядят естественно
- Не нарушают поток диалога
- Создают ощущение связанности мира

## Система триггеров

### Триггеры по локации

**Лор:**
Определённые локации связаны с определёнными типами легенд. Бар → боевые и социальные легенды, рынок → экономические легенды, лаборатория → исследовательские легенды.

**Механика:**
- Локации связаны с типами легенд (бар → боевые, рынок → экономические)
- NPC в этих локациях знают соответствующие легенды
- Вероятность активации выше в релевантных локациях

**Примеры:**
- Бар Afterlife → боевые и социальные легенды
- Рынок → экономические легенды
- Лаборатория → исследовательские легенды
- Корпоративный офис → легенды про конфликты с корпорациями

**Визуальный стиль:**
- Локации визуально отражают тип легенд (плакаты, граффити, голограммы)
- NPC в этих локациях имеют соответствующие знания

### Триггеры по времени

**Лор:**
Время суток влияет на тип баек. Ночь → таинственные легенды, день → открытые истории, события мира → актуальные байки.

**Механика:**
- Время суток влияет на тип баек (ночь → таинственные, день → открытые)
- События мира активируют актуальные байки
- Вероятность активации зависит от времени

**Примеры:**
- Ночь → таинственные легенды, истории про тени
- День → открытые истории, публичные события
- События мира → актуальные байки про текущие события

**Визуальный стиль:**
- Временные эффекты (ночь/день, праздничные украшения)
- Изменение атмосферы локаций в зависимости от времени

### Триггеры по фракции

**Лор:**
NPC определённых фракций знают определённые легенды. Arasaka NPC → легенды про конфликты с корпорацией, уличные банды → легенды про боевые действия.

**Механика:**
- Фракции связаны с типами легенд (Arasaka → конфликты, банды → боевые)
- NPC этих фракций знают соответствующие легенды
- Вероятность активации выше для релевантных фракций

**Примеры:**
- Arasaka NPC → легенды про конфликты с корпорацией
- Уличные банды → легенды про боевые действия
- Нейтральные NPC → общие легенды

**Визуальный стиль:**
- Фракционные NPC имеют соответствующие знания
- Визуальные индикаторы фракционной принадлежности

### Триггеры по теме диалога

**Лор:**
Ключевые слова в диалоге активируют релевантные байки. "торговля" → экономические легенды, "бой" → боевые легенды, "секреты" → исследовательские легенды.

**Механика:**
- Ключевые слова в диалоге активируют релевантные байки
- Система анализирует тему разговора
- Вероятность активации зависит от релевантности

**Примеры:**
- "торговля" → экономические легенды
- "бой" → боевые легенды
- "секреты" → исследовательские легенды
- "помощь" → социальные легенды

**Визуальный стиль:**
- Ключевые слова визуально не выделяются (скрытая механика)
- Результат выглядит естественно

### Триггеры по присутствию игрока-легенды

**Лор:**
Если легендарный игрок находится в локации, NPC могут комментировать его присутствие. Другие игроки могут спрашивать про него.

**Механика:**
- Присутствие легендарного игрока в локации активирует байки
- NPC комментируют присутствие легенды
- Другие игроки могут спрашивать про легенду

**Примеры:**
- Легендарный игрок входит в бар → бармен рассказывает байку
- Другие игроки спрашивают про легенду → NPC рассказывает байку
- Легендарный игрок проходит мимо → NPC перешёптываются

**Визуальный стиль:**
- Визуальные эффекты присутствия легенды (аура, голограммы)
- Реакции NPC на присутствие легенды (почтение, страх, зависть)
- Специальные анимации при встрече с легендой

## Интеграция с диалоговой системой

### Расширение диалоговых узлов

**Лор:**
Диалоговая система расширяется новым типом узла для баек. Узел содержит ссылку на байку и может быть условным.

**Механика:**
- Новый тип узла: "Legend Story Node"
- Узел содержит ссылку на байку
- Узел может быть условным (проверка наличия легенды)
- Узел может быть динамическим (генерация байки на лету)

**Примеры:**
- Узел "Legend Story" с ссылкой на байку про боевую легенду
- Условный узел, активирующийся только если игрок-легенда
- Динамический узел, генерирующий байку на основе контекста

**Визуальный стиль:**
- Узлы визуально не отличаются от обычных (скрытая механика)
- Результат выглядит как обычный диалог

### Диалоговые ветки

**Лор:**
В диалогах информаторов и рассказчиков появляются ветки для вопросов про легенд. Это даёт игроку возможность узнавать истории.

**Механика:**
- Ветка "Спросить про легенд" в диалогах информаторов
- Ветка "Рассказать про легенду" для NPC-рассказчиков
- Условные ветки, активирующиеся при наличии легенд

**Примеры:**
- Информатор: "Хочешь узнать про легенд? [Спросить про легенду]"
- NPC-рассказчик: "Могу рассказать про легенд. [Рассказать про легенду]"
- Условная ветка: "[Спросить про {legend_name}]" (только если легенда известна)

**Визуальный стиль:**
- Диалоговые опции выглядят естественно
- Не нарушают поток диалога

### Динамические диалоги

**Лор:**
Байки вставляются динамически в существующие диалоги, создавая естественные упоминания без нарушения структуры диалога.

**Механика:**
- Байки вставляются динамически в существующие диалоги
- Система подстановки текста в диалоговые шаблоны
- Сохранение естественности речи NPC

**Примеры:**
- Обычный диалог: "Осторожно в Watson."
- С байкой: "Осторожно в Watson. Как {legend_name} когда-то сделал, можно попасть в беду."

**Визуальный стиль:**
- Динамические вставки выглядят естественно
- Не нарушают структуру диалога

## Система знаний NPC

### Уровни знаний

**Лор:**
NPC имеют разные уровни знаний о легендах. Прямое знание → высокая точность, слухи → средняя точность, легенды → низкая точность с искажениями.

**Механика:**
- **Прямое знание**: NPC видел событие лично (100% точность, много деталей)
- **Слухи**: NPC слышал от других (70% точность, меньше деталей)
- **Легенды**: NPC знает только мифы и преувеличения (30% точность, искажения)

**Примеры:**
- Свидетель: "Я видел, как {name} вынес тысячу корпоратов. Невероятно!"
- Слухи: "Слышал, {name} вынес тысячу корпоратов. Говорят, он как призрак."
- Легенды: "Говорят, {name} в одиночку уничтожил тысячу корпоратов Arasaka. Невероятно!"

**Визуальный стиль:**
- Уровни знаний визуально не отображаются (скрытая механика)
- Результат отражается в деталях и точности байки

### Распространение знаний

**Лор:**
Знания распространяются между NPC через социальные сети. Время влияет на точность, локация влияет на доступность знаний.

**Механика:**
- Знания распространяются между NPC через социальные связи
- Время влияет на точность (старые события искажаются)
- Локация влияет на доступность знаний (близкие локации знают больше)

**Примеры:**
- Свежая информация: высокая точность, много деталей
- Старая информация: низкая точность, искажения
- Близкие локации: больше знаний
- Отдалённые локации: меньше знаний

**Визуальный стиль:**
- Распространение знаний визуально не отображается (скрытая механика)
- Результат отражается в доступности баек

### База знаний NPC

**Лор:**
Каждый NPC имеет базу знаний о легендах, которая определяет, какие байки он может рассказывать. База знаний обновляется через систему распространения.

**Механика:**
- Таблица `npc_legend_knowledge` - какие NPC знают какие легенды
- Таблица `knowledge_spread` - как знания распространяются
- Кэш знаний для быстрого доступа

**Примеры:**
- Бармен Afterlife знает все боевые легенды
- Торговец знает экономические легенды
- Информатор знает все типы легенд

**Визуальный стиль:**
- База знаний визуально не отображается (скрытая механика)
- Результат отражается в доступности баек

## Реакции NPC на легендарных игроков

### Типы реакций

**Лор:**
NPC по-разному реагируют на легендарных игроков в зависимости от отношения к легенде. Уважение, страх, зависть, нейтралитет - разные эмоции создают разные диалоги.

**Механика:**
- **Уважение**: NPC относится с почтением (позитивные диалоги, скидки)
- **Страх**: NPC боится легендарного игрока (осторожные диалоги, избегание)
- **Зависть**: NPC завидует достижениям (нейтральные/негативные диалоги)
- **Нейтралитет**: NPC знает, но не реагирует особо (обычные диалоги)

**Примеры:**
- Уважение: "Легенда {name}! Что могу для тебя сделать?"
- Страх: "О, это {name}... Будь осторожен."
- Зависть: "{name}? Удачливый чувак."
- Нейтралитет: "Слышал про {name}. Что нужно?"

**Визуальный стиль:**
- Реакции отражаются в тоне диалогов
- Визуальные эффекты (опционально: жесты, мимика)

### Влияние на диалоги

**Лор:**
Реакции NPC влияют на диалоги, создавая разные варианты приветствий, специальные опции и изменение тона разговора.

**Механика:**
- Разные варианты приветствий для легендарных игроков
- Специальные опции диалогов (скидки, уникальные квесты)
- Изменение тона разговора (почтение, страх, зависть)

**Примеры:**
- Приветствие с уважением: "Легенда {name}! Добро пожаловать!"
- Специальная опция: "[Получить скидку]" (только для легенд)
- Изменение тона: более формальный/почтительный тон

**Визуальный стиль:**
- Диалоги отражают реакцию NPC
- Визуальные эффекты (опционально)

### Влияние на поведение

**Лор:**
Реакции NPC влияют на поведение, создавая специальные услуги, скидки и уникальные квесты для легендарных игроков.

**Механика:**
- NPC могут предлагать специальные услуги (скидки, уникальные предметы)
- Скидки в магазинах (5-10% для легенд)
- Уникальные квесты (только для легенд)

**Примеры:**
- Торговец: "Для легенды {name} - скидка 10%!"
- Фиксёр: "У меня есть особое задание для тебя, {name}."
- Бармен: "Напиток за счёт заведения, легенда!"

**Визуальный стиль:**
- Поведение NPC отражает реакцию
- Визуальные индикаторы специальных услуг (опционально)

## Интеграция с игровыми системами

### NPC Service
- Интеграция с диалоговой системой NPC
- Управление знаниями NPC
- Реакции NPC на игроков

### World Service
- Получение контекста локаций
- Триггеры по событиям мира
- Распространение знаний между локациями

### Social Service
- Получение статуса легенды игрока
- Интеграция с системой репутации

### Dialogue System
- Расширение диалоговой системы
- Новые типы диалоговых узлов
- Динамическая генерация диалогов

## Критерии готовности

Концепция готова к передаче Architect когда:
- [x] Детальный лор в стиле Cyberpunk 2077 описан
- [x] Типы интеграции баек с диалогами детально описаны
- [x] Система триггеров активации определена
- [x] Интеграция с диалоговой системой проработана
- [x] Система знаний NPC определена
- [x] Реакции NPC на легендарных игроков описаны
- [x] Интеграции с игровыми системами описаны

## Следующие шаги

1. Передача концепции Architect для детализации технической реализации
2. Создание OpenAPI спецификаций для API Designer
3. Реализация бекенда для Backend Developer
4. Интеграция с контентом для Content Writer

