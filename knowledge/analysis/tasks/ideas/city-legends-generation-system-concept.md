<!-- Issue: #1465 -->
# Система генерации баек на основе действий игроков-легенд - Концепция

## Обзор

Система автоматической генерации баек анализирует данные игрока-легенды и создаёт текстовые истории, которые NPC могут рассказывать. Генерация происходит по шаблонам с подстановкой переменных, учитывая контекст и вариативность, создавая уникальные байки для каждого легендарного игрока.

## Лор в мире Cyberpunk 2077

### Контекст генерации баек

В мире NECPGAME легендарные игроки становятся частью городского фольклора. Их действия, достижения и статистика превращаются в байки, которые NPC передают из уст в уста. Система автоматически создаёт эти истории, анализируя реальные действия игроков.

**Как работают генерируемые байки:**
- Система анализирует достижения, статистику и действия игрока
- Выбирает наиболее значимые события для генерации баек
- Создаёт текстовые истории по шаблонам с вариативностью
- Адаптирует байки под контекст (локация, фракция, время)

**Атмосфера:**
- Байки основаны на реальных действиях игроков
- Каждая легенда уникальна и отражает стиль игры
- Время и распространение искажают информацию, создавая мифы
- Разные типы легенд (боевые, социальные, экономические, исследовательские)

## Источники данных для генерации

### Достижения игрока

**Лор:**
Уникальные достижения игрока становятся основой для легенд. Редкие достижения создают более интересные истории, чем обычные.

**Механика:**
- Уникальные достижения (тип, описание, дата получения)
- Редкие достижения (процент игроков, получивших)
- Цепочки достижений (связанные события)
- Специфические достижения (боевые, социальные, экономические, исследовательские)

**Примеры:**
- "Один против армии" → боевая легенда
- "Помощь тысяче новичков" → социальная легенда
- "Тысяча честных сделок" → экономическая легенда
- "Находка всех секретов" → исследовательская легенда

**Визуальный стиль:**
- Достижения визуально отображаются в интерфейсе
- Редкие достижения имеют особое оформление

### Статистика действий

**Лор:**
Статистика действий игрока показывает паттерны поведения, которые становятся основой для легенд. Уникальные комбинации действий создают более интересные истории.

**Механика:**
- Количество убийств по типам врагов (корпораты, бандиты, роботы)
- Уникальные комбинации действий (массовые убийства, одиночные подвиги)
- Рекорды (максимальный урон, время выживания, количество убийств)
- Социальные метрики (помощь другим игрокам, создание гильдий)

**Примеры:**
- 1000 убийств корпоратов Arasaka → боевая легенда
- Помощь 500 новичкам → социальная легенда
- Максимальный урон в одном бою → боевая легенда
- Создание крупной гильдии → социальная легенда

**Визуальный стиль:**
- Статистика визуально отображается в интерфейсе
- Рекорды имеют особое оформление

### Репутация и фракции

**Лор:**
Репутация игрока с фракциями влияет на тип легенд. Конфликты с корпорациями создают боевые легенды, сотрудничество создаёт социальные легенды.

**Механика:**
- Уровень репутации с каждой фракцией (от -100 до +100)
- Изменения репутации (резкие скачки создают легенды)
- Конфликты между фракциями (игрок в центре конфликта)
- Союзные отношения (игрок помогает фракциям)

**Примеры:**
- Репутация -100 с Arasaka → легенда про конфликт
- Репутация +100 с уличными бандами → легенда про сотрудничество
- Резкий скачок репутации → легенда про изменение отношений

**Визуальный стиль:**
- Репутация визуально отображается в интерфейсе
- Изменения репутации имеют визуальные эффекты

### Экономические данные

**Лор:**
Экономические достижения игрока создают легенды про торговлю, богатство и экономическое влияние.

**Механика:**
- Крупные транзакции (продажа/покупка дорогих предметов)
- Редкие предметы в инвентаре (уникальные артефакты)
- Торговые паттерны (честные сделки, обман, крупные операции)
- Экономическое влияние (контроль рынка, создание торговых сетей)

**Примеры:**
- 1000 честных сделок → легенда про честного торговца
- Коллекция редких артефактов → легенда про коллекционера
- Крупная транзакция → легенда про богатство

**Визуальный стиль:**
- Экономические данные визуально отображаются в интерфейсе
- Крупные транзакции имеют визуальные эффекты

### Временные метки

**Лор:**
Временные метки событий влияют на актуальность легенд. Недавние события создают более актуальные байки, старые события становятся мифами.

**Механика:**
- Когда произошло событие (дата, время)
- Периодичность действий (регулярные действия создают паттерны)
- Активность в определённое время (ночные действия, дневные действия)
- Временные контексты (вчера, на прошлой неделе, месяц назад)

**Примеры:**
- Недавнее событие → актуальная байка
- Старое событие → миф с искажениями
- Регулярные действия → паттерн поведения

**Визуальный стиль:**
- Временные метки визуально не отображаются (скрытая механика)
- Результат отражается в актуальности баек

## Система шаблонов баек

### Структура шаблона

**Лор:**
Шаблоны баек структурированы для генерации разнообразных историй. Они содержат переменные, которые заполняются данными о легенде.

**Механика:**
```
{greeting} {player_name}? {story_intro} {action_description} {location_context} {consequence} {reaction}
```

**Компоненты:**
- `{greeting}` - приветствие ("Слышал про", "Говорят,", "Ты знаешь")
- `{player_name}` - имя игрока
- `{story_intro}` - введение в историю ("тот, кто", "легенда, которая")
- `{action_description}` - описание действия (генерируется из достижений)
- `{location_context}` - контекст локации ("в Watson", "в Afterlife")
- `{consequence}` - последствия действия ("до сих пор ищут", "все знают")
- `{reaction}` - реакция NPC/фракции ("легенда!", "опасный преступник")

**Примеры:**
- "Слышал про {name}? Тот, кто вынес тысячу корпоратов в Watson. До сих пор ищут. Легенда!"
- "Говорят, {name} помог пятистам новичкам. Все знают его имя. Уважаемый человек."

**Визуальный стиль:**
- Шаблоны визуально не отображаются (скрытая механика)
- Результат выглядит естественно

### Типы шаблонов

**Лор:**
Разные типы легенд требуют разных шаблонов. Боевые, социальные, экономические, исследовательские - каждый тип имеет свои особенности.

**Механика:**
- **Боевые**: "Слышал про {name}? {action} в {location}. {enemy_type} до сих пор {consequence}."
- **Социальные**: "{name} - тот, кто {action}. {faction} {reaction}. {impact}."
- **Экономические**: "Торговец {name} {action}. {market_context}. {reputation_effect}."
- **Исследовательские**: "{name} нашел {discovery} в {location}. {lore_context}. {faction_reaction}."

**Примеры:**
- Боевой: "Слышал про John? Вынес тысячу корпоратов Arasaka в Watson. Корпораты до сих пор ищут его."
- Социальный: "Jane - та, кто помогла пятистам новичкам. Все знают её имя. Уважаемый человек."
- Экономический: "Торговец Mike провел тысячу честных сделок. Его слово - закон на рынке."
- Исследовательский: "Alex нашел секретную лабораторию в Watson. Это может изменить всё."

**Визуальный стиль:**
- Типы шаблонов визуально не отображаются (скрытая механика)
- Результат отражает тип легенды

### Переменные в шаблонах

**Лор:**
Переменные в шаблонах заменяются реальными данными о легенде, создавая уникальные истории для каждого игрока.

**Механика:**
- `{player_name}` - имя игрока (подставляется напрямую)
- `{action}` - описание действия (генерируется из достижений: "убил", "помог", "нашел")
- `{location}` - локация события (Watson, Afterlife, Arasaka Tower)
- `{enemy_type}` - тип врага (корпораты, бандиты, роботы)
- `{faction}` - название фракции (Arasaka, Militech, уличные банды)
- `{consequence}` - последствия действия (генерируется из контекста)
- `{reaction}` - реакция NPC/фракции (генерируется из репутации)
- `{time_context}` - временной контекст ("вчера", "на прошлой неделе", "месяц назад")

**Правила подстановки:**
- Генерация описаний действий из достижений (убил → вынес → уничтожил)
- Преобразование чисел в текстовый формат (1000 → тысячу)
- Адаптация временных контекстов (вчера → на прошлой неделе)
- Выбор эмоциональной окраски в зависимости от типа NPC

**Примеры:**
- Данные: {player_name: "John", action: "killed", number: 1000, enemy_type: "corpos"}
- Результат: "Слышал про John? Вынес тысячу корпоратов Arasaka в Watson."

**Визуальный стиль:**
- Переменные заменяются естественно, без видимых артефактов
- Текст выглядит как написанный человеком

## Алгоритм генерации

### Сбор данных

**Механика:**
1. Запрос к Achievement Service для достижений
2. Запрос к Social Service для репутации
3. Запрос к Analytics Service для статистики
4. Запрос к Inventory Service для редких предметов
5. Запрос к World Service для контекста локаций

**Примеры:**
- Achievement Service: уникальные достижения, редкие достижения
- Social Service: репутация с фракциями, изменения репутации
- Analytics Service: статистика убийств, рекорды, социальные метрики
- Inventory Service: редкие предметы, коллекции
- World Service: контекст локаций, события мира

**Визуальный стиль:**
- Сбор данных визуально не отображается (скрытая механика)
- Результат отражается в качестве баек

### Выбор релевантных событий

**Механика:**
1. Фильтрация по важности (уникальность, редкость)
2. Приоритизация недавних событий (актуальность)
3. Группировка связанных событий (создание цепочек)
4. Выбор наиболее значимых событий (максимум 5-10 на игрока)

**Критерии важности:**
- Уникальность (редкие достижения важнее обычных)
- Редкость (процент игроков, получивших)
- Недавность (недавние события важнее старых)
- Значимость (крупные события важнее мелких)

**Примеры:**
- Уникальное достижение "Один против армии" → высокая важность
- Редкое достижение (получили 1% игроков) → высокая важность
- Недавнее событие (произошло вчера) → высокая важность
- Крупное событие (1000 убийств) → высокая важность

**Визуальный стиль:**
- Выбор событий визуально не отображается (скрытая механика)
- Результат отражается в качестве баек

### Выбор шаблона

**Механика:**
1. Определение типа легенды (боевая, социальная, экономическая, исследовательская)
2. Выбор шаблона по типу (из базы шаблонов)
3. Проверка контекста (локация, фракция, время)
4. Выбор наиболее релевантного шаблона

**Примеры:**
- Боевое событие → боевой шаблон
- Социальное событие → социальный шаблон
- Экономическое событие → экономический шаблон
- Исследовательское событие → исследовательский шаблон

**Визуальный стиль:**
- Выбор шаблона визуально не отображается (скрытая механика)
- Результат отражает тип легенды

### Заполнение переменных

**Механика:**
1. Подстановка данных игрока (имя, достижения, статистика)
2. Генерация описаний действий из достижений (убил → вынес → уничтожил)
3. Добавление эмоциональной окраски (восхищение, страх, уважение)
4. Адаптация под контекст (локация, фракция, время)

**Примеры:**
- Данные: {player_name: "John", achievement: "killed_1000_corpos", location: "Watson"}
- Результат: "Слышал про John? Вынес тысячу корпоратов Arasaka в Watson. Легенда!"

**Визуальный стиль:**
- Заполнение переменных визуально не отображается (скрытая механика)
- Результат выглядит естественно

### Валидация и сохранение

**Механика:**
1. Проверка на дубликаты (не повторять недавние байки)
2. Проверка длины и читаемости (оптимально 50-200 слов)
3. Проверка релевантности (соответствие контексту)
4. Сохранение в БД (таблица `legend_stories`)

**Примеры:**
- Дубликат → генерация нового варианта
- Слишком длинно → сокращение
- Нечитаемо → исправление грамматики
- Не релевантно → выбор другого шаблона

**Визуальный стиль:**
- Валидация визуально не отображается (скрытая механика)
- Результат выглядит естественно

## Вариативность и уникальность

### Множественные варианты

**Лор:**
Одно событие может генерировать несколько вариантов байки, создавая разнообразие и предотвращая повторения.

**Механика:**
- Одно событие генерирует 3-5 вариантов байки
- Разные эмоциональные тона (восхищение, страх, уважение)
- Разные уровни детализации (краткая, средняя, подробная)
- Разные формулировки (синонимы, альтернативные структуры)

**Примеры:**
- Вариант 1: "Слышал про John? Вынес тысячу корпоратов."
- Вариант 2: "Говорят, John уничтожил тысячу корпоратов Arasaka."
- Вариант 3: "John? Это тот, кто разгромил тысячу корпоратов в Watson."

**Визуальный стиль:**
- Варианты визуально не отображаются (скрытая механика)
- Результат выглядит разнообразно

### Комбинирование событий

**Лор:**
Несколько событий могут объединяться в одну байку, создавая "легендарные цепочки" событий.

**Механика:**
- Несколько событий объединяются в одну байку (максимум 3 события)
- Создание "легендарных цепочек" (связанные события)
- Эволюция баек со временем (новые события обновляют старые)

**Примеры:**
- Событие 1: убил 1000 корпоратов
- Событие 2: помог 500 новичкам
- Комбинированная байка: "John - тот, кто вынес тысячу корпоратов и помог пятистам новичкам. Настоящая легенда!"

**Визуальный стиль:**
- Комбинирование визуально не отображается (скрытая механика)
- Результат выглядит естественно

### Контекстная адаптация

**Лор:**
Байки адаптируются под контекст: локацию, фракцию, время. Это создаёт ощущение, что NPC действительно знают, о чём говорят.

**Механика:**
- Адаптация под локацию (Watson → упоминание Watson в байке)
- Адаптация под фракцию (Arasaka NPC → упоминание Arasaka)
- Адаптация под время (ночь → таинственный стиль, день → открытый стиль)

**Примеры:**
- Локация Watson: "Слышал про John? Вынес тысячу корпоратов в Watson."
- Фракция Arasaka: "Преступник John уничтожил наших сотрудников."
- Время ночь: "Тень John появляется ночью и исчезает на рассвете."

**Визуальный стиль:**
- Адаптация визуально не отображается (скрытая механика)
- Результат выглядит естественно

## Интеграция с другими системами

### Achievement Service
- Подписка на события новых достижений
- Запрос данных о достижениях игрока

### Social Service
- Получение данных репутации
- Подписка на изменения репутации

### Analytics Service
- Получение статистики действий
- Анализ паттернов поведения

### Inventory Service
- Проверка редких предметов
- Анализ коллекций

### World Service
- Получение контекста локаций
- Интеграция с событиями мира

## Критерии готовности

Концепция готова к передаче Architect когда:
- [x] Детальный лор в стиле Cyberpunk 2077 описан
- [x] Источники данных для генерации детально описаны
- [x] Система шаблонов баек определена
- [x] Алгоритм генерации проработан
- [x] Вариативность и уникальность определена
- [x] Интеграции с игровыми системами описаны

## Следующие шаги

1. Передача концепции Architect для детализации технической реализации
2. Создание OpenAPI спецификаций для API Designer
3. Реализация бекенда для Backend Developer

