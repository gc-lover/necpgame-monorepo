<!-- Issue: #1469 -->
# Система триггеров и контекстной активации баек городских легенд - Концепция

## Обзор

Система триггеров определяет, когда и как NPC должны рассказывать байки про городских легенд, создавая естественный и релевантный игровой опыт. Система анализирует контекст игры и активирует байки в подходящие моменты, предотвращая спам и обеспечивая релевантность контента.

## Лор в мире Cyberpunk 2077

### Контекст городских легенд

В мире NECPGAME информация распространяется быстро, но не мгновенно. NPC живут своей жизнью, общаются друг с другом, делятся слухами и историями. Когда игрок становится легендой, его действия становятся частью городского фольклора, передаваемого из уст в уста.

**Как работают слухи в киберпанк-мире:**
- Информация распространяется через социальные сети NPC
- Бармены, информаторы и фиксёры — основные источники слухов
- Время и расстояние искажают информацию
- Фракции интерпретируют события по-своему
- Важные события распространяются быстрее

**Атмосфера:**
- Ночной город полон слухов и легенд
- NPC обсуждают легендарных игроков в барах
- Информаторы продают истории за деньги
- Корпорации отслеживают опасных игроков
- Уличные банды боятся или уважают легенд

## Типы триггеров

### 1. Пространственные триггеры

**Лор:**
NPC знают легенды, связанные с их локацией. Когда игрок входит в место, где произошло легендарное событие, NPC могут вспомнить историю.

**Механика:**
- Игрок входит в локацию, связанную с легендой
- Система проверяет, знает ли NPC эту легенду
- Если да, NPC может рассказать байку при взаимодействии
- Вероятность активации зависит от релевантности локации

**Примеры:**
- Бар Afterlife → байки про боевые легенды
- Рынок → байки про экономические легенды
- Лаборатория → байки про исследовательские легенды
- Корпоративный офис → байки про конфликты с корпорациями

**Визуальный стиль:**
- Локация с визуальными напоминаниями о легенде (плакаты, граффити, голограммы)
- NPC с особым поведением (смотрят на игрока, перешёптываются)
- Атмосферные эффекты (неоновые огни, дым, голограммы)

### 2. Временные триггеры

**Лор:**
Некоторые легенды актуальны в определённое время. Ночные истории рассказываются ночью, дневные — днём. Специальные события (праздники, корпоративные войны) активируют соответствующие байки.

**Механика:**
- Система проверяет текущее время игры
- Сопоставляет время с релевантными легендами
- Активирует байки, связанные с временным контекстом
- Специальные события имеют приоритет

**Примеры:**
- Ночь → таинственные легенды, истории про тени
- День → открытые истории, публичные события
- Праздники → легенды про праздничные события
- Корпоративные войны → легенды про конфликты

**Визуальный стиль:**
- Временные эффекты (ночь/день, праздничные украшения)
- Изменение атмосферы локаций в зависимости от времени
- Специальные события визуально отображаются в мире

### 3. Событийные триггеры

**Лор:**
Когда происходит событие, связанное с легендой, NPC вспоминают историю. Завершение квеста, достижение статуса, событие мира — всё это может активировать байки.

**Механика:**
- Система отслеживает события игры
- Сопоставляет события с релевантными легендами
- Активирует байки при наступлении события
- Приоритет зависит от важности события

**Примеры:**
- Завершение квеста → байка про похожий квест легенды
- Достижение статуса → байка про получение статуса легендой
- Событие мира → байка про участие легенды в событии
- Изменение репутации → байка про влияние легенды на фракцию

**Визуальный стиль:**
- Визуальные эффекты событий (взрывы, голограммы, дроны)
- Изменение поведения NPC при событиях
- Уведомления и новости о событиях

### 4. Диалоговые триггеры

**Лор:**
Игрок может спросить NPC про легендарного игрока, и NPC расскажет байку, если знает её. Тема разговора также может активировать релевантные байки.

**Механика:**
- Игрок задаёт вопрос про легенду
- Система проверяет, знает ли NPC эту легенду
- Если да, NPC рассказывает байку
- Тема разговора может активировать релевантные байки

**Примеры:**
- "Ты знаешь про {legend_name}?" → байка про легенду
- "Кто может помочь с Arasaka?" → байка про легенду, конфликтовавшую с Arasaka
- "Где найти редкое оружие?" → байка про легенду, нашедшую оружие
- Упоминание имени легенды → байка про легенду

**Визуальный стиль:**
- Диалоговые окна с вариантами вопросов
- Реакции NPC на вопросы (задумчивость, улыбка, страх)
- Визуальные эффекты при рассказе байки (голограммы, проекции)

### 5. Социальные триггеры

**Лор:**
Присутствие легендарного игрока в локации может активировать байки. Другие игроки могут спрашивать про легенду, NPC могут комментировать его присутствие.

**Механика:**
- Система отслеживает присутствие легендарных игроков
- Активирует байки при их появлении
- Другие игроки могут спрашивать про легенду
- NPC могут комментировать присутствие легенды

**Примеры:**
- Легендарный игрок входит в бар → бармен рассказывает байку
- Другие игроки спрашивают про легенду → NPC рассказывает байку
- Легендарный игрок проходит мимо → NPC перешёптываются
- Встреча с легендой → специальные диалоги

**Визуальный стиль:**
- Визуальные эффекты присутствия легенды (аура, голограммы)
- Реакции NPC на присутствие легенды (почтение, страх, зависть)
- Специальные анимации при встрече с легендой

### 6. Комбинированные триггеры

**Лор:**
Сложные ситуации требуют комбинации факторов. Ночь + локация + событие могут активировать особую байку, которая не активируется при отдельных факторах.

**Механика:**
- Система проверяет комбинацию факторов
- Активирует байку только при выполнении всех условий
- Приоритет зависит от сложности комбинации
- Условия могут быть "И" или "ИЛИ"

**Примеры:**
- Ночь + локация Watson + репутация с Arasaka < -50 → байка про конфликт
- День + рынок + экономическое событие → байка про торговлю
- Праздник + бар + социальное событие → байка про празднование
- Событие мира + корпоративный офис + боевая легенда → байка про конфликт

**Визуальный стиль:**
- Комбинация визуальных эффектов от разных факторов
- Уникальные атмосферные эффекты для сложных комбинаций
- Специальные анимации при активации сложных триггеров

## Система приоритетов

### Уровни приоритета

**Критический:**
- Байка активируется немедленно
- Пример: присутствие легендарного игрока в локации
- Нельзя пропустить или отложить

**Высокий:**
- Байка активируется при первом подходящем моменте
- Пример: завершение квеста, связанного с легендой
- Приоритет над другими байками

**Средний:**
- Байка активируется при наличии времени
- Пример: обычное взаимодействие с NPC
- Может быть отложена, если есть более важные байки

**Низкий:**
- Байка активируется в фоновом режиме
- Пример: фоновые разговоры NPC
- Не мешает основному геймплею

### Очередь активации

**Механика:**
- Триггеры с высоким приоритетом обрабатываются первыми
- Ограничение количества активных баек одновременно (макс 2-3)
- Таймауты между активациями (минимум 30 секунд)
- Ротация баек для разнообразия

**Визуальный стиль:**
- Индикаторы приоритета в интерфейсе (опционально)
- Плавные переходы между байками
- Отсутствие визуального спама

## Контекстная релевантность

### Факторы релевантности

**Локация:**
- Байка связана с текущей локацией → +50% релевантность
- Байка связана с соседней локацией → +25% релевантность
- Байка не связана с локацией → 0% релевантность

**Фракция:**
- Байка релевантна фракции NPC → +30% релевантность
- Байка связана с враждебной фракцией → +20% релевантность
- Байка не связана с фракцией → 0% релевантность

**Время:**
- Байка актуальна по времени → +20% релевантность
- Байка устарела → -10% релевантность
- Байка вневременная → 0% релевантность

**События:**
- Байка связана с текущим событием → +40% релевантность
- Байка связана с недавним событием → +20% релевантность
- Байка не связана с событиями → 0% релевантность

### Порог активации

**Механика:**
- Байка активируется только если relevance_score > threshold
- Порог зависит от типа байки (критическая: 50%, обычная: 70%)
- Порог может изменяться динамически (события мира снижают порог)
- Система выбирает байку с наивысшим релевантностью

## Предотвращение спама

### Кулердауны

**Механика:**
- Минимальное время между активациями одной байки: 1 час
- Минимальное время между активациями баек одного игрока: 30 минут
- Минимальное время между активациями одного NPC: 15 минут
- Кулердауны учитывают приоритет (критические байки могут игнорировать кулердауны)

**Визуальный стиль:**
- Отсутствие визуальных индикаторов кулердаунов (скрытая механика)
- Естественное поведение NPC (не рассказывают одну и ту же историю постоянно)

### Лимиты

**Механика:**
- Максимальное количество баек в час на игрока: 5
- Максимальное количество баек в локации одновременно: 3
- Максимальное количество баек от одного NPC в день: 10
- Лимиты учитывают приоритет (критические байки могут игнорировать лимиты)

**Визуальный стиль:**
- Естественное распределение баек во времени
- Отсутствие визуального спама

### Уникальность

**Механика:**
- Одна байка не повторяется в короткий период (минимум 2 часа)
- Приоритет новым байкам над старыми
- Ротация баек для разнообразия
- Система отслеживает, какие байки уже были рассказаны

**Визуальный стиль:**
- Разнообразие баек при повторных взаимодействиях
- Естественное развитие историй со временем

## Условия активации

### Простые условия

**Формат:**
```yaml
trigger:
  type: player_enters_location
  location: "afterlife_bar"
  legend_type: "combat"
```

**Примеры:**
- Игрок входит в локацию → активировать байку про локацию
- Определённое время суток → активировать байку про время
- Присутствие легендарного игрока → активировать байку про игрока

### Сложные условия

**Формат:**
```yaml
trigger:
  type: combined
  conditions:
    - type: player_in_location
      location: "watson_district"
    - type: time_of_day
      range: [20:00, 06:00]
    - type: player_reputation
      faction: "arasaka"
      min: -50
  operator: AND
```

**Примеры:**
- Ночь + локация + репутация → активировать байку про конфликт
- Событие + фракция + время → активировать байку про событие
- Легенда + локация + диалог → активировать байку про легенду

### Условные ветвления

**Механика:**
- Если условие A → активировать байку X
- Если условие B → активировать байку Y
- Если оба условия → активировать байку Z
- Если ни одно условие → не активировать байку

**Примеры:**
- Если игрок-легенда → байка про легенду
- Если обычный игрок → байка про общую легенду
- Если враг фракции → байка про конфликт
- Если союзник фракции → байка про сотрудничество

## Система событий

### Подписка на события

**Механика:**
- Система подписывается на события игры через Event Bus
- События активируют соответствующие триггеры
- Асинхронная обработка событий
- Фильтрация событий по релевантности

**Типы событий:**
- `player.enters_location` - игрок входит в локацию
- `player.completes_quest` - игрок завершает квест
- `player.achieves_legend_status` - игрок становится легендой
- `world.event.occurs` - событие мира
- `npc.interaction.starts` - начало взаимодействия с NPC
- `faction.reputation.changes` - изменение репутации с фракцией

### Обработка событий

**Механика:**
1. Событие поступает в систему
2. Фильтрация по релевантности
3. Проверка условий триггеров
4. Расчёт релевантности баек
5. Выбор байки с наивысшей релевантностью
6. Проверка кулердаунов и лимитов
7. Активация байки

**Визуальный стиль:**
- Плавная обработка событий без задержек
- Естественная активация баек

## Динамическая адаптация

### Адаптация под игрока

**Механика:**
- Разные байки для разных типов игроков (боевые, социальные, экономические)
- Учёт истории взаимодействий (не повторять уже рассказанные байки)
- Персонализация контента (байки про действия игрока)

**Примеры:**
- Боевой игрок → байки про боевые легенды
- Социальный игрок → байки про социальные легенды
- Экономический игрок → байки про экономические легенды

### Адаптация под контекст

**Механика:**
- Байки адаптируются под текущую ситуацию
- Учёт настроения NPC (радость, страх, злость)
- Учёт отношений с игроком (друг, враг, нейтрал)

**Примеры:**
- Радостный NPC → позитивные байки
- Испуганный NPC → страшные байки
- Злой NPC → негативные байки

## Интеграция с игровыми системами

### World Service
- Получение данных о локациях
- Подписка на события мира
- Управление временем игры

### NPC Service
- Интеграция с диалоговой системой
- Управление поведением NPC
- Получение контекста NPC

### Social Service
- Получение данных о репутации
- Подписка на изменения статуса
- Интеграция с системой легенд

### Event Bus
- Подписка на события игры
- Публикация событий активации
- Интеграция с другими системами

## Критерии готовности

Концепция готова к передаче Architect когда:
- [x] Детальный лор в стиле Cyberpunk 2077 описан
- [x] Все типы триггеров детально описаны
- [x] Система приоритетов проработана
- [x] Контекстная релевантность определена
- [x] Механизмы предотвращения спама описаны
- [x] Условия активации проработаны
- [x] Система событий описана
- [x] Динамическая адаптация определена
- [x] Интеграции с игровыми системами описаны

## Следующие шаги

1. Передача концепции Architect для детализации технической реализации
2. Создание OpenAPI спецификаций для API Designer
3. Реализация бекенда для Backend Developer
4. Интеграция с NPC диалоговой системой

