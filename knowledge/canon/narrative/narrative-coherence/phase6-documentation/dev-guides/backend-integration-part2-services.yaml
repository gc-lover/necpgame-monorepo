# Issue: #109
metadata:
  id: canon-backend-integration-part2-services
  title: 'Backend Integration — Part 2: Services'
  document_type: canon
  category: narrative-coherence
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-13T00:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - narrative
    - backend
    - services
  topics:
    - quest-logic
    - world-state
  related_systems:
    - narrative-service
    - world-state-service
  related_documents:
    - id: canon-backend-integration-part1-entities
      relation: precedes
    - id: canon-backend-integration-part3-api
      relation: continues
  source: shared/docs/knowledge/canon/narrative/narrative-coherence/phase6-documentation/dev-guides/backend-integration-part2-services.md
  visibility: internal
  audience:
    - concept
    - narrative
    - backend
  risk_level: medium
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: [ ]
summary:
  problem: Требовалось зафиксировать ключевые сервисы, управляющие доступностью квестов и состоянием мира в narrative backend.
  goal: Описать структуру и ответственность QuestGraphService и WorldStateService для синхронизации с фронтендом и API.
  essence: Документ раскрывает методы загрузки графа квестов, проверки условий, обработки выборов и модификации глобального состояния.
  key_points:
    - QuestGraphService строит граф квестовых зависимостей из JSON и кэширует его в памяти.
    - Сервис проверяет требования квеста по зависимостям, флагам и блокировкам.
    - Методы обработки выбора применяют последствия, обновляют флаги и открывают новые ветки.
    - WorldStateService объединяет личное и глобальное состояние и реализует голосование за изменения.
content:
  sections:
    - id: quest-graph-service
      title: 'QuestGraphService'
      body: |
        При инициализации сервис загружает данные графа зависимостей из JSON и формирует карту узлов для быстрых запросов. Метод isQuestAvailable проверяет наличие квеста, учитывая зависимые задания, обязательные флаги и блокировки. Доступные квесты фильтруются по текущей эпохе и преобразуются в краткие структуры ответа.

        ProcessChoice выполняется в транзакции и обрабатывает последствия выбора: установка флагов, разблокировку и блокировку квестов, а также генерацию результата выбора. Логика рассчитана на расширение новыми видами последствий без изменения сигнатур методов.
      mechanics_links: [ ]
      assets: [ ]
    - id: world-state-service
      title: 'WorldStateService'
      body: |
        Сервис объединяет состояние персонажа, сервера и фракций для формирования актуальной картины мира. Метод getWorldState готовит агрегированный вид, который учитывает приоритеты источников данных.

        CastVote принимает решения игроков, сохраняет голоса, проверяет пороги изменений и применяет обновления состояния. Поддерживается пошаговая обработка, позволяющая добавлять новые правила голосования.
      mechanics_links: [ ]
      assets: [ ]
    - id: extension-points
      title: 'Точки расширения'
      body: |
        Методы checkPrerequisites, checkRequiredFlags и isQuestBlocked могут переопределяться в подклассах или заполняться дополнительной логикой. Граф квестов поддерживает lazy обновление, что позволяет реагировать на изменения данных без перезапуска сервиса.

        В WorldStateService предусмотрен расчёт весов голосов и последующее применение преобразований, поэтому система готова к интеграции с репутационными модификаторами и сезонными событиями.
      mechanics_links: [ ]
      assets: [ ]
appendix:
  glossary: [ ]
  references: [ ]
  decisions: [ ]
implementation:
  github_issue: 109
  needs_task: false
  queue_reference: [ ]
  blockers: [ ]
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: narrative_platform_team
    changes: Консолидировано описание сервисов работы с графом квестов и состоянием мира.
validation:
  checksum: ''
  schema_version: '1.0'

