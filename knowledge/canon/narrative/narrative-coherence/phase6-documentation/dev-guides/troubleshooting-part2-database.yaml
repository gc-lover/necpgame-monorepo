# Issue: #109
metadata:
  id: narrative-coherence-troubleshooting-part2-database
  title: 'Troubleshooting — Part 2: Database & Performance'
  document_type: canon
  category: narrative-coherence
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-07T00:51:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - troubleshooting
    - performance
    - narrative-coherence
  topics:
    - database
    - optimization
  related_systems:
    - narrative-service
    - quest-service
  related_documents:
    - id: narrative-coherence-troubleshooting-part1-common
      relation: references
    - id: narrative-coherence-troubleshooting-part3-advanced
      relation: continues
  source: shared/docs/knowledge/canon/narrative/narrative-coherence/phase6-documentation/dev-guides/troubleshooting-part2-database.md
  visibility: internal
  audience:
    - backend
    - support
  risk_level: medium
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Производительность нарративного сервиса деградирует из‑за отсутствия индексов, кэширования и контроля соединений.
  goal: Предложить механизм оптимизации БД, устранить N+1 и обеспечить стабильное подключение Redis.
  essence: Вторая часть справочника концентрируется на настройке SQL, ORM и кэша для устойчивой работы квестового графа.
  key_points:
    - Индексация ключевых таблиц и использование EntityGraph для веток квестов.
    - Диагностика медленных запросов через EXPLAIN и переход на облегчённые проекции.
    - Проверка доступности Redis и включение уровней кэширования в сервисе.
content:
  sections:
    - id: performance-basics
      title: Оптимизация запросов
      body: |
        Начните с индексов на `quests(era, min_level)` и `player_flags(character_id, flag_key)`. Для устранения N+1 используйте `@EntityGraph(attributePaths = {"branches"})`, чтобы JPA загружал ветки за один запрос.
      mechanics_links:
        - services/backend/database/indexing-guide.yaml
      assets: []
    - id: slow-queries
      title: Диагностика медленных запросов
      body: |
        Запускайте `EXPLAIN ANALYZE` для подозрительных выборок и переходите к лёгким DTO через конструкторские проекции. Это снижает нагрузку на сериализацию и ускоряет выдачу списков квестов.
      mechanics_links:
        - services/backend/common/repository-patterns.yaml
      assets: []
    - id: caching
      title: Кэширование и Redis
      body: |
        Используйте `@Cacheable` для горячих запросов и регулярно проверяйте работоспособность Redis (`redis-cli ping`). При ошибках перезапустите сервер и убедитесь, что сервису доступны переменные подключения.
      mechanics_links:
        - services/backend/infrastructure/cache-management.yaml
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  github_issue: 109
  needs_task: false
  queue_reference: []
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: concept_director
    changes: Конвертирована часть Part 2 руководства Troubleshooting в YAML с фокусом на базе и производительности.
validation:
  checksum: ''
  schema_version: '1.0'

