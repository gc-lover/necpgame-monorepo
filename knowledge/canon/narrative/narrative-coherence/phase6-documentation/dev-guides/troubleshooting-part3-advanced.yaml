# Issue: #109
metadata:
  id: narrative-coherence-troubleshooting-part3-advanced
  title: 'Troubleshooting — Part 3: WebSocket & Advanced'
  document_type: canon
  category: narrative-coherence
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-07T00:52:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - troubleshooting
    - websocket
    - narrative-coherence
  topics:
    - realtime
    - stability
  related_systems:
    - narrative-service
    - quest-service
  related_documents:
    - id: narrative-coherence-troubleshooting-part1-common
      relation: references
    - id: narrative-coherence-troubleshooting-part2-database
      relation: references
  source: shared/docs/knowledge/canon/narrative/narrative-coherence/phase6-documentation/dev-guides/troubleshooting-part3-advanced.md
  visibility: internal
  audience:
    - backend
    - support
    - platform
  risk_level: medium
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: [ ]
summary:
  problem: После настройки базы и сервисов остаются комплексные ошибки WebSocket, утечки памяти и потребность в экстренных процедурах.
  goal: Предоставить инструкции по настройке CORS и топиков, ограничению ресурсов и оперативным действиям при сбоях.
  essence: Заключительная часть справочника описывает устойчивость реального времени и набор инструментов для оперативного реагирования.
  key_points:
    - Настройка WebSocket эндпоинтов и broadcast топиков.
    - Контроль кэша, сессий и логирования для предотвращения утечек.
    - Чеклист быстрых действий: роллбек миграций и очистка Redis.
content:
  sections:
    - id: websocket
      title: WebSocket не подключается
      body: |
        Проверьте CORS и эндпоинт `/ws/narrative`, разрешив домен клиента. Убедитесь, что сообщения отправляются в корректный topic `/topic/server/{serverId}/world-state` для подписчиков.
      mechanics_links:
        - services/backend/narrative/realtime-config.yaml
      assets: [ ]
    - id: memory
      title: Утечки памяти
      body: |
        Включите ограничение кэша через `@Cacheable(..., unless = "#result == null")` и настройте тайм-аут сессии (`spring.session.timeout: 30m`). Это предотвращает накопление устаревших данных.
      mechanics_links:
        - services/backend/infrastructure/cache-management.yaml
      assets: [ ]
    - id: debugging
      title: Инструменты отладки
      body: |
        Активируйте SQL-логирование (`logging.level.org.hibernate.SQL: DEBUG`) и используйте `redis-cli monitor` для отслеживания активности кэша. Эти инструменты помогают локализовать узкие места.
      mechanics_links:
        - services/backend/tooling/debugging-kit.yaml
      assets: [ ]
    - id: emergency
      title: Экстренные действия
      body: |
        Для критических случаев подготовьте rollback-скрипты миграций и сценарии очистки Redis (`redis-cli FLUSHDB`). Выполняйте операции согласно регламенту, фиксируя последствия в журнале инцидентов.
      mechanics_links:
        - mechanics/process/backend-readiness-checklist.yaml
      assets: [ ]
appendix:
  glossary: [ ]
  references: [ ]
  decisions: [ ]
implementation:
  github_issue: 109
  needs_task: false
  queue_reference: [ ]
  blockers: [ ]
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: concept_director
    changes: Конвертирована часть Part 3 руководства Troubleshooting в YAML с акцентом на WebSocket и аварийные процедуры.
validation:
  checksum: ''
  schema_version: '1.0'

