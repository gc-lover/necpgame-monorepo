# Issue: #142072496 - [Idea] Система триггеров и контекстной активации баек
metadata:
  id: urban-legends-trigger-system
  title: Система триггеров и контекстной активации баек
  document_type: idea
  category: mechanics
  status: approved
  version: '1.1.0'
  last_updated: 2025-12-28T22:40:00Z
  concept_approved: true
  concept_reviewed_at: '2025-12-28T22:40:00Z'
  owners:
    - role: content_designer
      contact: content@necp.game
  tags:
    - urban-legends
    - contextual-storytelling
    - dynamic-triggers
    - player-immersion
    - procedural-narrative
  topics:
    - interactive-narrative
    - contextual-systems
    - player-agency
    - world-reactivity
  related_systems:
    - narrative-service
    - event-service
    - player-tracking-service
  related_documents:
    - id: urban-legends-npc-integration
      relation: complements
      path: knowledge/idea/urban-legends-npc-integration.yaml
    - id: urban-legends-template-system
      relation: uses
      path: knowledge/idea/urban-legends-template-system.yaml
    - id: urban-legends-spreading
      relation: integrates
      path: knowledge/idea/urban-legends-spreading-system.yaml
  source: ''
  visibility: internal
  audience:
    - concept
    - content
    - gameplay
    - technical
  risk_level: medium

review:
  chain:
    - role: content_designer
      reviewer: 'Content Design Team'
      reviewed_at: 2025-12-28T22:40:00Z
      status: approved
  next_actions: []

summary:
  problem: Городские легенды должны активироваться в подходящих контекстах - в нужное время, в нужном месте, для нужных игроков, создавая органичные и иммерсивные нарративы.
  solution: Создать многоуровневую систему триггеров, которая анализирует контекст (действия игрока, окружение, время, социальные факторы) и активирует соответствующие легенды с подходящей интенсивностью.
  impact: Превращает пассивные истории в интерактивные переживания, повышает эмоциональную вовлеченность игроков и создает персонализированные нарративы.
  benefits:
    - Contextual storytelling адаптирующийся к игроку
    - Emergent narratives из комбинации триггеров
    - Emotional engagement через timely storytelling
    - Replayability через разные контекстуальные активации

trigger_types:
  spatial_triggers:
    description: Триггеры, связанные с местоположением
    categories:
      - **Location-based**: активация при посещении конкретного места
      - **Proximity-based**: активация при приближении к определенным объектам
      - **Zone-based**: активация при входе в зоны влияния
      - **Environmental**: активация на основе условий окружающей среды

    examples:
      - **Haunted building**: легенда о призраке активируется при входе в заброшенное здание
      - **Crime scene**: история о преступлении всплывает при посещении места происшествия
      - **Faction territory**: легенды фракции активируются в их контролируемых зонах
      - **Weather-dependent**: разные легенды в дождь vs солнечную погоду

  temporal_triggers:
    description: Триггеры, связанные со временем
    categories:
      - **Time-of-day**: активация в определенное время суток
      - **Seasonal**: активация в определенные сезоны
      - **Event-based**: активация во время глобальных событий
      - **Historical**: активация в anniversary событий

    examples:
      - **Midnight stories**: страшные легенды активируются после полуночи
      - **Festival legends**: праздничные истории во время фестивалей
      - **Anniversary tales**: легенды о прошлых событиях в их годовщины
      - **Eclipse myths**: специальные легенды во время солнечных затмений

  behavioral_triggers:
    description: Триггеры, связанные с действиями игрока
    categories:
      - **Action-based**: активация после определенных действий
      - **Skill-based**: активация при использовании определенных навыков
      - **Quest-based**: активация во время выполнения квестов
      - **Social-based**: активация в социальных взаимодействиях

    examples:
      - **Hacking trigger**: легенда о хакерском инциденте при взломе терминала
      - **Combat trigger**: история о бойце активируется после победы в драке
      - **Trading trigger**: легенда о мошенничестве при подозрительной сделке
      - **Romance trigger**: история любви активируется в романтических ситуациях

  contextual_triggers:
    description: Триггеры, связанные с общим контекстом
    categories:
      - **Emotional state**: активация на основе эмоций игрока
      - **Social context**: активация в присутствии определенных NPC
      - **Economic context**: активация при определенных рыночных условиях
      - **Faction relations**: активация на основе отношений с фракциями

    examples:
      - **Fear trigger**: страшные легенды когда игрок напуган
      - **Trust trigger**: доверительные истории от NPC с высокой репутацией
      - **Market crash**: легенды о финансовых кризисах во время рыночных падений
      - **War trigger**: военные истории во время конфликтов фракций

trigger_activation_system:
  trigger_engine:
    description: Двигатель активации триггеров
    components:
      - **Context analyzer**: анализ текущего контекста игрока
      - **Trigger matcher**: поиск подходящих триггеров
      - **Priority resolver**: разрешение конфликтов приоритетов
      - **Activation scheduler**: планирование активации легенд

    processing_pipeline:
      1. **Context collection**: сбор данных о текущем состоянии
      2. **Trigger evaluation**: оценка всех потенциальных триггеров
      3. **Relevance scoring**: расчет релевантности для игрока
      4. **Activation decision**: принятие решения об активации

  activation_intensity:
    description: Уровни интенсивности активации
    levels:
      - **Subtle**: косвенные упоминания в разговорах NPC
      - **Moderate**: прямые отсылки к легенде
      - **Intense**: детальный рассказ легенды
      - **Immersive**: интерактивное переживание легенды

    intensity_factors:
      - **Player engagement**: уровень вовлеченности игрока
      - **Legend relevance**: релевантность легенды для контекста
      - **Emotional impact**: эмоциональное воздействие на игрока
      - **Narrative importance**: важность для общего сюжета

  cooldown_system:
    description: Система кулдаунов для предотвращения спама
    mechanics:
      - **Trigger cooldowns**: задержки между активациями одного триггера
      - **Legend cooldowns**: паузы между рассказами одной легенды
      - **Context cooldowns**: задержки для похожих контекстов
      - **Player fatigue**: предотвращение перегрузки информацией

    adaptive_cooldowns:
      - **Dynamic adjustment**: адаптация под поведением игрока
      - **Context awareness**: учет контекста при расчете кулдаунов
      - **Importance scaling**: важные легенды имеют меньшие кулдауны
      - **Player preferences**: персонализация на основе предпочтений

context_analysis_engine:
  player_state_tracking:
    description: Отслеживание состояния игрока
    tracked_elements:
      - **Location history**: недавние посещенные места
      - **Action patterns**: повторяющиеся действия и привычки
      - **Emotional state**: текущие эмоции и настроение
      - **Social connections**: отношения с NPC и фракциями

    state_inference:
      - **Behavior clustering**: группировка похожих действий
      - **Pattern recognition**: распознавание паттернов поведения
      - **Context prediction**: предсказание будущих действий
      - **Preference learning**: изучение предпочтений игрока

  environmental_context:
    description: Анализ окружающего контекста
    factors:
      - **Physical environment**: характеристики места действия
      - **Social environment**: присутствующие NPC и их состояния
      - **Economic environment**: текущие рыночные условия
      - **Political environment**: отношения между фракциями

    dynamic_updates:
      - **Real-time monitoring**: постоянный мониторинг изменений
      - **Event correlation**: связь с глобальными событиями
      - **Weather integration**: влияние погоды на контекст
      - **Time progression**: изменения со временем

  narrative_context:
    description: Нарративный контекст и история
    elements:
      - **Active quests**: текущие задания игрока
      - **Known legends**: уже услышанные истории
      - **Character development**: прогресс персонажа
      - **World state**: текущее состояние мира игры

    context_integration:
      - **Quest synergy**: интеграция с активными квестами
      - **Lore connections**: связи с существующим лором
      - **Character arcs**: влияние на развитие персонажа
      - **World building**: вклад в построение мира

personalization_system:
  player_profile_analysis:
    description: Анализ профиля игрока
    profile_elements:
      - **Playstyle preferences**: предпочитаемые стили игры
      - **Emotional responses**: реакции на разные типы контента
      - **Knowledge level**: familiarity с миром игры
      - **Social preferences**: предпочтения в социальных взаимодействиях

    adaptive_personalization:
      - **Content filtering**: фильтрация контента по предпочтениям
      - **Intensity adjustment**: адаптация интенсивности под игрока
      - **Pacing control**: контроль темпа подачи информации
      - **Trigger sensitivity**: чувствительность к триггерам

  dynamic_difficulty:
    description: Динамическая сложность нарративов
    mechanics:
      - **Emotional intensity**: адаптация эмоционального воздействия
      - **Complexity scaling**: сложность историй под опыт игрока
      - **Trigger frequency**: частота активации триггеров
      - **Context depth**: глубина контекстуальной информации

    player_adaptation:
      - **Learning curve**: постепенное усложнение
      - **Challenge balancing**: баланс между вызовом и комфортом
      - **Engagement optimization**: оптимизация вовлеченности
      - **Retention focus**: удержание внимания игрока

multi_layer_triggering:
  primary_triggers:
    description: Основные триггеры первого уровня
    characteristics:
      - **Direct activation**: прямое срабатывание по условиям
      - **High priority**: высокий приоритет активации
      - **Immediate response**: быстрая реакция системы
      - **Clear conditions**: четкие условия срабатывания

    examples:
      - **Location entry**: вход в конкретное здание
      - **Time milestone**: достижение определенного времени
      - **Action completion**: завершение конкретного действия
      - **Event occurrence**: наступление глобального события

  secondary_triggers:
    description: Вторичные триггеры поддержки
    characteristics:
      - **Contextual enhancement**: усиление первичных триггеров
      - **Background activation**: работа в фоне
      - **Subtle influence**: косвенное влияние на контент
      - **Conditional activation**: активация при определенных условиях

    examples:
      - **Mood amplification**: усиление историй под настроение
      - **Social reinforcement**: поддержка через NPC взаимодействия
      - **Environmental cues**: подсказки через окружение
      - **Narrative foreshadowing**: намеки на будущие события

  emergent_triggers:
    description: Эмерджентные триггеры из комбинаций
    characteristics:
      - **Combination-based**: активация через комбинации факторов
      - **Unpredictable**: неожиданные срабатывания
      - **Dynamic creation**: создание новых триггеров на лету
      - **Player-driven**: зависят от действий игрока

    examples:
      - **Pattern recognition**: триггеры из паттернов поведения
      - **Social chain reactions**: цепные реакции в социальных сетях
      - **Contextual synthesis**: синтез из множественных контекстов
      - **Narrative convergence**: слияние нескольких сюжетных линий

trigger_conflict_resolution:
  priority_system:
    description: Система приоритетов триггеров
    priority_levels:
      - **Critical**: системные триггеры (безопасность, важные события)
      - **High**: сюжетно важные триггеры
      - **Medium**: контекстуально релевантные триггеры
      - **Low**: вспомогательные триггеры

    priority_factors:
      - **Narrative importance**: значимость для сюжета
      - **Player impact**: влияние на игровой опыт
      - **Timeliness**: urgency активации
      - **Context relevance**: релевантность текущему контексту

  conflict_resolution:
    description: Разрешение конфликтов между триггерами
    strategies:
      - **Priority-based**: выбор по приоритету
      - **Context-based**: выбор по релевантности контекста
      - **Alternation**: чередование конкурирующих триггеров
      - **Combination**: объединение нескольких триггеров

    resolution_rules:
      - **Dominance**: один триггер доминирует над другими
      - **Coexistence**: несколько триггеров могут сосуществовать
      - **Suppression**: слабые триггеры подавляются сильными
      - **Fusion**: слияние конфликтующих триггеров

performance_optimization:
  trigger_caching:
    description: Кеширование триггеров для производительности
    techniques:
      - **Spatial indexing**: индексация триггеров по местоположению
      - **Temporal scheduling**: планирование по времени
      - **Context hashing**: хеширование контекстных состояний
      - **Result caching**: кеширование результатов оценки

    cache_invalidation:
      - **Event-driven**: инвалидация при изменениях
      - **Time-based**: периодическая очистка кеша
      - **Size-based**: очистка при превышении размера
      - **Priority-based**: сохранение важных результатов

  efficient_evaluation:
    description: Эффективная оценка триггеров
    optimizations:
      - **Lazy evaluation**: отложенная оценка неактивных триггеров
      - **Batch processing**: пакетная обработка множественных триггеров
      - **Parallel computation**: параллельные вычисления
      - **Approximation algorithms**: аппроксимация для сложных оценок

    computational_limits:
      - **Evaluation budget**: ограничение на время оценки
      - **Concurrent triggers**: максимум одновременно активных триггеров
      - **Memory constraints**: ограничения на использование памяти
      - **CPU limits**: ограничения на использование процессора

integration_interfaces:
  narrative_service_integration:
    description: Интеграция с narrative service
    interfaces:
      - **Legend retrieval**: получение подходящих легенд
      - **Context sharing**: обмен контекстной информацией
      - **Trigger coordination**: координация активации триггеров
      - **Story state sync**: синхронизация состояния историй

    data_flow:
      - **Context input**: входящий поток контекстных данных
      - **Trigger output**: исходящий поток активных триггеров
      - **Legend delivery**: доставка выбранных легенд
      - **Feedback loop**: обратная связь для улучшения

  event_service_integration:
    description: Интеграция с event service
    interfaces:
      - **Event subscription**: подписка на игровые события
      - **Trigger registration**: регистрация триггеров событий
      - **Event correlation**: корреляция событий с триггерами
      - **State synchronization**: синхронизация состояний

    event_types:
      - **Player events**: события связанные с игроком
      - **World events**: глобальные события мира
      - **NPC events**: события связанные с NPC
      - **System events**: технические события системы

  player_tracking_integration:
    description: Интеграция с player tracking service
    interfaces:
      - **Behavior tracking**: отслеживание поведения игрока
      - **Preference learning**: изучение предпочтений
      - **Context monitoring**: мониторинг контекста игрока
      - **Engagement metrics**: метрики вовлеченности

    tracking_data:
      - **Action sequences**: последовательности действий
      - **Location history**: история перемещений
      - **Interaction patterns**: паттерны взаимодействий
      - **Response analytics**: аналитика реакций

quality_assurance:
  trigger_testing:
    description: Тестирование триггеров
    methodologies:
      - **Unit testing**: тестирование отдельных триггеров
      - **Integration testing**: тестирование взаимодействия
      - **Scenario testing**: тестирование в игровых сценариях
      - **Performance testing**: тестирование производительности

    test_coverage:
      - **Edge cases**: граничные условия и исключения
      - **Load testing**: тестирование под высокой нагрузкой
      - **Compatibility testing**: тестирование совместимости
      - **Regression testing**: тестирование на регрессии

  balance_verification:
    description: Проверка баланса системы
    metrics:
      - **Trigger frequency**: частота срабатывания триггеров
      - **Content diversity**: разнообразие активируемого контента
      - **Player experience**: качество опыта игрока
      - **Narrative coherence**: связность нарративов

    balance_adjustments:
      - **Frequency tuning**: настройка частоты активации
      - **Intensity scaling**: масштабирование интенсивности
      - **Context weighting**: взвешивание контекстных факторов
      - **Cooldown optimization**: оптимизация кулдаунов

example_implementations:
  haunted_building_scenario:
    description: Сценарий с призраком в здании
    trigger_sequence:
      1. **Spatial trigger**: вход в заброшенное здание
      2. **Time trigger**: активация после наступления темноты
      3. **Behavioral trigger**: усиление при исследовании подвала
      4. **Contextual trigger**: финальная легенда при обнаружении улик

    activation_flow:
      - **Initial whisper**: тихий шепот в пустых коридорах
      - **Building tension**: постепенное нарастание напряжения
      - **Climactic reveal**: кульминация с рассказом полной легенды
      - **Resolution**: разрешение через действия игрока

  social_chain_reaction:
    description: Цепная реакция в социальной сети
    trigger_cascade:
      1. **Primary trigger**: игрок становится свидетелем события
      2. **Secondary triggers**: NPC обсуждают событие в баре
      3. **Emergent triggers**: легенда распространяется по городу
      4. **Global impact**: влияние на экономику и политику

    propagation_effects:
      - **Economic changes**: изменения цен на товары
      - **Social shifts**: изменения в отношениях фракций
      - **Quest generation**: появление новых заданий
      - **Player reputation**: изменение репутации игрока

technical_architecture:
  trigger_database:
    description: База данных триггеров
    structure:
      - **Trigger definitions**: определения триггеров и условий
      - **Context templates**: шаблоны контекстных состояний
      - **Activation rules**: правила активации и приоритетов
      - **Performance metadata**: метаданные для оптимизации

    indexing_strategy:
      - **Spatial indexing**: индексы для пространственных триггеров
      - **Temporal indexing**: индексы для временных триггеров
      - **Behavioral indexing**: индексы для поведенческих триггеров
      - **Composite indexing**: составные индексы для комплексных условий

  real_time_processing:
    description: Обработка в реальном времени
    requirements:
      - **Low latency**: минимальная задержка активации
      - **High throughput**: обработка множества триггеров
      - **Scalable architecture**: масштабируемая архитектура
      - **Fault tolerance**: устойчивость к сбоям

    processing_pipeline:
      - **Event ingestion**: прием входящих событий
      - **Context enrichment**: обогащение контекстными данными
      - **Trigger matching**: сопоставление с триггерами
      - **Activation dispatch**: диспетчеризация активации

future_enhancements:
  ai_driven_adaptation:
    description: AI-управляемая адаптация
    features:
      - **Predictive triggering**: предсказание оптимальных моментов активации
      - **Emotional modeling**: моделирование эмоционального состояния игрока
      - **Personalized narratives**: персонализированные нарративы
      - **Adaptive difficulty**: адаптивная сложность историй

  cross_session_persistence:
    description: Персистентность между сессиями
    features:
      - **Long-term memory**: сохранение контекста между сессиями
      - **Progressive storytelling**: постепенное развитие историй
      - **Character continuity**: непрерывность персонажей
      - **World evolution**: эволюция мира со временем

  multi_modal_integration:
    description: Мультимодальная интеграция
    features:
      - **Audio triggers**: активация через звуковые cues
      - **Visual triggers**: активация через визуальные элементы
      - **Tactile feedback**: тактильные триггеры
      - **Olfactory integration**: интеграция запахов

history:
  - version: '1.0.0'
    date: 2025-12-28
    author: content_designer
    changes: Создан первоначальный документ системы триггеров городских легенд
  - version: '1.1.0'
    date: 2025-12-28
    author: content_designer
    changes: Расширена система с технической архитектурой, QA и планами развития.

validation:
  checksum: ''
  schema_version: '1.0'
