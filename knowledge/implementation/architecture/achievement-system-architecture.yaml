# Issue: #143577148
# Achievement System Architecture
# Спроектировано Architect агентом

version: "1.0.0"
last_updated: "2025-12-13"
author: "Architect Agent"

metadata:
  system_name: "Achievement System"
  description: "Система достижений для отслеживания прогресса игроков, награждения и мотивации"
  domain: "Gameplay"
  criticality: "High"
  performance_requirements:
    peak_load: "5k req/sec"
    concurrent_users: "50k"
    p99_latency: "<100ms"
    data_retention: "indefinite"

architecture_overview:
  purpose: |
    Achievement System предоставляет комплексную систему достижений для мотивации игроков,
    отслеживания прогресса и награждения за различные действия в игре.

  key_features:
    - Категории достижений (Combat, Social, Economy, Exploration, Special)
    - Прогрессивные достижения с уровнями сложности
    - Тайм-лимитные достижения
    - Скрытые достижения
    - Коллекционные достижения
    - Сезонные достижения
    - Гильдейские достижения

  business_value:
    - Увеличение вовлеченности игроков
    - Рост retention через систему наград
    - Социальная конкуренция через лидерборды
    - Монетизация через косметические награды

components:
  achievement_manager:
    description: "Управление каталогом достижений"
    responsibilities:
      - CRUD операции с достижениями
      - Валидация условий достижений
      - Управление категориями и тегами
      - Версионирование достижений
    interfaces:
      - REST API: /achievement/admin/*
      - Internal: AchievementCatalog interface
    dependencies:
      - Database: achievement_definitions table

  progress_tracker:
    description: "Отслеживание прогресса игроков"
    responsibilities:
      - Мониторинг действий игроков
      - Расчет прогресса по достижениям
      - Определение выполненных условий
      - Кэширование промежуточных результатов
    interfaces:
      - Event Bus: achievement:progress-update
      - Internal: ProgressCalculator interface
    dependencies:
      - Event Bus для получения событий
      - Redis для кэширования прогресса
      - Database: player_achievement_progress

  reward_distributor:
    description: "Распределение наград за достижения"
    responsibilities:
      - Выдача наград при выполнении достижений
      - Уведомление игроков
      - Интеграция с инвентарем и экономикой
      - Откат наград при необходимости
    interfaces:
      - Event Bus: achievement:completed
      - Internal: RewardService interface
    dependencies:
      - Economy Service для валюты
      - Inventory Service для предметов
      - Notification Service для оповещений

  achievement_validator:
    description: "Валидация достижений и защита от читов"
    responsibilities:
      - Проверка корректности прогресса
      - Анти-чит валидация
      - Аудит достижений
      - Блокировка подозрительных действий
    interfaces:
      - Internal: AchievementValidator interface
    dependencies:
      - Security Service для проверки сессий
      - Analytics для паттернов поведения

  event_handler:
    description: "Обработка событий и интеграция с другими системами"
    responsibilities:
      - Прослушивание игровых событий
      - Маршрутизация событий к компонентам
      - Агрегация событий для сложных достижений
      - Отправка уведомлений о прогрессе
    interfaces:
      - Event Bus: all achievement:* events
      - WebSocket: real-time progress updates
    dependencies:
      - Event Bus для коммуникации
      - Realtime Gateway для уведомлений

data_model:
  tables:
    achievement_definitions:
      description: "Определения достижений"
      fields:
        id: "BIGINT PRIMARY KEY"
        code: "VARCHAR(50) UNIQUE NOT NULL"
        title: "JSONB NOT NULL" # мультиязычный
        description: "JSONB NOT NULL"
        category: "VARCHAR(20) NOT NULL"
        difficulty: "VARCHAR(10) NOT NULL" # EASY, MEDIUM, HARD, LEGENDARY
        is_hidden: "BOOLEAN DEFAULT FALSE"
        is_repeatable: "BOOLEAN DEFAULT FALSE"
        max_progress: "INTEGER NOT NULL"
        conditions: "JSONB NOT NULL" # условия выполнения
        rewards: "JSONB NOT NULL" # награды
        prerequisites: "JSONB" # предварительные условия
        created_at: "TIMESTAMP NOT NULL"
        updated_at: "TIMESTAMP NOT NULL"
        is_active: "BOOLEAN DEFAULT TRUE"

    player_achievements:
      description: "Достижения игроков"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        achievement_id: "BIGINT NOT NULL"
        status: "VARCHAR(20) NOT NULL" # LOCKED, IN_PROGRESS, COMPLETED
        unlocked_at: "TIMESTAMP"
        completed_at: "TIMESTAMP"
        claimed_at: "TIMESTAMP"
        created_at: "TIMESTAMP NOT NULL"
        updated_at: "TIMESTAMP NOT NULL"
      indexes:
        - "player_id, achievement_id (UNIQUE)"
        - "player_id, status"
        - "achievement_id, status"
      partitioning: "RANGE (created_at)" # месячная партиция

    achievement_progress:
      description: "Прогресс по достижениям"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        achievement_id: "BIGINT NOT NULL"
        current_progress: "INTEGER NOT NULL DEFAULT 0"
        last_updated: "TIMESTAMP NOT NULL"
        metadata: "JSONB" # дополнительные данные прогресса
      indexes:
        - "player_id, achievement_id (UNIQUE)"
        - "achievement_id, current_progress"
      partitioning: "RANGE (last_updated)" # месячная партиция

    achievement_rewards:
      description: "История выдачи наград"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        achievement_id: "BIGINT NOT NULL"
        reward_type: "VARCHAR(20) NOT NULL" # CURRENCY, ITEM, TITLE, COSMETIC
        reward_id: "VARCHAR(100)" # ID предмета/валюты
        quantity: "INTEGER"
        claimed_at: "TIMESTAMP NOT NULL"
        transaction_id: "VARCHAR(100)" # для отката
      indexes:
        - "player_id, achievement_id"
        - "claimed_at"
      partitioning: "RANGE (claimed_at)" # месячная партиция

  caching_strategy:
    redis_keys:
      - "achievement:player:{player_id}:progress" # прогресс игрока
      - "achievement:player:{player_id}:completed" # завершенные достижения
      - "achievement:definition:{id}" # определение достижения
      - "achievement:category:{category}:active" # активные достижения категории
    ttl:
      progress: "1h"
      completed: "24h"
      definitions: "7d"
      categories: "1h"

api_endpoints:
  management:
    - "GET /achievement/admin/list" # список достижений
    - "POST /achievement/admin/create" # создать достижение
    - "PUT /achievement/admin/{id}" # обновить достижение
    - "DELETE /achievement/admin/{id}" # удалить достижение

  player:
    - "GET /achievement/player/progress" # прогресс игрока
    - "GET /achievement/player/completed" # завершенные достижения
    - "GET /achievement/player/available" # доступные достижения
    - "POST /achievement/player/{id}/claim" # получить награду

  public:
    - "GET /achievement/catalog" # каталог достижений
    - "GET /achievement/leaderboard" # лидерборд по достижениям
    - "GET /achievement/stats/global" # глобальная статистика

  real_time:
    - "WS /achievement/progress" # обновления прогресса

event_driven_architecture:
  published_events:
    - "achievement:unlocked" # достижение разблокировано
    - "achievement:progress-updated" # прогресс обновлен
    - "achievement:completed" # достижение выполнено
    - "achievement:reward-claimed" # награда получена
    - "achievement:condition-met" # условие выполнено

  subscribed_events:
    - "combat:enemy-killed" # враг убит
    - "quest:completed" # квест завершен
    - "item:crafted" # предмет создан
    - "player:level-up" # уровень повышен
    - "social:friend-added" # друг добавлен
    - "economy:transaction-completed" # транзакция завершена

integrations:
  character_service:
    purpose: "Получение данных о персонаже"
    endpoints:
      - "GET /character/{id}/stats"
      - "GET /character/{id}/inventory"
    events:
      - "character:level-up"
      - "character:class-changed"

  economy_service:
    purpose: "Выдача валюты и предметов"
    endpoints:
      - "POST /economy/reward"
      - "POST /economy/item/grant"
    events:
      - "economy:transaction-completed"

  notification_service:
    purpose: "Уведомления игроков"
    endpoints:
      - "POST /notification/send"
    events:
      - "notification:delivered"

  realtime_gateway:
    purpose: "Real-time обновления"
    endpoints:
      - "POST /realtime/broadcast"
      - "POST /realtime/personal/{player_id}"

performance_optimizations:
  level_1_basics:
    - Context timeouts для всех вызовов
    - DB connection pool (25-50 connections)
    - Structured logging
    - Health/Metrics endpoints

  level_2_hot_path:
    - Redis caching для прогресса
    - Batch updates для прогресса
    - Event-driven updates
    - Zero allocation targets

  level_3_gaming:
    - Spatial partitioning для гео-достижений
    - Adaptive caching
    - Predictive loading

data_consistency:
  patterns:
    event_sourcing:
      description: "Все изменения прогресса через events"
      implementation: "Outbox pattern для гарантированной доставки"
    cqrs:
      description: "Разделение чтения и записи"
      read_model: "Материализованные view для статистики"
    saga:
      description: "Распределенные транзакции для наград"
      compensation: "Откат наград при ошибках"

  sync_mechanisms:
    - Eventual consistency через events
    - Immediate consistency для критичных операций
    - Conflict resolution для concurrent updates

scaling_strategy:
  horizontal_scaling:
    - Stateless services
    - Shared Redis cache
    - Event-driven communication
    - Database read replicas

  data_partitioning:
    - Player-based sharding
    - Time-based partitioning для истории
    - Category-based grouping

  load_distribution:
    - CDN для статических данных достижений
    - Regional caches для популярных достижений
    - Background processing для тяжелых расчетов

monitoring_and_observability:
  metrics:
    - achievement_completion_rate
    - average_progression_time
    - reward_distribution_success_rate
    - cache_hit_ratio
    - event_processing_latency

  alerts:
    - High error rates in reward distribution
    - Stale progress data
    - Event processing backlog

  logging:
    - Structured logs for all operations
    - Audit trail for reward distributions
    - Performance profiling for slow queries

migration_plan:
  current_state: "No achievement system"
  target_state: "Full achievement system with 100+ achievements"

  phases:
    phase_1: "Core infrastructure (2 weeks)"
    phase_2: "Basic achievements (3 weeks)"
    phase_3: "Advanced features (4 weeks)"
    phase_4: "Optimization and scaling (2 weeks)"

  dependencies:
    - Database schema ready
    - Event bus configured
    - Notification system ready
    - Economy system integrated

testing_strategy:
  unit_tests:
    - Component isolation
    - Business logic validation
    - Error handling

  integration_tests:
    - End-to-end achievement flows
    - Cross-service communication
    - Data consistency

  performance_tests:
    - Load testing (5000 RPS)
    - Stress testing
    - Memory leak detection

  security_tests:
    - Achievement farming prevention
    - Data integrity validation
    - Rate limiting

change_history:
  - version: "1.0.0"
    date: "2025-12-13"
    changes:
      - Initial architecture design
      - Component specification
      - API design
      - Data model definition
      - Integration planning
