# Issue: #138

metadata:
  id: architecture-achievement-system
  title: "Achievement System Architecture"
  document_type: architecture
  category: implementation
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-02T18:26:00Z
  owners:
    - role: architect
  tags:
    - achievements
    - event-driven
    - architecture
  related_systems:
    - achievement-service
    - notification-service
    - mail-service
    - all-game-services
  related_documents:
    - id: achievement-system
      relation: implements

summary:
  problem: "Необходима event-driven архитектура достижений."
  goal: "Спроектировать систему достижений с мотивацией игроков."
  essence: "Event-driven платформа для отслеживания прогресса."

content:
  sections:
    - id: system-overview
      title: "Обзор"
      body: |
        Achievement System:
        - Отслеживание прогресса по всем механикам
        - Event-driven updates
        - Награды (валюта, предметы, титулы)
        - Категории достижений (8 типов)
        - Типы: Standard, Progressive, Repeatable
        - Интеграция со всеми сервисами

    - id: components
      title: "Компоненты"
      body: |
        ## achievement-service
        **Port:** 8086
        **API:** `/api/v1/world/achievements/*`
        
        Компоненты:
        - AchievementTracker - отслеживание прогресса
        - RewardDistributor - выдача наград
        - EventProcessor - обработка событий
        - TitleManager - управление титулами

        ## Интеграции
        - **All Services:** Подписка на события
        - **Notification Service:** Уведомления об unlock
        - **Mail Service:** Отправка наград

    - id: api-endpoints
      title: "API Endpoints"
      body: |
        GET /api/v1/world/achievements
        - Все достижения
        - Query: category, type
        - Response: Array of achievements

        GET /api/v1/world/achievements/{id}
        - Детали достижения
        - Response: Achievement details

        GET /api/v1/players/{playerId}/achievements
        - Прогресс игрока
        - Response: Player progress

        POST /api/v1/players/{playerId}/achievements/{id}/claim
        - Забрать награду
        - Response: Rewards

        GET /api/v1/players/{playerId}/titles
        - Титулы игрока
        - Response: Array of titles

        PUT /api/v1/players/{playerId}/titles/active
        - Установить активный титул
        - Request: title_id

    - id: database
      title: "База данных"
      body: |
        ## achievement_definitions
        ```sql
        CREATE TABLE achievement_definitions (
          id UUID PRIMARY KEY,
          name VARCHAR(200),
          description TEXT,
          category VARCHAR(50),
          type VARCHAR(20),
          criteria JSONB,
          rewards JSONB,
          icon VARCHAR(200),
          rarity VARCHAR(20)
        );
        ```

        ## player_achievement_progress
        ```sql
        CREATE TABLE player_achievement_progress (
          player_id UUID,
          achievement_id UUID,
          progress INT,
          max_progress INT,
          unlocked BOOLEAN,
          unlocked_at TIMESTAMP,
          claimed BOOLEAN,
          claimed_at TIMESTAMP,
          PRIMARY KEY (player_id, achievement_id)
        );
        ```

        ## player_titles
        ```sql
        CREATE TABLE player_titles (
          player_id UUID,
          title_id UUID,
          unlocked_at TIMESTAMP,
          PRIMARY KEY (player_id, title_id)
        );
        ```

    - id: event-driven
      title: "Event-Driven Architecture"
      body: |
        ## Subscribed Events

        - combat.* (урон, убийства, победы)
        - quest.* (завершение, прогресс)
        - economy.* (торговля, покупки)
        - social.* (друзья, гильдии)
        - character.* (уровень, навыки)
        - exploration.* (локации, открытия)

        ## Published Events

        - achievement.progress_updated
        - achievement.unlocked
        - achievement.claimed

        ## Event Processing

        1. Receive event from Kafka
        2. Find relevant achievements
        3. Update player progress
        4. Check unlock conditions
        5. If unlocked: notify + rewards
        6. Publish achievement event

    - id: achievement-types
      title: "Типы достижений"
      body: |
        ## Standard
        - One-time unlock
        - Example: "First Kill"

        ## Progressive
        - Multiple tiers
        - Example: "Kill 10/100/1000 enemies"

        ## Repeatable
        - Daily/Weekly reset
        - Example: "Complete 5 dailies"

        ## Categories
        - Combat (PvE, PvP)
        - Exploration (locations, secrets)
        - Economic (trades, wealth)
        - Social (friends, guilds)
        - Quests (story, side)
        - Progression (levels, skills)
        - PvP (arenas, wars)
        - Special (seasonal, events)

    - id: rewards
      title: "Награды"
      body: |
        ## Types
        - Currency (eurodollars, cryptos)
        - Items (cosmetics, equipment)
        - Titles (visual flair)
        - Reputation (factions)
        - Experience points
        - Visual elements (emotes, poses)

        ## Distribution
        - Auto-claim: currency, exp
        - Manual-claim: items, titles
        - Mail system: items overflow

appendix:
  decisions:
    - id: "ach-001"
      decision: "Event-driven updates"
      rationale: "Decoupling от других систем"

implementation:
  github_issue: 138
  needs_task: true
  next_steps:
    - "Database: Миграции"
    - "API Designer: OpenAPI"
    - "Backend: Реализация"

history:
  - version: "1.0.0"
    date: 2025-12-02
    author: architect
    changes: "Achievement System architecture"
