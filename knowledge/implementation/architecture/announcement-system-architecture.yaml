metadata:
  id: announcement-system-architecture
  title: Архитектура системы объявлений
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T23:59:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - live-ops
    - communications
    - announcements
  related_systems:
    - announcement-service
    - notification-service
    - admin-api
    - player-service
  related_documents:
    - id: backend-announcement-system
      relation: implements
  github_issue: 323
  visibility: internal
  audience:
    - architect
    - backend
    - live-ops
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы объявлений, включающую:
    - Управление новостями, патчноутами, событиями
    - Систему публикации объявлений
    - Систему доставки объявлений (много канальная)
    - Систему таргетинга
    - Систему учёта прочтений
    - Интеграции с уведомлениями и админ-панелью
  goal: |
    Создать архитектурную схему системы объявлений с определением:
    - Компонентов для управления объявлениями
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы объявлений с поддержкой публикации, доставки,
    таргетинга и учёта прочтений.

architecture:
  overview: |
    Архитектура системы объявлений состоит из следующих компонентов:
    1. Announcement Manager - управление системой объявлений
    2. Announcement Publisher - публикация объявлений
    3. Announcement Scheduler - планирование публикации
    4. Announcement Delivery Manager - управление доставкой
    5. Announcement Targeting Manager - управление таргетингом
    6. Announcement Read Tracker - учёт прочтений
    7. Patch Notes Manager - управление патчноутами
    8. News Feed Manager - управление новостной лентой
    9. Announcement Analytics Collector - сбор аналитики
    10. Announcement Telemetry Collector - сбор телеметрии

  microservices:
    - name: announcement-service
      port: 8094
      responsibility: |
        Обработка системы объявлений:
        - Управление системой объявлений
        - Публикация объявлений
        - Планирование публикации
        - Управление доставкой
        - Управление таргетингом
        - Учёт прочтений
        - Управление патчноутами
        - Управление новостной лентой
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - announcement-manager: управление системой объявлений
        - announcement-publisher: публикация объявлений
        - announcement-scheduler: планирование публикации
        - announcement-delivery-manager: управление доставкой
        - announcement-targeting-manager: управление таргетингом
        - announcement-read-tracker: учёт прочтений
        - patch-notes-manager: управление патчноутами
        - news-feed-manager: управление новостной лентой
        - announcement-analytics-collector: сбор аналитики
        - announcement-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/announcements - список объявлений
        - GET /api/v1/announcements/{announcementId} - информация об объявлении
        - POST /api/v1/announcements - создание объявления
        - PUT /api/v1/announcements/{announcementId} - обновление объявления
        - DELETE /api/v1/announcements/{announcementId} - удаление объявления
        - POST /api/v1/announcements/{announcementId}/publish - публикация объявления
        - POST /api/v1/announcements/{announcementId}/schedule - планирование публикации
        - GET /api/v1/announcements/{characterId}/feed - новостная лента персонажа
        - GET /api/v1/announcements/{characterId}/unread - непрочитанные объявления
        - POST /api/v1/announcements/{announcementId}/read - отметка о прочтении
        - GET /api/v1/announcements/patch-notes - список патчноутов
        - GET /api/v1/announcements/patch-notes/{version} - патчноут по версии
        - POST /api/v1/announcements/patch-notes - создание патчноута
        - GET /api/v1/announcements/{characterId}/stats - статистика объявлений
      websocket_channels:
        - wss://api.necp.game/v1/announcements/{characterId} - поток новых объявлений персонажа
      events_published:
        - announcement.created: создано объявление
        - announcement.updated: обновлено объявление
        - announcement.published: опубликовано объявление
        - announcement.scheduled: запланировано объявление
        - announcement.delivered: доставлено объявление
        - announcement.read: прочитано объявление
        - announcement.patch-notes-published: опубликован патчноут
      events_subscribed:
        - character.created: создан персонаж
        - character.level-up: повышение уровня персонажа
        - maintenance.started: начато обслуживание
        - maintenance.ended: завершено обслуживание
        - event.started: начато событие
        - event.ended: завершено событие

  announcement_types:
    - name: game_news
      description: "Новости игры - общие новости о игре"
      display_style: "NEWS_FEED"
      priority: "MEDIUM"

    - name: patch_notes
      description: "Патчноуты - информация об обновлениях"
      display_style: "MODAL"
      priority: "HIGH"

    - name: maintenance
      description: "Обслуживание - информация об обслуживании"
      display_style: "POPUP"
      priority: "HIGH"

    - name: event
      description: "События - информация о событиях"
      display_style: "BANNER"
      priority: "MEDIUM"

    - name: promotion
      description: "Промо - рекламные акции"
      display_style: "BANNER"
      priority: "MEDIUM"

    - name: community
      description: "Сообщество - новости сообщества"
      display_style: "NEWS_FEED"
      priority: "LOW"

    - name: emergency
      description: "Экстренные - срочные объявления"
      display_style: "POPUP"
      priority: "CRITICAL"

  priorities:
    - name: low
      description: "Низкий приоритет"
      delivery_channels: ["NEWS_FEED"]

    - name: medium
      description: "Средний приоритет"
      delivery_channels: ["NEWS_FEED", "BANNER"]

    - name: high
      description: "Высокий приоритет"
      delivery_channels: ["NEWS_FEED", "BANNER", "POPUP"]

    - name: critical
      description: "Критический приоритет"
      delivery_channels: ["NEWS_FEED", "BANNER", "POPUP", "PUSH", "EMAIL"]

  display_styles:
    - name: news_feed
      description: "Новостная лента - стандартное отображение"
      modal: false
      dismissible: true

    - name: popup
      description: "Всплывающее окно - важные объявления"
      modal: false
      dismissible: true

    - name: modal
      description: "Модальное окно - требует взаимодействия"
      modal: true
      dismissible: false

    - name: banner
      description: "Баннер - постоянное отображение"
      modal: false
      dismissible: true

    - name: toast
      description: "Уведомление - краткое сообщение"
      modal: false
      dismissible: true

  delivery_channels:
    - name: in_game
      description: "В игре - отображение в клиенте"
      types: ["NEWS_FEED", "POPUP", "MODAL", "BANNER", "TOAST"]

    - name: push
      description: "Push уведомления - мобильные уведомления"
      types: ["PUSH"]

    - name: email
      description: "Email - отправка на email"
      types: ["EMAIL"]

    - name: social_media
      description: "Социальные сети - публикация в соцсетях"
      types: ["SOCIAL_MEDIA"]

  targeting:
    criteria:
      - level_range: "диапазон уровней"
      - region: "регион"
      - language: "язык"
      - platform: "платформа"
      - character_class: "класс персонажа"
      - faction: "фракция"
      - subscription_status: "статус подписки"
      - custom_tags: "пользовательские теги"
    operators:
      - equals: "равно"
      - not_equals: "не равно"
      - in: "в списке"
      - not_in: "не в списке"
      - greater_than: "больше"
      - less_than: "меньше"
      - range: "диапазон"

  publication_workflow:
    statuses:
      - draft: "черновик - редактирование"
      - scheduled: "запланировано - ожидание публикации"
      - published: "опубликовано - активно"
      - archived: "архивировано - неактивно"
    process:
      - creation: "создание объявления"
      - targeting_setup: "настройка таргетинга"
      - scheduling: "планирование публикации"
      - publication: "публикация объявления"
      - delivery: "доставка объявления"
      - tracking: "отслеживание прочтений"
      - archiving: "архивирование объявления"

  patch_notes:
    structure:
      - version: "версия патча"
      - release_date: "дата релиза"
      - improvements: "улучшения"
      - bug_fixes: "исправления багов"
      - known_issues: "известные проблемы"
      - attachments: "вложения"
    display:
      - modal_window: "модальное окно при входе"
      - news_feed: "в новостной ленте"
      - dedicated_page: "отдельная страница"

  read_tracking:
    events:
      - displayed: "отображено объявление"
      - read: "прочитано объявление"
      - clicked: "клик по объявлению"
      - dismissed: "закрыто объявление"
    analytics:
      - read_rate: "процент прочтений"
      - click_rate: "процент кликов"
      - dismissal_rate: "процент закрытий"
      - engagement_time: "время взаимодействия"

  data_flows:
    publication_flow: |
      1. Администратор создает объявление через Admin API
      2. Announcement Publisher сохраняет объявление в БД
      3. Announcement Targeting Manager настраивает таргетинг
      4. Announcement Scheduler планирует публикацию (если запланировано)
      5. Announcement Publisher публикует объявление
      6. Announcement Delivery Manager определяет целевую аудиторию
      7. Announcement Delivery Manager доставляет объявление через каналы
      8. Announcement Service публикует событие announcement.published
      9. Notification Service отправляет уведомления
      10. Realtime Gateway отправляет обновление клиентам

    delivery_flow: |
      1. Объявление опубликовано или запланировано
      2. Announcement Delivery Manager получает список целевой аудитории
      3. Announcement Targeting Manager фильтрует аудиторию по критериям
      4. Announcement Delivery Manager выбирает каналы доставки
      5. Announcement Delivery Manager доставляет через in-game канал
      6. Notification Service доставляет через push/email каналы
      7. Announcement Read Tracker отслеживает доставку
      8. Announcement Service публикует событие announcement.delivered
      9. Realtime Gateway отправляет обновление клиентам

    read_tracking_flow: |
      1. Игрок видит объявление в клиенте
      2. Клиент отправляет событие displayed
      3. Announcement Read Tracker фиксирует отображение
      4. Игрок читает объявление
      5. Клиент отправляет событие read
      6. Announcement Read Tracker фиксирует прочтение
      7. Announcement Service публикует событие announcement.read
      8. Analytics Service собирает метрики

  database_structure:
    tables:
      - name: announcements
        description: Объявления
        columns:
          - id: UUID PRIMARY KEY
          - type: ENUM (game_news, patch_notes, maintenance, event, promotion, community, emergency)
          - priority: ENUM (low, medium, high, critical)
          - display_style: ENUM (news_feed, popup, modal, banner, toast)
          - title: VARCHAR(255)
          - content: TEXT
          - media_urls: JSONB
          - targeting_criteria: JSONB
          - delivery_channels: JSONB
          - status: ENUM (draft, scheduled, published, archived)
          - scheduled_publish_at: TIMESTAMP
          - published_at: TIMESTAMP
          - archived_at: TIMESTAMP
          - created_by: UUID FOREIGN KEY
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: player_announcement_reads
        description: Прочтения объявлений игроками
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - announcement_id: UUID FOREIGN KEY
          - displayed_at: TIMESTAMP
          - read_at: TIMESTAMP
          - clicked_at: TIMESTAMP
          - dismissed_at: TIMESTAMP
          - engagement_time: INTEGER
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: patch_notes
        description: Патчноуты
        columns:
          - id: UUID PRIMARY KEY
          - version: VARCHAR(50) UNIQUE
          - release_date: TIMESTAMP
          - improvements: JSONB
          - bug_fixes: JSONB
          - known_issues: JSONB
          - attachments: JSONB
          - announcement_id: UUID FOREIGN KEY
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: announcement_telemetry
        description: Телеметрия объявлений
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - announcement_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    admin_api: |
      - Создание объявлений
      - Обновление объявлений
      - Удаление объявлений
      - Публикация объявлений
      - Планирование публикации

    notification_service: |
      - Доставка через push уведомления
      - Доставка через email
      - Уведомления о новых объявлениях

    player_service: |
      - Получение информации о персонаже для таргетинга
      - Проверка критериев таргетинга
      - Обновление статистики персонажа

    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Проверка класса персонажа

    maintenance_service: |
      - Интеграция с системой обслуживания
      - Автоматическое создание объявлений об обслуживании
      - Уведомления о начале/завершении обслуживания

    event_service: |
      - Интеграция с системой событий
      - Автоматическое создание объявлений о событиях
      - Уведомления о начале/завершении событий

    analytics_service: |
      - Логирование всех операций объявлений
      - Сбор метрик эффективности
      - Анализ паттернов прочтений
      - Мониторинг engagement

    realtime_gateway: |
      - Отправка realtime обновлений объявлений
      - Уведомления о новых объявлениях
      - Синхронизация новостной ленты

technical_specification:
  subtasks:
    - id: announcement-manager
      title: Реализация менеджера системы объявлений
      description: |
        Реализация Announcement Manager с управлением системой объявлений
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: announcement-publisher
      title: Реализация публикатора объявлений
      description: |
        Реализация Announcement Publisher с публикацией объявлений,
        управлением статусами и валидацией.
      dependencies: [announcement-manager]
      estimated_effort: 4 days

    - id: announcement-scheduler
      title: Реализация планировщика публикации
      description: |
        Реализация Announcement Scheduler с планированием публикации,
        автоматическим запуском и управлением расписанием.
      dependencies: [announcement-manager]
      estimated_effort: 4 days

    - id: announcement-delivery-manager
      title: Реализация менеджера доставки
      description: |
        Реализация Announcement Delivery Manager с управлением доставкой,
        выбором каналов и интеграцией с Notification Service.
      dependencies: [announcement-manager]
      estimated_effort: 5 days

    - id: announcement-targeting-manager
      title: Реализация менеджера таргетинга
      description: |
        Реализация Announcement Targeting Manager с управлением таргетингом,
        фильтрацией аудитории и проверкой критериев.
      dependencies: [announcement-manager]
      estimated_effort: 4 days

    - id: announcement-read-tracker
      title: Реализация трекера прочтений
      description: |
        Реализация Announcement Read Tracker с учётом прочтений,
        отслеживанием взаимодействий и сбором метрик.
      dependencies: [announcement-manager]
      estimated_effort: 4 days

    - id: patch-notes-manager
      title: Реализация менеджера патчноутов
      description: |
        Реализация Patch Notes Manager с управлением патчноутами,
        версионированием и отображением.
      dependencies: [announcement-manager]
      estimated_effort: 4 days

    - id: news-feed-manager
      title: Реализация менеджера новостной ленты
      description: |
        Реализация News Feed Manager с управлением новостной лентой,
        сортировкой и фильтрацией объявлений.
      dependencies: [announcement-manager]
      estimated_effort: 3 days

    - id: announcement-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Announcement Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [announcement-manager]
      estimated_effort: 3 days

    - id: announcement-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Announcement Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [announcement-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений объявлений,
        новостной ленты и уведомлений.
      dependencies: [announcement-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы объявлений.
      dependencies: [announcement-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для объявлений, прочтений, патчноутов
        и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> AnnouncementService[Announcement Service<br/>8094]
        
        AnnouncementService --> AM[Announcement Manager]
        AnnouncementService --> AP[Announcement Publisher]
        AnnouncementService --> AS[Announcement Scheduler]
        AnnouncementService --> ADM[Announcement Delivery Manager]
        AnnouncementService --> ATM[Announcement Targeting Manager]
        AnnouncementService --> ART[Announcement Read Tracker]
        AnnouncementService --> PNM[Patch Notes Manager]
        AnnouncementService --> NFM[News Feed Manager]
        AnnouncementService --> AAC[Announcement Analytics Collector]
        AnnouncementService --> ATC[Announcement Telemetry Collector]
        
        AM --> AP
        AM --> AS
        AM --> ADM
        AM --> ATM
        AM --> ART
        AM --> PNM
        AM --> NFM
        
        AnnouncementService --> AdminAPI[Admin API]
        AnnouncementService --> NotificationService[Notification Service]
        AnnouncementService --> PlayerService[Player Service]
        AnnouncementService --> CharacterService[Character Service]
        AnnouncementService --> MaintenanceService[Maintenance Service]
        AnnouncementService --> EventService[Event Service]
        AnnouncementService --> AnalyticsService[Analytics Service]
        
        AnnouncementService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        AnnouncementService --> DB[(Announcement DB)]
        
        Client --> WSAnnouncements[WebSocket<br/>Announcements]
        WSAnnouncements --> AnnouncementService
    ```

  publication_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Admin as Administrator
        participant AP as Announcement Publisher
        participant ATM as Announcement Targeting Manager
        participant AS as Announcement Scheduler
        participant ADM as Announcement Delivery Manager
        participant EB as Event Bus
        
        Admin->>AP: Create announcement
        AP->>AP: Save to DB
        AP->>ATM: Setup targeting
        AP->>AS: Schedule publication
        AS->>AS: Wait for scheduled time
        AS->>AP: Publish announcement
        AP->>ADM: Deliver announcement
        AP->>EB: Publish announcement.published
    ```

  delivery_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant ADM as Announcement Delivery Manager
        participant ATM as Announcement Targeting Manager
        participant NS as Notification Service
        participant ART as Announcement Read Tracker
        participant EB as Event Bus
        
        ADM->>ATM: Get target audience
        ATM->>ATM: Filter by criteria
        ADM->>ADM: Select delivery channels
        ADM->>ADM: Deliver in-game
        ADM->>NS: Deliver push/email
        ADM->>ART: Track delivery
        ADM->>EB: Publish announcement.delivered
    ```
