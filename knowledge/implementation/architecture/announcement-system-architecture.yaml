metadata:
  id: announcement-system-architecture
  title: Архитектура системы объявлений (Announcement System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-23T03:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - announcement
    - backend
    - live-ops
    - communications
  related_systems:
    - liveops-service-go
    - admin-api
    - notification-service
  related_documents:
    - id: backend-announcement-system
      relation: extends
  github_issue: 323
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы объявлений
    для управления новостями, патчноутами, событиями, таргетингом и много канальной
    доставкой объявлений для player engagement.
  goal: |
    Создать архитектурную схему системы объявлений с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы публикации объявлений
    - Системы доставки объявлений
    - Системы таргетинга
    - Системы учёта прочтений
    - Технического задания для реализации
  essence: |
    Система объявлений для управления новостями, патчноутами, событиями с таргетингом
    и много канальной доставкой через popup, push, email и новостную ленту.

architecture:
  overview: |
    Система объявлений состоит из восьми основных компонентов:
    1. Announcement Manager - управление объявлениями
    2. Announcement Publisher - публикация объявлений
    3. Announcement Scheduler - планировщик публикаций
    4. Announcement Delivery Service - доставка объявлений
    5. Announcement Targeting Engine - система таргетинга
    6. Announcement Read Tracker - учёт прочтений
    7. Patch Notes Service - сервис патчноутов
    8. Announcement Event Handler - обработка событий

  components:
    - name: Announcement Manager
      location: liveops-service-go (модуль announcement)
      responsibility: |
        - Управление объявлениями
        - Создание объявлений
        - Редактирование объявлений
        - Управление статусами
        - Интеграция с admin API
      announcement_types: |
        - GAME_NEWS: игровые новости
        - PATCH_NOTES: патчноуты
        - MAINTENANCE: обслуживание
        - EVENT: события
        - PROMOTION: промоакции
        - COMMUNITY: сообщество
        - EMERGENCY: экстренные
      priorities: |
        - LOW: низкий
        - NORMAL: обычный
        - HIGH: высокий
        - CRITICAL: критический
      display_styles: |
        - NEWS_FEED: новостная лента
        - POPUP: всплывающее окно
        - MODAL: модальное окно
        - BANNER: баннер
        - TOAST: уведомление
      endpoints:
        - POST /api/v1/liveops/announcements - создание объявления
        - GET /api/v1/liveops/announcements - список объявлений
        - GET /api/v1/liveops/announcements/{announcement_id} - информация об объявлении
        - PUT /api/v1/liveops/announcements/{announcement_id} - обновление объявления
        - DELETE /api/v1/liveops/announcements/{announcement_id} - удаление объявления

    - name: Announcement Publisher
      location: liveops-service-go (модуль announcement-publisher)
      responsibility: |
        - Публикация объявлений
        - Управление статусами публикации
        - Немедленная публикация
        - Отложенная публикация
      publication_statuses: |
        - DRAFT: черновик
        - SCHEDULED: запланировано
        - PUBLISHED: опубликовано
        - ARCHIVED: архивировано
      endpoints:
        - POST /api/v1/liveops/announcements/{announcement_id}/publish - публикация объявления
        - POST /api/v1/liveops/announcements/{announcement_id}/schedule - планирование публикации
        - POST /api/v1/liveops/announcements/{announcement_id}/archive - архивирование

    - name: Announcement Scheduler
      location: liveops-service-go (модуль announcement-scheduler)
      responsibility: |
        - Планирование публикаций
        - Автоматическая публикация по расписанию
        - Отсчёт времени до публикации
        - Интеграция с cron/scheduler
      scheduling_features: |
        - Планирование по дате/времени
        - Автоматическая публикация
        - Отсчёт времени
        - Уведомления перед публикацией
      endpoints:
        - POST /api/v1/liveops/announcements/{announcement_id}/schedule - планирование
        - GET /api/v1/liveops/announcements/scheduled - запланированные объявления

    - name: Announcement Delivery Service
      location: liveops-service-go (модуль announcement-delivery)
      responsibility: |
        - Доставка объявлений через различные каналы
        - In-game popup
        - Push-уведомления
        - Email
        - Новостная лента
        - Интеграция с notification service
      delivery_channels: |
        - IN_GAME_POPUP: всплывающее окно в игре
        - PUSH_NOTIFICATION: push-уведомление
        - EMAIL: email
        - NEWS_FEED: новостная лента
      delivery_rules: |
        - Для срочных сообщений автоматически активируются push и email
        - Выбор каналов доставки при создании объявления
        - Таргетинг аудитории
      endpoints:
        - POST /api/v1/liveops/announcements/{announcement_id}/deliver - доставка объявления
        - GET /api/v1/liveops/announcements/{announcement_id}/delivery-status - статус доставки

    - name: Announcement Targeting Engine
      location: liveops-service-go (модуль announcement-targeting)
      responsibility: |
        - Таргетинг объявлений
        - Выбор аудитории
        - Фильтрация по критериям
        - Персонализация
      targeting_criteria: |
        - По региону
        - По уровню игрока
        - По активности
        - По платёжеспособности
        - По языку
        - По платформе
      endpoints:
        - POST /api/v1/liveops/announcements/{announcement_id}/target - настройка таргетинга
        - GET /api/v1/liveops/announcements/{announcement_id}/audience - аудитория объявления

    - name: Announcement Read Tracker
      location: liveops-service-go (модуль announcement-tracking)
      responsibility: |
        - Учёт прочтений объявлений
        - Отслеживание взаимодействий
        - Статистика прочтений
        - Аналитика
      tracking_features: |
        - Отслеживание прочтений
        - Отслеживание кликов
        - Отслеживание скрытий
        - Статистика взаимодействий
      endpoints:
        - POST /api/v1/liveops/announcements/{announcement_id}/read - отметка прочтения
        - POST /api/v1/liveops/announcements/{announcement_id}/click - отслеживание клика
        - GET /api/v1/liveops/announcements/{announcement_id}/stats - статистика объявления

    - name: Patch Notes Service
      location: liveops-service-go (модуль patch-notes)
      responsibility: |
        - Управление патчноутами
        - Формирование модальных объявлений
        - Версии патчноутов
        - Списки улучшений и проблем
      patch_notes_features: |
        - Модальные объявления
        - Версии патчноутов
        - Списки улучшений
        - Известные проблемы
        - Вложения
      endpoints:
        - POST /api/v1/liveops/patch-notes - создание патчноута
        - GET /api/v1/liveops/patch-notes - список патчноутов
        - GET /api/v1/liveops/patch-notes/{version} - патчноут по версии

    - name: Announcement Event Handler
      location: liveops-service-go (модуль announcement-events)
      responsibility: |
        - Обработка событий объявлений
        - Публикация событий в event bus
        - Подписка на события от других систем
        - Интеграция с аналитикой
      announcement_events_published: |
        - announcement:created
        - announcement:published
        - announcement:delivered
        - announcement:read
        - announcement:clicked
      endpoints:
        - GET /api/v1/liveops/announcements/events/{announcement_id} - события объявления

  data_flow:
    announcement_creation: |
      1. Администратор создаёт объявление через admin API
      2. Announcement Manager сохраняет объявление в БД
      3. Настраивается таргетинг через Announcement Targeting Engine
      4. Выбираются каналы доставки
      5. Если запланировано - Announcement Scheduler планирует публикацию
      6. Announcement Event Handler публикует announcement:created

    announcement_publication: |
      1. При наступлении времени публикации или при ручной публикации
      2. Announcement Publisher обновляет статус на PUBLISHED
      3. Announcement Delivery Service выбирает аудиторию через Targeting Engine
      4. Доставка через выбранные каналы (popup, push, email, news feed)
      5. Announcement Event Handler публикует announcement:published и announcement:delivered
      6. Notification Service отправляет уведомления

    announcement_read: |
      1. Игрок видит объявление
      2. Игрок взаимодействует с объявлением (читает, кликает, скрывает)
      3. Announcement Read Tracker фиксирует взаимодействие
      4. Статистика обновляется
      5. Announcement Event Handler публикует события (announcement:read, announcement:clicked)

  integrations:
    with_admin_api: |
      - Создание объявлений
      - Управление объявлениями
      - Мониторинг статистики

    with_notification_service: |
      - Доставка через push-уведомления
      - Доставка через email
      - Интеграция с системой уведомлений

    with_player_service: |
      - Получение информации об игроках для таргетинга
      - Интеграция с профилями игроков

    with_analytics_service: |
      - Статистика прочтений
      - Статистика взаимодействий
      - Интеграция с аналитикой

    with_realtime_gateway: |
      - Синхронизация объявлений
      - Уведомления о новых объявлениях
      - Обновления в реальном времени

  database_schema:
    tables:
      - name: announcements
        description: Объявления
        fields:
          - id: UUID (PK)
          - title: VARCHAR(255)
          - content: TEXT
          - announcement_type: ENUM (GAME_NEWS, PATCH_NOTES, MAINTENANCE, EVENT, PROMOTION, COMMUNITY, EMERGENCY)
          - priority: ENUM (LOW, NORMAL, HIGH, CRITICAL)
          - display_style: ENUM (NEWS_FEED, POPUP, MODAL, BANNER, TOAST)
          - status: ENUM (DRAFT, SCHEDULED, PUBLISHED, ARCHIVED)
          - scheduled_publish_at: TIMESTAMP (nullable)
          - published_at: TIMESTAMP (nullable)
          - archived_at: TIMESTAMP (nullable)
          - targeting: JSONB (nullable)
          - delivery_channels: VARCHAR[] (default: ['NEWS_FEED'])
          - media: JSONB (nullable)
          - created_by: UUID (FK accounts)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - status, scheduled_publish_at
          - announcement_type, status
          - published_at DESC

      - name: player_announcement_reads
        description: Прочтения объявлений игроками
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - announcement_id: UUID (FK announcements)
          - read_at: TIMESTAMP
          - clicked_at: TIMESTAMP (nullable)
          - hidden_at: TIMESTAMP (nullable)
          - delivery_channel: VARCHAR(50)
        constraints: |
          - UNIQUE(player_id, announcement_id)
        indexes:
          - player_id, read_at
          - announcement_id, read_at

      - name: patch_notes
        description: Патчноуты
        fields:
          - id: UUID (PK)
          - version: VARCHAR(50) (UNIQUE)
          - title: VARCHAR(255)
          - content: TEXT
          - improvements: TEXT[]
          - known_issues: TEXT[]
          - attachments: JSONB (nullable)
          - announcement_id: UUID (FK announcements, nullable)
          - published_at: TIMESTAMP
          - created_at: TIMESTAMP
        indexes:
          - version
          - published_at DESC

technical_specification:
  backend_requirements:
    - Реализация модулей в liveops-service-go:
      - announcement (управление объявлениями)
      - announcement-publisher (публикация)
      - announcement-scheduler (планировщик)
      - announcement-delivery (доставка)
      - announcement-targeting (таргетинг)
      - announcement-tracking (учёт прочтений)
      - patch-notes (патчноуты)
      - announcement-events (события)
    - Интеграция с admin API
    - Интеграция с notification service
    - Интеграция с analytics service
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация объявлений через WebSocket
    - Уведомления о новых объявлениях
    - Обновления в реальном времени

  performance_requirements:
    - Создание объявления < 200ms
    - Публикация объявления < 500ms
    - Доставка объявления < 1s
    - Загрузка объявлений < 200ms
    - Поддержка до 10K объявлений
    - Поддержка до 1M прочтений

  scalability_requirements:
    - Горизонтальное масштабирование через liveops-service
    - Распределение нагрузки на объявления
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование объявлений в Redis
    - Оптимизация доставки через очереди

subtasks:
  - id: announcement-manager-module
    title: Реализация модуля Announcement Manager
    description: |
      Управление объявлениями
      Создание объявлений
      Управление статусами
    priority: high
    estimated_time: 3-4 дня

  - id: announcement-publisher
    title: Реализация Announcement Publisher
    description: |
      Публикация объявлений
      Управление статусами публикации
      Немедленная/отложенная публикация
    priority: high
    estimated_time: 2-3 дня

  - id: announcement-scheduler
    title: Реализация Announcement Scheduler
    description: |
      Планирование публикаций
      Автоматическая публикация
      Интеграция с cron/scheduler
    priority: high
    estimated_time: 3-4 дня

  - id: announcement-delivery-service
    title: Реализация Announcement Delivery Service
    description: |
      Доставка объявлений
      Много канальная доставка
      Интеграция с notification service
    priority: high
    estimated_time: 4-5 дней

  - id: announcement-targeting-engine
    title: Реализация Announcement Targeting Engine
    description: |
      Таргетинг объявлений
      Выбор аудитории
      Фильтрация по критериям
    priority: high
    estimated_time: 3-4 дня

  - id: announcement-read-tracker
    title: Реализация Announcement Read Tracker
    description: |
      Учёт прочтений
      Отслеживание взаимодействий
      Статистика
    priority: high
    estimated_time: 3-4 дня

  - id: patch-notes-service
    title: Реализация Patch Notes Service
    description: |
      Управление патчноутами
      Формирование модальных объявлений
      Версии патчноутов
    priority: high
    estimated_time: 3-4 дня

  - id: announcement-event-handler
    title: Реализация Announcement Event Handler
    description: |
      Обработка событий
      Публикация событий
      Интеграция с аналитикой
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование объявлений
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для объявлений
      Интеграция с существующим API liveops-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты создания объявлений
      Тесты публикации
      Тесты доставки
      Тесты таргетинга
      Тесты учёта прочтений
      Тесты интеграций
    priority: high
    estimated_time: 4-5 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Liveops Service"
            AM[Announcement Manager]
            AP[Announcement Publisher]
            AS[Announcement Scheduler]
            ADS[Announcement Delivery Service]
            ATE[Announcement Targeting Engine]
            ART[Announcement Read Tracker]
            PNS[Patch Notes Service]
            AEH[Announcement Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>announcements<br/>player_announcement_reads<br/>patch_notes)]
        end

        subgraph "External Services"
            AA[Admin API]
            NS[Notification Service]
            PS[Player Service]
            ASVC[Analytics Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        AA -->|create| AM
        AS -->|schedule| AP
        AP -->|publish| ADS
        ADS --> ATE
        ADS --> NS
        ART --> ASVC
        AEH --> RG
        RG -->|push announcements| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant A as Admin
        participant AM as Announcement Manager
        participant AP as Announcement Publisher
        participant ADS as Announcement Delivery Service
        participant P as Player

        A->>AM: Create announcement
        AM->>AM: Save announcement
        A->>AP: Publish announcement
        AP->>ADS: Deliver announcement
        ADS->>P: Show announcement
        P->>ADS: Read announcement
    ```

decisions:
  - id: adr-announcement-architecture
    summary: |
      Выбрана модульная архитектура внутри liveops-service-go для обеспечения
      тесной интеграции с live-ops системами.

  - id: adr-announcement-types
    summary: |
      Семь типов объявлений (GAME_NEWS, PATCH_NOTES, MAINTENANCE, EVENT, PROMOTION,
      COMMUNITY, EMERGENCY) обеспечивают гибкость в коммуникации с игроками.

  - id: adr-delivery-channels
    summary: |
      Много канальная доставка (in-game popup, push, email, news feed) обеспечивает
      максимальный охват аудитории и персонализацию.

  - id: adr-targeting
    summary: |
      Система таргетинга позволяет доставлять объявления релевантной аудитории
      и повышает эффективность коммуникации.

  - id: adr-read-tracking
    summary: |
      Учёт прочтений и взаимодействий позволяет измерять эффективность объявлений
      и оптимизировать коммуникацию.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата таргетинга и доставки

history:
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы объявлений:
      - Определены компоненты (Announcement Manager, Announcement Publisher, Announcement Scheduler, Announcement Delivery Service, Announcement Targeting Engine, Announcement Read Tracker, Patch Notes Service, Announcement Event Handler)
      - Описаны типы объявлений (GAME_NEWS, PATCH_NOTES, MAINTENANCE, EVENT, PROMOTION, COMMUNITY, EMERGENCY)
      - Описаны приоритеты (LOW, NORMAL, HIGH, CRITICAL)
      - Описаны стили отображения (NEWS_FEED, POPUP, MODAL, BANNER, TOAST)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (announcements, player_announcement_reads, patch_notes)
      - Спроектирована система публикации объявлений
      - Спроектирована система доставки объявлений
      - Спроектирована система таргетинга
      - Спроектирована система учёта прочтений
      - Создано техническое задание
      - Разбито на подзадачи

