metadata:
  id: anti-cheat-system-architecture
  title: Архитектура системы античита (Anti-Cheat System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T20:10:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - anti-cheat
    - backend
    - security
    - realtime
  related_systems:
    - realtime-gateway-go
    - session-service-go
    - gameplay-service-go
  related_documents:
    - id: backend-anti-cheat-compact
      relation: extends
  github_issue: 203
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы античита
    для обнаружения и предотвращения читерства через серверные проверки скорости,
    позиции, частоты действий и reconciliation.
  goal: |
    Создать архитектурную схему системы античита с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы обнаружения speed hack
    - Системы валидации позиции
    - Системы контроля частоты действий
    - Системы reconciliation
    - Технического задания для реализации
  essence: |
    Игровая система античита для обнаружения и предотвращения читерства через
    серверные проверки и reconciliation с клиентом.

architecture:
  overview: |
    Система античита состоит из семи основных компонентов:
    1. Speed Hack Detector - обнаружение speed hack
    2. Position Validator - валидация позиции
    3. Action Rate Limiter - контроль частоты действий
    4. Reconciliation Engine - reconciliation клиент-сервер
    5. Violation Logger - логирование нарушений
    6. Anti-Cheat Monitor - мониторинг нарушений
    7. Penalty Manager - управление наказаниями

  components:
    - name: Speed Hack Detector
      location: realtime-gateway-go (модуль anti-cheat)
      responsibility: |
        - Обнаружение speed hack
        - Расчёт скорости движения
        - Проверка максимальной скорости
        - Обнаружение аномалий скорости
        - Логирование нарушений
      detection_logic: |
        - Расчёт скорости: distance / time
        - Проверка максимальной скорости (с учётом навыков, баффов)
        - Порог отклонения: 10% от максимальной скорости
        - Учёт лагов и reconciliation
      thresholds: |
        - Максимальная скорость: зависит от класса и навыков
        - Порог отклонения: 10%
        - Количество нарушений для триггера: 3 за 10 секунд
      endpoints:
        - POST /api/v1/anti-cheat/speed/validate - валидация скорости
        - GET /api/v1/anti-cheat/speed/violations/{player_id} - нарушения скорости

    - name: Position Validator
      location: realtime-gateway-go (модуль anti-cheat)
      responsibility: |
        - Валидация позиции игрока
        - Проверка телепортации
        - Проверка прохождения через стены
        - Проверка коллизий
        - Логирование нарушений
      validation_logic: |
        - Проверка расстояния между позициями
        - Проверка прохождения через препятствия
        - Проверка коллизий с объектами
        - Учёт лагов и reconciliation
      thresholds: |
        - Максимальное расстояние за тик: зависит от скорости
        - Порог телепортации: 50 метров
        - Количество нарушений для триггера: 2 за 5 секунд
      endpoints:
        - POST /api/v1/anti-cheat/position/validate - валидация позиции
        - GET /api/v1/anti-cheat/position/violations/{player_id} - нарушения позиции

    - name: Action Rate Limiter
      location: realtime-gateway-go (модуль anti-cheat)
      responsibility: |
        - Контроль частоты действий
        - Обнаружение макросов
        - Обнаружение автоматических действий
        - Rate limiting действий
        - Логирование нарушений
      action_types: |
        - Атака: максимально 10 в секунду
        - Использование навыков: максимально 5 в секунду
        - Взаимодействие: максимально 20 в секунду
        - Движение: без ограничений (контролируется speed hack detector)
      detection_logic: |
        - Подсчёт действий за интервал времени
        - Проверка паттернов (идеальная периодичность)
        - Обнаружение человеческих паттернов vs макросов
      thresholds: |
        - Максимальная частота атак: 10/сек
        - Максимальная частота навыков: 5/сек
        - Максимальная частота взаимодействий: 20/сек
        - Порог идеальной периодичности: 95%
      endpoints:
        - POST /api/v1/anti-cheat/action-rate/validate - валидация частоты действий
        - GET /api/v1/anti-cheat/action-rate/violations/{player_id} - нарушения частоты

    - name: Reconciliation Engine
      location: realtime-gateway-go (модуль anti-cheat-reconciliation)
      responsibility: |
        - Reconciliation клиент-сервер
        - Компенсация лагов
        - Сверка состояния
        - Разрешение конфликтов
        - Снижение ложных срабатываний
      reconciliation_logic: |
        - Сравнение клиентского и серверного состояния
        - Учёт лагов сети
        - Компенсация задержек
        - Разрешение конфликтов в пользу сервера
        - Уведомление клиента о расхождениях
      reconciliation_window: |
        - Окно reconciliation: 500ms
        - Максимальное расхождение: 10%
        - Автоматическая коррекция при малых расхождениях
      endpoints:
        - POST /api/v1/anti-cheat/reconciliation/compare - сравнение состояний
        - POST /api/v1/anti-cheat/reconciliation/resolve - разрешение конфликтов

    - name: Violation Logger
      location: realtime-gateway-go (модуль anti-cheat-logging)
      responsibility: |
        - Логирование нарушений
        - Хранение истории нарушений
        - Агрегация нарушений
        - Генерация отчётов
        - Интеграция с мониторингом
      violation_types: |
        - SPEED_HACK: нарушение скорости
        - POSITION_HACK: нарушение позиции
        - ACTION_RATE_HACK: нарушение частоты действий
        - RECONCILIATION_FAILURE: неудачная reconciliation
      logging_format: |
        - Timestamp
        - Player ID
        - Violation type
        - Violation data (JSON)
        - Server state snapshot
        - Client state snapshot
      endpoints:
        - POST /api/v1/anti-cheat/violations/log - логирование нарушения
        - GET /api/v1/anti-cheat/violations/{player_id} - история нарушений

    - name: Anti-Cheat Monitor
      location: realtime-gateway-go (модуль anti-cheat-monitoring)
      responsibility: |
        - Мониторинг нарушений
        - Агрегация метрик
        - Триггеры для эскалации
        - Интеграция с observability
        - Генерация алертов
      monitoring_metrics: |
        - Количество нарушений по типам
        - Частота нарушений на игрока
        - Топ нарушителей
        - Тренды нарушений
      escalation_triggers: |
        - 3+ нарушения за 10 секунд: временная блокировка
        - 10+ нарушений за час: расследование
        - 50+ нарушений за день: постоянная блокировка
      endpoints:
        - GET /api/v1/anti-cheat/monitoring/stats - статистика нарушений
        - GET /api/v1/anti-cheat/monitoring/alerts - активные алерты

    - name: Penalty Manager
      location: realtime-gateway-go (модуль anti-cheat-penalties)
      responsibility: |
        - Управление наказаниями
        - Выдача временных блокировок
        - Выдача постоянных блокировок
        - Интеграция с session service
        - Уведомления игроков
      penalty_types: |
        - WARNING: предупреждение
        - TEMPORARY_BAN: временная блокировка (1 час - 7 дней)
        - PERMANENT_BAN: постоянная блокировка
        - ROLLBACK: откат действий
      penalty_logic: |
        - Автоматические наказания на основе нарушений
        - Ручные наказания администраторами
        - Эскалация наказаний при повторных нарушениях
      endpoints:
        - POST /api/v1/anti-cheat/penalties/apply - применение наказания
        - GET /api/v1/anti-cheat/penalties/{player_id} - наказания игрока
        - POST /api/v1/anti-cheat/penalties/revoke - отмена наказания

  data_flow:
    speed_validation: |
      1. Клиент отправляет данные о движении
      2. Realtime Gateway получает данные
      3. Speed Hack Detector рассчитывает скорость
      4. Проверяется максимальная скорость
      5. Если нарушение - логируется в Violation Logger
      6. Anti-Cheat Monitor агрегирует нарушения
      7. Если триггер сработал - Penalty Manager применяет наказание
      8. Session Service блокирует сессию (если нужно)
      9. Notification Service уведомляет игрока

    position_validation: |
      1. Клиент отправляет позицию
      2. Realtime Gateway получает данные
      3. Position Validator проверяет позицию
      4. Проверяется расстояние и коллизии
      5. Если нарушение - логируется в Violation Logger
      6. Reconciliation Engine пытается разрешить конфликт
      7. Если reconciliation неудачна - применяется наказание

    action_rate_validation: |
      1. Клиент отправляет действие
      2. Realtime Gateway получает данные
      3. Action Rate Limiter проверяет частоту
      4. Проверяется паттерн действий
      5. Если нарушение - логируется в Violation Logger
      6. Anti-Cheat Monitor агрегирует нарушения
      7. Если триггер сработал - применяется наказание

    reconciliation: |
      1. Клиент отправляет состояние
      2. Reconciliation Engine сравнивает с серверным состоянием
      3. Если расхождение в пределах окна - компенсируется
      4. Если расхождение большое - логируется как нарушение
      5. Серверное состояние применяется к клиенту
      6. Клиент получает уведомление о коррекции

  integrations:
    with_realtime_gateway: |
      - Получение данных от клиентов
      - Валидация в реальном времени
      - Отправка коррекций клиентам

    with_session_service: |
      - Блокировка сессий при нарушениях
      - Получение информации о сессиях
      - Управление доступом

    with_gameplay_service: |
      - Получение данных о боевых действиях
      - Валидация боевых действий
      - Откат боевых действий при нарушениях

    with_notification_service: |
      - Уведомления о нарушениях
      - Уведомления о наказаниях
      - Уведомления администраторам

    with_observability: |
      - Отправка метрик в Prometheus
      - Логирование в Loki
      - Трейсинг в Tempo

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для логирования нарушений и применения наказаний
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед применением наказаний
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (применение наказания, блокировка сессии, уведомление игрока)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния античита (обнаружение нарушения, применение наказания, отмена наказания)
      записываются как события в Event Store. Это обеспечивает полный аудит,
      возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: ViolationDetectedEvent, PenaltyAppliedEvent, PenaltyRevokedEvent, ReconciliationFailedEvent.
    cqrs_pattern: |
      Разделение команд (логирование нарушения, применение наказания) и запросов
      (получение истории нарушений, получение статистики, получение наказаний) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как применение наказания (логирование нарушения,
      применение наказания, блокировка сессии, уведомление игрока) или отмена наказания
      (отмена наказания, разблокировка сессии, уведомление игрока), используется Saga Pattern
      для обеспечения атомарности операций между Anti-Cheat Service, Session Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    validation_operations:
      tickrate: 20-128 Hz (в зависимости от типа активности)
      network_load: |
        - Валидация скорости: 20-128 Hz, ~0.5-2 KB/sec на игрока
        - Валидация позиции: 20-128 Hz, ~0.5-2 KB/sec на игрока
        - Валидация частоты действий: event-based, ~0.1-0.5 KB/sec на игрока
        - Общий трафик: ~1-4 KB/sec на игрока
      latency_requirements: < 5-10ms для валидации (критично для realtime)
      sync_strategy: Strong Consistency (ACID транзакции) для логирования нарушений

    reconciliation_operations:
      tickrate: 1-5 Hz для reconciliation
      network_load: |
        - Reconciliation запросы: 1-5 Hz, ~0.2-0.5 KB/sec на игрока
        - Коррекция состояния: event-based, ~0.1-0.3 KB/sec на игрока
        - Общий трафик: ~0.3-0.8 KB/sec на игрока
      latency_requirements: < 10-50ms для reconciliation
      sync_strategy: Eventual Consistency для reconciliation (компенсация лагов)

    violation_logging:
      tickrate: Event-based (on-demand)
      network_load: |
        - Логирование нарушений: event-based, ~0.01-0.05 events/sec на игрока
        - Получение истории нарушений: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.2 KB/sec на игрока
      latency_requirements: < 50-200ms для логирования нарушений
      sync_strategy: Strong Consistency (ACID транзакции) для логирования нарушений

    penalty_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Применение наказания: event-based, ~0.001-0.01 events/sec на игрока
        - Получение наказаний: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.2 KB/sec на игрока
      latency_requirements: < 100-300ms для применения наказания
      sync_strategy: Strong Consistency (ACID транзакции) для применения наказаний

  database_schema:
    tables:
      - name: anti_cheat_violations
        description: Нарушения античита
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - violation_type: ENUM (SPEED_HACK, POSITION_HACK, ACTION_RATE_HACK, RECONCILIATION_FAILURE)
          - violation_data: JSONB
          - server_state: JSONB
          - client_state: JSONB
          - severity: ENUM (LOW, MEDIUM, HIGH, CRITICAL)
          - created_at: TIMESTAMP
        indexes:
          - player_id, created_at
          - violation_type, created_at
          - severity, created_at

      - name: anti_cheat_penalties
        description: Наказания за нарушения
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - penalty_type: ENUM (WARNING, TEMPORARY_BAN, PERMANENT_BAN, ROLLBACK)
          - reason: TEXT
          - duration_seconds: INTEGER (nullable)
          - applied_by: UUID (FK accounts, nullable)
          - is_active:
              BOOLEAN (default: true)
          - expires_at: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
        indexes:
          - player_id, is_active
          - penalty_type, is_active
          - expires_at

      - name: anti_cheat_player_stats
        description: Статистика нарушений игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts, unique)
          - total_violations:
              INTEGER (default: 0)
          - speed_hack_count:
              INTEGER (default: 0)
          - position_hack_count:
              INTEGER (default: 0)
          - action_rate_hack_count:
              INTEGER (default: 0)
          - reconciliation_failure_count:
              INTEGER (default: 0)
          - last_violation_at: TIMESTAMP (nullable)
          - updated_at: TIMESTAMP
        indexes:
          - player_id (unique)
          - total_violations
