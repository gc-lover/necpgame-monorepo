# Issue: #227

metadata:
  id: architecture-battle-pass-system
  title: "Battle Pass System Architecture"
  document_type: architecture
  category: implementation
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-02T18:30:00Z
  owners:
    - role: architect
  tags:
    - battle-pass
    - monetization
    - progression
    - architecture
  related_systems:
    - battle-pass-service
    - economy-service
    - notification-service
    - quest-service
    - achievement-service
  related_documents:
    - id: backend-battle-pass-overview
      relation: implements
    - id: backend-battle-pass-part1-core
      relation: implements
    - id: backend-battle-pass-part2-rewards
      relation: implements

summary:
  problem: "Необходима архитектура Battle Pass для сезонов, прогрессии, наград и премиум-треков."
  goal: "Спроектировать систему Battle Pass с сезонами, прогрессией, наградами и челленджами."
  essence: "Event-driven система сезонной прогрессии с бесплатным и премиум треками."

content:
  sections:
    - id: system-overview
      title: "Обзор"
      body: |
        Battle Pass System:
        - Сезонная прогрессия (100 уровней)
        - Бесплатный и премиум треки
        - Еженедельные челленджи
        - Система XP источников
        - Выдача наград
        - Интеграция с экономикой

    - id: components
      title: "Компоненты"
      body: |
        ## battle-pass-service
        **Port:** TBD (8087 recommended)
        **API:** `/api/v1/economy/battle-pass/*`
        
        Компоненты:
        - SeasonManager - управление сезонами
        - ProgressionTracker - отслеживание прогресса
        - RewardDistributor - выдача наград
        - ChallengeGenerator - генерация челленджей
        - PremiumHandler - обработка премиум покупок
        - XPSystem - система опыта

        ## Интеграции
        - **Economy Service:** Проверка валюты, выдача наград
        - **Notification Service:** Уведомления о прогрессе
        - **Quest Service:** Интеграция с квестами
        - **Achievement Service:** Связь с достижениями
        - **Event Bus (Kafka):** События прогресса и наград

    - id: api-endpoints
      title: "API Endpoints"
      body: |
        GET /api/v1/economy/battle-pass/current
        - Текущий сезон
        - Response: Season info

        GET /api/v1/economy/battle-pass/progress
        - Прогресс игрока
        - Query: player_id
        - Response: Player progress

        POST /api/v1/economy/battle-pass/claim
        - Забрать награду уровня
        - Request: level, track (free/premium)
        - Response: Rewards

        POST /api/v1/economy/battle-pass/purchase-premium
        - Купить премиум трек
        - Request: player_id
        - Response: Premium status

        GET /api/v1/economy/battle-pass/challenges/weekly
        - Еженедельные челленджи
        - Query: player_id
        - Response: Weekly challenges

        POST /api/v1/economy/battle-pass/challenges/{id}/complete
        - Завершить челлендж
        - Request: player_id
        - Response: XP awarded

        GET /api/v1/economy/battle-pass/rewards
        - Все награды сезона
        - Query: season_id
        - Response: Array of rewards

    - id: database
      title: "База данных"
      body: |
        ## battle_pass_seasons
        ```sql
        CREATE TABLE battle_pass_seasons (
          id UUID PRIMARY KEY,
          name VARCHAR(200),
          start_date TIMESTAMP,
          end_date TIMESTAMP,
          is_active BOOLEAN,
          max_level INT DEFAULT 100
        );
        ```

        ## battle_pass_rewards
        ```sql
        CREATE TABLE battle_pass_rewards (
          id UUID PRIMARY KEY,
          season_id UUID REFERENCES battle_pass_seasons(id),
          level INT,
          track VARCHAR(20), -- 'free' or 'premium'
          reward_type VARCHAR(50),
          reward_data JSONB,
          UNIQUE(season_id, level, track)
        );
        ```

        ## player_battle_pass_progress
        ```sql
        CREATE TABLE player_battle_pass_progress (
          player_id UUID,
          season_id UUID REFERENCES battle_pass_seasons(id),
          current_level INT,
          current_xp INT,
          premium_owned BOOLEAN,
          premium_purchased_at TIMESTAMP,
          claimed_levels INT[],
          PRIMARY KEY (player_id, season_id)
        );
        ```

        ## weekly_challenges
        ```sql
        CREATE TABLE weekly_challenges (
          id UUID PRIMARY KEY,
          season_id UUID REFERENCES battle_pass_seasons(id),
          week_number INT,
          challenge_type VARCHAR(50),
          description TEXT,
          target_value INT,
          xp_reward INT,
          created_at TIMESTAMP
        );
        ```

        ## player_weekly_challenges
        ```sql
        CREATE TABLE player_weekly_challenges (
          player_id UUID,
          challenge_id UUID REFERENCES weekly_challenges(id),
          progress INT,
          completed BOOLEAN,
          completed_at TIMESTAMP,
          PRIMARY KEY (player_id, challenge_id)
        );
        ```

    - id: progression-system
      title: "Система прогрессии"
      body: |
        ## XP Sources
        - Quest completion
        - Daily activities
        - Weekly challenges
        - Combat actions
        - Social interactions
        - Economic activities

        ## Level Calculation
        - XP required per level increases
        - Formula: base_xp * (level * multiplier)
        - Max level: 100

        ## Premium Benefits
        - Additional rewards per level
        - XP boost (1.5x)
        - Exclusive cosmetics
        - Early access to rewards

    - id: season-system
      title: "Система сезонов"
      body: |
        ## Season Lifecycle
        1. Season creation
        2. Season activation
        3. Active period (8-12 weeks)
        4. Season end
        5. Rewards claim period (2 weeks)
        6. Season archive

        ## Season Management
        - One active season at a time
        - Automatic progression reset
        - Season-specific rewards
        - Season themes and cosmetics

    - id: reward-system
      title: "Система наград"
      body: |
        ## Reward Types
        - Currency (eurodollars, cryptos)
        - Items (equipment, consumables)
        - Cosmetics (skins, emotes)
        - XP boosters
        - Titles

        ## Reward Distribution
        - Free track: every level
        - Premium track: every level (additional)
        - Claim mechanism: manual or auto
        - Overflow handling: mail system

    - id: challenge-system
      title: "Система челленджей"
      body: |
        ## Weekly Challenges
        - 5 challenges per week
        - Auto-generation on Monday
        - XP rewards on completion
        - Challenge types:
          * Combat (kills, damage)
          * Quest (completions)
          * Social (interactions)
          * Economic (trades, crafting)
          * Exploration (locations)

        ## Challenge Processing
        1. Event received from game services
        2. Match challenge criteria
        3. Update progress
        4. Check completion
        5. Award XP if completed

    - id: event-driven
      title: "Event-Driven Architecture"
      body: |
        ## Subscribed Events
        - quest.completed
        - combat.action
        - economy.transaction
        - social.interaction
        - exploration.discovered

        ## Published Events
        - battle_pass.xp_awarded
        - battle_pass.level_up
        - battle_pass.reward_claimed
        - battle_pass.premium_purchased
        - battle_pass.challenge_completed

        ## Event Processing
        1. Receive event from Kafka
        2. Calculate XP from event
        3. Update player progress
        4. Check level up
        5. Check challenge progress
        6. Publish battle pass events

    - id: premium-system
      title: "Премиум система"
      body: |
        ## Premium Purchase
        - Currency: Premium currency
        - Price: Configurable per season
        - Validation: Economy service
        - Activation: Immediate
        - Retroactive rewards: Yes (all previous levels)

        ## Premium Features
        - Premium track rewards
        - XP boost (1.5x)
        - Exclusive cosmetics
        - Early access to content

appendix:
  decisions:
    - id: "bp-001"
      decision: "Event-driven progression"
      rationale: "Decoupling от других систем"
    - id: "bp-002"
      decision: "100 levels per season"
      rationale: "Оптимальный баланс прогрессии"
    - id: "bp-003"
      decision: "Weekly challenges"
      rationale: "Поддержание активности"

implementation:
  github_issue: 227
  needs_task: true
  next_steps:
    - "Database: Миграции"
    - "API Designer: OpenAPI"
    - "Backend: Реализация"

history:
  - version: "1.0.0"
    date: 2025-12-02
    author: architect
    changes: "Battle Pass System architecture"
