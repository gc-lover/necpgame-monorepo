# Issue: #172
metadata:
  id: chat-system-api
  title: Chat System — API контракты
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-14T15:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game

api_contracts:
  rest_api:
    base_path: "/api/v1/chat"
    endpoints:
      # Message Operations
      - method: POST
        path: "/messages"
        description: "Send message to channel"
        request_body:
          channel_id: "uuid"
          content: "string (max 500 chars)"
          message_type: "text | emote | system"
        response: "message object with id"

      - method: GET
        path: "/messages/{channel_id}"
        description: "Get channel message history"
        query_params:
          limit: "integer (default: 50, max: 100)"
          before: "timestamp"
        response: "array of message objects"

      - method: DELETE
        path: "/messages/{message_id}"
        description: "Delete message (moderator or sender)"
        response: "success confirmation"

      # Channel Management
      - method: GET
        path: "/channels"
        description: "Get available channels for user"
        response: "array of channel objects"

      - method: POST
        path: "/channels/{channel_id}/join"
        description: "Join channel"
        response: "success confirmation"

      - method: POST
        path: "/channels/{channel_id}/leave"
        description: "Leave channel"
        response: "success confirmation"

      - method: GET
        path: "/channels/{channel_id}/members"
        description: "Get channel members"
        response: "array of member objects"

      # Moderation Operations
      - method: POST
        path: "/moderation/report"
        description: "Report message or user"
        request_body:
          target_type: "message | user"
          target_id: "uuid"
          reason: "string"
          description: "string (optional)"
        response: "report confirmation"

      - method: POST
        path: "/moderation/ban"
        description: "Ban user from channel (moderator)"
        request_body:
          user_id: "uuid"
          channel_id: "uuid"
          duration: "integer (minutes)"
          reason: "string"
        response: "ban confirmation"

      - method: DELETE
        path: "/moderation/ban/{ban_id}"
        description: "Remove ban (moderator)"
        response: "success confirmation"

      # Voice Operations
      - method: POST
        path: "/voice/join"
        description: "Join voice channel"
        request_body:
          channel_id: "uuid"
          muted: "boolean (default: false)"
          deafened: "boolean (default: false)"
        response: "voice session info"

      - method: POST
        path: "/voice/leave"
        description: "Leave voice channel"
        response: "success confirmation"

      - method: PUT
        path: "/voice/mute"
        description: "Mute/unmute in voice channel"
        request_body:
          muted: "boolean"
        response: "success confirmation"

      # Settings
      - method: GET
        path: "/settings"
        description: "Get user chat settings"
        response: "settings object"

      - method: PUT
        path: "/settings"
        description: "Update user chat settings"
        request_body:
          language: "string"
          translation_enabled: "boolean"
          profanity_filter: "boolean"
          sound_notifications: "boolean"
        response: "updated settings"

  websocket_api:
    connection_endpoint: "/ws/chat"
    authentication: "JWT token in query params"

    events:
      # Connection Events
      - event: "chat:connect"
        direction: "client->server"
        payload: "user_id: uuid"
        response: "user channels and state"

      # Message Events
      - event: "chat:message"
        direction: "client->server"
        payload: "channel_id: uuid, content: string, type: string"
        broadcast: "channel members"

      - event: "chat:message:new"
        direction: "server->clients"
        payload: "message: full message object"

      - event: "chat:message:deleted"
        direction: "server->clients"
        payload: "message_id: uuid, reason: string"

      # Channel Events
      - event: "chat:channel:joined"
        direction: "server->clients"
        payload: "channel_id: uuid, user: user object"

      - event: "chat:channel:left"
        direction: "server->clients"
        payload: "channel_id: uuid, user_id: uuid"

      # Moderation Events
      - event: "chat:user:banned"
        direction: "server->clients"
        payload: "user_id: uuid, channel_id: uuid, duration: integer"

      - event: "chat:user:unbanned"
        direction: "server->clients"
        payload: "user_id: uuid, channel_id: uuid"

      # Voice Events
      - event: "chat:voice:user-joined"
        direction: "server->clients"
        payload: "user: user object, channel_id: uuid"

      - event: "chat:voice:user-left"
        direction: "server->clients"
        payload: "user_id: uuid, channel_id: uuid"

      - event: "chat:voice:user-muted"
        direction: "server->clients"
        payload: "user_id: uuid, muted: boolean"

      # System Events
      - event: "chat:system:notification"
        direction: "server->clients"
        payload: "type: string, message: string, data: object"

  event_bus_contracts:
    published_events:
      - event: "chat.message.sent"
        payload: "message: full message object, channel: channel object"
        routing_key: "chat.messages"

      - event: "chat.user.banned"
        payload: "user_id: uuid, moderator_id: uuid, reason: string"
        routing_key: "chat.moderation"

      - event: "chat.channel.created"
        payload: "channel: full channel object"
        routing_key: "chat.channels"

      - event: "chat.voice.session.started"
        payload: "channel_id: uuid, participants: array"
        routing_key: "chat.voice"

    consumed_events:
      - event: "user.online"
        source: "character-service"
        action: "Update user chat status"

      - event: "party.created"
        source: "party-service"
        action: "Create party voice/text channels"

      - event: "guild.member.joined"
        source: "guild-service"
        action: "Grant guild channel access"

      - event: "moderation.violation"
        source: "moderation-service"
        action: "Apply chat sanctions"
