# Issue: #172
metadata:
  id: chat-system-features
  title: Функциональные системы чата
  document_type: architecture
  category: features
  status: draft
  version: '1.0.0'
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - chat
    - features
    - channels
    - moderation
summary:
  goal: Описать функциональные системы каналов, модерации и форматирования.
content:
  sections:
    - id: channel-system
      title: Система каналов
      body: |
        ## Типы каналов

        ### Глобальные каналы
        - **GLOBAL**: Общий чат сервера (max 500 символов, cooldown 5 сек)
        - **TRADE**: Торговый чат (max 300 символов, cooldown 10 сек)
        - **NEWBIE**: Чат для новичков (max 200 символов, cooldown 3 сек)

        ### Локальные каналы
        - **LOCAL**: Чат зоны (радиус 100м, max 200 символов)
        - **INSTANCE**: Чат инстанса (текущий данжон/рейд)
        - **AREA**: Чат района города

        ### Групповые каналы
        - **PARTY**: Группа (2-5 игроков)
        - **RAID**: Рейд (6-40 игроков)
        - **GUILD**: Гильдия (до 100 игроков)

        ### Приватные каналы
        - **WHISPER**: Личное сообщение
        - **SYSTEM**: Системные уведомления

        ### Боевые каналы
        - **COMBAT_LOG**: Лог боя
        - **RP_EMOTE**: Ролевые эмоции

        ## Управление правами
        ```json
        {
          "read": true,
          "write": true,
          "moderate": false,
          "invite": true,
          "kick": false
        }
        ```
      mechanics_links: [ ]
      assets: [ ]

    - id: moderation-system
      title: Система модерации
      body: |
        ## Фильтры контента

        ### Profanity Filter
        - Список запрещенных слов
        - Whitelist разрешенных URL
        - Нормализация регистра
        - Замена повторяющихся символов

        ### Spam Detection
        - Rate limiting: max 10 сообщений/минуту
        - Duplicate detection
        - Pattern recognition

        ## Система банов
        - **TEXT_MUTE**: Запрет на текстовый чат
        - **CHANNEL_BAN**: Бан в конкретном канале
        - **GLOBAL_BAN**: Полный бан чата

        ## Авто-баны
        - 3 нарушения → 1 час mute
        - 5 нарушений → 24 часа ban
        - 10 нарушений → permanent ban
      mechanics_links: [ ]
      assets: [ ]

    - id: formatting-system
      title: Система форматирования
      body: |
        ## Rich Formatting
        ```
        **bold text** → <strong>bold text</strong>
        *italic text* → <em>italic text</em>
        `code` → <code>code</code>
        :smile: → [EMOJI]
        @username → <span class="mention">@username</span>
        ```

        ## Slash-команды
        ```
        /w username message    - Личное сообщение
        /r message            - Ответить на последнее сообщение
        /party message        - Сообщение группе
        /help                 - Справка
        /ignore username      - Игнорировать пользователя
        /report username      - Пожаловаться
        ```
      mechanics_links: [ ]
      assets: [ ]

    - id: history-system
      title: Система истории сообщений
      body: |
        ## Хранение данных
        - **Redis**: Последние 1000 сообщений на канал (TTL 24 часа)
        - **PostgreSQL**: Полная история (удаление через 30 дней)

        ## Пагинация
        ```
        GET /api/v1/chat/history/{channelId}?before=msg_123&limit=50
        ```

        ## Поиск и фильтрация
        - Поиск по тексту сообщений
        - Фильтрация по пользователю
        - Фильтрация по времени
      mechanics_links: [ ]
      assets: [ ]

    - id: data-flows
      title: Потоки данных
      body: |
        ## Отправка сообщения
        1. Клиент → chat-core-service
        2. Валидация через chat-moderation-service
        3. Форматирование текста
        4. Определение получателей через chat-channel-service
        5. Сохранение через chat-history-service
        6. Отправка через WebSocket

        ## Модерация
        1. Проверка запрещенных слов
        2. Анализ спама через Redis
        3. Авто-бан при нарушениях
        4. Уведомление модераторов
      mechanics_links: [ ]
      assets: [ ]
implementation:
  github_issue: 172