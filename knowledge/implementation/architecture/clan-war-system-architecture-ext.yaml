          - defender_clan_id: UUID (FK guilds)
          - status: ENUM (DECLARED, PREPARATION, ACTIVE, ENDING, ENDED)
          - phase: ENUM (PREPARATION, ACTIVE, ENDING)
          - attacker_score: INTEGER (default: 0)
          - defender_score: INTEGER (default: 0)
          - winner_clan_id: UUID (FK guilds, nullable)
          - allies_attacker: UUID[] (FK guilds)
          - allies_defender: UUID[] (FK guilds)
          - declared_at: TIMESTAMP
          - preparation_started_at: TIMESTAMP (nullable)
          - active_started_at: TIMESTAMP (nullable)
          - ended_at: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - attacker_clan_id, status
          - defender_clan_id, status
          - status, active_started_at

      - name: war_battles
        description: Битвы в войне
        fields:
          - id: UUID (PK)
          - war_id: UUID (FK clan_wars)
          - battle_type: ENUM (TERRITORY_BATTLE, SIEGE, OPEN_WORLD_PVP)
          - territory_id: UUID (FK territories, nullable)
          - status: ENUM (CREATED, ACTIVE, ENDED)
          - attacker_score: INTEGER (default: 0)
          - defender_score: INTEGER (default: 0)
          - started_at: TIMESTAMP (nullable)
          - ended_at: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
        indexes:
          - war_id, status
          - territory_id, status
          - status, started_at

      - name: territories
        description: Территории
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - owner_clan_id: UUID (FK guilds, nullable)
          - resource_type: ENUM (ORE, ENERGY, DATA, MIXED)
          - resource_amount: INTEGER (default: 0)
          - defense_level: INTEGER (default: 1)
          - siege_difficulty: INTEGER (default: 1)
          - location_x: FLOAT
          - location_y: FLOAT
          - location_z: FLOAT
          - is_active: BOOLEAN (default: true)
          - captured_at: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - owner_clan_id
          - is_active
          - location_x, location_y, location_z

      - name: war_participants
        description: Участники войны
        fields:
          - id: UUID (PK)
          - war_id: UUID (FK clan_wars)
          - clan_id: UUID (FK guilds)
          - role: ENUM (ATTACKER, DEFENDER, ALLY_ATTACKER, ALLY_DEFENDER)
          - kills: INTEGER (default: 0)
          - deaths: INTEGER (default: 0)
          - score_contribution: INTEGER (default: 0)
          - joined_at: TIMESTAMP
        constraints: |
          - UNIQUE(war_id, clan_id)
        indexes:
          - war_id, clan_id
          - clan_id

      - name: war_kill_logs
        description: Логи убийств в войне
        fields:
          - id: UUID (PK)
          - war_id: UUID (FK clan_wars)
          - battle_id: UUID (FK war_battles, nullable)
          - killer_id: UUID (FK accounts)
          - victim_id: UUID (FK accounts)
          - killer_clan_id: UUID (FK guilds)
          - victim_clan_id: UUID (FK guilds)
          - score_awarded: INTEGER
          - killed_at: TIMESTAMP
        indexes:
          - war_id, killed_at
          - battle_id, killed_at
          - killer_clan_id, killed_at

technical_specification:
  backend_requirements:
    - Реализация модулей в world-service-go:
      - clan-war (управление войнами)
      - clan-war-phases (фазы)
      - clan-war-territory (территории)
      - clan-war-battle (битвы)
      - clan-war-scoring (очки)
      - clan-war-rewards (награды)
      - clan-war-alliance (союзы)
      - clan-war-events (события)
    - Интеграция с guild-service для кланов
    - Интеграция с gameplay-service для боёв
    - Интеграция с economy-service для наград
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация состояния войны через WebSocket
    - Уведомления о событиях войны
    - Обновления очков в реальном времени

  performance_requirements:
    - Объявление войны < 200ms
    - Создание битвы < 100ms
    - Начисление очков < 50ms
    - Завершение войны < 500ms
    - Поддержка до 100 активных войн
    - Поддержка до 1K активных битв

  scalability_requirements:
    - Горизонтальное масштабирование через world-service
    - Распределение нагрузки на войны
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование активных войн в Redis

subtasks:
  - id: war-manager-module
    title: Реализация модуля War Manager
    description: |
      Управление клановыми войнами
      Объявление войны
      Завершение войны
    priority: high
    estimated_time: 4-5 дней

  - id: war-phase-controller-implementation
    title: Реализация War Phase Controller
    description: |
      Управление фазами войны
      Переходы между фазами
      Планирование фаз
    priority: high
    estimated_time: 3-4 дня

  - id: territory-manager
    title: Реализация Territory Manager
    description: |
      Управление территориями
      Владение территориями
      Защита территорий
    priority: high
    estimated_time: 4-5 дней

  - id: battle-manager
    title: Реализация Battle Manager
    description: |
      Управление сражениями
      Создание битв
      Трекинг активных битв
    priority: high
    estimated_time: 4-5 дней

  - id: score-calculator
    title: Реализация Score Calculator
    description: |
      Расчёт очков войны
      Начисление очков за действия
      Определение победителя
    priority: high
    estimated_time: 3-4 дня

  - id: reward-distributor
    title: Реализация Reward Distributor
    description: |
      Распределение наград за войну
      Выдача наград победителю
      Интеграция с economy service
    priority: high
    estimated_time: 3-4 дня

  - id: alliance-manager
    title: Реализация Alliance Manager
    description: |
      Управление союзами в войне
      Приглашение союзников
      Управление союзниками
    priority: high
    estimated_time: 3-4 дня

  - id: war-event-handler
    title: Реализация War Event Handler
    description: |
      Обработка событий войны
      Публикация событий
      Подписка на события
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование активных войн
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для клановых войн
      Интеграция с существующим API world-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты объявления войны
      Тесты фаз войны
      Тесты битв
      Тесты наград
      Тесты интеграций
    priority: high
    estimated_time: 4-5 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "World Service"
            WM[War Manager]
            WPC[War Phase Controller]
            TM[Territory Manager]
            BM[Battle Manager]
            SC[Score Calculator]
            RD[Reward Distributor]
            AM[Alliance Manager]
            WEH[War Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>clan_wars<br/>war_battles<br/>territories<br/>war_participants<br/>war_kill_logs)]
        end

        subgraph "External Services"
            GS[Guild Service]
            WS[World Service]
            GMS[Gameplay Service]
            ES[Economy Service]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|declare war| WM
        WM --> GS
        WM --> WPC
        WPC --> BM
        BM --> TM
        BM --> GMS
        GMS --> SC
        SC --> RD
        RD --> ES
        AM --> GS
        WEH --> NS
        WEH --> RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Clan
        participant WM as War Manager
        participant WPC as War Phase Controller
        participant BM as Battle Manager
        participant SC as Score Calculator
        participant RD as Reward Distributor

        C->>WM: Declare war
        WM->>WPC: Start preparation phase
        WPC->>WPC: Wait 24 hours
        WPC->>BM: Start active phase
        BM->>BM: Create battles
        BM->>SC: Award scores
        SC->>SC: Calculate winner
        SC->>RD: Distribute rewards
        RD->>RD: Send rewards
    ```

decisions:
  - id: adr-clan-war-architecture
    summary: |
      Выбрана модульная архитектура внутри world-service-go для обеспечения
      тесной интеграции с территориальной системой.

  - id: adr-war-phases
    summary: |
      Система фаз войны (подготовка, активная фаза, завершение) обеспечивает
      структурированный процесс и даёт игрокам время на подготовку.

  - id: adr-territory-system
    summary: |
      Система территорий с ресурсами и защитой создаёт стратегический элемент
      и мотивирует игроков участвовать в войнах.

  - id: adr-scoring-system
    summary: |
      Многоуровневая система очков (битвы, осады, убийства) обеспечивает
      справедливое определение победителя и учитывает различные типы активности.

  - id: adr-alliance-system
    summary: |
      Система союзов позволяет кланам объединяться для крупных войн и создаёт
      социальный элемент в PvP контенте.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата фаз и событий

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния клановых войн
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (объявление войны, завершение войны, распределение наград)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для войн, битв, очков, территорий, наград и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы клановых войн:
      - Определены компоненты (War Manager, War Phase Controller, Territory Manager, Battle Manager, Score Calculator, Reward Distributor, Alliance Manager, War Event Handler)
      - Описаны фазы войны (PREPARATION 24ч, ACTIVE 7 дней, ENDING)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (clan_wars, war_battles, territories, war_participants, war_kill_logs)
      - Спроектирована система фаз войны
      - Спроектирована система управления территориями
      - Спроектирована система сражений
      - Спроектирована система наград
      - Создано техническое задание
      - Разбито на подзадачи


