metadata:
  id: clan-war-system-architecture
  title: Архитектура системы клановых войн (Clan War System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T20:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - clan-war
    - backend
    - pvp
    - territory
  related_systems:
    - guild-service-go
    - world-service-go
    - gameplay-service-go
    - economy-service-go
  related_documents:
    - id: backend-clan-war-system
      relation: extends
  github_issue: 290
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы клановых войн
    для управления войнами между кланами, территориями, фазами войны, сражениями
    и наградами для endgame PvP контента.
  goal: |
    Создать архитектурную схему системы клановых войн с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы фаз войны
    - Системы управления территориями
    - Системы сражений
    - Системы наград
    - Технического задания для реализации
  essence: |
    Игровая система клановых войн для управления войнами между кланами, территориями
    и endgame PvP контентом.

architecture:
  overview: |
    Система клановых войн состоит из восьми основных компонентов:
    1. War Manager - управление войнами
    2. War Phase Controller - управление фазами войны
    3. Territory Manager - управление территориями
    4. Battle Manager - управление сражениями
    5. Score Calculator - расчёт очков
    6. Reward Distributor - распределение наград
    7. Alliance Manager - управление союзами
    8. War Event Handler - обработка событий войны

  components:
    - name: War Manager
      location: world-service-go (модуль clan-war)
      responsibility: |
        - Управление клановыми войнами
        - Объявление войны
        - Завершение войны
        - Управление участниками войны
        - Интеграция с guild service
      war_lifecycle: |
        - DECLARED: война объявлена
        - PREPARATION: фаза подготовки
        - ACTIVE: активная фаза
        - ENDING: завершение
        - ENDED: война завершена
      war_requirements: |
        - Минимальный размер кланов
        - Cooldown между войнами
        - Проверка текущего состояния
      endpoints:
        - POST /api/v1/world/clan-war/declare - объявление войны
        - GET /api/v1/world/clan-war/{war_id} - информация о войне
        - GET /api/v1/world/clan-war/active - активные войны
        - POST /api/v1/world/clan-war/{war_id}/cancel - отмена войны

    - name: War Phase Controller
      location: world-service-go (модуль clan-war-phases)
      responsibility: |
        - Управление фазами войны
        - Переходы между фазами
        - Планирование фаз
        - Уведомления о смене фаз
      war_phases: |
        - PREPARATION: фаза подготовки (24 часа)
        - ACTIVE: активная фаза (7 дней)
        - ENDING: фаза завершения (немедленно)
      phase_transitions: |
        - DECLARED -> PREPARATION (автоматически через 1 час)
        - PREPARATION -> ACTIVE (через 24 часа)
        - ACTIVE -> ENDING (через 7 дней)
        - ENDING -> ENDED (после подсчёта очков)
      endpoints:
        - GET /api/v1/world/clan-war/{war_id}/phase - текущая фаза
        - POST /api/v1/world/clan-war/{war_id}/phase/transition - переход фазы (admin)

    - name: Territory Manager
      location: world-service-go (модуль clan-war-territory)
      responsibility: |
        - Управление территориями
        - Владение территориями
        - Защита территорий
        - Ресурсы территорий
        - Сложность осады
      territory_features: |
        - Владение кланом
        - Ресурсы территории
        - Уровень защиты
        - Сложность осады
        - Бонусы владения
      territory_transfer: |
        - Передача территории победителю
        - Сброс защиты
        - Обновление ресурсов
      endpoints:
        - GET /api/v1/world/clan-war/territories - список территорий
        - GET /api/v1/world/clan-war/territories/{territory_id} - информация о территории
        - POST /api/v1/world/clan-war/territories/{territory_id}/transfer - передача территории

    - name: Battle Manager
      location: world-service-go (модуль clan-war-battle)
      responsibility: |
        - Управление сражениями
        - Создание битв за территории
        - Запуск битв
        - Трекинг активных битв
        - Интеграция с PvP системой
      battle_types: |
        - TERRITORY_BATTLE: битва за территорию
        - SIEGE: осада территории
        - OPEN_WORLD_PVP: открытый мир PvP
      battle_lifecycle: |
        - CREATED: битва создана
        - ACTIVE: битва активна
        - ENDED: битва завершена
      endpoints:
        - POST /api/v1/world/clan-war/battles/create - создание битвы
        - POST /api/v1/world/clan-war/battles/{battle_id}/start - запуск битвы
        - GET /api/v1/world/clan-war/battles/active - активные битвы
        - POST /api/v1/world/clan-war/battles/{battle_id}/end - завершение битвы

    - name: Score Calculator
      location: world-service-go (модуль clan-war-scoring)
      responsibility: |
        - Расчёт очков войны
        - Начисление очков за действия
        - Агрегация очков
        - Определение победителя
      score_sources: |
        - Territory battles: очки за битвы за территории
        - Siege events: очки за осады
        - Kill score: очки за убийства
        - Territory control: очки за контроль территорий
      scoring_rules: |
        - Взвешивание различных источников очков
        - Бонусы за территориальный контроль
        - Штрафы за потери
      endpoints:
        - GET /api/v1/world/clan-war/{war_id}/scores - очки войны
        - POST /api/v1/world/clan-war/scores/add - начисление очков
        - GET /api/v1/world/clan-war/{war_id}/winner - победитель войны

    - name: Reward Distributor
      location: world-service-go (модуль clan-war-rewards)
      responsibility: |
        - Распределение наград за войну
        - Выдача наград победителю
        - Выдача утешительных призов
        - Интеграция с economy service
      reward_types: |
        - Winner rewards: награды победителя
        - Loser rewards: утешительные призы
        - Participation rewards: награды за участие
      reward_distribution: |
        - Награды за победу
        - Награды за участие
        - Награды за территориальный контроль
      endpoints:
        - POST /api/v1/world/clan-war/{war_id}/rewards/distribute - распределение наград
        - GET /api/v1/world/clan-war/{war_id}/rewards - награды войны

    - name: Alliance Manager
      location: world-service-go (модуль clan-war-alliance)
      responsibility: |
        - Управление союзами в войне
        - Приглашение союзников
        - Управление союзниками
        - Интеграция с guild service
      alliance_features: |
        - Приглашение союзников
        - Управление союзниками
        - Ограничения на союзы
        - Бонусы за союзы
      endpoints:
        - POST /api/v1/world/clan-war/{war_id}/alliance/invite - приглашение союзника
        - GET /api/v1/world/clan-war/{war_id}/alliance - союзники войны
        - POST /api/v1/world/clan-war/{war_id}/alliance/remove - удаление союзника

    - name: War Event Handler
      location: world-service-go (модуль clan-war-events)
      responsibility: |
        - Обработка событий войны
        - Публикация событий в event bus
        - Подписка на события от других систем
        - Уведомления игроков
      war_events_published: |
        - clan-war:declared
        - clan-war:phase-changed
        - clan-war:battle-started
        - clan-war:battle-ended
        - clan-war:territory-captured
        - clan-war:ended
        - clan-war:rewards-distributed
      war_events_consumed: |
        - combat:player-killed
        - territory:captured
        - guild:member-joined
      endpoints:
        - GET /api/v1/world/clan-war/events/{war_id} - события войны

  data_flow:
    war_declaration: |
      1. Клан объявляет войну другому клану
      2. War Manager проверяет требования (размер, cooldown)
      3. Создаётся запись войны (DECLARED)
      4. Alliance Manager обрабатывает союзников
      5. War Phase Controller планирует фазы
      6. War Event Handler публикует clan-war:declared
      7. Notification Service уведомляет кланы
      8. Realtime Gateway синхронизирует состояние

    war_phase_transition: |
      1. War Phase Controller проверяет время
      2. Если время истекло - переход на следующую фазу
      3. Обновляется состояние войны
      4. Если переход в ACTIVE - запускаются битвы
      5. Если переход в ENDING - рассчитываются очки
      6. War Event Handler публикует clan-war:phase-changed
      7. Notification Service уведомляет участников

    territory_battle: |
      1. Battle Manager создаёт битву за территорию
      2. Битва запускается (ACTIVE)
      3. Игроки вступают в PvP зону
      4. Combat Service обрабатывает убийства
      5. Score Calculator начисляет очки
      6. При захвате территории - обновляется владение
      7. War Event Handler публикует clan-war:territory-captured
      8. Realtime Gateway синхронизирует состояние

    war_resolution: |
      1. War Phase Controller переводит войну в ENDING
      2. Score Calculator рассчитывает итоговые очки
      3. Определяется победитель
      4. Territory Manager передаёт территории победителю
      5. Reward Distributor распределяет награды
      6. Economy Service получает награды
      7. War Event Handler публикует clan-war:ended
      8. Notification Service уведомляет участников

  integrations:
    with_guild_service: |
      - Получение информации о кланах
      - Проверка размера кланов
      - Синхронизация с гильдиями
      - Уведомления участников кланов

    with_world_service: |
      - Управление территориями
      - Позиционирование PvP зон
      - Пространственные данные

    with_gameplay_service: |
      - Получение событий о боях
      - Интеграция с combat system
      - Обработка убийств

    with_economy_service: |
      - Выдача наград
      - Интеграция с экономической системой
      - Обновление ресурсов территорий

    with_notification_service: |
      - Уведомления о войнах
      - Уведомления о битвах
      - Уведомления о наградах

    with_realtime_gateway: |
      - Синхронизация состояния войны
      - Уведомления о событиях
      - Обновления в реальном времени

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для объявления войны, создания битв, начисления очков и распределения наград
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед объявлением войны и созданием битв
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (объявление войны, завершение войны, распределение наград)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния клановых войн (объявление войны, переход фаз, создание битв, начисление очков,
      захват территорий, завершение войны, распределение наград) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: WarDeclaredEvent, PhaseChangedEvent, BattleStartedEvent, TerritoryCapturedEvent, WarEndedEvent, RewardsDistributedEvent.
    cqrs_pattern: |
      Разделение команд (объявление войны, создание битв, начисление очков, распределение наград) и запросов
      (получение информации о войне, получение очков, получение наград) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как объявление войны (проверка требований, создание войны,
      настройка фаз, уведомление участников) или завершение войны (расчёт очков, определение победителя,
      передача территорий, распределение наград, уведомление участников), используется Saga Pattern
      для обеспечения атомарности операций между World Service, Guild Service, Economy Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    war_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Объявление войны: event-based, ~0.001-0.01 events/sec
        - Переход фаз: event-based, ~0.001-0.01 events/sec
        - Завершение войны: event-based, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.5 KB/sec для операций войны
      latency_requirements: < 200-500ms для объявления войны, < 100-300ms для перехода фаз
      sync_strategy: Strong Consistency (ACID транзакции) для операций войны

    battle_operations:
      tickrate: Event-based (on-demand) + 20-60 Hz для активных битв
      network_load: |
        - Создание битвы: event-based, ~0.01-0.1 events/sec
        - Запуск битвы: event-based, ~0.01-0.1 events/sec
        - Завершение битвы: event-based, ~0.01-0.1 events/sec
        - Обновление состояния битвы: 20-60 Hz, ~0.5-2 KB/sec на битву
        - Общий трафик: ~0.2-1 KB/sec для операций битвы, ~0.5-2 KB/sec для активных битв
      latency_requirements: < 100-200ms для создания битвы, < 50-100ms для обновления состояния
      sync_strategy: Strong Consistency (ACID транзакции) для создания битв, Eventual Consistency для обновлений состояния

    scoring_operations:
      tickrate: Event-based (on-demand при событиях)
      network_load: |
        - Начисление очков: event-based, ~0.1-1 events/sec на войну
        - Получение очков: event-based, ~0.01-0.05 requests/sec на войну
        - Обновление очков: event-based + 1-5 Hz, ~0.1-0.3 KB/sec на войну
        - Общий трафик: ~0.2-0.5 KB/sec для операций очков
      latency_requirements: < 50-100ms для начисления очков, < 30-100ms для получения очков
      sync_strategy: Strong Consistency (ACID транзакции) для начисления очков

    territory_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Захват территории: event-based, ~0.01-0.05 events/sec
        - Получение информации о территории: event-based, ~0.01-0.02 requests/sec
        - Обновление ресурсов: event-based + 1-5 Hz, ~0.05-0.2 KB/sec на территорию
        - Общий трафик: ~0.1-0.3 KB/sec для операций территорий
      latency_requirements: < 100-200ms для захвата территории, < 30-100ms для получения информации
      sync_strategy: Strong Consistency (ACID транзакции) для захвата территорий

    reward_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Распределение наград: event-based, ~0.001-0.01 events/sec на войну
        - Получение наград: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.2 KB/sec для операций наград
      latency_requirements: < 200-500ms для распределения наград, < 50-150ms для получения наград
      sync_strategy: Strong Consistency (ACID транзакции) для распределения наград

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий войны: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_schema:
    tables:
      - name: clan_wars
        description: Клановые войны
        fields:
          - id: UUID (PK)
          - attacker_clan_id: UUID (FK guilds)
