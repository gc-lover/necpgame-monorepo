metadata:
  id: arch-clan-war-system
  title: 'Архитектура системы клановых войн - Clan War System Architecture'
  document_type: architecture
  category: backend
  status: draft
  version: '1.0.0'
  last_updated: '2025-12-28T12:00:00Z'
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: backend_architect
      contact: backend@necp.game
  tags:
    - clan-war
    - architecture
    - backend
    - mmofps
  topics:
    - system-architecture
    - game-mechanics
  related_systems:
    - clan-service
    - territory-service
    - battle-service
  related_documents:
    - id: arch-backend-optimization-guide
      relation: references
    - id: arch-database-scaling-guide
      relation: references
  source: shared/docs/knowledge/implementation/architecture/clan-war-system-architecture.yaml
  visibility: internal
  audience:
    - backend
    - architect
    - qa
  risk_level: medium

summary:
  problem: Необходима масштабируемая архитектура системы клановых войн для MMOFPS игры с поддержкой тысяч одновременных войн
  goal: Спроектировать высокопроизводительную систему клановых войн с оптимизациями для 10k+ одновременных игроков
  essence: Архитектура обеспечивает конкурентные войны между кланами с территориальным контролем, боями и статистикой
  key_points:
    - Высокая производительность для MMOFPS
    - Масштабируемость до 1000+ одновременных войн
    - Оптимизированные запросы к БД
    - Real-time синхронизация состояния войн

content:
  overview:
    title: Обзор архитектуры
    description: |
      Система клановых войн предоставляет инфраструктуру для конкурентных войн между кланами игроков.
      Архитектура оптимизирована для MMOFPS с поддержкой тысяч одновременных войн и боев.

  architecture:
    layers:
      - name: Presentation Layer
        description: HTTP API с REST endpoints для управления войнами
        technologies:
          - Go with Chi router
          - OpenAPI 3.0 specification
          - JSON responses
        responsibilities:
          - REST API endpoints
          - Request validation
          - Response formatting

      - name: Business Logic Layer
        description: Бизнес-логика клановых войн с оптимизациями производительности
        technologies:
          - Go services
          - Memory pooling
          - Context timeouts
        responsibilities:
          - War lifecycle management
          - Battle coordination
          - Territory control logic

      - name: Data Access Layer
        description: Оптимизированный доступ к данным с connection pooling
        technologies:
          - PostgreSQL with pgx driver
          - Connection pooling
          - Prepared statements
        responsibilities:
          - CRUD operations
          - Transaction management
          - Query optimization

    components:
      - name: ClanWarService
        description: Основной сервис управления войнами
        responsibilities:
          - Создание и управление войнами
          - Координация боев
          - Расчет результатов
        performance_features:
          - Memory pooling для объектов войны
          - Context timeouts для всех операций
          - Optimized struct alignment

      - name: ClanWarRepository
        description: Репозиторий данных клановых войн
        responsibilities:
          - Хранение состояния войн
          - Управление битвами
          - Статистика территорий
        performance_features:
          - Connection pooling (25 max connections)
          - Prepared statements
          - Batch operations

      - name: TerritoryService
        description: Сервис управления территориями
        responsibilities:
          - Контроль владения территориями
          - Расчет влияния кланов
          - Географическая логика
        performance_features:
          - Spatial indexing
          - Cached territory data
          - Optimized queries

  data_model:
    entities:
      - name: ClanWar
        description: Основная сущность войны между кланами
        fields:
          - id: UUID первичный ключ
          - clan_id_1: UUID первого клана
          - clan_id_2: UUID второго клана
          - status: Статус войны (pending/active/completed/cancelled)
          - territory_id: ID территории конфликта
          - start_time/end_time: Временные рамки
          - winner_clan_id: Победитель
          - score_clan1/score_clan2: Очки кланов
        indexes:
          - clan_id_1, clan_id_2
          - status, start_time
          - territory_id

      - name: Battle
        description: Отдельный бой в рамках войны
        fields:
          - id: UUID первичный ключ
          - war_id: ID родительской войны
          - territory_id: ID территории боя
          - status: Статус боя
          - start_time/end_time: Время боя
          - winner_clan_id: Победитель боя
          - score_clan1/score_clan2: Очки в бое
        indexes:
          - war_id, status
          - territory_id, start_time

      - name: Territory
        description: Контролируемая территория
        fields:
          - id: UUID первичный ключ
          - name: Название территории
          - description: Описание
          - type: Тип (resource/strategic/commercial)
          - owner_clan_id: Владеющий клан
        indexes:
          - owner_clan_id
          - type

  performance_optimizations:
    memory_management:
      - Object pooling для ClanWar/Battle/Territory объектов
      - Zero-allocation operations где возможно
      - Optimized struct alignment (48-byte boundary)

    database_optimizations:
      - Connection pooling (25 max connections)
      - Prepared statements для всех запросов
      - Strategic indexing по часто используемым полям
      - Batch operations для массовых обновлений

    caching_strategy:
      - In-memory cache для активных войн
      - Redis для распределенного состояния
      - LRU eviction для territory data

    concurrency_patterns:
      - Context timeouts для всех операций (30s default)
      - Goroutine pooling для parallel operations
      - Mutex-free operations где возможно

  scalability:
    horizontal_scaling:
      - Stateless service instances
      - Database read replicas
      - Sharded territory data

    vertical_scaling:
      - CPU optimization через memory pooling
      - Memory optimization через object reuse
      - I/O optimization через connection pooling

    monitoring:
      - Prometheus metrics
      - Jaeger tracing
      - Custom performance counters

  security:
    authorization:
      - Clan membership verification
      - Territory ownership validation
      - War declaration permissions

    rate_limiting:
      - War declaration limits
      - API rate limits per clan
      - Battle creation throttling

    audit:
      - War action logging
      - Territory transfer tracking
      - Score manipulation detection

  deployment:
    infrastructure:
      - Kubernetes deployment
      - PostgreSQL database
      - Redis cache cluster

    configuration:
      - Environment-based config
      - Secrets management
      - Feature flags

  testing:
    unit_tests:
      - Service layer testing
      - Repository layer testing
      - Handler layer testing

    integration_tests:
      - Full war lifecycle
      - Multi-clan scenarios
      - Performance under load

    load_testing:
      - 1000 concurrent wars
      - 10000 simultaneous battles
      - Peak traffic simulation

  maintenance:
    migration_strategy:
      - Zero-downtime deployments
      - Backward compatibility
      - Data migration scripts

    monitoring_alerts:
      - War creation rate anomalies
      - Database connection issues
      - Memory usage spikes

review:
  chain:
    - role: backend_architect
      reviewer: ''
      reviewed_at: ''
      status: pending
    - role: performance_engineer
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions:
    - Создать детальную API спецификацию
    - Реализовать базовые CRUD операции
    - Настроить мониторинг и метрики