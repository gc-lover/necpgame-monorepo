metadata:
  id: combat-ai-enemies-architecture
  title: Архитектура системы боевого AI врагов
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T18:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - combat
    - ai
    - enemies
    - raids
    - telemetry
  related_systems:
    - gameplay-service
    - world-service
    - analytics-service
    - economy-service
    - social-service
  related_documents:
    - id: mechanics-combat-ai-enemies
      relation: implements
    - id: analysis-2025-11-09-combat-ai-package
      relation: extends
  github_issue: 157
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы боевого AI врагов, включающую:
    - Профили AI врагов с различными слоями сложности (Street, Tactical, Mythic, Raid)
    - Рейдовые сценарии с фазами и механиками боссов
    - Телеметрию и балансировку AI
    - Интеграцию с combat session, world events и аналитикой
  goal: |
    Создать архитектурную схему системы боевого AI с определением:
    - Компонентов для управления AI врагами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Объединенная архитектура системы боевого AI с поддержкой профилей врагов,
    рейдовых сценариев, телеметрии и балансировки.

architecture:
  overview: |
    Архитектура системы боевого AI состоит из следующих компонентов:
    1. AI Profile Manager - управление профилями AI врагов
    2. AI Behavior Engine - движок поведения AI (Behaviour Tree + Utility AI)
    3. Raid Manager - управление рейдовыми сценариями
    4. Boss Phase Controller - управление фазами боссов
    5. AI Telemetry Collector - сбор телеметрии AI
    6. AI Balance Tuner - автотюнинг баланса AI
    7. Encounter Manager - управление встречами с врагами

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка боевого AI:
        - Управление профилями AI врагов
        - Обработка поведения AI
        - Управление рейдами и фазами боссов
        - Сбор телеметрии
        - Балансировка AI
      components:
        - ai-profile-manager: управление профилями AI
        - ai-behavior-engine: движок поведения AI
        - raid-manager: управление рейдами
        - boss-phase-controller: управление фазами боссов
        - ai-telemetry-collector: сбор телеметрии
        - ai-balance-tuner: автотюнинг баланса
        - encounter-manager: управление встречами
      endpoints:
        - GET /api/v1/gameplay/combat/ai/profiles - список профилей AI
        - GET /api/v1/gameplay/combat/ai/profiles/{id} - информация о профиле
        - GET /api/v1/gameplay/combat/ai/profiles/{id}/telemetry - телеметрия профиля
        - POST /api/v1/gameplay/combat/raids/{raidId}/phase - переход фазы рейда
        - POST /api/v1/gameplay/combat/ai/encounter - создание встречи
        - GET /api/v1/gameplay/combat/ai/encounter/{encounterId} - информация о встрече
        - POST /api/v1/gameplay/combat/ai/encounter/{encounterId}/start - старт встречи
        - POST /api/v1/gameplay/combat/ai/encounter/{encounterId}/end - завершение встречи
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/raid/{raidId} - события рейда (PhaseStart, MechanicTrigger, PlayerDown, CheckRequired)
      events_published:
        - combat.ai.state: состояние AI врага
        - world.events.trigger: триггер мирового события
        - raid.telemetry: телеметрия рейда
        - raid.phase.started: начало фазы рейда
        - raid.phase.completed: завершение фазы рейда
        - raid.boss.defeated: поражение босса
        - encounter.started: начало встречи
        - encounter.completed: завершение встречи

  difficulty_layers:
    - name: street
      description: Уличные враги
      skill_level: "1-10"
      characteristics: |
        Базовые навыки, простая тактика, стандартное оружие
      unique_abilities: []
      lore_events: []

    - name: tactical
      description: Тактические враги
      skill_level: "11-20"
      characteristics: |
        Продвинутая тактика, сканы, адаптация, уникальные навыки фракций
      unique_abilities:
        - Urban Sweep
        - Sync Burst
        - Faction-specific abilities (Arasaka, Militech, Kang Tao, NetWatch, Voodoo Boys)
      lore_events: []

    - name: mythic
      description: Мифические враги
      skill_level: "21-30"
      characteristics: |
        Легендарные способности, сложные механики, уникальные сценарии
      unique_abilities:
        - Reality Tear
        - Legendary combos
      lore_events: []

    - name: raid
      description: Рейдовые враги
      skill_level: "31+"
      characteristics: |
        Многофазовые боссы, координация команды, уникальные механики рейдов
      unique_abilities:
        - Blackwall Expedition mechanics
        - Corpo Tower Assault mechanics
      lore_events:
        - Blackwall Expedition
        - Corpo Tower Assault

  data_flows:
    ai_encounter_flow: |
      1. Игрок входит в зону с врагами
      2. Encounter Manager создает встречу через POST /api/v1/gameplay/combat/ai/encounter
      3. AI Profile Manager загружает профили врагов
      4. AI Behavior Engine инициализирует поведение
      5. Encounter Manager запускает встречу через POST /api/v1/gameplay/combat/ai/encounter/{id}/start
      6. AI Behavior Engine обрабатывает поведение врагов
      7. Combat Session обрабатывает боевые действия
      8. AI Telemetry Collector собирает данные
      9. При завершении Encounter Manager завершает встречу
      10. Gameplay Service публикует событие encounter.completed

    raid_flow: |
      1. Команда игроков входит в рейд
      2. Raid Manager создает рейдовую сессию
      3. Boss Phase Controller инициализирует первую фазу
      4. Raid Manager публикует событие raid.phase.started
      5. Realtime Gateway отправляет событие PhaseStart через WebSocket
      6. Игроки сражаются с боссом
      7. Boss Phase Controller отслеживает прогресс фазы
      8. При выполнении условий Boss Phase Controller переходит к следующей фазе
      9. Raid Manager публикует событие raid.phase.completed
      10. При поражении босса Raid Manager публикует raid.boss.defeated
      11. Economy Service выдает награды
      12. Analytics Service логирует рейд

    ai_behavior_flow: |
      1. AI Behavior Engine получает состояние боя
      2. AI Behavior Engine оценивает ситуацию через Utility AI
      3. AI Behavior Engine выбирает действие через Behaviour Tree
      4. AI Behavior Engine выполняет действие (атака, способность, перемещение)
      5. Combat Session обрабатывает действие
      6. AI Behavior Engine обновляет состояние AI
      7. AI Telemetry Collector записывает действие
      8. Gameplay Service публикует событие combat.ai.state
      9. Realtime Gateway отправляет обновление клиентам

    balance_tuning_flow: |
      1. AI Telemetry Collector собирает данные за 24 часа
      2. AI Balance Tuner анализирует метрики (урон, время до падения, skill tests)
      3. AI Balance Tuner определяет дисбалансы
      4. AI Balance Tuner рассчитывает новые коэффициенты
      5. AI Balance Tuner обновляет профили AI
      6. AI Balance Tuner публикует событие ai.balance.updated
      7. Analytics Service логирует изменения баланса

  database_structure:
    tables:
      - name: enemy_ai_profiles
        description: Профили AI врагов
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - difficulty_layer: ENUM (street, tactical, mythic, raid)
          - skill_level_min: INTEGER
          - skill_level_max: INTEGER
          - behavior_tree: JSONB
          - utility_weights: JSONB
          - abilities: JSONB
          - loot_table_id: UUID
          - faction_id: UUID (nullable)
          - world_influence: JSONB
          - created_at: TIMESTAMP

      - name: enemy_ai_abilities
        description: Способности AI врагов
        columns:
          - id: UUID PRIMARY KEY
          - profile_id: UUID FOREIGN KEY
          - ability_name: VARCHAR(255)
          - ability_type: VARCHAR(100)
          - cooldown: INTEGER
          - damage: INTEGER
          - effects: JSONB
          - requirements: JSONB

      - name: raid_boss_phases
        description: Фазы рейдовых боссов
        columns:
          - id: UUID PRIMARY KEY
          - raid_id: UUID FOREIGN KEY
          - phase_number: INTEGER
          - phase_name: VARCHAR(255)
          - boss_profile_id: UUID FOREIGN KEY
          - mechanics: JSONB
          - health_threshold: INTEGER
          - transition_conditions: JSONB
          - rewards: JSONB

      - name: raid_sessions
        description: Сессии рейдов
        columns:
          - id: UUID PRIMARY KEY
          - raid_id: UUID FOREIGN KEY
          - current_phase: INTEGER
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)
          - status: ENUM (in_progress, completed, failed)
          - participants: JSONB

      - name: ai_encounters
        description: Встречи с AI врагами
        columns:
          - id: UUID PRIMARY KEY
          - encounter_type: VARCHAR(100)
          - profile_ids: JSONB
          - zone_id: UUID
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)
          - result: ENUM (victory, defeat, abandoned)

      - name: ai_telemetry
        description: Телеметрия AI
        columns:
          - id: UUID PRIMARY KEY
          - profile_id: UUID FOREIGN KEY
          - encounter_id: UUID FOREIGN KEY (nullable)
          - raid_id: UUID FOREIGN KEY (nullable)
          - damage_dealt: INTEGER
          - damage_taken: INTEGER
          - time_to_defeat: INTEGER
          - skill_tests_passed: INTEGER
          - skill_tests_failed: INTEGER
          - abilities_used: JSONB
          - timestamp: TIMESTAMP

      - name: ai_balance_coefficients
        description: Коэффициенты баланса AI
        columns:
          - id: UUID PRIMARY KEY
          - profile_id: UUID FOREIGN KEY
          - coefficient_type: VARCHAR(100)
          - value: DECIMAL(10,4)
          - updated_at: TIMESTAMP
          - tuning_reason: TEXT

  integrations:
    combat_session: |
      - AI враги участвуют в combat session
      - Обработка урона и способностей через Combat Session
      - Синхронизация состояния боя

    world_service: |
      - Триггеры мировых событий при поражении боссов
      - Влияние на состояние мира через world.events.trigger
      - Интеграция с фракциями и территориями

    economy_service: |
      - Генерация лута через loot tables
      - Выдача наград за рейды
      - Экономические модификаторы для AI

    analytics_service: |
      - Сбор телеметрии всех встреч
      - Анализ баланса и метрик
      - Детект эксплойтов и аномалий

    social_service: |
      - Координация команд в рейдах
      - Социальные бонусы для командных рейдов
      - Интеграция с гильдиями

    progression_service: |
      - Проверка требований для рейдов
      - Начисление опыта за победы
      - Обновление навыков на основе встреч

    realtime_gateway: |
      - Отправка realtime событий рейдов
      - Синхронизация состояния AI
      - Уведомления о фазах и механиках

technical_specification:
  subtasks:
    - id: ai-profile-manager
      title: Реализация менеджера профилей AI
      description: |
        Реализация AI Profile Manager с загрузкой профилей, фильтрацией по слоям сложности
        и управлением способностями врагов.
      dependencies: []
      estimated_effort: 4 days

    - id: ai-behavior-engine
      title: Реализация движка поведения AI
      description: |
        Реализация AI Behavior Engine с комбинацией Behaviour Tree и Utility AI,
        обработкой действий и синхронизацией с Combat Session.
      dependencies: [ai-profile-manager]
      estimated_effort: 7 days

    - id: raid-manager
      title: Реализация менеджера рейдов
      description: |
        Реализация Raid Manager с управлением рейдовыми сессиями, координацией игроков
        и интеграцией с World Service.
      dependencies: [ai-profile-manager]
      estimated_effort: 6 days

    - id: boss-phase-controller
      title: Реализация контроллера фаз боссов
      description: |
        Реализация Boss Phase Controller с управлением фазами, механиками боссов
        и переходами между фазами.
      dependencies: [raid-manager, ai-behavior-engine]
      estimated_effort: 5 days

    - id: encounter-manager
      title: Реализация менеджера встреч
      description: |
        Реализация Encounter Manager с созданием встреч, управлением жизненным циклом
        и интеграцией с AI Behavior Engine.
      dependencies: [ai-behavior-engine]
      estimated_effort: 4 days

    - id: ai-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация AI Telemetry Collector с сбором метрик, логированием действий
        и интеграцией с Analytics Service.
      dependencies: [ai-behavior-engine, encounter-manager]
      estimated_effort: 3 days

    - id: ai-balance-tuner
      title: Реализация автотюнера баланса
      description: |
        Реализация AI Balance Tuner с анализом метрик, расчетом коэффициентов
        и автоматическим обновлением баланса каждые 24 часа.
      dependencies: [ai-telemetry-collector]
      estimated_effort: 5 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime событий рейдов
        с поддержкой PhaseStart, MechanicTrigger, PlayerDown, CheckRequired.
      dependencies: [raid-manager, boss-phase-controller]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы AI.
      dependencies: [ai-behavior-engine, raid-manager, encounter-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для AI профилей, способностей, рейдов, встреч, телеметрии
        и баланса с миграциями Liquibase.
      dependencies: []
      estimated_effort: 2 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> GameplayService[Gameplay Service<br/>8083]
        
        GameplayService --> APM[AI Profile Manager]
        GameplayService --> ABE[AI Behavior Engine]
        GameplayService --> RM[Raid Manager]
        GameplayService --> BPC[Boss Phase Controller]
        GameplayService --> EMC[Encounter Manager]
        GameplayService --> ATC[AI Telemetry Collector]
        GameplayService --> ABT[AI Balance Tuner]
        
        ABE --> APM
        BPC --> RM
        EMC --> ABE
        ATC --> ABE
        ABT --> ATC
        
        GameplayService --> CombatSession[Combat Session]
        GameplayService --> WorldService[World Service]
        GameplayService --> EconomyService[Economy Service]
        GameplayService --> AnalyticsService[Analytics Service]
        GameplayService --> SocialService[Social Service]
        GameplayService --> ProgressionService[Progression Service]
        
        GameplayService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        GameplayService --> DB[(Gameplay DB)]
        
        Client --> WSRaid[WebSocket<br/>Raid Events]
        WSRaid --> GameplayService
    ```

  raid_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant RM as Raid Manager
        participant BPC as Boss Phase Controller
        participant ABE as AI Behavior Engine
        participant WS as World Service
        participant EB as Event Bus
        participant RG as Realtime Gateway
        
        C->>RM: Enter raid
        RM->>RM: Create raid session
        RM->>BPC: Initialize phase 1
        BPC->>ABE: Load boss AI profile
        RM->>EB: Publish raid.phase.started
        EB->>RG: Notify clients
        RG->>C: PhaseStart event
        
        Note over C,RG: Players fight boss
        
        ABE->>ABE: Process boss behavior
        ABE->>BPC: Update phase progress
        BPC->>BPC: Check phase conditions
        
        alt Phase conditions met
            BPC->>BPC: Transition to next phase
            BPC->>EB: Publish raid.phase.completed
            EB->>RG: Notify clients
            RG->>C: PhaseStart (next phase)
        end
        
        alt Boss defeated
            BPC->>RM: Boss defeated
            RM->>EB: Publish raid.boss.defeated
            RM->>WS: Trigger world event
            RM->>RM: Complete raid session
            EB->>RG: Notify clients
            RG->>C: Raid completed
        end
    ```

  ai_behavior_diagram: |
    ```mermaid
    sequenceDiagram
        participant ABE as AI Behavior Engine
        participant APM as AI Profile Manager
        participant CS as Combat Session
        participant ATC as AI Telemetry Collector
        participant EB as Event Bus
        
        ABE->>APM: Load AI profile
        APM-->>ABE: Profile data
        
        loop Combat loop
            ABE->>ABE: Evaluate situation (Utility AI)
            ABE->>ABE: Select action (Behaviour Tree)
            ABE->>CS: Execute action
            CS->>CS: Process combat action
            CS-->>ABE: Action result
            ABE->>ABE: Update AI state
            ABE->>ATC: Record action
            ABE->>EB: Publish combat.ai.state
        end
    ```

