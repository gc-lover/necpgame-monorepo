metadata:
  id: combat-freerun-architecture
  title: Архитектура системы Freerun (паркур в бою)
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-30T19:25:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - combat
    - freerun
    - parkour
    - movement
    - stamina
  related_systems:
    - gameplay-service
    - quest-service
    - analytics-service
  related_documents:
    - id: combat-freerun
      relation: implements
    - id: analysis-combat-freerun-brief
      relation: extends
  github_issue: 1513
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы Freerun (паркур в бою), включающую:
    - Смешанный контроль паркура (автоматический и ручной)
    - Элементы паркура (прыжки, лазание, скольжение, гравиботы)
    - Систему выносливости (stamina)
    - Интеграцию с боем (атаки с воздуха, стрельба в движении, мобильные способности)
    - Комбо паркура
    - Пользовательские маршруты
    - Телеметрию и античит
  goal: |
    Создать архитектурную схему системы Freerun с определением:
    - Компонентов для управления паркуром
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Объединенная архитектура системы Freerun с поддержкой паркура в бою,
    управления выносливостью, комбо и интеграции с боевой системой.

architecture:
  overview: |
    Архитектура системы Freerun состоит из следующих компонентов:
    1. Freerun Action Manager - управление действиями паркура
    2. Stamina Manager - управление выносливостью
    3. Freerun Combo System - система комбо паркура
    4. Route Manager - управление маршрутами
    5. Mobile Ability Integrator - интеграция мобильных способностей
    6. Freerun Telemetry Collector - сбор телеметрии
    7. Anti-Cheat Validator - валидация античит

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка Freerun:
        - Управление действиями паркура
        - Управление выносливостью
        - Обработка комбо паркура
        - Управление маршрутами
        - Интеграция мобильных способностей
        - Сбор телеметрии
        - Валидация античит
      components:
        - freerun-action-manager: управление действиями паркура
        - stamina-manager: управление выносливостью
        - freerun-combo-system: система комбо паркура
        - route-manager: управление маршрутами
        - mobile-ability-integrator: интеграция мобильных способностей
        - freerun-telemetry-collector: сбор телеметрии
        - anti-cheat-validator: валидация античит
      endpoints:
        - POST /api/v1/gameplay/combat/freerun/actions - выполнение действия паркура
        - GET /api/v1/gameplay/combat/freerun/actions/available - доступные действия
        - POST /api/v1/gameplay/combat/freerun/actions/wall-run - активация Wall Run
        - POST /api/v1/gameplay/combat/freerun/actions/double-jump - выполнение Double Jump
        - POST /api/v1/gameplay/combat/freerun/actions/slide - активация Slide
        - POST /api/v1/gameplay/combat/freerun/actions/air-dash - выполнение Air Dash
        - POST /api/v1/gameplay/combat/freerun/actions/wall-kick - выполнение Wall Kick
        - POST /api/v1/gameplay/combat/freerun/actions/vault - выполнение Vault
        - POST /api/v1/gameplay/combat/freerun/combo - выполнение комбо паркура
        - POST /api/v1/gameplay/combat/freerun/movement-attack - атака во время движения
        - POST /api/v1/gameplay/combat/freerun/movement-combo - комбо из движения
        - GET /api/v1/gameplay/combat/freerun/stamina - состояние выносливости
        - POST /api/v1/gameplay/combat/freerun/stamina/recover - восстановление выносливости
        - GET /api/v1/gameplay/combat/freerun/loadout - получение лоадаута паркура
        - POST /api/v1/gameplay/combat/freerun/loadout - обновление лоадаута
        - POST /api/v1/gameplay/combat/freerun/mobile-ability - активация мобильной способности
        - POST /api/v1/gameplay/combat/freerun/route - создание пользовательского маршрута
        - GET /api/v1/gameplay/combat/freerun/route/{routeId} - получение маршрута
        - GET /api/v1/gameplay/combat/freerun/telemetry - телеметрия паркура
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/combat/freerun/{sessionId} - поток действий и состояния stamina
        - wss://api.necp.game/v1/gameplay/combat/freerun/telemetry/{characterId} - телеметрия тренировки
      events_published:
        - combat.freerun.action: выполнение действия паркура
        - combat.freerun.wall-run.started: начало Wall Run
        - combat.freerun.wall-run.ended: окончание Wall Run
        - combat.freerun.double-jump: выполнение Double Jump
        - combat.freerun.slide.started: начало Slide
        - combat.freerun.slide.ended: окончание Slide
        - combat.freerun.air-dash: выполнение Air Dash
        - combat.freerun.wall-kick: выполнение Wall Kick
        - combat.freerun.vault: выполнение Vault
        - combat.freerun.combo: выполнение комбо паркура
        - combat.freerun.movement-attack: атака во время движения
        - combat.freerun.movement-combo: комбо из движения
        - combat.freerun.stamina: изменение выносливости
        - combat.freerun.mobile-ability: активация мобильной способности
        - combat.freerun.route-created: создание пользовательского маршрута
        - combat.freerun.route-completed: завершение маршрута
      events_subscribed:
        - combat.session.started: начало боевой сессии
        - combat.ability.activated: активация способности
        - combat.implant.activated: активация импланта
        - quest.trigger: триггеры квестов
        - progression.skill-updated: обновление навыков

  freerun_elements:
    - name: roof_jump
      description: Прыжки между крышами
      stamina_cost: 20
      automation_level: "auto/manual"

    - name: wall_climb
      description: Лазание по стенам
      stamina_cost: 15
      automation_level: "auto/manual"

    - name: wire_slide
      description: Скольжение по проводам
      stamina_cost: 10
      automation_level: "auto/manual"

    - name: rock_climb
      description: Скалолазание
      stamina_cost: 25
      automation_level: "manual"

    - name: hook_grab
      description: Захват крюками
      stamina_cost: 12
      automation_level: "auto/manual"

    - name: gravibot
      description: Использование гравиботов
      stamina_cost: 30
      automation_level: "auto/manual"

    - name: leg_implant
      description: Использование имплантов для ног
      stamina_cost: 18
      automation_level: "auto/manual"

    - name: wall_run
      description: Бег по стенам
      stamina_cost: 15
      stamina_per_second: 15
      automation_level: "auto/manual"
      category: "basic_acrobatics"

    - name: double_jump
      description: Двойной прыжок
      stamina_cost: 12
      automation_level: "auto/manual"
      category: "basic_acrobatics"

    - name: slide
      description: Скольжение
      stamina_cost: 6
      automation_level: "auto/manual"
      category: "basic_acrobatics"

    - name: air_dash
      description: Воздушный рывок
      stamina_cost: 12
      cooldown: 2.0
      automation_level: "manual"
      category: "advanced_acrobatics"

    - name: wall_kick
      description: Отталкивание от стены
      stamina_cost: 8
      automation_level: "auto/manual"
      category: "advanced_acrobatics"

    - name: vault
      description: Перепрыгивание
      stamina_cost: 5
      automation_level: "auto/manual"
      category: "basic_acrobatics"

  control_modes:
    - name: basic
      description: Базовый режим с автоматизацией
      automation_level: "high"
      features: "Автоматическое удержание на маршрутах, помощь в манёврах"

    - name: advanced
      description: Продвинутый режим с полным контролем
      automation_level: "low"
      features: "Полный контроль для точных манёвров, соревновательная игра"

  data_flows:
    freerun_action_flow: |
      1. Игрок выполняет действие паркура
      2. Freerun Action Manager получает запрос через POST /api/v1/gameplay/combat/freerun/actions
      3. Freerun Action Manager проверяет доступность действия
      4. Stamina Manager проверяет наличие выносливости
      5. Anti-Cheat Validator валидирует действие
      6. Freerun Action Manager выполняет действие
      7. Stamina Manager расходует выносливость
      8. Freerun Combo System проверяет комбо
      9. Mobile Ability Integrator проверяет мобильные способности
      10. Gameplay Service публикует событие combat.freerun.action
      11. Realtime Gateway отправляет обновление клиентам

    stamina_management_flow: |
      1. Игрок выполняет действие паркура
      2. Stamina Manager рассчитывает расход выносливости
      3. Stamina Manager учитывает навыки и импланты
      4. Stamina Manager обновляет состояние выносливости
      5. Если выносливость обнулена, Stamina Manager блокирует действия
      6. Stamina Manager запускает восстановление выносливости
      7. Gameplay Service публикует событие combat.freerun.stamina
      8. Realtime Gateway отправляет обновление клиентам

    freerun_combo_flow: |
      1. Игрок выполняет последовательность действий паркура
      2. Freerun Combo System отслеживает последовательность
      3. Freerun Combo System проверяет соответствие комбо
      4. Freerun Combo System применяет бонусы комбо
      5. Freerun Combo System интегрирует с боевыми комбо
      6. Gameplay Service публикует событие combat.freerun.combo
      7. Realtime Gateway отправляет обновление клиентам

    mobile_ability_flow: |
      1. Игрок активирует способность во время паркура
      2. Mobile Ability Integrator проверяет доступность способности
      3. Mobile Ability Integrator проверяет совместимость с текущим действием
      4. Mobile Ability Integrator применяет мобильную версию способности
      5. Mobile Ability Integrator корректирует затраты способности
      6. Gameplay Service публикует событие combat.freerun.mobile-ability
      7. Realtime Gateway отправляет обновление клиентам

    route_creation_flow: |
      1. Игрок создает пользовательский маршрут
      2. Route Manager получает запрос через POST /api/v1/gameplay/combat/freerun/route
      3. Route Manager валидирует маршрут
      4. Route Manager проверяет доступность элементов маршрута
      5. Route Manager сохраняет маршрут
      6. Gameplay Service публикует событие combat.freerun.route-created
      7. Realtime Gateway отправляет обновление клиентам

  database_structure:
    tables:
      - name: freerun_actions
        description: Действия паркура
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - action_type: ENUM (roof_jump, wall_climb, wire_slide, rock_climb, hook_grab, gravibot, leg_implant, wall_run, double_jump, slide, air_dash, wall_kick, vault)
          - position_before: JSONB
          - position_after: JSONB
          - stamina_cost: INTEGER
          - automation_level: VARCHAR(50)
          - timestamp: TIMESTAMP

      - name: freerun_profiles
        description: Профили паркура персонажей
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - control_mode: ENUM (basic, advanced)
          - preferred_automation: DECIMAL(3,2)
          - loadout: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: freerun_combos_history
        description: История комбо паркура
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - combo_sequence: JSONB
          - bonuses_applied: JSONB
          - combat_integration: BOOLEAN
          - timestamp: TIMESTAMP

      - name: freerun_stamina_state
        description: Состояние выносливости
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - current_stamina: INTEGER
          - max_stamina: INTEGER
          - recovery_rate: DECIMAL(5,2)
          - modifiers: JSONB
          - last_update: TIMESTAMP

      - name: freerun_routes
        description: Пользовательские маршруты
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - name: VARCHAR(255)
          - route_points: JSONB
          - difficulty: VARCHAR(50)
          - is_public: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: freerun_telemetry
        description: Телеметрия паркура
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - action_type: VARCHAR(100)
          - duration: INTEGER
          - distance: DECIMAL(10,2)
          - stamina_used: INTEGER
          - combo_triggered: BOOLEAN
          - timestamp: TIMESTAMP

      - name: freerun_audit_log
        description: Журнал аудита для античита
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - action_type: VARCHAR(100)
          - validation_result: VARCHAR(50)
          - suspicious_flags: JSONB
          - timestamp: TIMESTAMP

  integrations:
    combat_session: |
      - Интеграция действий паркура с боевой сессией
      - Синхронизация позиций и состояний
      - Обработка атак с воздуха и стрельбы в движении

    ability_service: |
      - Получение мобильных версий способностей
      - Корректировка затрат способностей для паркура
      - Интеграция способностей с действиями паркура

    implant_service: |
      - Получение данных об имплантах для паркура
      - Расчет бонусов имплантов для выносливости
      - Интеграция имплантов с элементами паркура

    progression_service: |
      - Получение данных о навыках паркура
      - Расчет бонусов навыков для выносливости
      - Обновление навыков на основе действий паркура

    quest_service: |
      - Триггеры квестов при выполнении маршрутов
      - Проверка требований квестов для паркура
      - Интеграция с квестовыми маршрутами

    analytics_service: |
      - Логирование всех действий паркура
      - Сбор метрик эффективности
      - Анализ паттернов использования паркура
      - Детект эксплойтов

    inventory_service: |
      - Проверка экипировки для паркура
      - Получение данных о гравиботах и оборудовании
      - Расчет модификаторов экипировки

    realtime_gateway: |
      - Отправка realtime обновлений действий паркура
      - Синхронизация состояния выносливости
      - Уведомления о комбо и мобильных способностях

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для создания действий паркура и обновления состояния
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед выполнением действий паркура
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (действие паркура, расход stamina, комбо)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния паркура (выполнение действий, изменение stamina, комбо)
      записываются как события в Event Store. Это обеспечивает полный аудит,
      возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: FreerunActionExecutedEvent, StaminaChangedEvent, ComboTriggeredEvent.
    cqrs_pattern: |
      Разделение команд (выполнение действий паркура, обновление stamina) и запросов
      (получение состояния паркура, история действий) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как выполнение действия паркура (проверка stamina,
      выполнение действия, расход stamina, проверка комбо, интеграция с боем), используется
      Saga Pattern для обеспечения атомарности операций между Gameplay Service,
      Stamina Manager и Combat Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_and_network_requirements:
    freerun_actions:
      tickrate: 60-128 Hz
      network_load: |
        - Позиции персонажа: 60-128 updates/sec
        - Состояние действий: event-based, ~10-20 events/sec
        - Обновление stamina: 20-30 updates/sec
        - Общий трафик: ~5-10 KB/sec на игрока
      sync_strategy: Strong Consistency для позиций, Eventual для статистики

    wall_run:
      tickrate: 60-128 Hz
      network_load: |
        - Позиция во время Wall Run: 60-128 updates/sec
        - События начала/окончания: event-based
        - Общий трафик: ~2-3 KB/sec на игрока
      sync_strategy: Strong Consistency

    double_jump:
      tickrate: Event-based (on-demand)
      network_load: |
        - Событие прыжка: event-based, ~1-2 events/sec
        - Обновление позиции: 60-128 updates/sec
        - Общий трафик: ~0.5-1 KB/sec на игрока
      sync_strategy: Strong Consistency

    slide:
      tickrate: 60-128 Hz
      network_load: |
        - Позиция во время Slide: 60-128 updates/sec
        - События начала/окончания: event-based
        - Общий трафик: ~2-3 KB/sec на игрока
      sync_strategy: Strong Consistency

    air_dash:
      tickrate: Event-based (on-demand)
      network_load: |
        - Событие Air Dash: event-based, ~0.5-1 events/sec
        - Обновление позиции: 60-128 updates/sec
        - Общий трафик: ~0.5-1 KB/sec на игрока
      sync_strategy: Strong Consistency

    movement_attacks:
      tickrate: 60-128 Hz
      network_load: |
        - Атаки в движении: event-based, ~5-10 events/sec
        - Обновление позиции: 60-128 updates/sec
        - Общий трафик: ~3-5 KB/sec на игрока
      sync_strategy: Strong Consistency

    movement_combos:
      tickrate: Event-based (on-demand)
      network_load: |
        - Комбо из движения: event-based, ~1-3 events/sec
        - Обновление состояния: event-based
        - Общий трафик: ~0.5-1 KB/sec на игрока
      sync_strategy: Strong Consistency

technical_specification:
  reference: combat-freerun-architecture-spec.yaml

diagrams:
  reference: combat-freerun-architecture-spec.yaml

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния паркура
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана базовая архитектура системы Freerun:
      - Определены компоненты для управления паркуром
      - Описаны API endpoints и WebSocket каналы
      - Спроектированы потоки данных
      - Определена структура БД
      - Добавлены элементы акробатики (wall_run, double_jump, slide, air_dash, wall_kick, vault)
      - Добавлена спецификация тикрейта и сетевой нагрузки

