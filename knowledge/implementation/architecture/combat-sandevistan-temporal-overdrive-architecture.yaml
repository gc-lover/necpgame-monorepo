<!-- Issue: #39 -->
metadata:
  id: combat-sandevistan-temporal-overdrive-architecture
  title: Архитектура системы Sandevistan Temporal Overdrive
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-01T00:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - combat
    - implants
    - time-dilation
    - realtime
    - pvp
  related_systems:
    - gameplay-service
    - combat-service
    - realtime-service
    - animation-service
    - safety-service
  related_documents:
    - id: combat-sandevistan-temporal-overdrive
      relation: implements
    - id: combat-abilities-architecture
      relation: extends
    - id: combat-implants-architecture
      relation: extends
  github_issue: 39
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer
    - network

summary:
  problem: |
    Требуется спроектировать архитектуру системы Sandevistan Temporal Overdrive,
    которая реализует эффект замедления времени для конкретного игрока в MMO
    без изменения серверного тайминга и нарушения честности PvP.
  goal: |
    Создать архитектурную схему системы Sandevistan с определением:
    - Компонентов для управления временным овердрайвом
    - REST, WebSocket и Event Bus контрактов
    - Синхронизации данных между слоями (Event Sourcing, CQRS)
    - Тикрейта и требований к сетевой нагрузке
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Архитектура системы Sandevistan, сочетающая визуальную фантазию EdgeRunners
    с сетевой архитектурой MMO, используя Action Priority Budget и Perception Drag
    для реализации эффекта замедления времени без изменения серверного tick rate.

architecture:
  overview: |
    Архитектура системы Sandevistan состоит из следующих компонентов:
    1. Temporal Overdrive Manager - управление фазами активации
    2. Action Priority Budget Engine - обработка микробюджета действий
    3. Perception Drag System - дебафф восприятия для противников
    4. Heat Management System - управление перегревом и киберпсихозом
    5. Temporal Marks Tracker - отслеживание целей для delayed burst
    6. MicroTick Window Buffer - буфер ввода для батчинга действий
    7. Counterplay Handler - обработка контрплея (EMP, Chrono-Jammer)

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка Sandevistan Temporal Overdrive:
        - Управление фазами активации (подготовка, активная, рекуперация)
        - Обработка Action Priority Budget
        - Управление перегревом и киберпсихозом
        - Отслеживание Temporal Marks
        - Обработка контрплея
      components:
        - temporal-overdrive-manager: управление фазами активации
        - action-priority-budget-engine: обработка микробюджета действий
        - heat-management-system: управление перегревом
        - temporal-marks-tracker: отслеживание целей
        - counterplay-handler: обработка контрплея
      endpoints:
        - POST /api/v1/gameplay/combat/implants/sandevistan/activate - активация Sandevistan
        - GET /api/v1/gameplay/combat/implants/sandevistan/status - статус активации
        - POST /api/v1/gameplay/combat/implants/sandevistan/actions/batch - батч действий
        - GET /api/v1/gameplay/combat/implants/sandevistan/heat - уровень перегрева
        - POST /api/v1/gameplay/combat/implants/sandevistan/cooling - охлаждение
        - POST /api/v1/gameplay/combat/implants/sandevistan/counterplay - применение контрплея
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/combat/implants/sandevistan/{sessionId} - live события
        - wss://api.necp.game/v1/gameplay/combat/implants/sandevistan/player/{characterId} - обновления статуса
      events_published:
        - combat.sandevistan.activated: активация Sandevistan
        - combat.sandevistan.action-budget-used: использование Action Budget
        - combat.sandevistan.heat-updated: обновление перегрева
        - combat.sandevistan.overstress: критический перегрев
        - combat.sandevistan.counterplay-applied: применение контрплея
        - combat.sandevistan.temporal-mark-applied: применение Temporal Mark
        - combat.sandevistan.phase-changed: смена фазы
      events_subscribed:
        - combat.ability.activated: активация способностей
        - combat.implant.installed: установка имплантов
        - combat.hacking.emp-applied: применение EMP
        - progression.cyberpsychosis-updated: обновление киберпсихоза

    - name: realtime-service
      port: 8085
      responsibility: |
        Обработка realtime синхронизации Sandevistan:
        - Распаковка батчей действий из MicroTick Window
        - Последовательное исполнение действий в один тик
        - Применение Perception Drag к противникам
        - Синхронизация визуальных эффектов
      components:
        - microtick-window-processor: обработка батчей действий
        - action-sequencer: последовательное исполнение действий
        - perception-drag-applier: применение Perception Drag
        - visual-effects-sync: синхронизация визуальных эффектов
      endpoints:
        - POST /api/v1/realtime/combat/sandevistan/actions/process - обработка батча действий
        - POST /api/v1/realtime/combat/sandevistan/perception-drag - применение Perception Drag
      websocket_channels:
        - wss://api.necp.game/v1/realtime/combat/sandevistan/{sessionId} - realtime события
      events_published:
        - realtime.sandevistan.actions-processed: обработка батча действий
        - realtime.sandevistan.perception-drag-applied: применение Perception Drag
      events_subscribed:
        - combat.sandevistan.activated: активация Sandevistan
        - combat.sandevistan.action-budget-used: использование Action Budget

  data_synchronization:
    strategy: Event Sourcing + CQRS
    event_store: |
      Все события Sandevistan сохраняются в Event Store:
      - combat.sandevistan.activated
      - combat.sandevistan.action-budget-used
      - combat.sandevistan.heat-updated
      - combat.sandevistan.overstress
      - combat.sandevistan.counterplay-applied
      - combat.sandevistan.temporal-mark-applied
      - combat.sandevistan.phase-changed
    command_side: |
      Command Side (Write Model):
      - gameplay-service: обработка команд активации, действий, охлаждения
      - realtime-service: обработка батчей действий
    query_side: |
      Query Side (Read Model):
      - gameplay-service: получение статуса активации, уровня перегрева
      - realtime-service: получение состояния Perception Drag
    saga_pattern: |
      Saga для обработки активации Sandevistan:
      1. Start Activation Saga
      2. Check Requirements (имплант установлен, ресурсы доступны)
      3. Reserve Action Budget
      4. Activate Temporal Overdrive
      5. Start Heat Tracking
      6. If failure: Compensate (rollback активации, возврат ресурсов)
    consistency: |
      Strong Consistency для критичных операций:
      - Активация Sandevistan
      - Применение Action Budget
      - Обновление перегрева
      - Применение контрплея
      Eventual Consistency для:
      - Визуальные эффекты
      - Perception Drag (клиентская синхронизация)

  network_requirements:
    tick_rate:
      pve_zones: |
        - Протокол: WebSocket (TCP)
        - Тикрейт: 20-30 Hz
        - Задержка: <100 мс
        - Игроков: 100-500
      pvp_small: |
        - Протокол: UDP
        - Тикрейт: 60-128 Hz
        - Задержка: <30 мс
        - Игроков: 5-20
      pvp_gvg_200: |
        - Протокол: UDP
        - Тикрейт: 60-80 Hz
        - Задержка: <40 мс
        - Игроков: 200 (100v100)
        - Оптимизация: Spatial partitioning
      pvp_gvg_400: |
        - Протокол: UDP
        - Тикрейт: 40-60 Hz
        - Задержка: <50 мс
        - Игроков: 400 (200v200)
        - Оптимизация: Spatial sharding (2-4 shards)
      massive_war: |
        - Протокол: UDP
        - Тикрейт: 20-40 Hz
        - Задержка: <100 мс
        - Игроков: 2000+
        - Архитектура: Cluster (5-10 servers)
    action_priority_budget: |
      - Максимум 3 действия за один серверный тик
      - Батчинг действий в MicroTick Window Buffer
      - Последовательное исполнение действий внутри тика
      - Приоритет: dash > attack > ability
    perception_drag: |
      - Клиентский debuff восприятия: до 120 мс задержка отображения
      - Серверный debuff реакции: +15% к глобальному кулдауну
      - Увеличение времени выката cover-to-cover
      - Применяется только к противникам активированного игрока
    bandwidth_optimization: |
      - Spatial partitioning для снижения трафика на 80-90%
      - Event aggregation (батчинг) для больших битв
      - Адаптивный тикрейт в зависимости от количества игроков
      - Квантование координат для уменьшения размера сообщений

  data_flows:
    activation_flow: |
      1. Клиент отправляет POST /api/v1/gameplay/combat/implants/sandevistan/activate
      2. Temporal Overdrive Manager проверяет требования (имплант, ресурсы, кулдаун)
      3. Temporal Overdrive Manager резервирует Action Budget
      4. Temporal Overdrive Manager активирует фазу подготовки (300 мс)
      5. Heat Management System начинает отслеживание перегрева
      6. Gameplay Service публикует событие combat.sandevistan.activated
      7. Realtime Service применяет Perception Drag к противникам
      8. Realtime Gateway отправляет обновление клиентам

    action_batch_flow: |
      1. Клиент собирает действия в MicroTick Window Buffer (до 3 действий)
      2. Клиент отправляет POST /api/v1/gameplay/combat/implants/sandevistan/actions/batch
      3. Action Priority Budget Engine проверяет доступный бюджет
      4. MicroTick Window Processor распаковывает батч
      5. Action Sequencer исполняет действия последовательно в один тик
      6. Temporal Marks Tracker фиксирует цели (до 3 целей)
      7. Gameplay Service публикует событие combat.sandevistan.action-budget-used
      8. Realtime Gateway отправляет обновление клиентам

    heat_management_flow: |
      1. Игрок использует Action Budget
      2. Heat Management System рассчитывает накопление перегрева
      3. Heat Management System проверяет пороговые значения (1-4 stacks)
      4. При достижении 4 stacks: активация overstress
      5. Heat Management System применяет штрафы (30% HP, неконтролируемый рывок)
      6. Heat Management System обновляет киберпсихоз через Progression Service
      7. Gameplay Service публикует событие combat.sandevistan.heat-updated или overstress
      8. Realtime Gateway отправляет обновление клиентам

    counterplay_flow: |
      1. Противник активирует контрплей (EMP, Chrono-Jammer, hacking)
      2. Counterplay Handler проверяет тип контрплея
      3. Counterplay Handler применяет эффекты:
         - Chrono-Jammer: уменьшает Action Budget до 1, блокирует dash
         - EMP: мгновенно завершает фазу (dilation_break)
         - Hacking: накладывает dilation_break
      4. Temporal Overdrive Manager завершает активную фазу
      5. Gameplay Service публикует событие combat.sandevistan.counterplay-applied
      6. Realtime Gateway отправляет обновление клиентам

    temporal_marks_flow: |
      1. Игрок в активной фазе фиксирует цели (до 3 целей)
      2. Temporal Marks Tracker сохраняет метки целей
      3. При выходе из овердрайва:
         - Delayed burst урон (60% базового урона в PvP, 100% в PvE)
         - Нейрошок (0.7 с оглушение в PvE, aim sway в PvP)
      4. Gameplay Service публикует событие combat.sandevistan.temporal-mark-applied
      5. Realtime Gateway отправляет обновление клиентам

  database_structure:
    tables:
      - name: sandevistan_activations
        description: Активации Sandevistan
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - session_id: UUID FOREIGN KEY
          - phase: ENUM (preparation, active, recovery)
          - started_at: TIMESTAMP
          - active_phase_started_at: TIMESTAMP (nullable)
          - recovery_phase_started_at: TIMESTAMP (nullable)
          - ended_at: TIMESTAMP (nullable)
          - action_budget_remaining: INTEGER
          - action_budget_max: INTEGER
          - heat_stacks: INTEGER
          - is_active: BOOLEAN
          - created_at: TIMESTAMP

      - name: sandevistan_action_batches
        description: Батчи действий в MicroTick Window
        columns:
          - id: UUID PRIMARY KEY
          - activation_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - tick_number: BIGINT
          - actions: JSONB (массив действий)
          - actions_count: INTEGER
          - processed_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: sandevistan_temporal_marks
        description: Temporal Marks целей
        columns:
          - id: UUID PRIMARY KEY
          - activation_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - target_id: UUID
          - target_type: ENUM (player, npc, enemy)
          - marked_at: TIMESTAMP
          - applied_at: TIMESTAMP (nullable)
          - damage_dealt: INTEGER (nullable)
          - effect_applied: JSONB (nullable)
          - created_at: TIMESTAMP

      - name: sandevistan_heat_state
        description: Состояние перегрева
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - current_stacks: INTEGER
          - max_stacks: INTEGER DEFAULT 4
          - last_update: TIMESTAMP
          - overstress_triggered: BOOLEAN DEFAULT false
          - overstress_triggered_at: TIMESTAMP (nullable)
          - cooldown_until: TIMESTAMP (nullable)
          - created_at: TIMESTAMP

      - name: sandevistan_counterplay_logs
        description: Логи контрплея
        columns:
          - id: UUID PRIMARY KEY
          - activation_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - counterplay_type: ENUM (emp, chrono-jammer, hacking, crowd-control)
          - applied_by: UUID (character_id противника)
          - applied_at: TIMESTAMP
          - effect_applied: JSONB
          - created_at: TIMESTAMP

      - name: sandevistan_perception_drag_state
        description: Состояние Perception Drag для противников
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY (противник)
          - active_activation_id: UUID FOREIGN KEY
          - drag_delay_ms: INTEGER
          - reaction_debuff_percent: DECIMAL(5,2)
          - applied_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - is_active: BOOLEAN
          - created_at: TIMESTAMP

  integrations:
    combat_service: |
      - Получение данных о боевых сессиях
      - Применение урона и эффектов
      - Интеграция с системой способностей

    realtime_service: |
      - Обработка батчей действий
      - Применение Perception Drag
      - Синхронизация визуальных эффектов

    progression_service: |
      - Обновление киберпсихоза
      - Проверка требований для активации
      - Применение штрафов при overstress

    implant_service: |
      - Проверка установленного импланта Sandevistan
      - Получение данных об улучшениях импланта
      - Обновление состояния импланта

    analytics_service: |
      - Логирование всех активаций
      - Сбор метрик использования
      - Античит мониторинг (лицензии в PvP)

    animation_service: |
      - Синхронизация анимаций активации
      - Afterimage silhouettes для противников
      - Визуальные эффекты слоумо

    safety_service: |
      - Проверка лицензий в PvP (максимум активаций)
      - Логирование для античит-аналитики
      - Ограничения для предотвращения эксплойтов

technical_specification:
  subtasks:
    - id: temporal-overdrive-manager
      title: Реализация менеджера временного овердрайва
      description: |
        Реализация Temporal Overdrive Manager с управлением фазами активации
        (подготовка, активная, рекуперация) и проверкой требований.
      dependencies: []
      estimated_effort: 4 days

    - id: action-priority-budget-engine
      title: Реализация движка Action Priority Budget
      description: |
        Реализация Action Priority Budget Engine с обработкой микробюджета действий
        (до 3 действий за тик) и последовательным исполнением.
      dependencies: [temporal-overdrive-manager]
      estimated_effort: 5 days

    - id: microtick-window-processor
      title: Реализация процессора MicroTick Window
      description: |
        Реализация MicroTick Window Processor с распаковкой батчей действий
        и синхронизацией с realtime-service.
      dependencies: [action-priority-budget-engine]
      estimated_effort: 4 days

    - id: heat-management-system
      title: Реализация системы управления перегревом
      description: |
        Реализация Heat Management System с отслеживанием heat stacks,
        обработкой overstress и интеграцией с киберпсихозом.
      dependencies: [temporal-overdrive-manager]
      estimated_effort: 4 days

    - id: temporal-marks-tracker
      title: Реализация трекера Temporal Marks
      description: |
        Реализация Temporal Marks Tracker с фиксацией целей (до 3 целей)
        и применением delayed burst эффектов.
      dependencies: [temporal-overdrive-manager]
      estimated_effort: 3 days

    - id: perception-drag-system
      title: Реализация системы Perception Drag
      description: |
        Реализация Perception Drag System с применением клиентского debuff
        восприятия (до 120 мс) и серверного debuff реакции (+15% кулдаун).
      dependencies: [temporal-overdrive-manager]
      estimated_effort: 4 days

    - id: counterplay-handler
      title: Реализация обработчика контрплея
      description: |
        Реализация Counterplay Handler с обработкой EMP, Chrono-Jammer,
        hacking и crowd-control эффектов.
      dependencies: [temporal-overdrive-manager]
      estimated_effort: 3 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений активаций,
        действий и Perception Drag.
      dependencies: [temporal-overdrive-manager, action-priority-budget-engine]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы Sandevistan.
      dependencies: [temporal-overdrive-manager, heat-management-system]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для активаций, батчей действий, Temporal Marks,
        перегрева, контрплея и Perception Drag с миграциями Liquibase.
      dependencies: []
      estimated_effort: 2 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> GameplayService[Gameplay Service<br/>8083]
        Gateway --> RealtimeService[Realtime Service<br/>8085]
        
        GameplayService --> TOM[Temporal Overdrive Manager]
        GameplayService --> APBE[Action Priority Budget Engine]
        GameplayService --> HMS[Heat Management System]
        GameplayService --> TMT[Temporal Marks Tracker]
        GameplayService --> CH[Counterplay Handler]
        
        RealtimeService --> MWP[MicroTick Window Processor]
        RealtimeService --> AS[Action Sequencer]
        RealtimeService --> PDA[Perception Drag Applier]
        RealtimeService --> VES[Visual Effects Sync]
        
        APBE --> MWP
        TOM --> HMS
        TOM --> TMT
        
        GameplayService --> CombatService[Combat Service]
        GameplayService --> ProgressionService[Progression Service]
        GameplayService --> ImplantService[Implant Service]
        GameplayService --> AnalyticsService[Analytics Service]
        GameplayService --> SafetyService[Safety Service]
        
        RealtimeService --> AnimationService[Animation Service]
        
        GameplayService --> EventBus[Event Bus<br/>Kafka]
        RealtimeService --> EventBus
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        GameplayService --> DB[(Gameplay DB)]
        RealtimeService --> DB
        
        Client --> WSSand[WebSocket<br/>Sandevistan]
        WSSand --> GameplayService
        WSSand --> RealtimeService
    ```

  activation_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant TOM as Temporal Overdrive Manager
        participant IS as Implant Service
        participant HMS as Heat Management System
        participant RS as Realtime Service
        participant EB as Event Bus
        
        C->>TOM: POST /sandevistan/activate
        TOM->>IS: Check implant installed
        IS-->>TOM: Implant data
        TOM->>TOM: Check requirements (resources, cooldown)
        TOM->>TOM: Reserve Action Budget
        TOM->>TOM: Activate preparation phase (300ms)
        TOM->>HMS: Start heat tracking
        TOM->>EB: Publish combat.sandevistan.activated
        TOM->>RS: Apply Perception Drag
        RS->>RS: Apply drag to opponents
        TOM-->>C: Activation started
        
        Note over TOM: After 300ms
        TOM->>TOM: Switch to active phase (4s)
        TOM->>EB: Publish combat.sandevistan.phase-changed
        TOM-->>C: Active phase started
    ```

  action_batch_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant APBE as Action Priority Budget Engine
        participant MWP as MicroTick Window Processor
        participant AS as Action Sequencer
        participant TMT as Temporal Marks Tracker
        participant EB as Event Bus
        
        C->>C: Collect actions in MicroTick Window Buffer (max 3)
        C->>APBE: POST /sandevistan/actions/batch
        APBE->>APBE: Check available budget
        APBE->>MWP: Process batch
        MWP->>MWP: Unpack actions
        MWP->>AS: Execute actions sequentially
        AS->>AS: Execute action 1
        AS->>AS: Execute action 2
        AS->>AS: Execute action 3
        AS->>TMT: Track targets (max 3)
        TMT->>TMT: Mark targets
        APBE->>EB: Publish combat.sandevistan.action-budget-used
        APBE-->>C: Actions processed
    ```

