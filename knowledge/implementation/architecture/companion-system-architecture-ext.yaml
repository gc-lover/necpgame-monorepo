- companion_type_id: UUID FOREIGN KEY
- name: VARCHAR(255)
- level: INTEGER
- experience: INTEGER
- stats: JSONB
- customization: JSONB
- is_summoned: BOOLEAN
- summoned_at: TIMESTAMP
- created_at: TIMESTAMP
- updated_at: TIMESTAMP

- name: companion_abilities
  description: Способности компаньонов
  columns:
    - id: UUID PRIMARY KEY
    - companion_id: UUID FOREIGN KEY
    - ability_id: VARCHAR(50)
    - ability_type: ENUM (active, passive)
    - level: INTEGER
    - cooldown_until: TIMESTAMP
    - is_unlocked: BOOLEAN
    - created_at: TIMESTAMP
    - updated_at: TIMESTAMP

- name: companion_progression_history
  description: История прогрессии компаньонов
  columns:
    - id: UUID PRIMARY KEY
    - companion_id: UUID FOREIGN KEY
    - level: INTEGER
    - experience: INTEGER
    - xp_gained: INTEGER
    - xp_source: VARCHAR(50)
    - created_at: TIMESTAMP

- name: companion_telemetry
  description: Телеметрия компаньонов
  columns:
    - id: UUID PRIMARY KEY
    - event_type: VARCHAR(50)
    - companion_id: UUID FOREIGN KEY
    - character_id: UUID FOREIGN KEY
    - event_data: JSONB
    - created_at: TIMESTAMP

integrations:
  combat_service: |
    - Получение событий боя
    - Применение боевых эффектов компаньонов
    - Расчет урона и лечения
    - Интеграция с боевой системой

  inventory_service: |
    - Проверка наличия предметов для компаньонов
    - Добавление предметов, собранных компаньонами
    - Управление экипировкой компаньонов

  character_service: |
    - Получение информации о персонаже
    - Проверка уровня персонажа
    - Обновление статистики персонажа

  economy_service: |
    - Покупка компаньонов
    - Проверка баланса
    - Обработка транзакций
    - Логирование экономических операций

  quest_service: |
    - Получение событий квестов
    - Начисление опыта компаньонам за квесты
    - Интеграция с системой квестов

  realtime_gateway: |
    - Отправка realtime обновлений компаньонов
    - Синхронизация состояния компаньонов
    - Уведомления о событиях

  world_service: |
    - Спавн компаньонов в мире
    - Проверка ограничений зон
    - Управление позициями компаньонов

technical_specification:
  subtasks:
    - id: companion-manager
      title: Реализация менеджера системы компаньонов
      description: |
        Реализация Companion Manager с управлением системой компаньонов
        и интеграцией с другими компонентами.
      dependencies: [ ]
      estimated_effort: 4 days

    - id: companion-catalog-manager
      title: Реализация менеджера каталога компаньонов
      description: |
        Реализация Companion Catalog Manager с управлением каталогом компаньонов,
        типами и доступностью.
      dependencies: [ companion-manager ]
      estimated_effort: 3 days

    - id: companion-ownership-manager
      title: Реализация менеджера владения компаньонами
      description: |
        Реализация Companion Ownership Manager с управлением владением компаньонами,
        покупкой и проверкой владения.
      dependencies: [ companion-manager ]
      estimated_effort: 3 days

    - id: companion-summon-manager
      title: Реализация менеджера призыва/отзыва
      description: |
        Реализация Companion Summon Manager с управлением призывом/отзывом компаньонов,
        проверкой ограничений и спавном в мире.
      dependencies: [ companion-manager ]
      estimated_effort: 4 days

    - id: companion-progression-manager
      title: Реализация менеджера прогрессии
      description: |
        Реализация Companion Progression Manager с управлением прогрессией компаньонов,
        начислением опыта и повышением уровня.
      dependencies: [ companion-manager ]
      estimated_effort: 4 days

    - id: companion-ability-manager
      title: Реализация менеджера способностей
      description: |
        Реализация Companion Ability Manager с управлением способностями компаньонов,
        активацией и кулдаунами.
      dependencies: [ companion-manager ]
      estimated_effort: 4 days

    - id: companion-customization-manager
      title: Реализация менеджера кастомизации
      description: |
        Реализация Companion Customization Manager с управлением кастомизацией компаньонов,
        переименованием и изменением внешнего вида.
      dependencies: [ companion-manager ]
      estimated_effort: 3 days

    - id: companion-stats-calculator
      title: Реализация калькулятора статистики
      description: |
        Реализация Companion Stats Calculator с расчетом статистики компаньонов,
        учетом уровня и эффектов.
      dependencies: [ companion-progression-manager ]
      estimated_effort: 3 days

    - id: companion-effects-applier
      title: Реализация применения эффектов
      description: |
        Реализация Companion Effects Applier с применением эффектов компаньонов,
        интеграцией с боевой системой и миром.
      dependencies: [ companion-manager ]
      estimated_effort: 4 days

    - id: companion-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Companion Telemetry Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [ companion-manager ]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений компаньонов,
        состояния и уведомлений.
      dependencies: [ companion-manager ]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы компаньонов.
      dependencies: [ companion-manager ]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для типов компаньонов, компаньонов игроков,
        способностей, прогрессии и телеметрии с миграциями Liquibase.
      dependencies: [ ]
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
    
        Gateway --> CompanionService[Companion Service<br/>8091]
    
        CompanionService --> CM[Companion Manager]
        CompanionService --> CCM[Companion Catalog Manager]
        CompanionService --> COM[Companion Ownership Manager]
        CompanionService --> CSM[Companion Summon Manager]
        CompanionService --> CPM[Companion Progression Manager]
        CompanionService --> CAM[Companion Ability Manager]
        CompanionService --> CCuM[Companion Customization Manager]
        CompanionService --> CSC[Companion Stats Calculator]
        CompanionService --> CEA[Companion Effects Applier]
        CompanionService --> CTC[Companion Telemetry Collector]
    
        CM --> CCM
        CM --> COM
        CM --> CSM
        CM --> CPM
        CPM --> CSC
        CM --> CAM
        CM --> CCuM
        CM --> CEA
    
        CompanionService --> CombatService[Combat Service]
        CompanionService --> InventoryService[Inventory Service]
        CompanionService --> CharacterService[Character Service]
        CompanionService --> EconomyService[Economy Service]
        CompanionService --> QuestService[Quest Service]
        CompanionService --> WorldService[World Service]
    
        CompanionService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
    
        CompanionService --> DB[(Companion DB)]
    
        Client --> WSCompanion[WebSocket<br/>Companion]
        WSCompanion --> CompanionService
    ```

  summon_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant CSM as Companion Summon Manager
        participant CEA as Companion Effects Applier
        participant WS as World Service
        participant EB as Event Bus
    
        P->>CSM: Summon companion
        CSM->>CSM: Check ownership
        CSM->>CSM: Dismiss active companion
        CSM->>CSM: Validate zone restrictions
        CSM->>WS: Spawn companion in world
        CSM->>CEA: Apply effects
        CSM->>EB: Publish companion.summoned
    ```

  progression_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Companion
        participant CPM as Companion Progression Manager
        participant CSC as Companion Stats Calculator
        participant CEA as Companion Effects Applier
        participant EB as Event Bus
    
        C->>CPM: Gain experience
        CPM->>CPM: Check level up
        CPM->>CPM: Level up
        CPM->>CSC: Recalculate stats
        CPM->>CEA: Update effects
        CPM->>EB: Publish companion.level-up
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния компаньонов
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (покупка компаньона, призыв, применение эффектов)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для компаньонов, призыва, прогрессии, способностей, кастомизации, статистики, эффектов и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы компаньонов:
      - Определены компоненты (Companion Manager, Companion Catalog Manager, Companion Ownership Manager, Companion Summon Manager, Companion Progression Manager, Companion Ability Manager, Companion Customization Manager, Companion Stats Calculator, Companion Effects Applier, Companion Telemetry Collector)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (companion_types, player_companions, companion_abilities, companion_progression_history, companion_telemetry)
      - Спроектирована система призыва/отзыва компаньонов
      - Спроектирована система прогрессии компаньонов
      - Спроектирована система способностей (активные/пассивные)
      - Спроектирована система кастомизации
      - Создано техническое задание
      - Разбито на подзадачи
