metadata:
  id: companion-system-architecture
  title: Архитектура системы компаньонов
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-30T20:45:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - gameplay
    - companions
    - pets
    - drones
    - combat
  related_systems:
    - companion-service
    - combat-service
    - inventory-service
    - character-service
    - economy-service
    - realtime-gateway
  related_documents:
    - id: backend-companion-system
      relation: implements
  github_issue: 314
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы компаньонов, включающую:
    - Управление боевыми дронами, утилитарными помощниками и питомцами
    - Систему призыва/отзыва компаньонов
    - Систему прогрессии компаньонов (уровни, опыт, статы)
    - Систему способностей (активные и пассивные)
    - Систему кастомизации
    - Интеграции с боёвкой, инвентарем и экономикой
  goal: |
    Создать архитектурную схему системы компаньонов с определением:
    - Компонентов для управления компаньонами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы компаньонов с поддержкой призыва, прогрессии,
    способностей и кастомизации.

architecture:
  overview: |
    Архитектура системы компаньонов состоит из следующих компонентов:
    1. Companion Manager - управление системой компаньонов
    2. Companion Catalog Manager - управление каталогом компаньонов
    3. Companion Ownership Manager - управление владением компаньонами
    4. Companion Summon Manager - управление призывом/отзывом
    5. Companion Progression Manager - управление прогрессией
    6. Companion Ability Manager - управление способностями
    7. Companion Customization Manager - управление кастомизацией
    8. Companion Stats Calculator - расчет статистики компаньонов
    9. Companion Effects Applier - применение эффектов компаньонов
    10. Companion Telemetry Collector - сбор телеметрии

  microservices:
    - name: companion-service
      port: 8091
      responsibility: |
        Обработка системы компаньонов:
        - Управление системой компаньонов
        - Управление каталогом компаньонов
        - Управление владением компаньонами
        - Управление призывом/отзывом
        - Управление прогрессией
        - Управление способностями
        - Управление кастомизацией
        - Расчет статистики
        - Применение эффектов
        - Сбор телеметрии
      components:
        - companion-manager: управление системой компаньонов
        - companion-catalog-manager: управление каталогом компаньонов
        - companion-ownership-manager: управление владением компаньонами
        - companion-summon-manager: управление призывом/отзывом
        - companion-progression-manager: управление прогрессией
        - companion-ability-manager: управление способностями
        - companion-customization-manager: управление кастомизацией
        - companion-stats-calculator: расчет статистики компаньонов
        - companion-effects-applier: применение эффектов компаньонов
        - companion-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/companion/catalog - каталог доступных компаньонов
        - GET /api/v1/companion/catalog/{companionTypeId} - информация о типе компаньона
        - POST /api/v1/companion/purchase - покупка компаньона
        - GET /api/v1/companion/{characterId}/companions - список компаньонов персонажа
        - GET /api/v1/companion/{characterId}/companions/{companionId} - информация о компаньоне
        - POST /api/v1/companion/{characterId}/companions/{companionId}/summon - призыв компаньона
        - POST /api/v1/companion/{characterId}/companions/{companionId}/dismiss - отзыв компаньона
        - GET /api/v1/companion/{characterId}/active - активный компаньон
        - POST /api/v1/companion/{characterId}/companions/{companionId}/rename - переименование компаньона
        - GET /api/v1/companion/{characterId}/companions/{companionId}/stats - статистика компаньона
        - POST /api/v1/companion/{characterId}/companions/{companionId}/abilities/{abilityId}/activate - активация способности
        - GET /api/v1/companion/{characterId}/companions/{companionId}/abilities - список способностей
        - POST /api/v1/companion/{characterId}/companions/{companionId}/customize - кастомизация компаньона
        - GET /api/v1/companion/{characterId}/companions/{companionId}/progression - прогрессия компаньона
      websocket_channels:
        - wss://api.necp.game/v1/companion/{characterId} - поток обновлений компаньонов персонажа
      events_published:
        - companion.purchased: куплен компаньон
        - companion.summoned: призван компаньон
        - companion.dismissed: отозван компаньон
        - companion.level-up: повышение уровня компаньона
        - companion.ability-activated: активирована способность
        - companion.customized: кастомизирован компаньон
        - companion.stats-updated: обновлена статистика
        - companion.effects-applied: применены эффекты
      events_subscribed:
        - character.created: создан персонаж
        - character.level-up: повышение уровня персонажа
        - combat.enemy-killed: убийство врага
        - quest.completed: завершение квеста
        - economy.transaction: транзакция в экономике
        - inventory.item-added: добавлен предмет в инвентарь

  companion_types:
    - name: combat_drone
      description: "Боевые дроны - атакующие, поддерживающие и разведывательные"
      categories:
        - attack: "атакующие дроны"
        - support: "поддерживающие дроны"
        - recon: "разведывательные дроны"
      stats:
        - health: "здоровье"
        - damage: "урон"
        - armor: "броня"
        - speed: "скорость"
        - range: "дальность атаки"

    - name: utility
      description: "Утилитарные помощники - сбор лута, хакерство, крафт"
      categories:
        - loot_collector: "сборщик лута"
        - hacking_assistant: "помощник по хакерству"
        - crafting_bot: "бот для крафта"
      stats:
        - efficiency: "эффективность"
        - speed: "скорость работы"
        - capacity: "вместимость"

    - name: social_pet
      description: "Социальные питомцы - кошки, собаки, дрон-птицы"
      categories:
        - cat: "кошка"
        - dog: "собака"
        - drone_bird: "дрон-птица"
      stats:
        - happiness: "счастье"
        - loyalty: "лояльность"
        - social_bonus: "социальный бонус"

  summon_system:
    process:
      - ownership_check: "проверка владения компаньоном"
      - active_companion_dismiss: "отзыв активного компаньона (если есть)"
      - summon_validation: "валидация призыва (зона, условия)"
      - companion_spawn: "спавн компаньона в мире"
      - effects_application: "применение эффектов компаньона"
      - status_update: "обновление статуса призыва"
    restrictions:
      - zone_restrictions: "ограничения по зонам"
      - cooldown: "кулдаун между призывами"
      - max_active: "максимум активных компаньонов (обычно 1)"
      - level_requirements: "требования по уровню"

  progression_system:
    levels:
      - max_level: 50
      - xp_per_level: "опыт для повышения уровня"
      - stat_growth: "рост статистики за уровень"
    xp_sources:
      - combat: "участие в бою"
      - quests: "выполнение квестов"
      - activities: "активности с компаньоном"
    stat_improvements:
      - health: "улучшение здоровья"
      - damage: "улучшение урона"
      - efficiency: "улучшение эффективности"
      - happiness: "улучшение счастья"

  abilities:
    active_abilities:
      - attack_command: "команда атаки"
      - defensive_mode: "оборонительный режим"
      - support_heal: "лечение поддержки"
      - recon_scan: "разведывательное сканирование"
      - loot_collect: "сбор лута"
      - hack_assist: "помощь в хакерстве"
    passive_abilities:
      - auto_collect: "автоматический сбор"
      - combat_assistance: "боевая помощь"
      - stat_bonus: "бонус к статистике"
      - social_bonus: "социальный бонус"
    cooldowns:
      - ability_cooldown: "кулдаун способности"
      - global_cooldown: "глобальный кулдаун"
    effects:
      - damage: "урон"
      - heal: "лечение"
      - buff: "бафф"
      - debuff: "дебафф"
      - utility: "утилитарный эффект"

  customization:
    options:
      - name: "имя компаньона"
      - appearance: "внешний вид"
      - colors: "цвета"
      - accessories: "аксессуары"
      - skins: "скины"
    restrictions:
      - ownership: "требуется владение"
      - level: "требования по уровню"
      - currency: "требуется валюта"

  data_flows:
    purchase_flow: |
      1. Игрок запрашивает покупку компаньона
      2. Companion Catalog Manager проверяет доступность
      3. Economy Service проверяет баланс
      4. Economy Service списывает валюту
      5. Companion Ownership Manager создает запись владения
      6. Companion Service публикует событие companion.purchased
      7. Realtime Gateway отправляет обновление клиенту

    summon_flow: |
      1. Игрок запрашивает призыв компаньона
      2. Companion Summon Manager проверяет владение
      3. Companion Summon Manager отзывает активного компаньона (если есть)
      4. Companion Summon Manager проверяет ограничения зоны
      5. Companion Summon Manager спавнит компаньона в мире
      6. Companion Effects Applier применяет эффекты
      7. Companion Service публикует событие companion.summoned
      8. Realtime Gateway отправляет обновление клиенту

    progression_flow: |
      1. Компаньон получает опыт (бой, квест, активность)
      2. Companion Progression Manager проверяет достаточность опыта
      3. Companion Progression Manager повышает уровень
      4. Companion Stats Calculator пересчитывает статистику
      5. Companion Effects Applier обновляет эффекты
      6. Companion Service публикует событие companion.level-up
      7. Realtime Gateway отправляет обновление клиенту

    ability_activation_flow: |
      1. Игрок активирует способность компаньона
      2. Companion Ability Manager проверяет доступность
      3. Companion Ability Manager проверяет кулдаун
      4. Companion Ability Manager активирует способность
      5. Companion Effects Applier применяет эффекты способности
      6. Companion Service публикует событие companion.ability-activated
      7. Realtime Gateway отправляет обновление клиенту

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций (покупка, призыв, прогрессия)
    mechanisms:
      - ACID транзакции для покупки компаньонов, призыва/отзыва, прогрессии и активации способностей
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении статистики
      - Валидация перед покупкой компаньона, призывом и активацией способностей
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (покупка компаньона, призыв, применение эффектов)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния компаньонов (покупка, призыв, отзыв, прогрессия, активация способностей,
      кастомизация, применение эффектов) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: CompanionPurchasedEvent, CompanionSummonedEvent, CompanionDismissedEvent, CompanionLevelUpEvent, CompanionAbilityActivatedEvent, CompanionCustomizedEvent.
    cqrs_pattern: |
      Разделение команд (покупка компаньона, призыв, активация способностей, кастомизация) и запросов
      (получение каталога, получение списка компаньонов, получение статистики) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как покупка компаньона (проверка баланса, списание валюты,
      создание записи владения, уведомление игрока) или призыв компаньона (проверка владения, отзыв активного,
      спавн в мире, применение эффектов, уведомление игрока), используется Saga Pattern
      для обеспечения атомарности операций между Companion Service, Economy Service, World Service, Combat Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    companion_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Покупка компаньона: event-based, ~0.001-0.01 events/sec на игрока
        - Получение каталога: event-based, ~0.01-0.02 requests/sec на игрока
        - Получение списка компаньонов: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций компаньонов
      latency_requirements: < 200-300ms для покупки компаньона, < 30-100ms для получения каталога
      sync_strategy: Strong Consistency (ACID транзакции) для покупки компаньонов

    summon_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Призыв компаньона: event-based, ~0.01-0.05 events/sec на игрока
        - Отзыв компаньона: event-based, ~0.01-0.05 events/sec на игрока
        - Получение активного компаньона: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций призыва
      latency_requirements: < 100-200ms для призыва/отзыва компаньона, < 30-100ms для получения активного
      sync_strategy: Strong Consistency (ACID транзакции) для призыва/отзыва

    progression_operations:
      tickrate: Event-based (on-demand при получении опыта) + 1-5 Hz для обновления статистики
      network_load: |
        - Получение опыта: event-based, ~0.01-0.1 events/sec на игрока
        - Повышение уровня: event-based, ~0.001-0.01 events/sec на игрока
        - Получение прогрессии: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций прогрессии
      latency_requirements: < 50-100ms для получения опыта, < 30-100ms для получения прогрессии
      sync_strategy: Strong Consistency (ACID транзакции) для прогрессии

    ability_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Активация способности: event-based, ~0.01-0.1 events/sec на игрока
        - Получение списка способностей: event-based, ~0.01-0.02 requests/sec на игрока
        - Обновление кулдаунов: event-based + 1-5 Hz, ~0.01-0.05 events/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций способностей
      latency_requirements: < 50-100ms для активации способности, < 30-100ms для получения списка
      sync_strategy: Strong Consistency (ACID транзакции) для активации способностей

    customization_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Кастомизация компаньона: event-based, ~0.001-0.01 events/sec на игрока
        - Переименование: event-based, ~0.001-0.01 events/sec на игрока
        - Получение кастомизации: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций кастомизации
      latency_requirements: < 100-200ms для кастомизации, < 30-100ms для получения кастомизации
      sync_strategy: Strong Consistency (ACID транзакции) для кастомизации

    stats_operations:
      tickrate: Event-based (on-demand при изменении) + 1-5 Hz для обновления статистики
      network_load: |
        - Расчет статистики: event-based, ~0.01-0.05 events/sec на игрока
        - Получение статистики: event-based, ~0.01-0.05 requests/sec на игрока
        - Обновление статистики: 1-5 Hz, ~0.01-0.05 events/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций статистики
      latency_requirements: < 50-100ms для расчета статистики, < 30-100ms для получения статистики
      sync_strategy: Strong Consistency (ACID транзакции) для расчета статистики

    effects_operations:
      tickrate: Event-based (on-demand при призыве/отзыве/активации способностей) + 20-60 Hz для активных эффектов в бою
      network_load: |
        - Применение эффектов: event-based, ~0.01-0.05 events/sec на игрока
        - Обновление эффектов в бою: 20-60 Hz, ~0.5-2 KB/sec на игрока
        - Получение эффектов: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций эффектов (без боя), ~0.5-2 KB/sec в бою
      latency_requirements: < 50-100ms для применения эффектов, < 10-50ms для обновления эффектов в бою
      sync_strategy: Strong Consistency (ACID транзакции) для применения эффектов, Eventual Consistency для обновлений в бою

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий компаньонов: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_structure:
    tables:
      - name: companion_types
        description: Типы компаньонов
        columns:
          - id: UUID PRIMARY KEY
          - code: VARCHAR(50) UNIQUE
          - name: VARCHAR(255)
          - category: ENUM (combat_drone, utility, social_pet)
          - subcategory: VARCHAR(50)
          - description: TEXT
          - base_stats: JSONB
          - abilities: JSONB
          - cost: JSONB
          - requirements: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: player_companions
        description: Компаньоны игроков
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - companion_type_id: UUID FOREIGN KEY
          - name: VARCHAR(255)
          - level: INTEGER
          - experience: INTEGER
          - stats: JSONB
          - customization: JSONB
          - is_summoned: BOOLEAN
          - summoned_at: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: companion_abilities
        description: Способности компаньонов
        columns:
          - id: UUID PRIMARY KEY
          - companion_id: UUID FOREIGN KEY
          - ability_id: VARCHAR(50)
          - ability_type: ENUM (active, passive)
          - level: INTEGER
          - cooldown_until: TIMESTAMP
          - is_unlocked: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: companion_progression_history
        description: История прогрессии компаньонов
        columns:
          - id: UUID PRIMARY KEY
          - companion_id: UUID FOREIGN KEY
          - level: INTEGER
          - experience: INTEGER
          - xp_gained: INTEGER
          - xp_source: VARCHAR(50)
          - created_at: TIMESTAMP

      - name: companion_telemetry
        description: Телеметрия компаньонов
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - companion_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    combat_service: |
      - Получение событий боя
      - Применение боевых эффектов компаньонов
      - Расчет урона и лечения
      - Интеграция с боевой системой

    inventory_service: |
      - Проверка наличия предметов для компаньонов
      - Добавление предметов, собранных компаньонами
      - Управление экипировкой компаньонов

    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Обновление статистики персонажа

    economy_service: |
      - Покупка компаньонов
      - Проверка баланса
      - Обработка транзакций
      - Логирование экономических операций

    quest_service: |
      - Получение событий квестов
      - Начисление опыта компаньонам за квесты
      - Интеграция с системой квестов

    realtime_gateway: |
      - Отправка realtime обновлений компаньонов
      - Синхронизация состояния компаньонов
      - Уведомления о событиях

    world_service: |
      - Спавн компаньонов в мире
      - Проверка ограничений зон
      - Управление позициями компаньонов

technical_specification:
  subtasks:
    - id: companion-manager
      title: Реализация менеджера системы компаньонов
      description: |
        Реализация Companion Manager с управлением системой компаньонов
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: companion-catalog-manager
      title: Реализация менеджера каталога компаньонов
      description: |
        Реализация Companion Catalog Manager с управлением каталогом компаньонов,
        типами и доступностью.
      dependencies: [companion-manager]
      estimated_effort: 3 days

    - id: companion-ownership-manager
      title: Реализация менеджера владения компаньонами
      description: |
        Реализация Companion Ownership Manager с управлением владением компаньонами,
        покупкой и проверкой владения.
      dependencies: [companion-manager]
      estimated_effort: 3 days

    - id: companion-summon-manager
      title: Реализация менеджера призыва/отзыва
      description: |
        Реализация Companion Summon Manager с управлением призывом/отзывом компаньонов,
        проверкой ограничений и спавном в мире.
      dependencies: [companion-manager]
      estimated_effort: 4 days

    - id: companion-progression-manager
      title: Реализация менеджера прогрессии
      description: |
        Реализация Companion Progression Manager с управлением прогрессией компаньонов,
        начислением опыта и повышением уровня.
      dependencies: [companion-manager]
      estimated_effort: 4 days

    - id: companion-ability-manager
      title: Реализация менеджера способностей
      description: |
        Реализация Companion Ability Manager с управлением способностями компаньонов,
        активацией и кулдаунами.
      dependencies: [companion-manager]
      estimated_effort: 4 days

    - id: companion-customization-manager
      title: Реализация менеджера кастомизации
      description: |
        Реализация Companion Customization Manager с управлением кастомизацией компаньонов,
        переименованием и изменением внешнего вида.
      dependencies: [companion-manager]
      estimated_effort: 3 days

    - id: companion-stats-calculator
      title: Реализация калькулятора статистики
      description: |
        Реализация Companion Stats Calculator с расчетом статистики компаньонов,
        учетом уровня и эффектов.
      dependencies: [companion-progression-manager]
      estimated_effort: 3 days

    - id: companion-effects-applier
      title: Реализация применения эффектов
      description: |
        Реализация Companion Effects Applier с применением эффектов компаньонов,
        интеграцией с боевой системой и миром.
      dependencies: [companion-manager]
      estimated_effort: 4 days

    - id: companion-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Companion Telemetry Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [companion-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений компаньонов,
        состояния и уведомлений.
      dependencies: [companion-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы компаньонов.
      dependencies: [companion-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для типов компаньонов, компаньонов игроков,
        способностей, прогрессии и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> CompanionService[Companion Service<br/>8091]
        
        CompanionService --> CM[Companion Manager]
        CompanionService --> CCM[Companion Catalog Manager]
        CompanionService --> COM[Companion Ownership Manager]
        CompanionService --> CSM[Companion Summon Manager]
        CompanionService --> CPM[Companion Progression Manager]
        CompanionService --> CAM[Companion Ability Manager]
        CompanionService --> CCuM[Companion Customization Manager]
        CompanionService --> CSC[Companion Stats Calculator]
        CompanionService --> CEA[Companion Effects Applier]
        CompanionService --> CTC[Companion Telemetry Collector]
        
        CM --> CCM
        CM --> COM
        CM --> CSM
        CM --> CPM
        CPM --> CSC
        CM --> CAM
        CM --> CCuM
        CM --> CEA
        
        CompanionService --> CombatService[Combat Service]
        CompanionService --> InventoryService[Inventory Service]
        CompanionService --> CharacterService[Character Service]
        CompanionService --> EconomyService[Economy Service]
        CompanionService --> QuestService[Quest Service]
        CompanionService --> WorldService[World Service]
        
        CompanionService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        CompanionService --> DB[(Companion DB)]
        
        Client --> WSCompanion[WebSocket<br/>Companion]
        WSCompanion --> CompanionService
    ```

  summon_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant CSM as Companion Summon Manager
        participant CEA as Companion Effects Applier
        participant WS as World Service
        participant EB as Event Bus
        
        P->>CSM: Summon companion
        CSM->>CSM: Check ownership
        CSM->>CSM: Dismiss active companion
        CSM->>CSM: Validate zone restrictions
        CSM->>WS: Spawn companion in world
        CSM->>CEA: Apply effects
        CSM->>EB: Publish companion.summoned
    ```

  progression_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Companion
        participant CPM as Companion Progression Manager
        participant CSC as Companion Stats Calculator
        participant CEA as Companion Effects Applier
        participant EB as Event Bus
        
        C->>CPM: Gain experience
        CPM->>CPM: Check level up
        CPM->>CPM: Level up
        CPM->>CSC: Recalculate stats
        CPM->>CEA: Update effects
        CPM->>EB: Publish companion.level-up
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния компаньонов
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (покупка компаньона, призыв, применение эффектов)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для компаньонов, призыва, прогрессии, способностей, кастомизации, статистики, эффектов и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы компаньонов:
      - Определены компоненты (Companion Manager, Companion Catalog Manager, Companion Ownership Manager, Companion Summon Manager, Companion Progression Manager, Companion Ability Manager, Companion Customization Manager, Companion Stats Calculator, Companion Effects Applier, Companion Telemetry Collector)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (companion_types, player_companions, companion_abilities, companion_progression_history, companion_telemetry)
      - Спроектирована система призыва/отзыва компаньонов
      - Спроектирована система прогрессии компаньонов
      - Спроектирована система способностей (активные/пассивные)
      - Спроектирована система кастомизации
      - Создано техническое задание
      - Разбито на подзадачи
