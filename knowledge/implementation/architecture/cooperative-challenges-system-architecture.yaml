metadata:
  id: cooperative-challenges-system-architecture
  title: Архитектура системы кооперативных испытаний
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-XXT00:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - gameplay
    - cooperative
    - challenges
    - teamwork
    - hardcore
  related_systems:
    - gameplay-service
    - social-service
    - achievement-service
  related_documents:
    - id: cooperative-challenges-idea
      relation: implements
  github_issue: 1507
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Не хватает испытаний, которые бы требовали высокой координации команды.
    Большинство контента можно пройти без идеальной координации.
  goal: |
    Создать архитектуру кооперативных испытаний, которая:
    - Требует синхронизированных действий команды
    - Предоставляет ролевые испытания
    - Тестирует координацию команды
    - Награждает за идеальную координацию
  essence: |
    Система кооперативных испытаний предоставляет три типа испытаний: Synchronized Actions,
    Role-Specific Challenges и Team Coordination Tests. Каждый тип требует идеальной координации.

architecture:
  overview: |
    Система кооперативных испытаний состоит из следующих компонентов:
    1. Cooperative Challenge Manager - управление кооперативными испытаниями
    2. Synchronization Tracker - отслеживание синхронизации действий
    3. Role Challenge Controller - управление ролевыми испытаниями
    4. Coordination Tester - тестирование координации команды
    5. Coordination Reward Calculator - расчёт наград за координацию

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка кооперативных испытаний:
        - Управление испытаниями
        - Отслеживание синхронизации
        - Тестирование координации
      components:
        - cooperative-challenge-manager: управление испытаниями
        - synchronization-tracker: отслеживание синхронизации
        - role-challenge-controller: управление ролевыми испытаниями
        - coordination-tester: тестирование координации
        - coordination-reward-calculator: расчёт наград
      endpoints:
        - POST /api/v1/gameplay/cooperative-challenges/start - начало испытания
        - POST /api/v1/gameplay/cooperative-challenges/synchronize - синхронизация действия
        - GET /api/v1/gameplay/cooperative-challenges/{id}/status - статус испытания
        - POST /api/v1/gameplay/cooperative-challenges/{id}/complete - завершение
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/cooperative-challenges/{challengeId} - события испытания
      events_published:
        - gameplay.cooperative-challenge.started: начало испытания
        - gameplay.cooperative-challenge.synchronized: синхронизация действия
        - gameplay.cooperative-challenge.completed: завершение испытания
        - gameplay.cooperative-challenge.coordination.perfect: идеальная координация

  data_flows:
    synchronization_flow: |
      1. Игроки должны выполнить синхронизированное действие
      2. Synchronization Tracker отслеживает действия всех игроков
      3. Synchronization Tracker проверяет окно синхронизации (±0.5 сек)
      4. При успешной синхронизации Coordination Reward Calculator увеличивает бонус
      5. Gameplay Service публикует событие gameplay.cooperative-challenge.synchronized

    coordination_test_flow: |
      1. Coordination Tester активирует тест координации
      2. Coordination Tester отслеживает позиционирование команды
      3. Coordination Tester отслеживает коммуникацию команды
      4. Coordination Tester отслеживает распределение ресурсов
      5. Coordination Tester оценивает координацию команды
      6. При идеальной координации выдается максимальный бонус

  database_structure:
    tables:
      - name: cooperative_challenge_sessions
        description: Сессии кооперативных испытаний
        columns:
          - id: UUID PRIMARY KEY
          - challenge_type: VARCHAR(100)
          - team_id: UUID FOREIGN KEY
          - synchronization_score: DECIMAL(5,2)
          - coordination_score: DECIMAL(5,2)
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)

      - name: synchronization_events
        description: События синхронизации
        columns:
          - id: UUID PRIMARY KEY
          - challenge_session_id: UUID FOREIGN KEY
          - player_id: UUID FOREIGN KEY
          - action_type: VARCHAR(100)
          - timestamp: TIMESTAMP
          - synchronized: BOOLEAN

  integrations:
    social_service: |
      - Координация команд
      - Управление группами

    achievement_service: |
      - Отслеживание достижений
      - Выдача титулов
      - Уведомления о достижениях

  technical_tasks:
    phases:
      phase_1:
        name: Cooperative Challenge Manager и Synchronization Tracker
        tasks:
          - Реализация Cooperative Challenge Manager
          - Реализация Synchronization Tracker
          - Управление испытаниями
          - Отслеживание синхронизации
          - Интеграция с Gameplay Service
        estimated_effort: 4 days

      phase_2:
        name: Role Challenge Controller и Coordination Tester
        tasks:
          - Реализация Role Challenge Controller
          - Реализация Coordination Tester
          - Управление ролевыми испытаниями
          - Тестирование координации
          - Интеграция с Social Service
        estimated_effort: 4 days


