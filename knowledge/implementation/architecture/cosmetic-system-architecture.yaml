metadata:
  id: cosmetic-system-architecture
  title: Архитектура системы косметики
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-30T20:50:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - monetization
    - personalization
    - cosmetics
  related_systems:
    - cosmetic-service
    - inventory-service
    - shop-service
    - economy-service
    - analytics-service
  related_documents:
    - id: backend-cosmetic-system
      relation: implements
  github_issue: 315
  visibility: internal
  audience:
    - architect
    - backend
    - monetization
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы косметики, включающую:
    - Управление каталогом косметических предметов
    - Систему покупки косметики
    - Систему экипировки косметики
    - Систему магазина и ротации
    - Систему редкостей
    - Интеграции с экономикой и инвентарем
  goal: |
    Создать архитектурную схему системы косметики с определением:
    - Компонентов для управления косметикой
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы косметики с поддержкой покупки, экипировки,
    магазина и редкостей.

architecture:
  overview: |
    Архитектура системы косметики состоит из следующих компонентов:
    1. Cosmetic Manager - управление системой косметики
    2. Cosmetic Catalog Manager - управление каталогом косметики
    3. Cosmetic Ownership Manager - управление владением косметикой
    4. Cosmetic Shop Manager - управление магазином и ротацией
    5. Cosmetic Equip Manager - управление экипировкой косметики
    6. Cosmetic Rarity Manager - управление редкостями
    7. Cosmetic Purchase Manager - управление покупкой косметики
    8. Cosmetic Preview Manager - управление предпросмотром косметики
    9. Cosmetic Analytics Collector - сбор аналитики
    10. Cosmetic Telemetry Collector - сбор телеметрии

  microservices:
    - name: cosmetic-service
      port: 8092
      responsibility: |
        Обработка системы косметики:
        - Управление системой косметики
        - Управление каталогом косметики
        - Управление владением косметикой
        - Управление магазином и ротацией
        - Управление экипировкой
        - Управление редкостями
        - Управление покупкой
        - Управление предпросмотром
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - cosmetic-manager: управление системой косметики
        - cosmetic-catalog-manager: управление каталогом косметики
        - cosmetic-ownership-manager: управление владением косметикой
        - cosmetic-shop-manager: управление магазином и ротацией
        - cosmetic-equip-manager: управление экипировкой косметики
        - cosmetic-rarity-manager: управление редкостями
        - cosmetic-purchase-manager: управление покупкой косметики
        - cosmetic-preview-manager: управление предпросмотром косметики
        - cosmetic-analytics-collector: сбор аналитики
        - cosmetic-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/cosmetic/catalog - каталог косметики
        - GET /api/v1/cosmetic/catalog/{cosmeticId} - информация о косметике
        - GET /api/v1/cosmetic/shop - ежедневный магазин
        - GET /api/v1/cosmetic/shop/rotation - информация о ротации
        - POST /api/v1/cosmetic/purchase - покупка косметики
        - GET /api/v1/cosmetic/{characterId}/cosmetics - список косметики персонажа
        - GET /api/v1/cosmetic/{characterId}/cosmetics/owned - владение косметикой
        - GET /api/v1/cosmetic/{characterId}/cosmetics/equipped - экипированная косметика
        - POST /api/v1/cosmetic/{characterId}/cosmetics/{cosmeticId}/equip - экипировка косметики
        - POST /api/v1/cosmetic/{characterId}/cosmetics/{cosmeticId}/unequip - снятие косметики
        - GET /api/v1/cosmetic/{characterId}/cosmetics/{cosmeticId}/preview - предпросмотр косметики
        - GET /api/v1/cosmetic/rarities - список редкостей
        - GET /api/v1/cosmetic/{characterId}/cosmetics/stats - статистика косметики
      websocket_channels:
        - wss://api.necp.game/v1/cosmetic/{characterId} - поток обновлений косметики персонажа
      events_published:
        - cosmetic.purchased: куплена косметика
        - cosmetic.equipped: экипирована косметика
        - cosmetic.unequipped: снята косметика
        - cosmetic.shop-rotated: обновлен магазин
        - cosmetic.rarity-unlocked: разблокирована редкость
        - cosmetic.stats-updated: обновлена статистика
      events_subscribed:
        - character.created: создан персонаж
        - economy.transaction: транзакция в экономике
        - inventory.item-added: добавлен предмет в инвентарь
        - achievement.unlocked: разблокировано достижение

  cosmetic_categories:
    - name: character_skin
      description: "Скины персонажа - изменение внешнего вида персонажа"
      slots:
        - head: "голова"
        - body: "тело"
        - legs: "ноги"
        - feet: "ноги"
        - hands: "руки"
      rarities:
        - common: "обычная"
        - rare: "редкая"
        - epic: "эпическая"
        - legendary: "легендарная"

    - name: weapon_skin
      description: "Скины оружия - изменение внешнего вида оружия"
      slots:
        - primary: "основное оружие"
        - secondary: "вторичное оружие"
        - melee: "ближнее оружие"
      rarities:
        - common: "обычная"
        - rare: "редкая"
        - epic: "эпическая"
        - legendary: "легендарная"

    - name: emote
      description: "Эмоции - анимации персонажа"
      slots:
        - emote_1: "эмоция 1"
        - emote_2: "эмоция 2"
        - emote_3: "эмоция 3"
        - emote_4: "эмоция 4"
      rarities:
        - common: "обычная"
        - rare: "редкая"
        - epic: "эпическая"
        - legendary: "легендарная"

    - name: title
      description: "Титулы - текстовые обозначения"
      slots:
        - title: "титул"
      rarities:
        - common: "обычная"
        - rare: "редкая"
        - epic: "эпическая"
        - legendary: "легендарная"

    - name: name_plate
      description: "Таблички с именами - визуальные элементы"
      slots:
        - name_plate: "табличка с именем"
      rarities:
        - common: "обычная"
        - rare: "редкая"
        - epic: "эпическая"
        - legendary: "легендарная"

  rarities:
    - name: common
      description: "Обычная редкость"
      color: "#FFFFFF"
      drop_rate: 0.5
      shop_frequency: "high"

    - name: rare
      description: "Редкая редкость"
      color: "#1E90FF"
      drop_rate: 0.3
      shop_frequency: "medium"

    - name: epic
      description: "Эпическая редкость"
      color: "#9B30FF"
      drop_rate: 0.15
      shop_frequency: "low"

    - name: legendary
      description: "Легендарная редкость"
      color: "#FFD700"
      drop_rate: 0.05
      shop_frequency: "very_low"

  shop_system:
    rotation:
      - frequency: "daily"
        description: "Ежедневная ротация магазина"
        items_per_rotation: 10-15
        rarity_distribution:
          - common: 40%
          - rare: 35%
          - epic: 20%
          - legendary: 5%
      - frequency: "weekly"
        description: "Еженедельная ротация магазина"
        items_per_rotation: 5-8
        rarity_distribution:
          - rare: 50%
          - epic: 40%
          - legendary: 10%
    algorithm:
      - selection: "выбор предметов для ротации"
      - rarity_balance: "балансировка редкостей"
      - exclusivity_check: "проверка эксклюзивности"
      - notification: "уведомление игроков"

  purchase_system:
    process:
      - ownership_check: "проверка владения"
      - availability_check: "проверка доступности"
      - currency_check: "проверка валюты"
      - currency_deduction: "списание валюты"
      - ownership_grant: "выдача владения"
      - notification: "уведомление игрока"
      - analytics_logging: "логирование в аналитику"
    restrictions:
      - exclusive_items: "эксклюзивные предметы"
      - time_limited: "временные ограничения"
      - level_requirements: "требования по уровню"

  equip_system:
    process:
      - ownership_check: "проверка владения"
      - slot_validation: "валидация слота"
      - current_equip_unequip: "снятие текущей косметики (если есть)"
      - equip_application: "применение косметики"
      - stats_update: "обновление статистики"
      - notification: "уведомление игрока"
    slots:
      - character_skin: "слот скина персонажа"
      - weapon_skin: "слот скина оружия"
      - emote: "слот эмоции"
      - title: "слот титула"
      - name_plate: "слот таблички с именем"

  preview_system:
    features:
      - 3d_preview: "3D предпросмотр косметики"
      - animation_preview: "предпросмотр анимаций"
      - comparison: "сравнение с текущей косметикой"
      - rotation: "вращение модели"
    restrictions:
      - ownership: "требуется владение для некоторых предпросмотров"
      - shop_items: "предпросмотр предметов из магазина"

  data_flows:
    purchase_flow: |
      1. Игрок запрашивает покупку косметики
      2. Cosmetic Purchase Manager проверяет владение
      3. Cosmetic Purchase Manager проверяет доступность
      4. Economy Service проверяет баланс
      5. Economy Service списывает валюту
      6. Cosmetic Ownership Manager выдает владение
      7. Cosmetic Service публикует событие cosmetic.purchased
      8. Realtime Gateway отправляет обновление клиенту

    equip_flow: |
      1. Игрок запрашивает экипировку косметики
      2. Cosmetic Equip Manager проверяет владение
      3. Cosmetic Equip Manager проверяет слот
      4. Cosmetic Equip Manager снимает текущую косметику (если есть)
      5. Cosmetic Equip Manager применяет косметику
      6. Cosmetic Service публикует событие cosmetic.equipped
      7. Realtime Gateway отправляет обновление клиенту

    shop_rotation_flow: |
      1. Триггер ротации магазина (ежедневно/еженедельно)
      2. Cosmetic Shop Manager выбирает предметы для ротации
      3. Cosmetic Shop Manager балансирует редкости
      4. Cosmetic Shop Manager проверяет эксклюзивность
      5. Cosmetic Shop Manager сохраняет ротацию в БД
      6. Cosmetic Service публикует событие cosmetic.shop-rotated
      7. Notification Service отправляет уведомления игрокам
      8. Realtime Gateway отправляет обновление клиентам

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций (покупка, экипировка)
    mechanisms:
      - ACID транзакции для покупки косметики, экипировки и ротации магазина
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении экипировки
      - Валидация перед покупкой косметики и экипировкой
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (покупка косметики, экипировка, ротация магазина)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния косметики (покупка, экипировка, снятие, ротация магазина,
      разблокировка редкости) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: CosmeticPurchasedEvent, CosmeticEquippedEvent, CosmeticUnequippedEvent, ShopRotatedEvent, RarityUnlockedEvent.
    cqrs_pattern: |
      Разделение команд (покупка косметики, экипировка, ротация магазина) и запросов
      (получение каталога, получение списка косметики, получение экипированной косметики) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как покупка косметики (проверка баланса, списание валюты,
      выдача владения, уведомление игрока) или экипировка косметики (проверка владения, снятие текущей,
      применение новой, обновление статистики, уведомление игрока), используется Saga Pattern
      для обеспечения атомарности операций между Cosmetic Service, Economy Service, Character Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    catalog_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Получение каталога: event-based, ~0.01-0.05 requests/sec на игрока
        - Получение информации о косметике: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций каталога
      latency_requirements: < 30-100ms для получения каталога, < 20-50ms для получения информации
      sync_strategy: Eventual Consistency для каталога (кэширование в Redis)

    shop_operations:
      tickrate: Event-based (on-demand) + cron-triggered для ротации (ежедневно/еженедельно)
      network_load: |
        - Получение магазина: event-based, ~0.01-0.05 requests/sec на игрока
        - Получение информации о ротации: event-based, ~0.001-0.01 requests/sec на игрока
        - Ротация магазина: cron-triggered, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций магазина
      latency_requirements: < 30-100ms для получения магазина, < 50-200ms для ротации
      sync_strategy: Strong Consistency (ACID транзакции) для ротации, Eventual Consistency для получения магазина

    purchase_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Покупка косметики: event-based, ~0.001-0.01 events/sec на игрока
        - Проверка владения: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций покупки
      latency_requirements: < 200-300ms для покупки косметики, < 30-100ms для проверки владения
      sync_strategy: Strong Consistency (ACID транзакции) для покупки косметики

    equip_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Экипировка косметики: event-based, ~0.01-0.05 events/sec на игрока
        - Снятие косметики: event-based, ~0.01-0.05 events/sec на игрока
        - Получение экипированной косметики: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций экипировки
      latency_requirements: < 100-200ms для экипировки/снятия косметики, < 30-100ms для получения экипированной
      sync_strategy: Strong Consistency (ACID транзакции) для экипировки косметики

    preview_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Предпросмотр косметики: event-based, ~0.01-0.05 requests/sec на игрока
        - 3D предпросмотр: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций предпросмотра
      latency_requirements: < 100-200ms для предпросмотра, < 200-300ms для 3D предпросмотра
      sync_strategy: Eventual Consistency для предпросмотра (кэширование)

    rarity_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Получение списка редкостей: event-based, ~0.001-0.01 requests/sec на игрока
        - Разблокировка редкости: event-based, ~0.001-0.01 events/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций редкостей
      latency_requirements: < 30-100ms для получения списка, < 50-150ms для разблокировки
      sync_strategy: Strong Consistency (ACID транзакции) для разблокировки редкости

    stats_operations:
      tickrate: Event-based (on-demand при изменении) + 1-5 Hz для обновления статистики
      network_load: |
        - Получение статистики: event-based, ~0.01-0.02 requests/sec на игрока
        - Обновление статистики: 1-5 Hz, ~0.01-0.05 events/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций статистики
      latency_requirements: < 30-100ms для получения статистики, < 50-100ms для обновления
      sync_strategy: Eventual Consistency для статистики (кэширование в Redis)

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий косметики: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_structure:
    tables:
      - name: cosmetic_items
        description: Каталог косметических предметов
        columns:
          - id: UUID PRIMARY KEY
          - code: VARCHAR(50) UNIQUE
          - name: VARCHAR(255)
          - category: ENUM (character_skin, weapon_skin, emote, title, name_plate)
          - rarity: ENUM (common, rare, epic, legendary)
          - cost: JSONB
          - assets: JSONB
          - description: TEXT
          - is_exclusive: BOOLEAN
          - is_time_limited: BOOLEAN
          - available_from: TIMESTAMP
          - available_until: TIMESTAMP
          - level_requirement: INTEGER
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: player_cosmetics
        description: Владение косметикой игроками
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - cosmetic_id: UUID FOREIGN KEY
          - source: VARCHAR(50)
          - acquired_at: TIMESTAMP
          - usage_count: INTEGER
          - last_used_at: TIMESTAMP

      - name: player_equipped_cosmetics
        description: Экипированная косметика игроков
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - slot_type: ENUM (character_skin, weapon_skin, emote, title, name_plate)
          - slot_name: VARCHAR(50)
          - cosmetic_id: UUID FOREIGN KEY
          - equipped_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: cosmetic_shop_rotations
        description: Ротации магазина косметики
        columns:
          - id: UUID PRIMARY KEY
          - rotation_type: ENUM (daily, weekly)
          - start_date: TIMESTAMP
          - end_date: TIMESTAMP
          - items: JSONB
          - created_at: TIMESTAMP

      - name: cosmetic_telemetry
        description: Телеметрия косметики
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - character_id: UUID FOREIGN KEY
          - cosmetic_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    inventory_service: |
      - Проверка наличия косметики в инвентаре
      - Добавление косметики в инвентарь
      - Управление косметическими предметами

    economy_service: |
      - Покупка косметики
      - Проверка баланса
      - Обработка транзакций
      - Логирование экономических операций

    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Обновление внешнего вида персонажа

    shop_service: |
      - Управление магазином
      - Ротация товаров
      - Уведомления о новых товарах

    analytics_service: |
      - Логирование всех операций косметики
      - Сбор метрик эффективности
      - Анализ паттернов покупок
      - Мониторинг популярности косметики

    notification_service: |
      - Уведомления о новых товарах в магазине
      - Уведомления о покупке косметики
      - Уведомления о ротации магазина

    achievement_service: |
      - Интеграция с достижениями
      - Разблокировка достижений за косметику
      - Обновление прогресса достижений

    realtime_gateway: |
      - Отправка realtime обновлений косметики
      - Синхронизация экипированной косметики
      - Уведомления о событиях

technical_specification:
  subtasks:
    - id: cosmetic-manager
      title: Реализация менеджера системы косметики
      description: |
        Реализация Cosmetic Manager с управлением системой косметики
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: cosmetic-catalog-manager
      title: Реализация менеджера каталога косметики
      description: |
        Реализация Cosmetic Catalog Manager с управлением каталогом косметики,
        типами и доступностью.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: cosmetic-ownership-manager
      title: Реализация менеджера владения косметикой
      description: |
        Реализация Cosmetic Ownership Manager с управлением владением косметикой,
        проверкой владения и выдачей косметики.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: cosmetic-shop-manager
      title: Реализация менеджера магазина и ротации
      description: |
        Реализация Cosmetic Shop Manager с управлением магазином,
        ротацией товаров и алгоритмом выбора.
      dependencies: [cosmetic-manager]
      estimated_effort: 4 days

    - id: cosmetic-equip-manager
      title: Реализация менеджера экипировки косметики
      description: |
        Реализация Cosmetic Equip Manager с управлением экипировкой косметики,
        слотами и применением косметики.
      dependencies: [cosmetic-manager]
      estimated_effort: 4 days

    - id: cosmetic-rarity-manager
      title: Реализация менеджера редкостей
      description: |
        Реализация Cosmetic Rarity Manager с управлением редкостями,
        расчетом вероятностей и визуальными эффектами.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: cosmetic-purchase-manager
      title: Реализация менеджера покупки косметики
      description: |
        Реализация Cosmetic Purchase Manager с управлением покупкой косметики,
        проверкой ограничений и обработкой транзакций.
      dependencies: [cosmetic-ownership-manager]
      estimated_effort: 4 days

    - id: cosmetic-preview-manager
      title: Реализация менеджера предпросмотра косметики
      description: |
        Реализация Cosmetic Preview Manager с управлением предпросмотром косметики,
        3D предпросмотром и сравнением.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: cosmetic-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Cosmetic Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: cosmetic-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Cosmetic Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [cosmetic-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений косметики,
        экипировки и уведомлений.
      dependencies: [cosmetic-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы косметики.
      dependencies: [cosmetic-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для косметических предметов, владения,
        экипировки, ротаций и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> CosmeticService[Cosmetic Service<br/>8092]
        
        CosmeticService --> CM[Cosmetic Manager]
        CosmeticService --> CCM[Cosmetic Catalog Manager]
        CosmeticService --> COM[Cosmetic Ownership Manager]
        CosmeticService --> CSM[Cosmetic Shop Manager]
        CosmeticService --> CEM[Cosmetic Equip Manager]
        CosmeticService --> CRM[Cosmetic Rarity Manager]
        CosmeticService --> CPM[Cosmetic Purchase Manager]
        CosmeticService --> CPvM[Cosmetic Preview Manager]
        CosmeticService --> CAC[Cosmetic Analytics Collector]
        CosmeticService --> CTC[Cosmetic Telemetry Collector]
        
        CM --> CCM
        CM --> COM
        CM --> CSM
        CM --> CEM
        CM --> CRM
        COM --> CPM
        CM --> CPvM
        
        CosmeticService --> InventoryService[Inventory Service]
        CosmeticService --> EconomyService[Economy Service]
        CosmeticService --> CharacterService[Character Service]
        CosmeticService --> ShopService[Shop Service]
        CosmeticService --> AnalyticsService[Analytics Service]
        CosmeticService --> NotificationService[Notification Service]
        CosmeticService --> AchievementService[Achievement Service]
        
        CosmeticService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        CosmeticService --> DB[(Cosmetic DB)]
        
        Client --> WSCosmetic[WebSocket<br/>Cosmetic]
        WSCosmetic --> CosmeticService
    ```

  purchase_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant CPM as Cosmetic Purchase Manager
        participant ES as Economy Service
        participant COM as Cosmetic Ownership Manager
        participant EB as Event Bus
        
        P->>CPM: Purchase cosmetic
        CPM->>CPM: Check ownership
        CPM->>CPM: Check availability
        CPM->>ES: Check balance
        ES->>ES: Deduct currency
        CPM->>COM: Grant ownership
        CPM->>EB: Publish cosmetic.purchased
    ```

  equip_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant CEM as Cosmetic Equip Manager
        participant EB as Event Bus
        
        P->>CEM: Equip cosmetic
        CEM->>CEM: Check ownership
        CEM->>CEM: Validate slot
        CEM->>CEM: Unequip current (if any)
        CEM->>CEM: Apply cosmetic
        CEM->>EB: Publish cosmetic.equipped
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния косметики
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (покупка косметики, экипировка, ротация магазина)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для каталога, магазина, покупки, экипировки, предпросмотра, редкостей, статистики и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы косметики:
      - Определены компоненты (Cosmetic Manager, Cosmetic Catalog Manager, Cosmetic Ownership Manager, Cosmetic Shop Manager, Cosmetic Equip Manager, Cosmetic Rarity Manager, Cosmetic Purchase Manager, Cosmetic Preview Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (cosmetic_items, player_cosmetics, player_equipped_cosmetics, cosmetic_shop_rotations, cosmetic_telemetry)
      - Спроектирована система покупки косметики
      - Спроектирована система экипировки косметики
      - Спроектирована система магазина и ротации
      - Спроектирована система редкостей
      - Создано техническое задание
      - Разбито на подзадачи
