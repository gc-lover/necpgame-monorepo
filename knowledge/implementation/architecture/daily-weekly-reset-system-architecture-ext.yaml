constraints: |
  - UNIQUE(player_id, quest_id, week_start)
indexes:
  - player_id, week_start
  - quest_id, week_start

  - name: reset_tracking
    description: Трекинг сбросов
    fields:
      - id: UUID (PK)
      - reset_type: ENUM (daily, weekly)
      - reset_date: DATE
      - status: ENUM (pending, in_progress, completed, failed)
      - started_at: TIMESTAMP
      - completed_at: TIMESTAMP (nullable)
      - players_processed:
          INTEGER (default: 0)
      - players_total: INTEGER
      - error_message: TEXT (nullable)
      - created_at: TIMESTAMP
    indexes:
      - reset_type, reset_date
      - status, reset_date

  - name: login_rewards_tracking
    description: Трекинг логин-наград
    fields:
      - id: UUID (PK)
      - player_id: UUID (FK accounts)
      - reward_type: ENUM (daily, weekly, monthly)
      - day_number: INTEGER
      - claimed_at: TIMESTAMP
      - reward_data: JSONB
      - streak_days:
          INTEGER (default: 0)
      - last_login_date: DATE
      - created_at: TIMESTAMP
    constraints: |
      - UNIQUE(player_id, reward_type, day_number)
    indexes:
      - player_id, reward_type
      - last_login_date

  - name: daily_lockouts
    description: Ежедневные ограничения
    fields:
      - id: UUID (PK)
      - player_id: UUID (FK accounts)
      - lockout_type: VARCHAR(100)
      - lockout_data: JSONB
      - reset_date: DATE
      - expires_at: TIMESTAMP
      - created_at: TIMESTAMP
    constraints: |
      - UNIQUE(player_id, lockout_type, reset_date)
    indexes:
      - player_id, reset_date
      - expires_at

technical_specification:
  backend_requirements:
    - Реализация модулей в world-service-go:
        - reset (управление сбросами)
        - reset-quests (квесты)
        - reset-rewards (награды)
        - reset-scheduler (планировщик)
        - reset-executor (выполнение)
        - reset-events (события)
    - Интеграция с gameplay-service для квестов
    - Интеграция с economy-service для наград
    - Оптимизация запросов к БД (batch, индексы)

  cron_requirements:
    - Daily reset: каждые 24 часа в 00:00 UTC
    - Weekly reset: каждую неделю в понедельник 00:00 UTC
    - Retry логика: до 3 попыток
    - Мониторинг выполнения

  performance_requirements:
    - Выполнение daily reset < 30 минут
    - Выполнение weekly reset < 1 часа
    - Обработка 1000 игроков < 1 минуты
    - Поддержка до 1M игроков

  scalability_requirements:
    - Горизонтальное масштабирование через world-service
    - Распределение нагрузки на сбросы
    - Оптимизация запросов к БД (batch, индексы)
    - Параллельная обработка игроков

subtasks:
  - id: daily-reset-manager-module
    title: Реализация модуля Daily Reset Manager
    description: |
      Управление daily resets
      Сброс daily квестов и ограничений
      Трекинг daily прогресса
    priority: high
    estimated_time: 3-4 дня

  - id: weekly-reset-manager-implementation
    title: Реализация Weekly Reset Manager
    description: |
      Управление weekly resets
      Сброс weekly квестов и ограничений
      Трекинг weekly прогресса
    priority: high
    estimated_time: 3-4 дня

  - id: quest-pool-manager
    title: Реализация Quest Pool Manager
    description: |
      Управление пулами квестов
      Ротация квестов
      Выдача квестов игрокам
    priority: high
    estimated_time: 3-4 дня

  - id: login-rewards-manager
    title: Реализация Login Rewards Manager
    description: |
      Управление логин-наградами
      Трекинг дней логина
      Выдача наград
    priority: high
    estimated_time: 3-4 дня

  - id: reset-scheduler
    title: Реализация Reset Scheduler
    description: |
      Планирование сбросов
      Управление cron jobs
      Координация сбросов
    priority: high
    estimated_time: 2-3 дня

  - id: reset-executor
    title: Реализация Reset Executor
    description: |
      Выполнение сбросов
      Batch обработка игроков
      Транзакционность операций
    priority: high
    estimated_time: 3-4 дня

  - id: reset-event-handler
    title: Реализация Reset Event Handler
    description: |
      Обработка событий сбросов
      Публикация событий
      Подписка на события
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование пулов квестов
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для сбросов
      Интеграция с существующим API world-service
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты daily resets
      Тесты weekly resets
      Тесты login rewards
      Тесты интеграций
    priority: high
    estimated_time: 3-4 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "World Service"
            DRM[Daily Reset Manager]
            WRM[Weekly Reset Manager]
            QPM[Quest Pool Manager]
            LRM[Login Rewards Manager]
            RS[Reset Scheduler]
            RE[Reset Executor]
            REH[Reset Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>daily_quests_pool<br/>player_daily_quests<br/>weekly_quests_pool<br/>reset_tracking<br/>login_rewards_tracking)]
        end

        subgraph "External Services"
            GS[Gameplay Service]
            ES[Economy Service]
            SS[Social Service]
            LS[Leaderboard Service]
            MS[Mail Service]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Cron"
            CRON[Cron Jobs]
        end

        CRON --> RS
        RS --> RE
        RE --> DRM
        RE --> WRM
        DRM --> QPM
        WRM --> QPM
        QPM --> GS
        LRM --> ES
        RE --> LRM
        RE --> DB
        REH --> NS
        REH --> RG
        WRM --> LS
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant CRON as Cron
        participant RS as Reset Scheduler
        participant RE as Reset Executor
        participant DRM as Daily Reset Manager
        participant QPM as Quest Pool Manager
        participant REH as Reset Event Handler

        CRON->>RS: Daily reset trigger
        RS->>RE: Execute daily reset
        RE->>DRM: Reset daily quests
        DRM->>QPM: Assign new quests
        QPM->>QPM: Save to DB
        RE->>REH: Publish reset:daily-completed
        REH->>REH: Notify players
    ```

decisions:
  - id: adr-reset-architecture
    summary: |
      Выбрана модульная архитектура внутри world-service-go для обеспечения
      централизованного управления сбросами.

  - id: adr-batch-processing
    summary: |
      Batch обработка игроков обеспечивает эффективное выполнение сбросов
      для большого количества игроков.

  - id: adr-quest-pools
    summary: |
      Система пулов квестов с ротацией обеспечивает разнообразие контента
      и предотвращает повторение одних и тех же квестов.

  - id: adr-login-rewards
    summary: |
      Система логин-наград с сериями мотивирует игроков возвращаться
      ежедневно и повышает retention.

  - id: adr-cron-scheduling
    summary: |
      Cron jobs для сбросов обеспечивают надёжное выполнение в заданное время
      с возможностью retry при ошибках.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата расписаний и событий

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния сбросов
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (выполнение сброса, выдача наград)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для сбросов, выдачи квестов, логин-наград и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы Daily/Weekly Reset:
      - Определены компоненты (Daily Reset Manager, Weekly Reset Manager, Quest Pool Manager, Login Rewards Manager, Reset Scheduler, Reset Executor, Reset Event Handler)
      - Описаны типы сбросов (daily, weekly)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (daily_quests_pool, player_daily_quests, weekly_quests_pool, player_weekly_quests, reset_tracking, login_rewards_tracking, daily_lockouts)
      - Спроектирована система daily resets
      - Спроектирована система weekly resets
      - Спроектирована система login rewards
      - Спроектирована система cron jobs
      - Создано техническое задание
      - Разбито на подзадачи

