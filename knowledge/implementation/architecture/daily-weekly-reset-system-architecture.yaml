metadata:
  id: daily-weekly-reset-system-architecture
  title: Архитектура системы Daily/Weekly Reset
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-21T12:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - resets
    - engagement
    - liveops
    - world
  related_systems:
    - world-service
    - gameplay-service
    - economy-service
    - social-service
    - notification-service
    - analytics-service
  related_documents:
    - id: backend-daily-weekly-reset-system
      relation: implements
  github_issue: 215
  visibility: internal
  audience:
    - architect
    - backend
    - world
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы Daily/Weekly Reset, включающую:
    - Ежедневные и еженедельные сбросы квестов и наград
    - Управление логин-вознаграждениями
    - Систему cron jobs для автоматического выполнения сбросов
    - Интеграции с системами квестов, экономики и уведомлений
    - Трекинг прогресса игроков и предотвращение повторных сбросов
  goal: |
    Создать архитектурную схему системы сбросов с определением:
    - Компонентов для управления сбросами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы daily/weekly reset с поддержкой квестов,
    логин-наград, cron jobs и уведомлений.

architecture:
  overview: |
    Архитектура системы Daily/Weekly Reset состоит из следующих компонентов:
    1. Reset Manager - управление системой сбросов
    2. Daily Reset Processor - обработка ежедневных сбросов
    3. Weekly Reset Processor - обработка еженедельных сбросов
    4. Login Rewards Manager - управление логин-вознаграждениями
    5. Quest Reset Handler - сброс квестов
    6. Reward Reset Handler - сброс наград и ограничений
    7. Reset Scheduler - планировщик сбросов
    8. Reset Notification Service - уведомления игроков
    9. Reset Analytics Collector - сбор аналитики сбросов

  microservices:
    - name: world-service
      port: 8080
      responsibility: |
        Основной сервис для управления сбросами:
        - Управление системой сбросов
        - Обработка ежедневных сбросов
        - Обработка еженедельных сбросов
        - Управление логин-вознаграждениями
        - Сброс квестов
        - Сброс наград и ограничений
        - Планировка сбросов
        - Отправка уведомлений
        - Сбор аналитики
      components:
        - reset-manager: управление системой сбросов
        - daily-reset-processor: обработка ежедневных сбросов
        - weekly-reset-processor: обработка еженедельных сбросов
        - login-rewards-manager: управление логин-вознаграждениями
        - quest-reset-handler: сброс квестов
        - reward-reset-handler: сброс наград и ограничений
        - reset-scheduler: планировщик сбросов
        - reset-notification-service: уведомления игроков
        - reset-analytics-collector: сбор аналитики сбросов
      endpoints:
        - GET /api/v1/resets/status - получение статуса сбросов
        - GET /api/v1/resets/next-reset-times - получение времени следующих сбросов
        - POST /api/v1/resets/trigger-daily - ручной запуск daily reset (admin only)
        - POST /api/v1/resets/trigger-weekly - ручной запуск weekly reset (admin only)
        - GET /api/v1/resets/player/{characterId}/login-streak - получение серии логинов игрока
        - GET /api/v1/resets/player/{characterId}/login-rewards - получение доступных логин-наград
        - POST /api/v1/resets/player/{characterId}/claim-login-reward - получение логин-награды
        - GET /api/v1/resets/player/{characterId}/daily-quests - получение ежедневных квестов
        - GET /api/v1/resets/player/{characterId}/weekly-quests - получение еженедельных квестов
        - POST /api/v1/resets/player/{characterId}/refresh-daily-quests - обновление ежедневных квестов
        - POST /api/v1/resets/player/{characterId}/refresh-weekly-quests - обновление еженедельных квестов

  database:
    tables:
      - name: daily_quests_pool
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: quest_type
            type: VARCHAR(50)
          - name: quest_category
            type: VARCHAR(50)
          - name: quest_title
            type: TEXT
          - name: quest_description
            type: TEXT
          - name: objectives
            type: JSONB
          - name: rewards
            type: JSONB
          - name: difficulty
            type: VARCHAR(20)
          - name: is_active
            type: BOOLEAN
            default: true
          - name: created_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: updated_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
        indexes:
          - columns: [quest_type, quest_category]
          - columns: [is_active]

      - name: weekly_quests_pool
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: quest_type
            type: VARCHAR(50)
          - name: quest_title
            type: TEXT
          - name: quest_description
            type: TEXT
          - name: objectives
            type: JSONB
          - name: rewards
            type: JSONB
          - name: is_active
            type: BOOLEAN
            default: true
          - name: created_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: updated_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
        indexes:
          - columns: [quest_type]
          - columns: [is_active]

      - name: player_daily_quests
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: character_id
            type: BIGINT
          - name: quest_pool_id
            type: INTEGER
            references: daily_quests_pool(id)
          - name: assigned_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: completed_at
            type: TIMESTAMP
            nullable: true
          - name: progress
            type: JSONB
            default: '{}'
          - name: is_completed
            type: BOOLEAN
            default: false
        indexes:
          - columns: [character_id]
          - columns: [character_id, is_completed]
          - columns: [assigned_at]

      - name: player_weekly_quests
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: character_id
            type: BIGINT
          - name: quest_pool_id
            type: INTEGER
            references: weekly_quests_pool(id)
          - name: assigned_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: completed_at
            type: TIMESTAMP
            nullable: true
          - name: progress
            type: JSONB
            default: '{}'
          - name: is_completed
            type: BOOLEAN
            default: false
        indexes:
          - columns: [character_id]
          - columns: [character_id, is_completed]
          - columns: [assigned_at]

      - name: reset_tracking
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: character_id
            type: BIGINT
          - name: reset_type
            type: VARCHAR(20)  # 'daily' or 'weekly'
          - name: reset_date
            type: DATE
          - name: last_reset_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: next_reset_at
            type: TIMESTAMP
          - name: quests_refreshed
            type: BOOLEAN
            default: false
          - name: rewards_reset
            type: BOOLEAN
            default: false
        indexes:
          - columns: [character_id, reset_type]
          - columns: [reset_date]
          - columns: [next_reset_at]

      - name: login_rewards_tracking
        columns:
          - name: id
            type: SERIAL
            primary_key: true
          - name: character_id
            type: BIGINT
          - name: login_date
            type: DATE
          - name: login_streak
            type: INTEGER
            default: 1
          - name: last_login_at
            type: TIMESTAMP
            default: CURRENT_TIMESTAMP
          - name: rewards_claimed
            type: JSONB
            default: '[]'
          - name: streak_broken
            type: BOOLEAN
            default: false
        indexes:
          - columns: [character_id]
          - columns: [character_id, login_date]
          - columns: [last_login_at]

  integrations:
    - service: gameplay-service
      purpose: Получение данных о прогрессе квестов
      endpoints:
        - GET /api/v1/gameplay/quests/{characterId}/progress
        - POST /api/v1/gameplay/quests/{characterId}/reset-progress
    - service: economy-service
      purpose: Управление наградами и ограничениями
      endpoints:
        - GET /api/v1/economy/rewards/{characterId}/daily-limits
        - POST /api/v1/economy/rewards/{characterId}/reset-limits
        - POST /api/v1/economy/rewards/{characterId}/grant-login-reward
    - service: notification-service
      purpose: Отправка уведомлений о сбросах
      endpoints:
        - POST /api/v1/notifications/send
        - POST /api/v1/notifications/broadcast
    - service: analytics-service
      purpose: Сбор статистики сбросов
      endpoints:
        - POST /api/v1/analytics/events/reset-completed
        - POST /api/v1/analytics/events/login-streak-updated

  event_bus:
    events:
      - name: reset.daily.started
        payload:
          reset_time: timestamp
          affected_characters: integer
        description: Начало ежедневного сброса
      - name: reset.daily.completed
        payload:
          reset_time: timestamp
          processed_characters: integer
          duration_ms: integer
        description: Завершение ежедневного сброса
      - name: reset.weekly.started
        payload:
          reset_time: timestamp
          affected_characters: integer
        description: Начало еженедельного сброса
      - name: reset.weekly.completed
        payload:
          reset_time: timestamp
          processed_characters: integer
          duration_ms: integer
        description: Завершение еженедельного сброса
      - name: player.login-streak.updated
        payload:
          character_id: integer
          new_streak: integer
          previous_streak: integer
        description: Обновление серии логинов игрока
      - name: player.daily-quests.refreshed
        payload:
          character_id: integer
          new_quests_count: integer
          old_quests_count: integer
        description: Обновление ежедневных квестов игрока
      - name: player.weekly-quests.refreshed
        payload:
          character_id: integer
          new_quests_count: integer
          old_quests_count: integer
        description: Обновление еженедельных квестов игрока
      - name: player.login-reward.claimed
        payload:
          character_id: integer
          reward_day: integer
          reward_type: string
          reward_amount: integer
        description: Получение логин-награды игроком

  technical_requirements:
    - name: Cron Jobs
      description: |
        Система должна поддерживать cron jobs для автоматического выполнения сбросов:
        - Daily reset: каждый день в 00:00 UTC
        - Weekly reset: каждый понедельник в 00:00 UTC
        - Login streak reset: проверка каждый день в 00:01 UTC
      implementation:
        - Kubernetes CronJobs для надежности
        - Мониторинг выполнения через Prometheus
        - Ручной триггер для тестирования и аварийных ситуаций

    - name: Idempotency
      description: |
        Все операции сброса должны быть идемпотентными:
        - Повторный запуск daily reset не должен дублировать награды
        - Проверка временных окон для предотвращения повторных сбросов
        - Трекинг статуса выполнения сбросов
      implementation:
        - Проверка last_reset_at перед выполнением
        - Атомарные операции в БД
        - Graceful handling повторных вызовов

    - name: Performance
      description: |
        Система должна обрабатывать миллионы игроков:
        - Пакетная обработка игроков
        - Оптимизированные запросы к БД
        - Асинхронная обработка уведомлений
        - Кеширование часто используемых данных
      implementation:
        - Batch processing по 1000 игроков
        - Индексы на все ключевые поля
        - Redis cache для быстрого доступа
        - Background jobs для тяжелых операций

    - name: Monitoring
      description: |
        Полный мониторинг системы сбросов:
        - Метрики выполнения сбросов
        - Время обработки
        - Количество обработанных игроков
        - Ошибки и исключения
      implementation:
        - Prometheus metrics
        - Grafana dashboards
        - Alerts для сбоев
        - Логирование всех операций

  implementation_plan:
    subtasks:
      - name: "Архитектура компонентов"
        description: "Спроектировать компоненты Reset Manager, Daily/Weekly Processors"
        assignee: "architect"
        estimate_days: 2
        dependencies: []

      - name: "База данных"
        description: "Создать схему БД с таблицами для квестов, трекинга и наград"
        assignee: "database"
        estimate_days: 3
        dependencies: ["Архитектура компонентов"]

      - name: "API спецификации"
        description: "Создать OpenAPI спецификации для всех endpoints"
        assignee: "api-designer"
        estimate_days: 5
        dependencies: ["Архитектура компонентов", "База данных"]

      - name: "Backend реализация"
        description: "Реализовать сервисы сбросов в world-service"
        assignee: "backend"
        estimate_days: 15
        dependencies: ["API спецификации"]

      - name: "Интеграционное тестирование"
        description: "Протестировать интеграции с gameplay, economy, notification сервисами"
        assignee: "qa"
        estimate_days: 5
        dependencies: ["Backend реализация"]

      - name: "Мониторинг и оптимизация"
        description: "Добавить метрики, алерты и оптимизировать производительность"
        assignee: "performance"
        estimate_days: 3
        dependencies: ["Backend реализация"]

  risks:
    - name: "Производительность массовых сбросов"
      impact: high
      probability: medium
      mitigation: "Batch processing, индексы, кеширование, асинхронная обработка"
    - name: "Идемпотентность операций"
      impact: high
      probability: low
      mitigation: "Проверка временных окон, атомарные операции, graceful error handling"
    - name: "Временные зоны игроков"
      impact: medium
      probability: low
      mitigation: "Все расчеты в UTC, конвертация на клиенте"
    - name: "Сбой cron jobs"
      impact: high
      probability: low
      mitigation: "Kubernetes CronJobs, monitoring, manual triggers"

  success_criteria:
    - Архитектура системы полностью спроектирована
    - Все компоненты и их взаимодействия определены
    - Микросервисы и endpoints идентифицированы
    - Структура БД спроектирована с индексами
    - Система daily resets спроектирована
    - Система weekly resets спроектирована
    - Система login rewards спроектирована
    - Система cron jobs спроектирована
    - Техническое задание для реализации готово
    - План реализации с оценками сроков готов

review:
  chain: []
  next_actions: []
appendix:
  glossary:
    - term: "Daily Reset"
      definition: "Ежедневный сброс квестов, наград и ограничений, происходящий каждый день в полночь UTC"
    - term: "Weekly Reset"
      definition: "Еженедельный сброс квестов, наград и ограничений, происходящий каждый понедельник в полночь UTC"
    - term: "Login Streak"
      definition: "Серия последовательных дней входа игрока в игру без пропусков"
    - term: "Login Rewards"
      definition: "Награды за ежедневный вход в игру, зависящие от login streak"
  references:
    - id: backend-daily-weekly-reset-system
      title: "Реализация Daily/Weekly Reset System"
      type: implementation
  decisions: []

history:
  - version: "1.0.0"
    date: 2025-12-21
    author: architect
    changes: "Создана полная архитектура системы Daily/Weekly Reset"

validation:
  checksum: ""
  schema_version: "1.0"