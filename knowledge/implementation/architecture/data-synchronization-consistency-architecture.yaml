metadata:
  id: data-synchronization-consistency-architecture
  title: Архитектура синхронизации данных и консистентности
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-29T12:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - data-synchronization
    - consistency
    - infrastructure
    - microservices
  related_systems:
    - character-service-go
    - inventory-service-go
    - world-service-go
    - realtime-gateway-go
    - event-bus
  related_documents:
    - id: data-synchronization-consistency-guide
      relation: implements
    - id: realtime-server-system-architecture
      relation: extends
    - id: global-state-system-architecture
      relation: extends
  github_issue: 1521
  visibility: internal
  audience:
    - architect
    - backend
    - infrastructure
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру синхронизации данных между различными слоями
    (клиент, сервер, база данных) и механиками игры (инвентарь, персонаж, квесты, боевая система)
    для обеспечения консистентности данных в распределенной микросервисной архитектуре.
  goal: |
    Создать архитектурную схему системы синхронизации данных с определением:
    - Компонентов для синхронизации между слоями и механиками
    - Паттернов синхронизации (Event Bus, Outbox, Saga)
    - Стратегий консистентности (Strong vs Eventual)
    - Механизмов разрешения конфликтов
    - Интеграций с существующими системами
    - Структуры БД для синхронизации
    - Технического задания для реализации
  essence: |
    Комплексная архитектура синхронизации данных с использованием событийной архитектуры,
    паттернов распределенных систем и стратегий консистентности для MMORPG.

architecture:
  overview: |
    Архитектура синхронизации данных состоит из следующих компонентов:
    1. Event Bus Manager - управление Event Bus (Kafka)
    2. Outbox Pattern Processor - гарантированная доставка событий
    3. Saga Orchestrator - координация распределенных транзакций
    4. State Synchronization Manager - синхронизация состояния между сервисами
    5. Conflict Resolution Engine - разрешение конфликтов
    6. Consistency Monitor - мониторинг консистентности
    7. Data Validation Service - валидация данных
    8. Sync Analytics Collector - сбор аналитики синхронизации

  microservices:
    - name: sync-service
      port: 8090
      responsibility: |
        Центральный сервис для синхронизации данных:
        - Управление Event Bus
        - Обработка Outbox Pattern
        - Оркестрация Saga транзакций
        - Синхронизация состояния
        - Разрешение конфликтов
        - Мониторинг консистентности
      components:
        - event-bus-manager: управление Event Bus
        - outbox-processor: обработка Outbox Pattern
        - saga-orchestrator: оркестрация Saga транзакций
        - state-sync-manager: синхронизация состояния
        - conflict-resolver: разрешение конфликтов
        - consistency-monitor: мониторинг консистентности
        - data-validator: валидация данных
        - sync-analytics: сбор аналитики

  components:
    - name: Event Bus Manager
      location: sync-service
      responsibility: |
        Управление Event Bus (Kafka):
        - Создание и управление топиками
        - Публикация событий
        - Подписка на события
        - Гарантия доставки (at-least-once, exactly-once)
        - Управление партициями
        - Мониторинг производительности
      events_categories:
        - character.*: события персонажа
        - inventory.*: события инвентаря
        - quest.*: события квестов
        - combat.*: события боевой системы
        - economy.*: события экономики
        - world.*: события мира

    - name: Outbox Pattern Processor
      location: sync-service
      responsibility: |
        Гарантированная доставка событий из транзакций:
        - Чтение событий из таблицы Outbox
        - Публикация в Event Bus
        - Удаление обработанных событий
        - Retry при ошибках
        - Дедупликация событий
      flow: |
        1. Сервис выполняет транзакцию и записывает событие в Outbox
        2. Outbox Processor читает событие из Outbox
        3. Outbox Processor публикует событие в Event Bus
        4. После успешной публикации событие удаляется из Outbox

    - name: Saga Orchestrator
      location: sync-service
      responsibility: |
        Оркестрация распределенных транзакций:
        - Определение шагов Saga
        - Выполнение шагов последовательно
        - Компенсация при ошибках
        - Отслеживание состояния Saga
        - Retry и rollback
      saga_types:
        - choreography: каждый сервис знает следующий шаг
        - orchestration: центральный координатор управляет процессом
      example_saga: |
        Покупка предмета:
        1. InventoryService: резервирование слота
        2. CharacterService: проверка денег
        3. CharacterService: списание денег
        4. InventoryService: добавление предмета
        5. При ошибке → компенсирующие транзакции

    - name: State Synchronization Manager
      location: sync-service
      responsibility: |
        Синхронизация состояния между сервисами:
        - Server-wide синхронизация (мировые данные)
        - Player-specific синхронизация (персональные данные)
        - Phased синхронизация (сюжетные фазы)
        - Redis pub/sub для realtime обновлений
        - WebSocket каналы для клиентов
        - Инвалидация кэша
      sync_strategies:
        - strong_consistency: для критичных данных
        - eventual_consistency: для некритичных данных
        - hybrid: комбинация стратегий

    - name: Conflict Resolution Engine
      location: sync-service
      responsibility: |
        Разрешение конфликтов при одновременных изменениях:
        - Last Write Wins (LWW) для некритичных данных
        - Vector Clocks для распределенных систем
        - Operational Transformation (OT) для совместного редактирования
        - CRDT для автоматического разрешения конфликтов
        - Voting для критичных изменений
      conflict_types:
        - timestamp_conflict: конфликт по времени
        - version_conflict: конфликт версий
        - data_conflict: конфликт данных

    - name: Consistency Monitor
      location: sync-service
      responsibility: |
        Мониторинг консистентности данных:
        - Отслеживание времени синхронизации
        - Обнаружение неконсистентных данных
        - Метрики консистентности
        - Алерты при проблемах
        - Валидация данных между сервисами

    - name: Data Validation Service
      location: sync-service
      responsibility: |
        Валидация данных при синхронизации:
        - Референсная целостность (foreign keys)
        - Бизнес-правила
        - Согласованность между сервисами
        - Проверка версий данных
        - Валидация событий

  consistency_strategies:
    strong_consistency:
      application: |
        Критичные данные, требующие мгновенной консистентности:
        - Инвентарь (предметы, слоты)
        - Деньги (валюта, баланс)
        - Персонаж (статы, уровни)
        - Квесты (прогресс, награды)
      implementation: |
        - ACID транзакции (PostgreSQL)
        - Pessimistic locking для торговли
        - Optimistic locking для обновлений
        - Ссылочная целостность (foreign keys)
        - Уровни изоляции транзакций

    eventual_consistency:
      application: |
        Некритичные данные, где допустимы временные несоответствия:
        - Статистика игроков
        - Логи активности
        - Аналитика
        - Кэшируемые данные
      implementation: |
        - Асинхронная обработка через Event Bus
        - Event Sourcing для аудита
        - CQRS для чтения
        - Redis для кэширования

  synchronization_patterns:
    event_bus:
      description: Централизованная шина событий для обмена сообщениями
      implementation: Kafka
      guarantees: at-least-once delivery
      topics:
        - character-events
        - inventory-events
        - quest-events
        - combat-events
        - economy-events
        - world-events

    outbox_pattern:
      description: Гарантированная доставка событий из транзакций
      implementation: |
        Таблица Outbox в каждой БД сервиса:
        - event_id (UUID)
        - event_type (string)
        - payload (JSONB)
        - created_at (timestamp)
        - processed_at (timestamp)
        - status (pending, processed, failed)

    saga_pattern:
      description: Управление распределенными транзакциями
      implementation: |
        Orchestration-based Saga:
        - Центральный координатор (Saga Orchestrator)
        - Шаги Saga с компенсацией
        - Отслеживание состояния
        - Retry и rollback

    idempotency:
      description: Идемпотентность операций
      implementation: |
        - Уникальные ID для операций
        - Проверка выполнения перед повторным выполнением
        - Кэширование результатов

  api_endpoints:
    event_bus:
      - POST /api/v1/sync/events/publish - публикация события
      - GET /api/v1/sync/events/{event_id} - получение события
      - GET /api/v1/sync/events - список событий с фильтрацией

    outbox:
      - GET /api/v1/sync/outbox/pending - список ожидающих событий
      - POST /api/v1/sync/outbox/{event_id}/retry - повторная обработка
      - GET /api/v1/sync/outbox/stats - статистика Outbox

    saga:
      - POST /api/v1/sync/saga/start - запуск Saga
      - GET /api/v1/sync/saga/{saga_id} - состояние Saga
      - POST /api/v1/sync/saga/{saga_id}/compensate - компенсация

    state_sync:
      - POST /api/v1/sync/state/sync - синхронизация состояния
      - GET /api/v1/sync/state/{key} - получение состояния
      - POST /api/v1/sync/state/batch - пакетная синхронизация

    conflict_resolution:
      - POST /api/v1/sync/conflicts/resolve - разрешение конфликта
      - GET /api/v1/sync/conflicts - список конфликтов
      - POST /api/v1/sync/conflicts/{conflict_id}/resolve - разрешение

    consistency:
      - GET /api/v1/sync/consistency/check - проверка консистентности
      - GET /api/v1/sync/consistency/metrics - метрики консистентности
      - POST /api/v1/sync/consistency/fix - исправление неконсистентности

  websocket_channels:
    - wss://api.necp.game/v1/sync/state/{sessionId} - поток синхронизации состояния
    - wss://api.necp.game/v1/sync/events/{sessionId} - поток событий
    - wss://api.necp.game/v1/sync/conflicts/{sessionId} - поток конфликтов

  event_bus_events:
    published:
      - sync.state.updated: обновление состояния
      - sync.conflict.detected: обнаружение конфликта
      - sync.conflict.resolved: разрешение конфликта
      - sync.consistency.violation: нарушение консистентности
      - sync.saga.started: запуск Saga
      - sync.saga.completed: завершение Saga
      - sync.saga.failed: ошибка Saga
      - sync.outbox.processed: обработка Outbox события

    subscribed:
      - character.*: события персонажа
      - inventory.*: события инвентаря
      - quest.*: события квестов
      - combat.*: события боевой системы
      - economy.*: события экономики
      - world.*: события мира

  data_flows:
    client_server_sync: |
      1. Клиент отправляет действие через WebSocket
      2. Realtime Gateway валидирует действие
      3. Realtime Gateway отправляет в Gameplay Service
      4. Gameplay Service обрабатывает действие
      5. Gameplay Service записывает событие в Outbox
      6. Outbox Processor публикует событие в Event Bus
      7. Сервисы-подписчики получают событие
      8. Realtime Gateway получает обновление состояния
      9. Realtime Gateway отправляет обновление клиенту

    inter_service_sync: |
      1. Сервис A выполняет транзакцию
      2. Сервис A записывает событие в Outbox
      3. Outbox Processor публикует событие в Event Bus
      4. Сервис B подписан на событие
      5. Сервис B обрабатывает событие
      6. Сервис B обновляет свое состояние
      7. Сервис B может опубликовать новое событие

    saga_execution: |
      1. Saga Orchestrator запускает Saga
      2. Saga Orchestrator выполняет шаг 1 (Сервис A)
      3. Если успешно → шаг 2 (Сервис B)
      4. Если ошибка → компенсирующие транзакции
      5. После всех шагов → Saga завершена

  database_structure:
    outbox_table: |
      CREATE TABLE outbox (
        event_id UUID PRIMARY KEY,
        event_type VARCHAR(255) NOT NULL,
        payload JSONB NOT NULL,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        processed_at TIMESTAMP,
        status VARCHAR(50) NOT NULL DEFAULT 'pending',
        retry_count INT DEFAULT 0,
        error_message TEXT
      );

    saga_table: |
      CREATE TABLE saga (
        saga_id UUID PRIMARY KEY,
        saga_type VARCHAR(255) NOT NULL,
        status VARCHAR(50) NOT NULL,
        current_step INT NOT NULL,
        steps JSONB NOT NULL,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
      );

    sync_state_table: |
      CREATE TABLE sync_state (
        key VARCHAR(255) PRIMARY KEY,
        category VARCHAR(100) NOT NULL,
        value JSONB NOT NULL,
        version INT NOT NULL,
        updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_by UUID
      );

    conflict_table: |
      CREATE TABLE conflicts (
        conflict_id UUID PRIMARY KEY,
        key VARCHAR(255) NOT NULL,
        conflict_type VARCHAR(100) NOT NULL,
        old_value JSONB,
        new_value JSONB,
        detected_at TIMESTAMP NOT NULL DEFAULT NOW(),
        resolved_at TIMESTAMP,
        resolution_strategy VARCHAR(100)
      );

    consistency_check_table: |
      CREATE TABLE consistency_checks (
        check_id UUID PRIMARY KEY,
        service_name VARCHAR(255) NOT NULL,
        check_type VARCHAR(100) NOT NULL,
        status VARCHAR(50) NOT NULL,
        violations JSONB,
        checked_at TIMESTAMP NOT NULL DEFAULT NOW()
      );

  integrations:
    - service: character-service-go
      integration: |
        - Подписка на события персонажа
        - Публикация событий изменений персонажа
        - Использование Outbox Pattern
        - Участие в Saga транзакциях

    - service: inventory-service-go
      integration: |
        - Подписка на события инвентаря
        - Публикация событий изменений инвентаря
        - Использование Outbox Pattern
        - Участие в Saga транзакциях

    - service: world-service-go
      integration: |
        - Подписка на события мира
        - Публикация событий изменений мира
        - Использование State Synchronization Manager
        - Участие в Saga транзакциях

    - service: realtime-gateway-go
      integration: |
        - WebSocket синхронизация с клиентами
        - Подписка на события для realtime обновлений
        - Публикация событий от клиентов

    - service: event-bus (Kafka)
      integration: |
        - Управление топиками
        - Публикация и подписка на события
        - Гарантия доставки

  technical_specification:
    subtasks:
      - id: sync-1
        title: Event Bus Manager
        description: Реализация управления Event Bus (Kafka)
        effort: 8
        files:
          - services/sync-service/internal/eventbus/manager.go (350 строк)
          - services/sync-service/internal/eventbus/publisher.go (280 строк)
          - services/sync-service/internal/eventbus/subscriber.go (320 строк)

      - id: sync-2
        title: Outbox Pattern Processor
        description: Реализация Outbox Pattern для гарантированной доставки
        effort: 6
        files:
          - services/sync-service/internal/outbox/processor.go (380 строк)
          - services/sync-service/internal/outbox/repository.go (250 строк)

      - id: sync-3
        title: Saga Orchestrator
        description: Реализация Saga Orchestrator для распределенных транзакций
        effort: 10
        files:
          - services/sync-service/internal/saga/orchestrator.go (420 строк)
          - services/sync-service/internal/saga/step.go (280 строк)
          - services/sync-service/internal/saga/compensation.go (300 строк)

      - id: sync-4
        title: State Synchronization Manager
        description: Реализация синхронизации состояния между сервисами
        effort: 8
        files:
          - services/sync-service/internal/sync/manager.go (400 строк)
          - services/sync-service/internal/sync/strategies.go (350 строк)

      - id: sync-5
        title: Conflict Resolution Engine
        description: Реализация разрешения конфликтов
        effort: 6
        files:
          - services/sync-service/internal/conflict/resolver.go (380 строк)
          - services/sync-service/internal/conflict/strategies.go (320 строк)

      - id: sync-6
        title: Consistency Monitor
        description: Реализация мониторинга консистентности
        effort: 5
        files:
          - services/sync-service/internal/consistency/monitor.go (350 строк)
          - services/sync-service/internal/consistency/validator.go (280 строк)

      - id: sync-7
        title: API Endpoints
        description: Реализация REST API endpoints
        effort: 4
        files:
          - services/sync-service/internal/api/handlers.go (450 строк)

      - id: sync-8
        title: Database Migrations
        description: Создание миграций БД для синхронизации
        effort: 3
        files:
          - infrastructure/liquibase/changelogs/sync-service/V1_0__create_sync_tables.sql (200 строк)

  diagrams:
    component_diagram: |
      ```mermaid
      graph TB
        Client[Client] -->|WebSocket| Gateway[Realtime Gateway]
        Gateway -->|gRPC| Gameplay[Gameplay Service]
        Gameplay -->|Transaction| DB1[(Database)]
        Gameplay -->|Outbox| Outbox[Outbox Table]
        Outbox -->|Read| Processor[Outbox Processor]
        Processor -->|Publish| EventBus[Event Bus Kafka]
        EventBus -->|Subscribe| Character[Character Service]
        EventBus -->|Subscribe| Inventory[Inventory Service]
        EventBus -->|Subscribe| Quest[Quest Service]
        Character -->|State| Sync[State Sync Manager]
        Inventory -->|State| Sync
        Quest -->|State| Sync
        Sync -->|Sync| Redis[(Redis)]
        Sync -->|WebSocket| Gateway
        Gateway -->|Update| Client
      ```

    saga_flow: |
      ```mermaid
      sequenceDiagram
        Client->>Saga Orchestrator: Start Saga
        Saga Orchestrator->>Service A: Execute Step 1
        Service A-->>Saga Orchestrator: Success
        Saga Orchestrator->>Service B: Execute Step 2
        Service B-->>Saga Orchestrator: Success
        Saga Orchestrator->>Service C: Execute Step 3
        Service C-->>Saga Orchestrator: Error
        Saga Orchestrator->>Service B: Compensate Step 2
        Saga Orchestrator->>Service A: Compensate Step 1
        Saga Orchestrator-->>Client: Saga Failed
      ```









