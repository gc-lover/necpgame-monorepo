**Реализация:**
  - Kafka для критичных событий
  - RabbitMQ для некритичных событий
  - gRPC для синхронных вызовов (только при необходимости)
  
  **События:**
  - `character.level_up`
  - `inventory.item_added`
  - `quest.completed`
  - `combat.damage_dealt`
  - `economy.transaction_completed`
  
  ### 4. Database per Service
  
  **Принцип:** Каждый микросервис имеет свою БД
  
  **Преимущества:**
  - Независимость сервисов
  - Разные типы БД для разных задач
  - Масштабирование независимо
  
  **Синхронизация:**
  - Через события (Event Sourcing)
  - Через API (для критичных данных)
  - Через репликацию (для некритичных данных)
  
  ### 5. Caching Strategy
  
  **Уровни кэширования:**
  - **L1 (In-Memory):** Горячие данные в памяти сервиса
  - **L2 (Redis):** Распределенный кэш для общих данных
  - **L3 (Database):** Персистентное хранилище
  
  **Инвалидация:**
  - По времени (TTL)
  - По событиям (при изменении данных)
  - По версиям (версионирование данных)

- id: consistency_strategies
  title: Стратегии консистентности для разных типов данных
  body: |
    ## Классификация данных по критичности
    
    ### Критичные данные (Strong Consistency)
    
    **Требования:**
    - Мгновенная консистентность
    - ACID транзакции
    - Блокировки при необходимости
    
    **Примеры:**
    - Инвентарь (предметы, слоты)
    - Деньги (валюта, баланс)
    - Персонаж (статы, уровни)
    - Квесты (прогресс, награды)
    
    **Реализация:**
    - PostgreSQL с транзакциями
    - Pessimistic locking для торговли
    - Optimistic locking для обновлений
    
    ### Некритичные данные (Eventual Consistency)
    
    **Требования:**
    - Допустимы временные несоответствия
    - Синхронизация через события
    - Компенсация при ошибках
    
    **Примеры:**
    - Статистика игроков
    - Логи активности
    - Аналитика
    - Кэшируемые данные
    
    **Реализация:**
    - Асинхронная обработка
    - Event Sourcing
    - CQRS для чтения
    
    ### Гибридный подход
    
    **Принцип:** Разные стратегии для разных частей системы
    
    **Пример:**
    - Инвентарь: Strong Consistency (PostgreSQL)
    - Статистика: Eventual Consistency (Redis + события)
    - Логи: Eventual Consistency (Kafka + ClickHouse)

- id: conflict_resolution
  title: Разрешение конфликтов
  body: |
    ## Стратегии разрешения конфликтов
    
    ### 1. Last Write Wins (LWW)
    
    **Применение:** Некритичные данные
    
    **Реализация:**
    - Использование timestamp
    - Последнее обновление побеждает
    
    **Недостатки:** Потеря данных при одновременных обновлениях
    
    ### 2. Vector Clocks
    
    **Применение:** Распределенные системы
    
    **Реализация:**
    - Вектор временных меток для каждого узла
    - Определение причинно-следственных связей
    - Разрешение конфликтов на основе порядка событий
    
    ### 3. Operational Transformation (OT)
    
    **Применение:** Совместное редактирование
    
    **Реализация:**
    - Трансформация операций для согласования
    - Применение операций в правильном порядке
    
    ### 4. Conflict-Free Replicated Data Types (CRDTs)
    
    **Применение:** Распределенные структуры данных
    
    **Преимущества:**
    - Автоматическое разрешение конфликтов
    - Гарантированная консистентность
    - Без координации между узлами
    
    **Примеры:**
    - Counters (счетчики)
    - Sets (множества)
    - Maps (словари)

- id: monitoring_and_validation
  title: Мониторинг и валидация консистентности
  body: |
    ## Мониторинг консистентности
    
    ### 1. Метрики
    
    **Метрики для отслеживания:**
    - Время синхронизации между сервисами
    - Количество конфликтов
    - Задержка репликации
    - Количество неконсистентных данных
    
    ### 2. Валидация данных
    
    **Проверки:**
    - Референсная целостность (foreign keys)
    - Бизнес-правила (валидация данных)
    - Согласованность между сервисами
    
    ### 3. Алерты
    
    **Триггеры:**
    - Обнаружение неконсистентных данных
    - Превышение времени синхронизации
    - Критичные ошибки транзакций
    
    ### 4. Аудит
    
    **Логирование:**
    - Все изменения данных
    - События синхронизации
    - Ошибки и конфликты
    
    **Использование:**
    - Отладка проблем
    - Восстановление данных
    - Анализ производительности

appendix:
  glossary:
    - term: Strong Consistency (Строгая консистентность)
      definition: Все реплики данных мгновенно согласованы. Любое чтение возвращает последнее записанное значение.
    - term: Eventual Consistency (Конечная консистентность)
      definition: Данные могут быть временно несогласованы, но со временем синхронизируются.
    - term: ACID
      definition: Atomicity (атомарность), Consistency (консистентность), Isolation (изоляция), Durability (долговечность) - свойства транзакций.
    - term: Event Sourcing
      definition: Хранение всех изменений состояния как последовательности событий. Состояние вычисляется из событий.
    - term: CQRS
      definition: Command Query Responsibility Segregation - разделение операций чтения и записи для оптимизации.
    - term: Saga Pattern
      definition: Паттерн для управления распределенными транзакциями через последовательность локальных транзакций с компенсацией.
    - term: Outbox Pattern
      definition: Паттерн для гарантированной доставки событий из транзакций через таблицу Outbox.
    - term: Idempotency (Идемпотентность)
      definition: Свойство операции, при котором повторное выполнение дает тот же результат, что и первое выполнение.
    - term: Circuit Breaker
      definition: Паттерн для защиты от каскадных сбоев путем временного отключения недоступных сервисов.
    - term: Vector Clocks
      definition: Механизм для определения причинно-следственных связей в распределенных системах.
    - term: CRDT
      definition: Conflict-Free Replicated Data Types - структуры данных, автоматически разрешающие конфликты при репликации.

  references:
    - title: "Синхронизация данных в многопользовательских играх"
      link: https://habr.com/ru/articles/328702/
    - title: "Консистентность данных в распределенных системах"
      link: https://habr.com/ru/companies/flant/articles/500850/
    - title: "Event Sourcing и CQRS"
      link: https://martinfowler.com/eaaDev/EventSourcing.html
    - title: "Saga Pattern для микросервисов"
      link: https://microservices.io/patterns/data/saga.html
    - title: "Теорема CAP"
      link: https://ru.wikipedia.org/wiki/Теорема_CAP

  decisions:
    - date: 2025-11-29
      decision: Использовать Strong Consistency для критичных данных (инвентарь, деньги, персонаж)
      rationale: Критичные данные требуют мгновенной консистентности для предотвращения дублирования предметов, потери денег и других проблем.
    - date: 2025-11-29
      decision: Использовать Eventual Consistency для некритичных данных (статистика, логи, аналитика)
      rationale: Некритичные данные могут быть временно несогласованы, что позволяет улучшить производительность и масштабируемость.
    - date: 2025-11-29
      decision: Применить Event-Driven Architecture для синхронизации между механиками
      rationale: Событийная архитектура обеспечивает слабую связанность между механиками и упрощает добавление новых функций.
    - date: 2025-11-29
      decision: Использовать Saga Pattern для распределенных транзакций между микросервисами
      rationale: Saga Pattern более подходит для микросервисов, чем 2PC, так как не требует блокировок и обеспечивает лучшую производительность.

