metadata:
  id: device-system-architecture
  title: Архитектура системы устройств
  document_type: architecture
  category: systems
  status: approved
  version: "1.1.0"
  last_updated: 2025-12-28T17:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - device
    - gameplay
  related_systems:
    - gameplay-service-go
    - world-service-go
  related_documents:
    - id: network-system-architecture
      relation: extends
    - id: local-network-system-architecture
      relation: extends
  github_issue: 1449
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы устройств с поддержкой простых
    устройств (без сети) и сложных устройств (с сетью), а также возможностью
    объединения в локальную сеть.
  goal: |
    Создать архитектурную схему системы устройств с определением:
    - Микросервисов для управления устройствами
    - Компонентов для простых и сложных устройств
    - Дистанционного взаимодействия
    - Объединения в локальную сеть
    - API endpoints (высокоуровнево)
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Система управления устройствами с поддержкой простых и сложных устройств,
    дистанционного взаимодействия и объединения в локальную сеть.

architecture:
  overview: |
    Система устройств состоит из следующих компонентов:
    1. Device Service - управление устройствами
    2. Simple Device Manager - управление простыми устройствами
    3. Network Device Manager - управление сложными устройствами
    4. Device Interaction Service - взаимодействие с устройствами
    5. Local Network Manager - объединение устройств в локальную сеть

  device_types:
    - type: simple
      characteristics:
        - no_network: true
        - local_interaction_only: true
        - no_remote_access: true

    - type: network
      characteristics:
        - network_enabled: true
        - remote_access: true
        - local_network_capable: true

  microservices:
    - name: device-service
      location: gameplay-service-go (модуль device)
      port: 8083
      responsibility: |
        Управление устройствами:
        - CRUD операции с устройствами
        - Управление типами устройств
        - Управление состоянием устройств
        - Интеграция с миром игры
      endpoints:
        - GET /api/v1/gameplay/devices - список устройств
        - GET /api/v1/gameplay/devices/{deviceId} - информация об устройстве
        - POST /api/v1/gameplay/devices - создание устройства
        - PUT /api/v1/gameplay/devices/{deviceId} - обновление устройства
        - DELETE /api/v1/gameplay/devices/{deviceId} - удаление устройства

    - name: simple-device-manager
      location: gameplay-service-go (модуль device-simple)
      port: 8083
      responsibility: |
        Управление простыми устройствами:
        - Управление простыми устройствами без сети
        - Локальное взаимодействие
        - Проверка доступности устройства
      endpoints:
        - POST /api/v1/gameplay/devices/{deviceId}/interact - взаимодействие с устройством
        - GET /api/v1/gameplay/devices/{deviceId}/status - статус устройства

    - name: network-device-manager
      location: gameplay-service-go (модуль device-network)
      port: 8083
      responsibility: |
        Управление сложными устройствами:
        - Управление устройствами с сетью
        - Подключение устройств к сети
        - Дистанционное взаимодействие
        - Управление сетевыми функциями
      endpoints:
        - POST /api/v1/gameplay/devices/{deviceId}/network/connect - подключение к сети
        - POST /api/v1/gameplay/devices/{deviceId}/network/disconnect - отключение от сети
        - POST /api/v1/gameplay/devices/{deviceId}/remote/interact - дистанционное взаимодействие
        - GET /api/v1/gameplay/devices/{deviceId}/network/status - статус сети

    - name: device-interaction-service
      location: gameplay-service-go (модуль device-interaction)
      port: 8083
      responsibility: |
        Взаимодействие с устройствами:
        - Обработка взаимодействий с устройствами
        - Валидация взаимодействий
        - Применение эффектов взаимодействий
        - Интеграция с другими системами
      endpoints:
        - POST /api/v1/gameplay/devices/{deviceId}/interact - взаимодействие
        - GET /api/v1/gameplay/devices/{deviceId}/interactions - доступные взаимодействия

    - name: local-network-manager
      location: gameplay-service-go (модуль device-local-network)
      port: 8083
      responsibility: |
        Объединение устройств в локальную сеть:
        - Создание локальной сети
        - Добавление устройств в локальную сеть
        - Управление локальной сетью
        - Изоляция от глобальной сети
      endpoints:
        - POST /api/v1/gameplay/devices/local-network/create - создание локальной сети
        - POST /api/v1/gameplay/devices/local-network/{networkId}/devices/{deviceId} - добавление устройства
        - DELETE /api/v1/gameplay/devices/local-network/{networkId}/devices/{deviceId} - удаление устройства
        - GET /api/v1/gameplay/devices/local-network/{networkId} - информация о локальной сети

  integrations:
    network_service: |
      - Подключение устройств к сети
      - Дистанционное взаимодействие
      - Сетевая коммуникация

    local_network_service: |
      - Объединение устройств в локальную сеть
      - Изоляция от глобальной сети
      - Управление локальной сетью

    hacking_service: |
      - Взлом устройств
      - Защита устройств
      - Установка бекдоров

  technical_tasks:
    phase_1:
      name: Device Service Core
      tasks:
        - Реализация Device Service
        - CRUD операции с устройствами
        - Управление типами устройств
      estimated_effort: 4 days

    phase_2:
      name: Simple Device Manager
      tasks:
        - Реализация Simple Device Manager
        - Локальное взаимодействие
      estimated_effort: 2 days

    phase_3:
      name: Network Device Manager
      tasks:
        - Реализация Network Device Manager
        - Подключение к сети
        - Дистанционное взаимодействие
      estimated_effort: 4 days

    phase_4:
      name: Device Interaction Service
      tasks:
        - Реализация Device Interaction Service
        - Обработка взаимодействий
      estimated_effort: 3 days

    phase_5:
      name: Local Network Manager
      tasks:
        - Реализация Local Network Manager
        - Объединение устройств
        - Изоляция от глобальной сети
      estimated_effort: 3 days

    phase_6:
      name: Интеграции
      tasks:
        - Интеграция с Network Service
        - Интеграция с Local Network Service
        - Интеграция с Hacking Service
        - WebSocket каналы
      estimated_effort: 2 days

    total_estimated_effort: 18 days

  database_schema:
    device_table: |
      CREATE TABLE devices (
        id UUID PRIMARY KEY,
        player_id UUID NOT NULL,
        type VARCHAR(50) NOT NULL, -- 'simple' or 'network'
        name VARCHAR(255) NOT NULL,
        description TEXT,
        location_x FLOAT,
        location_y FLOAT,
        location_z FLOAT,
        status VARCHAR(50) DEFAULT 'inactive',
        network_id UUID, -- for local network membership
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

        FOREIGN KEY (player_id) REFERENCES players(id),
        FOREIGN KEY (network_id) REFERENCES local_networks(id)
      );

    device_interactions_table: |
      CREATE TABLE device_interactions (
        id UUID PRIMARY KEY,
        device_id UUID NOT NULL,
        player_id UUID NOT NULL,
        interaction_type VARCHAR(100) NOT NULL,
        parameters JSONB,
        result JSONB,
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

        FOREIGN KEY (device_id) REFERENCES devices(id),
        FOREIGN KEY (player_id) REFERENCES players(id)
      );

    local_networks_table: |
      CREATE TABLE local_networks (
        id UUID PRIMARY KEY,
        owner_id UUID NOT NULL,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        max_devices INTEGER DEFAULT 10,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

        FOREIGN KEY (owner_id) REFERENCES players(id)
      );

  websocket_integration:
    real_time_updates: |
      - Device status changes
      - Network connection events
      - Interaction results
      - Local network updates

    channels:
      - /ws/devices/{playerId} - personal device updates
      - /ws/networks/{networkId} - local network updates
      - /ws/devices/public - public device interactions

  security_considerations:
    access_control: |
      - Device ownership verification
      - Network membership checks
      - Interaction permission validation
      - Rate limiting for interactions

    data_protection: |
      - Encrypted device configurations
      - Secure network communications
      - Audit logging for all interactions
      - Anti-cheat measures for device manipulation

  monitoring_metrics:
    device_metrics: |
      - Active devices count
      - Device interaction frequency
      - Network performance stats
      - Error rates by device type

    performance_indicators: |
      - Average interaction response time
      - Network latency measurements
      - Memory usage per device type
      - Database query performance

  deployment_consideration:
    scaling_strategy: |
      - Horizontal scaling for device services
      - Database sharding by player regions
      - Redis caching for device states
      - CDN for static device assets

    high_availability: |
      - Multi-region deployment
      - Automatic failover mechanisms
      - Data backup and recovery
      - Service health monitoring

history:
  - version: '1.0.0'
    date: 2025-11-29
    author: architect
    changes: Создан первоначальный документ архитектуры системы устройств с базовыми компонентами.
  - version: '1.1.0'
    date: 2025-12-28
    author: architect
    changes: Расширена архитектура с детальной базой данных, WebSocket интеграцией, безопасностью, мониторингом и стратегией развертывания. Архитектура одобрена для реализации.

validation:
  checksum: ''
  schema_version: '1.0'

