metadata:
  id: difficulty-rating-system-architecture
  title: Архитектура системы рейтинга сложности
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-XXT00:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - gameplay
    - difficulty-rating
    - dynamic-difficulty
    - matchmaking
    - hardcore
  related_systems:
    - gameplay-service
    - matchmaking-service
    - analytics-service
  related_documents:
    - id: difficulty-rating-idea
      relation: implements
  github_issue: 1505
  visibility: internal
  audience:
    - architect
    - backend
    - matchmaking
    - api-designer

summary:
  problem: |
    Игроки часто выбирают неподходящую сложность контента, что приводит к фрустрации
    или скуке. Не хватает системы, которая бы автоматически подстраивала сложность
    под уровень игрока.
  goal: |
    Создать архитектуру рейтинга сложности, которая:
    - Автоматически определяет подходящую сложность для игрока
    - Подстраивает сложность контента под команду
    - Предоставляет рекомендации по сложности
    - Интегрируется с системой матчмейкинга
  essence: |
    Система рейтинга сложности анализирует навыки игроков и автоматически подстраивает
    сложность контента. Система учитывает историю прохождения и предпочтения игроков.

architecture:
  overview: |
    Система рейтинга сложности состоит из следующих компонентов:
    1. Player Skill Rater - оценка навыков игрока
    2. Content Difficulty Rater - оценка сложности контента
    3. Difficulty Adjuster - автоматическая подстройка сложности
    4. Recommendation Engine - рекомендации по сложности
    5. Rating Telemetry Collector - сбор телеметрии рейтингов

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка рейтинга сложности:
        - Оценка навыков игроков
        - Оценка сложности контента
        - Автоматическая подстройка
        - Рекомендации
      components:
        - player-skill-rater: оценка навыков
        - content-difficulty-rater: оценка сложности
        - difficulty-adjuster: автоматическая подстройка
        - recommendation-engine: рекомендации
        - rating-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/gameplay/difficulty-rating/player/{playerId} - рейтинг игрока
        - GET /api/v1/gameplay/difficulty-rating/content/{contentId} - рейтинг контента
        - GET /api/v1/gameplay/difficulty-rating/recommendations/{playerId} - рекомендации
        - POST /api/v1/gameplay/difficulty-rating/adjust - подстройка сложности
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/difficulty-rating/{playerId} - события рейтинга
      events_published:
        - gameplay.difficulty-rating.updated: обновление рейтинга
        - gameplay.difficulty-rating.recommendation: рекомендация сложности

  data_flows:
    skill_rating_flow: |
      1. Player Skill Rater анализирует историю прохождения игрока
      2. Player Skill Rater рассчитывает рейтинг навыков
      3. Player Skill Rater обновляет рейтинг в БД
      4. Gameplay Service публикует событие gameplay.difficulty-rating.updated
      5. Recommendation Engine использует рейтинг для рекомендаций

    difficulty_adjustment_flow: |
      1. Игрок входит в контент с командой
      2. Difficulty Adjuster получает рейтинги всех игроков
      3. Difficulty Adjuster рассчитывает средний рейтинг команды
      4. Difficulty Adjuster подстраивает сложность контента
      5. Gameplay Service применяет модификаторы сложности

  database_structure:
    tables:
      - name: player_skill_ratings
        description: Рейтинги навыков игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - skill_rating: DECIMAL(10,2)
          - completion_rate: DECIMAL(5,2)
          - average_time: INTEGER
          - average_deaths: DECIMAL(5,2)
          - updated_at: TIMESTAMP

      - name: content_difficulty_ratings
        description: Рейтинги сложности контента
        columns:
          - id: UUID PRIMARY KEY
          - content_id: UUID FOREIGN KEY
          - difficulty_rating: DECIMAL(10,2)
          - completion_rate: DECIMAL(5,2)
          - average_time: INTEGER
          - average_deaths: DECIMAL(5,2)
          - updated_at: TIMESTAMP

  integrations:
    matchmaking_service: |
      - Подбор игроков по рейтингу
      - Балансировка команд

    analytics_service: |
      - Анализ данных о рейтингах
      - Оптимизация алгоритмов

  technical_tasks:
    phases:
      phase_1:
        name: Player Skill Rater и Content Difficulty Rater
        tasks:
          - Реализация Player Skill Rater
          - Реализация Content Difficulty Rater
          - Оценка навыков игроков
          - Оценка сложности контента
          - Интеграция с Analytics Service
        estimated_effort: 4 days

      phase_2:
        name: Difficulty Adjuster и Recommendation Engine
        tasks:
          - Реализация Difficulty Adjuster
          - Реализация Recommendation Engine
          - Автоматическая подстройка сложности
          - Рекомендации по сложности
          - Интеграция с Matchmaking Service
        estimated_effort: 4 days


