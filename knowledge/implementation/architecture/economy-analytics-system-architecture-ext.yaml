indexes:
  - player_id, active
  - symbol, active, triggered
  - triggered_at

  - name: analytics_settings
    description: Настройки аналитики игроков
    fields:
      - id: UUID (PK)
      - player_id: UUID (FK accounts)
      - chart_preferences: JSONB (настройки графиков)
      - indicator_preferences: JSONB (выбранные индикаторы)
      - alert_preferences: JSONB (настройки оповещений)
      - updated_at: TIMESTAMP
    indexes:
      - player_id

technical_specification:
  backend_requirements:
    - Реализация Analytics Data Collector:
        - Сбор данных о ценах
        - Сбор данных о транзакциях
        - Хранение исторических данных
    - Реализация Chart Data Manager:
        - Подготовка данных для графиков
        - Агрегация данных по таймфреймам
        - Форматирование данных
    - Реализация Technical Indicators Calculator:
        - Расчёт MA, RSI, MACD, Bollinger Bands
        - Расчёт других индикаторов
    - Реализация Sentiment Analyzer:
        - Анализ настроений
        - Расчёт индекса страха и жадности
        - Генерация тепловых карт
    - Реализация Portfolio Analytics Manager:
        - Расчёт метрик портфеля
        - История сделок
        - Графики прибыли/убытков
    - Реализация Alert Manager:
        - Создание оповещений
        - Проверка условий
        - Отправка уведомлений
    - Реализация Analytics Cache Manager:
        - Кэширование данных
        - Инвалидация кэша
    - Реализация Analytics API Gateway:
        - Маршрутизация запросов
        - WebSocket для потоковых данных
    - Интеграция с economy-service для данных о ценах
    - Интеграция с stock-exchange-service для данных об акциях
    - Интеграция с investment-service для портфельной аналитики
    - Создание схемы БД (analytics_chart_data, analytics_indicators, analytics_sentiment, analytics_portfolio_snapshots, analytics_alerts, analytics_settings)

  performance_requirements:
    - Получение данных графика: <200 мс (с кэшем)
    - Расчёт индикатора: <500 мс
    - Анализ настроений: <1000 мс
    - Портфельная аналитика: <1000 мс
    - Проверка оповещений: <100 мс
    - WebSocket обновления: каждые 1-5 секунд

  scalability_requirements:
    - Горизонтальное масштабирование через пул инстансов
    - Распределение символов по инстансам
    - Кэширование в Redis для быстрого доступа
    - Асинхронная обработка расчётов через очереди

subtasks:
  - id: analytics-data-collector
    title: Реализация Analytics Data Collector
    description: |
      Сбор данных для аналитики:
      - Сбор данных о ценах
      - Сбор данных о транзакциях
      - Хранение исторических данных
    priority: high
    estimated_time: 5-6 дней

  - id: chart-data-manager
    title: Реализация Chart Data Manager
    description: |
      Управление данными для графиков:
      - Подготовка данных для различных типов графиков
      - Агрегация данных по таймфреймам
      - Форматирование данных
    priority: high
    estimated_time: 5-6 дней

  - id: technical-indicators-calculator
    title: Реализация Technical Indicators Calculator
    description: |
      Расчёт технических индикаторов:
      - MA, RSI, MACD, Bollinger Bands
      - Другие индикаторы
    priority: high
    estimated_time: 6-7 дней

  - id: sentiment-analyzer
    title: Реализация Sentiment Analyzer
    description: |
      Анализ настроений:
      - Расчёт баланса сигналов
      - Индекс страха и жадности
      - Тепловые карты
    priority: medium
    estimated_time: 5-6 дней

  - id: portfolio-analytics-manager
    title: Реализация Portfolio Analytics Manager
    description: |
      Аналитика портфеля:
      - Расчёт метрик
      - История сделок
      - Графики прибыли/убытков
    priority: high
    estimated_time: 6-7 дней

  - id: alert-manager
    title: Реализация Alert Manager
    description: |
      Управление оповещениями:
      - Создание оповещений
      - Проверка условий
      - Отправка уведомлений
    priority: high
    estimated_time: 4-5 дней

  - id: analytics-cache-manager
    title: Реализация Analytics Cache Manager
    description: |
      Кэширование данных:
      - Кэширование графиков
      - Кэширование индикаторов
      - Инвалидация кэша
    priority: high
    estimated_time: 3-4 дня

  - id: analytics-api-gateway
    title: Реализация Analytics API Gateway
    description: |
      API Gateway:
      - Маршрутизация запросов
      - WebSocket для потоковых данных
    priority: high
    estimated_time: 4-5 дней

  - id: database-schema
    title: Создание схемы БД для аналитики
    description: |
      Создание таблиц:
      - analytics_chart_data
      - analytics_indicators
      - analytics_sentiment
      - analytics_portfolio_snapshots
      - analytics_alerts
      - analytics_settings
    priority: high
    estimated_time: 3-4 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для аналитики:
      - Графики
      - Индикаторы
      - Настроения
      - Портфель
      - Оповещения
    priority: high
    estimated_time: 5-6 дней

  - id: websocket-streaming
    title: Реализация WebSocket для потоковых данных
    description: |
      WebSocket поток:
      - Потоковые данные графиков
      - Оповещения в реальном времени
    priority: high
    estimated_time: 3-4 дня

  - id: economy-stock-integration
    title: Интеграция с Economy и Stock Exchange Services
    description: |
      Интеграция с экономическими данными:
      - Получение данных о ценах
      - Получение данных о транзакциях
      - Интеграция с событиями
    priority: high
    estimated_time: 4-5 дней

  - id: event-bus-integration
    title: Интеграция с Event Bus
    description: |
      Публикация и подписка на события:
      - analytics.* события
      - Подписка на economy.price.updated, stock-exchange.price.updated, economy.event.active, investment.position.updated
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты системы аналитики:
      - Тесты графиков
      - Тесты индикаторов
      - Тесты настроений
      - Тесты портфельной аналитики
      - Тесты оповещений
      - Тесты интеграций
      - Тесты производительности
    priority: high
    estimated_time: 7-8 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Analytics Service"
            ADC[Analytics Data Collector]
            CDM[Chart Data Manager]
            TIC[Technical Indicators Calculator]
            SA[Sentiment Analyzer]
            PAM[Portfolio Analytics Manager]
            AM[Alert Manager]
            ACM[Analytics Cache Manager]
            AAG[Analytics API Gateway]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>analytics_chart_data<br/>analytics_indicators<br/>analytics_sentiment<br/>analytics_portfolio_snapshots<br/>analytics_alerts<br/>analytics_settings)]
        end

        subgraph "Cache"
            REDIS[(Redis Cache)]
        end

        subgraph "Event Bus"
            EB[Kafka/Event Bus]
        end

        subgraph "External Services"
            ES[Economy Service]
            SES[Stock Exchange Service]
            IS[Investment Service]
            NS[Notification Service]
        end

        AAG --> CDM
        AAG --> TIC
        AAG --> SA
        AAG --> PAM
        AAG --> AM
        CDM --> ADC
        CDM --> ACM
        TIC --> ADC
        TIC --> ACM
        SA --> ADC
        PAM --> ADC
        AM --> ADC
        ADC --> ES
        ADC --> SES
        ADC --> IS
        ACM --> REDIS
        ADC --> DB
        CDM --> DB
        TIC --> DB
        SA --> DB
        PAM --> DB
        AM --> DB
        AAG --> EB
        ADC --> EB
        AM --> NS
    ```

  chart_data_flow: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant AAG as Analytics API Gateway
        participant ACM as Analytics Cache Manager
        participant ADC as Analytics Data Collector
        participant CDM as Chart Data Manager
        participant ES as Economy Service

        C->>AAG: Request Chart Data
        AAG->>ACM: Check Cache
        alt Cache Hit
            ACM->>AAG: Return Cached Data
        else Cache Miss
            ACM->>ADC: Request Data
            ADC->>ES: Get Price Data
            ES->>ADC: Return Price Data
            ADC->>CDM: Format Data
            CDM->>ACM: Store in Cache
            CDM->>AAG: Return Formatted Data
        end
        AAG->>C: Return Chart Data
    ```

  indicator_calculation_flow: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant AAG as Analytics API Gateway
        participant TIC as Technical Indicators Calculator
        participant ADC as Analytics Data Collector
        participant ACM as Analytics Cache Manager

        C->>AAG: Request Indicator
        AAG->>ACM: Check Cache
        alt Cache Hit
            ACM->>AAG: Return Cached Indicator
        else Cache Miss
            ACM->>ADC: Request Historical Data
            ADC->>ADC: Get Historical Data
            ADC->>TIC: Calculate Indicator
            TIC->>TIC: Apply Formula
            TIC->>ACM: Store in Cache
            TIC->>AAG: Return Indicator
        end
        AAG->>C: Return Indicator
    ```

decisions:
  - id: adr-economy-analytics-architecture
    summary: |
      Выбрана микросервисная архитектура с analytics-service как основным сервисом
      и интеграцией с economy-service и stock-exchange-service для получения данных.

  - id: adr-chart-data-management
    summary: |
      Данные для графиков управляются через Chart Data Manager с поддержкой различных типов графиков
      и агрегацией данных по таймфреймам для оптимизации производительности.

  - id: adr-technical-indicators
    summary: |
      Технические индикаторы рассчитываются через Technical Indicators Calculator с кэшированием результатов
      для быстрого доступа и снижения нагрузки на систему.

  - id: adr-caching-strategy
    summary: |
      Используется многоуровневое кэширование (Redis + БД) для оптимизации производительности
      и снижения нагрузки на источники данных.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация формата данных графиков (JSONB структура)
  - Определение формата индикаторов и настроений
  - Создание схем сообщений для Event Bus

history:
  - version: "1.0.0"
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы экономической аналитики:
      - Определены микросервисы (analytics-service, economy-service, stock-exchange-service)
      - Определены компоненты (Analytics Data Collector, Chart Data Manager, Technical Indicators Calculator, Sentiment Analyzer, Portfolio Analytics Manager, Alert Manager, Analytics Cache Manager, Analytics API Gateway)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных (chart data request, indicator calculation, sentiment analysis, portfolio analytics, alert processing)
      - Определена структура БД (analytics_chart_data, analytics_indicators, analytics_sentiment, analytics_portfolio_snapshots, analytics_alerts, analytics_settings)
      - Описаны интеграции с другими сервисами (economy-service, stock-exchange-service, investment-service, notification-service)
      - Определены Event Bus события (published и subscribed)
      - Создано техническое задание
      - Разбито на подзадачи

