metadata:
  id: economy-analytics-system-architecture
  title: Архитектура системы экономической аналитики
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T16:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - analytics
    - charts
    - market-intelligence
  related_systems:
    - economy-service
    - analytics-service
    - stock-exchange-service
  related_documents:
    - id: economy-analytics
      relation: extends
    - id: game-mechanics-systems-architecture
      relation: extends
  github_issue: 216
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы экономической аналитики для предоставления игрокам
    инструментов визуализации и отслеживания трендов: графики цен, технические индикаторы, анализ настроений,
    портфельная аналитика и оповещения.
  goal: |
    Создать архитектурную схему системы экономической аналитики с определением:
    - Микросервисов для управления аналитикой
    - Компонентов для графиков, индикаторов, анализа настроений, портфельной аналитики
    - API endpoints (высокоуровнево)
    - Интеграций с другими экономическими системами
    - Структуры БД для хранения аналитических данных
    - Технического задания для реализации
  essence: |
    Система экономической аналитики предоставляет профессиональные графики, технические индикаторы,
    анализ настроений рынка, портфельную аналитику и систему оповещений для принятия торговых решений.

architecture:
  overview: |
    Система экономической аналитики состоит из следующих компонентов:
    1. Analytics Data Collector - сбор данных для аналитики
    2. Chart Data Manager - управление данными для графиков
    3. Technical Indicators Calculator - расчёт технических индикаторов
    4. Sentiment Analyzer - анализ настроений рынка
    5. Portfolio Analytics Manager - аналитика портфеля
    6. Alert Manager - управление оповещениями
    7. Analytics Cache Manager - кэширование аналитических данных
    8. Analytics API Gateway - API для доступа к аналитике

  microservices:
    - name: analytics-service
      location: services/analytics-service
      responsibility: |
        Основной сервис для экономической аналитики:
        - Сбор данных для аналитики
        - Расчёт технических индикаторов
        - Анализ настроений
        - Портфельная аналитика
        - Управление оповещениями
      components:
        - Analytics Data Collector
        - Chart Data Manager
        - Technical Indicators Calculator
        - Sentiment Analyzer
        - Portfolio Analytics Manager
        - Alert Manager
        - Analytics Cache Manager
      endpoints:
        - GET /api/v1/analytics/chart/{symbol} - данные для графика
        - GET /api/v1/analytics/chart/{symbol}/history - история цен
        - GET /api/v1/analytics/indicators/{symbol} - технические индикаторы
        - GET /api/v1/analytics/sentiment/{symbol} - анализ настроений
        - GET /api/v1/analytics/portfolio/{player_id} - аналитика портфеля
        - GET /api/v1/analytics/portfolio/{player_id}/history - история портфеля
        - GET /api/v1/analytics/portfolio/{player_id}/metrics - метрики портфеля
        - GET /api/v1/analytics/heatmap - тепловая карта рынка
        - GET /api/v1/analytics/alerts - список оповещений игрока
        - POST /api/v1/analytics/alerts - создание оповещения
        - PUT /api/v1/analytics/alerts/{id} - обновление оповещения
        - DELETE /api/v1/analytics/alerts/{id} - удаление оповещения
        - WS /ws/analytics/chart/{symbol} - WebSocket для потоковых данных графика
        - WS /ws/analytics/alerts - WebSocket для оповещений

    - name: economy-service
      location: services/economy-service
      responsibility: |
        Интеграция с экономическими данными:
        - Предоставление данных о ценах
        - Предоставление данных о транзакциях
        - Интеграция с экономическими событиями
      components:
        - Economy Data Provider
      endpoints:
        - GET /api/v1/economy/prices/{symbol} - текущие цены
        - GET /api/v1/economy/prices/{symbol}/history - история цен

    - name: stock-exchange-service
      location: services/stock-exchange-service
      responsibility: |
        Интеграция с биржей:
        - Предоставление данных об акциях
        - Предоставление данных о сделках
        - Интеграция с биржевыми событиями
      components:
        - Stock Exchange Data Provider
      endpoints:
        - GET /api/v1/stock-exchange/stocks/{id}/prices - цены акций
        - GET /api/v1/stock-exchange/stocks/{id}/trades - сделки

  components:
    - name: Analytics Data Collector
      location: analytics-service
      responsibility: |
        Сбор данных для аналитики:
        - Сбор данных о ценах из economy-service и stock-exchange-service
        - Сбор данных о транзакциях
        - Сбор данных о событиях
        - Хранение исторических данных
      methods:
        - collectPriceData(symbol, timeRange)
        - collectTransactionData(playerId, timeRange)
        - collectEventData(timeRange)
        - storeHistoricalData(data)

    - name: Chart Data Manager
      location: analytics-service
      responsibility: |
        Управление данными для графиков:
        - Подготовка данных для различных типов графиков (линейные, свечные, OHLC, area, гистограммы)
        - Агрегация данных по таймфреймам
        - Кэширование данных графиков
      methods:
        - getChartData(symbol, chartType, timeFrame, timeRange)
        - aggregateData(data, timeFrame)
        - formatCandlestickData(data)
        - formatOHLCData(data)

    - name: Technical Indicators Calculator
      location: analytics-service
      responsibility: |
        Расчёт технических индикаторов:
        - MA (Moving Average)
        - RSI (Relative Strength Index)
        - MACD (Moving Average Convergence Divergence)
        - Bollinger Bands
        - Другие индикаторы
      methods:
        - calculateMA(data, period)
        - calculateRSI(data, period)
        - calculateMACD(data, fastPeriod, slowPeriod, signalPeriod)
        - calculateBollingerBands(data, period, stdDev)
        - calculateIndicator(symbol, indicatorType, parameters)

    - name: Sentiment Analyzer
      location: analytics-service
      responsibility: |
        Анализ настроений рынка:
        - Расчёт баланса бычьих и медвежьих сигналов
        - Индекс страха и жадности
        - Тепловые карты по секторам
        - Анализ настроений портфеля
      methods:
        - analyzeSentiment(symbol, timeRange)
        - calculateFearGreedIndex(timeRange)
        - generateHeatmap(sector, timeRange)
        - analyzePortfolioSentiment(playerId)

    - name: Portfolio Analytics Manager
      location: analytics-service
      responsibility: |
        Аналитика портфеля:
        - Расчёт доходности (total return)
        - Расчёт риска (Sharpe ratio)
        - Win rate и profit factor
        - История сделок
        - Динамика прибыли и убытков
      methods:
        - calculateTotalReturn(playerId, timeRange)
        - calculateSharpeRatio(playerId, timeRange)
        - calculateWinRate(playerId, timeRange)
        - calculateProfitFactor(playerId, timeRange)
        - getTradeHistory(playerId, timeRange)
        - getProfitLossChart(playerId, timeRange)

    - name: Alert Manager
      location: analytics-service
      responsibility: |
        Управление оповещениями:
        - Создание ценовых оповещений
        - Создание событийных оповещений
        - Проверка условий оповещений
        - Отправка уведомлений
      methods:
        - createPriceAlert(playerId, symbol, condition, targetPrice)
        - createEventAlert(playerId, eventType, condition)
        - checkAlerts(symbol, currentPrice)
        - sendAlert(alertId, notification)

    - name: Analytics Cache Manager
      location: analytics-service
      responsibility: |
        Кэширование аналитических данных:
        - Кэширование данных графиков
        - Кэширование индикаторов
        - Кэширование портфельной аналитики
        - Инвалидация кэша
      methods:
        - cacheChartData(symbol, chartType, timeFrame, data)
        - getCachedChartData(symbol, chartType, timeFrame)
        - cacheIndicator(symbol, indicatorType, data)
        - invalidateCache(symbol, dataType)

    - name: Analytics API Gateway
      location: analytics-service
      responsibility: |
        API Gateway для аналитики:
        - Маршрутизация запросов
        - Агрегация данных из разных источников
        - Форматирование ответов
        - WebSocket для потоковых данных
      methods:
        - routeRequest(endpoint, parameters)
        - aggregateData(sources)
        - formatResponse(data, format)
        - streamChartData(symbol, clientId)

  data_flow:
    chart_data_request: |
      1. Клиент запрашивает данные для графика через Analytics API Gateway
      2. Analytics Cache Manager проверяет кэш
      3. Если данных нет в кэше: Analytics Data Collector собирает данные из economy-service/stock-exchange-service
      4. Chart Data Manager форматирует данные для типа графика
      5. Данные кэшируются
      6. Данные возвращаются клиенту

    indicator_calculation: |
      1. Клиент запрашивает технический индикатор
      2. Analytics Cache Manager проверяет кэш
      3. Если данных нет: Analytics Data Collector собирает исторические данные
      4. Technical Indicators Calculator рассчитывает индикатор
      5. Результат кэшируется
      6. Результат возвращается клиенту

    sentiment_analysis: |
      1. Клиент запрашивает анализ настроений
      2. Sentiment Analyzer собирает данные о сигналах и событиях
      3. Рассчитывается баланс бычьих/медвежьих сигналов
      4. Рассчитывается индекс страха и жадности
      5. Генерируется тепловая карта (если требуется)
      6. Результат возвращается клиенту

    portfolio_analytics: |
      1. Клиент запрашивает аналитику портфеля
      2. Portfolio Analytics Manager получает данные о позициях игрока
      3. Собираются данные о транзакциях и сделках
      4. Рассчитываются метрики (total return, Sharpe ratio, win rate, profit factor)
      5. Формируется история сделок
      6. Генерируется график прибыли/убытков
      7. Результат возвращается клиенту

    alert_processing: |
      1. Alert Manager периодически проверяет условия оповещений
      2. Для ценовых оповещений: проверяется текущая цена символа
      3. Для событийных оповещений: проверяются активные события
      4. При выполнении условия: отправляется уведомление через notification-service
      5. WebSocket отправляет оповещение клиенту в реальном времени

  integrations:
    with_economy_service: |
      - Получение данных о ценах
      - Получение данных о транзакциях
      - Интеграция с экономическими событиями

    with_stock_exchange_service: |
      - Получение данных об акциях
      - Получение данных о сделках
      - Интеграция с биржевыми событиями

    with_investment_service: |
      - Получение данных о портфеле игрока
      - Получение данных о позициях
      - Получение данных о сделках

    with_notification_service: |
      - Отправка оповещений
      - Push-уведомления
      - Email-уведомления

    with_event_bus: |
      - Подписка на события цен
      - Подписка на экономические события
      - Публикация аналитических событий

  event_bus_events:
    published:
      - analytics.chart.data.updated
      - analytics.indicator.calculated
      - analytics.sentiment.updated
      - analytics.portfolio.updated
      - analytics.alert.triggered
    subscribed:
      - economy.price.updated (для обновления графиков)
      - stock-exchange.price.updated (для обновления графиков)
      - economy.event.active (для событийных оповещений)
      - investment.position.updated (для портфельной аналитики)

  database_schema:
    tables:
      - name: analytics_chart_data
        description: Данные для графиков
        fields:
          - id: UUID (PK)
          - symbol: VARCHAR(50)
          - chart_type: ENUM (line, candlestick, ohlc, area, volume)
          - time_frame: VARCHAR(20) (1m, 5m, 15m, 1h, 4h, 1d, 1w)
          - timestamp: TIMESTAMP
          - open: DECIMAL(20,8) (nullable)
          - high: DECIMAL(20,8) (nullable)
          - low: DECIMAL(20,8) (nullable)
          - close: DECIMAL(20,8)
          - volume: DECIMAL(20,2) (nullable)
          - data: JSONB (дополнительные данные)
        indexes:
          - symbol, chart_type, time_frame, timestamp
          - timestamp

      - name: analytics_indicators
        description: Технические индикаторы
        fields:
          - id: UUID (PK)
          - symbol: VARCHAR(50)
          - indicator_type: VARCHAR(50) (MA, RSI, MACD, BollingerBands, etc.)
          - parameters: JSONB (параметры индикатора)
          - timestamp: TIMESTAMP
          - value: DECIMAL(20,8)
          - signal: ENUM (buy, sell, neutral, nullable)
        indexes:
          - symbol, indicator_type, timestamp
          - timestamp

      - name: analytics_sentiment
        description: Анализ настроений
        fields:
          - id: UUID (PK)
          - symbol: VARCHAR(50) (nullable, для общего рынка может быть NULL)
          - timestamp: TIMESTAMP
          - bullish_signals: INTEGER
          - bearish_signals: INTEGER
          - fear_greed_index: DECIMAL(5,2) (0.00-100.00)
          - sentiment_score: DECIMAL(5,2) (-100.00 to 100.00)
        indexes:
          - symbol, timestamp
          - timestamp

      - name: analytics_portfolio_snapshots
        description: Снимки портфеля для аналитики
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - timestamp: TIMESTAMP
          - total_value: DECIMAL(10,2)
          - total_cost: DECIMAL(10,2)
          - total_return: DECIMAL(10,2)
          - total_return_percentage: DECIMAL(5,2)
          - sharpe_ratio: DECIMAL(5,2) (nullable)
          - win_rate: DECIMAL(5,2) (nullable)
          - profit_factor: DECIMAL(5,2) (nullable)
        indexes:
          - player_id, timestamp
          - timestamp

      - name: analytics_alerts
        description: Оповещения игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - alert_type: ENUM (price, event)
          - symbol: VARCHAR(50) (nullable, для событийных оповещений)
          - event_type: VARCHAR(50) (nullable, для событийных оповещений)
          - condition: ENUM (above, below, equals, change_percentage)
          - target_value: DECIMAL(20,8) (nullable)
          - triggered: BOOLEAN
          - triggered_at: TIMESTAMP (nullable)
          - active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
