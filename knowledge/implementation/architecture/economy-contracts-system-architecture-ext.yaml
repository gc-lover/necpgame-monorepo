fields:
  - id: UUID (PK)
  - contract_id: UUID (FK player_contracts)
  - initiator_items: JSONB (предметы инициатора)
  - counterparty_items: JSONB (предметы контрагента)
  - initiator_currency: DECIMAL(10,2)
  - counterparty_currency: DECIMAL(10,2)
  - status: ENUM (locked, released, distributed)
  - locked_at: TIMESTAMP
  - released_at: TIMESTAMP (nullable)
indexes:
  - contract_id
  - status

  - name: collaterals
    description: Залоги для контрактов
    fields:
      - id: UUID (PK)
      - contract_id: UUID (FK player_contracts)
      - player_id: UUID (FK accounts)
      - amount: DECIMAL(10,2)
      - forfeited_amount: DECIMAL(10,2)
      - status: ENUM (locked, released, forfeited)
      - locked_at: TIMESTAMP
      - released_at: TIMESTAMP (nullable)
    indexes:
      - contract_id
      - player_id, status

  - name: contract_disputes
    description: Споры по контрактам
    fields:
      - id: UUID (PK)
      - contract_id: UUID (FK player_contracts)
      - initiator_id: UUID (FK accounts)
      - reason: TEXT
      - evidence: JSONB (доказательства)
      - ai_moderation_result: JSONB (nullable)
      - decision: ENUM (pending, initiator_wins, counterparty_wins, partial)
      - escrow_distribution: JSONB (nullable)
      - resolved_at: TIMESTAMP (nullable)
      - created_at: TIMESTAMP
    indexes:
      - contract_id
      - initiator_id
      - decision, resolved_at

  - name: contract_execution_log
    description: Лог исполнения контрактов
    fields:
      - id: UUID (PK)
      - contract_id: UUID (FK player_contracts)
      - action: VARCHAR(255)
      - details: JSONB
      - executed_at: TIMESTAMP
    indexes:
      - contract_id, executed_at

technical_specification:
  backend_requirements:
    - Реализация Contract Manager в contract-service:
        - CRUD операции с контрактами
        - Управление жизненным циклом (переходы состояний)
        - Валидация контрактов
    - Реализация Contract Negotiation Manager:
        - Управление переговорами
        - Обмен предложениями
        - Финализация контрактов
    - Реализация Escrow Manager:
        - Создание эскроу
        - Блокировка активов
        - Освобождение эскроу
    - Реализация Collateral Manager:
        - Создание залогов
        - Блокировка залогов
        - Удержание залогов
    - Реализация Arbitration Manager:
        - Создание споров
        - Сбор доказательств
        - AI-модерация
        - Разрешение споров
    - Реализация Contract Validator:
        - Проверка требований
        - KYC проверки
        - Проверка лимитов
        - Детекция мошенничества
    - Реализация Contract Execution Engine:
        - Исполнение контрактов
        - Интеграция с другими сервисами
    - Реализация Contract Analytics Collector:
        - Сбор метрик
        - Анализ успешности
        - Генерация отчётов
    - Интеграция с inventory-service для предметов
    - Интеграция с wallet-service для валюты
    - Интеграция с reputation-service для репутации
    - Интеграция с logistics-service для доставки
    - Интеграция с crafting-service для крафта
    - Создание схемы БД (player_contracts, contract_negotiations, escrows, collaterals, contract_disputes, contract_execution_log)

  performance_requirements:
    - Создание контракта: <300 мс
    - Создание эскроу: <200 мс
    - Исполнение контракта: <500 мс
    - Разрешение спора: <2000 мс
    - Поддержка до 1000 активных контрактов на игрока

  scalability_requirements:
    - Горизонтальное масштабирование через пул инстансов
    - Распределение контрактов по инстансам
    - Кэширование правил валидации в Redis
    - Асинхронная обработка споров через очереди

subtasks:
  - id: contract-manager
    title: Реализация Contract Manager
    description: |
      Управление контрактами:
      - CRUD операции
      - Управление жизненным циклом
      - Валидация контрактов
    priority: high
    estimated_time: 6-7 дней

  - id: contract-negotiation-manager
    title: Реализация Contract Negotiation Manager
    description: |
      Управление переговорами:
      - Инициация переговоров
      - Обмен предложениями
      - Финализация контрактов
    priority: high
    estimated_time: 4-5 дней

  - id: escrow-manager
    title: Реализация Escrow Manager
    description: |
      Управление эскроу:
      - Создание эскроу
      - Блокировка активов
      - Освобождение эскроу
    priority: high
    estimated_time: 5-6 дней

  - id: collateral-manager
    title: Реализация Collateral Manager
    description: |
      Управление залогами:
      - Создание залогов
      - Блокировка залогов
      - Удержание залогов
    priority: high
    estimated_time: 4-5 дней

  - id: arbitration-manager
    title: Реализация Arbitration Manager
    description: |
      Управление арбитражем:
      - Создание споров
      - Сбор доказательств
      - AI-модерация
      - Разрешение споров
    priority: high
    estimated_time: 7-8 дней

  - id: contract-validator
    title: Реализация Contract Validator
    description: |
      Валидация контрактов:
      - Проверка требований
      - KYC проверки
      - Проверка лимитов
      - Детекция мошенничества
    priority: high
    estimated_time: 5-6 дней

  - id: contract-execution-engine
    title: Реализация Contract Execution Engine
    description: |
      Исполнение контрактов:
      - Выполнение условий
      - Интеграция с другими сервисами
    priority: high
    estimated_time: 6-7 дней

  - id: contract-analytics-collector
    title: Реализация Contract Analytics Collector
    description: |
      Сбор аналитики:
      - Сбор метрик
      - Анализ успешности
      - Генерация отчётов
    priority: medium
    estimated_time: 4-5 дней

  - id: database-schema
    title: Создание схемы БД для контрактов
    description: |
      Создание таблиц:
      - player_contracts
      - contract_negotiations
      - escrows
      - collaterals
      - contract_disputes
      - contract_execution_log
    priority: high
    estimated_time: 3-4 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для системы контрактов:
      - CRUD операции
      - Управление переговорами
      - Управление эскроу и залогами
      - Управление спорами
    priority: high
    estimated_time: 5-6 дней

  - id: inventory-integration
    title: Интеграция с Inventory Service
    description: |
      Интеграция с инвентарём:
      - Блокировка предметов
      - Обмен предметами
      - Освобождение предметов
    priority: high
    estimated_time: 3-4 дня

  - id: wallet-integration
    title: Интеграция с Wallet Service
    description: |
      Интеграция с кошельками:
      - Блокировка валюты
      - Перевод валюты
      - Освобождение валюты
    priority: high
    estimated_time: 3-4 дня

  - id: reputation-integration
    title: Интеграция с Reputation Service
    description: |
      Интеграция с репутацией:
      - Обновление репутации
      - Влияние споров
      - Рейтинги контрагентов
    priority: medium
    estimated_time: 3-4 дня

  - id: logistics-crafting-integration
    title: Интеграция с Logistics и Crafting Services
    description: |
      Интеграция с доставкой и крафтом:
      - Создание доставки
      - Создание заказа на крафт
      - Отслеживание выполнения
    priority: medium
    estimated_time: 4-5 дней

  - id: event-bus-integration
    title: Интеграция с Event Bus
    description: |
      Публикация и подписка на события:
      - contract.* события
      - Подписка на inventory.item.locked, wallet.balance.locked, logistics.delivery.completed, crafting.order.completed
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты системы контрактов:
      - Тесты жизненного цикла
      - Тесты эскроу и залогов
      - Тесты арбитража
      - Тесты интеграций
      - Тесты производительности
    priority: high
    estimated_time: 7-8 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Contract Service"
            CM[Contract Manager]
            CNM[Contract Negotiation Manager]
            CEE[Contract Execution Engine]
            CV[Contract Validator]
        end

        subgraph "Escrow Service"
            EM[Escrow Manager]
            COL[Collateral Manager]
        end

        subgraph "Arbitration Service"
            AM[Arbitration Manager]
            DP[Dispute Processor]
        end

        subgraph "Analytics Service"
            CAC[Contract Analytics Collector]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>player_contracts<br/>contract_negotiations<br/>escrows<br/>collaterals<br/>contract_disputes<br/>contract_execution_log)]
        end

        subgraph "Event Bus"
            EB[Kafka/Event Bus]
        end

        subgraph "External Services"
            IS[Inventory Service]
            WS[Wallet Service]
            RS[Reputation Service]
            LS[Logistics Service]
            CS[Crafting Service]
            NS[Notification Service]
        end

        CM --> CNM
        CM --> CEE
        CM --> CV
        CM --> EM
        CM --> COL
        CM --> AM
        CEE --> IS
        CEE --> WS
        CEE --> LS
        CEE --> CS
        EM --> IS
        EM --> WS
        AM --> EM
        AM --> COL
        CM --> CAC
        CM --> DB
        CNM --> DB
        EM --> DB
        COL --> DB
        AM --> DB
        CM --> EB
        EM --> EB
        AM --> EB
        CM --> RS
        CM --> NS
    ```

  contract_lifecycle_flow: |
    ```mermaid
    stateDiagram-v2
        [*] --> DRAFT: Create Contract
        DRAFT --> NEGOTIATION: Send to Counterparty
        NEGOTIATION --> ESCROW_PENDING: Accept Terms
        ESCROW_PENDING --> ACTIVE: Escrow Locked
        ACTIVE --> COMPLETED: Execute Contract
        ACTIVE --> DISPUTED: Create Dispute
        DISPUTED --> COMPLETED: Resolve Dispute
        DISPUTED --> CANCELLED: Resolve Dispute
        NEGOTIATION --> CANCELLED: Reject
        ESCROW_PENDING --> CANCELLED: Cancel
        ACTIVE --> CANCELLED: Cancel
        COMPLETED --> [*]
        CANCELLED --> [*]
    ```

  escrow_flow: |
    ```mermaid
    sequenceDiagram
        participant CM as Contract Manager
        participant EM as Escrow Manager
        participant IS as Inventory Service
        participant WS as Wallet Service
        participant COL as Collateral Manager

        CM->>EM: Create Escrow
        EM->>IS: Lock Items
        IS->>EM: Items Locked
        EM->>WS: Lock Currency
        WS->>EM: Currency Locked
        EM->>COL: Create Collaterals
        COL->>WS: Lock Collateral
        WS->>COL: Collateral Locked
        EM->>CM: Escrow Ready
        Note over CM: Contract Active
        CM->>EM: Release Escrow
        EM->>IS: Release Items
        EM->>WS: Release Currency
        COL->>WS: Release Collateral
    ```

decisions:
  - id: adr-contracts-architecture
    summary: |
      Выбрана микросервисная архитектура с contract-service как основным сервисом
      и отдельными сервисами для эскроу и арбитража.

  - id: adr-contract-lifecycle
    summary: |
      Реализован жизненный цикл контрактов с состояниями DRAFT → NEGOTIATION → ESCROW_PENDING → ACTIVE → COMPLETED/CANCELLED/DISPUTED
      для управления контрактами от создания до завершения.

  - id: adr-escrow-system
    summary: |
      Эскроу реализован через отдельный сервис с блокировкой активов в inventory-service и wallet-service
      для обеспечения безопасности сделок.

  - id: adr-arbitration-system
    summary: |
      Арбитраж реализован через отдельный сервис с AI-модерацией для автоматического разрешения споров
      и распределения эскроу согласно решениям.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация формата контрактов (JSONB структура)
  - Определение формата эскроу и залогов
  - Создание схем сообщений для Event Bus

history:
  - version: "1.0.0"
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы контрактов и сделок:
      - Определены микросервисы (contract-service, escrow-service, arbitration-service, analytics-service)
      - Определены компоненты (Contract Manager, Contract Negotiation Manager, Escrow Manager, Collateral Manager, Arbitration Manager, Contract Validator, Contract Execution Engine, Contract Analytics Collector)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных (contract creation, negotiation, escrow setup, execution, completion, dispute)
      - Определена структура БД (player_contracts, contract_negotiations, escrows, collaterals, contract_disputes, contract_execution_log)
      - Описаны интеграции с другими сервисами (inventory-service, wallet-service, reputation-service, logistics-service, crafting-service, notification-service)
      - Определены Event Bus события (published и subscribed)
      - Создано техническое задание
      - Разбито на подзадачи

