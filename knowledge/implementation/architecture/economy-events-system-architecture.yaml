# Issue: #225
metadata:
  id: economy-events-system-architecture
  title: Архитектура системы экономических событий
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-30T19:25:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy-events
    - backend
    - economy
  related_systems:
    - economy-service-go
    - pricing-engine-go
    - analytics-service-go
  related_documents:
    - id: economy-events
      relation: extends
  github_issue: 225
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы экономических событий
    для управления событиями, влияющими на цены, курсы и активность игроков,
    с поддержкой планирования, жизненного цикла и интеграций.
  goal: |
    Создать архитектурную схему системы экономических событий с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Технического задания для реализации
  essence: |
    Система управления экономическими событиями с поддержкой планирования, жизненного цикла,
    применения эффектов, мониторинга и интеграции с pricing-engine, stock-exchange,
    currency-exchange и analytics-service.

architecture:
  overview: |
    Система экономических событий состоит из следующих компонентов:
    1. Event Manager - управление событиями и их жизненным циклом
    2. Event Scheduler - планирование и триггеры событий
    3. Effect Applier - применение эффектов к ценам и курсам
    4. Event Monitor - мониторинг и аудит событий
    5. Integration Handler - интеграция с другими сервисами
    6. Notification Manager - уведомления игроков о событиях

  components:
    - name: Event Manager
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Управление жизненным циклом событий (PLANNED, ANNOUNCED, ACTIVE, COOLDOWN, ARCHIVED)
        - CRUD операции с событиями
        - Валидация событий
        - Управление типами событий (кризисы, бумы, инфляция, эмбарго, санкции, тарифы, скандалы, технологические прорывы)
        - Управление охватом событий (глобальные, региональные)
      port: 8085 (economy-service-go)
      endpoints:
        - GET /api/v1/economy/events - список событий
        - GET /api/v1/economy/events/{event_id} - получение события
        - POST /api/v1/economy/events - создание события
        - PUT /api/v1/economy/events/{event_id} - обновление события
        - DELETE /api/v1/economy/events/{event_id} - удаление события
        - POST /api/v1/economy/events/{event_id}/announce - анонс события
        - POST /api/v1/economy/events/{event_id}/activate - активация события
        - POST /api/v1/economy/events/{event_id}/archive - архивация события

    - name: Event Scheduler
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Планирование событий (cron, триггеры)
        - Автоматический запуск событий
        - Управление ограничениями (количество активных событий, минимальные перерывы)
        - Интеграция с quest-service для триггеров от квестов
        - Интеграция с симуляцией для автоматических событий
      integration: |
        Интегрируется с quest-service для триггеров от квестов
        Интегрируется с симуляцией для автоматических событий
        Использует cron для запланированных событий

    - name: Effect Applier
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Применение эффектов к ценам и курсам
        - Модификация цен товаров
        - Модификация курсов валют
        - Модификация ликвидности
        - Управление модификаторами (JSON-поля)
      integration: |
        Интегрируется с pricing-engine для изменения цен
        Интегрируется с currency-exchange для изменения курсов
        Интегрируется с stock-exchange для изменения котировок

    - name: Event Monitor
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Мониторинг активных событий
        - Аудит изменений событий
        - KPI метрики (PriceDeviation, TransactionVolume, EventUptime)
        - Алерты при нарушении прогнозов
        - Отчеты о событиях
      integration: |
        Интегрируется с analytics-service для метрик
        Публикует события мониторинга через Event Bus

    - name: Integration Handler
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Интеграция с pricing-engine
        - Интеграция с stock-exchange
        - Интеграция с currency-exchange
        - Интеграция с quest-service
        - Интеграция с analytics-service
        - Публикация событий через Event Bus
      integration: |
        Публикует события через Event Bus для других сервисов
        Подписывается на события от других сервисов

    - name: Notification Manager
      location: economy-service-go (модуль economy-events)
      responsibility: |
        - Уведомления игроков о событиях
        - Баннеры в игре
        - Push/email уведомления
        - Советы игрокам
        - WebSocket feed для realtime обновлений
      integration: |
        Интегрируется с notification-service для отправки уведомлений
        Использует Realtime Gateway для WebSocket feed

  microservices:
    - name: economy-service-go
      port: 8085
      responsibility: |
        Основной сервис для экономических событий:
        - Управление событиями и их жизненным циклом
        - Планирование и триггеры событий
        - Применение эффектов к ценам и курсам
        - Мониторинг и аудит событий
        - Интеграция с другими сервисами
        - Уведомления игроков
      components:
        - Event Manager
        - Event Scheduler
        - Effect Applier
        - Event Monitor
        - Integration Handler
        - Notification Manager

  database_schema:
    tables:
      - name: economic_events
        description: |
          Хранит экономические события
        columns:
          - event_id (UUID, PK)
          - event_type (VARCHAR, NOT NULL) -- 'CRISIS', 'BOOM', 'INFLATION', 'EMBARGO', 'SANCTIONS', 'TARIFFS', 'SCANDAL', 'TECH_BREAKTHROUGH'
          - scope (VARCHAR, NOT NULL) -- 'GLOBAL', 'REGIONAL'
          - region_id (UUID, FK) -- для региональных событий
          - title (VARCHAR, NOT NULL)
          - description (TEXT)
          - status (VARCHAR, NOT NULL) -- 'PLANNED', 'ANNOUNCED', 'ACTIVE', 'COOLDOWN', 'ARCHIVED'
          - planned_start (TIMESTAMP)
          - announced_at (TIMESTAMP)
          - started_at (TIMESTAMP)
          - ended_at (TIMESTAMP)
          - archived_at (TIMESTAMP)
          - effects (JSONB) -- модификаторы цен, курсов, ликвидности
          - coverage (JSONB) -- охват (регионы, отрасли, товары)
          - created_at (TIMESTAMP)
          - updated_at (TIMESTAMP)
        indexes:
          - idx_event_type (event_type)
          - idx_status (status)
          - idx_scope (scope)
          - idx_region_id (region_id)
          - idx_planned_start (planned_start)
          - idx_started_at (started_at)

      - name: economic_event_history
        description: |
          Хранит историю изменений событий для аудита
        columns:
          - history_id (UUID, PK)
          - event_id (UUID, FK, NOT NULL)
          - action (VARCHAR, NOT NULL) -- 'CREATED', 'UPDATED', 'ANNOUNCED', 'ACTIVATED', 'ARCHIVED'
          - changed_by (UUID) -- user_id или system
          - changes (JSONB) -- детали изменений
          - timestamp (TIMESTAMP, NOT NULL)
        indexes:
          - idx_event_id (event_id)
          - idx_timestamp (timestamp)

      - name: economic_event_metrics
        description: |
          Хранит метрики событий для мониторинга
        columns:
          - metric_id (UUID, PK)
          - event_id (UUID, FK, NOT NULL)
          - metric_type (VARCHAR, NOT NULL) -- 'PRICE_DEVIATION', 'TRANSACTION_VOLUME', 'EVENT_UPTIME'
          - value (DECIMAL, NOT NULL)
          - recorded_at (TIMESTAMP, NOT NULL)
        indexes:
          - idx_event_id (event_id)
          - idx_metric_type (metric_type)
          - idx_recorded_at (recorded_at)

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для создания и активации событий
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед применением эффектов
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (активация события, применение эффектов)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния событий (создание, активация, применение эффектов)
      записываются как события в Event Store. Это обеспечивает полный аудит,
      возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: EventCreatedEvent, EventActivatedEvent, EffectAppliedEvent.
    cqrs_pattern: |
      Разделение команд (создание событий, активация) и запросов (получение событий,
      история) для оптимизации производительности и масштабируемости.
      Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как активация события (применение эффектов
      к pricing-engine, currency-exchange, stock-exchange), используется Saga Pattern
      для обеспечения атомарности операций между Event Service и другими сервисами.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    event_operations:
      tickrate: Event-based (on-demand) + 1-5 Hz для мониторинга
      network_load: |
        - Обновления событий: event-based, ~0.1-0.5 events/sec
        - WebSocket feed событий: 1-5 Hz, ~0.2-0.5 KB/sec на игрока
        - Применение эффектов: event-based, ~0.1-0.3 events/sec
        - Общий трафик: ~0.3-1 KB/sec на игрока
      latency_requirements: < 50-200ms для операций с событиями
      sync_strategy: Strong Consistency (ACID транзакции) для управления событиями, Eventual Consistency для эффектов

  scalability_requirements:
    - Горизонтальное масштабирование через economy-service
    - Распределение нагрузки на обработку событий
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование активных событий в Redis
    - WebSocket для потоковой передачи событий

subtasks:
  phase_1:
    name: Event Manager
    tasks:
      - Реализация Event Manager
      - CRUD операции с событиями
      - Управление жизненным циклом событий
      - Валидация событий
    estimated_effort: 4 days

  phase_2:
    name: Event Scheduler
    tasks:
      - Реализация Event Scheduler
      - Планирование событий (cron)
      - Триггеры от квестов
      - Автоматические события
    estimated_effort: 4 days

  phase_3:
    name: Effect Applier
    tasks:
      - Реализация Effect Applier
      - Применение эффектов к ценам
      - Применение эффектов к курсам
      - Интеграция с pricing-engine и currency-exchange
    estimated_effort: 5 days

  phase_4:
    name: Event Monitor и Integration Handler
    tasks:
      - Реализация Event Monitor
      - Метрики и KPI
      - Аудит событий
      - Integration Handler
      - Интеграция с другими сервисами
    estimated_effort: 5 days

  phase_5:
    name: Notification Manager и WebSocket
    tasks:
      - Реализация Notification Manager
      - Уведомления игроков
      - WebSocket feed
      - Интеграция с notification-service
    estimated_effort: 3 days

  phase_6:
    name: Тестирование и оптимизация
    tasks:
      - Нагрузочное тестирование
      - Оптимизация запросов
      - Мониторинг и алерты
    estimated_effort: 3 days

  total_estimated_effort: 24 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Economy Service"
            EM[Event Manager]
            ES[Event Scheduler]
            EA[Effect Applier]
            EMO[Event Monitor]
            IH[Integration Handler]
            NM[Notification Manager]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>economic_events<br/>economic_event_history<br/>economic_event_metrics)]
        end

        subgraph "External Services"
            PE[Pricing Engine]
            CE[Currency Exchange]
            SE[Stock Exchange]
            QS[Quest Service]
            AS[Analytics Service]
            NS[Notification Service]
            RG[Realtime Gateway]
            EB[Event Bus]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|API requests| EM
        EM --> ES
        EM --> EA
        EM --> EMO
        ES --> IH
        EA --> PE
        EA --> CE
        EA --> SE
        EMO --> AS
        IH --> EB
        IH --> QS
        NM --> NS
        NM --> RG
        EM -->|store| DB
        EMO -->|store| DB
        RG -->|push updates| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant S as Scheduler
        participant EM as Event Manager
        participant EA as Effect Applier
        participant PE as Pricing Engine
        participant CE as Currency Exchange
        participant RG as Realtime Gateway
        participant CL as Client

        S->>EM: Trigger event activation
        EM->>EM: Update event status
        EM->>EA: Apply effects
        EA->>PE: Update prices
        EA->>CE: Update rates
        PE->>EA: Prices updated
        CE->>EA: Rates updated
        EA->>EM: Effects applied
        EM->>RG: Notify clients
        RG->>CL: Push event update
    ```

  event_lifecycle: |
    ```mermaid
    stateDiagram-v2
        [*] --> PLANNED: Event Created
        PLANNED --> ANNOUNCED: Announce Event
        ANNOUNCED --> ACTIVE: Activate Event
        ACTIVE --> COOLDOWN: Event Ended
        COOLDOWN --> ARCHIVED: Archive Event
        PLANNED --> ARCHIVED: Cancel Event
        ANNOUNCED --> ARCHIVED: Cancel Event
        ACTIVE --> ARCHIVED: Force Archive
        ARCHIVED --> [*]
    ```

decisions:
  - id: adr-economy-events-architecture
    title: Централизованная модель экономических событий
    status: approved
    rationale: |
      Обеспечивает единый контроль событий, применение эффектов и интеграцию с сервисами.
      Упрощает мониторинг и аудит событий.

history:
  - version: '1.0.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Создана полная архитектура системы экономических событий:
      - Определены компоненты (Event Manager, Event Scheduler, Effect Applier, Event Monitor, Integration Handler, Notification Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (economic_events, economic_event_history, economic_event_metrics)
      - Спроектирована система жизненного цикла событий
      - Спроектирована система применения эффектов
      - Добавлена детальная синхронизация данных (Event Sourcing, CQRS, Saga Pattern, Outbox Pattern)
      - Добавлена спецификация тикрейта для операций с событиями
      - Создано техническое задание
      - Разбито на подзадачи
