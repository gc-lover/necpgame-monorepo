metadata:
  id: economy-investments-system-architecture
  title: Архитектура системы инвестиций
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T14:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - investments
    - portfolio
    - stock-exchange
  related_systems:
    - economy-service
    - stock-exchange-service
    - housing-system
    - analytics-service
  related_documents:
    - id: economy-investments
      relation: extends
    - id: game-mechanics-systems-architecture
      relation: extends
  github_issue: 228
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы инвестиций для распределения капитала игроков
    в различные активы (акции, облигации, недвижимость, производственные доли, спекуляции)
    с управлением портфелем, анализом рисков и долгосрочным доходом.
  goal: |
    Создать архитектурную схему системы инвестиций с определением:
    - Микросервисов для управления инвестициями
    - Компонентов для портфеля, рисков, аналитики
    - API endpoints (высокоуровнево)
    - Интеграций с другими экономическими системами
    - Структуры БД для хранения инвестиций и портфелей
    - Технического задания для реализации
  essence: |
    Система инвестиций управляет портфелями игроков, обрабатывает различные типы инвестиций,
    анализирует риски, предоставляет рекомендации по ребалансировке и интегрируется с биржей,
    недвижимостью и экономическими событиями.

architecture:
  overview: |
    Система инвестиций состоит из следующих компонентов:
    1. Investment Manager - управление инвестициями и портфелями
    2. Investment Product Catalog - каталог инвестиционных продуктов
    3. Portfolio Manager - управление портфелями игроков
    4. Risk Analyzer - анализ рисков инвестиций
    5. Portfolio Rebalancer - рекомендации по ребалансировке
    6. Dividend Calculator - расчёт дивидендов и выплат
    7. Investment Analytics Collector - сбор аналитики по инвестициям
    8. Investment Lifecycle Manager - управление жизненным циклом инвестиций

  microservices:
    - name: economy-service
      location: services/economy-service
      responsibility: |
        Основной сервис для управления инвестициями:
        - CRUD операции с инвестициями
        - Управление портфелями
        - Расчёт доходности
        - Интеграция с другими экономическими системами
      components:
        - Investment Manager
        - Portfolio Manager
        - Investment Lifecycle Manager
      endpoints:
        - GET /api/v1/investments/products - каталог инвестиционных продуктов
        - GET /api/v1/investments/products/{id} - детали продукта
        - POST /api/v1/investments/positions - создание инвестиционной позиции
        - GET /api/v1/investments/positions - список позиций игрока
        - GET /api/v1/investments/positions/{id} - детали позиции
        - DELETE /api/v1/investments/positions/{id} - закрытие позиции
        - GET /api/v1/investments/portfolio - портфель игрока
        - GET /api/v1/investments/portfolio/analytics - аналитика портфеля
        - POST /api/v1/investments/portfolio/rebalance - ребалансировка портфеля
        - GET /api/v1/investments/transactions - история транзакций
        - POST /api/v1/investments/transactions - создание транзакции

    - name: stock-exchange-service
      location: services/stock-exchange-service
      responsibility: |
        Интеграция с биржей для акций:
        - Получение данных об акциях
        - Синхронизация цен
        - Обработка дивидендов
      components:
        - Stock Integration Manager
      endpoints:
        - GET /api/v1/stock-exchange/stocks/{id} - данные об акции
        - GET /api/v1/stock-exchange/stocks/{id}/dividends - дивиденды акции

    - name: housing-service
      location: services/housing-service
      responsibility: |
        Интеграция с недвижимостью:
        - Получение данных о недвижимости
        - Синхронизация доходности
        - Управление инвестициями в недвижимость
      components:
        - Real Estate Integration Manager
      endpoints:
        - GET /api/v1/housing/properties/{id} - данные о недвижимости
        - GET /api/v1/housing/properties/{id}/yield - доходность недвижимости

    - name: analytics-service
      location: services/analytics-service
      responsibility: |
        Аналитика по инвестициям:
        - Сбор метрик портфеля
        - Анализ рисков
        - Рекомендации по ребалансировке
        - Прогнозы доходности
      components:
        - Investment Analytics Collector
        - Risk Analyzer
        - Portfolio Rebalancer
      endpoints:
        - GET /api/v1/analytics/investments/portfolio/{player_id} - аналитика портфеля
        - GET /api/v1/analytics/investments/risk-analysis - анализ рисков
        - GET /api/v1/analytics/investments/recommendations - рекомендации

  components:
    - name: Investment Manager
      location: economy-service
      responsibility: |
        Управление инвестициями и их жизненным циклом:
        - Создание, обновление, закрытие инвестиционных позиций
        - Управление транзакциями
        - Валидация инвестиций
        - Интеграция с различными типами активов
      methods:
        - createPosition(investmentData)
        - updatePosition(positionId, investmentData)
        - closePosition(positionId)
        - getPosition(positionId)
        - listPositions(playerId, filters)

    - name: Investment Product Catalog
      location: economy-service
      responsibility: |
        Каталог инвестиционных продуктов:
        - Управление продуктами (акции, облигации, недвижимость, производственные доли, спекуляции)
        - Характеристики продуктов (доходность, риски, минимальная сумма)
        - Доступность продуктов
      methods:
        - getProducts(productType, filters)
        - getProductDetails(productId)
        - checkAvailability(productId)
        - updateProduct(productId, productData)

    - name: Portfolio Manager
      location: economy-service
      responsibility: |
        Управление портфелями игроков:
        - Создание и управление портфелями
        - Распределение капитала
        - Балансировка риск/доходность
        - Шаблоны диверсификации
      methods:
        - getPortfolio(playerId)
        - createPortfolio(playerId, portfolioData)
        - updatePortfolio(playerId, portfolioData)
        - calculatePortfolioValue(playerId)
        - getPortfolioDistribution(playerId)

    - name: Risk Analyzer
      location: analytics-service
      responsibility: |
        Анализ рисков инвестиций:
        - Расчёт уровней риска
        - Анализ диверсификации
        - Контроль рисков (suitability, margin, tax withholding)
        - Предупредительные события (margin call, KYC)
      methods:
        - analyzeRisk(positionId)
        - analyzePortfolioRisk(playerId)
        - checkSuitability(playerId, productId)
        - checkMarginRequirements(playerId)
        - generateRiskAlerts(playerId)

    - name: Portfolio Rebalancer
      location: analytics-service
      responsibility: |
        Рекомендации по ребалансировке портфеля:
        - Анализ текущего распределения
        - Рекомендации по ребалансировке
        - Шаблоны диверсификации
        - Автоматическая ребалансировка (опционально)
      methods:
        - analyzeRebalancing(playerId)
        - generateRecommendations(playerId)
        - applyRebalancing(playerId, recommendations)
        - getDiversificationTemplates()

    - name: Dividend Calculator
      location: economy-service
      responsibility: |
        Расчёт дивидендов и выплат:
        - Расчёт дивидендов по акциям
        - Расчёт доходности облигаций
        - Расчёт доходности недвижимости
        - Начисление выплат
      methods:
        - calculateDividends(positionId)
        - calculateBondYield(positionId)
        - calculateRealEstateYield(positionId)
        - processPayouts(playerId)

    - name: Investment Analytics Collector
      location: analytics-service
      responsibility: |
        Сбор аналитики по инвестициям:
        - Сбор метрик портфеля
        - Анализ доходности
        - Прогнозы
        - Интеграция с analytics-service
      methods:
        - collectPortfolioMetrics(playerId)
        - analyzeReturns(playerId, timeRange)
        - generateForecasts(playerId)
        - generateReports(playerId)

    - name: Investment Lifecycle Manager
      location: economy-service
      responsibility: |
        Управление жизненным циклом инвестиций:
        - Discovery (обнаружение продуктов)
        - Research (исследование)
        - Purchase (покупка)
        - Hold (удержание)
        - Rebalance (ребалансировка)
        - Exit (выход)
      methods:
        - discoverProducts(playerId, criteria)
        - researchProduct(productId)
        - purchaseInvestment(playerId, productId, amount)
        - holdInvestment(positionId)
        - exitInvestment(positionId, exitStrategy)

  data_flow:
    investment_discovery: |
      1. Игрок запрашивает каталог инвестиционных продуктов
      2. Investment Product Catalog возвращает доступные продукты
      3. Игрок исследует продукт (research)
      4. Risk Analyzer анализирует риски для игрока
      5. Игрок получает рекомендации

    investment_purchase: |
      1. Игрок создаёт инвестиционную позицию через Investment Manager
      2. Investment Manager проверяет доступность продукта
      3. Risk Analyzer проверяет suitability и margin requirements
      4. Portfolio Manager обновляет портфель игрока
      5. Транзакция создаётся и сохраняется в БД
      6. Событие публикуется в Event Bus (economy.investment.purchased)
      7. Investment Lifecycle Manager переводит статус в HOLD

    dividend_payout: |
      1. Dividend Calculator рассчитывает дивиденды для позиций
      2. Начисление выплат в wallet игрока
      3. Транзакция создаётся
      4. Событие публикуется в Event Bus (economy.investment.dividend_paid)
      5. Investment Analytics Collector обновляет метрики

    portfolio_rebalancing: |
      1. Portfolio Rebalancer анализирует текущее распределение портфеля
      2. Генерируются рекомендации по ребалансировке
      3. Игрок применяет рекомендации (или автоматически)
      4. Investment Manager создаёт новые позиции или закрывает существующие
      5. Portfolio Manager обновляет портфель
      6. Событие публикуется в Event Bus (economy.investment.rebalanced)

    investment_exit: |
      1. Игрок запрашивает выход из инвестиции
      2. Investment Manager закрывает позицию
      3. Расчёт прибыли/убытка
      4. Выплата средств в wallet игрока
      5. Транзакция создаётся
      6. Investment Lifecycle Manager переводит статус в EXIT
      7. Событие публикуется в Event Bus (economy.investment.exited)

  integrations:
    with_stock_exchange: |
      - Получение данных об акциях
      - Синхронизация цен
      - Обработка дивидендов
      - Интеграция с биржевыми событиями

    with_housing_system: |
      - Получение данных о недвижимости
      - Синхронизация доходности
      - Управление инвестициями в недвижимость

    with_economy_events: |
      - Получение активных экономических событий
      - Влияние событий на доходность инвестиций
      - Влияние событий на риски

    with_analytics_service: |
      - Отправка метрик портфеля
      - Получение аналитики и рекомендаций
      - Генерация отчетов

    with_wallet_service: |
      - Списание средств при покупке
      - Начисление выплат (дивиденды, доходность)
      - Возврат средств при выходе

  event_bus_events:
    published:
      - economy.investment.product.discovered
      - economy.investment.purchased
      - economy.investment.position.updated
      - economy.investment.dividend_paid
      - economy.investment.rebalanced
      - economy.investment.exited
      - economy.investment.risk_alert
      - economy.investment.margin_call
    subscribed:
      - economy.event.active (для влияния на доходность)
      - stock-exchange.price.updated (для синхронизации цен акций)
      - housing.yield.updated (для синхронизации доходности недвижимости)

  database_schema:
    tables:
      - name: investment_products
        description: Инвестиционные продукты
        fields:
          - id: UUID (PK)
          - product_type: ENUM (stock, bond, real_estate, production_share, commodity_speculation)
          - name: VARCHAR(255)
          - description: TEXT
          - issuer_id: UUID (FK corporations/factions, nullable)
          - base_yield_percentage: DECIMAL(5,2)
          - risk_level: ENUM (low, medium, high, very_high)
          - min_investment_amount: DECIMAL(10,2)
          - max_investment_amount: DECIMAL(10,2) (nullable)
          - liquidity: ENUM (high, medium, low)
          - maturity_days: INTEGER (nullable, для облигаций)
          - available: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - product_type, available
          - issuer_id
          - risk_level

      - name: player_investment_positions
        description: Инвестиционные позиции игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - product_id: UUID (FK investment_products)
          - position_type: ENUM (long, short, nullable)
          - amount: DECIMAL(10,2)
          - purchase_price: DECIMAL(10,2)
          - current_price: DECIMAL(10,2)
          - current_value: DECIMAL(10,2)
          - profit_loss: DECIMAL(10,2)
          - profit_loss_percentage: DECIMAL(5,2)
          - status: ENUM (active, closed, suspended)
          - purchased_at: TIMESTAMP
          - closed_at: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - player_id, status
          - product_id, status
          - purchased_at

      - name: investment_transactions
        description: Транзакции по инвестициям
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - position_id: UUID (FK player_investment_positions, nullable)
          - transaction_type: ENUM (purchase, sale, dividend, interest, fee, tax)
          - product_id: UUID (FK investment_products)
          - amount: DECIMAL(10,2)
          - price: DECIMAL(10,2) (nullable)
          - total: DECIMAL(10,2)
          - currency: VARCHAR(10)
          - status: ENUM (pending, completed, failed, cancelled)
          - executed_at: TIMESTAMP
          - created_at: TIMESTAMP
        indexes:
          - player_id, executed_at
          - position_id
