metadata:
  id: economy-logistics-system-architecture
  title: Архитектура системы логистики и перевозок
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T13:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - logistics
    - transportation
    - insurance
  related_systems:
    - economy-service
    - logistics-service
    - insurance-service
    - inventory-service
    - world-service
  related_documents:
    - id: economy-logistics
      relation: extends
    - id: economy-contracts
      relation: integrates_with
    - id: economy-events
      relation: influences
    - id: game-mechanics-systems-architecture
      relation: extends
  github_issue: 230
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы логистики и перевозок для перемещения товаров
    между регионами с учётом рисков, страхования, эскорта и мониторинга SLA.
  goal: |
    Создать архитектурную схему системы логистики с определением:
    - Микросервисов для управления перевозками
    - Компонентов для расчёта стоимости, управления рисками, страхования
    - API endpoints (высокоуровнево)
    - Интеграций с другими экономическими системами
    - Структуры БД для хранения перевозок и их состояния
    - Технического задания для реализации
  essence: |
    Система логистики управляет жизненным циклом перевозок (DRAFT → SCHEDULED → IN_TRANSIT → DELIVERED/LOST),
    рассчитывает стоимость с учётом транспорта, рисков, страхования и эскорта, отслеживает перевозки в реальном времени
    и управляет рисками через вероятностные модели.

architecture:
  overview: |
    Система логистики состоит из следующих компонентов:
    1. Logistics Manager - управление перевозками и их жизненным циклом
    2. Quote Calculator - расчёт стоимости перевозки
    3. Route Planner - планирование маршрутов
    4. Transport Manager - управление типами транспорта
    5. Risk Engine - управление рисками и вероятностные модели
    6. Insurance Manager - управление страхованием перевозок
    7. Escort Manager - управление конвоями и эскортом
    8. Tracking Manager - отслеживание перевозок в реальном времени
    9. SLA Monitor - мониторинг SLA и алертинг
    10. Incident Manager - обработка инцидентов (атаки, аварии, задержки)

  microservices:
    - name: logistics-service
      location: services/logistics-service
      responsibility: |
        Основной сервис для управления логистикой и перевозками:
        - CRUD операции с перевозками
        - Управление жизненным циклом перевозок
        - Расчёт стоимости перевозок
        - Планирование маршрутов
        - Отслеживание перевозок
      components:
        - Logistics Manager
        - Quote Calculator
        - Route Planner
        - Transport Manager
        - Tracking Manager
      endpoints:
        - POST /api/v1/logistics/shipments/quote - расчёт стоимости перевозки
        - POST /api/v1/logistics/shipments - создание перевозки
        - GET /api/v1/logistics/shipments/{id} - детали перевозки
        - PUT /api/v1/logistics/shipments/{id} - обновление перевозки
        - DELETE /api/v1/logistics/shipments/{id} - отмена перевозки
        - POST /api/v1/logistics/shipments/{id}/schedule - планирование перевозки
        - POST /api/v1/logistics/shipments/{id}/start - начало перевозки
        - POST /api/v1/logistics/shipments/{id}/complete - завершение перевозки
        - GET /api/v1/logistics/shipments - список перевозок (с фильтрами)
        - GET /api/v1/logistics/shipments/active - активные перевозки
        - WS /ws/logistics/shipments/{id} - WebSocket для отслеживания перевозки

    - name: risk-service
      location: services/risk-service (или модуль в logistics-service)
      responsibility: |
        Управление рисками перевозок:
        - Расчёт вероятностей рисков
        - Обработка инцидентов
        - Динамическая смена маршрутов
        - Интеграция с экономическими событиями
      components:
        - Risk Engine
        - Incident Manager
        - Route Optimizer
      endpoints:
        - POST /api/v1/risk/calculate - расчёт рисков для маршрута
        - POST /api/v1/risk/incidents - создание инцидента
        - GET /api/v1/risk/incidents/{id} - детали инцидента
        - POST /api/v1/risk/reroute - пересчёт маршрута при риске

    - name: insurance-service
      location: services/insurance-service
      responsibility: |
        Управление страхованием перевозок:
        - Расчёт стоимости страхования
        - Управление страховыми планами
        - Обработка страховых выплат
        - Интеграция с логистикой
      components:
        - Insurance Manager
        - Insurance Calculator
        - Claim Processor
      endpoints:
        - POST /api/v1/insurance/calculate - расчёт стоимости страхования
        - POST /api/v1/insurance/policies - создание страхового полиса
        - GET /api/v1/insurance/policies/{id} - детали полиса
        - POST /api/v1/insurance/claims - создание страхового требования
        - GET /api/v1/insurance/claims/{id} - детали требования

    - name: escort-service
      location: services/escort-service (или модуль в logistics-service)
      responsibility: |
        Управление конвоями и эскортом:
        - Найм эскорта
        - Управление бронированным транспортом
        - Расчёт влияния эскорта на риски
        - Координация конвоев
      components:
        - Escort Manager
        - Escort Calculator
        - Convoy Coordinator
      endpoints:
        - POST /api/v1/escort/calculate - расчёт стоимости эскорта
        - POST /api/v1/escort/hire - найм эскорта
        - GET /api/v1/escort/available - доступные эскорты
        - POST /api/v1/escort/convoy - создание конвоя

  components:
    - name: Logistics Manager
      location: logistics-service
      responsibility: |
        Управление перевозками и их жизненным циклом:
        - Создание, обновление, отмена перевозок
        - Переходы между состояниями (DRAFT → SCHEDULED → IN_TRANSIT → DELIVERED/LOST)
        - Валидация данных перевозок
        - Управление версиями перевозок
      methods:
        - createShipment(shipmentData)
        - updateShipment(shipmentId, shipmentData)
        - cancelShipment(shipmentId)
        - transitionState(shipmentId, newState)
        - getShipment(shipmentId)
        - listShipments(filters)

    - name: Quote Calculator
      location: logistics-service
      responsibility: |
        Расчёт стоимости перевозки:
        - Расчёт базовой стоимости по маршруту и транспорту
        - Учёт рисков и страхования
        - Учёт эскорта
        - Финальная стоимость перевозки
      methods:
        - calculateQuote(route, transport, cargo, insurance, escort)
        - calculateBaseCost(route, transport, cargo)
        - calculateRiskCost(route, risks)
        - calculateInsuranceCost(cargo, insurancePlan)
        - calculateEscortCost(escortType, route)

    - name: Route Planner
      location: logistics-service
      responsibility: |
        Планирование маршрутов:
        - Определение оптимальных маршрутов
        - Расчёт расстояний и времени доставки
        - Учёт рисков на маршрутах
        - Динамическая смена маршрутов при инцидентах
      methods:
        - planRoute(origin, destination, transportType)
        - calculateDistance(origin, destination)
        - calculateDeliveryTime(route, transportType)
        - optimizeRoute(route, risks)
        - reroute(shipmentId, newRoute)

    - name: Transport Manager
      location: logistics-service
      responsibility: |
        Управление типами транспорта:
        - Каталог транспорта (наземный, воздушный, железнодорожный, курьерский, самовывоз)
        - Характеристики транспорта (скорость, вместимость, стоимость)
        - Доступность транспорта
      methods:
        - getTransportTypes()
        - getTransportDetails(transportType)
        - checkAvailability(transportType, route)
        - reserveTransport(transportType, shipmentId)

    - name: Risk Engine
      location: risk-service
      responsibility: |
        Управление рисками и вероятностные модели:
        - Расчёт вероятностей рисков (атаки бандитов, аварии, таможенные задержки, погода)
        - Моделирование инцидентов
        - Расчёт влияния эскорта на риски
        - Интеграция с экономическими событиями
      methods:
        - calculateRisks(route, transportType, cargo)
        - simulateIncident(riskType, probability)
        - applyEscortRiskReduction(escortType, baseRisks)
        - getEventInfluencedRisks(route, activeEvents)

    - name: Insurance Manager
      location: insurance-service
      responsibility: |
        Управление страхованием перевозок:
        - Расчёт стоимости страхования (basic, premium, full)
        - Создание страховых полисов
        - Обработка страховых требований
        - Выплаты при потере груза
      methods:
        - calculateInsuranceCost(cargo, insurancePlan)
        - createPolicy(shipmentId, insurancePlan)
        - processClaim(claimId)
        - payoutClaim(claimId, amount)

    - name: Escort Manager
      location: escort-service
      responsibility: |
        Управление конвоями и эскортом:
        - Найм эскорта (NPC или игроки)
        - Управление бронированным транспортом
        - Расчёт влияния эскорта на вероятность атак
        - Координация конвоев
      methods:
        - calculateEscortCost(escortType, route)
        - hireEscort(shipmentId, escortType)
        - getAvailableEscorts(route)
        - createConvoy(shipmentIds)

    - name: Tracking Manager
      location: logistics-service
      responsibility: |
        Отслеживание перевозок в реальном времени:
        - Обновление позиции перевозки
        - WebSocket поток для клиентов
        - Уведомления о статусе
        - Интеграция с картой мира
      methods:
        - updatePosition(shipmentId, position)
        - getCurrentPosition(shipmentId)
        - subscribeToTracking(shipmentId, clientId)
        - sendTrackingUpdate(shipmentId, update)

    - name: SLA Monitor
      location: logistics-service
      responsibility: |
        Мониторинг SLA и алертинг:
        - Отслеживание времени доставки
        - Проверка отклонений от SLA
        - Генерация алертов
        - KPI метрики
      methods:
        - monitorSLA(shipmentId)
        - checkSLAViolations()
        - generateAlert(shipmentId, violation)
        - calculateKPIs(timeRange)

    - name: Incident Manager
      location: risk-service
      responsibility: |
        Обработка инцидентов:
        - Создание инцидентов (атаки, аварии, задержки)
        - Обработка последствий инцидентов
        - Уведомления об инцидентах
        - Интеграция со страхованием
      methods:
        - createIncident(shipmentId, incidentType, details)
        - processIncident(incidentId)
        - notifyIncident(shipmentId, incident)
        - handleLoss(shipmentId, incidentId)

  data_flow:
    shipment_creation: |
      1. Игрок запрашивает расчёт стоимости через Quote Calculator
      2. Quote Calculator получает данные о маршруте, транспорте, грузе
      3. Risk Engine рассчитывает риски для маршрута
      4. Insurance Manager рассчитывает стоимость страхования
      5. Escort Manager рассчитывает стоимость эскорта (если требуется)
      6. Quote Calculator суммирует все стоимости
      7. Игрок создаёт перевозку через Logistics Manager
      8. Перевозка сохраняется в БД со статусом DRAFT

    shipment_scheduling: |
      1. Игрок планирует перевозку (выбирает время отправки)
      2. Logistics Manager переводит статус DRAFT → SCHEDULED
      3. Transport Manager резервирует транспорт
      4. Insurance Manager создаёт страховой полис (если выбрано)
      5. Escort Manager нанимает эскорт (если требуется)
      6. Route Planner финализирует маршрут
      7. Событие публикуется в Event Bus (logistics.shipment.scheduled)

    shipment_start: |
      1. Наступает время отправки или игрок запускает перевозку вручную
      2. Logistics Manager переводит статус SCHEDULED → IN_TRANSIT
      3. Tracking Manager начинает отслеживание позиции
      4. SLA Monitor начинает мониторинг времени доставки
      5. WebSocket соединение открывается для клиента
      6. Событие публикуется в Event Bus (logistics.shipment.started)

    shipment_tracking: |
      1. Tracking Manager обновляет позицию перевозки (каждые N секунд)
      2. WebSocket отправляет обновления клиентам
      3. Risk Engine проверяет риски на текущей позиции
      4. При обнаружении риска: Incident Manager создаёт инцидент
      5. При инциденте: обработка последствий (потеря груза, задержка, повреждение)
      6. При потере: Insurance Manager обрабатывает страховое требование

    shipment_completion: |
      1. Перевозка достигает пункта назначения
      2. Logistics Manager переводит статус IN_TRANSIT → DELIVERED
      3. Inventory Service получает груз в пункте назначения
      4. SLA Monitor финализирует метрики
      5. Tracking Manager останавливает отслеживание
      6. Событие публикуется в Event Bus (logistics.shipment.delivered)
      7. Уведомления отправляются игроку

    incident_handling: |
      1. Risk Engine обнаруживает риск или инцидент происходит
      2. Incident Manager создаёт инцидент (атака, авария, задержка)
      3. Обработка последствий:
         - Потеря груза → статус LOST, страховое требование
         - Задержка → статус DELAYED, пересчёт времени доставки
         - Повреждение → снижение стоимости груза, страховое требование
      4. Уведомления отправляются игроку
      5. Событие публикуется в Event Bus (logistics.shipment.incident)

  integrations:
    with_economy_service: |
      - Получение данных о грузе
      - Синхронизация стоимости перевозок
      - Интеграция с контрактами

    with_inventory_service: |
      - Резервирование груза при создании перевозки
      - Передача груза в пункте назначения
      - Возврат груза при отмене перевозки

    with_insurance_service: |
      - Расчёт стоимости страхования
      - Создание страховых полисов
      - Обработка страховых требований

    with_world_service: |
      - Получение данных о регионах и маршрутах
      - Интеграция с картой мира
      - Синхронизация позиций перевозок

    with_economy_events: |
      - Получение активных экономических событий
      - Влияние событий на риски (кризисы, эмбарго)
      - Влияние событий на стоимость перевозок

    with_notification_service: |
      - Уведомления о статусе перевозки
      - Уведомления об инцидентах
      - Уведомления о доставке

  event_bus_events:
    published:
      - logistics.shipment.created
      - logistics.shipment.scheduled
      - logistics.shipment.started
      - logistics.shipment.position_updated
      - logistics.shipment.incident
      - logistics.shipment.delayed
      - logistics.shipment.delivered
      - logistics.shipment.lost
      - logistics.shipment.cancelled
    subscribed:
      - economy.event.active (для влияния на риски)
      - world.region.changed (для изменения маршрутов)

