metadata:
  id: economy-logistics-system-architecture
  title: Архитектура системы логистики и перевозок
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T13:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - logistics
    - transportation
    - insurance
  related_systems:
    - economy-service
    - logistics-service
    - insurance-service
    - inventory-service
    - world-service
  related_documents:
    - id: economy-logistics
      relation: extends
    - id: economy-contracts
      relation: integrates_with
    - id: economy-events
      relation: influences
    - id: game-mechanics-systems-architecture
      relation: extends
  github_issue: 230
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы логистики и перевозок для перемещения товаров
    между регионами с учётом рисков, страхования, эскорта и мониторинга SLA.
  goal: |
    Создать архитектурную схему системы логистики с определением:
    - Микросервисов для управления перевозками
    - Компонентов для расчёта стоимости, управления рисками, страхования
    - API endpoints (высокоуровнево)
    - Интеграций с другими экономическими системами
    - Структуры БД для хранения перевозок и их состояния
    - Технического задания для реализации
  essence: |
    Система логистики управляет жизненным циклом перевозок (DRAFT → SCHEDULED → IN_TRANSIT → DELIVERED/LOST),
    рассчитывает стоимость с учётом транспорта, рисков, страхования и эскорта, отслеживает перевозки в реальном времени
    и управляет рисками через вероятностные модели.

architecture:
  overview: |
    Система логистики состоит из следующих компонентов:
    1. Logistics Manager - управление перевозками и их жизненным циклом
    2. Quote Calculator - расчёт стоимости перевозки
    3. Route Planner - планирование маршрутов
    4. Transport Manager - управление типами транспорта
    5. Risk Engine - управление рисками и вероятностные модели
    6. Insurance Manager - управление страхованием перевозок
    7. Escort Manager - управление конвоями и эскортом
    8. Tracking Manager - отслеживание перевозок в реальном времени
    9. SLA Monitor - мониторинг SLA и алертинг
    10. Incident Manager - обработка инцидентов (атаки, аварии, задержки)

  microservices:
    - name: logistics-service
      location: services/logistics-service
      responsibility: |
        Основной сервис для управления логистикой и перевозками:
        - CRUD операции с перевозками
        - Управление жизненным циклом перевозок
        - Расчёт стоимости перевозок
        - Планирование маршрутов
        - Отслеживание перевозок
      components:
        - Logistics Manager
        - Quote Calculator
        - Route Planner
        - Transport Manager
        - Tracking Manager
      endpoints:
        - POST /api/v1/logistics/shipments/quote - расчёт стоимости перевозки
        - POST /api/v1/logistics/shipments - создание перевозки
        - GET /api/v1/logistics/shipments/{id} - детали перевозки
        - PUT /api/v1/logistics/shipments/{id} - обновление перевозки
        - DELETE /api/v1/logistics/shipments/{id} - отмена перевозки
        - POST /api/v1/logistics/shipments/{id}/schedule - планирование перевозки
        - POST /api/v1/logistics/shipments/{id}/start - начало перевозки
        - POST /api/v1/logistics/shipments/{id}/complete - завершение перевозки
        - GET /api/v1/logistics/shipments - список перевозок (с фильтрами)
        - GET /api/v1/logistics/shipments/active - активные перевозки
        - WS /ws/logistics/shipments/{id} - WebSocket для отслеживания перевозки

    - name: risk-service
      location: services/risk-service (или модуль в logistics-service)
      responsibility: |
        Управление рисками перевозок:
        - Расчёт вероятностей рисков
        - Обработка инцидентов
        - Динамическая смена маршрутов
        - Интеграция с экономическими событиями
      components:
        - Risk Engine
        - Incident Manager
        - Route Optimizer
      endpoints:
        - POST /api/v1/risk/calculate - расчёт рисков для маршрута
        - POST /api/v1/risk/incidents - создание инцидента
        - GET /api/v1/risk/incidents/{id} - детали инцидента
        - POST /api/v1/risk/reroute - пересчёт маршрута при риске

    - name: insurance-service
      location: services/insurance-service
      responsibility: |
        Управление страхованием перевозок:
        - Расчёт стоимости страхования
        - Управление страховыми планами
        - Обработка страховых выплат
        - Интеграция с логистикой
      components:
        - Insurance Manager
        - Insurance Calculator
        - Claim Processor
      endpoints:
        - POST /api/v1/insurance/calculate - расчёт стоимости страхования
        - POST /api/v1/insurance/policies - создание страхового полиса
        - GET /api/v1/insurance/policies/{id} - детали полиса
        - POST /api/v1/insurance/claims - создание страхового требования
        - GET /api/v1/insurance/claims/{id} - детали требования

    - name: escort-service
      location: services/escort-service (или модуль в logistics-service)
      responsibility: |
        Управление конвоями и эскортом:
        - Найм эскорта
        - Управление бронированным транспортом
        - Расчёт влияния эскорта на риски
        - Координация конвоев
      components:
        - Escort Manager
        - Escort Calculator
        - Convoy Coordinator
      endpoints:
        - POST /api/v1/escort/calculate - расчёт стоимости эскорта
        - POST /api/v1/escort/hire - найм эскорта
        - GET /api/v1/escort/available - доступные эскорты
        - POST /api/v1/escort/convoy - создание конвоя

  components:
    - name: Logistics Manager
      location: logistics-service
      responsibility: |
        Управление перевозками и их жизненным циклом:
        - Создание, обновление, отмена перевозок
        - Переходы между состояниями (DRAFT → SCHEDULED → IN_TRANSIT → DELIVERED/LOST)
        - Валидация данных перевозок
        - Управление версиями перевозок
      methods:
        - createShipment(shipmentData)
        - updateShipment(shipmentId, shipmentData)
        - cancelShipment(shipmentId)
        - transitionState(shipmentId, newState)
        - getShipment(shipmentId)
        - listShipments(filters)

    - name: Quote Calculator
      location: logistics-service
      responsibility: |
        Расчёт стоимости перевозки:
        - Расчёт базовой стоимости по маршруту и транспорту
        - Учёт рисков и страхования
        - Учёт эскорта
        - Финальная стоимость перевозки
      methods:
        - calculateQuote(route, transport, cargo, insurance, escort)
        - calculateBaseCost(route, transport, cargo)
        - calculateRiskCost(route, risks)
        - calculateInsuranceCost(cargo, insurancePlan)
        - calculateEscortCost(escortType, route)

    - name: Route Planner
      location: logistics-service
      responsibility: |
        Планирование маршрутов:
        - Определение оптимальных маршрутов
        - Расчёт расстояний и времени доставки
        - Учёт рисков на маршрутах
        - Динамическая смена маршрутов при инцидентах
      methods:
        - planRoute(origin, destination, transportType)
        - calculateDistance(origin, destination)
        - calculateDeliveryTime(route, transportType)
        - optimizeRoute(route, risks)
        - reroute(shipmentId, newRoute)

    - name: Transport Manager
      location: logistics-service
      responsibility: |
        Управление типами транспорта:
        - Каталог транспорта (наземный, воздушный, железнодорожный, курьерский, самовывоз)
        - Характеристики транспорта (скорость, вместимость, стоимость)
        - Доступность транспорта
      methods:
        - getTransportTypes()
        - getTransportDetails(transportType)
        - checkAvailability(transportType, route)
        - reserveTransport(transportType, shipmentId)

    - name: Risk Engine
      location: risk-service
      responsibility: |
        Управление рисками и вероятностные модели:
        - Расчёт вероятностей рисков (атаки бандитов, аварии, таможенные задержки, погода)
        - Моделирование инцидентов
        - Расчёт влияния эскорта на риски
        - Интеграция с экономическими событиями
      methods:
        - calculateRisks(route, transportType, cargo)
        - simulateIncident(riskType, probability)
        - applyEscortRiskReduction(escortType, baseRisks)
        - getEventInfluencedRisks(route, activeEvents)

    - name: Insurance Manager
      location: insurance-service
      responsibility: |
        Управление страхованием перевозок:
        - Расчёт стоимости страхования (basic, premium, full)
        - Создание страховых полисов
        - Обработка страховых требований
        - Выплаты при потере груза
      methods:
        - calculateInsuranceCost(cargo, insurancePlan)
        - createPolicy(shipmentId, insurancePlan)
        - processClaim(claimId)
        - payoutClaim(claimId, amount)

    - name: Escort Manager
      location: escort-service
      responsibility: |
        Управление конвоями и эскортом:
        - Найм эскорта (NPC или игроки)
        - Управление бронированным транспортом
        - Расчёт влияния эскорта на вероятность атак
        - Координация конвоев
      methods:
        - calculateEscortCost(escortType, route)
        - hireEscort(shipmentId, escortType)
        - getAvailableEscorts(route)
        - createConvoy(shipmentIds)

    - name: Tracking Manager
      location: logistics-service
      responsibility: |
        Отслеживание перевозок в реальном времени:
        - Обновление позиции перевозки
        - WebSocket поток для клиентов
        - Уведомления о статусе
        - Интеграция с картой мира
      methods:
        - updatePosition(shipmentId, position)
        - getCurrentPosition(shipmentId)
        - subscribeToTracking(shipmentId, clientId)
        - sendTrackingUpdate(shipmentId, update)

    - name: SLA Monitor
      location: logistics-service
      responsibility: |
        Мониторинг SLA и алертинг:
        - Отслеживание времени доставки
        - Проверка отклонений от SLA
        - Генерация алертов
        - KPI метрики
      methods:
        - monitorSLA(shipmentId)
        - checkSLAViolations()
        - generateAlert(shipmentId, violation)
        - calculateKPIs(timeRange)

    - name: Incident Manager
      location: risk-service
      responsibility: |
        Обработка инцидентов:
        - Создание инцидентов (атаки, аварии, задержки)
        - Обработка последствий инцидентов
        - Уведомления об инцидентах
        - Интеграция со страхованием
      methods:
        - createIncident(shipmentId, incidentType, details)
        - processIncident(incidentId)
        - notifyIncident(shipmentId, incident)
        - handleLoss(shipmentId, incidentId)

  data_flow:
    shipment_creation: |
      1. Игрок запрашивает расчёт стоимости через Quote Calculator
      2. Quote Calculator получает данные о маршруте, транспорте, грузе
      3. Risk Engine рассчитывает риски для маршрута
      4. Insurance Manager рассчитывает стоимость страхования
      5. Escort Manager рассчитывает стоимость эскорта (если требуется)
      6. Quote Calculator суммирует все стоимости
      7. Игрок создаёт перевозку через Logistics Manager
      8. Перевозка сохраняется в БД со статусом DRAFT

    shipment_scheduling: |
      1. Игрок планирует перевозку (выбирает время отправки)
      2. Logistics Manager переводит статус DRAFT → SCHEDULED
      3. Transport Manager резервирует транспорт
      4. Insurance Manager создаёт страховой полис (если выбрано)
      5. Escort Manager нанимает эскорт (если требуется)
      6. Route Planner финализирует маршрут
      7. Событие публикуется в Event Bus (logistics.shipment.scheduled)

    shipment_start: |
      1. Наступает время отправки или игрок запускает перевозку вручную
      2. Logistics Manager переводит статус SCHEDULED → IN_TRANSIT
      3. Tracking Manager начинает отслеживание позиции
      4. SLA Monitor начинает мониторинг времени доставки
      5. WebSocket соединение открывается для клиента
      6. Событие публикуется в Event Bus (logistics.shipment.started)

    shipment_tracking: |
      1. Tracking Manager обновляет позицию перевозки (каждые N секунд)
      2. WebSocket отправляет обновления клиентам
      3. Risk Engine проверяет риски на текущей позиции
      4. При обнаружении риска: Incident Manager создаёт инцидент
      5. При инциденте: обработка последствий (потеря груза, задержка, повреждение)
      6. При потере: Insurance Manager обрабатывает страховое требование

    shipment_completion: |
      1. Перевозка достигает пункта назначения
      2. Logistics Manager переводит статус IN_TRANSIT → DELIVERED
      3. Inventory Service получает груз в пункте назначения
      4. SLA Monitor финализирует метрики
      5. Tracking Manager останавливает отслеживание
      6. Событие публикуется в Event Bus (logistics.shipment.delivered)
      7. Уведомления отправляются игроку

    incident_handling: |
      1. Risk Engine обнаруживает риск или инцидент происходит
      2. Incident Manager создаёт инцидент (атака, авария, задержка)
      3. Обработка последствий:
         - Потеря груза → статус LOST, страховое требование
         - Задержка → статус DELAYED, пересчёт времени доставки
         - Повреждение → снижение стоимости груза, страховое требование
      4. Уведомления отправляются игроку
      5. Событие публикуется в Event Bus (logistics.shipment.incident)

  integrations:
    with_economy_service: |
      - Получение данных о грузе
      - Синхронизация стоимости перевозок
      - Интеграция с контрактами

    with_inventory_service: |
      - Резервирование груза при создании перевозки
      - Передача груза в пункте назначения
      - Возврат груза при отмене перевозки

    with_insurance_service: |
      - Расчёт стоимости страхования
      - Создание страховых полисов
      - Обработка страховых требований

    with_world_service: |
      - Получение данных о регионах и маршрутах
      - Интеграция с картой мира
      - Синхронизация позиций перевозок

    with_economy_events: |
      - Получение активных экономических событий
      - Влияние событий на риски (кризисы, эмбарго)
      - Влияние событий на стоимость перевозок

    with_notification_service: |
      - Уведомления о статусе перевозки
      - Уведомления об инцидентах
      - Уведомления о доставке

  event_bus_events:
    published:
      - logistics.shipment.created
      - logistics.shipment.scheduled
      - logistics.shipment.started
      - logistics.shipment.position_updated
      - logistics.shipment.incident
      - logistics.shipment.delayed
      - logistics.shipment.delivered
      - logistics.shipment.lost
      - logistics.shipment.cancelled
    subscribed:
      - economy.event.active (для влияния на риски)
      - world.region.changed (для изменения маршрутов)

  database_schema:
    tables:
      - name: transport_shipments
        description: Перевозки
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - origin_region_id: UUID (FK regions)
          - destination_region_id: UUID (FK regions)
          - transport_type: ENUM (ground, air, rail, courier, player_pickup)
          - cargo_data: JSONB (список предметов, вес, объём, стоимость)
          - route_data: JSONB (маршрут, расстояние, время доставки)
          - status: ENUM (DRAFT, SCHEDULED, IN_TRANSIT, DELAYED, DELIVERED, LOST, CANCELLED)
          - scheduled_departure: TIMESTAMP (nullable)
          - actual_departure: TIMESTAMP (nullable)
          - estimated_arrival: TIMESTAMP (nullable)
          - actual_arrival: TIMESTAMP (nullable)
          - current_position: POINT (nullable, для отслеживания)
          - insurance_plan: ENUM (none, basic, premium, full, nullable)
          - insurance_policy_id: UUID (FK insurance_policies, nullable)
          - escort_type: ENUM (none, npc_escort, player_escort, armored_transport, nullable)
          - escort_id: UUID (nullable)
          - base_cost: DECIMAL(10,2)
          - insurance_cost: DECIMAL(10,2)
          - escort_cost: DECIMAL(10,2)
          - total_cost: DECIMAL(10,2)
          - sla_target_hours: INTEGER
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - player_id, status
          - status, scheduled_departure
          - origin_region_id, destination_region_id
          - current_position (GIST index для геопозиции)

      - name: transport_routes
        description: Маршруты перевозок
        fields:
          - id: UUID (PK)
          - shipment_id: UUID (FK transport_shipments)
          - route_type: ENUM (local, regional, global)
          - waypoints: POINT[] (массив точек маршрута)
          - distance_km: DECIMAL(10,2)
          - estimated_hours: DECIMAL(10,2)
          - base_risk_level: DECIMAL(3,2) (0.00-1.00)
          - created_at: TIMESTAMP
        indexes:
          - shipment_id

      - name: transport_incidents
        description: Инциденты перевозок
        fields:
          - id: UUID (PK)
          - shipment_id: UUID (FK transport_shipments)
          - incident_type: ENUM (bandit_attack, accident, customs_delay, weather, other)
          - severity: ENUM (low, medium, high, critical)
          - description: TEXT
          - position: POINT
          - occurred_at: TIMESTAMP
          - resolved_at: TIMESTAMP (nullable)
          - cargo_loss_percentage: DECIMAL(5,2) (0.00-100.00)
          - delay_hours: INTEGER
          - resolved: BOOLEAN
        indexes:
          - shipment_id, occurred_at
          - incident_type, severity

      - name: transport_tracking
        description: Отслеживание позиций перевозок
        fields:
          - id: UUID (PK)
          - shipment_id: UUID (FK transport_shipments)
          - position: POINT
          - speed_kmh: DECIMAL(10,2)
          - progress_percentage: DECIMAL(5,2) (0.00-100.00)
          - recorded_at: TIMESTAMP
        indexes:
          - shipment_id, recorded_at
          - position (GIST index)

      - name: transport_sla_metrics
        description: Метрики SLA перевозок
        fields:
          - id: UUID (PK)
          - shipment_id: UUID (FK transport_shipments)
          - target_hours: INTEGER
          - actual_hours: INTEGER (nullable)
          - on_time: BOOLEAN (nullable)
          - sla_violated: BOOLEAN
          - violation_reason: TEXT (nullable)
          - measured_at: TIMESTAMP
        indexes:
          - shipment_id
          - sla_violated, measured_at

technical_specification:
  backend_requirements:
    - Реализация Logistics Manager в logistics-service:
      - CRUD операции с перевозками
      - Управление жизненным циклом (переходы состояний)
      - Валидация данных перевозок
    - Реализация Quote Calculator:
      - Расчёт базовой стоимости
      - Учёт рисков, страхования, эскорта
      - Финальная стоимость
    - Реализация Route Planner:
      - Планирование маршрутов
      - Расчёт расстояний и времени
      - Оптимизация маршрутов
    - Реализация Transport Manager:
      - Каталог транспорта
      - Резервирование транспорта
    - Реализация Risk Engine:
      - Расчёт вероятностей рисков
      - Моделирование инцидентов
      - Интеграция с экономическими событиями
    - Реализация Insurance Manager:
      - Расчёт стоимости страхования
      - Создание полисов
      - Обработка требований
    - Реализация Escort Manager:
      - Найм эскорта
      - Расчёт влияния на риски
    - Реализация Tracking Manager:
      - Отслеживание позиций
      - WebSocket поток
    - Реализация SLA Monitor:
      - Мониторинг времени доставки
      - Генерация алертов
    - Реализация Incident Manager:
      - Обработка инцидентов
      - Интеграция со страхованием
    - Создание схемы БД (transport_shipments, transport_routes, transport_incidents, transport_tracking, transport_sla_metrics)

  performance_requirements:
    - Расчёт стоимости: <200 мс
    - Создание перевозки: <300 мс
    - Обновление позиции: <50 мс
    - WebSocket обновления: каждые 1-5 секунд
    - Поддержка до 1000 активных перевозок одновременно

  scalability_requirements:
    - Горизонтальное масштабирование через пул инстансов
    - Распределение перевозок по инстансам
    - Кэширование маршрутов в Redis
    - Асинхронная обработка инцидентов через очереди

subtasks:
  - id: logistics-manager
    title: Реализация Logistics Manager
    description: |
      CRUD операции и управление жизненным циклом перевозок:
      - Создание, обновление, отмена перевозок
      - Переходы между состояниями
      - Валидация данных
    priority: high
    estimated_time: 5-6 дней

  - id: quote-calculator
    title: Реализация Quote Calculator
    description: |
      Расчёт стоимости перевозок:
      - Базовая стоимость
      - Учёт рисков, страхования, эскорта
      - Финальная стоимость
    priority: high
    estimated_time: 4-5 дней

  - id: route-planner
    title: Реализация Route Planner
    description: |
      Планирование маршрутов:
      - Определение оптимальных маршрутов
      - Расчёт расстояний и времени
      - Динамическая смена маршрутов
    priority: high
    estimated_time: 5-6 дней

  - id: transport-manager
    title: Реализация Transport Manager
    description: |
      Управление типами транспорта:
      - Каталог транспорта
      - Резервирование транспорта
    priority: high
    estimated_time: 3-4 дня

  - id: risk-engine
    title: Реализация Risk Engine
    description: |
      Управление рисками:
      - Расчёт вероятностей рисков
      - Моделирование инцидентов
      - Интеграция с экономическими событиями
    priority: high
    estimated_time: 6-7 дней

  - id: insurance-manager
    title: Реализация Insurance Manager
    description: |
      Управление страхованием:
      - Расчёт стоимости страхования
      - Создание полисов
      - Обработка требований
    priority: medium
    estimated_time: 4-5 дней

  - id: escort-manager
    title: Реализация Escort Manager
    description: |
      Управление эскортом:
      - Найм эскорта
      - Расчёт влияния на риски
      - Координация конвоев
    priority: medium
    estimated_time: 4-5 дней

  - id: tracking-manager
    title: Реализация Tracking Manager
    description: |
      Отслеживание перевозок:
      - Обновление позиций
      - WebSocket поток
      - Интеграция с картой
    priority: high
    estimated_time: 5-6 дней

  - id: sla-monitor
    title: Реализация SLA Monitor
    description: |
      Мониторинг SLA:
      - Отслеживание времени доставки
      - Генерация алертов
      - KPI метрики
    priority: medium
    estimated_time: 3-4 дня

  - id: incident-manager
    title: Реализация Incident Manager
    description: |
      Обработка инцидентов:
      - Создание инцидентов
      - Обработка последствий
      - Интеграция со страхованием
    priority: high
    estimated_time: 5-6 дней

  - id: database-schema
    title: Создание схемы БД для логистики
    description: |
      Создание таблиц:
      - transport_shipments
      - transport_routes
      - transport_incidents
      - transport_tracking
      - transport_sla_metrics
    priority: high
    estimated_time: 2-3 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для системы логистики:
      - CRUD операции
      - Управление жизненным циклом
      - Отслеживание и мониторинг
    priority: high
    estimated_time: 4-5 дней

  - id: websocket-tracking
    title: Реализация WebSocket для отслеживания
    description: |
      WebSocket поток для клиентов:
      - Подписка на перевозку
      - Обновления позиции в реальном времени
      - Уведомления об инцидентах
    priority: high
    estimated_time: 3-4 дня

  - id: event-bus-integration
    title: Интеграция с Event Bus
    description: |
      Публикация и подписка на события:
      - logistics.shipment.* события
      - Подписка на economy.event.active, world.region.changed
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты системы логистики:
      - Тесты жизненного цикла
      - Тесты расчёта стоимости
      - Тесты рисков и инцидентов
      - Тесты интеграций
      - Тесты производительности
    priority: high
    estimated_time: 6-7 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Logistics Service"
            LM[Logistics Manager]
            QC[Quote Calculator]
            RP[Route Planner]
            TM[Transport Manager]
            TRM[Tracking Manager]
            SLAM[SLA Monitor]
        end

        subgraph "Risk Service"
            RE[Risk Engine]
            IM[Incident Manager]
            RO[Route Optimizer]
        end

        subgraph "Insurance Service"
            INS[Insurance Manager]
            IC[Insurance Calculator]
            CP[Claim Processor]
        end

        subgraph "Escort Service"
            EM[Escort Manager]
            EC[Escort Calculator]
            CC[Convoy Coordinator]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>transport_shipments<br/>transport_routes<br/>transport_incidents<br/>transport_tracking<br/>transport_sla_metrics)]
        end

        subgraph "Event Bus"
            EB[Kafka/Event Bus]
        end

        subgraph "External Services"
            ES[Economy Service]
            IS[Inventory Service]
            WS[World Service]
            NS[Notification Service]
        end

        LM --> QC
        LM --> RP
        LM --> TM
        LM --> TRM
        LM --> SLAM
        QC --> RE
        QC --> INS
        QC --> EM
        RP --> RE
        RE --> IM
        IM --> INS
        TRM --> SLAM
        LM --> DB
        RE --> DB
        IM --> DB
        TRM --> DB
        LM --> EB
        RE --> EB
        IM --> EB
        LM --> ES
        LM --> IS
        RP --> WS
        LM --> NS
    ```

  shipment_lifecycle_flow: |
    ```mermaid
    stateDiagram-v2
        [*] --> DRAFT: Create Shipment
        DRAFT --> SCHEDULED: Schedule
        SCHEDULED --> IN_TRANSIT: Start
        IN_TRANSIT --> DELIVERED: Complete
        IN_TRANSIT --> DELAYED: Incident
        IN_TRANSIT --> LOST: Critical Incident
        DELAYED --> IN_TRANSIT: Resume
        DELAYED --> LOST: Critical Incident
        DRAFT --> CANCELLED: Cancel
        SCHEDULED --> CANCELLED: Cancel
        DELIVERED --> [*]
        LOST --> [*]
        CANCELLED --> [*]
    ```

  quote_calculation_flow: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant QC as Quote Calculator
        participant RP as Route Planner
        participant RE as Risk Engine
        participant INS as Insurance Manager
        participant EM as Escort Manager

        C->>QC: Request Quote
        QC->>RP: Plan Route
        RP->>QC: Return Route Data
        QC->>RE: Calculate Risks
        RE->>QC: Return Risk Data
        QC->>INS: Calculate Insurance
        INS->>QC: Return Insurance Cost
        QC->>EM: Calculate Escort
        EM->>QC: Return Escort Cost
        QC->>QC: Calculate Total Cost
        QC->>C: Return Quote
    ```

decisions:
  - id: adr-logistics-architecture
    summary: |
      Выбрана микросервисная архитектура с logistics-service как основным сервисом
      и отдельными сервисами для рисков, страхования и эскорта.

  - id: adr-shipment-lifecycle
    summary: |
      Реализован жизненный цикл перевозок с состояниями DRAFT → SCHEDULED → IN_TRANSIT → DELIVERED/LOST
      для управления перевозками от создания до доставки.

  - id: adr-risk-management
    summary: |
      Риски управляются через вероятностные модели с учётом типа транспорта, маршрута,
      экономических событий и эскорта для реалистичного моделирования.

  - id: adr-tracking-system
    summary: |
      Отслеживание перевозок реализовано через WebSocket для реального времени
      и обновление позиций в БД для истории.

  - id: adr-insurance-integration
    summary: |
      Страхование интегрировано с логистикой через insurance-service
      с автоматической обработкой требований при потере груза.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация формата данных перевозок (JSONB структура)
  - Определение формата маршрутов и позиций
  - Создание схем сообщений для Event Bus

history:
  - version: "1.0.0"
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы логистики и перевозок:
      - Определены микросервисы (logistics-service, risk-service, insurance-service, escort-service)
      - Определены компоненты (Logistics Manager, Quote Calculator, Route Planner, Transport Manager, Risk Engine, Insurance Manager, Escort Manager, Tracking Manager, SLA Monitor, Incident Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных (создание, планирование, начало, отслеживание, завершение, обработка инцидентов)
      - Определена структура БД (transport_shipments, transport_routes, transport_incidents, transport_tracking, transport_sla_metrics)
      - Описаны интеграции с другими сервисами (economy-service, inventory-service, insurance-service, world-service, economy-events, notification-service)
      - Определены Event Bus события (published и subscribed)
      - Создано техническое задание
      - Разбито на подзадачи

