metadata:
  id: economy-production-chains-system-architecture
  title: Архитектура системы производственных цепочек
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T15:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - production
    - crafting
    - manufacturing
  related_systems:
    - economy-service
    - crafting-service
    - guild-service
    - inventory-service
  related_documents:
    - id: mechanics-economy-production-chains
      relation: extends
    - id: game-mechanics-systems-architecture
      relation: extends
  github_issue: 232
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы производственных цепочек для управления
    производством от добычи сырья до крафта легендарных предметов с учётом этапов, инвестиций,
    рисков, массового производства и ускорителей.
  goal: |
    Создать архитектурную схему системы производственных цепочек с определением:
    - Микросервисов для управления производством
    - Компонентов для цепочек, станций, лицензий, ускорителей
    - API endpoints (высокоуровнево)
    - Интеграций с другими системами
    - Структуры БД для хранения цепочек и производства
    - Технического задания для реализации
  essence: |
    Система производственных цепочек управляет многоэтапным производством предметов,
    поддерживает массовое производство, ускорители, rush-заказы и легендарный крафт,
    интегрируется с crafting-service, guild-service и economy-service.

architecture:
  overview: |
    Система производственных цепочек состоит из следующих компонентов:
    1. Production Chain Manager - управление производственными цепочками
    2. Production Stage Manager - управление этапами производства
    3. Station Manager - управление производственными станциями
    4. License Manager - управление лицензиями на производство
    5. Resource Manager - управление ресурсами для производства
    6. Bulk Production Manager - управление массовым производством
    7. Accelerator Manager - управление ускорителями и rush-заказами
    8. Legendary Craft Manager - управление легендарным крафтом
    9. Production Analytics Collector - сбор аналитики по производству

  microservices:
    - name: production-service
      location: services/production-service
      responsibility: |
        Основной сервис для управления производственными цепочками:
        - CRUD операции с цепочками
        - Управление этапами производства
        - Управление станциями и лицензиями
        - Массовое производство
        - Интеграция с crafting-service
      components:
        - Production Chain Manager
        - Production Stage Manager
        - Station Manager
        - License Manager
        - Resource Manager
        - Bulk Production Manager
        - Accelerator Manager
        - Legendary Craft Manager
      endpoints:
        - GET /api/v1/production/chains - список производственных цепочек
        - GET /api/v1/production/chains/{id} - детали цепочки
        - POST /api/v1/production/chains/{id}/start - запуск производства
        - GET /api/v1/production/orders/{id} - детали заказа на производство
        - POST /api/v1/production/orders - создание заказа
        - DELETE /api/v1/production/orders/{id} - отмена заказа
        - POST /api/v1/production/orders/{id}/rush - rush-заказ
        - POST /api/v1/production/bulk - массовое производство
        - GET /api/v1/production/stations - список станций игрока
        - GET /api/v1/production/stations/{id} - детали станции
        - POST /api/v1/production/stations/{id}/upgrade - улучшение станции
        - GET /api/v1/production/licenses - список лицензий игрока
        - POST /api/v1/production/licenses/{id}/purchase - покупка лицензии
        - GET /api/v1/production/accelerators - доступные ускорители
        - POST /api/v1/production/orders/{id}/accelerator - применение ускорителя
        - GET /api/v1/production/legendary/quests - квесты для легендарного крафта
        - POST /api/v1/production/legendary/craft - запуск легендарного крафта

    - name: crafting-service
      location: services/crafting-service
      responsibility: |
        Интеграция с системой крафта:
        - Выполнение этапов крафта
        - Управление рецептами
        - Обработка результатов крафта
      components:
        - Crafting Integration Manager
      endpoints:
        - POST /api/v1/crafting/execute - выполнение крафта
        - GET /api/v1/crafting/recipes/{id} - детали рецепта

    - name: guild-service
      location: services/guild-service
      responsibility: |
        Интеграция с гильдиями:
        - Гильдийное производство
        - Распределение ролей (добытчики, переработчики, крафтеры)
        - Кооперативное производство
      components:
        - Guild Production Manager
      endpoints:
        - GET /api/v1/guilds/{id}/production - производство гильдии
        - POST /api/v1/guilds/{id}/production/assign - назначение ролей

  components:
    - name: Production Chain Manager
      location: production-service
      responsibility: |
        Управление производственными цепочками:
        - Создание и управление цепочками
        - Определение этапов производства
        - Валидация цепочек
        - Интеграция с рецептами
      methods:
        - getChains(itemTier, itemType)
        - getChainDetails(chainId)
        - validateChain(chainId, playerId)
        - calculateChainCost(chainId, quantity)

    - name: Production Stage Manager
      location: production-service
      responsibility: |
        Управление этапами производства:
        - Выполнение этапов (добыча сырья, переработка, крафт)
        - Переходы между этапами
        - Валидация ресурсов для этапа
        - Обработка результатов этапа
      methods:
        - executeStage(orderId, stageId)
        - validateStageResources(stageId, resources)
        - processStageResult(stageId, result)
        - transitionToNextStage(orderId)

    - name: Station Manager
      location: production-service
      responsibility: |
        Управление производственными станциями:
        - Управление станциями игрока
        - Улучшение станций
        - Проверка доступности станций
        - Резервирование станций
      methods:
        - getStations(playerId)
        - getStationDetails(stationId)
        - upgradeStation(stationId, upgradeType)
        - reserveStation(stationId, orderId)
        - releaseStation(stationId, orderId)

    - name: License Manager
      location: production-service
      responsibility: |
        Управление лицензиями на производство:
        - Каталог лицензий
        - Покупка лицензий
        - Проверка наличия лицензий
        - Управление сроками действия лицензий
      methods:
        - getLicenses(itemTier, itemType)
        - purchaseLicense(playerId, licenseId)
        - checkLicense(playerId, licenseId)
        - renewLicense(licenseId)

    - name: Resource Manager
      location: production-service
      responsibility: |
        Управление ресурсами для производства:
        - Проверка наличия ресурсов
        - Резервирование ресурсов
        - Расход ресурсов
        - Интеграция с inventory-service
      methods:
        - checkResources(playerId, resources)
        - reserveResources(playerId, resources, orderId)
        - consumeResources(orderId, resources)
        - releaseResources(orderId, resources)

    - name: Bulk Production Manager
      location: production-service
      responsibility: |
        Управление массовым производством:
        - Создание массовых заказов
        - Оптимизация времени и ресурсов
        - Управление производственными площадками
        - Сборочные линии
      methods:
        - createBulkOrder(playerId, itemId, quantity)
        - optimizeBulkProduction(orderId)
        - getProductionLines(playerId)
        - assignToProductionLine(orderId, lineId)

    - name: Accelerator Manager
      location: production-service
      responsibility: |
        Управление ускорителями и rush-заказами:
        - Применение ускорителей (Efficiency Catalyst, Quality Enhancer, Material Optimizer)
        - Создание rush-заказов
        - Расчёт стоимости ускорения
        - Управление эффектами ускорителей
      methods:
        - getAccelerators()
        - applyAccelerator(orderId, acceleratorId)
        - createRushOrder(orderId, rushOptions)
        - calculateRushCost(orderId, timeReduction)
        - getAcceleratorEffects(orderId)

    - name: Legendary Craft Manager
      location: production-service
      responsibility: |
        Управление легендарным крафтом:
        - Квестовые цепочки для легендарных предметов
        - Проверка требований (чертежи, мастерство, компоненты)
        - Доступ к легендарным кузням
        - Обработка высоких рисков провала
      methods:
        - getLegendaryQuests(itemId)
        - checkLegendaryRequirements(playerId, itemId)
        - startLegendaryCraft(playerId, itemId, questChainId)
        - processLegendaryResult(craftId, success)

    - name: Production Analytics Collector
      location: analytics-service
      responsibility: |
        Сбор аналитики по производству:
        - Сбор метрик производства
        - Анализ прибыльности
        - Отчёты по производству
        - Интеграция с analytics-service
      methods:
        - collectProductionMetrics(playerId, timeRange)
        - analyzeProfitability(chainId, timeRange)
        - generateProductionReport(playerId, timeRange)

  data_flow:
    production_start: |
      1. Игрок выбирает производственную цепочку через Production Chain Manager
      2. Production Chain Manager валидирует цепочку и проверяет лицензии
      3. License Manager проверяет наличие необходимых лицензий
      4. Resource Manager проверяет наличие ресурсов
      5. Station Manager резервирует станцию
      6. Создаётся заказ на производство со статусом PENDING
      7. Событие публикуется в Event Bus (production.order.created)

    production_execution: |
      1. Production Stage Manager начинает выполнение первого этапа
      2. Resource Manager резервирует ресурсы для этапа
      3. Выполняется этап (добыча сырья, переработка, крафт)
      4. Обрабатывается результат этапа (успех/провал)
      5. При успехе: переход к следующему этапу
      6. При провале: обработка провала (потеря ресурсов, возможность повтора)
      7. Событие публикуется в Event Bus (production.stage.completed, production.stage.failed)

    production_completion: |
      1. Все этапы выполнены успешно
      2. Production Stage Manager завершает производство
      3. Resource Manager освобождает неиспользованные ресурсы
      4. Station Manager освобождает станцию
      5. Inventory Service получает готовый предмет
      6. Заказ переводится в статус COMPLETED
      7. Production Analytics Collector обновляет метрики
      8. Событие публикуется в Event Bus (production.order.completed)

    bulk_production: |
      1. Игрок создаёт массовый заказ через Bulk Production Manager
      2. Bulk Production Manager оптимизирует производство (экономия времени и ресурсов)
      3. Заказ распределяется по производственным линиям
      4. Параллельное выполнение этапов на разных линиях
      5. Сбор результатов и передача в inventory-service
      6. Событие публикуется в Event Bus (production.bulk.completed)

    rush_order: |
      1. Игрок создаёт rush-заказ через Accelerator Manager
      2. Accelerator Manager рассчитывает стоимость ускорения
      3. Игрок подтверждает rush-заказ (увеличение стоимости)
      4. Время производства сокращается
      5. Заказ выполняется с ускорением
      6. Событие публикуется в Event Bus (production.order.rushed)

    legendary_craft: |
      1. Игрок начинает квестовую цепочку для легендарного предмета
      2. Legendary Craft Manager проверяет требования (чертежи, мастерство, компоненты)
      3. Игрок выполняет квестовые этапы
      4. При выполнении всех требований: доступ к легендарной кузне
      5. Запускается производство с высоким риском провала
      6. Обрабатывается результат (успех/провал)
      7. Событие публикуется в Event Bus (production.legendary.crafted, production.legendary.failed)

  integrations:
    with_crafting_service: |
      - Выполнение этапов крафта
      - Получение рецептов
      - Обработка результатов крафта

    with_guild_service: |
      - Гильдийное производство
      - Распределение ролей
      - Кооперативное производство

    with_inventory_service: |
      - Проверка наличия ресурсов
      - Резервирование ресурсов
      - Получение готовых предметов

    with_economy_service: |
      - Расчёт стоимости производства
      - Расчёт прибыльности
      - Интеграция с экономическими событиями

    with_quest_service: |
      - Квестовые цепочки для легендарных предметов
      - Интеграция с квестами производства

  event_bus_events:
    published:
      - production.order.created
      - production.order.started
      - production.stage.started
      - production.stage.completed
      - production.stage.failed
      - production.order.completed
      - production.order.failed
      - production.order.cancelled
      - production.bulk.created
      - production.bulk.completed
      - production.order.rushed
      - production.accelerator.applied
      - production.legendary.quest.started
      - production.legendary.crafted
      - production.legendary.failed
    subscribed:
      - economy.event.active (для влияния на стоимость производства)
      - inventory.resource.updated (для проверки ресурсов)

  database_schema:
    tables:
      - name: production_chains
        description: Производственные цепочки
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - description: TEXT
          - item_tier: INTEGER (1-5)
          - item_type: VARCHAR(50) (weapon, cyberdeck, consumable, mod, etc.)
          - stages: JSONB (массив этапов цепочки)
          - base_cost: DECIMAL(10,2)
          - base_time_minutes: INTEGER
          - base_success_rate: DECIMAL(5,2) (0.00-100.00)
          - required_licenses: UUID[] (FK production_licenses)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - item_tier, item_type
          - name

      - name: production_orders
        description: Заказы на производство
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - chain_id: UUID (FK production_chains)
          - guild_id: UUID (FK guilds, nullable)
          - quantity: INTEGER
          - status: ENUM (pending, started, in_progress, completed, failed, cancelled)
          - current_stage: INTEGER
          - total_stages: INTEGER
          - total_cost: DECIMAL(10,2)
          - actual_cost: DECIMAL(10,2)
          - estimated_time_minutes: INTEGER
          - actual_time_minutes: INTEGER (nullable)
          - success_rate: DECIMAL(5,2)
          - is_rush: BOOLEAN
          - rush_cost_multiplier: DECIMAL(3,2) (nullable)
          - is_bulk: BOOLEAN
          - bulk_efficiency: DECIMAL(5,2) (nullable)
          - station_id: UUID (FK production_stations, nullable)
