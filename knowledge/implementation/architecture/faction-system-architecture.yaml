# Issue: #1442

architecture:
  name: "Faction System Architecture"
  version: "1.0.0"
  description: "Многослойная система фракций для обобщения коопераций игроков"
  
core_components:
  - name: "Faction Core Service"
    description: "Управление фракциями, создание, настройка, иерархия"
    responsibilities:
      - Создание и регистрация фракций
      - Управление структурой фракции
      - Иерархия внутри фракции
      - Распределение ролей и полномочий
    technologies:
      - Go microservice
      - PostgreSQL для хранения
      - gRPC для внутренних коммуникаций
      - REST API для клиентов
    
  - name: "Faction Membership Service"
    description: "Управление членством в фракциях"
    responsibilities:
      - Объединение кланов в фракции
      - Управление членами фракций
      - Права и обязанности членов
      - Ранги и роли
    technologies:
      - Go microservice
      - PostgreSQL
      - Redis для кэширования активных членов
    
  - name: "Faction Niche Service"
    description: "Управление нишами и специализацией фракций"
    responsibilities:
      - Каталог доступных ниш
      - Захват и контроль ниш
      - Защита ниш от конкурентов
      - Уникальные способности фракций
    technologies:
      - Go microservice
      - PostgreSQL для ниш
      - Event sourcing для истории контроля
    
  - name: "Faction Relations Service"
    description: "Управление отношениями между фракциями"
    responsibilities:
      - Типы отношений (союз, нейтрал, вражда)
      - Дипломатия и договоры
      - Конфликты и войны
      - История взаимодействий
    technologies:
      - Go microservice
      - PostgreSQL для отношений
      - Graph DB (Neo4j) для сети отношений
    
  - name: "Faction Conflict Service"
    description: "Управление фракционными конфликтами"
    responsibilities:
      - Объявление войн
      - Боевые действия
      - Экономические санкции
      - Разрешение конфликтов
    technologies:
      - Go microservice
      - PostgreSQL
      - Event sourcing для истории конфликтов
    
  - name: "Faction Analytics Service"
    description: "Аналитика фракций и их активности"
    responsibilities:
      - Статистика фракций
      - Метрики влияния
      - Рейтинги фракций
      - Прогнозирование событий
    technologies:
      - Go microservice
      - ClickHouse для аналитики
      - Prometheus metrics

microservices:
  - name: "faction-core-service"
    port: 8091
    endpoints:
      - "POST /api/v1/factions/create"
      - "GET /api/v1/factions/{id}"
      - "PUT /api/v1/factions/{id}"
      - "DELETE /api/v1/factions/{id}"
      - "GET /api/v1/factions/list"
      - "POST /api/v1/factions/{id}/hierarchy/update"
    
  - name: "faction-membership-service"
    port: 8092
    endpoints:
      - "POST /api/v1/factions/{id}/members/add-clan"
      - "DELETE /api/v1/factions/{id}/members/remove-clan/{clan_id}"
      - "GET /api/v1/factions/{id}/members/list"
      - "PUT /api/v1/factions/{id}/members/{member_id}/rank"
      - "GET /api/v1/players/{player_id}/factions"
    
  - name: "faction-niche-service"
    port: 8093
    endpoints:
      - "GET /api/v1/niches/catalog"
      - "POST /api/v1/factions/{id}/niches/claim"
      - "DELETE /api/v1/factions/{id}/niches/abandon/{niche_id}"
      - "GET /api/v1/factions/{id}/niches/list"
      - "POST /api/v1/niches/{niche_id}/contest"
    
  - name: "faction-relations-service"
    port: 8094
    endpoints:
      - "GET /api/v1/factions/{id}/relations"
      - "PUT /api/v1/factions/{id}/relations/{target_id}"
      - "POST /api/v1/factions/{id}/diplomacy/treaty"
      - "GET /api/v1/factions/{id}/relations/graph"
    
  - name: "faction-conflict-service"
    port: 8095
    endpoints:
      - "POST /api/v1/factions/{id}/conflicts/declare-war"
      - "GET /api/v1/conflicts/active"
      - "POST /api/v1/conflicts/{id}/battle/report"
      - "POST /api/v1/conflicts/{id}/resolve"
      - "GET /api/v1/factions/{id}/conflicts/history"

database_schema:
  tables:
    - name: "factions"
      columns:
        - "id UUID PRIMARY KEY"
        - "name VARCHAR(100) NOT NULL"
        - "type VARCHAR(50) NOT NULL" # criminal_gang, professional_guild, political_movement, corporate_alliance, religious_sect, scientific_org
        - "ideology TEXT"
        - "created_at TIMESTAMP"
        - "updated_at TIMESTAMP"
        - "leader_clan_id UUID"
        - "status VARCHAR(50)" # active, disbanded, suspended
    
    - name: "faction_hierarchy"
      columns:
        - "id UUID PRIMARY KEY"
        - "faction_id UUID REFERENCES factions(id)"
        - "role VARCHAR(100)" # leader, officer, member
        - "clan_id UUID"
        - "permissions JSONB"
        - "appointed_at TIMESTAMP"
    
    - name: "faction_niches"
      columns:
        - "id UUID PRIMARY KEY"
        - "name VARCHAR(100) NOT NULL"
        - "type VARCHAR(50)" # territorial, economic, political, criminal, technological, social
        - "description TEXT"
        - "benefits JSONB"
        - "requirements JSONB"
    
    - name: "faction_niche_control"
      columns:
        - "id UUID PRIMARY KEY"
        - "faction_id UUID REFERENCES factions(id)"
        - "niche_id UUID REFERENCES faction_niches(id)"
        - "controlled_since TIMESTAMP"
        - "control_strength FLOAT" # 0.0 - 1.0
        - "contested BOOLEAN DEFAULT false"
    
    - name: "faction_relations"
      columns:
        - "id UUID PRIMARY KEY"
        - "faction_id UUID REFERENCES factions(id)"
        - "target_faction_id UUID REFERENCES factions(id)"
        - "relation_type VARCHAR(50)" # allied, neutral, competitive, hostile, trading
        - "relation_value INT" # -100 to +100
        - "updated_at TIMESTAMP"
    
    - name: "faction_conflicts"
      columns:
        - "id UUID PRIMARY KEY"
        - "attacker_faction_id UUID REFERENCES factions(id)"
        - "defender_faction_id UUID REFERENCES factions(id)"
        - "conflict_type VARCHAR(50)" # territorial, economic, political, ideological, resource
        - "status VARCHAR(50)" # active, resolved, ongoing
        - "started_at TIMESTAMP"
        - "ended_at TIMESTAMP"
        - "winner_faction_id UUID"

integrations:
  - service: "clan-service"
    purpose: "Кланы как базовые единицы фракций"
    interaction: "Кланы объединяются в фракции, фракции управляют кланами"
  
  - service: "corporation-service"
    purpose: "Корпоративные фракции"
    interaction: "Корпорации могут создавать или вступать в фракции"
  
  - service: "political-service"
    purpose: "Политические фракции"
    interaction: "Политические структуры как тип фракций"
  
  - service: "economy-service"
    purpose: "Экономические механики фракций"
    interaction: "Фракции участвуют в экономике через ниши"
  
  - service: "world-service"
    purpose: "Влияние фракций на мир"
    interaction: "Фракции контролируют территории и влияют на события"
  
  - service: "combat-service"
    purpose: "Боевые действия между фракциями"
    interaction: "Фракционные конфликты через PvP и PvE"

events:
  - "FactionCreated"
  - "FactionDisbanded"
  - "ClanJoinedFaction"
  - "ClanLeftFaction"
  - "NicheClaimed"
  - "NicheAbandoned"
  - "NicheContested"
  - "RelationChanged"
  - "WarDeclared"
  - "ConflictResolved"

data_synchronization:
  pattern: "Event Sourcing + CQRS"
  description: "События фракций сохраняются в event store, проекции для быстрых запросов"
  event_store: "PostgreSQL"
  projections:
    - "FactionState - текущее состояние фракции"
    - "FactionMembershipView - список членов"
    - "FactionNicheView - контролируемые ниши"
    - "FactionRelationsGraph - граф отношений"

scalability:
  sharding_strategy: "По континентам и регионам"
  caching: "Redis для активных фракций и отношений"
  read_replicas: "Для аналитики и отчетов"

security:
  authentication: "JWT tokens через auth-service"
  authorization: "RBAC по ролям в фракции"
  rate_limiting: "100 requests/minute для faction operations"

monitoring:
  metrics:
    - "faction_count" - количество активных фракций
    - "faction_membership" - членство в фракциях
    - "niche_control_distribution" - распределение ниш
    - "conflict_count" - активные конфликты
  alerts:
    - "Массовое создание фракций (>10/minute)"
    - "Критический конфликт (>1000 игроков вовлечено)"

next_steps:
  - "Передача Database Engineer для проектирования БД схемы"
  - "Передача API Designer для создания OpenAPI спецификаций"
  - "Интеграция с clan-service и corporation-service"

related_issues:
  - "#1433 - Иерархия коопераций"
  - "#1435 - Система корпораций"
  - "#1437 - Система политики"
