metadata:
  id: game-mechanics-systems-architecture
  title: Архитектура систем игровых механик
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T13:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - mechanics
    - gameplay
    - combat
    - economy
    - social
    - progression
    - world
  related_systems:
    - gameplay-service
    - economy-service
    - social-service
    - world-service
    - progression-service
    - character-service
    - narrative-service
  related_documents:
    - id: mechanics-overview
      relation: implements
    - id: combat-overview
      relation: implements
    - id: economy-overview
      relation: implements
    - id: social-mechanics-overview
      relation: implements
    - id: progression-attributes
      relation: implements
  github_issue: 104
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру систем игровых механик, охватывающую:
    - Combat (50+ документов) - боевая система, стрельба, стелс, паркур, способности, импланты
    - Economy (60+ документов) - торговля, крафт, валюты, рынки, биржа, аукционы
    - Social (56 документов) - отношения с NPC, найм, заказы, наставничество, репутация
    - Progression (12 документов) - атрибуты, навыки, перки, классы, перерождение
    - World (25+ документов) - события, рейды, боссы, состояние мира
    - Meta - система лиг
  goal: |
    Создать архитектурную схему систем механик с определением:
    - Микросервисов для обработки механик
    - Компонентов для каждой подсистемы
    - Интеграций между системами
    - API endpoints (высокоуровнево)
    - Структуры БД для хранения данных механик
    - Технического задания для реализации
  essence: |
    Объединенная архитектура всех игровых механик с распределением по микросервисам
    и четкими интеграциями между системами.

architecture:
  overview: |
    Системы механик распределены по следующим микросервисам:
    1. gameplay-service (8083) - боевые системы, прогрессия, PvP, матчмейкинг
    2. economy-service (8085) - инвентарь, торговля, крафт, генерация лута
    3. social-service (8084) - гильдии, отношения с NPC, соцсети, коммуникации
    4. world-service (8086) - мировые события, рейды, управление территориями
    5. progression-service - прогрессия персонажа, атрибуты, навыки, перки

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка боевых механик и игрового процесса:
        - Боевая система (стрельба, стелс, паркур, способности)
        - Импланты и киберпсихоз
        - PvP/PvE баланс
        - Экстракт-механики
        - Арена и лутинг
        - Интеграция с progression-service
      components:
        - combat-engine: обработка боевых действий
        - ability-system: система способностей
        - implant-manager: управление имплантами
        - stealth-system: стелс механики
        - freerun-system: паркур и мобильность
        - extract-zone-manager: управление экстракт-зонами
        - arena-manager: управление аренами
        - loot-generator: генерация лута в бою
      endpoints:
        - POST /api/v1/gameplay/combat/attack - атака
        - POST /api/v1/gameplay/combat/ability - использование способности
        - POST /api/v1/gameplay/combat/stealth - стелс действие
        - POST /api/v1/gameplay/combat/freerun - паркур действие
        - POST /api/v1/gameplay/extract/enter - вход в экстракт-зону
        - POST /api/v1/gameplay/extract/extract - экстракция
        - GET /api/v1/gameplay/combat/loadout - текущий лоадаут
        - POST /api/v1/gameplay/combat/loadout - изменение лоадаута
        - GET /api/v1/gameplay/implants/list - список имплантов
        - POST /api/v1/gameplay/implants/install - установка импланта
        - POST /api/v1/gameplay/implants/remove - удаление импланта
        - GET /api/v1/gameplay/arena/list - список арен
        - POST /api/v1/gameplay/arena/join - присоединение к арене

    - name: economy-service
      port: 8085
      responsibility: |
        Экономические механики:
        - Торговля (игроковый рынок, аукционы, биржа)
        - Крафт и производство
        - Валюты и ресурсы
        - Инвентарь
        - Торговые маршруты
        - Инвестиции и аналитика
      components:
        - trading-engine: обработка торговли
        - crafting-system: система крафта
        - inventory-manager: управление инвентарем
        - currency-manager: управление валютами
        - market-manager: управление рынками
        - auction-house: аукционный дом
        - stock-exchange: биржа
        - production-chains: производственные цепочки
        - resource-manager: управление ресурсами
      endpoints:
        - GET /api/v1/economy/inventory - инвентарь игрока
        - POST /api/v1/economy/inventory/move - перемещение предмета
        - POST /api/v1/economy/trading/sell - продажа предмета
        - POST /api/v1/economy/trading/buy - покупка предмета
        - GET /api/v1/economy/market/listings - список предложений
        - POST /api/v1/economy/market/create-listing - создание предложения
        - POST /api/v1/economy/crafting/craft - создание предмета
        - GET /api/v1/economy/crafting/recipes - доступные рецепты
        - GET /api/v1/economy/auction/list - список аукционов
        - POST /api/v1/economy/auction/bid - ставка на аукционе
        - GET /api/v1/economy/stock/list - список акций
        - POST /api/v1/economy/stock/buy - покупка акций
        - POST /api/v1/economy/stock/sell - продажа акций
        - GET /api/v1/economy/currencies - валюты игрока
        - POST /api/v1/economy/currencies/exchange - обмен валют

    - name: social-service
      port: 8084
      responsibility: |
        Социальные механики:
        - Отношения с NPC
        - Найм NPC
        - Заказы от игроков
        - Наставничество
        - Репутация
        - Гильдии и кланы
        - Семейные отношения
      components:
        - relationship-manager: управление отношениями
        - npc-hiring-system: система найма NPC
        - player-orders-system: система заказов игроков
        - mentorship-system: система наставничества
        - reputation-manager: управление репутацией
        - guild-manager: управление гильдиями
        - family-system: семейные отношения
        - notification-system: система уведомлений
      endpoints:
        - GET /api/v1/social/relationships - отношения игрока
        - POST /api/v1/social/relationships/interact - взаимодействие с NPC
        - GET /api/v1/social/npc-hiring/available - доступные NPC
        - POST /api/v1/social/npc-hiring/hire - найм NPC
        - GET /api/v1/social/orders/list - список заказов
        - POST /api/v1/social/orders/create - создание заказа
        - POST /api/v1/social/orders/accept - принятие заказа
        - GET /api/v1/social/mentorship/mentors - наставники
        - POST /api/v1/social/mentorship/request - запрос наставничества
        - GET /api/v1/social/reputation/list - репутация игрока
        - GET /api/v1/social/guilds/list - список гильдий
        - POST /api/v1/social/guilds/create - создание гильдии
        - POST /api/v1/social/guilds/join - присоединение к гильдии

    - name: world-service
      port: 8086
      responsibility: |
        Мировые механики:
        - Мировые события
        - Рейды
        - Боссы
        - Управление территориями
        - Синхронизация состояния мира
        - Данжи
      components:
        - event-manager: управление событиями
        - raid-manager: управление рейдами
        - boss-manager: управление боссами
        - territory-manager: управление территориями
        - world-state-sync: синхронизация состояния мира
        - dungeon-manager: управление данжами
      endpoints:
        - GET /api/v1/world/events/active - активные события
        - GET /api/v1/world/events/{eventId} - информация о событии
        - POST /api/v1/world/events/{eventId}/participate - участие в событии
        - GET /api/v1/world/raids/list - список рейдов
        - POST /api/v1/world/raids/{raidId}/join - присоединение к рейду
        - GET /api/v1/world/bosses/active - активные боссы
        - POST /api/v1/world/bosses/{bossId}/engage - начало боя с боссом
        - GET /api/v1/world/territories - территории
        - GET /api/v1/world/territories/{territoryId} - информация о территории
        - GET /api/v1/world/dungeons/list - список данжей
        - POST /api/v1/world/dungeons/{dungeonId}/enter - вход в данж

    - name: progression-service
      port: 8087
      responsibility: |
        Прогрессия персонажа:
        - Атрибуты и характеристики
        - Навыки
        - Перки
        - Классы
        - Перерождение
        - Опыт и уровни
      components:
        - attribute-manager: управление атрибутами
        - skill-manager: управление навыками
        - perk-manager: управление перками
        - class-manager: управление классами
        - xp-calculator: расчет опыта
        - rebirth-system: система перерождения
      endpoints:
        - GET /api/v1/progression/attributes - атрибуты персонажа
        - POST /api/v1/progression/attributes/allocate - распределение очков
        - GET /api/v1/progression/skills - навыки персонажа
        - POST /api/v1/progression/skills/train - тренировка навыка
        - GET /api/v1/progression/perks - доступные перки
        - POST /api/v1/progression/perks/unlock - открытие перка
        - GET /api/v1/progression/classes - классы
        - POST /api/v1/progression/classes/select - выбор класса
        - GET /api/v1/progression/xp - текущий опыт
        - POST /api/v1/progression/rebirth - перерождение

  data_flows:
    combat_flow: |
      1. Клиент отправляет действие (атака, способность)
      2. Gameplay Service обрабатывает действие через Combat Engine
      3. Combat Engine проверяет условия (выносливость, кулдауны)
      4. Combat Engine рассчитывает урон/эффект
      5. Combat Engine обновляет состояние боя
      6. Combat Engine публикует событие combat:action-executed
      7. Progression Service получает событие и обновляет опыт
      8. Economy Service получает событие и генерирует лут (если применимо)
      9. Realtime Gateway отправляет обновление клиентам

    trading_flow: |
      1. Игрок создает предложение на рынке
      2. Economy Service валидирует предложение
      3. Economy Service создает листинг в БД
      4. Economy Service публикует событие economy:listing-created
      5. Другие игроки видят предложение
      6. Игрок покупает предмет
      7. Economy Service проверяет наличие средств
      8. Economy Service переводит предмет и валюту
      9. Economy Service публикует событие economy:transaction-completed
      10. Social Service обновляет репутацию (если применимо)

    crafting_flow: |
      1. Игрок выбирает рецепт для крафта
      2. Economy Service проверяет наличие ресурсов
      3. Economy Service проверяет навыки игрока через Progression Service
      4. Economy Service рассчитывает шанс успеха
      5. Economy Service списывает ресурсы
      6. Economy Service генерирует предмет
      7. Economy Service добавляет предмет в инвентарь
      8. Progression Service обновляет опыт крафта
      9. Economy Service публикует событие economy:item-crafted

    npc_hiring_flow: |
      1. Игрок просматривает доступных NPC
      2. Social Service загружает список NPC с учетом репутации
      3. Игрок нанимает NPC
      4. Social Service проверяет требования (репутация, валюта)
      5. Social Service списывает валюту через Economy Service
      6. Social Service создает контракт найма
      7. Social Service публикует событие social:npc-hired
      8. NPC становится доступным для использования

    progression_flow: |
      1. Игрок выполняет действие (бой, крафт, квест)
      2. Соответствующий сервис публикует событие с опытом
      3. Progression Service получает событие
      4. Progression Service рассчитывает опыт для навыков
      5. Progression Service обновляет прогресс навыков
      6. Если навык повысился, Progression Service проверяет доступные перки
      7. Progression Service публикует событие progression:skill-leveled
      8. Realtime Gateway отправляет уведомление игроку

    world_event_flow: |
      1. World Service определяет начало события
      2. World Service загружает конфигурацию события
      3. World Service публикует событие world:event-started
      4. Игроки получают уведомление через Realtime Gateway
      5. Игроки присоединяются к событию
      6. World Service отслеживает прогресс события
      7. При завершении World Service рассчитывает награды
      8. World Service выдает награды через Economy Service
      9. World Service публикует событие world:event-completed

  database_structure:
    tables:
      - name: combat_sessions
        description: Боевые сессии
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - zone_id: UUID
          - session_type: ENUM (pve, pvp, arena, extract)
          - started_at: TIMESTAMP
          - ended_at: TIMESTAMP
          - stats: JSONB

      - name: player_loadouts
        description: Лоадауты игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - name: VARCHAR(255)
          - weapons: JSONB
          - abilities: JSONB
          - implants: JSONB
          - is_active: BOOLEAN
          - created_at: TIMESTAMP

      - name: installed_implants
        description: Установленные импланты
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - implant_type: VARCHAR(100)
          - implant_data: JSONB
          - installed_at: TIMESTAMP
          - cyberpsychosis_level: DECIMAL(3,2)

      - name: inventory_items
        description: Предметы в инвентаре
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - item_id: UUID
          - quantity: INTEGER
          - slot: INTEGER
          - properties: JSONB

      - name: market_listings
        description: Предложения на рынке
        columns:
          - id: UUID PRIMARY KEY
          - seller_id: UUID FOREIGN KEY
          - item_id: UUID
          - quantity: INTEGER
          - price: DECIMAL(18,2)
          - currency_type: VARCHAR(50)
          - created_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - status: ENUM (active, sold, expired, cancelled)

      - name: crafting_recipes
        description: Рецепты крафта
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - category: VARCHAR(100)
          - required_skills: JSONB
          - required_items: JSONB
          - result_item: UUID
          - result_quantity: INTEGER
          - success_chance: DECIMAL(3,2)

      - name: crafting_history
        description: История крафта
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - recipe_id: UUID FOREIGN KEY
          - success: BOOLEAN
          - crafted_at: TIMESTAMP

      - name: npc_relationships
        description: Отношения с NPC
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - npc_id: UUID
          - relationship_type: VARCHAR(100)
          - reputation_value: INTEGER
          - last_interaction: TIMESTAMP
          - relationship_data: JSONB

      - name: npc_contracts
        description: Контракты найма NPC
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - npc_id: UUID
          - contract_type: VARCHAR(100)
          - duration: INTEGER
          - cost: DECIMAL(18,2)
          - started_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - status: ENUM (active, completed, cancelled)

      - name: player_orders
        description: Заказы от игроков
        columns:
          - id: UUID PRIMARY KEY
          - creator_id: UUID FOREIGN KEY
          - executor_id: UUID FOREIGN KEY (nullable)
          - order_type: VARCHAR(100)
          - description: TEXT
          - reward: JSONB
          - requirements: JSONB
          - status: ENUM (open, accepted, in_progress, completed, cancelled)
          - created_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)

      - name: mentorship_relationships
        description: Отношения наставничества
        columns:
          - id: UUID PRIMARY KEY
          - mentor_id: UUID FOREIGN KEY
          - student_id: UUID FOREIGN KEY
          - started_at: TIMESTAMP
          - status: ENUM (active, completed, cancelled)

      - name: guilds
        description: Гильдии
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - leader_id: UUID FOREIGN KEY
          - description: TEXT
          - level: INTEGER
          - created_at: TIMESTAMP

      - name: guild_members
        description: Члены гильдий
        columns:
          - id: UUID PRIMARY KEY
          - guild_id: UUID FOREIGN KEY
          - player_id: UUID FOREIGN KEY
          - role: VARCHAR(100)
          - joined_at: TIMESTAMP

      - name: world_events
        description: Мировые события
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(100)
          - name: VARCHAR(255)
          - description: TEXT
          - start_time: TIMESTAMP
          - end_time: TIMESTAMP
          - status: ENUM (scheduled, active, completed, cancelled)
          - configuration: JSONB

      - name: world_event_participants
        description: Участники мировых событий
        columns:
          - id: UUID PRIMARY KEY
          - event_id: UUID FOREIGN KEY
          - player_id: UUID FOREIGN KEY
          - contribution: INTEGER
          - rewards_received: JSONB
          - joined_at: TIMESTAMP

      - name: raids
        description: Рейды
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - raid_type: VARCHAR(100)
          - difficulty: VARCHAR(50)
          - max_players: INTEGER
          - status: ENUM (open, in_progress, completed, failed)
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)

      - name: raid_participants
        description: Участники рейдов
        columns:
          - id: UUID PRIMARY KEY
          - raid_id: UUID FOREIGN KEY
          - player_id: UUID FOREIGN KEY
          - role: VARCHAR(100)
          - joined_at: TIMESTAMP

      - name: player_attributes
        description: Атрибуты игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - strength: INTEGER
          - reflexes: INTEGER
          - body: INTEGER
          - intelligence: INTEGER
          - tech: INTEGER
          - cool: INTEGER
          - will: INTEGER
          - agility: INTEGER
          - empathy: INTEGER
          - available_points: INTEGER

      - name: player_skills
        description: Навыки игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - skill_type: VARCHAR(100)
          - level: INTEGER
          - xp: INTEGER
          - max_level: INTEGER

      - name: player_perks
        description: Перки игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - perk_id: UUID
          - unlocked_at: TIMESTAMP

      - name: player_classes
        description: Классы игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID FOREIGN KEY
          - class_id: UUID
          - level: INTEGER
          - selected_at: TIMESTAMP

  integrations:
    character_service: |
      - Получение данных персонажа для проверок
      - Обновление прогресса персонажа
      - Проверка требований для действий

    economy_service: |
      - Выдача наград
      - Проверка наличия валюты
      - Генерация лута
      - Управление инвентарем

    social_service: |
      - Обновление репутации
      - Проверка отношений с NPC
      - Управление гильдиями

    world_service: |
      - Получение информации о событиях
      - Участие в рейдах
      - Управление территориями

    progression_service: |
      - Получение данных навыков
      - Обновление опыта
      - Проверка требований навыков

    narrative_service: |
      - Интеграция с квестами
      - Управление сюжетными линиями
      - Интеграция с лигами

    realtime_gateway: |
      - Отправка уведомлений
      - Реалтайм обновления состояния
      - Синхронизация боевых действий

technical_specification:
  subtasks:
    - id: gameplay-service-core
      title: Реализация основного функционала gameplay-service
      description: |
        Реализация базовой инфраструктуры gameplay-service с поддержкой боевых механик,
        способностей, имплантов и интеграции с другими сервисами.
      dependencies: []
      estimated_effort: 7 days

    - id: combat-engine
      title: Реализация боевого движка
      description: |
        Реализация Combat Engine с обработкой атак, способностей, стелса, паркура
        и интеграцией с progression-service.
      dependencies: [gameplay-service-core]
      estimated_effort: 5 days

    - id: economy-service-core
      title: Реализация основного функционала economy-service
      description: |
        Реализация базовой инфраструктуры economy-service с поддержкой торговли,
        крафта, инвентаря и валют.
      dependencies: []
      estimated_effort: 7 days

    - id: trading-system
      title: Реализация системы торговли
      description: |
        Реализация Trading Engine с поддержкой рынка, аукционов, биржи
        и интеграцией с inventory-manager.
      dependencies: [economy-service-core]
      estimated_effort: 5 days

    - id: crafting-system
      title: Реализация системы крафта
      description: |
        Реализация Crafting System с поддержкой рецептов, производственных цепочек
        и интеграцией с progression-service для проверки навыков.
      dependencies: [economy-service-core]
      estimated_effort: 4 days

    - id: social-service-core
      title: Реализация основного функционала social-service
      description: |
        Реализация базовой инфраструктуры social-service с поддержкой отношений,
        найма NPC, заказов и гильдий.
      dependencies: []
      estimated_effort: 6 days

    - id: npc-systems
      title: Реализация систем работы с NPC
      description: |
        Реализация Relationship Manager, NPC Hiring System и Player Orders System
        с интеграцией с economy-service и progression-service.
      dependencies: [social-service-core]
      estimated_effort: 5 days

    - id: world-service-core
      title: Реализация основного функционала world-service
      description: |
        Реализация базовой инфраструктуры world-service с поддержкой событий,
        рейдов, боссов и синхронизации состояния мира.
      dependencies: []
      estimated_effort: 6 days

    - id: progression-service-core
      title: Реализация основного функционала progression-service
      description: |
        Реализация базовой инфраструктуры progression-service с поддержкой атрибутов,
        навыков, перков и классов.
      dependencies: []
      estimated_effort: 5 days

    - id: database-schema
      title: Создание схемы БД для механик
      description: |
        Создание таблиц БД для всех систем механик с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> GameplayService[Gameplay Service]
        Gateway --> EconomyService[Economy Service]
        Gateway --> SocialService[Social Service]
        Gateway --> WorldService[World Service]
        Gateway --> ProgressionService[Progression Service]
        
        GameplayService --> CombatEngine[Combat Engine]
        GameplayService --> AbilitySystem[Ability System]
        GameplayService --> ImplantManager[Implant Manager]
        GameplayService --> StealthSystem[Stealth System]
        GameplayService --> FreerunSystem[Freerun System]
        
        EconomyService --> TradingEngine[Trading Engine]
        EconomyService --> CraftingSystem[Crafting System]
        EconomyService --> InventoryManager[Inventory Manager]
        EconomyService --> MarketManager[Market Manager]
        EconomyService --> AuctionHouse[Auction House]
        
        SocialService --> RelationshipManager[Relationship Manager]
        SocialService --> NPCHiringSystem[NPC Hiring System]
        SocialService --> PlayerOrdersSystem[Player Orders System]
        SocialService --> MentorshipSystem[Mentorship System]
        SocialService --> GuildManager[Guild Manager]
        
        WorldService --> EventManager[Event Manager]
        WorldService --> RaidManager[Raid Manager]
        WorldService --> BossManager[Boss Manager]
        WorldService --> TerritoryManager[Territory Manager]
        
        ProgressionService --> AttributeManager[Attribute Manager]
        ProgressionService --> SkillManager[Skill Manager]
        ProgressionService --> PerkManager[Perk Manager]
        ProgressionService --> ClassManager[Class Manager]
        
        GameplayService --> ProgressionService
        EconomyService --> ProgressionService
        SocialService --> EconomyService
        WorldService --> EconomyService
        WorldService --> GameplayService
        
        GameplayService --> CharacterService[Character Service]
        EconomyService --> CharacterService
        SocialService --> CharacterService
        WorldService --> CharacterService
        ProgressionService --> CharacterService
        
        GameplayService --> EventBus[Event Bus]
        EconomyService --> EventBus
        SocialService --> EventBus
        WorldService --> EventBus
        ProgressionService --> EventBus
        
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        GameplayService --> DB1[(Gameplay DB)]
        EconomyService --> DB2[(Economy DB)]
        SocialService --> DB3[(Social DB)]
        WorldService --> DB4[(World DB)]
        ProgressionService --> DB5[(Progression DB)]
    ```

  mechanics_interaction_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant GS as Gameplay Service
        participant ES as Economy Service
        participant SS as Social Service
        participant PS as Progression Service
        participant EB as Event Bus
        
        C->>GS: POST /combat/attack
        GS->>GS: Process combat action
        GS->>EB: Publish combat:action-executed
        GS-->>C: Combat result
        
        EB->>PS: combat:action-executed
        PS->>PS: Calculate XP
        PS->>PS: Update skills
        PS->>EB: Publish progression:skill-leveled
        
        EB->>ES: combat:enemy-killed
        ES->>ES: Generate loot
        ES->>ES: Add to inventory
        ES->>EB: Publish economy:loot-generated
        
        EB->>SS: combat:action-executed
        SS->>SS: Update reputation (if applicable)
        
        Note over C,EB: Player crafts item
        
        C->>ES: POST /crafting/craft
        ES->>PS: Check skills
        PS-->>ES: Skills data
        ES->>ES: Calculate success chance
        ES->>ES: Consume resources
        ES->>ES: Generate item
        ES->>EB: Publish economy:item-crafted
        ES-->>C: Craft result
        
        EB->>PS: economy:item-crafted
        PS->>PS: Update crafting XP
    ```

