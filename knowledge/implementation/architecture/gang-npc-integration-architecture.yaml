metadata:
  id: gang-npc-integration-architecture
  title: Архитектура интеграции NPC лидеров банд с системами уличной чести и клановых столкновений (на примере Хосе Рамиреса)
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T13:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - npc
    - gang
    - street-honor
    - clan-conflicts
    - integration
  related_systems:
    - gameplay-service-go
    - world-service-go
    - quest-engine
    - clan-war-system
  related_documents:
    - id: npc-integration-system-architecture
      relation: extends
    - id: npc-jose-tiger-ramirez
      relation: extends
    - id: clan-war-system-architecture
      relation: references
  github_issue: 25
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    NPC лидеры банд (такие как Хосе Рамирес из Valentinos) требуют специфической интеграции
    с системами уличной чести, клановых столкновений, защиты территории и кодекса чести,
    которые отличаются от корпоративных и общих NPC интеграций.
  goal: |
    Создать архитектурную схему интеграции NPC лидеров банд с игровыми системами:
    - Система уличной чести (street honor)
    - Клановые столкновения (PvP)
    - Защита территории
    - Кодекс чести и лояльность
    - Культурные события банд
    - API endpoints (высокоуровнево)
    - Техническое задание для реализации
  essence: |
    Архитектура интеграции NPC лидеров банд с системами уличной чести и клановых столкновений
    для обеспечения динамического контента банд и PvP конфликтов.

architecture:
  overview: |
    Система интеграции NPC лидеров банд расширяет общую архитектуру NPC интеграции
    следующими компонентами:
    1. Street Honor System - система уличной чести
    2. Gang Territory Manager - управление территорией банд
    3. Gang Clan Conflict Manager - управление клановыми столкновениями
    4. Gang Honor Code System - система кодекса чести
    5. Gang Cultural Events Manager - управление культурными событиями
    6. Gang Recruitment System - система вербовки в банды
    7. Gang Family System - семейная модель сообщества

  microservices:
    - name: street-honor-system
      location: gameplay-service-go (модуль street-honor)
      responsibility: |
        Система уличной чести:
        - Отслеживание уличной чести игроков
        - Управление уровнями чести
        - Влияние на доступность контента
        - Интеграция с репутацией банд
      honor_features:
        - Honor levels (уровни чести: dishonored, neutral, respected, honored, legendary)
        - Honor points (очки чести)
        - Honor decay (угасание чести при бездействии)
        - Honor events (события, влияющие на честь)
      endpoints:
        - GET /api/v1/gang/{gang_id}/honor/{player_id} - честь игрока
        - POST /api/v1/gang/{gang_id}/honor/{player_id}/update - обновление чести
        - GET /api/v1/gang/{gang_id}/honor/{player_id}/history - история чести
        - POST /api/v1/gang/{gang_id}/honor/{player_id}/event - событие чести

    - name: gang-territory-manager
      location: world-service-go (модуль gang-territory)
      responsibility: |
        Управление территорией банд:
        - Определение территорий банд
        - Управление контролем территории
        - Защита территории от врагов
        - Влияние на игровой мир
      territory_features:
        - Territory definition (определение территорий)
        - Territory control (контроль территории)
        - Territory defense (защита территории)
        - Territory influence (влияние на мир)
      endpoints:
        - GET /api/v1/gang/{gang_id}/territory - территория банды
        - GET /api/v1/gang/{gang_id}/territory/control - контроль территории
        - POST /api/v1/gang/{gang_id}/territory/defend - защита территории
        - GET /api/v1/gang/{gang_id}/territory/influence - влияние территории

    - name: gang-clan-conflict-manager
      location: gameplay-service-go (модуль gang-clan-conflicts)
      responsibility: |
        Управление клановыми столкновениями:
        - Инициация клановых столкновений
        - Координация PvP конфликтов между бандами
        - Управление результатами столкновений
        - Интеграция с системой клановых войн
      conflict_types:
        - Street Brawls (уличные драки)
        - Territory Disputes (территориальные споры)
        - Honor Duels (дуэли чести)
        - Gang Wars (войны банд)
      endpoints:
        - GET /api/v1/gang/{gang_id}/conflicts - активные конфликты
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/initiate - инициация конфликта
        - GET /api/v1/gang/{gang_id}/conflicts/{conflict_id}/status - статус конфликта
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/join - присоединение к конфликту
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/resolve - разрешение конфликта

    - name: gang-honor-code-system
      location: gameplay-service-go (модуль gang-honor-code)
      responsibility: |
        Система кодекса чести:
        - Управление кодексом чести банд
        - Проверка соблюдения кодекса
        - Последствия нарушения кодекса
        - Награды за соблюдение кодекса
      honor_code_features:
        - Code definition (определение кодекса)
        - Code compliance (соблюдение кодекса)
        - Code violations (нарушения кодекса)
        - Code rewards (награды за соблюдение)
      endpoints:
        - GET /api/v1/gang/{gang_id}/honor-code - кодекс чести банды
        - POST /api/v1/gang/{gang_id}/honor-code/check - проверка соблюдения
        - POST /api/v1/gang/{gang_id}/honor-code/violation - регистрация нарушения
        - GET /api/v1/gang/{gang_id}/honor-code/rewards - награды за соблюдение

    - name: gang-cultural-events-manager
      location: world-service-go (модуль gang-cultural-events)
      responsibility: |
        Управление культурными событиями банд:
        - Создание культурных событий
        - Координация участников событий
        - Управление наградами за события
        - Интеграция с Live Ops
      cultural_event_types:
        - Street Festivals (уличные фестивали)
        - Cultural Celebrations (культурные празднования)
        - Community Events (события сообщества)
        - Tradition Rituals (ритуалы традиций)
      endpoints:
        - GET /api/v1/gang/{gang_id}/cultural-events - культурные события
        - GET /api/v1/gang/{gang_id}/cultural-events/{event_id} - информация о событии
        - POST /api/v1/gang/{gang_id}/cultural-events/{event_id}/join - присоединение к событию
        - POST /api/v1/gang/{gang_id}/cultural-events/{event_id}/complete - завершение события

    - name: gang-recruitment-system
      location: gameplay-service-go (модуль gang-recruitment)
      responsibility: |
        Система вербовки в банды:
        - Создание программ вербовки
        - Управление кандидатами
        - Процесс инициации
        - Интеграция с кодексом чести
      recruitment_features:
        - Recruitment programs (программы вербовки)
        - Candidate tracking (отслеживание кандидатов)
        - Initiation process (процесс инициации)
        - Honor requirements (требования чести)
      endpoints:
        - GET /api/v1/gang/{gang_id}/recruitment/programs - программы вербовки
        - POST /api/v1/gang/{gang_id}/recruitment/programs/{program_id}/apply - подача заявки
        - GET /api/v1/gang/{gang_id}/recruitment/candidates/{player_id} - статус кандидата
        - POST /api/v1/gang/{gang_id}/recruitment/candidates/{player_id}/initiate - инициация кандидата

    - name: gang-family-system
      location: gameplay-service-go (модуль gang-family)
      responsibility: |
        Семейная модель сообщества:
        - Управление семейными связями в банде
        - Отслеживание отношений между членами
        - Управление семейными событиями
        - Интеграция с системой отношений
      family_features:
        - Family bonds (семейные связи)
        - Member relationships (отношения между членами)
        - Family events (семейные события)
        - Loyalty tracking (отслеживание лояльности)
      endpoints:
        - GET /api/v1/gang/{gang_id}/family/members - члены семьи банды
        - GET /api/v1/gang/{gang_id}/family/{player_id}/relationships - отношения игрока
        - POST /api/v1/gang/{gang_id}/family/{player_id}/bond - создание связи
        - GET /api/v1/gang/{gang_id}/family/events - семейные события

  data_flow:
    street_honor_flow: |
      1. Игрок взаимодействует с NPC Хосе Рамиресом
      2. Игрок выполняет действия, соответствующие кодексу чести
      3. Street Honor System увеличивает честь игрока
      4. Игрок получает доступ к новому контенту
      5. Игрок нарушает кодекс чести
      6. Gang Honor Code System регистрирует нарушение
      7. Street Honor System снижает честь игрока
      8. Доступ к контенту ограничивается

    territory_defense_flow: |
      1. Враги (Maelstrom) атакуют территорию Valentinos
      2. Gang Territory Manager детектирует атаку
      3. NPC Хосе Рамирес инициирует событие защиты
      4. Игроки получают уведомление о защите территории
      5. Игроки присоединяются к защите
      6. Gang Clan Conflict Manager координирует конфликт
      7. Игроки участвуют в PvP боях
      8. При успешной защите территория сохраняется
      9. Street Honor System награждает защитников

    clan_conflict_flow: |
      1. NPC Хосе Рамирес инициирует клановое столкновение
      2. Gang Clan Conflict Manager создаёт конфликт
      3. Игроки получают уведомление о конфликте
      4. Игроки присоединяются к стороне (Valentinos)
      5. Gang Clan Conflict Manager координирует PvP
      6. Игроки участвуют в уличных боях
      7. Gang Clan Conflict Manager отслеживает прогресс
      8. При завершении конфликта определяются результаты
      9. Street Honor System обновляет честь участников

    cultural_event_flow: |
      1. NPC Хосе Рамирес создаёт культурное событие
      2. Gang Cultural Events Manager публикует событие
      3. Игроки просматривают доступные события
      4. Игроки присоединяются к событию
      5. Gang Cultural Events Manager координирует участников
      6. Событие проходит (фестиваль, празднование)
      7. Gang Cultural Events Manager отслеживает прогресс
      8. При завершении события выдаются награды
      9. Street Honor System обновляет честь участников

  integrations:
    with_npc_integration_system: |
      - Использование NPC Quest Manager для квестов
      - Использование NPC Relationship Tracker для отношений
      - Использование NPC Dialogue System для диалогов
      - Использование NPC Event Trigger System для событий

    with_clan_war_system: |
      - Интеграция с системой клановых войн
      - Использование общих механизмов PvP
      - Координация больших конфликтов

    with_quest_engine: |
      - Создание квестов защиты территории
      - Интеграция с цепочками квестов
      - Управление наградами за квесты

    with_world_service: |
      - Управление территориальными событиями
      - Синхронизация состояния территорий
      - Интеграция с Live Ops

  database_schema:
    tables:
      - name: street_honor
        description: Уличная честь игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - gang_id: VARCHAR(50) (FK gangs)
          - honor_level: ENUM (dishonored, neutral, respected, honored, legendary)
          - honor_points: INTEGER (очки чести)
          - last_interaction: TIMESTAMP
          - violation_count: INTEGER (количество нарушений)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(player_id, gang_id)
        indexes:
          - player_id, gang_id
          - gang_id, honor_level

      - name: gang_territories
        description: Территории банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - territory_name: VARCHAR(255)
          - zone_id: UUID (FK zones)
          - control_level: INTEGER (уровень контроля, 0-100)
          - defense_status: ENUM (safe, threatened, under_attack)
          - last_attack: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, control_level
          - zone_id

      - name: gang_clan_conflicts
        description: Клановые столкновения банд
        fields:
          - id: UUID (PK)
          - initiator_gang: VARCHAR(50) (FK gangs)
          - target_gang: VARCHAR(50) (FK gangs)
          - conflict_type: ENUM (street_brawl, territory_dispute, honor_duel, gang_war)
          - status: ENUM (pending, active, resolved)
          - participants: UUID[] (array of player IDs)
          - outcome: JSONB (результат конфликта)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - initiator_gang, status
          - target_gang, status

      - name: gang_honor_code
        description: Кодекс чести банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - code_rules: JSONB (правила кодекса)
          - violation_penalties: JSONB (штрафы за нарушения)
          - compliance_rewards: JSONB (награды за соблюдение)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id

      - name: gang_honor_violations
        description: Нарушения кодекса чести
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - gang_id: VARCHAR(50) (FK gangs)
          - violation_type: VARCHAR(50)
          - violation_severity: ENUM (minor, moderate, major, severe)
          - penalty_applied: JSONB (применённый штраф)
          - created_at: TIMESTAMP
        indexes:
          - player_id, gang_id
          - gang_id, violation_severity

      - name: gang_cultural_events
        description: Культурные события банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - event_type: ENUM (street_festival, cultural_celebration, community_event, tradition_ritual)
          - title: VARCHAR(255)
          - description: TEXT
          - requirements: JSONB (требования для участия)
          - rewards: JSONB (награды за событие)
          - status: ENUM (pending, active, completed, cancelled)
          - participants: UUID[] (array of player IDs)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, status
          - event_type, status

      - name: gang_recruitment_programs
        description: Программы вербовки банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - program_name: VARCHAR(255)
          - requirements: JSONB (требования для участия)
          - honor_requirements: INTEGER (минимальная честь)
          - rewards: JSONB (награды за участие)
          - status: ENUM (active, closed, completed)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, status

      - name: gang_recruitment_candidates
        description: Кандидаты на вербовку в банды
        fields:
          - id: UUID (PK)
          - program_id: UUID (FK gang_recruitment_programs)
          - player_id: UUID (FK accounts)
          - status: ENUM (applied, reviewing, initiated, accepted, rejected)
          - application_data: JSONB (данные заявки)
          - honor_check: BOOLEAN (проверка чести пройдена)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(program_id, player_id)
        indexes:
          - program_id, status
          - player_id, status

      - name: gang_family_bonds
        description: Семейные связи в бандах
