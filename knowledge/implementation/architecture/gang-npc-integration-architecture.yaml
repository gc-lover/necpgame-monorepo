metadata:
  id: gang-npc-integration-architecture
  title: Архитектура интеграции NPC лидеров банд с системами уличной чести и клановых столкновений (на примере Хосе Рамиреса)
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T13:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - npc
    - gang
    - street-honor
    - clan-conflicts
    - integration
  related_systems:
    - gameplay-service-go
    - world-service-go
    - quest-engine
    - clan-war-system
  related_documents:
    - id: npc-integration-system-architecture
      relation: extends
    - id: npc-jose-tiger-ramirez
      relation: extends
    - id: clan-war-system-architecture
      relation: references
  github_issue: 25
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    NPC лидеры банд (такие как Хосе Рамирес из Valentinos) требуют специфической интеграции
    с системами уличной чести, клановых столкновений, защиты территории и кодекса чести,
    которые отличаются от корпоративных и общих NPC интеграций.
  goal: |
    Создать архитектурную схему интеграции NPC лидеров банд с игровыми системами:
    - Система уличной чести (street honor)
    - Клановые столкновения (PvP)
    - Защита территории
    - Кодекс чести и лояльность
    - Культурные события банд
    - API endpoints (высокоуровнево)
    - Техническое задание для реализации
  essence: |
    Архитектура интеграции NPC лидеров банд с системами уличной чести и клановых столкновений
    для обеспечения динамического контента банд и PvP конфликтов.

architecture:
  overview: |
    Система интеграции NPC лидеров банд расширяет общую архитектуру NPC интеграции
    следующими компонентами:
    1. Street Honor System - система уличной чести
    2. Gang Territory Manager - управление территорией банд
    3. Gang Clan Conflict Manager - управление клановыми столкновениями
    4. Gang Honor Code System - система кодекса чести
    5. Gang Cultural Events Manager - управление культурными событиями
    6. Gang Recruitment System - система вербовки в банды
    7. Gang Family System - семейная модель сообщества

  microservices:
    - name: street-honor-system
      location: gameplay-service-go (модуль street-honor)
      responsibility: |
        Система уличной чести:
        - Отслеживание уличной чести игроков
        - Управление уровнями чести
        - Влияние на доступность контента
        - Интеграция с репутацией банд
      honor_features:
        - Honor levels (уровни чести: dishonored, neutral, respected, honored, legendary)
        - Honor points (очки чести)
        - Honor decay (угасание чести при бездействии)
        - Honor events (события, влияющие на честь)
      endpoints:
        - GET /api/v1/gang/{gang_id}/honor/{player_id} - честь игрока
        - POST /api/v1/gang/{gang_id}/honor/{player_id}/update - обновление чести
        - GET /api/v1/gang/{gang_id}/honor/{player_id}/history - история чести
        - POST /api/v1/gang/{gang_id}/honor/{player_id}/event - событие чести

    - name: gang-territory-manager
      location: world-service-go (модуль gang-territory)
      responsibility: |
        Управление территорией банд:
        - Определение территорий банд
        - Управление контролем территории
        - Защита территории от врагов
        - Влияние на игровой мир
      territory_features:
        - Territory definition (определение территорий)
        - Territory control (контроль территории)
        - Territory defense (защита территории)
        - Territory influence (влияние на мир)
      endpoints:
        - GET /api/v1/gang/{gang_id}/territory - территория банды
        - GET /api/v1/gang/{gang_id}/territory/control - контроль территории
        - POST /api/v1/gang/{gang_id}/territory/defend - защита территории
        - GET /api/v1/gang/{gang_id}/territory/influence - влияние территории

    - name: gang-clan-conflict-manager
      location: gameplay-service-go (модуль gang-clan-conflicts)
      responsibility: |
        Управление клановыми столкновениями:
        - Инициация клановых столкновений
        - Координация PvP конфликтов между бандами
        - Управление результатами столкновений
        - Интеграция с системой клановых войн
      conflict_types:
        - Street Brawls (уличные драки)
        - Territory Disputes (территориальные споры)
        - Honor Duels (дуэли чести)
        - Gang Wars (войны банд)
      endpoints:
        - GET /api/v1/gang/{gang_id}/conflicts - активные конфликты
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/initiate - инициация конфликта
        - GET /api/v1/gang/{gang_id}/conflicts/{conflict_id}/status - статус конфликта
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/join - присоединение к конфликту
        - POST /api/v1/gang/{gang_id}/conflicts/{conflict_id}/resolve - разрешение конфликта

    - name: gang-honor-code-system
      location: gameplay-service-go (модуль gang-honor-code)
      responsibility: |
        Система кодекса чести:
        - Управление кодексом чести банд
        - Проверка соблюдения кодекса
        - Последствия нарушения кодекса
        - Награды за соблюдение кодекса
      honor_code_features:
        - Code definition (определение кодекса)
        - Code compliance (соблюдение кодекса)
        - Code violations (нарушения кодекса)
        - Code rewards (награды за соблюдение)
      endpoints:
        - GET /api/v1/gang/{gang_id}/honor-code - кодекс чести банды
        - POST /api/v1/gang/{gang_id}/honor-code/check - проверка соблюдения
        - POST /api/v1/gang/{gang_id}/honor-code/violation - регистрация нарушения
        - GET /api/v1/gang/{gang_id}/honor-code/rewards - награды за соблюдение

    - name: gang-cultural-events-manager
      location: world-service-go (модуль gang-cultural-events)
      responsibility: |
        Управление культурными событиями банд:
        - Создание культурных событий
        - Координация участников событий
        - Управление наградами за события
        - Интеграция с Live Ops
      cultural_event_types:
        - Street Festivals (уличные фестивали)
        - Cultural Celebrations (культурные празднования)
        - Community Events (события сообщества)
        - Tradition Rituals (ритуалы традиций)
      endpoints:
        - GET /api/v1/gang/{gang_id}/cultural-events - культурные события
        - GET /api/v1/gang/{gang_id}/cultural-events/{event_id} - информация о событии
        - POST /api/v1/gang/{gang_id}/cultural-events/{event_id}/join - присоединение к событию
        - POST /api/v1/gang/{gang_id}/cultural-events/{event_id}/complete - завершение события

    - name: gang-recruitment-system
      location: gameplay-service-go (модуль gang-recruitment)
      responsibility: |
        Система вербовки в банды:
        - Создание программ вербовки
        - Управление кандидатами
        - Процесс инициации
        - Интеграция с кодексом чести
      recruitment_features:
        - Recruitment programs (программы вербовки)
        - Candidate tracking (отслеживание кандидатов)
        - Initiation process (процесс инициации)
        - Honor requirements (требования чести)
      endpoints:
        - GET /api/v1/gang/{gang_id}/recruitment/programs - программы вербовки
        - POST /api/v1/gang/{gang_id}/recruitment/programs/{program_id}/apply - подача заявки
        - GET /api/v1/gang/{gang_id}/recruitment/candidates/{player_id} - статус кандидата
        - POST /api/v1/gang/{gang_id}/recruitment/candidates/{player_id}/initiate - инициация кандидата

    - name: gang-family-system
      location: gameplay-service-go (модуль gang-family)
      responsibility: |
        Семейная модель сообщества:
        - Управление семейными связями в банде
        - Отслеживание отношений между членами
        - Управление семейными событиями
        - Интеграция с системой отношений
      family_features:
        - Family bonds (семейные связи)
        - Member relationships (отношения между членами)
        - Family events (семейные события)
        - Loyalty tracking (отслеживание лояльности)
      endpoints:
        - GET /api/v1/gang/{gang_id}/family/members - члены семьи банды
        - GET /api/v1/gang/{gang_id}/family/{player_id}/relationships - отношения игрока
        - POST /api/v1/gang/{gang_id}/family/{player_id}/bond - создание связи
        - GET /api/v1/gang/{gang_id}/family/events - семейные события

  data_flow:
    street_honor_flow: |
      1. Игрок взаимодействует с NPC Хосе Рамиресом
      2. Игрок выполняет действия, соответствующие кодексу чести
      3. Street Honor System увеличивает честь игрока
      4. Игрок получает доступ к новому контенту
      5. Игрок нарушает кодекс чести
      6. Gang Honor Code System регистрирует нарушение
      7. Street Honor System снижает честь игрока
      8. Доступ к контенту ограничивается

    territory_defense_flow: |
      1. Враги (Maelstrom) атакуют территорию Valentinos
      2. Gang Territory Manager детектирует атаку
      3. NPC Хосе Рамирес инициирует событие защиты
      4. Игроки получают уведомление о защите территории
      5. Игроки присоединяются к защите
      6. Gang Clan Conflict Manager координирует конфликт
      7. Игроки участвуют в PvP боях
      8. При успешной защите территория сохраняется
      9. Street Honor System награждает защитников

    clan_conflict_flow: |
      1. NPC Хосе Рамирес инициирует клановое столкновение
      2. Gang Clan Conflict Manager создаёт конфликт
      3. Игроки получают уведомление о конфликте
      4. Игроки присоединяются к стороне (Valentinos)
      5. Gang Clan Conflict Manager координирует PvP
      6. Игроки участвуют в уличных боях
      7. Gang Clan Conflict Manager отслеживает прогресс
      8. При завершении конфликта определяются результаты
      9. Street Honor System обновляет честь участников

    cultural_event_flow: |
      1. NPC Хосе Рамирес создаёт культурное событие
      2. Gang Cultural Events Manager публикует событие
      3. Игроки просматривают доступные события
      4. Игроки присоединяются к событию
      5. Gang Cultural Events Manager координирует участников
      6. Событие проходит (фестиваль, празднование)
      7. Gang Cultural Events Manager отслеживает прогресс
      8. При завершении события выдаются награды
      9. Street Honor System обновляет честь участников

  integrations:
    with_npc_integration_system: |
      - Использование NPC Quest Manager для квестов
      - Использование NPC Relationship Tracker для отношений
      - Использование NPC Dialogue System для диалогов
      - Использование NPC Event Trigger System для событий

    with_clan_war_system: |
      - Интеграция с системой клановых войн
      - Использование общих механизмов PvP
      - Координация больших конфликтов

    with_quest_engine: |
      - Создание квестов защиты территории
      - Интеграция с цепочками квестов
      - Управление наградами за квесты

    with_world_service: |
      - Управление территориальными событиями
      - Синхронизация состояния территорий
      - Интеграция с Live Ops

  database_schema:
    tables:
      - name: street_honor
        description: Уличная честь игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - gang_id: VARCHAR(50) (FK gangs)
          - honor_level: ENUM (dishonored, neutral, respected, honored, legendary)
          - honor_points: INTEGER (очки чести)
          - last_interaction: TIMESTAMP
          - violation_count: INTEGER (количество нарушений)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(player_id, gang_id)
        indexes:
          - player_id, gang_id
          - gang_id, honor_level

      - name: gang_territories
        description: Территории банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - territory_name: VARCHAR(255)
          - zone_id: UUID (FK zones)
          - control_level: INTEGER (уровень контроля, 0-100)
          - defense_status: ENUM (safe, threatened, under_attack)
          - last_attack: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, control_level
          - zone_id

      - name: gang_clan_conflicts
        description: Клановые столкновения банд
        fields:
          - id: UUID (PK)
          - initiator_gang: VARCHAR(50) (FK gangs)
          - target_gang: VARCHAR(50) (FK gangs)
          - conflict_type: ENUM (street_brawl, territory_dispute, honor_duel, gang_war)
          - status: ENUM (pending, active, resolved)
          - participants: UUID[] (array of player IDs)
          - outcome: JSONB (результат конфликта)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - initiator_gang, status
          - target_gang, status

      - name: gang_honor_code
        description: Кодекс чести банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - code_rules: JSONB (правила кодекса)
          - violation_penalties: JSONB (штрафы за нарушения)
          - compliance_rewards: JSONB (награды за соблюдение)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id

      - name: gang_honor_violations
        description: Нарушения кодекса чести
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - gang_id: VARCHAR(50) (FK gangs)
          - violation_type: VARCHAR(50)
          - violation_severity: ENUM (minor, moderate, major, severe)
          - penalty_applied: JSONB (применённый штраф)
          - created_at: TIMESTAMP
        indexes:
          - player_id, gang_id
          - gang_id, violation_severity

      - name: gang_cultural_events
        description: Культурные события банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - event_type: ENUM (street_festival, cultural_celebration, community_event, tradition_ritual)
          - title: VARCHAR(255)
          - description: TEXT
          - requirements: JSONB (требования для участия)
          - rewards: JSONB (награды за событие)
          - status: ENUM (pending, active, completed, cancelled)
          - participants: UUID[] (array of player IDs)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, status
          - event_type, status

      - name: gang_recruitment_programs
        description: Программы вербовки банд
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - program_name: VARCHAR(255)
          - requirements: JSONB (требования для участия)
          - honor_requirements: INTEGER (минимальная честь)
          - rewards: JSONB (награды за участие)
          - status: ENUM (active, closed, completed)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, status

      - name: gang_recruitment_candidates
        description: Кандидаты на вербовку в банды
        fields:
          - id: UUID (PK)
          - program_id: UUID (FK gang_recruitment_programs)
          - player_id: UUID (FK accounts)
          - status: ENUM (applied, reviewing, initiated, accepted, rejected)
          - application_data: JSONB (данные заявки)
          - honor_check: BOOLEAN (проверка чести пройдена)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(program_id, player_id)
        indexes:
          - program_id, status
          - player_id, status

      - name: gang_family_bonds
        description: Семейные связи в бандах
        fields:
          - id: UUID (PK)
          - gang_id: VARCHAR(50) (FK gangs)
          - player_id: UUID (FK accounts)
          - family_role: VARCHAR(50) (роль в семье)
          - bond_strength: INTEGER (сила связи, 0-100)
          - related_members: UUID[] (array of related player IDs)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - gang_id, player_id
          - player_id, bond_strength

technical_specification:
  backend_requirements:
    - Расширение gameplay-service-go модулями:
      - street-honor (система уличной чести)
      - gang-clan-conflicts (клановые столкновения)
      - gang-honor-code (кодекс чести)
      - gang-recruitment (вербовка в банды)
      - gang-family (семейная модель)
    - Расширение world-service-go модулями:
      - gang-territory (управление территорией)
      - gang-cultural-events (культурные события)
    - Интеграция с npc-integration-system для базовой функциональности NPC
    - Интеграция с clan-war-system для PvP механизмов
    - Интеграция с quest-engine для квестов защиты территории

  gang_npc_specific_requirements:
    - NPC Хосе Рамирес (Valentinos):
      - Квесты защиты Heywood
      - Культурные события Valentinos
      - Вербовка новых членов
      - Клановые столкновения с Maelstrom
      - Управление кодексом чести

  performance_requirements:
    - Поддержка до 20 активных клановых конфликтов одновременно
    - Задержка обновления чести: <50 мс
    - Поддержка до 50 активных культурных событий
    - Поддержка до 30 активных программ вербовки
    - Поддержка до 100 территорий банд

  scalability_requirements:
    - Горизонтальное масштабирование через пул инстансов
    - Кэширование состояния чести в Redis
    - Асинхронная обработка конфликтов через event bus
    - Batch-обработка обновлений чести

subtasks:
  - id: street-honor-system-module
    title: Реализация Street Honor System модуля
    description: |
      Система уличной чести:
      - Отслеживание уличной чести игроков
      - Управление уровнями чести
      - Влияние на доступность контента
    priority: high
    estimated_time: 5-6 дней

  - id: gang-territory-manager-module
    title: Реализация Gang Territory Manager модуля
    description: |
      Управление территорией банд:
      - Определение территорий
      - Управление контролем территории
      - Защита территории
    priority: high
    estimated_time: 5-6 дней

  - id: gang-clan-conflict-manager-module
    title: Реализация Gang Clan Conflict Manager модуля
    description: |
      Управление клановыми столкновениями:
      - Инициация столкновений
      - Координация PvP конфликтов
      - Управление результатами
    priority: high
    estimated_time: 6-7 дней

  - id: gang-honor-code-system-module
    title: Реализация Gang Honor Code System модуля
    description: |
      Система кодекса чести:
      - Управление кодексом чести
      - Проверка соблюдения кодекса
      - Последствия нарушений
    priority: high
    estimated_time: 4-5 дней

  - id: gang-cultural-events-manager-module
    title: Реализация Gang Cultural Events Manager модуля
    description: |
      Управление культурными событиями:
      - Создание культурных событий
      - Координация участников
      - Управление наградами
    priority: high
    estimated_time: 5-6 дней

  - id: gang-recruitment-system-module
    title: Реализация Gang Recruitment System модуля
    description: |
      Система вербовки в банды:
      - Создание программ вербовки
      - Управление кандидатами
      - Процесс инициации
    priority: high
    estimated_time: 5-6 дней

  - id: gang-family-system-module
    title: Реализация Gang Family System модуля
    description: |
      Семейная модель сообщества:
      - Управление семейными связями
      - Отслеживание отношений
      - Управление семейными событиями
    priority: high
    estimated_time: 4-5 дней

  - id: database-schema-gang-integration
    title: Создание схемы БД для интеграции банд
    description: |
      Создание таблиц для интеграции банд:
      - street_honor
      - gang_territories
      - gang_clan_conflicts
      - gang_honor_code
      - gang_honor_violations
      - gang_cultural_events
      - gang_recruitment_programs
      - gang_recruitment_candidates
      - gang_family_bonds
    priority: high
    estimated_time: 3-4 дня

  - id: api-endpoints-gang-integration
    title: Реализация REST API endpoints для интеграции банд
    description: |
      Создание всех endpoints для интеграции банд:
      - Honor endpoints
      - Territory endpoints
      - Conflict endpoints
      - Honor code endpoints
      - Cultural events endpoints
      - Recruitment endpoints
      - Family endpoints
    priority: high
    estimated_time: 4-5 дней

  - id: integration-testing-gang
    title: Интеграционное тестирование систем банд
    description: |
      Тесты интеграции банд:
      - Тесты уличной чести
      - Тесты управления территорией
      - Тесты клановых столкновений
      - Тесты кодекса чести
      - Тесты культурных событий
      - Тесты вербовки
      - Тесты семейной модели
    priority: high
    estimated_time: 6-7 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Gang NPC Integration System"
            SHS[Street Honor System]
            GTM[Gang Territory Manager]
            GCCM[Gang Clan Conflict Manager]
            GHCS[Gang Honor Code System]
            GCEM[Gang Cultural Events Manager]
            GRS[Gang Recruitment System]
            GFS[Gang Family System]
        end

        subgraph "NPC Integration System"
            NQM[NPC Quest Manager]
            NRT[NPC Relationship Tracker]
            NDS[NPC Dialogue System]
        end

        subgraph "Game Services"
            CWS[Clan War System]
            QE[Quest Engine]
            WS[World Service]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>street_honor<br/>gang_territories<br/>gang_clan_conflicts<br/>gang_honor_code<br/>gang_cultural_events<br/>gang_recruitment_programs<br/>gang_family_bonds)]
        end

        subgraph "NPC"
            NPC[Хосе Рамирес<br/>Valentinos Leader]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|interact| NPC
        NPC --> NDS
        NDS --> NQM
        NDS --> SHS
        NDS --> GTM
        NDS --> GCCM
        NDS --> GHCS
        NDS --> GCEM
        NDS --> GRS
        GCCM --> CWS
        GTM --> WS
        GCEM --> WS
        SHS --> DB
        GTM --> DB
        GCCM --> DB
        GHCS --> DB
        GCEM --> DB
        GRS --> DB
        GFS --> DB
    ```

  street_honor_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant NPC as Хосе Рамирес
        participant NDS as NPC Dialogue System
        participant SHS as Street Honor System
        participant GHCS as Gang Honor Code System

        C->>NPC: Interact
        NPC->>NDS: Show dialogue tree
        NDS->>C: Display "Show Respect" option
        C->>NDS: Select "Show Respect"
        NDS->>SHS: Update honor (+3)
        SHS->>GHCS: Check honor code compliance
        GHCS->>SHS: Compliance confirmed
        SHS->>C: Honor updated
        Note over C,GHCS: Player gains access to new content
    ```

decisions:
  - id: adr-gang-npc-integration-architecture
    summary: |
      Выбрана архитектура, расширяющая общую NPC интеграцию для NPC лидеров банд
      с фокусом на уличную честь и клановые столкновения.

  - id: adr-street-honor-system
    summary: |
      Реализована отдельная система уличной чести для банд с влиянием на доступность
      контента и интеграцией с кодексом чести.

  - id: adr-gang-territory-management
    summary: |
      Управление территорией банд обеспечивает динамический контроль районов
      и защиту от врагов с влиянием на игровой мир.

  - id: adr-gang-clan-conflicts
    summary: |
      Интеграция с clan-war-system для PvP механизмов клановых столкновений
      обеспечивает единообразие и переиспользование логики.

  - id: adr-gang-honor-code
    summary: |
      Система кодекса чести обеспечивает структурированные правила поведения
      с последствиями за нарушения и наградами за соблюдение.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация схем данных для интеграции банд
  - Определение формата кодекса чести
  - Создание спецификации системы уличной чести

history:
  - version: "1.0.0"
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура интеграции NPC лидеров банд с игровыми системами:
      - Определены компоненты (Street Honor System, Gang Territory Manager, Gang Clan Conflict Manager, Gang Honor Code System, Gang Cultural Events Manager, Gang Recruitment System, Gang Family System)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных (street honor flow, territory defense flow, clan conflict flow, cultural event flow)
      - Определена структура БД (9 таблиц)
      - Спроектирована интеграция с игровыми системами (NPC integration, clan war system, quest engine, world service)
      - Создано техническое задание
      - Разбито на подзадачи (10 подзадач)

