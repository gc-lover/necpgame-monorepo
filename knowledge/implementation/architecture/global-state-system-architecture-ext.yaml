    history_and_time_travel:
      - GET /api/v1/world/state/{key}/history
        description: Получить историю изменений
        response: array<StateEvent>
      - GET /api/v1/world/state/{key}/at-time
        description: Получить состояние на момент времени
        query_params:
          - timestamp: timestamp
        response: GlobalState
      - POST /api/v1/world/state/replay
        description: Replay событий для восстановления
        request: ReplayRequest
        response: ReplayResponse

    queries:
      - POST /api/v1/world/state/query
        description: Запросы к состоянию (point, range, aggregate)
        request: StateQueryRequest
        response: StateQueryResponse
      - GET /api/v1/world/state/projections
        description: Получить доступные проекции
        response: array<Projection>

    synchronization:
      - GET /api/v1/world/state/sync/status
        description: Статус синхронизации
        response: SyncStatus
      - POST /api/v1/world/state/sync/trigger
        description: Триггер синхронизации (admin)
        request: SyncTriggerRequest
        response: SyncTriggerResponse

  technical_tasks:
    phases:
      phase_1:
        name: Global State Manager и Event Processing Pipeline
        tasks:
          - Реализация Global State Manager
          - CRUD операции
          - Кэширование в Redis
          - Публикация событий
          - Event Processing Pipeline (10 этапов)
        estimated_effort: 6 days

      phase_2:
        name: State Synchronization Manager
        tasks:
          - Реализация State Synchronization Manager
          - Server-wide синхронизация
          - Player-specific синхронизация
          - Phased синхронизация
          - Redis pub/sub интеграция
        estimated_effort: 5 days

      phase_3:
        name: Conflict Resolution Engine
        tasks:
          - Реализация Conflict Resolution Engine
          - Last Write Wins стратегия
          - Голосование
          - Event версионность
          - Merge дельт
          - Optimistic locking
        estimated_effort: 4 days

      phase_4:
        name: Event Store и Replay Engine
        tasks:
          - Реализация Event Store Manager
          - Snapshot management
          - State Replay Engine
          - Time travel функциональность
          - Аудит изменений
        estimated_effort: 5 days

      phase_5:
        name: Query Service и Projections
        tasks:
          - Реализация Query Service
          - Point, range, aggregate queries
          - Projection Manager
          - Материализованные представления
          - Оптимизация запросов
        estimated_effort: 4 days

      phase_6:
        name: WebSocket Sync Manager
        tasks:
          - Реализация WebSocket Sync Manager
          - WebSocket каналы
          - Подписка на изменения
          - Управление подключениями
          - Heartbeat и переподключение
        estimated_effort: 3 days

      phase_7:
        name: Интеграции и оптимизация
        tasks:
          - Интеграция с Event Bus
          - Интеграция с Redis Cluster
          - Интеграция с PostgreSQL
          - Интеграция с Realtime Gateway
          - Performance tuning
          - Мониторинг и алерты
        estimated_effort: 5 days

    total_estimated_effort: 32 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> WorldService[World Service<br/>8086]
        
        WorldService --> GSM[Global State Manager]
        WorldService --> EPP[Event Processing Pipeline]
        WorldService --> SSM[State Synchronization Manager]
        WorldService --> CRE[Conflict Resolution Engine]
        WorldService --> ESM[Event Store Manager]
        WorldService --> SRE[State Replay Engine]
        WorldService --> QS[Query Service]
        WorldService --> PM[Projection Manager]
        WorldService --> WSSM[WebSocket Sync Manager]
        
        WorldService --> EventBus[Event Bus<br/>Kafka]
        WorldService --> Redis[(Redis Cluster)]
        WorldService --> DB[(PostgreSQL)]
        
        Redis --> WSSM
        WSSM --> RealtimeGateway[Realtime Gateway]
        RealtimeGateway --> Client
        
        WorldService --> OtherServices[Other Services]
        OtherServices --> EventBus
        EventBus --> WorldService
    ```

  event_processing_pipeline: |
    ```mermaid
    graph LR
        A[Receive Event] --> B[Validate]
        B --> C[Authorize]
        C --> D[Enrich]
        D --> E[Write Event Store]
        E --> F[Publish Event Bus]
        F --> G[Process Subscribers]
        G --> H[Update State]
        H --> I[Notifications]
        I --> J[Analytics]
    ```

  sync_flow: |
    ```mermaid
    sequenceDiagram
        participant Service
        participant WorldService
        participant GlobalStateManager
        participant Redis
        participant EventBus
        participant OtherServices
        
        Service->>WorldService: Update State
        WorldService->>GlobalStateManager: Process Update
        GlobalStateManager->>Redis: Update Cache
        GlobalStateManager->>EventBus: Publish StateChangedEvent
        EventBus->>OtherServices: Notify Subscribers
        Redis->>Redis: PUBLISH world:state-changed
        Redis->>WorldService: Notify Subscribers
        WorldService->>RealtimeGateway: WebSocket Update
    ```

  network_requirements:
    protocol: |
      Global State система использует WebSocket (TCP) для синхронизации с клиентами:
      - Протокол: WebSocket (TCP) - постоянно, без переключения
      - Применение: все типы синхронизации (server-wide, player-specific, phased)
      - Надежная доставка сообщений критична для состояния
      - Поддержка TLS (wss://)
    
    tickrate_and_frequency: |
      Тикрейт и частота обновлений:
      - Server-wide синхронизация: Event-based (при изменениях состояния)
      - Player-specific синхронизация: Event-based (при изменениях персональных данных)
      - Phased синхронизация: Event-based (при изменениях фаз)
      - WebSocket heartbeat: каждые 30 секунд
      - Redis pub/sub: realtime (мгновенно при изменениях)
      - Event Bus синхронизация: batch каждые 100 мс (для оптимизации)
    
    latency_requirements: |
      Требования к задержке:
      - WebSocket обновления: <100 мс (p99)
      - Redis pub/sub: <10 мс (p99)
      - Event Bus синхронизация: <200 мс (p99)
      - State queries: <50 мс (p99)
      - State updates: <100 мс (p99)
    
    network_load: |
      Сетевая нагрузка:
      - WebSocket обновления: 0.5-2 KB/sec на игрока (зависит от частоты изменений)
      - Redis pub/sub: 1-5 KB/sec на сервис (зависит от количества подписчиков)
      - Event Bus: 5-20 KB/sec (batch синхронизация)
      - State queries: 0.1-0.5 KB/запрос
      - State updates: 0.5-2 KB/обновление
    
    optimization: |
      Оптимизации:
      - Кэширование состояния в Redis для быстрого доступа
      - Batch синхронизация через Event Bus (каждые 100 мс)
      - WebSocket каналы только для активных подписчиков
      - Инвалидация кэша при изменениях
      - Оптимистичная блокировка для снижения конфликтов












