# Issue: #141
metadata:
  id: guild-system-architecture
  title: Архитектура системы гильдий
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-12-14T12:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - guilds
    - architecture
    - backend
    - social
    - economy
    - world
  topics:
    - membership
    - ranks
    - wars
    - territories
    - bank
  related_systems:
    - social-service
    - economy-service
    - world-service
    - combat-service
    - notification-service
  related_documents:
    - id: guild-system-backend
      relation: extends
    - id: guilds-overview
      relation: references
  source: ''
  visibility: internal
  audience:
    - architect
    - backend
    - concept
  risk_level: high
review:
  chain:
    - role: architect
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Отсутствует полная архитектурная документация системы гильдий для управления участниками, рангами, банком, войнами и территорией.
  goal: Спроектировать полную техническую архитектуру системы гильдий с определением компонентов, API, потоков данных, структуры БД и систем управления.
  essence: Микросервисная архитектура с выделенными сервисами для управления гильдиями, банком, войнами и территориями, интегрированная с существующими системами.
  key_points:
    - Микросервисная архитектура с 4 основными сервисами
    - Полная структура БД с оптимизированными индексами
    - Системы управления рангами, банком и войнами
    - API endpoints для всех операций
    - Потоки данных и интеграции между сервисами
content:
  sections:
    - id: overview
      title: Обзор архитектуры
      body: |
        Система гильдий построена на микросервисной архитектуре и состоит из 4 основных сервисов:

        1. **guild-core-service** - основной сервис управления гильдиями
        2. **guild-bank-service** - сервис банка гильдии
        3. **guild-war-service** - сервис гильдейских войн
        4. **guild-territory-service** - сервис территорий и собственности

        Все сервисы интегрируются с существующими системами (social, economy, world, combat, notification).
      mechanics_links: []
      assets: []

    - id: components
      title: Компоненты системы
      body: |
        ## guild-core-service (порт 8084)
        Основной сервис управления гильдиями:
        - Создание/удаление гильдий
        - Управление членством (приглашения, исключения)
        - Система рангов и прав
        - Базовые настройки гильдии
        - Статистика и метрики

        ## guild-bank-service (порт 8085)
        Сервис банковских операций гильдии:
        - Управление общим банком
        - Вклады и снятия средств
        - Налоги и сборы
        - Экономические транзакции

        ## guild-war-service (порт 8086)
        Сервис гильдейских войн:
        - Объявление и управление войнами
        - Система очков войны
        - Бонусы за участие
        - Статистика войн

        ## guild-territory-service (порт 8087)
        Сервис территорий и собственности:
        - Захват и защита территорий
        - Управление собственностью
        - Территориальные войны
        - Экономические бонусы территорий
      mechanics_links: []
      assets: []

    - id: database
      title: Структура базы данных
      body: |
        ## Основные таблицы

        ### guilds
        ```sql
        CREATE TABLE guilds (
          guild_id UUID PRIMARY KEY,
          name VARCHAR(100) NOT NULL UNIQUE,
          tag VARCHAR(10) NOT NULL UNIQUE,
          description TEXT,
          leader_id UUID NOT NULL REFERENCES players(player_id),
          level INTEGER DEFAULT 1,
          experience BIGINT DEFAULT 0,
          max_members INTEGER DEFAULT 50,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );

        CREATE INDEX idx_guilds_name ON guilds(name);
        CREATE INDEX idx_guilds_tag ON guilds(tag);
        CREATE INDEX idx_guilds_leader ON guilds(leader_id);
        ```

        ### guild_members
        ```sql
        CREATE TABLE guild_members (
          guild_id UUID REFERENCES guilds(guild_id),
          player_id UUID REFERENCES players(player_id),
          rank_id INTEGER REFERENCES guild_ranks(rank_id),
          joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          contribution_points BIGINT DEFAULT 0,
          PRIMARY KEY (guild_id, player_id)
        );

        CREATE INDEX idx_guild_members_player ON guild_members(player_id);
        CREATE INDEX idx_guild_members_rank ON guild_members(rank_id);
        ```

        ### guild_ranks
        ```sql
        CREATE TABLE guild_ranks (
          rank_id SERIAL PRIMARY KEY,
          guild_id UUID REFERENCES guilds(guild_id),
          name VARCHAR(50) NOT NULL,
          level INTEGER NOT NULL,
          permissions JSONB,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ```

        ### guild_bank
        ```sql
        CREATE TABLE guild_bank (
          guild_id UUID PRIMARY KEY REFERENCES guilds(guild_id),
          balance JSONB DEFAULT '{}', -- Валюты и ресурсы
          tax_rate DECIMAL(3,2) DEFAULT 0.05,
          last_transaction_at TIMESTAMP WITH TIME ZONE,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ```

        ### guild_wars
        ```sql
        CREATE TABLE guild_wars (
          war_id UUID PRIMARY KEY,
          attacker_guild_id UUID REFERENCES guilds(guild_id),
          defender_guild_id UUID REFERENCES guilds(guild_id),
          territory_id UUID,
          status VARCHAR(20) DEFAULT 'active',
          points_attacker BIGINT DEFAULT 0,
          points_defender BIGINT DEFAULT 0,
          started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          ended_at TIMESTAMP WITH TIME ZONE
        );
        ```

        ### guild_territories
        ```sql
        CREATE TABLE guild_territories (
          territory_id UUID PRIMARY KEY,
          guild_id UUID REFERENCES guilds(guild_id),
          name VARCHAR(100) NOT NULL,
          type VARCHAR(50),
          coordinates JSONB,
          bonuses JSONB,
          controlled_since TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ```
      mechanics_links: []
      assets: []

    - id: api-endpoints
      title: API Endpoints
      body: |
        ## Guild Core API (guild-core-service)

        ### Управление гильдиями
        ```
        POST   /api/v1/guilds              - Создать гильдию
        GET    /api/v1/guilds/{id}         - Получить информацию о гильдии
        PUT    /api/v1/guilds/{id}         - Обновить гильдию
        DELETE /api/v1/guilds/{id}         - Распустить гильдию
        GET    /api/v1/guilds/search       - Поиск гильдий
        ```

        ### Управление членством
        ```
        POST   /api/v1/guilds/{id}/invite  - Пригласить игрока
        POST   /api/v1/guilds/{id}/join    - Принять приглашение
        DELETE /api/v1/guilds/{id}/leave   - Покинуть гильдию
        DELETE /api/v1/guilds/{id}/kick    - Исключить игрока
        ```

        ### Управление рангами
        ```
        POST   /api/v1/guilds/{id}/ranks       - Создать ранг
        PUT    /api/v1/guilds/{id}/ranks/{rid} - Обновить ранг
        DELETE /api/v1/guilds/{id}/ranks/{rid} - Удалить ранг
        PUT    /api/v1/guilds/{id}/members/{pid}/rank - Изменить ранг участника
        ```

        ## Guild Bank API (guild-bank-service)

        ### Банковские операции
        ```
        GET    /api/v1/guilds/{id}/bank          - Получить баланс банка
        POST   /api/v1/guilds/{id}/bank/deposit   - Внести средства
        POST   /api/v1/guilds/{id}/bank/withdraw  - Снять средства
        PUT    /api/v1/guilds/{id}/bank/tax       - Изменить налог
        GET    /api/v1/guilds/{id}/bank/history   - История транзакций
        ```

        ## Guild War API (guild-war-service)

        ### Управление войнами
        ```
        POST   /api/v1/guilds/{id}/wars           - Объявить войну
        GET    /api/v1/guilds/{id}/wars           - Список войн
        GET    /api/v1/wars/{wid}                 - Детали войны
        PUT    /api/v1/wars/{wid}/end             - Завершить войну
        POST   /api/v1/wars/{wid}/points          - Добавить очки
        ```

        ## Guild Territory API (guild-territory-service)

        ### Управление территориями
        ```
        GET    /api/v1/territories                - Список территорий
        POST   /api/v1/territories/{tid}/claim    - Захватить территорию
        DELETE /api/v1/territories/{tid}/claim    - Отказаться от территории
        GET    /api/v1/guilds/{id}/territories     - Территории гильдии
        ```
      mechanics_links: []
      assets: []

    - id: data-flows
      title: Потоки данных
      body: |
        ## Создание гильдии
        1. Игрок отправляет запрос в guild-core-service
        2. Валидация данных и проверка прав
        3. Создание записи в БД
        4. Публикация события `guild:created`
        5. Уведомление через notification-service

        ## Вступление в гильдию
        1. Приглашение через guild-core-service
        2. Игрок принимает приглашение
        3. Обновление guild_members
        4. Публикация `guild:member-joined`
        5. Обновление социальных связей в social-service

        ## Банковская транзакция
        1. Запрос в guild-bank-service
        2. Валидация баланса через economy-service
        3. Выполнение транзакции
        4. Обновление guild_bank
        5. Публикация `guild:bank-transaction`

        ## Гильдейская война
        1. Объявление войны через guild-war-service
        2. Создание записи в guild_wars
        3. Уведомление участников
        4. Интеграция с combat-service для боев
        5. Обновление очков и завершение войны
      mechanics_links: []
      assets: []

    - id: rank-system
      title: Система рангов и прав
      body: |
        ## Структура рангов
        Каждый ранг имеет уровень (1-10) и набор разрешений:

        ### Основные ранги (автоматические)
        - **Глава** (level 10): Полный доступ ко всем функциям
        - **Заместитель** (level 8): Управление членами, банком, войнами
        - **Офицер** (level 6): Приглашения, исключения, управление рангами
        - **Ветеран** (level 4): Доступ к банку, участие в войнах
        - **Член** (level 2): Базовые права, вклад в банк
        - **Рекрут** (level 1): Минимальные права

        ## Разрешения
        ```json
        {
          "invite_members": true,
          "kick_members": true,
          "manage_ranks": true,
          "manage_bank": true,
          "declare_war": true,
          "manage_territories": true,
          "edit_guild_info": true,
          "view_bank_history": true
        }
        ```

        ## Прогрессия рангов
        - Автоматическое повышение при достижении contribution_points
        - Ручное повышение офицерами и выше
        - Минимальный срок в ранге перед повышением
      mechanics_links: []
      assets: []

    - id: bank-system
      title: Система банка гильдии
      body: |
        ## Структура банка
        Банк хранит различные валюты и ресурсы в JSONB формате:

        ```json
        {
          "credits": 150000,
          "premium_currency": 2500,
          "resources": {
            "metal": 5000,
            "energy": 3000,
            "rare_materials": 150
          }
        }
        ```

        ## Типы транзакций
        - **Вклады**: Игроки вносят средства в банк гильдии
        - **Снятия**: Авторизованные участники снимают средства
        - **Налоги**: Автоматический сбор с активностей участников
        - **Награды**: Распределение от войн и территорий

        ## Налоговые ставки
        - Базовая ставка: 5% от наград
        - Настраиваемая главой гильдии
        - Автоматическое применение при получении наград

        ## Интеграция с экономикой
        - Валидация балансов через economy-service
        - Атомарные транзакции
        - Аудит всех операций
      mechanics_links: []
      assets: []

    - id: war-system
      title: Система гильдейских войн
      body: |
        ## Типы войн
        - **Территориальные войны**: Захват территорий
        - **Рейтинговые войны**: За позицию в таблице лидеров
        - **Ресурсные войны**: Контроль над ресурсными точками

        ## Механика войны
        1. Объявление войны (требует разрешения офицера+)
        2. Период подготовки (24 часа)
        3. Активная фаза (7 дней)
        4. Подведение итогов

        ## Система очков
        - Убийство противника: +10 очков
        - Захват цели: +50 очков
        - Защита территории: +25 очков
        - Командные бонусы за участие

        ## Награды победителям
        - Репутация гильдии
        - Экономические бонусы
        - Территориальные преимущества
        - Персональные награды участникам

        ## Интеграция с боевой системой
        - Регистрация боев через combat-service
        - Автоматический подсчет очков
        - Бонусы за гильдейские бои
      mechanics_links: []
      assets: []

    - id: integration
      title: Интеграции с другими системами
      body: |
        ## Social Service
        - Управление социальными связями участников
        - Чат гильдии
        - Уведомления о событиях

        ## Economy Service
        - Валидация транзакций
        - Курсы валют
        - Экономические события

        ## World Service
        - Территории и зоны контроля
        - Мировые события
        - Географические данные

        ## Combat Service
        - Регистрация боев в войнах
        - Бонусы за гильдейские бои
        - Статистика PvP

        ## Notification Service
        - Уведомления о событиях гильдии
        - Приглашения и объявления
        - Еженедельные отчеты
      mechanics_links: []
      assets: []

    - id: technical-spec
      title: Техническое задание
      body: |
        ## Требования к производительности
        - P99 latency <50ms для основных операций
        - Поддержка 1000+ одновременных гильдий
        - Масштабируемость до 100k+ участников

        ## Безопасность
        - Валидация всех разрешений
        - Аудит критических операций
        - Защита от эксплойтов

        ## Мониторинг
        - Метрики производительности
        - Логи всех операций
        - Алерты на аномалии

        ## Тестирование
        - Unit тесты для всех компонентов
        - Integration тесты API
        - Load тесты для высокой нагрузки
      mechanics_links: []
      assets: []

    - id: implementation-plan
      title: План реализации
      body: |
        ## Фаза 1: Базовая функциональность (2 недели)
        - guild-core-service с CRUD операциями
        - Базовая структура БД
        - API для создания и управления гильдиями
        - Система членства

        ## Фаза 2: Ранги и права (1 неделя)
        - Система рангов
        - Управление разрешениями
        - API для рангов

        ## Фаза 3: Банк гильдии (1 неделя)
        - guild-bank-service
        - Интеграция с economy-service
        - Налоги и транзакции

        ## Фаза 4: Войны (2 недели)
        - guild-war-service
        - Система очков
        - Интеграция с combat-service

        ## Фаза 5: Территории (2 недели)
        - guild-territory-service
        - Захват территорий
        - Экономические бонусы

        ## Фаза 6: Оптимизация и тестирование (1 неделя)
        - Производительность
        - Безопасность
        - Полное тестирование
      mechanics_links: []
      assets: []
appendix:
  glossary:
    - term: Guild
      definition: Организация игроков с общими целями, ресурсами и территорией
    - term: Rank
      definition: Уровень прав и ответственности участника в гильдии
    - term: Territory
      definition: Контролируемая область мира с экономическими бонусами
  references: []
  decisions:
    - id: adr-guild-architecture
      summary: Утверждена микросервисная архитектура системы гильдий с 4 выделенными сервисами
implementation:
  needs_task: true
  github_issue: 141
  queue_reference: []
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-12-14
    author: Backend Agent
    changes: Создана полная архитектурная документация системы гильдий
validation:
  checksum: ''
  schema_version: '1.0'