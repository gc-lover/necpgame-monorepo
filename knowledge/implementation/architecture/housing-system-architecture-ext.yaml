          - used_slots: INTEGER (default: 0)
          - prestige_score: INTEGER (default: 0)
          - access_setting: ENUM (PRIVATE, FRIENDS_ONLY, PUBLIC, GUILD_ONLY)
          - guests: UUID[] (FK accounts)
          - purchased_at: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - owner_id
          - guild_id
          - apartment_type, prestige_score

      - name: placed_furniture
        description: Размещённая мебель
        fields:
          - id: UUID (PK)
          - apartment_id: UUID (FK apartments)
          - furniture_item_id: UUID (FK furniture_items)
          - position_x: FLOAT
          - position_y: FLOAT
          - position_z: FLOAT
          - rotation_x: FLOAT (default: 0)
          - rotation_y: FLOAT (default: 0)
          - rotation_z: FLOAT (default: 0)
          - scale_x: FLOAT (default: 1)
          - scale_y: FLOAT (default: 1)
          - scale_z: FLOAT (default: 1)
          - placed_at: TIMESTAMP
        indexes:
          - apartment_id
          - furniture_item_id

      - name: furniture_items
        description: Каталог мебели
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - category: ENUM (DECORATIVE, FUNCTIONAL, COMFORT, STORAGE)
          - description: TEXT
          - price: BIGINT
          - prestige_points: INTEGER (default: 0)
          - slot_cost: INTEGER (default: 1)
          - is_unique: BOOLEAN (default: false)
          - function_bonus: JSONB (nullable)
          - is_active: BOOLEAN (default: true)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - category, is_active
          - is_unique, prestige_points

      - name: player_furniture_inventory
        description: Инвентарь мебели игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - furniture_item_id: UUID (FK furniture_items)
          - quantity: INTEGER (default: 1)
          - purchased_at: TIMESTAMP
        constraints: |
          - UNIQUE(player_id, furniture_item_id)
        indexes:
          - player_id
          - furniture_item_id

      - name: apartment_visits
        description: Посещения квартир
        fields:
          - id: UUID (PK)
          - apartment_id: UUID (FK apartments)
          - visitor_id: UUID (FK accounts)
          - visited_at: TIMESTAMP
        indexes:
          - apartment_id, visited_at
          - visitor_id, visited_at

technical_specification:
  backend_requirements:
    - Реализация модулей в world-service-go:
      - housing (управление квартирами)
      - housing-furniture (мебель)
      - housing-placement (размещение)
      - housing-prestige (престиж)
      - housing-bonuses (бонусы)
      - housing-visits (посещения)
      - housing-events (события)
      - housing-shop (магазин)
    - Интеграция с economy-service для покупок
    - Интеграция с social-service для доступа
    - Интеграция с character-service для бонусов
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация состояния квартир через WebSocket
    - Уведомления о событиях
    - Обновления в реальном времени

  performance_requirements:
    - Покупка квартиры < 200ms
    - Размещение мебели < 100ms
      - Загрузка квартиры < 200ms
      - Расчёт престижа < 50ms
      - Поддержка до 100K квартир
      - Поддержка до 1M предметов мебели

  scalability_requirements:
    - Горизонтальное масштабирование через world-service
    - Распределение нагрузки на квартиры
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование каталога мебели в Redis

subtasks:
  - id: apartment-manager-module
    title: Реализация модуля Apartment Manager
    description: |
      Управление квартирами
      Покупка квартир
      Управление настройками доступа
    priority: high
    estimated_time: 4-5 дней

  - id: furniture-manager-implementation
    title: Реализация Furniture Manager
    description: |
      Управление мебелью
      Каталог мебели
      Покупка мебели
    priority: high
    estimated_time: 3-4 дня

  - id: furniture-placement-system
    title: Реализация Furniture Placement System
    description: |
      Размещение мебели
      Позиционирование и трансформации
      Валидация размещения
    priority: high
    estimated_time: 5-6 дней

  - id: prestige-calculator
    title: Реализация Prestige Calculator
    description: |
      Расчёт престижа
      Агрегация очков
      Интеграция с leaderboard
    priority: high
    estimated_time: 3-4 дня

  - id: functional-bonus-aggregator
    title: Реализация Functional Bonus Aggregator
    description: |
      Агрегация функциональных бонусов
      Применение бонусов к игроку
      Интеграция с character service
    priority: high
    estimated_time: 3-4 дня

  - id: visit-manager
    title: Реализация Visit Manager
    description: |
      Управление посещениями
      Проверка доступа
      Трекинг посещений
    priority: high
    estimated_time: 3-4 дня

  - id: housing-event-handler
    title: Реализация Housing Event Handler
    description: |
      Обработка событий жилья
      Публикация событий
      Подписка на события
    priority: high
    estimated_time: 2-3 дня

  - id: housing-shop-manager
    title: Реализация Housing Shop Manager
    description: |
      Управление магазином мебели
      Каталог и фильтрация
      Покупка мебели
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование каталога
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для жилья
      Интеграция с существующим API world-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты покупки квартир
      Тесты размещения мебели
      Тесты престижа
      Тесты бонусов
      Тесты интеграций
    priority: high
    estimated_time: 4-5 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "World Service"
            AM[Apartment Manager]
            FM[Furniture Manager]
            FPS[Furniture Placement System]
            PC[Prestige Calculator]
            FBA[Functional Bonus Aggregator]
            VM[Visit Manager]
            HEH[Housing Event Handler]
            HSM[Housing Shop Manager]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>apartments<br/>placed_furniture<br/>furniture_items<br/>player_furniture_inventory<br/>apartment_visits)]
        end

        subgraph "External Services"
            ES[Economy Service]
            SS[Social Service]
            GS[Guild Service]
            CS[Character Service]
            LS[Leaderboard Service]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|purchase apartment| AM
        CL -->|place furniture| FPS
        AM --> ES
        FM --> ES
        FPS --> PC
        FPS --> FBA
        FBA --> CS
        PC --> LS
        VM --> SS
        HEH --> NS
        HEH --> RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant AM as Apartment Manager
        participant ES as Economy Service
        participant FPS as Furniture Placement System
        participant PC as Prestige Calculator

        P->>AM: Purchase apartment
        AM->>ES: Check currency
        ES->>AM: Currency OK
        AM->>AM: Create apartment
        P->>FPS: Place furniture
        FPS->>FPS: Validate placement
        FPS->>PC: Recalculate prestige
        PC->>PC: Update prestige
    ```

decisions:
  - id: adr-housing-architecture
    summary: |
      Выбрана модульная архитектура внутри world-service-go для обеспечения
      тесной интеграции с территориальной системой.

  - id: adr-apartment-types
    summary: |
      Различные типы квартир (студия, стандартная, пентхаус, гильдейский зал)
      обеспечивают прогрессию и мотивируют игроков развиваться.

  - id: adr-furniture-system
    summary: |
      Система мебели с категориями и функциональными бонусами создаёт
      глубину кастомизации и практическую ценность.

  - id: adr-prestige-system
    summary: |
      Система престижа мотивирует игроков улучшать свои квартиры и создаёт
      социальный элемент через лидерборды.

  - id: adr-functional-bonuses
    summary: |
      Функциональные бонусы мебели дают практическую ценность квартирам
      и мотивируют игроков инвестировать в жильё.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата размещения мебели и бонусов

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния жилья
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (покупка квартиры, размещение мебели, применение бонусов)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для квартир, мебели, престижа, бонусов, посещений и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы жилья:
      - Определены компоненты (Apartment Manager, Furniture Manager, Furniture Placement System, Prestige Calculator, Functional Bonus Aggregator, Visit Manager, Housing Event Handler, Housing Shop Manager)
      - Описаны типы квартир (STUDIO, STANDARD, PENTHOUSE, GUILD_HALL)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (apartments, placed_furniture, furniture_items, player_furniture_inventory, apartment_visits)
      - Спроектирована система покупки жилья
      - Спроектирована система размещения мебели
      - Спроектирована система престижа
      - Спроектирована система функциональных бонусов
      - Создано техническое задание
      - Разбито на подзадачи


