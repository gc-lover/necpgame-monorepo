metadata:
  id: housing-system-architecture
  title: Архитектура системы жилья (Housing System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T20:35:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - housing
    - backend
    - social
    - customization
  related_systems:
    - world-service-go
    - economy-service-go
    - social-service-go
  related_documents:
    - id: backend-housing-system
      relation: extends
  github_issue: 299
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы жилья
    для управления квартирами, мебелью, престижем, функциональными бонусами
    и посещениями для player engagement.
  goal: |
    Создать архитектурную схему системы жилья с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы покупки жилья
    - Системы размещения мебели
    - Системы престижа
    - Системы функциональных бонусов
    - Технического задания для реализации
  essence: |
    Игровая система жилья для управления квартирами, мебелью, престижем
    и функциональными бонусами для player engagement.

architecture:
  overview: |
    Система жилья состоит из восьми основных компонентов:
    1. Apartment Manager - управление квартирами
    2. Furniture Manager - управление мебелью
    3. Furniture Placement System - система размещения мебели
    4. Prestige Calculator - расчёт престижа
    5. Functional Bonus Aggregator - агрегация функциональных бонусов
    6. Visit Manager - управление посещениями
    7. Housing Event Handler - обработка событий
    8. Housing Shop Manager - управление магазином мебели

  components:
    - name: Apartment Manager
      location: world-service-go (модуль housing)
      responsibility: |
        - Управление квартирами игроков
        - Покупка квартир
        - Выбор локации
        - Управление настройками доступа
        - Интеграция с economy service
      apartment_types: |
        - STUDIO: студия (50,000 eddies, 20 слотов мебели)
        - STANDARD: стандартная квартира (200,000 eddies, 40 слотов)
        - PENTHOUSE: пентхаус (1,000,000 eddies, 80 слотов, вертолётная площадка)
        - GUILD_HALL: гильдейский зал (5,000,000 eddies из гильдейского банка, 200 слотов)
      access_settings: |
        - PRIVATE: приватная квартира
        - FRIENDS_ONLY: только для друзей
        - PUBLIC: публичная квартира
        - GUILD_ONLY: только для гильдии
      endpoints:
        - GET /api/v1/world/housing/apartments/available - доступные квартиры
        - POST /api/v1/world/housing/apartments/purchase - покупка квартиры
        - GET /api/v1/world/housing/apartments/{apartment_id} - информация о квартире
        - POST /api/v1/world/housing/apartments/{apartment_id}/settings - настройки доступа

    - name: Furniture Manager
      location: world-service-go (модуль housing-furniture)
      responsibility: |
        - Управление мебелью
        - Каталог мебели
        - Покупка мебели
        - Хранение мебели
        - Интеграция с economy service
      furniture_categories: |
        - DECORATIVE: декоративные предметы (постеры, растения, неон, ковры, арт)
        - FUNCTIONAL: функциональные бонусы (крафт-столы, регенерация, стойки оружия)
        - COMFORT: комфорт (кровати, диваны, кресла, столы)
        - STORAGE: хранилища (шкафы, сейфы, оружейные шкафы)
      furniture_properties: |
        - Престиж
        - Функциональные бонусы
        - Размер (слоты)
        - Уникальность
      endpoints:
        - GET /api/v1/world/housing/furniture/catalog - каталог мебели
        - POST /api/v1/world/housing/furniture/purchase - покупка мебели
        - GET /api/v1/world/housing/furniture/owned/{player_id} - мебель игрока

    - name: Furniture Placement System
      location: world-service-go (модуль housing-placement)
      responsibility: |
        - Размещение мебели в квартирах
        - Позиционирование мебели
        - Трансформации мебели (позиция, поворот, масштаб)
        - Валидация размещения
        - Проверка лимитов слотов
      placement_features: |
        - 3D позиционирование
        - Поворот мебели
        - Масштабирование
        - Проверка коллизий
        - Проверка лимитов
      validation_rules: |
        - Проверка доступных слотов
        - Проверка коллизий с другими предметами
        - Проверка границ квартиры
      endpoints:
        - POST /api/v1/world/housing/apartments/{apartment_id}/furniture/place - размещение мебели
        - POST /api/v1/world/housing/apartments/{apartment_id}/furniture/{furniture_id}/move - перемещение мебели
        - POST /api/v1/world/housing/apartments/{apartment_id}/furniture/{furniture_id}/remove - удаление мебели

    - name: Prestige Calculator
      location: world-service-go (модуль housing-prestige)
      responsibility: |
        - Расчёт престижа квартиры
        - Агрегация очков престижа
        - Обновление рейтинга
        - Интеграция с leaderboard
      prestige_sources: |
        - Базовый престиж типа квартиры
        - Очки за мебель
        - Бонусы за локацию
        - Бонусы за уникальные предметы
      prestige_formula: |
        - Базовый престиж квартиры
        - Сумма престижа мебели
        - Множитель локации
        - Бонус за уникальность
      endpoints:
        - GET /api/v1/world/housing/apartments/{apartment_id}/prestige - престиж квартиры
        - GET /api/v1/world/housing/prestige/leaderboard - лидерборд престижа

    - name: Functional Bonus Aggregator
      location: world-service-go (модуль housing-bonuses)
      responsibility: |
        - Агрегация функциональных бонусов мебели
        - Расчёт бонусов к характеристикам
        - Применение бонусов к игроку
        - Интеграция с character service
      bonus_types: |
        - CRAFT_SPEED: скорость крафта
        - STORAGE_SLOTS: слоты хранилища
        - HUMANITY_REGENERATION: регенерация человечности
        - WEAPON_STORAGE: хранение оружия
      bonus_aggregation: |
        - Суммирование бонусов от всех размещённых предметов
        - Применение к характеристикам игрока
        - Обновление при изменении мебели
      endpoints:
        - GET /api/v1/world/housing/apartments/{apartment_id}/bonuses - бонусы квартиры
        - GET /api/v1/world/housing/player/{player_id}/bonuses - бонусы игрока

    - name: Visit Manager
      location: world-service-go (модуль housing-visits)
      responsibility: |
        - Управление посещениями квартир
        - Проверка доступа
        - Загрузка состояния квартиры
        - Трекинг посещений
        - Уведомления владельца
      visit_features: |
        - Проверка настроек доступа
        - Загрузка состояния квартиры
        - Трекинг визитов
        - Уведомления владельцу
        - История посещений
      endpoints:
        - POST /api/v1/world/housing/apartments/{apartment_id}/visit - посещение квартиры
        - GET /api/v1/world/housing/apartments/{apartment_id}/visits - история посещений
        - GET /api/v1/world/housing/player/{player_id}/visits - посещения игрока

    - name: Housing Event Handler
      location: world-service-go (модуль housing-events)
      responsibility: |
        - Обработка событий жилья
        - Публикация событий в event bus
        - Подписка на события от других систем
        - Уведомления игроков
      housing_events_published: |
        - housing:apartment-purchased
        - housing:furniture-placed
        - housing:furniture-removed
        - housing:prestige-updated
        - housing:apartment-visited
      housing_events_consumed: |
        - character:level-up
        - guild:member-joined
        - friend:added
      endpoints:
        - GET /api/v1/world/housing/events/{apartment_id} - события квартиры

    - name: Housing Shop Manager
      location: world-service-go (модуль housing-shop)
      responsibility: |
        - Управление магазином мебели
        - Каталог мебели
        - Фильтрация и поиск
        - Покупка мебели
        - Интеграция с economy service
      shop_features: |
        - Каталог с фильтрацией
        - Поиск по категориям
        - Просмотр деталей
        - Покупка мебели
      endpoints:
        - GET /api/v1/world/housing/shop/catalog - каталог магазина
        - GET /api/v1/world/housing/shop/furniture/{furniture_id} - детали мебели
        - POST /api/v1/world/housing/shop/purchase - покупка мебели

  data_flow:
    apartment_purchase: |
      1. Игрок выбирает тип квартиры и локацию
      2. Apartment Manager проверяет доступность
      3. Economy Service проверяет наличие средств
      4. Economy Service списывает валюту
      5. Создаётся запись квартиры
      6. Housing Event Handler публикует housing:apartment-purchased
      7. Notification Service уведомляет игрока
      8. Realtime Gateway синхронизирует состояние

    furniture_placement: |
      1. Игрок выбирает мебель для размещения
      2. Furniture Placement System проверяет доступные слоты
      3. Проверяются коллизии и границы
      4. Мебель размещается в квартире
      5. Prestige Calculator пересчитывает престиж
      6. Functional Bonus Aggregator обновляет бонусы
      7. Housing Event Handler публикует housing:furniture-placed
      8. Realtime Gateway синхронизирует изменения

    apartment_visit: |
      1. Игрок запрашивает посещение квартиры
      2. Visit Manager проверяет настройки доступа
      3. Если доступ разрешён - загружается состояние квартиры
      4. Трекится посещение
      5. Housing Event Handler публикует housing:apartment-visited
      6. Notification Service уведомляет владельца
      7. Realtime Gateway синхронизирует состояние

  integrations:
    with_economy_service: |
      - Покупка квартир и мебели
      - Списание валюты
      - Интеграция с экономической системой

    with_social_service: |
      - Проверка друзей для доступа
      - Интеграция с системой друзей
      - Уведомления о посещениях

    with_guild_service: |
      - Покупка гильдейских залов
      - Проверка членства в гильдии
      - Интеграция с гильдиями

    with_character_service: |
      - Применение функциональных бонусов
      - Обновление характеристик
      - Интеграция с персонажем

    with_leaderboard_service: |
      - Лидерборд престижа
      - Обновление рейтингов
      - Интеграция с лидербордами

    with_notification_service: |
      - Уведомления о покупках
      - Уведомления о посещениях
      - Уведомления о престиже

    with_realtime_gateway: |
      - Синхронизация состояния квартир
      - Уведомления о событиях
      - Обновления в реальном времени

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для покупки квартир, размещения мебели, расчёта престижа и применения бонусов
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед покупкой квартиры и размещением мебели
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (покупка квартиры, размещение мебели, применение бонусов)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния жилья (покупка квартиры, размещение мебели, удаление мебели,
      обновление престижа, применение бонусов, посещение квартиры) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: ApartmentPurchasedEvent, FurniturePlacedEvent, FurnitureRemovedEvent, PrestigeUpdatedEvent, BonusAppliedEvent, ApartmentVisitedEvent.
    cqrs_pattern: |
      Разделение команд (покупка квартиры, размещение мебели, применение бонусов) и запросов
      (получение информации о квартире, получение каталога мебели, получение престижа) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как покупка квартиры (проверка средств, списание валюты,
      создание квартиры, уведомление игрока) или размещение мебели (проверка слотов, размещение мебели,
      пересчёт престижа, обновление бонусов, уведомление игрока), используется Saga Pattern
      для обеспечения атомарности операций между World Service, Economy Service, Character Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    apartment_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Покупка квартиры: event-based, ~0.001-0.01 events/sec на игрока
        - Получение информации о квартире: event-based, ~0.01-0.05 requests/sec на игрока
        - Обновление настроек доступа: event-based, ~0.001-0.01 events/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций квартир
      latency_requirements: < 200-300ms для покупки квартиры, < 30-100ms для получения информации
      sync_strategy: Strong Consistency (ACID транзакции) для покупки квартир

    furniture_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Покупка мебели: event-based, ~0.01-0.05 events/sec на игрока
        - Размещение мебели: event-based, ~0.01-0.1 events/sec на игрока
        - Перемещение мебели: event-based, ~0.01-0.1 events/sec на игрока
        - Удаление мебели: event-based, ~0.01-0.05 events/sec на игрока
        - Получение каталога мебели: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций мебели
      latency_requirements: < 100-200ms для размещения мебели, < 30-100ms для получения каталога
      sync_strategy: Strong Consistency (ACID транзакции) для размещения мебели

    prestige_operations:
      tickrate: Event-based (on-demand при изменении мебели) + 1-5 Hz для обновления лидерборда
      network_load: |
        - Расчёт престижа: event-based, ~0.01-0.05 events/sec на игрока
        - Получение престижа: event-based, ~0.01-0.02 requests/sec на игрока
        - Обновление лидерборда: 1-5 Hz, ~0.05-0.2 KB/sec
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций престижа
      latency_requirements: < 50-100ms для расчёта престижа, < 30-100ms для получения престижа
      sync_strategy: Strong Consistency (ACID транзакции) для расчёта престижа, Eventual Consistency для лидерборда

    bonus_operations:
      tickrate: Event-based (on-demand при изменении мебели)
      network_load: |
        - Агрегация бонусов: event-based, ~0.01-0.05 events/sec на игрока
        - Применение бонусов: event-based, ~0.01-0.05 events/sec на игрока
        - Получение бонусов: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций бонусов
      latency_requirements: < 50-150ms для применения бонусов, < 30-100ms для получения бонусов
      sync_strategy: Strong Consistency (ACID транзакции) для применения бонусов

    visit_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Посещение квартиры: event-based, ~0.01-0.05 events/sec на игрока
        - Загрузка состояния квартиры: event-based, ~0.01-0.05 requests/sec на игрока
        - Получение истории посещений: event-based, ~0.001-0.01 requests/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций посещений
      latency_requirements: < 200-300ms для посещения квартиры, < 100-200ms для загрузки состояния
      sync_strategy: Strong Consistency (ACID транзакции) для посещений

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий жилья: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_schema:
    tables:
      - name: apartments
        description: Квартиры игроков
        fields:
          - id: UUID (PK)
          - owner_id: UUID (FK accounts)
          - guild_id: UUID (FK guilds, nullable)
          - apartment_type: ENUM (STUDIO, STANDARD, PENTHOUSE, GUILD_HALL)
          - location_id: VARCHAR(100)
          - price: BIGINT
          - furniture_slots: INTEGER
