          - shard_x: INTEGER
          - shard_y: INTEGER
          - min_x: FLOAT
          - min_y: FLOAT
          - max_x: FLOAT
          - max_y: FLOAT
          - player_count: INTEGER
          - status: ENUM (active, syncing, full)
        indexes:
          - zone_id, shard_x, shard_y
          - server_id

      - name: cluster_servers
        description: Серверы в мультисерверном кластере
        fields:
          - id: UUID (PK)
          - cluster_id: UUID
          - server_id: UUID (FK game_instances)
          - shard_ids: UUID[] (array of shard IDs)
          - player_count: INTEGER
          - load_percentage: FLOAT
          - status: ENUM (active, syncing, overloaded, down)
          - last_sync: TIMESTAMP
        indexes:
          - cluster_id, status
          - server_id

technical_specification:
  backend_requirements:
    - Расширение realtime-gateway-go для поддержки WebSocket и UDP:
      - Модуль protocol-gateway (поддержка обоих протоколов)
      - Модуль protocol-switch-manager (динамическое переключение)
      - Модуль udp-gateway (UDP обработка)
      - Модуль session-manager (управление сессиями)
      - Модуль spatial-partitioning-engine (оптимизация средних битв)
      - Модуль spatial-sharding-manager (масштабирование больших битв)
      - Модуль cluster-coordinator (координация кластеров)
    - Расширение ws-lobby-go для поддержки WebSocket в MMORPG зонах
    - Интеграция с world-service для данных о зонах
    - Интеграция с gameplay-service для боевых событий
    - Интеграция с matchmaking-service для PvP инстансов

  protocol_requirements:
    - WebSocket (TCP):
      - Применение:
        - Безопасные зоны (Safe Zones): постоянно, без переключения
        - Открытый мир (Open World): по умолчанию, переключение на UDP при входе в бой
      - Tick rate: 20-30 Hz
      - Задержка: <100 мс
      - Надежная доставка сообщений
      - Поддержка TLS (wss://)
      - Данные: квесты, инвентарь, чат, торговля, социальные взаимодействия
    - UDP:
      - Применение:
        - Выделенные PvP зоны (Dedicated PvP Zones): постоянно, без переключения
        - Открытый мир (Open World): при входе в бой, переключение из WebSocket
      - Tick rate: 60-128 Hz (зависит от типа зоны)
      - Задержка: 5-50 мс
      - Собственная реализация надежности (sequence, ACK/NACK)
      - QoS управление (prioritization, packet ordering)
      - Anti-cheat валидация
      - Данные: позиции, выстрелы, урон, боевые события

  performance_requirements:
    - Protocol switching (только для открытого мира):
      - Время переключения: <1 секунда
      - Overlap период: 1-2 секунды (оба соединения активны)
      - Fallback: автоматический возврат на WebSocket при проблемах с UDP
    - Безопасные зоны (Safe Zones):
      - WebSocket: до 500 игроков на зону
      - Переключение: отключено (только WebSocket)
    - Открытый мир (Open World):
      - WebSocket (PvE режим): до 500 игроков на зону
      - UDP (PvP режим): зависит от количества игроков в бою
    - Выделенные PvP зоны (Dedicated PvP Zones):
      - UDP small PvP: 5-20 игроков, 60-128 Hz
      - UDP GvG 200: 200 игроков, 60-80 Hz, spatial partitioning
      - UDP GvG 400: 400 игроков, 40-60 Hz, spatial sharding (2-4 shards)
      - UDP massive war: 2000+ игроков, 20-40 Hz, cluster (5-10 servers)
    - Оптимизация:
      - Bandwidth optimization: 80-90% снижение через spatial partitioning
      - Event aggregation: батчинг 100 мс для больших битв

  scalability_requirements:
    - Горизонтальное масштабирование через пул инстансов
    - Автоскейлинг на основе нагрузки (количество игроков)
    - Распределение зон по инстансам
    - Edge-ноды для снижения задержки
    - Live-migration зон между инстансами

subtasks:
  - id: protocol-gateway-module
    title: Реализация Protocol Gateway модуля
    description: |
      Единая точка входа с поддержкой WebSocket и UDP:
      - Принятие соединений обоих типов
      - Маршрутизация к обработчикам
      - Балансировка нагрузки
    priority: high
    estimated_time: 6-7 дней

  - id: protocol-switch-manager-module
    title: Реализация Protocol Switch Manager модуля
    description: |
      Управление динамическим переключением протоколов:
      - Определение триггеров переключения
      - Синхронизация состояния
      - Координация overlap периода
      - Fallback механизм
    priority: high
    estimated_time: 7-8 дней

  - id: udp-gateway-module
    title: Реализация UDP Gateway модуля
    description: |
      Обработка UDP соединений для PvP зон:
      - Управление UDP соединениями
      - Надежность поверх UDP (sequence, ACK)
      - QoS управление
      - Anti-cheat валидация
    priority: high
    estimated_time: 8-10 дней

  - id: session-manager-module
    title: Реализация Session Manager модуля
    description: |
      Управление сессиями и состоянием переключения:
      - Создание и управление сессиями
      - Хранение состояния переключения
      - Синхронизация данных между протоколами
    priority: high
    estimated_time: 5-6 дней

  - id: spatial-partitioning-engine
    title: Реализация Spatial Partitioning Engine
    description: |
      Оптимизация для средних битв:
      - Разделение зон на сетку
      - Определение видимых игроков
      - Фильтрация обновлений
    priority: high
    estimated_time: 6-7 дней

  - id: spatial-sharding-manager
    title: Реализация Spatial Sharding Manager
    description: |
      Масштабирование для больших битв:
      - Разделение зон на shards
      - Распределение игроков по shards
      - Синхронизация между shards
    priority: high
    estimated_time: 7-8 дней

  - id: cluster-coordinator
    title: Реализация Cluster Coordinator
    description: |
      Координация мультисерверных кластеров:
      - Управление кластером серверов
      - Синхронизация состояния
      - LOD управление
      - Агрегация событий
    priority: medium
    estimated_time: 8-10 дней

  - id: database-schema
    title: Создание схемы БД для гибридной сети
    description: |
      Создание таблиц для протоколов, сессий, spatial partitioning и sharding:
      - zone_protocol_config
      - protocol_sessions
      - spatial_cells
      - spatial_shards
      - cluster_servers
    priority: high
    estimated_time: 3-4 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для гибридной сетевой системы:
      - Protocol Gateway endpoints
      - Protocol Switch Manager endpoints
      - Session Manager endpoints
      - Spatial Partitioning/Sharding endpoints
    priority: high
    estimated_time: 4-5 дней

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты протоколов и переключения:
      - Тесты WebSocket соединений
      - Тесты UDP соединений
      - Тесты динамического переключения
      - Тесты spatial partitioning/sharding
      - Тесты производительности
    priority: high
    estimated_time: 7-8 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Protocol Gateway"
            PG[Protocol Gateway<br/>WebSocket + UDP]
        end

        subgraph "Protocol Management"
            PSM[Protocol Switch Manager]
            SM[Session Manager]
        end

        subgraph "Protocol Handlers"
            WSH[WebSocket Gateway<br/>PvE Zones]
            UDH[UDP Gateway<br/>PvP Zones]
        end

        subgraph "Zone Management"
            ZM[Zone Manager]
            SPE[Spatial Partitioning<br/>200 players]
            SSM[Spatial Sharding<br/>400 players]
            CC[Cluster Coordinator<br/>2000+ players]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>zones<br/>protocol_sessions<br/>spatial_cells<br/>spatial_shards<br/>cluster_servers)]
        end

        subgraph "External Services"
            WS[World Service]
            GS[Gameplay Service]
            MS[Matchmaking Service]
            CS[Character Service]
        end

        subgraph "Clients"
            CL[UE5 Client<br/>WebSocket/UDP]
        end

        CL -->|WebSocket/UDP| PG
        PG --> PSM
        PSM --> SM
        PSM -->|route| WSH
        PSM -->|route| UDH
        WSH --> ZM
        UDH --> ZM
        ZM --> SPE
        ZM --> SSM
        ZM --> CC
        SM --> DB
        ZM --> DB
        ZM --> WS
        WSH --> GS
        UDH --> GS
        ZM --> MS
    ```

  protocol_switching_flow: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant PG as Protocol Gateway
        participant PSM as Protocol Switch Manager
        participant SM as Session Manager
        participant WSH as WebSocket Handler
        participant UDH as UDP Handler

        C->>PG: WebSocket connection (PvE)
        PG->>WSH: Route to WebSocket handler
        WSH->>SM: Create session (websocket_only)
        Note over C,UDH: Player enters combat
        
        C->>PSM: Request protocol switch (PvE→PvP)
        PSM->>SM: Get session state
        SM->>PSM: Current state (websocket_only)
        PSM->>WSH: Sync critical data
        WSH->>C: Send critical state
        
        PSM->>UDH: Create UDP connection
        UDH->>C: Establish UDP connection
        SM->>SM: Update session (dual mode)
        
        Note over C,UDH: Overlap period (1-2 sec)
        WSH->>C: Updates via WebSocket
        UDH->>C: Updates via UDP
        
        C->>PSM: Confirm UDP ready
        PSM->>SM: Update session (udp_only)
        PSM->>WSH: Close WebSocket (or idle)
        Note over C,UDH: Player in PvP mode (UDP only)
    ```

  large_battle_architecture: |
    ```mermaid
    graph TB
        subgraph "Massive War Zone (2000 players)"
            subgraph "Cluster Coordinator"
                CC[Cluster Coordinator]
            end
            
            subgraph "Server 1"
                S1[Game Server 1]
                SH1[Shard 1-1<br/>200 players]
                SH2[Shard 1-2<br/>200 players]
            end
            
            subgraph "Server 2"
                S2[Game Server 2]
                SH3[Shard 2-1<br/>200 players]
                SH4[Shard 2-2<br/>200 players]
            end
            
            subgraph "Server 3"
                S3[Game Server 3]
                SH5[Shard 3-1<br/>200 players]
                SH6[Shard 3-2<br/>200 players]
            end
            
            CC --> S1
            CC --> S2
            CC --> S3
            S1 --> SH1
            S1 --> SH2
            S2 --> SH3
            S2 --> SH4
            S3 --> SH5
            S3 --> SH6
            
            SH1 -.->|Edge Sync| SH2
            SH2 -.->|Edge Sync| SH3
            SH3 -.->|Edge Sync| SH4
        end
    ```

decisions:
  - id: adr-hybrid-protocol-architecture
    summary: |
      Выбрана гибридная архитектура с:
      - WebSocket для безопасных зон (PvP отключен) и открытого мира (PvE режим)
      - UDP для выделенных PvP зон и боевых действий в открытом мире
      - Динамическим переключением протоколов WebSocket ↔ UDP только в открытом мире

  - id: adr-protocol-switching
    summary: |
      Реализован механизм динамического переключения с overlap периодом (1-2 секунды)
      для бесшовной миграции между протоколами без потери данных.

  - id: adr-spatial-optimization
    summary: |
      Использован spatial partitioning (grid 100x100 м) для средних битв и spatial sharding
      для больших битв для масштабирования до 2000+ игроков.

  - id: adr-udp-reliability
    summary: |
      Реализована собственная система надежности поверх UDP (sequence numbers, ACK/NACK)
      вместо использования QUIC из-за проблем совместимости между MsQuic (UE5) и quic-go (Go).

  - id: adr-cluster-architecture
    summary: |
      Использован мультисерверный кластер с spatial sharding и edge synchronization
      для поддержки масштабных войн до 2000+ игроков.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация протокола переключения
  - Создание схем сообщений для WebSocket и UDP
  - Определение формата данных для синхронизации состояния

history:
  - version: "1.0.0"
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура гибридной сетевой системы:
      - Определены микросервисы (Protocol Gateway, Protocol Switch Manager, WebSocket Gateway, UDP Gateway, Zone Manager, Session Manager, Spatial Partitioning Engine, Spatial Sharding Manager, Cluster Coordinator)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных и переключение протоколов
      - Определена структура БД (zone_protocol_config, protocol_sessions, spatial_cells, spatial_shards, cluster_servers)
      - Спроектирована архитектура для различных типов зон (PvE, малые PvP, GvG 200/400, massive war 2000+)
      - Спроектированы стратегии оптимизации (spatial partitioning, sharding, clustering)
      - Создано техническое задание
      - Разбито на подзадачи

