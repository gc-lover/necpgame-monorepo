metadata:
  id: hybrid-network-system-architecture
  title: Архитектура гибридной сетевой системы (WebSocket/UDP)
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-29T12:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - networking
    - websocket
    - udp
    - hybrid
    - realtime
  related_systems:
    - realtime-gateway-go
    - ws-lobby-go
    - matchmaking-go
    - world-service-go
  related_documents:
    - id: network-architecture-analysis
      relation: extends
    - id: realtime-server-system-architecture
      relation: extends
  github_issue: 11
  visibility: internal
  audience:
    - architect
    - backend
    - infrastructure
    - api-designer

summary:
  problem: |
    Требуется спроектировать гибридную сетевую архитектуру с динамическим переключением
    между WebSocket (TCP) и UDP протоколами для оптимальной производительности в различных
    режимах игры: MMORPG зоны (PvE/PvP), малые PvP зоны, GvG битвы (200-400 игроков),
    масштабные войны (2000+ игроков).
  goal: |
    Создать архитектурную схему гибридной сетевой системы с определением:
    - Микросервисов для поддержки WebSocket и UDP
    - Механизма динамического переключения протоколов
    - Архитектуры для различных типов зон и масштабов битв
    - Стратегий оптимизации и масштабирования
    - API endpoints (высокоуровнево)
    - Технического задания для реализации
  essence: |
    Гибридная сетевая архитектура с:
    - WebSocket для безопасных зон (PvP отключен) и открытого мира (PvE режим)
    - UDP для выделенных PvP зон и боевых действий в открытом мире
    - Динамическим переключением протоколов WebSocket ↔ UDP в открытом мире
    - Масштабированием для больших битв (200-2000+ игроков)

architecture:
  overview: |
    Гибридная сетевая система состоит из следующих компонентов:
    1. Protocol Gateway - единая точка входа с поддержкой WebSocket и UDP
    2. Protocol Switch Manager - управление динамическим переключением протоколов (только для открытого мира)
    3. WebSocket Gateway - обработка WebSocket соединений (безопасные зоны и открытый мир в PvE режиме)
    4. UDP Gateway - обработка UDP соединений (выделенные PvP зоны и открытый мир в PvP режиме)
    5. Zone Manager - управление зонами и выбор протокола (определение типа зоны: безопасная/открытый мир/выделенная PvP)
    6. Session Manager - управление сессиями и состояние переключения
    7. Spatial Partitioning Engine - оптимизация для средних битв (200 игроков)
    8. Spatial Sharding Manager - масштабирование для больших битв (400+ игроков)
    9. Cluster Coordinator - координация мультисерверных кластеров (2000+ игроков)

  microservices:
    - name: protocol-gateway
      location: realtime-gateway-go (расширение)
      responsibility: |
        Единая точка входа для всех сетевых соединений:
        - Принятие WebSocket соединений (ws://, wss://)
        - Принятие UDP соединений (udp://)
        - Маршрутизация к соответствующему обработчику
        - Балансировка нагрузки между инстансами
      protocol_support:
        - WebSocket (TCP) на портах 8080, 8443 (TLS)
        - UDP на портах 18080, 18081-18100 (диапазон для кластеров)
        - Поддержка TLS для WebSocket (wss://)
      endpoints:
        - WS /ws/game - WebSocket endpoint для игры
        - WS /ws/lobby - WebSocket endpoint для лобби
        - UDP :18080 - UDP endpoint для PvP зон
        - GET /api/v1/gateway/status - статус gateway
        - GET /api/v1/gateway/protocols - поддерживаемые протоколы
        - POST /api/v1/gateway/switch-protocol - запрос на переключение протокола

    - name: protocol-switch-manager
      location: realtime-gateway-go (новый модуль)
      responsibility: |
        Управление динамическим переключением протоколов:
        - Определение триггеров переключения (вход/выход из боя)
        - Синхронизация состояния между протоколами
        - Координация overlap периода (оба соединения активны)
        - Fallback на WebSocket при проблемах с UDP
      switch_triggers:
        - Open world (WebSocket) → PvP (UDP):
            - Вход в боевой режим (детекция врагов)
            - Активация боевых способностей
            - Вход в зону боевых действий
        - PvP (UDP) → Open world (WebSocket):
            - Выход из боя (отсутствие врагов 5+ секунд)
            - Выход из зоны боевых действий
            - Деактивация боевых способностей
        - Safe zones (безопасные зоны):
            - Переключение отключено (только WebSocket)
        - Dedicated PvP zones (выделенные PvP зоны):
            - Переключение отключено (только UDP)
        - Fallback:
            - UDP недоступен: Автоматический fallback на WebSocket
            - Проблемы с UDP соединением: Возврат на WebSocket
      switch_mechanics: |
        1. Запрос на переключение от клиента или сервера
        2. Синхронизация состояния через WebSocket (критичные данные)
        3. Установка нового соединения (UDP или WebSocket)
        4. Overlap период (1-2 секунды): оба соединения активны
        5. Миграция всех обновлений на новый протокол
        6. Закрытие старого соединения после подтверждения
        7. Время переключения: 0.5-1 секунда
      endpoints:
        - POST /api/v1/protocol/switch/request - запрос на переключение
        - POST /api/v1/protocol/switch/sync - синхронизация состояния
        - GET /api/v1/protocol/switch/status - статус переключения

    - name: websocket-gateway
      location: ws-lobby-go (расширение) + realtime-gateway-go
      responsibility: |
        Обработка WebSocket соединений для MMORPG зон:
        - Управление WebSocket соединениями
        - Обработка сообщений через WebSocket
        - Поддержка топиков (zone, character, world, chat)
        - Heartbeat и keepalive
      zone_types:
        - Safe zones (безопасные зоны - города, торговые зоны):
            - PvP отключен полностью
            - Протокол: WebSocket (постоянно, без переключения)
            - Применение: города, торговые зоны, лобби
        - Open world zones (открытый мир - PvE зоны с возможностью PvP):
            - PvP возможен
            - Протокол: WebSocket по умолчанию, UDP при входе в бой (динамическое переключение)
            - Применение: открытый мир, квестовые зоны, исследовательские зоны
        - Social zones (социальные зоны):
            - PvP отключен
            - Протокол: WebSocket (постоянно)
            - Применение: лобби, торговые зоны, социальные хабы
      features:
        - Tick rate: 20-30 Hz для PvE зон
        - Задержка: <100 мс
        - Поддержка до 500 игроков на зону
        - Надежная доставка сообщений
      endpoints:
        - WS /ws/game - основное WebSocket соединение
        - WS /ws/lobby - WebSocket для лобби
        - POST /api/v1/websocket/connections/{id}/subscribe - подписка на топик
        - POST /api/v1/websocket/connections/{id}/unsubscribe - отписка

    - name: udp-gateway
      location: realtime-gateway-go (новый модуль)
      responsibility: |
        Обработка UDP соединений для PvP зон:
        - Управление UDP соединениями
        - Обработка UDP пакетов (Protobuf)
        - Поддержка надежности поверх UDP (sequence numbers, ACK/NACK)
        - QoS управление (prioritization, packet ordering)
      zone_types:
        - Small PvP zones (5-20 игроков)
        - GvG zones (200-400 игроков)
        - Massive war zones (2000+ игроков)
      features:
        - Tick rate: 60-128 Hz (зависит от типа зоны)
        - Задержка: 5-50 мс
        - Надежность: собственная реализация (sequence, ACK)
        - Anti-cheat: валидация пакетов, rate limiting
      endpoints:
        - UDP :18080 - основной UDP endpoint
        - UDP :18081-18100 - UDP endpoints для кластеров
        - GET /api/v1/udp/connections/{id}/stats - статистика UDP соединения
        - POST /api/v1/udp/test - тест UDP соединения

    - name: zone-manager
      location: realtime-gateway-go (расширение модуля zone-manager)
      responsibility: |
        Управление зонами и выбор протокола:
        - Определение типа зоны (PvE/PvP)
        - Выбор оптимального протокола
        - Управление лимитами игроков
        - Мониторинг производительности зон
      zone_protocol_mapping:
        - Safe zones (безопасные зоны):
            - Протокол: WebSocket (TCP) - постоянно
            - PvP: отключен
            - Переключение: нет (только WebSocket)
        - Open world zones (открытый мир):
            - Протокол по умолчанию: WebSocket (TCP)
            - Протокол в бою: UDP (динамическое переключение)
            - PvP: возможен
            - Переключение: WebSocket ↔ UDP (автоматическое)
        - Dedicated PvP zones (выделенные PvP зоны):
            - Протокол: UDP - постоянно
            - PvP: всегда включен
            - Переключение: нет (только UDP)
            - Типы: малые арены (5-20), GvG 200, GvG 400, Massive war 2000+
        - Small PvP zones (5-20 игроков):
            - Протокол: UDP + Spatial Partitioning
        - GvG zones (200 игроков):
            - Протокол: UDP + Spatial Partitioning
        - GvG zones (400 игроков):
            - Протокол: UDP + Spatial Sharding
        - Massive war (2000+ игроков):
            - Протокол: UDP + Cluster + Sharding
      endpoints:
        - GET /api/v1/zones - список зон
        - GET /api/v1/zones/{id} - информация о зоне
        - GET /api/v1/zones/{id}/protocol - рекомендуемый протокол
        - POST /api/v1/zones/{id}/join - присоединение к зоне

    - name: session-manager
      location: realtime-gateway-go (новый модуль)
      responsibility: |
        Управление сессиями и состоянием переключения:
        - Создание и управление сессиями
        - Хранение состояния переключения протоколов
        - Синхронизация данных между протоколами
        - Восстановление сессий после разрывов
      session_states:
        - websocket_only: только WebSocket соединение
        - udp_only: только UDP соединение
        - switching: процесс переключения
        - dual: оба соединения активны (overlap)
      endpoints:
        - GET /api/v1/sessions/{id} - информация о сессии
        - POST /api/v1/sessions/{id}/switch - переключение протокола
        - GET /api/v1/sessions/{id}/state - состояние переключения

    - name: spatial-partitioning-engine
      location: realtime-gateway-go (новый модуль)
      responsibility: |
        Оптимизация для средних битв (100-400 игроков):
        - Разделение зоны на сетку (grid) 100x100 м
        - Определение видимых игроков (своя ячейка + 8 соседних)
        - Фильтрация обновлений по близости
        - Приоритезация обновлений
      optimization:
        - Grid size: 100x100 метров
        - Visibility: своя ячейка + 8 соседних (3x3)
        - Traffic reduction: 80-90%
        - Max updates per tick: 50-100 (зависит от зоны)
      endpoints:
        - GET /api/v1/spatial/{zone_id}/cells - ячейки зоны
        - GET /api/v1/spatial/{zone_id}/cells/{x}/{y}/players - игроки в ячейке
        - POST /api/v1/spatial/{zone_id}/update - обновление позиции

    - name: spatial-sharding-manager
      location: realtime-gateway-go (новый модуль)
      responsibility: |
        Масштабирование для больших битв (400-2000 игроков):
        - Разделение зоны на shards (серверы)
        - Распределение игроков по shards по координатам
        - Синхронизация между shards
        - Edge synchronization (границы shards)
      sharding_strategy:
        - 400 игроков: 2-4 shards
        - 1000 игроков: 5-7 shards
        - 2000 игроков: 8-10 shards
        - Shard size: ~200x200 метров
        - Edge buffer: 50 метров (пересекающиеся зоны)
      endpoints:
        - GET /api/v1/sharding/{zone_id}/shards - shards зоны
        - GET /api/v1/sharding/{zone_id}/shard/{id}/players - игроки в shard
        - POST /api/v1/sharding/{zone_id}/sync - синхронизация между shards

    - name: cluster-coordinator
      location: realtime-gateway-go (новый модуль) + отдельный сервис
      responsibility: |
        Координация мультисерверных кластеров (2000+ игроков):
        - Управление кластером серверов
        - Распределение нагрузки
        - Синхронизация состояния между серверами
        - LOD (Level of Detail) управление
        - Агрегация событий
      cluster_features:
        - Server count: 5-10 серверов
        - Spatial sharding по серверам
        - Event aggregation (батчинг 100 мс)
        - LOD для дальних объектов (снижение детализации)
        - Global state synchronization
      endpoints:
        - GET /api/v1/cluster/status - статус кластера
        - GET /api/v1/cluster/servers - серверы в кластере
        - POST /api/v1/cluster/sync - синхронизация кластера

  data_flow:
    protocol_switching: |
      1. Игрок в PvE зоне (WebSocket), детектируется вход в бой
      2. Protocol Switch Manager получает запрос на переключение
      3. Синхронизация критичных данных через WebSocket (инвентарь, здоровье)
      4. Установка UDP соединения параллельно с WebSocket
      5. Overlap период (1-2 сек): оба соединения получают обновления
      6. Миграция всех обновлений на UDP
      7. Подтверждение от клиента о получении UDP обновлений
      8. Закрытие WebSocket соединения (или переход в idle режим)
      9. Игрок в PvP режиме (UDP только)

    zone_joining: |
      1. Игрок запрашивает присоединение к зоне
      2. Zone Manager определяет тип зоны и рекомендуемый протокол
      3. Protocol Gateway устанавливает соединение (WebSocket или UDP)
      4. Session Manager создает сессию
      5. Для PvP зон: Spatial Partitioning/Sharding добавляет игрока в ячейку/shard
      6. Начальная синхронизация состояния
      7. Игрок получает обновления через выбранный протокол

    large_battle_optimization: |
      1. GvG битва 400 игроков начинается
      2. Spatial Sharding Manager делит зону на 4 shards
      3. Игроки распределяются по shards по координатам
      4. Каждый shard обрабатывается отдельным сервером
      5. Edge synchronization обеспечивает синхронизацию на границах
      6. Spatial Partitioning внутри каждого shard (grid 100x100 м)
      7. LOD снижает детализацию для дальних объектов
      8. Event aggregation группирует события в батчи
      9. Клиенты получают оптимизированные обновления через UDP

  integrations:
    with_world_service: |
      - Получение данных о зонах
      - Синхронизация мировых событий
      - Управление NPC и объектами

    with_gameplay_service: |
      - Обработка боевых событий
      - Валидация боевых действий
      - Синхронизация боевого состояния

    with_matchmaking_service: |
      - Создание PvP инстансов
      - Распределение игроков по зонам
      - Управление очередями

    with_character_service: |
      - Получение данных о персонажах
      - Синхронизация позиций
      - Обновление статов

  database_schema:
    tables:
      - name: zone_protocol_config
        description: Конфигурация протоколов для зон
        fields:
          - zone_id: UUID (PK, FK zones)
          - default_protocol: ENUM (websocket, udp)
          - supports_switching: BOOLEAN
          - min_players_for_udp: INTEGER
          - tick_rate_websocket: INTEGER
          - tick_rate_udp: INTEGER
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: protocol_sessions
        description: Сессии переключения протоколов
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - character_id: UUID (FK characters)
          - zone_id: UUID (FK zones)
          - current_protocol: ENUM (websocket, udp, switching, dual)
          - websocket_connection_id: UUID (nullable)
          - udp_connection_id: UUID (nullable)
          - switch_state: JSONB (состояние переключения)
          - last_protocol_switch: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: spatial_cells
        description: Ячейки spatial partitioning
        fields:
          - id: UUID (PK)
          - zone_id: UUID (FK zones)
          - shard_id: UUID (FK shards, nullable)
          - cell_x: INTEGER
          - cell_y: INTEGER
          - min_x: FLOAT
          - min_y: FLOAT
          - max_x: FLOAT
          - max_y: FLOAT
          - player_count: INTEGER
        indexes:
          - zone_id, cell_x, cell_y
          - shard_id, cell_x, cell_y

      - name: spatial_shards
        description: Shards для больших битв
        fields:
          - id: UUID (PK)
          - zone_id: UUID (FK zones)
          - server_id: UUID (FK game_instances)
