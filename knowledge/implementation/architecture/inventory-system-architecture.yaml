metadata:
  id: inventory-system-architecture
  title: Архитектура системы инвентаря
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T18:45:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - inventory
    - backend
    - economy
  related_systems:
    - economy-service-go
    - character-service-go
    - loot-system
    - trade-system
  related_documents:
    - id: backend-inventory-part1-core
      relation: extends
    - id: backend-inventory-part2-advanced
      relation: extends
  github_issue: 135
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы инвентаря
    для управления предметами игроков, экипировкой, хранением, stacking,
    весом и интеграцией с другими системами.
  goal: |
    Создать архитектурную схему системы инвентаря с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Технического задания для реализации
  essence: |
    Комплексная система управления инвентарём с поддержкой backpack, equipment,
    bank/stash, stacking, веса, экипировки и интеграцией с торговлей, лутом и персонажами.

architecture:
  overview: |
    Система инвентаря состоит из пяти основных компонентов:
    1. Inventory Manager - управление инвентарём персонажа
    2. Equipment Manager - управление экипировкой
    3. Storage Manager - управление банком/стэшем
    4. Item Stack Manager - управление стеками предметов
    5. Weight Calculator - расчёт веса и ограничений

  components:
    - name: Inventory Manager
      location: economy-service-go (модуль inventory)
      responsibility: |
        - Управление инвентарём персонажа (backpack)
        - CRUD операции с предметами
        - Управление слотами инвентаря
        - Поиск свободных слотов
        - Оптимизация размещения предметов
        - Синхронизация с character-service
      port: 8086 (economy-service-go)
      endpoints:
        - GET /api/v1/economy/inventory/{character_id} - получение инвентаря
        - POST /api/v1/economy/inventory/{character_id}/items - добавление предмета
        - PUT /api/v1/economy/inventory/{character_id}/items/{item_id} - обновление предмета
        - DELETE /api/v1/economy/inventory/{character_id}/items/{item_id} - удаление предмета
        - POST /api/v1/economy/inventory/{character_id}/items/{item_id}/move - перемещение предмета
        - POST /api/v1/economy/inventory/{character_id}/items/{item_id}/split - разделение стека
        - POST /api/v1/economy/inventory/{character_id}/items/{item_id}/merge - объединение стеков
        - GET /api/v1/economy/inventory/{character_id}/free-slots - свободные слоты

    - name: Equipment Manager
      location: economy-service-go (модуль equipment)
      responsibility: |
        - Управление экипировкой персонажа
        - Проверка требований для экипировки
        - Применение статов от экипировки
        - Управление слотами экипировки (weapon, armor, implants, etc.)
        - Снятие экипировки
        - Валидация совместимости предметов
      integration: |
        Интегрируется с character-service для применения статов
        Синхронизирует изменения с progression system
      endpoints:
        - GET /api/v1/economy/inventory/{character_id}/equipment - получение экипировки
        - POST /api/v1/economy/inventory/{character_id}/equipment/equip - экипировка предмета
        - POST /api/v1/economy/inventory/{character_id}/equipment/unequip - снятие предмета
        - GET /api/v1/economy/inventory/{character_id}/equipment/stats - статы от экипировки

    - name: Storage Manager
      location: economy-service-go (модуль storage)
      responsibility: |
        - Управление банком/стэшем персонажа
        - Расширение хранилища
        - Перемещение предметов между инвентарём и банком
        - Управление несколькими хранилищами (личный банк, гильдия)
        - Оптимизация хранения
      endpoints:
        - GET /api/v1/economy/inventory/{character_id}/storage - получение хранилища
        - POST /api/v1/economy/inventory/{character_id}/storage/items - добавление в хранилище
        - POST /api/v1/economy/inventory/{character_id}/storage/transfer - перемещение между инвентарём и хранилищем
        - POST /api/v1/economy/inventory/{character_id}/storage/expand - расширение хранилища

    - name: Item Stack Manager
      location: economy-service-go (модуль item-stack)
      responsibility: |
        - Управление стеками предметов
        - Объединение стеков одинаковых предметов
        - Разделение стеков
        - Проверка максимального размера стека
        - Оптимизация размещения стеков
      endpoints:
        - POST /api/v1/economy/inventory/{character_id}/items/{item_id}/stack - операции со стеком
        - GET /api/v1/economy/inventory/{character_id}/items/{item_id}/stack-info - информация о стеке

    - name: Weight Calculator
      location: economy-service-go (модуль weight)
      responsibility: |
        - Расчёт веса инвентаря
        - Проверка ограничений по весу
        - Валидация возможности подбора предмета
        - Расчёт перегрузки
        - Применение модификаторов веса
      integration: |
        Использует характеристики персонажа из character-service
        Применяет модификаторы от экипировки и перков
      endpoints:
        - GET /api/v1/economy/inventory/{character_id}/weight - текущий вес
        - GET /api/v1/economy/inventory/{character_id}/weight/limit - лимит веса
        - POST /api/v1/economy/inventory/{character_id}/weight/validate - валидация веса

  data_flow:
    item_pickup: |
      1. Игрок подбирает предмет (loot или trade)
      2. Weight Calculator проверяет возможность подбора (вес, лимиты)
      3. Item Stack Manager проверяет возможность объединения со стеком
      4. Inventory Manager ищет свободный слот
      5. Предмет добавляется в инвентарь
      6. Weight Calculator обновляет вес
      7. Character-service обновляет характеристики
      8. Realtime Gateway синхронизирует изменения

    item_equip: |
      1. Игрок экипирует предмет
      2. Equipment Manager проверяет требования (уровень, класс, характеристики)
      3. Проверяется совместимость с текущей экипировкой
      4. Предмет перемещается из инвентаря в слот экипировки
      5. Character-service применяет статы от предмета
      6. Equipment Manager обновляет состояние экипировки
      7. Realtime Gateway синхронизирует изменения

    item_storage: |
      1. Игрок перемещает предмет в хранилище
      2. Storage Manager проверяет доступность хранилища
      3. Проверяется лимит хранилища
      4. Предмет перемещается из инвентаря в хранилище
      5. Weight Calculator обновляет вес инвентаря
      6. Realtime Gateway синхронизирует изменения

  integrations:
    with_character_service: |
      - Получение характеристик персонажа для проверки требований
      - Применение статов от экипировки
      - Обновление веса персонажа
      - Синхронизация изменений

    with_loot_system: |
      - Получение предметов после боя/квестов
      - Интеграция с системой генерации лута
      - Валидация подбора предметов

    with_trade_system: |
      - Проверка владения предметами для торговли
      - Блокировка предметов во время торговли
      - Перемещение предметов после обмена

    with_realtime_gateway: |
      - Realtime синхронизация изменений инвентаря
      - Push уведомления о новых предметах
      - Синхронизация экипировки

  database_schema:
    tables:
      - name: character_inventory
        description: Инвентарь персонажа
        fields:
          - character_id: UUID (PK, FK)
          - max_slots: INTEGER
          - current_weight: FLOAT
          - max_weight: FLOAT
          - updated_at: TIMESTAMP
        indexes:
          - character_id

      - name: character_items
        description: Предметы в инвентаре
        fields:
          - id: UUID (PK)
          - character_id: UUID (FK)
          - item_template_id: UUID (FK item_templates)
          - slot_index: INTEGER
          - stack_size: INTEGER
          - durability: INTEGER (nullable)
          - bind_status: ENUM (unbound, bound, account_bound)
          - modifiers: JSONB (модификаторы предмета)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - character_id, slot_index
          - character_id, item_template_id

      - name: character_equipment
        description: Экипировка персонажа
        fields:
          - character_id: UUID (PK, FK)
          - slot_type: ENUM (weapon_primary, weapon_secondary, armor_head, armor_body, armor_legs, implant_1, implant_2, etc.)
          - item_id: UUID (FK character_items)
          - equipped_at: TIMESTAMP
        indexes:
          - character_id, slot_type

      - name: character_storage
        description: Хранилище персонажа (банк/стэш)
        fields:
          - id: UUID (PK)
          - character_id: UUID (FK)
          - storage_type: ENUM (personal_bank, guild_bank, stash)
          - max_slots: INTEGER
          - current_weight: FLOAT
          - max_weight: FLOAT
          - updated_at: TIMESTAMP
        indexes:
          - character_id, storage_type

      - name: storage_items
        description: Предметы в хранилище
        fields:
          - id: UUID (PK)
          - storage_id: UUID (FK character_storage)
          - item_template_id: UUID (FK item_templates)
          - slot_index: INTEGER
          - stack_size: INTEGER
          - durability: INTEGER (nullable)
          - bind_status: ENUM
          - modifiers: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - storage_id, slot_index

      - name: item_templates
        description: Шаблоны предметов
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - item_type: ENUM (weapon, armor, consumable, material, quest_item, etc.)
          - rarity: ENUM (common, uncommon, rare, epic, legendary)
          - weight: FLOAT
          - max_stack_size: INTEGER
          - bind_on_pickup: BOOLEAN
          - requirements: JSONB (требования для использования)
          - stats: JSONB (базовые статы)
          - created_at: TIMESTAMP
        indexes:
          - item_type, rarity

technical_specification:
  backend_requirements:
    - Реализация модулей в economy-service-go:
      - inventory (управление инвентарём)
      - equipment (управление экипировкой)
      - storage (управление хранилищем)
      - item-stack (управление стеками)
      - weight (расчёт веса)
    - Интеграция с character-service для характеристик
    - Интеграция с loot-system для получения предметов
    - Интеграция с trade-system для торговли
    - Оптимизация запросов к БД (batch, индексы)

  performance_requirements:
    - Получение инвентаря < 50ms
    - Добавление предмета < 30ms
    - Экипировка предмета < 50ms
    - Поддержка до 1000 слотов в инвентаре
    - Поддержка до 10000 предметов на персонажа
    - Кэширование активных инвентарей

  scalability_requirements:
    - Горизонтальное масштабирование через economy-service
    - Распределение нагрузки на инвентари
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование активных инвентарей в памяти (Redis)

  data_consistency:
    strategy: Strong Consistency (ACID транзакции)
    mechanisms:
      - ACID транзакции для операций с предметами
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед сохранением изменений
      - Синхронизация с character-service через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных транзакций (trade, loot)

  data_synchronization:
    event_sourcing: |
      Все изменения инвентаря записываются как события:
      - ItemAddedEvent - предмет добавлен
      - ItemRemovedEvent - предмет удален
      - ItemMovedEvent - предмет перемещен
      - ItemEquippedEvent - предмет экипирован
      - ItemUnequippedEvent - предмет снят
      - StackMergedEvent - стеки объединены
      - StackSplitEvent - стек разделен
      
      События хранятся в Event Store (Kafka topics) для:
      - Восстановления состояния инвентаря
      - Аудит-лога операций
      - Синхронизации с другими сервисами
      - Аналитики и мониторинга

    cqrs_pattern: |
      Разделение команд и запросов:
      - Write Model: Inventory Manager обрабатывает команды (add, remove, move, equip)
      - Read Model: Оптимизированные представления для быстрого чтения
      - Projections: Материализованные представления для частых запросов
      - Event Handlers: Обработка событий для обновления read-моделей

    saga_pattern: |
      Для распределенных транзакций:
      - Trade Saga: обмен предметами между игроками
      - Loot Saga: получение предметов после боя/квестов
      - Storage Transfer Saga: перемещение между инвентарём и хранилищем
      
      Компенсирующие транзакции:
      - Откат изменений при ошибках
      - Восстановление состояния при сбоях

    outbox_pattern: |
      Гарантированная доставка событий:
      - Запись событий в outbox таблицу в той же транзакции
      - Outbox Processor публикует события в Event Bus
      - Retry механизм для failed событий
      - Идемпотентность обработки событий

  tickrate_specification:
    inventory_operations:
      tickrate: Event-based (on-demand)
      description: |
        Операции с инвентарём выполняются по требованию (event-based),
        не требуют постоянного тикрейта.
      network_load: |
        - Изменения инвентаря: event-based, ~5-10 events/sec
        - Синхронизация состояния: при изменении, ~1-2 updates/sec
        - Общий трафик: ~0.5-1 KB/sec на игрока
      sync_strategy: Strong Consistency (ACID транзакции)
      latency_requirements: |
        - Получение инвентаря: < 50ms
        - Добавление предмета: < 30ms
        - Экипировка предмета: < 50ms
        - Перемещение предмета: < 30ms

subtasks:
  - id: inventory-manager-module
    title: Реализация модуля Inventory Manager
    description: |
      Создание модуля управления инвентарём
      CRUD операции с предметами
      Управление слотами
    priority: high
    estimated_time: 4-5 дней

  - id: equipment-manager
    title: Реализация Equipment Manager
    description: |
      Управление экипировкой
      Проверка требований
      Применение статов
    priority: high
    estimated_time: 3-4 дня

  - id: storage-manager
    title: Реализация Storage Manager
    description: |
      Управление хранилищем
      Перемещение предметов
      Расширение хранилища
    priority: medium
    estimated_time: 2-3 дня

  - id: item-stack-manager
    title: Реализация Item Stack Manager
    description: |
      Управление стеками предметов
