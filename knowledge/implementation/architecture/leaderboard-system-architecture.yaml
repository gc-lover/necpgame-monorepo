metadata:
  id: leaderboard-system-architecture
  title: Архитектура системы лидербордов (Leaderboard System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-22T21:15:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - leaderboard
    - backend
    - world
    - rankings
  related_systems:
    - world-service-go
    - social-service-go
    - character-service-go
    - achievement-service-go
    - gameplay-service-go
  related_documents:
    - id: backend-leaderboard-system
      relation: extends
    - id: implementation-leaderboard-core
      relation: references
  github_issue: 140
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы лидербордов
    для управления глобальными, сезонными, дружественными и гильдийными рейтингами
    с поддержкой real-time обновлений и высокой производительности.
  goal: |
    Создать архитектурную схему системы лидербордов с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Стратегии кэширования (Redis)
    - Системы обновления рейтингов
    - Технического задания для реализации
  essence: |
    Система лидербордов управляет различными типами рейтингов (глобальные, сезонные,
    дружественные, гильдийные) с использованием Redis для hot data и PostgreSQL для
    персистентного хранения, обеспечивая real-time обновления и сезонные сбросы.

architecture:
  overview: |
    Система лидербордов состоит из пяти основных компонентов:
    1. Leaderboard Manager - управление рейтингами и типами лидербордов
    2. Score Calculator - расчёт очков и метрик
    3. Ranking Engine - обновление позиций и рангов
    4. Season Manager - управление сезонами и сбросами
    5. Cache Manager - управление кэшированием в Redis

  components:
    - name: Leaderboard Manager
      location: world-service-go (модуль leaderboard)
      responsibility: |
        - Управление типами лидербордов (global, class, seasonal, friend, guild)
        - Создание и конфигурация лидербордов
        - Получение рейтингов и позиций игроков
        - Управление областями видимости (scope)
        - Интеграция с другими сервисами
      port: 8085 (world-service-go)
      endpoints:
        - GET /api/v1/world/leaderboards - список лидербордов
        - GET /api/v1/world/leaderboards/{leaderboard_id} - получение лидерборда
        - GET /api/v1/world/leaderboards/{leaderboard_id}/top - топ игроков
        - GET /api/v1/world/leaderboards/{leaderboard_id}/rank/{player_id} - позиция игрока
        - GET /api/v1/world/leaderboards/{leaderboard_id}/around/{player_id} - соседи игрока

    - name: Score Calculator
      location: world-service-go (модуль leaderboard-scoring)
      responsibility: |
        - Расчёт очков для различных метрик
        - Функции расчёта overall power, combat score
        - Учёт уровня, экипировки, навыков, достижений
        - Обработка различных типов метрик
      scoring_functions: |
        - calculate_overall_power: уровень, экипировка, навыки, достижения, капитал, репутация, PvP рейтинг
        - calculate_combat_score: убийства, точность, KDA, нанесённый урон
        - calculate_economic_score: капитал, торговля, доходы
        - calculate_social_score: репутация, гильдия, друзья
      integration: |
        Интегрируется с character-service для данных персонажа
        Интегрируется с achievement-service для достижений
        Интегрируется с economy-service для экономических метрик

    - name: Ranking Engine
      location: world-service-go (модуль leaderboard-ranking)
      responsibility: |
        - Обновление позиций игроков в рейтингах
        - Синхронизация Redis ↔ PostgreSQL
        - Батчевая обработка обновлений
        - Определение рангов и тиров
        - Обработка изменений позиций
      update_strategies: |
        - real-time: немедленное обновление для критических событий
        - hourly: периодическое обновление для стандартных метрик
        - daily: ежедневное обновление для агрегированных метрик
        - weekly: еженедельное обновление для долгосрочных метрик
      integration: |
        Использует Redis sorted sets для hot data
        Синхронизирует с PostgreSQL для персистентности
        Публикует события об изменениях позиций

    - name: Season Manager
      location: world-service-go (модуль leaderboard-seasons)
      responsibility: |
        - Управление сезонами лидербордов
        - Сезонные сбросы и архивация
        - Распределение наград за сезон
        - Создание снапшотов
        - Запуск новых сезонов
      season_flow: |
        1. Создание финального снапшота
        2. Распределение наград по тирам (Diamond, Platinum, Gold, Silver, Bronze)
        3. Архивация данных сезона
        4. Сброс рейтингов
        5. Запуск нового сезона
      endpoints:
        - GET /api/v1/world/leaderboards/seasons - список сезонов
        - GET /api/v1/world/leaderboards/seasons/{season_id} - данные сезона
        - POST /api/v1/world/leaderboards/seasons/{season_id}/reset - сброс сезона
        - GET /api/v1/world/leaderboards/seasons/{season_id}/rewards - награды сезона

    - name: Cache Manager
      location: world-service-go (модуль leaderboard-cache)
      responsibility: |
        - Управление кэшированием в Redis
        - Операции с Redis sorted sets
        - Инвалидация кэша
        - Оптимизация запросов
        - Синхронизация с PostgreSQL
      redis_operations: |
        - ZADD: добавление/обновление позиции
        - ZRANGE: получение топ игроков
        - ZRANK: получение позиции игрока
        - ZREVRANGE: получение обратного рейтинга
        - ZREMRANGEBYRANK: очистка старых позиций
      redis_keys: |
        - leaderboard:{code}:{scope} - основной рейтинг
        - leaderboard:{code}:{scope}:season:{season_id} - сезонный рейтинг
        - leaderboard:{code}:{scope}:friends:{player_id} - дружественный рейтинг
        - leaderboard:{code}:{scope}:guild:{guild_id} - гильдийный рейтинг

  leaderboard_types:
    - type: global
      description: Глобальные рейтинги всех игроков
      scope: server
      update_frequency: real-time / hourly
      examples:
        - Overall Power
        - Combat Score
        - Economic Score
        - Social Score

    - type: class
      description: Рейтинги по классам персонажей
      scope: class
      update_frequency: hourly
      examples:
        - Netrunner Rankings
        - Solo Rankings
        - Techie Rankings

    - type: seasonal
      description: Сезонные рейтинги с периодическими сбросами
      scope: season
      update_frequency: real-time
      examples:
        - Season 1 Combat
        - Season 1 Overall
      reset_frequency: monthly / quarterly

    - type: friend
      description: Рейтинги среди друзей игрока
      scope: friends
      update_frequency: real-time
      examples:
        - Friends Overall Power
        - Friends Combat Score

    - type: guild
      description: Рейтинги гильдий
      scope: guild
      update_frequency: daily
      examples:
        - Guild Power
        - Guild Activity

  data_flow:
    score_update: |
      1. Игровое событие происходит (комбат, достижение, экономическая операция)
      2. Event Bus получает событие
      3. Score Calculator рассчитывает новые очки
      4. Ranking Engine обновляет позицию в Redis
      5. Cache Manager синхронизирует изменения
      6. Realtime Gateway уведомляет клиентов об изменениях
      7. Периодическая синхронизация с PostgreSQL

    leaderboard_query: |
      1. Клиент запрашивает лидерборд
      2. Leaderboard Manager проверяет кэш Redis
      3. Если данные в кэше - возвращает из Redis
      4. Если нет - загружает из PostgreSQL и кэширует
      5. Возвращает данные клиенту

    season_reset: |
      1. Season Manager запускает процесс сброса
      2. Создаётся финальный снапшот текущего сезона
      3. Распределяются награды по тирам
      4. Данные архивируются в PostgreSQL
      5. Очищается Redis кэш
      6. Запускается новый сезон

  integrations:
    with_character_service: |
      - Получение данных персонажа для расчёта очков
      - Уровень, экипировка, навыки
      - Статистика персонажа

    with_achievement_service: |
      - Получение достижений для расчёта очков
      - Учёт достижений в overall power
      - Интеграция с системой титулов

    with_economy_service: |
      - Получение экономических метрик
      - Капитал, доходы, торговля
      - Экономический рейтинг

    with_social_service: |
      - Получение списка друзей для friend leaderboards
      - Данные гильдий для guild leaderboards
      - Социальные метрики

    with_gameplay_service: |
      - Получение боевых метрик
      - Убийства, точность, KDA
      - Боевой рейтинг

    with_realtime_gateway: |
      - Push уведомления об изменениях позиций
      - Real-time обновления лидербордов
      - Синхронизация состояния

  database_schema:
    tables:
      - name: leaderboards
        description: Определения лидербордов
        fields:
          - id: UUID (PK)
          - code: VARCHAR(100) (unique) - код лидерборда
          - name: VARCHAR(255) - название
          - type: ENUM (global, class, seasonal, friend, guild)
          - scope: VARCHAR(100) - область видимости
          - metric_type: VARCHAR(100) - тип метрики
          - update_frequency: ENUM (realtime, hourly, daily, weekly)
          - is_active: BOOLEAN
          - season_id: UUID (FK, nullable) - для сезонных лидербордов
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - code, type
          - type, is_active
          - season_id

      - name: leaderboard_entries
        description: Записи в лидербордах
        fields:
          - id: UUID (PK)
          - leaderboard_id: UUID (FK leaderboards)
          - player_id: UUID (FK accounts)
          - score: DECIMAL(20,2) - очки игрока
          - rank: INTEGER - текущая позиция
          - previous_rank: INTEGER - предыдущая позиция
          - tier: ENUM (diamond, platinum, gold, silver, bronze)
          - metadata: JSONB - дополнительные данные (денормализованные)
          - season_id: UUID (FK, nullable)
          - updated_at: TIMESTAMP
        indexes:
          - leaderboard_id, rank
          - player_id, leaderboard_id
          - leaderboard_id, score (desc)
          - season_id, rank

      - name: leaderboard_snapshots
        description: Снапшоты лидербордов (для сезонов)
        fields:
          - id: UUID (PK)
          - leaderboard_id: UUID (FK leaderboards)
          - season_id: UUID (FK)
          - snapshot_data: JSONB - полные данные рейтинга
          - created_at: TIMESTAMP
        indexes:
          - leaderboard_id, season_id
          - season_id

      - name: leaderboard_seasons
        description: Сезоны лидербордов
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - start_date: TIMESTAMP
          - end_date: TIMESTAMP
          - status: ENUM (active, ended, archived)
          - rewards_distributed: BOOLEAN
          - created_at: TIMESTAMP
        indexes:
          - status, end_date
          - start_date, end_date

      - name: leaderboard_rewards
        description: Награды за позиции в лидербордах
        fields:
          - id: UUID (PK)
          - leaderboard_id: UUID (FK leaderboards)
          - season_id: UUID (FK leaderboard_seasons, nullable)
          - tier: ENUM (diamond, platinum, gold, silver, bronze)
          - rank_min: INTEGER - минимальная позиция для тира
          - rank_max: INTEGER - максимальная позиция для тира
          - rewards: JSONB - награды (валюта, предметы, титулы)
          - created_at: TIMESTAMP
        indexes:
          - leaderboard_id, tier
          - season_id, tier

  redis_schema:
    sorted_sets: |
      - Ключ: leaderboard:{code}:{scope}
        Значение: sorted set с player_id как member и score как score
        Операции: ZADD, ZRANGE, ZRANK, ZREVRANGE

      - Ключ: leaderboard:{code}:{scope}:season:{season_id}
        Значение: sorted set для сезонного рейтинга
        TTL: до конца сезона

      - Ключ: leaderboard:{code}:{scope}:friends:{player_id}
        Значение: sorted set для дружественного рейтинга
        TTL: 1 час (обновляется при запросе)

      - Ключ: leaderboard:{code}:{scope}:guild:{guild_id}
        Значение: sorted set для гильдийного рейтинга
        TTL: 24 часа

technical_specification:
  backend_requirements:
    - Реализация модулей в world-service-go:
      - leaderboard (управление лидербордами)
      - leaderboard-scoring (расчёт очков)
      - leaderboard-ranking (обновление позиций)
      - leaderboard-seasons (управление сезонами)
      - leaderboard-cache (кэширование)
    - Интеграция с Redis для hot data
    - Интеграция с PostgreSQL для персистентности
    - Периодическая синхронизация Redis ↔ PostgreSQL
    - Оптимизация запросов (индексы, кэширование)

  performance_requirements:
    - Получение топ-100 < 10ms (из Redis)
    - Получение позиции игрока < 5ms (из Redis)
    - Обновление позиции < 50ms
    - Поддержка до 1M игроков в глобальных рейтингах
    - Поддержка до 10K активных лидербордов

  scalability_requirements:
    - Горизонтальное масштабирование через world-service
    - Распределение нагрузки на Redis кластер
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование активных лидербордов в Redis

  caching_strategy:
    - Redis для hot data (топ-1000, активные позиции)
    - PostgreSQL для полных данных и истории
    - Периодическая синхронизация (каждые 5 минут)
    - Инвалидация кэша при обновлениях

subtasks:
  - id: leaderboard-manager-module
    title: Реализация модуля Leaderboard Manager
    description: |
      Создание модуля управления лидербордами
      CRUD операции для лидербордов
      Получение рейтингов и позиций
    priority: high
    estimated_time: 3-4 дня

  - id: score-calculator-implementation
    title: Реализация Score Calculator
    description: |
      Реализация функций расчёта очков
      Интеграция с другими сервисами
      Оптимизация расчётов
    priority: high
    estimated_time: 3-4 дня

  - id: ranking-engine-development
    title: Реализация Ranking Engine
    description: |
      Обновление позиций игроков
      Синхронизация Redis ↔ PostgreSQL
      Батчевая обработка обновлений
    priority: high
    estimated_time: 4-5 дней

  - id: season-manager-implementation
    title: Реализация Season Manager
    description: |
      Управление сезонами
      Сезонные сбросы и архивация
      Распределение наград
    priority: high
    estimated_time: 3-4 дня

  - id: cache-manager-development
    title: Реализация Cache Manager
    description: |
      Управление кэшированием в Redis
      Операции с sorted sets
      Инвалидация кэша
    priority: high
    estimated_time: 2-3 дня

  - id: redis-postgresql-sync
    title: Синхронизация Redis ↔ PostgreSQL
    description: |
      Периодическая синхронизация данных
      Батчевая запись в PostgreSQL
      Обработка конфликтов
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Материализованные представления
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для лидербордов
      Интеграция с существующим API world-service
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты управления лидербордами
      Тесты расчёта очков
      Тесты синхронизации Redis ↔ PostgreSQL
      Тесты сезонных сбросов
    priority: high
    estimated_time: 2-3 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "World Service"
            LM[Leaderboard Manager]
            SC[Score Calculator]
            RE[Ranking Engine]
            SM[Season Manager]
            CM[Cache Manager]
        end

        subgraph "Storage"
            Redis[(Redis<br/>Sorted Sets)]
            DB[(PostgreSQL<br/>leaderboards<br/>leaderboard_entries<br/>leaderboard_snapshots)]
        end

        subgraph "External Services"
            CS[Character Service]
            AS[Achievement Service]
            ES[Economy Service]
            SS[Social Service]
            GS[Gameplay Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|API requests| LM
        LM --> CM
        LM --> RE
        RE --> CM
        RE --> SC
        SC --> CS
        SC --> AS
        SC --> ES
        SC --> GS
        CM -->|read/write| Redis
        RE -->|sync| DB
        SM -->|snapshots| DB
        LM -->|friends/guilds| SS
        RE -->|updates| RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant E as Event
        participant SC as Score Calculator
        participant RE as Ranking Engine
        participant CM as Cache Manager
        participant R as Redis
        participant DB as PostgreSQL
        participant RG as Realtime Gateway
        participant C as Client

        E->>SC: Game event
        SC->>SC: Calculate score
        SC->>RE: Update ranking
        RE->>CM: Update cache
        CM->>R: ZADD score
        RE->>DB: Batch sync
        RE->>RG: Notify change
        RG->>C: Push update
        
        C->>CM: Query leaderboard
        CM->>R: ZRANGE top-100
        R->>CM: Return data
        CM->>C: Return leaderboard
    ```

  season_lifecycle: |
    ```mermaid
    graph LR
        subgraph "Season Lifecycle"
            S1[Season Start]
            S2[Active Season]
            S3[Season End]
            S4[Snapshot Created]
            S5[Rewards Distributed]
            S6[Archived]
        end

        S1 -->|start| S2
        S2 -->|end date| S3
        S3 -->|create snapshot| S4
        S4 -->|distribute rewards| S5
        S5 -->|archive| S6
        S6 -->|new season| S1
    ```

decisions:
  - id: adr-leaderboard-architecture
    summary: |
      Выбрана модульная архитектура внутри world-service-go для обеспечения
      тесной интеграции с мировыми системами и глобальными данными.

  - id: adr-redis-postgresql
    summary: |
      Использование Redis для hot data (топ-1000, активные позиции) и PostgreSQL
      для персистентного хранения обеспечивает баланс между производительностью
      и надёжностью.

  - id: adr-scoring-functions
    summary: |
      Модульная система расчёта очков позволяет легко добавлять новые метрики
      и типы лидербордов без изменения основной архитектуры.

  - id: adr-seasonal-resets
    summary: |
      Сезонные сбросы с архивацией и наградами обеспечивают долгосрочную
      мотивацию игроков и справедливое соревнование.

  - id: adr-realtime-updates
    summary: |
      Real-time обновления через Realtime Gateway обеспечивают актуальность
      данных для игроков и повышают вовлечённость.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение стратегии кэширования

history:
  - version: '1.0.0'
    date: 2025-11-22
    author: Architect Agent
    changes: |
      Создана полная архитектура системы лидербордов:
      - Определены компоненты (Leaderboard Manager, Score Calculator, Ranking Engine, Season Manager, Cache Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД и Redis
      - Спроектирована система обновления рейтингов
      - Определена стратегия кэширования
      - Создано техническое задание
      - Разбито на подзадачи


