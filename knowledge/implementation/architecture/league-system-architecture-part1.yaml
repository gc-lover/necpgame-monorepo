metadata:
  id: league-system-architecture
  title: Архитектура системы лиг
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T15:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - meta
    - seasons
    - progression
    - reset
  related_systems:
    - league-service
    - progression-service
    - matchmaking-service
    - world-service
    - economy-service
    - character-service
    - analytics-service
  related_documents:
    - id: league-system-mechanics
      relation: implements
  github_issue: 83
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру сезонной системы лиг, которая обеспечивает:
    - Циклические сезоны с глобальным сбросом (3-6 месяцев)
    - Мета-прогресс между сезонами (титулы, косметика, Legacy Items)
    - Интеграцию с matchmaking и progression системами
    - Динамическую вариативность миров и событий
    - Hall of Fame и рейтинговую систему
  goal: |
    Создать архитектурную схему системы лиг с определением:
    - Микросервисов для управления лигами
    - Компонентов для сезонов, сброса, мета-прогресса
    - API endpoints (высокоуровнево)
    - Интеграций с другими системами
    - Структуры БД для лиг, мета-прогресса и статистики
    - Технического задания для реализации

architecture:
  overview: |
    Система лиг состоит из следующих компонентов:
    1. League Manager - управление текущей лигой и переходами между сезонами
    2. Season Controller - контроль фаз сезона (Start, Rise, Crisis, Endgame, Finale)
    3. Global Reset Engine - выполнение глобального сброса персонажей и экономики
    4. Meta Progression Manager - управление мета-прогрессом (титулы, косметика, Legacy Items)
    5. Hall of Fame Manager - управление Hall of Fame и рейтингами
    6. League Statistics Collector - сбор и анализ статистики лиг
    7. Legacy Shop Manager - управление Legacy Shop и наградами
    8. Time Acceleration Controller - управление ускорением игрового времени

  microservices:
    - name: league-service
      port: 8093
      responsibility: |
        Основной сервис для управления лигами:
        - Управление текущей лигой и её фазами
        - Контроль времени и ускорения
        - Координация глобального сброса
        - Управление мета-прогрессом
        - Hall of Fame и рейтинги
      components:
        - League Manager
        - Season Controller
        - Global Reset Engine
        - Meta Progression Manager
        - Hall of Fame Manager
        - League Statistics Collector
        - Legacy Shop Manager
        - Time Acceleration Controller
      endpoints:
        - GET /api/v1/league/current - текущая лига
        - GET /api/v1/league/{leagueId}/statistics - статистика лиги
        - GET /api/v1/league/countdown - таймер до конца лиги
        - POST /api/v1/league/end-event/register - регистрация на финал
        - GET /api/v1/player/legacy-progress - мета-прогресс игрока
        - GET /api/v1/league/hall-of-fame - Hall of Fame
        - GET /api/v1/league/phases - текущая фаза лиги
        - POST /api/v1/league/reset/trigger - триггер сброса (admin)

    - name: progression-service
      port: 8082
      responsibility: |
        Интеграция с мета-прогрессом:
        - Управление титулами и достижениями
        - Косметика и разблокировки
        - Legacy Items и их эффекты
        - Глобальный рейтинг (MMR/ELO)
      components:
        - Title Manager
        - Cosmetic Unlock Manager
        - Legacy Items Manager
        - Global Rating Manager
      endpoints:
        - GET /api/v1/progression/titles - список титулов
        - GET /api/v1/progression/cosmetics - разблокированная косметика
        - GET /api/v1/progression/legacy-items - Legacy Items
        - GET /api/v1/progression/rating - глобальный рейтинг

    - name: matchmaking-service
      port: 8081
      responsibility: |
        Интеграция с матчмейкингом:
        - Использование глобального рейтинга для матчмейкинга
        - Учет текущей фазы лиги
        - Сезонные рейтинги
      components:
        - League Rating Adapter
        - Season Phase Adapter
      endpoints:
        - GET /api/v1/matchmaking/league-rating - рейтинг для матчмейкинга

  components:
    - name: League Manager
      location: league-service
      responsibility: |
        Управление жизненным циклом лиг:
        - Создание новой лиги
        - Управление текущей лигой
        - Переходы между фазами
        - Завершение лиги и подготовка к сбросу
        - Хранение конфигурации лиги (seed, вариации)
      dependencies:
        - Database
        - Event Bus
        - Season Controller

    - name: Season Controller
      location: league-service
      responsibility: |
        Контроль фаз сезона:
        - Start (месяц 1): создание персонажей, выбор фракций
        - Rise (месяцы 2-3): корпоративные войны
        - Crisis (месяцы 4-5): поздние конфликты
        - Endgame (последние 2 недели): кульминация
        - Finale (27 июля 2093): глобальный сброс
        - Управление ускорением времени (15-30 игровых дней за реальный день)
      dependencies:
        - League Manager
        - Time Acceleration Controller
        - Event Bus

    - name: Global Reset Engine
      location: league-service
      responsibility: |
        Выполнение глобального сброса:
        - Удаление персонажей текущей лиги
        - Очистка прогресса квестов
        - Сброс экономики
        - Распад гильдий (с возможностью восстановления)
        - Сохранение мета-прогресса
        - Выдача итоговых наград
      dependencies:
        - Character Service
        - Economy Service
        - Social Service
        - Quest Service
        - Meta Progression Manager
        - Event Bus

    - name: Meta Progression Manager
      location: league-service
      responsibility: |
        Управление мета-прогрессом:
        - Сохранение достижений и титулов
        - Косметика и разблокировки
        - Legacy Items (мощные предметы старта новой лиги)
        - Глобальный рейтинг с мягким сбросом (20%)
        - Legacy Points и их использование
      dependencies:
        - Progression Service
        - Database
        - Event Bus

    - name: Hall of Fame Manager
      location: league-service
      responsibility: |
        Управление Hall of Fame:
        - Фиксация лучших игроков каждой лиги
        - Категории: первые прохождения, экономика, PvP, альтернативные режимы
        - Статуя победителя лиги (3D-модель)
        - Вечное отображение имен
        - Уникальная косметика для победителей
      dependencies:
        - League Statistics Collector
        - Database
        - Event Bus

    - name: League Statistics Collector
      location: league-service
      responsibility: |
        Сбор и анализ статистики:
        - Статистика по фазам лиги
        - Экономические метрики
        - PvP метрики
        - Квестовые метрики
        - Интеграция с Analytics Service
      dependencies:
        - Analytics Service
        - Database
        - Event Bus

    - name: Legacy Shop Manager
      location: league-service
      responsibility: |
        Управление Legacy Shop:
        - Legacy Points за участие
        - Покупка Legacy Items
        - Косметические награды
        - Ограничения на использование Legacy Items
      dependencies:
        - Meta Progression Manager
        - Economy Service
        - Database

    - name: Time Acceleration Controller
      location: league-service
      responsibility: |
        Управление ускорением времени:
        - Масштабирование времени (15-30 игровых дней за реальный день)
        - Учет сценарных событий (замедление для драматургии)
        - Синхронизация с World Service
        - Расчет текущей игровой даты
      dependencies:
        - World Service
        - Season Controller
        - Event Bus

  integrations:
    - service: world-service
      purpose: |
        Синхронизация игрового времени и мировых событий:
        - Получение текущей игровой даты
        - Триггеры мировых событий по фазам лиги
        - Влияние решений игроков на мир
      events:
        - league:phase-changed
        - league:time-acceleration-updated
        - world:league-event-triggered

    - service: character-service
      purpose: |
        Управление персонажами в контексте лиг:
        - Создание персонажей в новой лиге
        - Удаление персонажей при сбросе
        - Сохранение мета-данных
      events:
        - league:reset-started
        - league:reset-completed
        - character:league-created
        - character:league-deleted

    - service: economy-service
      purpose: |
        Сброс экономики и Legacy Items:
        - Очистка экономики при сбросе
        - Выдача Legacy Items в новой лиге
        - Экономические метрики для статистики
      events:
        - league:reset-economy
        - league:legacy-items-distributed
        - economy:league-statistics

    - service: social-service
      purpose: |
        Управление гильдиями и социальными связями:
        - Распад гильдий при сбросе
        - Восстановление составов в новой лиге
        - Сохранение социальных связей
      events:
        - league:guilds-disbanded
        - league:guilds-restored
        - social:league-statistics

    - service: quest-service
      purpose: |
        Сброс прогресса квестов:
        - Очистка прогресса квестов
        - Сохранение завершенных квестов для мета-прогресса
        - Триггеры квестов по фазам лиги
      events:
        - league:quests-reset
        - quest:league-phase-triggered
        - quest:league-completion-tracked

    - service: matchmaking-service
      purpose: |
        Использование глобального рейтинга:
        - Получение глобального рейтинга для матчмейкинга
        - Учет текущей фазы лиги
        - Сезонные рейтинги
      events:
        - league:rating-updated
        - matchmaking:league-rating-requested

    - service: analytics-service
      purpose: |
        Телеметрия и аналитика:
        - События лиги (contract_viewed, league_phase_transition, hall_of_fame_update)
        - Статистика по фазам
        - Аналитические панели
      events:
        - league:telemetry-event
        - analytics:league-statistics-requested

  data_models:
    - name: League
