metadata:
  id: league-system-architecture
  title: Архитектура системы лиг
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T15:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - meta
    - seasons
    - progression
    - reset
  related_systems:
    - league-service
    - progression-service
    - matchmaking-service
    - world-service
    - economy-service
    - character-service
    - analytics-service
  related_documents:
    - id: league-system-mechanics
      relation: implements
  github_issue: 83
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру сезонной системы лиг, которая обеспечивает:
    - Циклические сезоны с глобальным сбросом (3-6 месяцев)
    - Мета-прогресс между сезонами (титулы, косметика, Legacy Items)
    - Интеграцию с matchmaking и progression системами
    - Динамическую вариативность миров и событий
    - Hall of Fame и рейтинговую систему
  goal: |
    Создать архитектурную схему системы лиг с определением:
    - Микросервисов для управления лигами
    - Компонентов для сезонов, сброса, мета-прогресса
    - API endpoints (высокоуровнево)
    - Интеграций с другими системами
    - Структуры БД для лиг, мета-прогресса и статистики
    - Технического задания для реализации

architecture:
  overview: |
    Система лиг состоит из следующих компонентов:
    1. League Manager - управление текущей лигой и переходами между сезонами
    2. Season Controller - контроль фаз сезона (Start, Rise, Crisis, Endgame, Finale)
    3. Global Reset Engine - выполнение глобального сброса персонажей и экономики
    4. Meta Progression Manager - управление мета-прогрессом (титулы, косметика, Legacy Items)
    5. Hall of Fame Manager - управление Hall of Fame и рейтингами
    6. League Statistics Collector - сбор и анализ статистики лиг
    7. Legacy Shop Manager - управление Legacy Shop и наградами
    8. Time Acceleration Controller - управление ускорением игрового времени

  microservices:
    - name: league-service
      port: 8093
      responsibility: |
        Основной сервис для управления лигами:
        - Управление текущей лигой и её фазами
        - Контроль времени и ускорения
        - Координация глобального сброса
        - Управление мета-прогрессом
        - Hall of Fame и рейтинги
      components:
        - League Manager
        - Season Controller
        - Global Reset Engine
        - Meta Progression Manager
        - Hall of Fame Manager
        - League Statistics Collector
        - Legacy Shop Manager
        - Time Acceleration Controller
      endpoints:
        - GET /api/v1/league/current - текущая лига
        - GET /api/v1/league/{leagueId}/statistics - статистика лиги
        - GET /api/v1/league/countdown - таймер до конца лиги
        - POST /api/v1/league/end-event/register - регистрация на финал
        - GET /api/v1/player/legacy-progress - мета-прогресс игрока
        - GET /api/v1/league/hall-of-fame - Hall of Fame
        - GET /api/v1/league/phases - текущая фаза лиги
        - POST /api/v1/league/reset/trigger - триггер сброса (admin)

    - name: progression-service
      port: 8082
      responsibility: |
        Интеграция с мета-прогрессом:
        - Управление титулами и достижениями
        - Косметика и разблокировки
        - Legacy Items и их эффекты
        - Глобальный рейтинг (MMR/ELO)
      components:
        - Title Manager
        - Cosmetic Unlock Manager
        - Legacy Items Manager
        - Global Rating Manager
      endpoints:
        - GET /api/v1/progression/titles - список титулов
        - GET /api/v1/progression/cosmetics - разблокированная косметика
        - GET /api/v1/progression/legacy-items - Legacy Items
        - GET /api/v1/progression/rating - глобальный рейтинг

    - name: matchmaking-service
      port: 8081
      responsibility: |
        Интеграция с матчмейкингом:
        - Использование глобального рейтинга для матчмейкинга
        - Учет текущей фазы лиги
        - Сезонные рейтинги
      components:
        - League Rating Adapter
        - Season Phase Adapter
      endpoints:
        - GET /api/v1/matchmaking/league-rating - рейтинг для матчмейкинга

  components:
    - name: League Manager
      location: league-service
      responsibility: |
        Управление жизненным циклом лиг:
        - Создание новой лиги
        - Управление текущей лигой
        - Переходы между фазами
        - Завершение лиги и подготовка к сбросу
        - Хранение конфигурации лиги (seed, вариации)
      dependencies:
        - Database
        - Event Bus
        - Season Controller

    - name: Season Controller
      location: league-service
      responsibility: |
        Контроль фаз сезона:
        - Start (месяц 1): создание персонажей, выбор фракций
        - Rise (месяцы 2-3): корпоративные войны
        - Crisis (месяцы 4-5): поздние конфликты
        - Endgame (последние 2 недели): кульминация
        - Finale (27 июля 2093): глобальный сброс
        - Управление ускорением времени (15-30 игровых дней за реальный день)
      dependencies:
        - League Manager
        - Time Acceleration Controller
        - Event Bus

    - name: Global Reset Engine
      location: league-service
      responsibility: |
        Выполнение глобального сброса:
        - Удаление персонажей текущей лиги
        - Очистка прогресса квестов
        - Сброс экономики
        - Распад гильдий (с возможностью восстановления)
        - Сохранение мета-прогресса
        - Выдача итоговых наград
      dependencies:
        - Character Service
        - Economy Service
        - Social Service
        - Quest Service
        - Meta Progression Manager
        - Event Bus

    - name: Meta Progression Manager
      location: league-service
      responsibility: |
        Управление мета-прогрессом:
        - Сохранение достижений и титулов
        - Косметика и разблокировки
        - Legacy Items (мощные предметы старта новой лиги)
        - Глобальный рейтинг с мягким сбросом (20%)
        - Legacy Points и их использование
      dependencies:
        - Progression Service
        - Database
        - Event Bus

    - name: Hall of Fame Manager
      location: league-service
      responsibility: |
        Управление Hall of Fame:
        - Фиксация лучших игроков каждой лиги
        - Категории: первые прохождения, экономика, PvP, альтернативные режимы
        - Статуя победителя лиги (3D-модель)
        - Вечное отображение имен
        - Уникальная косметика для победителей
      dependencies:
        - League Statistics Collector
        - Database
        - Event Bus

    - name: League Statistics Collector
      location: league-service
      responsibility: |
        Сбор и анализ статистики:
        - Статистика по фазам лиги
        - Экономические метрики
        - PvP метрики
        - Квестовые метрики
        - Интеграция с Analytics Service
      dependencies:
        - Analytics Service
        - Database
        - Event Bus

    - name: Legacy Shop Manager
      location: league-service
      responsibility: |
        Управление Legacy Shop:
        - Legacy Points за участие
        - Покупка Legacy Items
        - Косметические награды
        - Ограничения на использование Legacy Items
      dependencies:
        - Meta Progression Manager
        - Economy Service
        - Database

    - name: Time Acceleration Controller
      location: league-service
      responsibility: |
        Управление ускорением времени:
        - Масштабирование времени (15-30 игровых дней за реальный день)
        - Учет сценарных событий (замедление для драматургии)
        - Синхронизация с World Service
        - Расчет текущей игровой даты
      dependencies:
        - World Service
        - Season Controller
        - Event Bus

  integrations:
    - service: world-service
      purpose: |
        Синхронизация игрового времени и мировых событий:
        - Получение текущей игровой даты
        - Триггеры мировых событий по фазам лиги
        - Влияние решений игроков на мир
      events:
        - league:phase-changed
        - league:time-acceleration-updated
        - world:league-event-triggered

    - service: character-service
      purpose: |
        Управление персонажами в контексте лиг:
        - Создание персонажей в новой лиге
        - Удаление персонажей при сбросе
        - Сохранение мета-данных
      events:
        - league:reset-started
        - league:reset-completed
        - character:league-created
        - character:league-deleted

    - service: economy-service
      purpose: |
        Сброс экономики и Legacy Items:
        - Очистка экономики при сбросе
        - Выдача Legacy Items в новой лиге
        - Экономические метрики для статистики
      events:
        - league:reset-economy
        - league:legacy-items-distributed
        - economy:league-statistics

    - service: social-service
      purpose: |
        Управление гильдиями и социальными связями:
        - Распад гильдий при сбросе
        - Восстановление составов в новой лиге
        - Сохранение социальных связей
      events:
        - league:guilds-disbanded
        - league:guilds-restored
        - social:league-statistics

    - service: quest-service
      purpose: |
        Сброс прогресса квестов:
        - Очистка прогресса квестов
        - Сохранение завершенных квестов для мета-прогресса
        - Триггеры квестов по фазам лиги
      events:
        - league:quests-reset
        - quest:league-phase-triggered
        - quest:league-completion-tracked

    - service: matchmaking-service
      purpose: |
        Использование глобального рейтинга:
        - Получение глобального рейтинга для матчмейкинга
        - Учет текущей фазы лиги
        - Сезонные рейтинги
      events:
        - league:rating-updated
        - matchmaking:league-rating-requested

    - service: analytics-service
      purpose: |
        Телеметрия и аналитика:
        - События лиги (contract_viewed, league_phase_transition, hall_of_fame_update)
        - Статистика по фазам
        - Аналитические панели
      events:
        - league:telemetry-event
        - analytics:league-statistics-requested

  data_models:
    - name: League
      fields:
        - id: UUID
        - name: string
        - seed: int64
        - start_date: timestamp
        - end_date: timestamp
        - current_phase: enum (Start, Rise, Crisis, Endgame, Finale)
        - time_acceleration: float
        - game_date: timestamp
        - created_at: timestamp
        - updated_at: timestamp

    - name: PlayerLegacy
      fields:
        - player_id: UUID
        - legacy_points: int
        - titles: array<string>
        - cosmetics: array<UUID>
        - legacy_items: array<UUID>
        - global_rating: float
        - hall_of_fame_entries: array<HallOfFameEntry>
        - created_at: timestamp
        - updated_at: timestamp

    - name: LeagueStatistics
      fields:
        - league_id: UUID
        - phase: enum
        - player_count: int
        - economy_metrics: json
        - pvp_metrics: json
        - quest_metrics: json
        - top_players: array<PlayerStats>
        - created_at: timestamp
        - updated_at: timestamp

    - name: HallOfFameEntry
      fields:
        - league_id: UUID
        - player_id: UUID
        - category: enum (Story, Economy, PvP, Alternative)
        - rank: int
        - achievement: string
        - statue_model: UUID
        - created_at: timestamp

  api_endpoints:
    league_management:
      - GET /api/v1/league/current
        description: Получить текущую лигу
        response: League
      - GET /api/v1/league/{leagueId}
        description: Получить информацию о лиге
        response: League
      - GET /api/v1/league/{leagueId}/statistics
        description: Получить статистику лиги
        response: LeagueStatistics
      - GET /api/v1/league/countdown
        description: Получить таймер до конца лиги
        response: Countdown
      - GET /api/v1/league/phases
        description: Получить текущую фазу лиги
        response: PhaseInfo

    meta_progression:
      - GET /api/v1/player/legacy-progress
        description: Получить мета-прогресс игрока
        response: PlayerLegacy
      - GET /api/v1/player/titles
        description: Получить титулы игрока
        response: array<Title>
      - GET /api/v1/player/cosmetics
        description: Получить косметику игрока
        response: array<Cosmetic>
      - GET /api/v1/player/legacy-items
        description: Получить Legacy Items игрока
        response: array<LegacyItem>

    hall_of_fame:
      - GET /api/v1/league/hall-of-fame
        description: Получить Hall of Fame
        response: array<HallOfFameEntry>
      - GET /api/v1/league/hall-of-fame/{leagueId}
        description: Получить Hall of Fame для лиги
        response: array<HallOfFameEntry>

    legacy_shop:
      - GET /api/v1/legacy-shop/items
        description: Получить доступные Legacy Items
        response: array<LegacyShopItem>
      - POST /api/v1/legacy-shop/purchase
        description: Купить Legacy Item
        request: PurchaseRequest
        response: PurchaseResponse

    events:
      - POST /api/v1/league/end-event/register
        description: Зарегистрироваться на финальный эвент
        request: EventRegistration
        response: RegistrationResponse

    admin:
      - POST /api/v1/league/reset/trigger
        description: Триггер глобального сброса (admin only)
        request: ResetRequest
        response: ResetResponse
      - POST /api/v1/league/create
        description: Создать новую лигу (admin only)
        request: LeagueCreateRequest
        response: League

  technical_tasks:
    phases:
      phase_1:
        name: League Manager и Season Controller
        tasks:
          - Реализация League Manager
          - Реализация Season Controller
          - Управление фазами лиги
          - Управление временем и ускорением
          - Интеграция с World Service
        estimated_effort: 5 days

      phase_2:
        name: Global Reset Engine
        tasks:
          - Реализация Global Reset Engine
          - Координация сброса с другими сервисами
          - Сохранение мета-прогресса
          - Выдача итоговых наград
          - Обработка ошибок и откат
        estimated_effort: 6 days

      phase_3:
        name: Meta Progression Manager
        tasks:
          - Реализация Meta Progression Manager
          - Управление титулами и достижениями
          - Косметика и разблокировки
          - Legacy Items и их эффекты
          - Глобальный рейтинг с мягким сбросом
        estimated_effort: 5 days

      phase_4:
        name: Hall of Fame и Statistics
        tasks:
          - Реализация Hall of Fame Manager
          - Реализация League Statistics Collector
          - Категории Hall of Fame
          - Статуя победителя
          - Интеграция с Analytics Service
        estimated_effort: 4 days

      phase_5:
        name: Legacy Shop
        tasks:
          - Реализация Legacy Shop Manager
          - Legacy Points система
          - Покупка Legacy Items
          - Ограничения на использование
        estimated_effort: 3 days

      phase_6:
        name: Интеграции
        tasks:
          - Интеграция с Character Service
          - Интеграция с Economy Service
          - Интеграция с Social Service
          - Интеграция с Quest Service
          - Интеграция с Matchmaking Service
          - Event Bus интеграция
        estimated_effort: 5 days

    total_estimated_effort: 28 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> LeagueService[League Service<br/>8093]
        
        LeagueService --> LM[League Manager]
        LeagueService --> SC[Season Controller]
        LeagueService --> GRE[Global Reset Engine]
        LeagueService --> MPM[Meta Progression Manager]
        LeagueService --> HOFM[Hall of Fame Manager]
        LeagueService --> LSC[League Statistics Collector]
        LeagueService --> LSM[Legacy Shop Manager]
        LeagueService --> TAC[Time Acceleration Controller]
        
        LeagueService --> CharacterService[Character Service<br/>8080]
        LeagueService --> EconomyService[Economy Service<br/>8085]
        LeagueService --> SocialService[Social Service<br/>8084]
        LeagueService --> QuestService[Quest Service<br/>8087]
        LeagueService --> MatchmakingService[Matchmaking Service<br/>8081]
        LeagueService --> WorldService[World Service<br/>8086]
        LeagueService --> ProgressionService[Progression Service<br/>8082]
        LeagueService --> AnalyticsService[Analytics Service<br/>8095]
        
        LeagueService --> EventBus[Event Bus<br/>Kafka]
        LeagueService --> DB[(League DB)]
        LeagueService --> Cache[(Redis Cache)]
        
        Client --> WSLeague[WebSocket<br/>League Updates]
        WSLeague --> LeagueService
    ```

  league_lifecycle: |
    ```mermaid
    stateDiagram-v2
        [*] --> Start: New League Created
        Start --> Rise: Month 1 Complete
        Rise --> Crisis: Months 2-3 Complete
        Crisis --> Endgame: Months 4-5 Complete
        Endgame --> Finale: Last 2 Weeks
        Finale --> Reset: July 27, 2093
        Reset --> [*]: Reset Complete
    ```

  reset_flow: |
    ```mermaid
    sequenceDiagram
        participant LeagueService
        participant GlobalResetEngine
        participant CharacterService
        participant EconomyService
        participant SocialService
        participant QuestService
        participant MetaProgressionManager
        
        LeagueService->>GlobalResetEngine: Trigger Reset
        GlobalResetEngine->>CharacterService: Delete Characters
        GlobalResetEngine->>EconomyService: Reset Economy
        GlobalResetEngine->>SocialService: Disband Guilds
        GlobalResetEngine->>QuestService: Reset Quests
        GlobalResetEngine->>MetaProgressionManager: Save Meta Progress
        GlobalResetEngine->>MetaProgressionManager: Distribute Rewards
        GlobalResetEngine->>LeagueService: Reset Complete
    ```

























