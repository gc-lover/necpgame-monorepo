metadata:
  id: legendary-npc-liveops-integration-architecture
  title: Архитектура интеграции легендарных NPC с Live Ops и специальными механиками (на примере Дэвида Мартинеса)
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T14:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - npc
    - legendary
    - live-ops
    - sandevistan
    - edgerunners
    - integration
  related_systems:
    - gameplay-service-go
    - world-service-go
    - quest-engine
    - live-ops-service
  related_documents:
    - id: npc-integration-system-architecture
      relation: extends
    - id: npc-david-martinez
      relation: extends
    - id: combat-sandevistan-temporal-overdrive
      relation: references
    - id: live-events-system
      relation: references
  github_issue: 27
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    Легендарные NPC (такие как Дэвид Мартинес) требуют специфической интеграции
    с системами Live Ops, специальными механиками (Sandevistan), сюжетами о киберпсихозе
    и Edgerunners командами, которые отличаются от обычных NPC интеграций.
  goal: |
    Создать архитектурную схему интеграции легендарных NPC с игровыми системами:
    - Интеграция с Live Ops событиями
    - Интеграция с механикой Sandevistan
    - Сюжеты о киберпсихозе
    - Edgerunners команды
    - Сезонные события
    - API endpoints (высокоуровнево)
    - Техническое задание для реализации
  essence: |
    Архитектура интеграции легендарных NPC с Live Ops системами и специальными механиками
    для обеспечения динамического контента и сезонных событий.

architecture:
  overview: |
    Система интеграции легендарных NPC расширяет общую архитектуру NPC интеграции
    следующими компонентами:
    1. Legendary NPC Event Manager - управление событиями легендарных NPC
    2. Sandevistan Integration System - интеграция с механикой Sandevistan
    3. Cyberpsychosis Story System - система сюжетов о киберпсихозе
    4. Edgerunners Team Manager - управление Edgerunners командами
    5. Seasonal Event Coordinator - координация сезонных событий
    6. Legendary NPC State Manager - управление состоянием легендарных NPC
    7. Live Ops Integration System - интеграция с Live Ops

  microservices:
    - name: legendary-npc-event-manager
      location: world-service-go (модуль legendary-npc-events)
      responsibility: |
        Управление событиями легендарных NPC:
        - Создание событий с участием легендарных NPC
        - Координация появления легендарных NPC
        - Управление наградами за события
        - Интеграция с Live Ops
      event_types:
        - Legendary Encounters (легендарные встречи)
        - Story Events (сюжетные события)
        - Seasonal Events (сезонные события)
        - Special Operations (специальные операции)
      endpoints:
        - GET /api/v1/legendary-npc/{npc_id}/events - события NPC
        - GET /api/v1/legendary-npc/{npc_id}/events/{event_id} - информация о событии
        - POST /api/v1/legendary-npc/{npc_id}/events/{event_id}/join - присоединение к событию
        - POST /api/v1/legendary-npc/{npc_id}/events/{event_id}/complete - завершение события

    - name: sandevistan-integration-system
      location: gameplay-service-go (модуль sandevistan-integration)
      responsibility: |
        Интеграция с механикой Sandevistan:
        - Управление Sandevistan способностями для NPC
        - Координация временного овердрайва
        - Интеграция с боевой системой
        - Управление рисками киберпсихоза
      sandevistan_features:
        - Temporal Overdrive (временной овердрайв)
        - Action Priority Budget (бюджет приоритетных действий)
        - Perception Drag (задержка восприятия)
        - Cyberpsychosis Risk (риск киберпсихоза)
      endpoints:
        - POST /api/v1/legendary-npc/{npc_id}/sandevistan/activate - активация Sandevistan
        - GET /api/v1/legendary-npc/{npc_id}/sandevistan/status - статус Sandevistan
        - POST /api/v1/legendary-npc/{npc_id}/sandevistan/cooling - охлаждение системы
        - GET /api/v1/legendary-npc/{npc_id}/sandevistan/cyberpsychosis-risk - риск киберпсихоза

    - name: cyberpsychosis-story-system
      location: gameplay-service-go (модуль cyberpsychosis-stories)
      responsibility: |
        Система сюжетов о киберпсихозе:
        - Управление сюжетами о киберпсихозе
        - Отслеживание прогресса киберпсихоза
        - Управление последствиями киберпсихоза
        - Интеграция с квестами
      cyberpsychosis_features:
        - Psychosis progression (прогрессия киберпсихоза)
        - Warning signs (предупреждающие знаки)
        - Intervention events (события вмешательства)
        - Recovery mechanics (механики восстановления)
      endpoints:
        - GET /api/v1/legendary-npc/{npc_id}/cyberpsychosis/status - статус киберпсихоза
        - GET /api/v1/legendary-npc/{npc_id}/cyberpsychosis/stories - сюжеты о киберпсихозе
        - POST /api/v1/legendary-npc/{npc_id}/cyberpsychosis/intervene - вмешательство
        - GET /api/v1/legendary-npc/{npc_id}/cyberpsychosis/progression - прогрессия

    - name: edgerunners-team-manager
      location: gameplay-service-go (модуль edgerunners-teams)
      responsibility: |
        Управление Edgerunners командами:
        - Создание Edgerunners команд
        - Управление участниками команд
        - Координация операций команд
        - Управление наградами команд
      team_features:
        - Team formation (формирование команд)
        - Team operations (операции команд)
        - Team reputation (репутация команд)
        - Team resources (ресурсы команд)
      endpoints:
        - GET /api/v1/edgerunners/teams - список команд
        - POST /api/v1/edgerunners/teams - создание команды
        - GET /api/v1/edgerunners/teams/{team_id} - информация о команде
        - POST /api/v1/edgerunners/teams/{team_id}/join - присоединение к команде
        - POST /api/v1/edgerunners/teams/{team_id}/operations/{op_id}/start - запуск операции

    - name: seasonal-event-coordinator
      location: world-service-go (модуль seasonal-events)
      responsibility: |
        Координация сезонных событий:
        - Планирование сезонных событий
        - Координация участия легендарных NPC
        - Управление наградами за сезоны
        - Интеграция с Live Ops
      seasonal_features:
        - Event scheduling (планирование событий)
        - NPC participation (участие NPC)
        - Seasonal rewards (сезонные награды)
        - Event progression (прогрессия событий)
      endpoints:
        - GET /api/v1/seasonal/events - сезонные события
        - GET /api/v1/seasonal/events/{event_id} - информация о событии
        - GET /api/v1/seasonal/events/{event_id}/legendary-npcs - легендарные NPC в событии
        - POST /api/v1/seasonal/events/{event_id}/join - присоединение к событию

    - name: legendary-npc-state-manager
      location: world-service-go (модуль legendary-npc-state)
      responsibility: |
        Управление состоянием легендарных NPC:
        - Хранение состояния легендарных NPC
        - Синхронизация между сервисами
        - Управление жизненным циклом
        - Персистентность состояния
      state_features:
        - Legendary status (легендарный статус)
        - Story progression (прогрессия сюжета)
        - Event participation (участие в событиях)
        - Relationship tracking (отслеживание отношений)
      endpoints:
        - GET /api/v1/legendary-npc/{npc_id}/state - состояние NPC
        - POST /api/v1/legendary-npc/{npc_id}/state/update - обновление состояния
        - GET /api/v1/legendary-npc/{npc_id}/story/progression - прогрессия сюжета

    - name: live-ops-integration-system
      location: world-service-go (модуль live-ops-integration)
      responsibility: |
        Интеграция с Live Ops:
        - Синхронизация с Live Ops событиями
        - Управление появлением легендарных NPC
        - Координация с сезонными кампаниями
        - Интеграция с аналитикой
      live_ops_features:
        - Event synchronization (синхронизация событий)
        - NPC spawning (появление NPC)
        - Campaign coordination (координация кампаний)
        - Analytics integration (интеграция с аналитикой)
      endpoints:
        - GET /api/v1/live-ops/events - активные Live Ops события
        - GET /api/v1/live-ops/events/{event_id}/legendary-npcs - легендарные NPC в событии
        - POST /api/v1/live-ops/events/{event_id}/trigger - триггер события
        - GET /api/v1/live-ops/campaigns - активные кампании

  data_flow:
    live_ops_event_flow: |
      1. Live Ops система планирует сезонное событие
      2. Seasonal Event Coordinator создаёт событие
      3. Legendary NPC Event Manager определяет участие Дэвида Мартинеса
      4. Игроки получают уведомление о событии
      5. Игроки присоединяются к событию
      6. Дэвид Мартинес появляется в событии
      7. Игроки взаимодействуют с Дэвидом
      8. Событие проходит с участием легендарного NPC
      9. При завершении события выдаются награды
      10. Legendary NPC State Manager обновляет состояние

    sandevistan_activation_flow: |
      1. Дэвид Мартинес активирует Sandevistan в бою
      2. Sandevistan Integration System обрабатывает активацию
      3. Сервер выделяет Action Priority Budget
      4. Клиент получает локальное слоумо
      5. Другие игроки получают Perception Drag
      6. Дэвид выполняет действия в ускоренном режиме
      7. Sandevistan Integration System отслеживает риск киберпсихоза
      8. При перегреве активируется Cyberpsychosis Story System
      9. Игроки могут вмешаться для помощи

    cyberpsychosis_story_flow: |
      1. Дэвид Мартинес использует Sandevistan слишком часто
      2. Cyberpsychosis Story System отслеживает прогрессию
      3. Система детектирует предупреждающие знаки
      4. Игроки получают уведомление о риске киберпсихоза
      5. Игроки могут вмешаться через квесты
      6. Cyberpsychosis Story System управляет сюжетом
      7. При успешном вмешательстве киберпсихоз предотвращается
      8. При провале активируется событие киберпсихоза
      9. Legendary NPC State Manager обновляет состояние

    edgerunners_team_flow: |
      1. Игроки формируют Edgerunners команду
      2. Edgerunners Team Manager создаёт команду
      3. Дэвид Мартинес может присоединиться к команде
      4. Команда получает доступ к специальным операциям
      5. Edgerunners Team Manager координирует операции
      6. Команда выполняет операции вместе с Дэвидом
      7. При успешном выполнении выдаются награды
      8. Edgerunners Team Manager обновляет репутацию команды

  integrations:
    with_npc_integration_system: |
      - Использование NPC Quest Manager для квестов
      - Использование NPC Relationship Tracker для отношений
      - Использование NPC Dialogue System для диалогов
      - Использование NPC Event Trigger System для событий

    with_live_ops_system: |
      - Синхронизация с Live Ops событиями
      - Управление сезонными кампаниями
      - Интеграция с аналитикой
      - Координация появления NPC

    with_combat_system: |
      - Интеграция с механикой Sandevistan
      - Управление временным овердрайвом
      - Координация боевых действий
      - Управление рисками киберпсихоза

    with_quest_engine: |
      - Создание квестов с легендарными NPC
      - Интеграция с сюжетами о киберпсихозе
      - Управление наградами за квесты

    with_world_service: |
      - Управление состоянием легендарных NPC
      - Синхронизация событий
      - Интеграция с Live Ops

  database_schema:
    tables:
      - name: legendary_npc_events
        description: События с легендарными NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - event_type: ENUM (legendary_encounter, story_event, seasonal_event, special_operation)
          - title: VARCHAR(255)
          - description: TEXT
          - requirements: JSONB (требования для участия)
          - rewards: JSONB (награды за событие)
          - status: ENUM (pending, active, completed, cancelled)
          - participants: UUID[] (array of player IDs)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - event_type, status

      - name: legendary_npc_sandevistan_state
        description: Состояние Sandevistan у легендарных NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - is_active: BOOLEAN (активен ли Sandevistan)
          - activation_count: INTEGER (количество активаций)
          - heat_level: INTEGER (уровень перегрева, 0-100)
          - cyberpsychosis_risk: INTEGER (риск киберпсихоза, 0-100)
          - last_activation: TIMESTAMP (nullable)
          - last_cooling: TIMESTAMP (nullable)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, is_active
          - cyberpsychosis_risk

      - name: cyberpsychosis_stories
        description: Сюжеты о киберпсихозе
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - story_type: ENUM (warning, intervention, recovery, full_psychosis)
          - progression_level: INTEGER (уровень прогрессии, 0-100)
          - warning_signs: JSONB (предупреждающие знаки)
          - intervention_events: JSONB (события вмешательства)
          - status: ENUM (pending, active, resolved, failed)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - progression_level

      - name: edgerunners_teams
        description: Edgerunners команды
        fields:
          - id: UUID (PK)
          - team_name: VARCHAR(255)
          - leader_id: UUID (FK accounts)
          - members: UUID[] (array of player IDs)
          - legendary_npc_members: VARCHAR(50)[] (array of NPC IDs)
          - reputation: INTEGER (репутация команды)
          - operations_completed: INTEGER (завершённых операций)
          - status: ENUM (active, inactive, disbanded)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - leader_id, status
          - reputation

      - name: edgerunners_operations
        description: Операции Edgerunners команд
        fields:
          - id: UUID (PK)
          - team_id: UUID (FK edgerunners_teams)
          - operation_type: ENUM (heist, rescue, sabotage, protection)
          - title: VARCHAR(255)
          - description: TEXT
          - requirements: JSONB (требования для операции)
          - rewards: JSONB (награды за операцию)
          - status: ENUM (pending, active, completed, failed)
          - participants: UUID[] (array of player IDs)
          - legendary_npc_participants: VARCHAR(50)[] (array of NPC IDs)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - team_id, status
          - operation_type, status

      - name: seasonal_events
        description: Сезонные события
        fields:
          - id: UUID (PK)
          - event_name: VARCHAR(255)
          - season: VARCHAR(50) (сезон события)
          - start_date: TIMESTAMP
          - end_date: TIMESTAMP
          - legendary_npc_participants: VARCHAR(50)[] (array of NPC IDs)
          - event_data: JSONB (данные события)
          - status: ENUM (scheduled, active, completed, cancelled)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - season, status
          - start_date, end_date

      - name: legendary_npc_state
        description: Состояние легендарных NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - story_progression: JSONB (прогрессия сюжета)
          - event_participation: JSONB (участие в событиях)
          - relationship_data: JSONB (данные отношений)
          - special_abilities: JSONB (специальные способности)
          - status: ENUM (active, inactive, story_locked)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status

