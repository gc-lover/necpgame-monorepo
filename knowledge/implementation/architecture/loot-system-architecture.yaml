metadata:
  id: loot-system-architecture
  title: Архитектура системы лута (Loot System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-22T21:45:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - loot
    - backend
    - economy
  related_systems:
    - loot-service-go
    - economy-service-go
    - gameplay-service-go
    - inventory-service-go
    - party-service-go
  related_documents:
    - id: backend-loot-system-part1
      relation: extends
    - id: implementation-backend-loot-system-part2
      relation: extends
  github_issue: 142
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы лута
    для генерации, распределения и выдачи предметов игрокам после боевых
    действий, квестов и других событий с поддержкой различных режимов
    распределения и продвинутых механик.
  goal: |
    Создать архитектурную схему системы лута с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы генерации лута
    - Системы распределения лута
    - Технического задания для реализации
  essence: |
    Экономическая система генерации и распределения лута с поддержкой
    различных режимов (personal, party, shared), roll системы, smart loot,
    world drops и гарантированных наград боссов.

architecture:
  overview: |
    Система лута состоит из шести основных компонентов:
    1. Loot Generator - генерация лута из таблиц
    2. Loot Distributor - распределение лута между игроками
    3. Loot Roll Manager - управление roll системой для групп
    4. Smart Loot Engine - умный лут с защитой от плохой удачи
    5. World Drop Manager - управление мировыми дропами
    6. Boss Loot Handler - обработка гарантированных наград боссов

  components:
    - name: Loot Generator
      location: loot-service-go (модуль loot-generation)
      responsibility: |
        - Генерация лута из loot tables
        - Применение luck модификаторов
        - Генерация валюты
        - Создание world drops
        - Обработка различных источников лута (NPC, контейнеры, квесты)
      loot_sources: |
        - NPC death: лут при смерти NPC
        - Container: лут из контейнеров
        - Quest reward: награды за квесты
        - Boss kill: лут от боссов
        - World event: лут от мировых событий
      endpoints:
        - POST /api/v1/economy/loot/generate - генерация лута
        - GET /api/v1/economy/loot/tables/{table_id} - получение loot table
        - POST /api/v1/economy/loot/apply-luck - применение luck модификатора

    - name: Loot Distributor
      location: loot-service-go (модуль loot-distribution)
      responsibility: |
        - Распределение лута между игроками
        - Обработка различных режимов распределения
        - Интеграция с inventory-service
        - Уведомления о получении лута
      distribution_modes: |
        - personal: личный лут для каждого игрока
        - party: общий лут для группы (с roll системой)
        - shared: общий лут для всех участников
        - boss: специальный режим для боссов
      endpoints:
        - POST /api/v1/economy/loot/distribute - распределение лута
        - GET /api/v1/economy/loot/distribution/{distribution_id} - статус распределения

    - name: Loot Roll Manager
      location: loot-service-go (модуль loot-rolls)
      responsibility: |
        - Управление roll системой для групп
        - Создание roll сессий
        - Обработка бросков игроков
        - Определение победителя
        - Таймауты и автоматическое распределение
      roll_mechanics: |
        - Need/Greed система
        - Таймаут на выбор (30 секунд)
        - Автоматическое распределение при таймауте
        - Логирование всех бросков
      endpoints:
        - POST /api/v1/economy/loot/rolls/create - создание roll сессии
        - POST /api/v1/economy/loot/rolls/{roll_id}/roll - бросок кубика
        - GET /api/v1/economy/loot/rolls/{roll_id} - статус roll сессии
        - POST /api/v1/economy/loot/rolls/{roll_id}/claim - получение предмета

    - name: Smart Loot Engine
      location: loot-service-go (модуль smart-loot)
      responsibility: |
        - Умный лут с учётом истории игрока
        - Защита от плохой удачи (Bad Luck Protection)
        - Адаптация под стиль игры игрока
        - Предотвращение дубликатов
      smart_loot_features: |
        - Отслеживание полученных предметов
        - Приоритет новых предметов
        - Адаптация под класс персонажа
        - Учёт активности игрока
      endpoints:
        - POST /api/v1/economy/loot/smart/generate - умная генерация лута
        - GET /api/v1/economy/loot/smart/history/{player_id} - история лута игрока

    - name: World Drop Manager
      location: loot-service-go (модуль world-drops)
      responsibility: |
        - Управление мировыми дропами
        - Создание world drops на карте
        - Обработка подбора world drops
        - Очистка истечённых world drops
      world_drop_features: |
        - Создание дропов на карте
        - Визуализация для всех игроков
        - Первый подобрал - получил
        - Таймаут на подбор (5 минут)
      endpoints:
        - POST /api/v1/economy/loot/world-drops/create - создание world drop
        - POST /api/v1/economy/loot/world-drops/{drop_id}/pickup - подбор world drop
        - GET /api/v1/economy/loot/world-drops/nearby - ближайшие world drops

    - name: Boss Loot Handler
      location: loot-service-go (модуль boss-loot)
      responsibility: |
        - Обработка гарантированных наград боссов
        - Специальные loot tables для боссов
        - Распределение наград между участниками
        - Уникальные предметы боссов
      boss_loot_features: |
        - Гарантированные награды
        - Уникальные предметы
        - Персональные награды для каждого участника
        - Дополнительные награды за первый kill
      endpoints:
        - POST /api/v1/economy/loot/boss/generate - генерация лута босса
        - POST /api/v1/economy/loot/boss/distribute - распределение наград босса

  data_flow:
    loot_generation: |
      1. Событие происходит (NPC смерть, контейнер открыт, квест завершён)
      2. Gameplay Service отправляет запрос на генерацию лута
      3. Loot Generator выбирает loot table
      4. Применяются luck модификаторы
      5. Генерируются предметы и валюта
      6. Определяется режим распределения
      7. Loot Distributor распределяет лут
      8. Inventory Service добавляет предметы
      9. Notification Service уведомляет игроков

    party_loot_distribution: |
      1. Генерируется лут для группы
      2. Loot Roll Manager создаёт roll сессию
      3. Участники делают выбор (Need/Greed)
      4. Определяется победитель
      5. Предмет выдаётся победителю
      6. Остальные предметы распределяются автоматически
      7. Realtime Gateway синхронизирует состояние

    world_drop_creation: |
      1. Генерируется world drop
      2. World Drop Manager создаёт дроп на карте
      3. Координаты сохраняются в БД
      4. Realtime Gateway уведомляет игроков в зоне
      5. Игрок подбирает дроп
      6. World Drop Manager обрабатывает подбор
      7. Inventory Service добавляет предмет

  integrations:
    with_gameplay_service: |
      - Получение событий о смерти NPC, открытии контейнеров
      - Интеграция с боевыми сессиями
      - Интеграция с квестами для наград

    with_inventory_service: |
      - Добавление предметов в инвентарь
      - Проверка свободного места
      - Обработка переполнения инвентаря

    with_party_service: |
      - Получение информации о группе
      - Распределение лута между участниками
      - Roll система для групп

    with_economy_service: |
      - Выдача валюты
      - Интеграция с экономической системой
      - Учёт стоимости предметов

    with_character_service: |
      - Получение данных персонажа (luck, уровень)
      - Применение модификаторов
      - Учёт класса персонажа для smart loot

    with_realtime_gateway: |
      - Уведомления о получении лута
      - Синхронизация roll сессий
      - Уведомления о world drops

  database_schema:
    tables:
      - name: loot_tables
        description: Таблицы лута
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - source_type: ENUM (npc, container, quest, boss, world_event)
          - source_id: UUID
          - min_items: INTEGER
          - max_items: INTEGER
          - currency_min: DECIMAL(20,2)
          - currency_max: DECIMAL(20,2)
          - luck_modifier: DECIMAL(5,2)
          - is_active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - source_type, source_id
          - is_active

      - name: loot_table_entries
        description: Записи в таблицах лута
        fields:
          - id: UUID (PK)
          - loot_table_id: UUID (FK loot_tables)
          - item_template_id: UUID (FK item_templates)
          - weight: INTEGER
          - min_quantity: INTEGER
          - max_quantity: INTEGER
          - drop_chance: DECIMAL(5,2)
          - is_guaranteed: BOOLEAN
          - min_level: INTEGER
          - max_level: INTEGER
        indexes:
          - loot_table_id
          - item_template_id

      - name: loot_distributions
        description: Распределения лута
        fields:
          - id: UUID (PK)
          - source_type: ENUM (npc, container, quest, boss)
          - source_id: UUID
          - distribution_mode: ENUM (personal, party, shared, boss)
          - party_id: UUID (FK parties, nullable)
          - status: ENUM (pending, distributed, expired)
          - created_at: TIMESTAMP
          - distributed_at: TIMESTAMP (nullable)
        indexes:
          - source_type, source_id
          - party_id, status
          - status, created_at

      - name: loot_distribution_items
        description: Предметы в распределениях
        fields:
          - id: UUID (PK)
          - distribution_id: UUID (FK loot_distributions)
          - item_template_id: UUID (FK item_templates)
          - quantity: INTEGER
          - assigned_to: UUID (FK accounts, nullable)
          - status: ENUM (pending, assigned, claimed)
        indexes:
          - distribution_id
          - assigned_to, status

      - name: loot_rolls
        description: Roll сессии для групп
        fields:
          - id: UUID (PK)
          - distribution_id: UUID (FK loot_distributions)
          - item_id: UUID (FK loot_distribution_items)
          - party_id: UUID (FK parties)
          - status: ENUM (active, completed, expired)
          - expires_at: TIMESTAMP
          - winner_id: UUID (FK accounts, nullable)
          - created_at: TIMESTAMP
        indexes:
          - distribution_id
          - party_id, status
          - expires_at

      - name: loot_roll_participants
        description: Участники roll сессий
        fields:
          - id: UUID (PK)
          - roll_id: UUID (FK loot_rolls)
          - account_id: UUID (FK accounts)
          - choice: ENUM (need, greed, pass)
          - roll_value: INTEGER
          - rolled_at: TIMESTAMP (nullable)
        indexes:
          - roll_id, account_id (unique)
          - roll_id, choice

      - name: world_drops
        description: Мировые дропы
        fields:
          - id: UUID (PK)
          - item_template_id: UUID (FK item_templates)
          - quantity: INTEGER
          - location_x: DECIMAL(10,2)
          - location_y: DECIMAL(10,2)
          - location_z: DECIMAL(10,2)
          - world_id: UUID
          - status: ENUM (active, picked_up, expired)
          - created_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - picked_up_by: UUID (FK accounts, nullable)
          - picked_up_at: TIMESTAMP (nullable)
        indexes:
          - world_id, location_x, location_y
          - status, expires_at
          - status, created_at

      - name: player_loot_history
        description: История лута игроков (для smart loot)
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - item_template_id: UUID (FK item_templates)
          - source_type: ENUM (npc, container, quest, boss)
          - obtained_at: TIMESTAMP
          - luck_value: DECIMAL(5,2)
        indexes:
          - player_id, obtained_at
          - item_template_id, player_id

technical_specification:
  backend_requirements:
    - Реализация модулей в loot-service-go:
      - loot-generation (генерация лута)
      - loot-distribution (распределение)
      - loot-rolls (roll система)
      - smart-loot (умный лут)
      - world-drops (мировые дропы)
      - boss-loot (лут боссов)
    - Интеграция с gameplay-service для событий
    - Интеграция с inventory-service для выдачи предметов
    - Интеграция с party-service для группового лута
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Уведомления о получении лута через WebSocket
    - Синхронизация roll сессий в реальном времени
    - Уведомления о world drops в зоне

  performance_requirements:
    - Генерация лута < 50ms
    - Распределение лута < 100ms
    - Создание roll сессии < 30ms
    - Поддержка до 1000 активных world drops
    - Поддержка до 100 активных roll сессий

  scalability_requirements:
    - Горизонтальное масштабирование через loot-service
    - Распределение нагрузки на генерацию лута
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование loot tables

subtasks:
  - id: loot-generator-module
    title: Реализация модуля Loot Generator
    description: |
      Генерация лута из таблиц
      Применение luck модификаторов
      Создание world drops
    priority: high
    estimated_time: 4-5 дней

  - id: loot-distributor-implementation
    title: Реализация Loot Distributor
    description: |
      Распределение лута между игроками
      Обработка различных режимов
      Интеграция с inventory-service
    priority: high
    estimated_time: 3-4 дня

  - id: loot-roll-manager
    title: Реализация Loot Roll Manager
    description: |
      Управление roll системой
      Обработка бросков игроков
      Таймауты и автоматическое распределение
    priority: high
    estimated_time: 3-4 дня

  - id: smart-loot-engine
    title: Реализация Smart Loot Engine
    description: |
      Умный лут с учётом истории
      Защита от плохой удачи
      Предотвращение дубликатов
    priority: medium
    estimated_time: 3-4 дня

  - id: world-drop-manager
    title: Реализация World Drop Manager
    description: |
      Управление мировыми дропами
      Обработка подбора
      Очистка истечённых дропов
    priority: medium
    estimated_time: 2-3 дня

  - id: boss-loot-handler
    title: Реализация Boss Loot Handler
    description: |
      Обработка наград боссов
      Гарантированные награды
      Уникальные предметы
    priority: high
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование loot tables
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для лута
      Интеграция с существующим API
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты генерации лута
      Тесты распределения
      Тесты roll системы
      Тесты интеграций
    priority: high
    estimated_time: 2-3 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Loot Service"
            LG[Loot Generator]
            LD[Loot Distributor]
            LRM[Loot Roll Manager]
            SLE[Smart Loot Engine]
            WDM[World Drop Manager]
            BLH[Boss Loot Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>loot_tables<br/>loot_distributions<br/>loot_rolls<br/>world_drops)]
        end

        subgraph "External Services"
            GS[Gameplay Service]
            IS[Inventory Service]
            PS[Party Service]
            ES[Economy Service]
            CS[Character Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        GS -->|loot request| LG
        LG --> LD
        LD --> LRM
        LD --> SLE
        LG --> WDM
        GS -->|boss kill| BLH
        LG -->|store| DB
        LD -->|add items| IS
        LRM -->|party info| PS
        LD -->|currency| ES
        SLE -->|player data| CS
        LD -->|notify| RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant NPC as NPC Death
        participant GS as Gameplay Service
        participant LG as Loot Generator
        participant LD as Loot Distributor
        participant LRM as Loot Roll Manager
        participant IS as Inventory Service
        participant RG as Realtime Gateway

        NPC->>GS: NPC killed
        GS->>LG: Generate loot
        LG->>LG: Select loot table
        LG->>LG: Apply luck modifier
        LG->>LD: Distribute loot
        LD->>LRM: Create roll session
        LRM->>RG: Notify players
        LRM->>LRM: Process rolls
        LRM->>IS: Add items to winner
        IS->>RG: Notify players
    ```

decisions:
  - id: adr-loot-architecture
    summary: |
      Выбрана модульная архитектура внутри loot-service-go для обеспечения
      централизованного управления всей системой лута.

  - id: adr-loot-distribution-modes
    summary: |
      Множественные режимы распределения обеспечивают гибкость для разных
      сценариев игры (solo, party, boss).

  - id: adr-roll-system
    summary: |
      Roll система для групп обеспечивает справедливое распределение лута
      и вовлечённость всех участников.

  - id: adr-smart-loot
    summary: |
      Smart loot система повышает удовлетворённость игроков, предотвращая
      дубликаты и адаптируясь под стиль игры.

  - id: adr-world-drops
    summary: |
      World drops создают динамичный игровой мир и дополнительные возможности
      для получения предметов.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение алгоритмов генерации лута

history:
  - version: '1.0.0'
    date: 2025-11-22
    author: Architect Agent
    changes: |
      Создана полная архитектура системы лута:
      - Определены компоненты (Loot Generator, Loot Distributor, Loot Roll Manager, Smart Loot Engine, World Drop Manager, Boss Loot Handler)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (loot_tables, loot_table_entries, loot_distributions, loot_rolls, world_drops, player_loot_history)
      - Спроектирована система генерации лута
      - Спроектирована система распределения лута
      - Создано техническое задание
      - Разбито на подзадачи

