# Issue: #142

metadata:
  id: architecture-loot-system
  title: "Loot System Architecture"
  document_type: architecture
  category: implementation
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-02T18:25:00Z
  owners:
    - role: architect
  tags:
    - loot
    - economy
    - gameplay
    - architecture
  related_systems:
    - economy-service
    - gameplay-service
    - inventory-service
    - character-service
  related_documents:
    - id: loot-system-part1
      relation: implements
    - id: loot-system-part2
      relation: implements

summary:
  problem: "Необходима архитектура генерации и распределения лута."
  goal: "Спроектировать систему лута с loot tables, smart loot, boss rewards."
  essence: "Архитектура описывает генерацию, распределение, roll system."

content:
  sections:
    - id: system-overview
      title: "Обзор системы"
      body: |
        Loot System управляет:
        - Генерация предметов из loot tables
        - Распределение лута (personal/shared/roll)
        - Smart loot (адаптация под класс)
        - Boss guaranteed rewards
        - Bad Luck Protection
        - World drops management
        - Anti-duplicate protection

        Принципы:
        - RNG с seed для воспроизводимости
        - Smart loot для релевантности
        - Fair distribution в группах
        - Guaranteed rewards для боссов
        - Event-driven интеграция

    - id: components
      title: "Компоненты"
      body: |
        ## economy-service (Loot Module)
        **Ответственность:** Генерация и распределение лута
        **Технологии:** Go, PostgreSQL, Redis, Kafka
        **API:** `/api/v1/economy/loot/*`
        
        Компоненты:
        - LootGenerator - генерация из tables
        - SmartLootEngine - адаптация под класс
        - DistributionManager - распределение в группах
        - RollSystem - roll механика
        - BadLuckProtection - гарантии дропа

        ## Интеграции
        - **Gameplay Service:** События combat:enemy-killed, raid:boss-defeated
        - **Inventory Service:** Добавление предметов
        - **Character Service:** Класс, специализация, luck stats
        - **Party Service:** Режим распределения, участники

    - id: api-endpoints
      title: "API Endpoints"
      body: |
        ## Loot Drops
        
        GET /api/v1/economy/loot/drops/nearby
        - Предметы в радиусе
        - Query: position, radius
        - Response: Array of world drops

        POST /api/v1/economy/loot/pickup
        - Подбор предмета
        - Request: drop_id
        - Response: Item added to inventory

        GET /api/v1/economy/loot/history
        - История лута
        - Query: limit, offset
        - Response: Array of loot history

        ## Loot Rolls

        GET /api/v1/economy/loot/rolls/active
        - Активные roll'ы
        - Response: Array of active rolls

        POST /api/v1/economy/loot/rolls/{rollId}/submit
        - Отправить roll
        - Request: choice (need/greed/pass)
        - Response: Roll result

        ## Loot Settings

        PUT /api/v1/economy/loot/settings
        - Настройки auto-loot
        - Request: auto_loot preferences
        - Response: Updated settings

    - id: database
      title: "База данных"
      body: |
        ## loot_tables
        ```sql
        CREATE TABLE loot_tables (
          id UUID PRIMARY KEY,
          source_type VARCHAR(50),
          source_id VARCHAR(100),
          item_template_id UUID,
          drop_chance DECIMAL(5,4),
          min_quantity INT,
          max_quantity INT,
          min_quality INT,
          max_quality INT,
          rarity VARCHAR(20),
          level_requirement INT,
          conditions JSONB
        );
        ```

        ## world_drops
        ```sql
        CREATE TABLE world_drops (
          id UUID PRIMARY KEY,
          items JSONB,
          currency JSONB,
          position JSONB,
          zone_id VARCHAR(100),
          created_at TIMESTAMP,
          expires_at TIMESTAMP,
          picked_up BOOLEAN,
          picked_up_by UUID,
          loot_mode VARCHAR(20)
        );
        ```

        ## loot_rolls
        ```sql
        CREATE TABLE loot_rolls (
          id UUID PRIMARY KEY,
          party_id UUID,
          item_id UUID,
          roll_type VARCHAR(20),
          participants JSONB,
          results JSONB,
          winner_id UUID,
          status VARCHAR(20),
          created_at TIMESTAMP,
          expires_at TIMESTAMP
        );
        ```

        ## loot_history
        ```sql
        CREATE TABLE loot_history (
          id UUID PRIMARY KEY,
          player_id UUID,
          item_id UUID,
          quantity INT,
          source_type VARCHAR(50),
          source_id UUID,
          timestamp TIMESTAMP,
          rarity VARCHAR(20)
        );
        ```

    - id: loot-generation
      title: "Генерация лута"
      body: |
        ## Loot Flow

        1. Enemy/Boss defeated
        2. Gameplay Service → Event: combat:enemy-killed
        3. Loot Service (consumer) → Triggered
        4. Load loot_tables for source
        5. RNG generation (with luck modifiers)
        6. Smart Loot filter (class adaptation)
        7. Bad Luck Protection check
        8. Create world_drop OR direct add to inventory
        9. Publish event: loot:generated

        ## Smart Loot Algorithm

        1. Get character class/specialization
        2. Filter loot for relevant stats
        3. Increase probability for class items
        4. Remove irrelevant items
        5. Apply luck modifiers

        ## Bad Luck Protection

        - Track legendary drops per player
        - If no legendary drop in 7 days → guarantee next
        - Reset timer after legendary drop
        - Storage: PostgreSQL + Redis cache

    - id: distribution
      title: "Распределение лута"
      body: |
        ## Personal Loot

        - Each player gets own loot
        - No competition
        - Auto-pickup available
        - Best for solo/casual

        ## Party Roll

        - Items go to roll system
        - Players: Need/Greed/Pass
        - Highest roll wins
        - Timeout: 60 seconds
        - Fair for groups

        ## Master Loot

        - Party leader distributes
        - Manual assignment
        - For organized groups/guilds

        ## Boss Loot

        - Guaranteed rewards for all participants
        - Extra boss-specific loot (roll)
        - Achievement publishing
        - Logging for audit

    - id: events
      title: "Event Sourcing"
      body: |
        ## Topics

        ### loot.generated
        ```json
        {
          "event_type": "loot.generated",
          "source_type": "enemy",
          "source_id": "uuid",
          "items": [...],
          "player_ids": [...]
        }
        ```

        ### loot.picked_up
        ```json
        {
          "event_type": "loot.picked_up",
          "player_id": "uuid",
          "item_id": "uuid",
          "drop_id": "uuid"
        }
        ```

        ### legendary.dropped
        ```json
        {
          "event_type": "legendary.dropped",
          "player_id": "uuid",
          "item_id": "uuid",
          "rarity": "legendary"
        }
        ```

        ## Consumers
        - Inventory Service: Add items
        - Achievement Service: Legendary drops
        - Analytics Service: Loot statistics

    - id: scalability
      title: "Масштабируемость"
      body: |
        ## Caching
        - Loot tables в Redis (TTL: 1 hour)
        - Bad Luck Protection в Redis
        - Active rolls в Redis (TTL: 2 minutes)

        ## Background Jobs
        - Cleanup expired world drops (every 5 min)
        - Cleanup expired rolls (every 1 min)
        - Update loot table cache (every hour)

        ## Performance
        - Loot generation: <50ms
        - Pickup: <100ms
        - Roll: <10ms
        - DB queries: indexed

appendix:
  glossary:
    - term: "Smart Loot"
      definition: "Адаптация лута под класс персонажа"
    - term: "Bad Luck Protection"
      definition: "Гарантия legendary дропа раз в 7 дней"
  decisions:
    - id: "loot-001"
      decision: "Smart Loot обязателен"
      rationale: "Улучшает игровой опыт"
    - id: "loot-002"
      decision: "Multiple distribution modes"
      rationale: "Гибкость для разных групп"

implementation:
  github_issue: 142
  needs_task: true
  next_steps:
    - "Database: Миграции для loot tables"
    - "API Designer: OpenAPI спецификация"
    - "Backend: Реализация Loot Module"

history:
  - version: "1.0.0"
    date: 2025-12-02
    author: architect
    changes: "Создана архитектура Loot System"
