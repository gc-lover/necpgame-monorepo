<!-- Issue: #151 -->

# Архитектура почтовой системы - Part 2: Business Logic & Operations

**См. также:** [Part 1: Core Architecture](./mail-system-architecture-part1.md)

---

## 5. Бизнес-логика

### 5.1. Типы писем

| Mail Type | Отправитель | Вложения | COD | Истечение |
|-----------|-------------|----------|-----|-----------|
| `player` | Player | Да | Да | 7 дней |
| `system` | System | Нет | Нет | 30 дней |
| `quest_reward` | System | Да | Нет | 30 дней |
| `auction_win` | System | Да | Нет | 7 дней |
| `auction_return` | System | Да | Нет | 7 дней |
| `admin` | Admin | Да | Нет | 365 дней |

### 5.2. Лимиты и ограничения

**Отправка:**
- 10 писем/час (player-to-player)
- 50 писем/час (VIP)
- Без лимитов (системные)

**Размер:**
- Тема: max 255 символов
- Текст: max 5000 символов
- Вложения: max 10 предметов
- COD: max 1,000,000 gold

**Хранение:**
- Непрочитанные: 30 дней
- Прочитанные без вложений: 7 дней
- С вложениями: 30 дней

### 5.3. Возврат писем

**Условия:**
- Истекло с незабранными вложениями
- Получатель не существует
- Получатель заблокирован

**Процесс:**
1. Создать письмо для отправителя
2. Перенести вложения
3. Указать `return_reason`
4. Уведомить

### 5.4. COD Механика

- Отправитель указывает сумму COD
- Получатель оплачивает при получении
- Деньги переводятся отправителю
- Если не оплачено → возврат

---

## 6. События (Event-Driven)

### 6.1. Published Events

**mail:sent**
```json
{
  "mail_id": "uuid",
  "sender_id": "uuid",
  "recipient_id": "uuid",
  "has_attachments": true
}
```

**mail:attachment-claimed**
```json
{
  "mail_id": "uuid",
  "recipient_id": "uuid",
  "items_claimed": [...],
  "cod_paid": 500
}
```

**mail:expired**, **mail:returned**

### 6.2. Subscribed Events

- `quest:completed` → автоотправка наград
- `auction:won` → доставка предмета
- `auction:expired` → возврат ставки
- `admin:compensation` → массовая рассылка

---

## 7. Производительность

### 7.1. Метрики

- API response: < 100ms (p95)
- Mail delivery: < 1s
- Expiration worker: каждые 15 мин
- Throughput: 1000+ писем/сек

### 7.2. Оптимизации

**PostgreSQL:**
- Индексы на `recipient_id`, `expires_at`
- Партиционирование по `sent_at` (ежемесячно)
- Архивация (> 6 месяцев)

**Redis:**
- Кэш inbox (TTL: 5 мин)
- Счётчики непрочитанных

**Rate Limiting:**
- Sliding window algorithm

### 7.3. Мониторинг

**Метрики:**
- `mail_sent_total`
- `mail_pending`
- `mail_expired_hourly`
- `mail_returned_total`
- `api_latency_p95`

**Алерты:**
- `mail_pending > 10000`
- `api_latency_p95 > 200ms`
- `mail_expired_hourly > 1000`

---

## 8. Безопасность

### 8.1. Защита от спама

- Rate limiting (10 писем/час)
- Временная блокировка
- Чёрный список

### 8.2. Валидация

- Существование получателя
- Наличие предметов
- Баланс валюты

### 8.3. Audit Log

Все действия в `mail_audit_log`:
- Отправка, чтение, получение, истечение, возврат

---

## 9. Разбиение на подзадачи

### 9.1. Database Schema (P0)
**Срок:** 1 неделя

### 9.2. Mail REST API (P0)
**Срок:** 2 недели

### 9.3. Attachment Manager (P0)
**Срок:** 1.5 недели

### 9.4. Expiration Worker (P1)
**Срок:** 1 неделя

### 9.5. Event Integration (P1)
**Срок:** 1 неделя

### 9.6. System Mails API (P2)
**Срок:** 1 неделя

### 9.7. WebSocket Notifications (P2)
**Срок:** 0.5 недели

### 9.8. Monitoring (P2)
**Срок:** 1 неделя

---

## 10. Риски и зависимости

### 10.1. Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Спам | Высокая | Среднее | Rate limiting, блокировка |
| Потеря вложений | Низкая | Критическое | Транзакции, audit log |
| Высокая latency | Средняя | Среднее | Redis кэш, индексы |
| Переполнение БД | Средняя | Высокое | Автоочистка, партиционирование |

### 10.2. Зависимости

**Критические:** Inventory Service, Economy Service

**Опциональные:** Notification, Quest, Auction Services

---

## 11. Критерии готовности

- [x] Архитектура спроектирована
- [x] Компоненты определены
- [x] Микросервисы идентифицированы
- [x] API endpoints описаны
- [x] Система вложений спроектирована
- [x] Система COD спроектирована
- [x] Система истечения спроектирована
- [x] Техническое задание готово
- [x] Разбиение на подзадачи выполнено

---

**Конец Part 2**






























