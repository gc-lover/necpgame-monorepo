metadata:
  id: mail-system-architecture
  title: Архитектура почтовой системы (Mail System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-22T22:15:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - mail
    - backend
    - social
  related_systems:
    - mail-service-go
    - social-service-go
    - economy-service-go
    - inventory-service-go
    - notification-service-go
  related_documents:
    - id: mail-system
      relation: extends
  github_issue: 151
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру почтовой системы
    для доставки сообщений, предметов и наград между игроками с поддержкой
    вложений, COD, системных рассылок и автоматического истечения.
  goal: |
    Создать архитектурную схему почтовой системы с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы вложений
    - Системы COD
    - Системы автоматического истечения
    - Технического задания для реализации
  essence: |
    Социальная система доставки сообщений, предметов и наград между игроками
    с поддержкой вложений, COD, системных рассылок и автоматического истечения.

architecture:
  overview: |
    Почтовая система состоит из пяти основных компонентов:
    1. Mail Manager - управление письмами
    2. Attachment Handler - обработка вложений
    3. COD Processor - обработка COD (Cash on Delivery)
    4. Expiration Manager - управление истечением писем
    5. System Mail Sender - системные рассылки

  components:
    - name: Mail Manager
      location: mail-service-go (модуль mail)
      responsibility: |
        - Управление письмами (создание, отправка, получение)
        - Управление статусами писем (unread, read, claimed, expired)
        - Поиск и фильтрация писем
        - Интеграция с другими модулями
      port: 8086 (mail-service-go)
      endpoints:
        - POST /api/v1/social/mail/send - отправка письма
        - GET /api/v1/social/mail/inbox - входящие письма
        - GET /api/v1/social/mail/{mail_id} - получение письма
        - PUT /api/v1/social/mail/{mail_id}/read - пометка как прочитанное
        - DELETE /api/v1/social/mail/{mail_id} - удаление письма
        - GET /api/v1/social/mail/unread-count - количество непрочитанных

    - name: Attachment Handler
      location: mail-service-go (модуль attachments)
      responsibility: |
        - Управление вложениями (предметы, валюта)
        - Проверка доступности вложений
        - Выдача вложений игрокам
        - Интеграция с inventory-service и economy-service
      attachment_types: |
        - items: предметы
        - currency: валюта
        - quest_rewards: награды за квесты
        - achievement_rewards: награды за достижения
      endpoints:
        - POST /api/v1/social/mail/{mail_id}/attachments/claim - получение вложений
        - GET /api/v1/social/mail/{mail_id}/attachments - список вложений

    - name: COD Processor
      location: mail-service-go (модуль cod)
      responsibility: |
        - Обработка COD (Cash on Delivery)
        - Проверка баланса получателя
        - Списание средств при получении
        - Возврат при отказе
      cod_features: |
        - Установка стоимости доставки
        - Проверка баланса перед выдачей
        - Автоматический возврат при истечении
      endpoints:
        - POST /api/v1/social/mail/{mail_id}/cod/pay - оплата COD
        - POST /api/v1/social/mail/{mail_id}/cod/decline - отказ от COD

    - name: Expiration Manager
      location: mail-service-go (модуль expiration)
      responsibility: |
        - Управление истечением писем
        - Автоматическая очистка истёкших писем
        - Возврат вложений отправителю
        - Уведомления об истечении
      expiration_rules: |
        - Системные письма: 30 дней
        - Письма от игроков: 7 дней
        - Письма с COD: 3 дня
        - Награды: 14 дней
      endpoints:
        - GET /api/v1/social/mail/expiring - истекающие письма
        - POST /api/v1/social/mail/{mail_id}/extend - продление срока

    - name: System Mail Sender
      location: mail-service-go (модуль system-mail)
      responsibility: |
        - Системные рассылки
        - Массовая отправка писем
        - Шаблоны системных писем
        - Интеграция с event bus
      system_mail_types: |
        - quest_rewards: награды за квесты
        - achievement_rewards: награды за достижения
        - maintenance_notifications: уведомления о технических работах
        - event_rewards: награды за события
      endpoints:
        - POST /api/v1/social/mail/system/send - отправка системного письма
        - POST /api/v1/social/mail/system/broadcast - массовая рассылка

  data_flow:
    mail_sending: |
      1. Игрок отправляет письмо
      2. Mail Manager валидирует получателя и вложения
      3. Attachment Handler проверяет наличие предметов/валюты
      4. Economy Service списывает предметы/валюту
      5. Письмо сохраняется в БД
      6. Notification Service уведомляет получателя
      7. Realtime Gateway отправляет push уведомление

    attachment_claiming: |
      1. Игрок запрашивает получение вложений
      2. Attachment Handler проверяет статус письма
      3. Если COD - COD Processor проверяет баланс
      4. Inventory Service добавляет предметы
      5. Economy Service добавляет валюту
      6. Статус письма обновляется на "claimed"
      7. Realtime Gateway уведомляет об обновлении

    mail_expiration: |
      1. Expiration Manager проверяет истекающие письма
      2. Если письмо истекло и не прочитано
      3. Если есть вложения - возвращаются отправителю
      4. Письмо помечается как expired
      5. Уведомления отправляются обеим сторонам

  integrations:
    with_economy_service: |
      - Списание/начисление валюты
      - Проверка баланса для COD
      - Интеграция с экономической системой

    with_inventory_service: |
      - Добавление предметов в инвентарь
      - Проверка свободного места
      - Обработка переполнения инвентаря

    with_social_service: |
      - Интеграция с системой друзей
      - Уведомления о письмах
      - История переписки

    with_notification_service: |
      - Уведомления о новых письмах
      - Уведомления об истечении
      - Уведомления о получении вложений

    with_gameplay_service: |
      - Получение событий о наградах
      - Автоматическая отправка наград
      - Интеграция с квестами

    with_realtime_gateway: |
      - Push уведомления о новых письмах
      - Обновления статуса писем
      - Синхронизация состояния

  database_schema:
    tables:
      - name: mail_messages
        description: Письма игроков
        fields:
          - id: UUID (PK)
          - sender_id: UUID (FK accounts, nullable) - null для системных
          - recipient_id: UUID (FK accounts)
          - subject: VARCHAR(255)
          - body: TEXT
          - type: ENUM (player, system, quest_reward, achievement_reward, event_reward)
          - status: ENUM (unread, read, claimed, expired, deleted)
          - cod_amount: DECIMAL(20,2) (nullable)
          - cod_currency: VARCHAR(50) (nullable)
          - sent_at: TIMESTAMP
          - read_at: TIMESTAMP (nullable)
          - expires_at: TIMESTAMP
          - claimed_at: TIMESTAMP (nullable)
        indexes:
          - recipient_id, status
          - sender_id, sent_at
          - status, expires_at
          - type, sent_at

      - name: mail_attachments
        description: Вложения в письмах
        fields:
          - id: UUID (PK)
          - mail_id: UUID (FK mail_messages)
          - attachment_type: ENUM (item, currency, quest_reward)
          - item_id: UUID (FK items, nullable)
          - item_quantity: INTEGER (nullable)
          - currency_type: VARCHAR(50) (nullable)
          - currency_amount: DECIMAL(20,2) (nullable)
          - is_claimed: BOOLEAN (default: false)
          - claimed_at: TIMESTAMP (nullable)
        indexes:
          - mail_id
          - is_claimed

      - name: mail_returns
        description: Возвраты писем при истечении
        fields:
          - id: UUID (PK)
          - mail_id: UUID (FK mail_messages)
          - returned_at: TIMESTAMP
          - reason: ENUM (expired, declined, inventory_full)
        indexes:
          - mail_id

technical_specification:
  backend_requirements:
    - Реализация модулей в mail-service-go:
      - mail (управление письмами)
      - attachments (вложения)
      - cod (COD обработка)
      - expiration (истечение)
      - system-mail (системные рассылки)
    - Интеграция с economy-service для валюты
    - Интеграция с inventory-service для предметов
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Уведомления о новых письмах через WebSocket
    - Обновления статуса писем в реальном времени
    - Синхронизация количества непрочитанных

  performance_requirements:
    - Отправка письма < 100ms
    - Получение списка писем < 50ms
    - Получение вложений < 100ms
    - Поддержка до 100K писем на игрока
    - Поддержка до 10K активных писем

  scalability_requirements:
    - Горизонтальное масштабирование через mail-service
    - Распределение нагрузки на письма
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование непрочитанных писем

subtasks:
  - id: mail-manager-module
    title: Реализация модуля Mail Manager
    description: |
      Управление письмами
      CRUD операции
      Поиск и фильтрация
    priority: high
    estimated_time: 3-4 дня

  - id: attachment-handler-implementation
    title: Реализация Attachment Handler
    description: |
      Управление вложениями
      Выдача предметов и валюты
      Интеграция с inventory и economy
    priority: high
    estimated_time: 3-4 дня

  - id: cod-processor-development
    title: Реализация COD Processor
    description: |
      Обработка COD
      Проверка баланса
      Возврат при отказе
    priority: medium
    estimated_time: 2-3 дня

  - id: expiration-manager-implementation
    title: Реализация Expiration Manager
    description: |
      Управление истечением
      Автоматическая очистка
      Возврат вложений
    priority: high
    estimated_time: 2-3 дня

  - id: system-mail-sender
    title: Реализация System Mail Sender
    description: |
      Системные рассылки
      Массовая отправка
      Шаблоны писем
    priority: medium
    estimated_time: 2-3 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование непрочитанных
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для почты
      Интеграция с существующим API
    priority: high
    estimated_time: 2-3 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты отправки писем
      Тесты вложений
      Тесты COD
      Тесты интеграций
    priority: high
    estimated_time: 2-3 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Mail Service"
            MM[Mail Manager]
            AH[Attachment Handler]
            CP[COD Processor]
            EM[Expiration Manager]
            SMS[System Mail Sender]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>mail_messages<br/>mail_attachments<br/>mail_returns)]
        end

        subgraph "External Services"
            ES[Economy Service]
            IS[Inventory Service]
            SS[Social Service]
            NS[Notification Service]
            GS[Gameplay Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|send mail| MM
        MM --> AH
        MM --> CP
        MM --> EM
        MM --> SMS
        MM -->|store| DB
        AH -->|add items| IS
        AH -->|add currency| ES
        CP -->|check balance| ES
        SMS -->|events| GS
        MM -->|notify| NS
        MM -->|sync state| RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant S as Sender
        participant MM as Mail Manager
        participant AH as Attachment Handler
        participant ES as Economy Service
        participant R as Recipient
        participant IS as Inventory Service

        S->>MM: Send mail with attachments
        MM->>AH: Validate attachments
        AH->>ES: Check balance
        ES->>AH: Balance OK
        MM->>MM: Store mail
        MM->>R: Notify recipient
        
        R->>MM: Claim attachments
        MM->>AH: Process claim
        AH->>IS: Add items
        AH->>ES: Add currency
        MM->>MM: Update status
    ```

decisions:
  - id: adr-mail-architecture
    summary: |
      Выбрана модульная архитектура внутри mail-service-go для обеспечения
      централизованного управления всей почтовой системой.

  - id: adr-attachments
    summary: |
      Система вложений с интеграцией inventory и economy обеспечивает
      безопасную передачу предметов и валюты между игроками.

  - id: adr-cod-system
    summary: |
      COD система обеспечивает безопасную торговлю через почту с защитой
      от мошенничества.

  - id: adr-expiration
    summary: |
      Автоматическое истечение писем предотвращает накопление неактуальных
      данных и обеспечивает возврат вложений.

  - id: adr-system-mail
    summary: |
      Системные рассылки обеспечивают автоматическую доставку наград и
      уведомлений от игровых систем.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение правил истечения

history:
  - version: '1.0.0'
    date: 2025-11-22
    author: Architect Agent
    changes: |
      Создана полная архитектура почтовой системы:
      - Определены компоненты (Mail Manager, Attachment Handler, COD Processor, Expiration Manager, System Mail Sender)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (mail_messages, mail_attachments, mail_returns)
      - Спроектирована система вложений
      - Спроектирована система COD
      - Спроектирована система автоматического истечения
      - Создано техническое задание
      - Разбито на подзадачи


