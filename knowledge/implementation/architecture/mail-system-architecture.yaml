# Issue: #143577317
# Mail System Architecture
# Спроектировано Architect агентом

version: "1.0.0"
last_updated: "2025-12-13"
author: "Architect Agent"

metadata:
  system_name: "Mail System"
  description: "Система внутренней почты для коммуникации игроков с поддержкой вложений и уведомлений"
  domain: "Social"
  criticality: "High"
  performance_requirements:
    peak_load: "3k req/sec"
    concurrent_users: "25k"
    p99_latency: "<200ms"
    data_retention: "90 days"

architecture_overview:
  purpose: |
    Mail System предоставляет полноценную систему внутренней почты для игры,
    позволяя игрокам обмениваться сообщениями, предметами и валютой.

  key_features:
    - Отправка сообщений между игроками
    - Система вложений (предметы, валюта)
    - Папки и организация почты
    - Уведомления о новых сообщениях
    - Система черного списка
    - Поиск по сообщениям
    - Автоматические системные сообщения

  business_value:
    - Улучшение социального взаимодействия
    - Экономический обмен между игроками
    - Система поддержки игроков
    - Автоматизированные уведомления

components:
  mail_manager:
    description: "Управление почтовыми ящиками и сообщениями"
    responsibilities:
      - CRUD операции с сообщениями
      - Управление папками и метками
      - Поиск по сообщениям
      - Управление настройками почты
    interfaces:
      - REST API: /mail/admin/*
      - Internal: MailManager interface
    dependencies:
      - Database: mail_messages, player_mailboxes

  message_handler:
    description: "Обработка отправки и получения сообщений"
    responsibilities:
      - Валидация получателей
      - Обработка вложений
      - Отправка уведомлений
      - Управление черным списком
    interfaces:
      - Event Bus: mail:send, mail:received
      - Internal: MessageHandler interface
    dependencies:
      - Character Service для валидации игроков
      - Notification Service для оповещений

  attachment_processor:
    description: "Обработка вложений в сообщения"
    responsibilities:
      - Валидация предметов и валюты
      - Передача собственности на вложения
      - Обработка возвратов при ошибках
      - Управление временными блокировками
    interfaces:
      - Internal: AttachmentProcessor interface
    dependencies:
      - Economy Service для валюты
      - Inventory Service для предметов

  spam_filter:
    description: "Фильтрация спама и защита от злоупотреблений"
    responsibilities:
      - Анализ паттернов отправки
      - Блокировка подозрительной активности
      - Управление черным списком
      - Отчеты о нарушениях
    interfaces:
      - Internal: SpamFilter interface
    dependencies:
      - Security Service для проверки
      - Analytics для паттернов

  notification_system:
    description: "Управление уведомлениями о почте"
    responsibilities:
      - Отправка push-уведомлений
      - Управление настройками уведомлений
      - Агрегация уведомлений
      - Обработка оффлайн сообщений
    interfaces:
      - Event Bus: notification:*
      - WebSocket: real-time notifications
    dependencies:
      - Realtime Gateway для push
      - Notification Service

data_model:
  tables:
    player_mailboxes:
      description: "Почтовые ящики игроков"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        total_messages: "INTEGER NOT NULL DEFAULT 0"
        unread_count: "INTEGER NOT NULL DEFAULT 0"
        max_messages: "INTEGER NOT NULL DEFAULT 1000"
        settings: "JSONB" # настройки уведомлений, автоудаления
        created_at: "TIMESTAMP NOT NULL"
        updated_at: "TIMESTAMP NOT NULL"
      indexes:
        - "player_id (UNIQUE)"
      partitioning: "HASH (player_id)" # для равномерного распределения

    mail_messages:
      description: "Сообщения почты"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        sender_id: "BIGINT NOT NULL"
        recipient_id: "BIGINT NOT NULL"
        subject: "VARCHAR(200) NOT NULL"
        content: "TEXT NOT NULL"
        message_type: "VARCHAR(20) NOT NULL" # PLAYER, SYSTEM, ADMIN, TRADE
        status: "VARCHAR(20) NOT NULL" # SENT, DELIVERED, READ, DELETED
        priority: "VARCHAR(10) NOT NULL DEFAULT 'NORMAL'" # LOW, NORMAL, HIGH, URGENT
        has_attachments: "BOOLEAN DEFAULT FALSE"
        folder_id: "BIGINT" # NULL для входящих
        sent_at: "TIMESTAMP NOT NULL"
        read_at: "TIMESTAMP"
        expires_at: "TIMESTAMP" # автоудаление
        metadata: "JSONB" # дополнительные данные
      indexes:
        - "recipient_id, status, sent_at DESC"
        - "sender_id, sent_at DESC"
        - "message_type, sent_at DESC"
        - "expires_at" # для автоудаления
      partitioning: "RANGE (sent_at)" # месячная партиция

    mail_attachments:
      description: "Вложения в сообщения"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        message_id: "BIGINT NOT NULL"
        attachment_type: "VARCHAR(20) NOT NULL" # CURRENCY, ITEM, BLUEPRINT
        item_id: "VARCHAR(100)" # ID предмета или тип валюты
        quantity: "INTEGER"
        value: "DECIMAL(15,2)" # для валюты
        metadata: "JSONB" # дополнительные свойства
        status: "VARCHAR(20) NOT NULL" # PENDING, ATTACHED, CLAIMED, RETURNED
        created_at: "TIMESTAMP NOT NULL"
      indexes:
        - "message_id"
        - "status"
      partitioning: "RANGE (created_at)" # месячная партиция

    mail_folders:
      description: "Папки для организации почты"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        name: "VARCHAR(50) NOT NULL"
        folder_type: "VARCHAR(20) NOT NULL" # CUSTOM, SYSTEM (INBOX, SENT, TRASH, SPAM)
        message_count: "INTEGER NOT NULL DEFAULT 0"
        is_default: "BOOLEAN DEFAULT FALSE"
        created_at: "TIMESTAMP NOT NULL"
        updated_at: "TIMESTAMP NOT NULL"
      indexes:
        - "player_id, folder_type"
        - "player_id, name (UNIQUE)"
      partitioning: "HASH (player_id)"

    mail_blacklist:
      description: "Черный список игроков"
      fields:
        id: "BIGSERIAL PRIMARY KEY"
        player_id: "BIGINT NOT NULL"
        blocked_player_id: "BIGINT NOT NULL"
        reason: "VARCHAR(200)"
        created_at: "TIMESTAMP NOT NULL"
        expires_at: "TIMESTAMP"
      indexes:
        - "player_id, blocked_player_id (UNIQUE)"
        - "blocked_player_id"
        - "expires_at"

  caching_strategy:
    redis_keys:
      - "mail:player:{player_id}:unread" # счетчик непрочитанных
      - "mail:player:{player_id}:recent" # последние сообщения
      - "mail:message:{id}" # кэш сообщения
      - "mail:blacklist:{player_id}" # черный список
    ttl:
      unread: "1h"
      recent: "30m"
      messages: "1h"
      blacklist: "24h"

api_endpoints:
  player:
    - "GET /mail/messages" # список сообщений с пагинацией
    - "GET /mail/messages/{id}" # получить сообщение
    - "POST /mail/send" # отправить сообщение
    - "PUT /mail/messages/{id}/read" # отметить как прочитанное
    - "DELETE /mail/messages/{id}" # удалить сообщение
    - "POST /mail/messages/{id}/claim" # получить вложения

  folders:
    - "GET /mail/folders" # список папок
    - "POST /mail/folders" # создать папку
    - "PUT /mail/folders/{id}" # переименовать папку
    - "DELETE /mail/folders/{id}" # удалить папку
    - "PUT /mail/messages/{id}/folder" # переместить в папку

  social:
    - "GET /mail/blacklist" # черный список
    - "POST /mail/blacklist" # добавить в черный список
    - "DELETE /mail/blacklist/{player_id}" # удалить из черного списка

  admin:
    - "POST /mail/admin/broadcast" # массовое сообщение
    - "GET /mail/admin/stats" # статистика почты
    - "POST /mail/admin/spam-report" # отчет о спаме

event_driven_architecture:
  published_events:
    - "mail:message-sent" # сообщение отправлено
    - "mail:message-delivered" # сообщение доставлено
    - "mail:message-read" # сообщение прочитано
    - "mail:attachment-claimed" # вложение получено
    - "mail:blacklist-updated" # черный список изменен

  subscribed_events:
    - "player:login" # уведомление о непрочитанных
    - "character:level-up" # системные поздравления
    - "achievement:unlocked" # поздравления с достижениями
    - "economy:transaction-completed" # уведомления о транзакциях

integrations:
  character_service:
    purpose: "Валидация игроков и получение информации"
    endpoints:
      - "GET /character/{id}/exists"
      - "GET /character/{id}/basic"
    events:
      - "character:created"
      - "character:deleted"

  economy_service:
    purpose: "Обработка валютных вложений"
    endpoints:
      - "POST /economy/transfer"
      - "POST /economy/freeze"
      - "POST /economy/unfreeze"
    events:
      - "economy:transfer-completed"
      - "economy:transfer-failed"

  inventory_service:
    purpose: "Обработка предметных вложений"
    endpoints:
      - "POST /inventory/transfer"
      - "POST /inventory/lock"
      - "POST /inventory/unlock"
    events:
      - "inventory:transfer-completed"

  notification_service:
    purpose: "Отправка уведомлений"
    endpoints:
      - "POST /notification/send"
      - "POST /notification/bulk"
    events:
      - "notification:delivered"

  realtime_gateway:
    purpose: "Real-time уведомления"
    endpoints:
      - "POST /realtime/personal/{player_id}"
      - "POST /realtime/broadcast"
    events:
      - "realtime:connected"
      - "realtime:disconnected"

performance_optimizations:
  level_1_basics:
    - Context timeouts для всех операций
    - DB connection pool (25-50 connections)
    - Redis caching для счетчиков
    - Structured logging

  level_2_hot_path:
    - Message batching для массовых отправок
    - Lazy loading для вложений
    - Pagination для списков сообщений
    - Attachment pre-validation

  level_3_gaming:
    - Sharding по player_id для равномерной нагрузки
    - Time-based partitioning для старых сообщений
    - Background cleanup для expired messages
    - CDN для attachment metadata

data_consistency:
  patterns:
    event_sourcing:
      description: "Все изменения почты через events"
      implementation: "Outbox pattern для гарантированной доставки"
    saga:
      description: "Распределенные транзакции для вложений"
      compensation: "Возврат вложений при ошибках отправки"
    eventual_consistency:
      description: "Финальные консистентность для счетчиков"
      implementation: "Background sync jobs"

  sync_mechanisms:
    - Immediate consistency для отправки сообщений
    - Eventual consistency для счетчиков непрочитанных
    - Strong consistency для вложений

scaling_strategy:
  horizontal_scaling:
    - Stateless API services
    - Shared Redis для кэша
    - Event-driven communication
    - Database read replicas

  data_partitioning:
    - Hash partitioning по player_id для mailboxes
    - Range partitioning по sent_at для messages
    - Composite partitioning для attachments

  load_distribution:
    - Message queues для асинхронной обработки
    - Background jobs для cleanup
    - Rate limiting для spam prevention

monitoring_and_observability:
  metrics:
    - mail_messages_sent_total
    - mail_messages_delivered_total
    - mail_attachments_claimed_total
    - mail_average_response_time
    - mail_error_rate

  alerts:
    - High undelivered message rate
    - Attachment processing failures
    - Spam filter false positives
    - Database connection issues

  logging:
    - Structured logs for all operations
    - Audit trail for attachments
    - Performance profiling for slow queries

migration_plan:
  current_state: "No mail system"
  target_state: "Full mail system with attachments"

  phases:
    phase_1: "Core messaging (2 weeks)"
    phase_2: "Attachments system (2 weeks)"
    phase_3: "Advanced features (2 weeks)"
    phase_4: "Optimization (1 week)"

  dependencies:
    - Character Service ready
    - Economy Service ready
    - Inventory Service ready
    - Notification Service ready

testing_strategy:
  unit_tests:
    - Message validation logic
    - Attachment processing
    - Spam filtering algorithms

  integration_tests:
    - End-to-end message sending
    - Attachment claiming flows
    - Cross-service communication

  performance_tests:
    - Message throughput (1000 msg/sec)
    - Attachment processing load
    - Database query performance

  security_tests:
    - Attachment validation
    - Spam prevention
    - Data privacy

change_history:
  - version: "1.0.0"
    date: "2025-12-13"
    changes:
      - Initial architecture design
      - Component specification
      - API design
      - Data model definition
      - Integration planning
