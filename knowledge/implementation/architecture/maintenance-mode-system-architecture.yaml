metadata:
  id: maintenance-mode-system-architecture
  title: Архитектура системы режима обслуживания
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-30T20:55:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - infrastructure
    - operations
    - maintenance
  related_systems:
    - infrastructure-service
    - social-service
    - gameplay-service
    - notification-service
    - api-gateway
  related_documents:
    - id: backend-maintenance-mode-system
      relation: implements
  github_issue: 316
  visibility: internal
  audience:
    - architect
    - backend
    - infrastructure
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы режима обслуживания, включающую:
    - Управление плановым обслуживанием
    - Управление экстренным обслуживанием
    - Систему graceful shutdown
    - Систему уведомлений игроков
    - Блокировку новых соединений
    - Интеграции с инфраструктурой
  goal: |
    Создать архитектурную схему системы режима обслуживания с определением:
    - Компонентов для управления обслуживанием
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы режима обслуживания с поддержкой планового и экстренного обслуживания,
    graceful shutdown и уведомлений.

architecture:
  overview: |
    Архитектура системы режима обслуживания состоит из следующих компонентов:
    1. Maintenance Manager - управление системой обслуживания
    2. Maintenance Window Manager - управление окнами обслуживания
    3. Maintenance Status Manager - управление статусом обслуживания
    4. Scheduled Maintenance Manager - управление плановым обслуживанием
    5. Emergency Maintenance Manager - управление экстренным обслуживанием
    6. Graceful Shutdown Manager - управление graceful shutdown
    7. Connection Blocker - блокировка новых соединений
    8. Maintenance Notification Manager - управление уведомлениями
    9. Maintenance Analytics Collector - сбор аналитики
    10. Maintenance Telemetry Collector - сбор телеметрии

  microservices:
    - name: infrastructure-service
      port: 8093
      responsibility: |
        Обработка системы режима обслуживания:
        - Управление системой обслуживания
        - Управление окнами обслуживания
        - Управление статусом обслуживания
        - Управление плановым обслуживанием
        - Управление экстренным обслуживанием
        - Управление graceful shutdown
        - Блокировка новых соединений
        - Управление уведомлениями
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - maintenance-manager: управление системой обслуживания
        - maintenance-window-manager: управление окнами обслуживания
        - maintenance-status-manager: управление статусом обслуживания
        - scheduled-maintenance-manager: управление плановым обслуживанием
        - emergency-maintenance-manager: управление экстренным обслуживанием
        - graceful-shutdown-manager: управление graceful shutdown
        - connection-blocker: блокировка новых соединений
        - maintenance-notification-manager: управление уведомлениями
        - maintenance-analytics-collector: сбор аналитики
        - maintenance-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/maintenance/status - текущий статус обслуживания
        - GET /api/v1/maintenance/windows - список окон обслуживания
        - GET /api/v1/maintenance/windows/{windowId} - информация об окне обслуживания
        - POST /api/v1/maintenance/windows - создание окна обслуживания
        - PUT /api/v1/maintenance/windows/{windowId} - обновление окна обслуживания
        - DELETE /api/v1/maintenance/windows/{windowId} - удаление окна обслуживания
        - POST /api/v1/maintenance/emergency - запуск экстренного обслуживания
        - POST /api/v1/maintenance/start - начало обслуживания
        - POST /api/v1/maintenance/end - завершение обслуживания
        - GET /api/v1/maintenance/notifications - список уведомлений
        - POST /api/v1/maintenance/notifications - создание уведомления
      websocket_channels:
        - wss://api.necp.game/v1/maintenance/status - поток обновлений статуса обслуживания
      events_published:
        - maintenance.window-created: создано окно обслуживания
        - maintenance.window-updated: обновлено окно обслуживания
        - maintenance.window-deleted: удалено окно обслуживания
        - maintenance.started: начато обслуживание
        - maintenance.ended: завершено обслуживание
        - maintenance.emergency-started: начато экстренное обслуживание
        - maintenance.graceful-shutdown-started: начат graceful shutdown
        - maintenance.graceful-shutdown-completed: завершен graceful shutdown
        - maintenance.notification-sent: отправлено уведомление
      events_subscribed:
        - infrastructure.health-check-failed: проверка здоровья не прошла
        - deployment.started: начат деплой
        - deployment.completed: завершен деплой
        - infrastructure.alert: инфраструктурная тревога

  maintenance_types:
    - name: scheduled
      description: "Плановое обслуживание - запланированное заранее"
      characteristics:
        - advance_notice: "заблаговременное уведомление"
        - scheduled_time: "запланированное время"
        - duration_estimate: "оценка длительности"

    - name: emergency
      description: "Экстренное обслуживание - незапланированное срочное"
      characteristics:
        - immediate: "немедленное начало"
        - no_advance_notice: "без заблаговременного уведомления"
        - critical: "критическая ситуация"

    - name: hot_fix
      description: "Хотфикс - быстрое исправление критических багов"
      characteristics:
        - quick: "быстрое выполнение"
        - minimal_impact: "минимальное влияние"
        - urgent: "срочное"

    - name: rollback
      description: "Откат - возврат к предыдущей версии"
      characteristics:
        - version_rollback: "откат версии"
        - data_integrity: "сохранение целостности данных"
        - quick_recovery: "быстрое восстановление"

    - name: upgrade
      description: "Обновление - обновление системы"
      characteristics:
        - version_upgrade: "обновление версии"
        - feature_additions: "добавление функций"
        - performance_improvements: "улучшение производительности"

  maintenance_statuses:
    - name: planned
      description: "Запланировано - окно обслуживания запланировано"
      actions:
        - notification: "уведомление игроков"
        - preparation: "подготовка к обслуживанию"

    - name: starting
      description: "Начинается - обслуживание начинается"
      actions:
        - connection_blocking: "блокировка новых соединений"
        - graceful_shutdown_start: "начало graceful shutdown"

    - name: in_progress
      description: "В процессе - обслуживание выполняется"
      actions:
        - maintenance_operations: "выполнение операций обслуживания"
        - monitoring: "мониторинг процесса"

    - name: ending
      description: "Завершается - обслуживание завершается"
      actions:
        - system_restart: "перезапуск системы"
        - connection_unblocking: "разблокировка соединений"

    - name: completed
      description: "Завершено - обслуживание завершено"
      actions:
        - notification: "уведомление о завершении"
        - status_update: "обновление статуса"

    - name: cancelled
      description: "Отменено - обслуживание отменено"
      actions:
        - notification: "уведомление об отмене"
        - status_update: "обновление статуса"

  scheduled_maintenance_flow:
    steps:
      - planning: "планирование окна обслуживания"
      - notification_advance: "заблаговременное уведомление (24 часа, 1 час)"
      - maintenance_start: "начало обслуживания"
      - connection_blocking: "блокировка новых соединений"
      - graceful_shutdown: "graceful shutdown активных соединений"
      - maintenance_operations: "выполнение операций обслуживания"
      - system_restart: "перезапуск системы"
      - connection_unblocking: "разблокировка соединений"
      - maintenance_end: "завершение обслуживания"
      - notification_completion: "уведомление о завершении"

  emergency_maintenance_flow:
    steps:
      - trigger: "триггер экстренного обслуживания"
      - immediate_notification: "немедленное уведомление"
      - connection_blocking: "блокировка новых соединений"
      - graceful_shutdown: "graceful shutdown активных соединений"
      - emergency_operations: "выполнение экстренных операций"
      - system_restart: "перезапуск системы"
      - connection_unblocking: "разблокировка соединений"
      - maintenance_end: "завершение обслуживания"
      - notification_completion: "уведомление о завершении"

  graceful_shutdown:
    process:
      - stop_accepting_new_requests: "остановка приема новых запросов"
      - wait_for_active_requests: "ожидание завершения активных запросов"
      - close_connections: "закрытие соединений"
      - save_state: "сохранение состояния"
      - shutdown_services: "выключение сервисов"
    timeout:
      - default: "30 секунд"
      - configurable: "настраиваемый таймаут"
      - force_shutdown: "принудительное выключение после таймаута"

  connection_blocking:
    mechanism:
      - middleware: "middleware для блокировки"
      - status_check: "проверка статуса обслуживания"
      - response_503: "возврат статуса 503"
      - admin_bypass: "обход для администраторов"
    response:
      - status_code: 503
      - message: "Service Unavailable - Maintenance in progress"
      - retry_after: "время до завершения обслуживания"

  notifications:
    types:
      - advance_24h: "уведомление за 24 часа"
      - advance_1h: "уведомление за 1 час"
      - immediate: "немедленное уведомление"
      - completion: "уведомление о завершении"
    channels:
      - in_game: "в игре"
      - email: "email"
      - push: "push уведомления"
      - social_media: "социальные сети"
    content:
      - start_time: "время начала"
      - estimated_duration: "оценка длительности"
      - reason: "причина обслуживания"
      - impact: "влияние на игроков"

  data_flows:
    scheduled_maintenance_flow: |
      1. Администратор создает окно обслуживания
      2. Maintenance Window Manager сохраняет окно в БД
      3. Maintenance Notification Manager отправляет уведомления (24ч, 1ч)
      4. Maintenance Status Manager обновляет статус на "starting"
      5. Connection Blocker блокирует новые соединения
      6. Graceful Shutdown Manager начинает graceful shutdown
      7. Maintenance Operations выполняются
      8. System Restart выполняется
      9. Connection Blocker разблокирует соединения
      10. Maintenance Status Manager обновляет статус на "completed"
      11. Maintenance Notification Manager отправляет уведомление о завершении
      12. Infrastructure Service публикует событие maintenance.ended

    emergency_maintenance_flow: |
      1. Триггер экстренного обслуживания (инфраструктурная тревога, критический баг)
      2. Emergency Maintenance Manager создает экстренное окно
      3. Maintenance Notification Manager отправляет немедленное уведомление
      4. Maintenance Status Manager обновляет статус на "starting"
      5. Connection Blocker блокирует новые соединения
      6. Graceful Shutdown Manager начинает graceful shutdown
      7. Emergency Operations выполняются
      8. System Restart выполняется
      9. Connection Blocker разблокирует соединения
      10. Maintenance Status Manager обновляет статус на "completed"
      11. Maintenance Notification Manager отправляет уведомление о завершении
      12. Infrastructure Service публикует событие maintenance.ended

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций (создание окна, начало/завершение обслуживания)
    mechanisms:
      - ACID транзакции для создания окон обслуживания, обновления статуса и управления graceful shutdown
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении статуса
      - Валидация перед созданием окна обслуживания и началом обслуживания
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (начало обслуживания, graceful shutdown, завершение обслуживания)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния режима обслуживания (создание окна, обновление статуса, начало обслуживания,
      завершение обслуживания, отправка уведомлений) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: MaintenanceWindowCreatedEvent, MaintenanceStartedEvent, MaintenanceEndedEvent, GracefulShutdownStartedEvent, NotificationSentEvent.
    cqrs_pattern: |
      Разделение команд (создание окна, начало обслуживания, завершение обслуживания) и запросов
      (получение статуса, получение списка окон, получение уведомлений) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как начало обслуживания (обновление статуса, блокировка соединений,
      начало graceful shutdown, отправка уведомлений) или завершение обслуживания (завершение graceful shutdown,
      разблокировка соединений, обновление статуса, отправка уведомлений), используется Saga Pattern
      для обеспечения атомарности операций между Infrastructure Service, API Gateway, Notification Service и Realtime Gateway.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    status_operations:
      tickrate: Event-based (on-demand) + 1-5 Hz для обновления статуса во время обслуживания
      network_load: |
        - Получение статуса: event-based, ~0.01-0.05 requests/sec на клиента
        - Обновление статуса: 1-5 Hz во время обслуживания, ~0.01-0.05 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec на клиента для операций статуса
      latency_requirements: < 20-50ms для получения статуса, < 50-100ms для обновления статуса
      sync_strategy: Strong Consistency (ACID транзакции) для обновления статуса

    window_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Создание окна: event-based, ~0.001-0.01 events/sec (административные операции)
        - Получение списка окон: event-based, ~0.001-0.01 requests/sec
        - Обновление окна: event-based, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций окон
      latency_requirements: < 100-200ms для создания окна, < 30-100ms для получения списка
      sync_strategy: Strong Consistency (ACID транзакции) для операций с окнами

    maintenance_operations:
      tickrate: Event-based (on-demand при начале/завершении обслуживания)
      network_load: |
        - Начало обслуживания: event-based, ~0.001-0.01 events/sec
        - Завершение обслуживания: event-based, ~0.001-0.01 events/sec
        - Экстренное обслуживание: event-based, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций обслуживания
      latency_requirements: < 200-500ms для начала обслуживания, < 200-500ms для завершения
      sync_strategy: Strong Consistency (ACID транзакции) для операций обслуживания

    graceful_shutdown_operations:
      tickrate: Event-based (on-demand при начале shutdown) + 1-10 Hz для мониторинга прогресса
      network_load: |
        - Начало graceful shutdown: event-based, ~0.001-0.01 events/sec
        - Мониторинг прогресса: 1-10 Hz, ~0.01-0.05 events/sec
        - Завершение graceful shutdown: event-based, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций graceful shutdown
      latency_requirements: < 100-300ms для начала shutdown, < 30-100ms для мониторинга
      sync_strategy: Strong Consistency (ACID транзакции) для graceful shutdown

    connection_blocking_operations:
      tickrate: Event-based (on-demand при изменении статуса) + 1-5 Hz для проверки статуса
      network_load: |
        - Блокировка соединений: event-based, ~0.001-0.01 events/sec
        - Проверка статуса блокировки: 1-5 Hz, ~0.01-0.05 requests/sec
        - Разблокировка соединений: event-based, ~0.001-0.01 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций блокировки
      latency_requirements: < 50-100ms для блокировки/разблокировки, < 10-30ms для проверки статуса
      sync_strategy: Strong Consistency (ACID транзакции) для блокировки соединений

    notification_operations:
      tickrate: Event-based (on-demand при событиях обслуживания) + cron-triggered для заблаговременных уведомлений
      network_load: |
        - Отправка уведомлений: event-based, ~0.01-0.1 events/sec
        - Получение списка уведомлений: event-based, ~0.001-0.01 requests/sec
        - Заблаговременные уведомления: cron-triggered, ~0.001-0.01 events/sec
        - Общий трафик: ~0.2-0.5 KB/sec для операций уведомлений
      latency_requirements: < 100-300ms для отправки уведомлений, < 30-100ms для получения списка
      sync_strategy: Eventual Consistency для уведомлений (через Notification Service)

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий обслуживания: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_structure:
    tables:
      - name: maintenance_windows
        description: Окна обслуживания
        columns:
          - id: UUID PRIMARY KEY
          - type: ENUM (scheduled, emergency, hot_fix, rollback, upgrade)
          - status: ENUM (planned, starting, in_progress, ending, completed, cancelled)
          - scheduled_start: TIMESTAMP
          - scheduled_end: TIMESTAMP
          - actual_start: TIMESTAMP
          - actual_end: TIMESTAMP
          - estimated_duration: INTEGER
          - reason: TEXT
          - impact: TEXT
          - affected_services: JSONB
          - created_by: UUID FOREIGN KEY
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: maintenance_status
        description: Текущий статус обслуживания
        columns:
          - id: UUID PRIMARY KEY
          - is_maintenance_mode: BOOLEAN
          - current_window_id: UUID FOREIGN KEY
          - connection_blocking_enabled: BOOLEAN
          - graceful_shutdown_in_progress: BOOLEAN
          - last_updated: TIMESTAMP

      - name: maintenance_notifications
        description: Уведомления об обслуживании
        columns:
          - id: UUID PRIMARY KEY
          - window_id: UUID FOREIGN KEY
          - notification_type: ENUM (advance_24h, advance_1h, immediate, completion)
          - channel: ENUM (in_game, email, push, social_media)
          - content: JSONB
          - sent_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: maintenance_telemetry
        description: Телеметрия обслуживания
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - window_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    api_gateway: |
      - Блокировка новых запросов
      - Возврат статуса 503
      - Обход для администраторов

    notification_service: |
      - Отправка уведомлений игрокам
      - Уведомления через различные каналы
      - Логирование уведомлений

    infrastructure_service: |
      - Мониторинг состояния инфраструктуры
      - Триггеры экстренного обслуживания
      - Управление сервисами

    deployment_service: |
      - Интеграция с процессом деплоя
      - Автоматическое обслуживание при деплое
      - Откат при проблемах

    monitoring_service: |
      - Мониторинг процесса обслуживания
      - Алерты о проблемах
      - Метрики обслуживания

    analytics_service: |
      - Логирование всех операций обслуживания
      - Сбор метрик эффективности
      - Анализ паттернов обслуживания

    realtime_gateway: |
      - Отправка realtime обновлений статуса
      - Уведомления о начале/завершении обслуживания

technical_specification:
  subtasks:
    - id: maintenance-manager
      title: Реализация менеджера системы обслуживания
      description: |
        Реализация Maintenance Manager с управлением системой обслуживания
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: maintenance-window-manager
      title: Реализация менеджера окон обслуживания
      description: |
        Реализация Maintenance Window Manager с управлением окнами обслуживания,
        созданием, обновлением и удалением окон.
      dependencies: [maintenance-manager]
      estimated_effort: 4 days

    - id: maintenance-status-manager
      title: Реализация менеджера статуса обслуживания
      description: |
        Реализация Maintenance Status Manager с управлением статусом обслуживания,
        обновлением статуса и проверкой режима обслуживания.
      dependencies: [maintenance-manager]
      estimated_effort: 3 days

    - id: scheduled-maintenance-manager
      title: Реализация менеджера планового обслуживания
      description: |
        Реализация Scheduled Maintenance Manager с управлением плановым обслуживанием,
        планированием окон и автоматическим запуском.
      dependencies: [maintenance-window-manager]
      estimated_effort: 4 days

    - id: emergency-maintenance-manager
      title: Реализация менеджера экстренного обслуживания
      description: |
        Реализация Emergency Maintenance Manager с управлением экстренным обслуживанием,
        триггерами и немедленным запуском.
      dependencies: [maintenance-window-manager]
      estimated_effort: 4 days

    - id: graceful-shutdown-manager
      title: Реализация менеджера graceful shutdown
      description: |
        Реализация Graceful Shutdown Manager с управлением graceful shutdown,
        ожиданием завершения активных запросов и закрытием соединений.
      dependencies: [maintenance-manager]
      estimated_effort: 5 days

    - id: connection-blocker
      title: Реализация блокировщика соединений
      description: |
        Реализация Connection Blocker с блокировкой новых соединений,
        middleware для API Gateway и возвратом статуса 503.
      dependencies: [maintenance-status-manager]
      estimated_effort: 3 days

    - id: maintenance-notification-manager
      title: Реализация менеджера уведомлений
      description: |
        Реализация Maintenance Notification Manager с управлением уведомлениями,
        отправкой через различные каналы и логированием.
      dependencies: [maintenance-manager]
      estimated_effort: 4 days

    - id: maintenance-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Maintenance Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [maintenance-manager]
      estimated_effort: 3 days

    - id: maintenance-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Maintenance Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [maintenance-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений статуса обслуживания
        и уведомлений.
      dependencies: [maintenance-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы обслуживания.
      dependencies: [maintenance-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для окон обслуживания, статуса, уведомлений
        и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> InfrastructureService[Infrastructure Service<br/>8093]
        
        InfrastructureService --> MM[Maintenance Manager]
        InfrastructureService --> MWM[Maintenance Window Manager]
        InfrastructureService --> MSM[Maintenance Status Manager]
        InfrastructureService --> SMM[Scheduled Maintenance Manager]
        InfrastructureService --> EMM[Emergency Maintenance Manager]
        InfrastructureService --> GSM[Graceful Shutdown Manager]
        InfrastructureService --> CB[Connection Blocker]
        InfrastructureService --> MNM[Maintenance Notification Manager]
        InfrastructureService --> MAC[Maintenance Analytics Collector]
        InfrastructureService --> MTC[Maintenance Telemetry Collector]
        
        MM --> MWM
        MM --> MSM
        MWM --> SMM
        MWM --> EMM
        MSM --> CB
        MM --> GSM
        MM --> MNM
        
        InfrastructureService --> APIGateway[API Gateway]
        InfrastructureService --> NotificationService[Notification Service]
        InfrastructureService --> DeploymentService[Deployment Service]
        InfrastructureService --> MonitoringService[Monitoring Service]
        InfrastructureService --> AnalyticsService[Analytics Service]
        
        InfrastructureService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        InfrastructureService --> DB[(Infrastructure DB)]
        
        Client --> WSMaintenance[WebSocket<br/>Maintenance]
        WSMaintenance --> InfrastructureService
    ```

  scheduled_maintenance_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Admin as Administrator
        participant MWM as Maintenance Window Manager
        participant MNM as Maintenance Notification Manager
        participant MSM as Maintenance Status Manager
        participant CB as Connection Blocker
        participant GSM as Graceful Shutdown Manager
        participant EB as Event Bus
        
        Admin->>MWM: Create maintenance window
        MWM->>MWM: Save window to DB
        MWM->>MNM: Schedule notifications (24h, 1h)
        MWM->>MSM: Update status to "starting"
        MSM->>CB: Block new connections
        MSM->>GSM: Start graceful shutdown
        GSM->>GSM: Wait for active requests
        GSM->>GSM: Close connections
        GSM->>MSM: Shutdown complete
        MSM->>MSM: Update status to "completed"
        MSM->>MNM: Send completion notification
        MSM->>EB: Publish maintenance.ended
    ```

  emergency_maintenance_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Trigger as Infrastructure Alert
        participant EMM as Emergency Maintenance Manager
        participant MNM as Maintenance Notification Manager
        participant MSM as Maintenance Status Manager
        participant CB as Connection Blocker
        participant GSM as Graceful Shutdown Manager
        participant EB as Event Bus
        
        Trigger->>EMM: Emergency maintenance trigger
        EMM->>EMM: Create emergency window
        EMM->>MNM: Send immediate notification
        EMM->>MSM: Update status to "starting"
        MSM->>CB: Block new connections
        MSM->>GSM: Start graceful shutdown
        GSM->>GSM: Wait for active requests
        GSM->>GSM: Close connections
        GSM->>MSM: Shutdown complete
        MSM->>MSM: Update status to "completed"
        MSM->>MNM: Send completion notification
        MSM->>EB: Publish maintenance.ended
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния режима обслуживания
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (начало обслуживания, graceful shutdown, завершение обслуживания)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для статуса, окон, обслуживания, graceful shutdown, блокировки соединений, уведомлений и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы режима обслуживания:
      - Определены компоненты (Maintenance Manager, Maintenance Window Manager, Maintenance Status Manager, Scheduled Maintenance Manager, Emergency Maintenance Manager, Graceful Shutdown Manager, Connection Blocker, Maintenance Notification Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (maintenance_windows, maintenance_status, maintenance_notifications, maintenance_telemetry)
      - Спроектирована система планового обслуживания
      - Спроектирована система экстренного обслуживания
      - Спроектирована система graceful shutdown
      - Спроектирована система уведомлений
      - Создано техническое задание
      - Разбито на подзадачи
