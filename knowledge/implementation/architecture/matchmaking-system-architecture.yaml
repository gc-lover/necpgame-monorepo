metadata:
  id: matchmaking-system-architecture
  title: Архитектура системы матчмейкинга (Matchmaking System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T19:40:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - matchmaking
    - backend
    - gameplay
  related_systems:
    - matchmaking-go
    - gameplay-service-go
    - character-service-go
    - party-service-go
  related_documents:
    - id: backend-matchmaking-queue
      relation: extends
    - id: backend-matchmaking-algorithm
      relation: extends
    - id: backend-matchmaking-rating
      relation: extends
  github_issue: 150
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы матчмейкинга
    для подбора игроков в PvP, PvE и рейды с учётом рейтинга, очередей, алгоритмов
    подбора и балансировки команд.
  goal: |
    Создать архитектурную схему системы матчмейкинга с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы очередей
    - Алгоритмов подбора
    - Системы рейтинга
    - Технического задания для реализации
  essence: |
    Система матчмейкинга для подбора игроков в различные игровые режимы с учётом
    рейтинга, ролей, балансировки команд и качества матча.

architecture:
  overview: |
    Система матчмейкинга состоит из семи основных компонентов:
    1. Queue Manager - управление очередями
    2. Matchmaking Engine - алгоритмы подбора
    3. Rating System - система рейтинга
    4. Team Balancer - балансировка команд
    5. Match Quality Calculator - расчёт качества матча
    6. Anti-Smurf Detector - обнаружение смурфов
    7. Session Creator - создание игровых сессий

  components:
    - name: Queue Manager
      location: matchmaking-go (модуль queue)
      responsibility: |
        - Управление очередями матчмейкинга
        - Добавление/удаление игроков из очереди
        - Расширение диапазона поиска
        - Приоритеты ожидания
        - Интеграция с Redis для hot data
      queue_types: |
        - PvP: подбор для PvP матчей
        - PvE: подбор для PvE контента
        - Raid: подбор для рейдов
        - Ranked: ранговые матчи
        - Casual: казуальные матчи
      endpoints:
        - POST /api/v1/matchmaking/queue/join - вход в очередь
        - DELETE /api/v1/matchmaking/queue/leave - выход из очереди
        - GET /api/v1/matchmaking/queue/status - статус очереди
        - GET /api/v1/matchmaking/queue/estimate - оценка времени ожидания

    - name: Matchmaking Engine
      location: matchmaking-go (модуль matching)
      responsibility: |
        - Алгоритмы подбора игроков
        - Поиск кандидатов по рейтингу
        - Проверка совместимости
        - Формирование команд
        - Обработка различных режимов
      matching_algorithms: |
        - PvP: подбор по рейтингу с балансировкой
        - PvE: подбор с обязательными ролями
        - Raid: подбор больших групп
        - Party: подбор для существующих групп
      endpoints:
        - POST /api/v1/matchmaking/match/find - поиск матча
        - GET /api/v1/matchmaking/match/{match_id} - информация о матче
        - POST /api/v1/matchmaking/match/{match_id}/accept - принятие матча
        - POST /api/v1/matchmaking/match/{match_id}/decline - отклонение матча

    - name: Rating System
      location: matchmaking-go (модуль rating)
      responsibility: |
        - Управление рейтингами игроков
        - Расчёт MMR/ELO
        - Обновление рейтинга после матча
        - Управление сезонными рейтингами
        - Определение лиг и тиров
      rating_formula: |
        - ELO формула с K-факторами
        - Учёт силы противника
        - Streak бонусы/штрафы
        - Сезонные сбросы
      rating_tiers: |
        - Bronze, Silver, Gold, Platinum, Diamond, Master, Grandmaster
      endpoints:
        - GET /api/v1/matchmaking/rating/{player_id} - рейтинг игрока
        - GET /api/v1/matchmaking/rating/leaderboard - лидерборд рейтинга
        - POST /api/v1/matchmaking/rating/update - обновление рейтинга

    - name: Team Balancer
      location: matchmaking-go (модуль balancing)
      responsibility: |
        - Балансировка команд
        - Snake draft алгоритм
        - Распределение ролей
        - Проверка баланса силы команд
        - Оптимизация состава команд
      balancing_strategies: |
        - Snake draft: поочерёдный выбор
        - Role-based: по ролям
        - Rating-based: по рейтингу
        - Skill-based: по навыкам
      endpoints:
        - POST /api/v1/matchmaking/balance/calculate - расчёт баланса
        - POST /api/v1/matchmaking/balance/redistribute - перераспределение

    - name: Match Quality Calculator
      location: matchmaking-go (модуль quality)
      responsibility: |
        - Расчёт качества матча
        - Match Quality Score (MQS)
        - Учёт различных факторов
        - Оптимизация качества подбора
      quality_factors: |
        - Разброс рейтинга
        - Время ожидания
        - Латентность игроков
        - Баланс команд
        - Роли и композиция
      endpoints:
        - GET /api/v1/matchmaking/quality/{match_id} - качество матча
        - POST /api/v1/matchmaking/quality/calculate - расчёт качества

    - name: Anti-Smurf Detector
      location: matchmaking-go (модуль anti-smurf)
      responsibility: |
        - Обнаружение смурфов
        - Анализ статистики игрока
        - Проверка подозрительных паттернов
        - Применение ограничений
      detection_methods: |
        - Анализ винрейта
        - Проверка времени игры
        - Сравнение с ожидаемым рейтингом
        - Выявление аномалий
      endpoints:
        - POST /api/v1/matchmaking/anti-smurf/check - проверка игрока
        - GET /api/v1/matchmaking/anti-smurf/status/{player_id} - статус проверки

    - name: Session Creator
      location: matchmaking-go (модуль session)
      responsibility: |
        - Создание игровых сессий
        - Интеграция с gameplay-service
        - Настройка параметров матча
        - Уведомление игроков
      session_features: |
        - Создание игровой сессии
        - Настройка параметров
        - Приглашение игроков
        - Обработка подключений
      endpoints:
        - POST /api/v1/matchmaking/session/create - создание сессии
        - GET /api/v1/matchmaking/session/{session_id} - информация о сессии

  data_flow:
    queue_join: |
      1. Игрок запрашивает вход в очередь
      2. Queue Manager проверяет требования
      3. Игрок добавляется в очередь (Redis)
      4. Matchmaking Engine начинает поиск
      5. Находятся кандидаты по рейтингу
      6. Team Balancer балансирует команды
      7. Match Quality Calculator оценивает качество
      8. Создаётся матч
      9. Session Creator создаёт игровую сессию
      10. Игроки уведомляются

    match_found: |
      1. Matchmaking Engine находит подходящих игроков
      2. Team Balancer балансирует команды
      3. Match Quality Calculator рассчитывает качество
      4. Если качество приемлемо - создаётся матч
      5. Игроки получают уведомление
      6. Игроки принимают/отклоняют матч
      7. При принятии всеми - создаётся сессия
      8. Игроки подключаются к сессии

    rating_update: |
      1. Матч завершается
      2. Gameplay Service отправляет результаты
      3. Rating System получает результаты
      4. Рассчитывается изменение рейтинга
      5. Обновляется рейтинг всех участников
      6. Обновляются лиги и тиры
      7. Обновляется лидерборд

  integrations:
    with_gameplay_service: |
      - Получение результатов матчей
      - Создание игровых сессий
      - Интеграция с боевыми системами

    with_character_service: |
      - Получение данных персонажей
      - Роли и классы
      - Статистика игрока

    with_party_service: |
      - Подбор для групп
      - Информация о составе группы
      - Групповые очереди

    with_realtime_gateway: |
      - Уведомления о найденном матче
      - Обновления статуса очереди
      - Синхронизация состояния

  data_consistency:
    strategy: Eventual Consistency (Redis) + Strong Consistency (PostgreSQL) для критичных операций
    mechanisms:
      - ACID транзакции для обновления рейтинга и создания матчей
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед созданием матча
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (создание матча, обновление рейтинга)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния матчмейкинга (вход в очередь, найденный матч, обновление рейтинга)
      записываются как события в Event Store. Это обеспечивает полный аудит,
      возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: PlayerJoinedQueueEvent, MatchFoundEvent, MatchAcceptedEvent, RatingUpdatedEvent.
    cqrs_pattern: |
      Разделение команд (вход в очередь, принятие матча, обновление рейтинга) и запросов
      (получение статуса очереди, рейтинг игрока, история матчей) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как создание матча (создание матча, уведомление игроков,
      создание игровой сессии), используется Saga Pattern для обеспечения атомарности операций
      между Matchmaking Service и Gameplay Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    queue_operations:
      tickrate: Event-based (on-demand) + 1-5 Hz для обновления статуса очереди
      network_load: |
        - Вход в очередь: event-based, ~0.1-0.3 events/sec на игрока
        - Выход из очереди: event-based, ~0.1-0.2 events/sec на игрока
        - Обновление статуса очереди: 1-5 Hz, ~0.1-0.3 KB/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока
      latency_requirements: < 50-200ms для операций с очередью
      sync_strategy: Eventual Consistency для очереди (Redis), Strong Consistency для рейтинга

    matchmaking_operations:
      tickrate: Event-based (on-demand) + 1-10 Hz для поиска матчей
      network_load: |
        - Поиск матча: event-based, ~0.1-0.5 events/sec на игрока
        - Найденный матч: event-based, ~0.1-0.2 events/sec на игрока
        - Принятие/отклонение матча: event-based, ~0.1-0.2 events/sec на игрока
        - Обновление статуса матча: 1-10 Hz, ~0.2-0.5 KB/sec на игрока
        - Общий трафик: ~0.3-0.7 KB/sec на игрока
      latency_requirements: < 100-500ms для поиска матча
      sync_strategy: Eventual Consistency для поиска, Strong Consistency для создания матча

    rating_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Обновление рейтинга: event-based, ~0.1-0.2 events/sec на игрока
        - Получение рейтинга: event-based, ~0.1-0.3 requests/sec на игрока
        - Обновление лидерборда: event-based, ~0.1-0.2 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec на игрока
      latency_requirements: < 50-200ms для обновления рейтинга
      sync_strategy: Strong Consistency (ACID транзакции) для обновления рейтинга

  database_schema:
    tables:
      - name: matchmaking_queues
        description: Очереди матчмейкинга
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - queue_type: ENUM (pvp, pve, raid, ranked, casual)
          - game_mode: VARCHAR(100)
          - rating: INTEGER
          - role: VARCHAR(50) (nullable)
          - party_id: UUID (FK parties, nullable)
          - status: ENUM (waiting, matched, cancelled)
          - search_range: INTEGER (default: 100)
          - priority: INTEGER (default: 0)
          - joined_at: TIMESTAMP
          - matched_at: TIMESTAMP (nullable)
        indexes:
          - queue_type, status, rating
          - player_id, status
          - status, joined_at

      - name: player_ratings
        description: Рейтинги игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK accounts)
          - queue_type: ENUM (pvp, pve, raid)
          - rating: INTEGER (default: 1000)
          - peak_rating: INTEGER
          - games_played: INTEGER (default: 0)
          - wins: INTEGER (default: 0)
          - losses: INTEGER (default: 0)
          - win_streak: INTEGER (default: 0)
          - loss_streak: INTEGER (default: 0)
          - tier: ENUM (bronze, silver, gold, platinum, diamond, master, grandmaster)
          - league: INTEGER
          - season_id: UUID (FK seasons, nullable)
          - updated_at: TIMESTAMP
        indexes:
          - player_id, queue_type (unique)
          - queue_type, rating
          - tier, league

      - name: matchmaking_matches
        description: Найденные матчи
        fields:
          - id: UUID (PK)
          - queue_type: ENUM (pvp, pve, raid)
          - game_mode: VARCHAR(100)
          - status: ENUM (pending, accepted, rejected, started, completed)
          - team1_players: UUID[] (массив player_id)
          - team2_players: UUID[] (nullable, для PvP)
          - match_quality_score: DECIMAL(5,2)
          - created_at: TIMESTAMP
          - started_at: TIMESTAMP (nullable)
          - completed_at: TIMESTAMP (nullable)
        indexes:
          - status, created_at
          - queue_type, status

      - name: matchmaking_match_players
        description: Игроки в матчах
        fields:
          - id: UUID (PK)
          - match_id: UUID (FK matchmaking_matches)
          - player_id: UUID (FK accounts)
          - team: INTEGER (1 или 2)
          - role: VARCHAR(50)
          - accepted: BOOLEAN (default: false)
          - accepted_at: TIMESTAMP (nullable)
        indexes:
          - match_id, player_id (unique)
          - match_id, team

      - name: matchmaking_sessions
        description: Игровые сессии матчмейкинга
        fields:
          - id: UUID (PK)
          - match_id: UUID (FK matchmaking_matches)
          - session_id: UUID (FK game_sessions)
          - status: ENUM (created, active, completed)
          - created_at: TIMESTAMP
        indexes:
          - match_id
          - session_id

technical_specification:
  backend_requirements:
    - Реализация модулей в matchmaking-go:
      - queue (управление очередями)
      - matching (алгоритмы подбора)
      - rating (система рейтинга)
      - balancing (балансировка команд)
      - quality (качество матча)
      - anti-smurf (обнаружение смурфов)
      - session (создание сессий)
