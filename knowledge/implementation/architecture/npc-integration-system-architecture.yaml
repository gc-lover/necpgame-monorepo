metadata:
  id: npc-integration-system-architecture
  title: Архитектура системы интеграции NPC с игровыми системами (на примере Ройса)
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T11:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - npc
    - integration
    - quests
    - raids
    - economy
    - factions
  related_systems:
    - gameplay-service-go
    - economy-service-go
    - world-service-go
    - quest-engine
  related_documents:
    - id: npc-royce
      relation: extends
    - id: quest-engine-architecture
      relation: references
    - id: clan-war-system-architecture
      relation: references
  github_issue: 19
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - api-designer

summary:
  problem: |
    NPC профили существуют в изоляции и не интегрированы с игровыми системами:
    рейдов, экономики имплантов, фракционных войн. Требуется спроектировать
    архитектуру интеграции NPC как системных компонентов с игровыми механиками.
  goal: |
    Создать архитектурную схему интеграции NPC с игровыми системами:
    - Система квестов и событий от NPC
    - Интеграция с рейдовыми системами (Totentanz, конвои)
    - Интеграция с экономикой имплантов (нелегальный рынок)
    - Интеграция с фракционными войнами (уличные конфликты)
    - API endpoints (высокоуровнево)
    - Техническое задание для реализации
  essence: |
    Архитектура интеграции NPC как системных компонентов с рейдовыми системами,
    экономикой имплантов и фракционными войнами для обеспечения динамического
    игрового контента.

architecture:
  overview: |
    Система интеграции NPC состоит из следующих компонентов:
    1. NPC Quest Manager - управление квестами от NPC
    2. NPC Raid Coordinator - координация рейдовых событий
    3. NPC Economy Integrator - интеграция с экономикой имплантов
    4. NPC Faction War Manager - управление фракционными конфликтами
    5. NPC Relationship Tracker - отслеживание отношений с игроками
    6. NPC Event Trigger System - система триггеров событий
    7. NPC Dialogue System - система диалогов и взаимодействий
    8. NPC State Manager - управление состоянием NPC

  microservices:
    - name: npc-quest-manager
      location: gameplay-service-go (модуль npc-quests)
      responsibility: |
        Управление квестами от NPC:
        - Создание и управление квестами от NPC
        - Проверка условий доступности квестов
        - Отслеживание прогресса квестов
        - Выдача наград по завершении
      npc_quest_types:
        - Story quests (сюжетные квесты)
        - Raid quests (рейдовые квесты)
        - Economy quests (экономические квесты)
        - Faction quests (фракционные квесты)
        - Daily/Weekly quests (ежедневные/еженедельные)
      endpoints:
        - GET /api/v1/npc/{npc_id}/quests - список квестов от NPC
        - GET /api/v1/npc/{npc_id}/quests/{quest_id} - информация о квесте
        - POST /api/v1/npc/{npc_id}/quests/{quest_id}/accept - принятие квеста
        - POST /api/v1/npc/{npc_id}/quests/{quest_id}/complete - завершение квеста
        - GET /api/v1/npc/{npc_id}/quests/{quest_id}/progress - прогресс квеста

    - name: npc-raid-coordinator
      location: gameplay-service-go (модуль npc-raids)
      responsibility: |
        Координация рейдовых событий от NPC:
        - Создание рейдовых инстансов (Totentanz, конвои Militech)
        - Управление условиями доступа к рейдам
        - Координация участников рейда
        - Управление наградами за рейды
      raid_types:
        - Totentanz Raids (рейды в Totentanz)
        - Militech Convoy Raids (рейды на конвои Militech)
        - Psychoframe Trials (испытания Psychoframe)
        - Maelstrom Rampage Events (события Maelstrom Rampage)
      endpoints:
        - GET /api/v1/npc/{npc_id}/raids - список доступных рейдов
        - POST /api/v1/npc/{npc_id}/raids/{raid_id}/start - запуск рейда
        - GET /api/v1/npc/{npc_id}/raids/{raid_id}/status - статус рейда
        - POST /api/v1/npc/{npc_id}/raids/{raid_id}/complete - завершение рейда
        - GET /api/v1/npc/{npc_id}/raids/{raid_id}/rewards - награды за рейд

    - name: npc-economy-integrator
      location: economy-service-go (модуль npc-economy)
      responsibility: |
        Интеграция NPC с экономикой имплантов:
        - Управление нелегальным рынком имплантов
        - Контроль доступа к экстремальным имплантам
        - Управление ценами и доступностью имплантов
        - Интеграция с фиксёрами
      economy_features:
        - Illegal implant market (нелегальный рынок имплантов)
        - Extreme implant access (доступ к экстремальным имплантам)
        - Fixer integration (интеграция с фиксёрами)
        - Price manipulation (манипуляция ценами)
        - Supply chain control (контроль цепочек поставок)
      endpoints:
        - GET /api/v1/npc/{npc_id}/implants - доступные импланты от NPC
        - GET /api/v1/npc/{npc_id}/implants/{implant_id} - информация об импланте
        - POST /api/v1/npc/{npc_id}/implants/{implant_id}/purchase - покупка импланта
        - GET /api/v1/npc/{npc_id}/market - состояние рынка имплантов
        - POST /api/v1/npc/{npc_id}/market/update - обновление рынка

    - name: npc-faction-war-manager
      location: gameplay-service-go (модуль npc-faction-wars)
      responsibility: |
        Управление фракционными конфликтами:
        - Инициация уличных войн
        - Управление фракционными событиями
        - Координация конфликтов между фракциями
        - Управление последствиями войн
      faction_war_types:
        - Street Wars (уличные войны)
        - Territory Control (контроль территории)
        - Faction Alliances (фракционные альянсы)
        - Proxy Conflicts (прокси-конфликты)
      endpoints:
        - GET /api/v1/npc/{npc_id}/faction-wars - активные войны
        - POST /api/v1/npc/{npc_id}/faction-wars/{war_id}/initiate - инициация войны
        - GET /api/v1/npc/{npc_id}/faction-wars/{war_id}/status - статус войны
        - POST /api/v1/npc/{npc_id}/faction-wars/{war_id}/resolve - разрешение войны

    - name: npc-relationship-tracker
      location: gameplay-service-go (модуль npc-relationships)
      responsibility: |
        Отслеживание отношений с игроками:
        - Управление репутацией с NPC
        - Отслеживание истории взаимодействий
        - Управление уровнем доверия
        - Влияние на доступность контента
      relationship_features:
        - Reputation tracking (отслеживание репутации)
        - Trust level (уровень доверия)
        - Interaction history (история взаимодействий)
        - Content gating (ограничение доступа к контенту)
      endpoints:
        - GET /api/v1/npc/{npc_id}/relationships/{player_id} - отношения с игроком
        - GET /api/v1/npc/{npc_id}/reputation/{player_id} - репутация игрока
        - POST /api/v1/npc/{npc_id}/relationships/{player_id}/update - обновление отношений
        - GET /api/v1/npc/{npc_id}/relationships/{player_id}/history - история взаимодействий

    - name: npc-event-trigger-system
      location: world-service-go (модуль npc-events)
      responsibility: |
        Система триггеров событий от NPC:
        - Определение условий для событий
        - Триггеры событий на основе действий игроков
        - Управление мировыми событиями от NPC
        - Координация с Live Ops
      event_types:
        - Maelstrom Rampage Events (события Maelstrom Rampage)
        - Territory Control Events (события контроля территории)
        - Economy Events (экономические события)
        - Faction Conflict Events (события фракционных конфликтов)
      endpoints:
        - GET /api/v1/npc/{npc_id}/events - доступные события
        - POST /api/v1/npc/{npc_id}/events/{event_id}/trigger - триггер события
        - GET /api/v1/npc/{npc_id}/events/{event_id}/status - статус события
        - POST /api/v1/npc/{npc_id}/events/{event_id}/complete - завершение события

    - name: npc-dialogue-system
      location: gameplay-service-go (модуль npc-dialogue)
      responsibility: |
        Система диалогов и взаимодействий:
        - Управление диалоговыми деревьями
        - Обработка выборов игроков
        - Управление контекстными диалогами
        - Интеграция с квестами и событиями
      dialogue_features:
        - Dialogue trees (диалоговые деревья)
        - Player choices (выборы игроков)
        - Contextual dialogues (контекстные диалоги)
        - Quest integration (интеграция с квестами)
      endpoints:
        - GET /api/v1/npc/{npc_id}/dialogue - диалоговое дерево
        - POST /api/v1/npc/{npc_id}/dialogue/{node_id}/select - выбор в диалоге
        - GET /api/v1/npc/{npc_id}/dialogue/{node_id} - информация о узле диалога

    - name: npc-state-manager
      location: world-service-go (модуль npc-state)
      responsibility: |
        Управление состоянием NPC:
        - Хранение состояния NPC (позиция, здоровье, инвентарь)
        - Синхронизация состояния между сервисами
        - Управление жизненным циклом NPC
        - Персистентность состояния
      state_features:
        - Position tracking (отслеживание позиции)
        - Health management (управление здоровьем)
        - Inventory management (управление инвентарём)
        - Lifecycle management (управление жизненным циклом)
      endpoints:
        - GET /api/v1/npc/{npc_id}/state - состояние NPC
        - POST /api/v1/npc/{npc_id}/state/update - обновление состояния
        - GET /api/v1/npc/{npc_id}/location - текущая локация NPC

  data_flow:
    quest_flow: |
      1. Игрок взаимодействует с NPC Ройсом
      2. NPC Dialogue System показывает диалоговое дерево
      3. Игрок выбирает опцию "Получить квест"
      4. NPC Quest Manager проверяет условия доступности квестов
      5. NPC Quest Manager создаёт квест для игрока
      6. Игрок принимает квест через API
      7. NPC Quest Manager отслеживает прогресс квеста
      8. При завершении квеста выдаются награды
      9. NPC Relationship Tracker обновляет отношения

    raid_flow: |
      1. Игрок взаимодействует с NPC Ройсом
      2. NPC Dialogue System показывает опцию "Запустить рейд"
      3. NPC Raid Coordinator проверяет условия доступа
      4. NPC Raid Coordinator создаёт рейдовый инстанс
      5. Игроки присоединяются к рейду
      6. Рейд проходит в Totentanz или на конвое Militech
      7. NPC Raid Coordinator отслеживает прогресс рейда
      8. При завершении рейда выдаются награды
      9. NPC Relationship Tracker обновляет отношения

    economy_flow: |
      1. Игрок взаимодействует с NPC Ройсом
      2. NPC Dialogue System показывает опцию "Просмотреть импланты"
      3. NPC Economy Integrator получает доступные импланты
      4. Игрок просматривает каталог имплантов
      5. Игрок выбирает имплант для покупки
      6. NPC Economy Integrator проверяет условия покупки
      7. Игрок покупает имплант
      8. NPC Economy Integrator обновляет рынок имплантов
      9. NPC Relationship Tracker обновляет отношения

    faction_war_flow: |
      1. NPC Faction War Manager определяет условия для войны
      2. NPC Event Trigger System триггерит событие войны
      3. Игроки получают уведомление о начале войны
      4. Игроки присоединяются к фракции (Maelstrom)
      5. NPC Faction War Manager координирует конфликт
      6. Игроки участвуют в уличных боях
      7. NPC Faction War Manager отслеживает прогресс войны
      8. При завершении войны определяются последствия
      9. NPC Relationship Tracker обновляет отношения

  integrations:
    with_quest_engine: |
      - Создание квестов от NPC
      - Отслеживание прогресса квестов
      - Выдача наград за квесты
      - Интеграция с диалоговой системой

    with_raid_system: |
      - Создание рейдовых инстансов
      - Координация участников рейда
      - Управление наградами за рейды
      - Интеграция с системой матчмейкинга

    with_economy_service: |
      - Управление рынком имплантов
      - Контроль цен и доступности
      - Интеграция с фиксёрами
      - Управление цепочками поставок

    with_faction_system: |
      - Инициация фракционных конфликтов
      - Управление территориальным контролем
      - Координация альянсов
      - Управление последствиями войн

    with_world_service: |
      - Управление состоянием NPC
      - Синхронизация позиций
      - Управление мировыми событиями
      - Интеграция с Live Ops

  database_schema:
    tables:
      - name: npc_quests
        description: Квесты от NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - quest_type: ENUM (story, raid, economy, faction, daily, weekly)
          - title: VARCHAR(255)
          - description: TEXT
          - requirements: JSONB (требования для доступа)
          - rewards: JSONB (награды за квест)
          - status: ENUM (active, completed, failed, expired)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - quest_type, status

      - name: npc_raid_instances
        description: Рейдовые инстансы от NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - raid_type: ENUM (totentanz, militech_convoy, psychoframe, rampage)
          - instance_id: UUID (FK raid_instances)
          - status: ENUM (pending, active, completed, failed)
          - participants: UUID[] (array of player IDs)
          - rewards: JSONB (награды за рейд)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - raid_type, status

      - name: npc_implant_market
        description: Рынок имплантов от NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - implant_id: VARCHAR(50) (FK implants)
          - price: DECIMAL(10,2)
          - availability: INTEGER (количество доступных)
          - requirements: JSONB (требования для покупки)
          - status: ENUM (available, sold_out, restricted)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - implant_id, status

      - name: npc_faction_wars
        description: Фракционные войны от NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - war_type: ENUM (street_war, territory_control, alliance, proxy)
          - target_faction: VARCHAR(50) (FK factions)
          - status: ENUM (pending, active, resolved)
          - participants: UUID[] (array of player IDs)
          - outcome: JSONB (результат войны)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
          - target_faction, status

      - name: npc_relationships
        description: Отношения NPC с игроками
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - player_id: UUID (FK accounts)
          - reputation: INTEGER (репутация, -100 до 100)
          - trust_level: INTEGER (уровень доверия, 0 до 100)
          - interaction_count: INTEGER (количество взаимодействий)
          - last_interaction: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(npc_id, player_id)
        indexes:
          - npc_id, player_id
          - player_id, reputation

      - name: npc_events
        description: События от NPC
        fields:
          - id: UUID (PK)
          - npc_id: VARCHAR(50) (FK npcs)
          - event_type: ENUM (rampage, territory_control, economy, faction_conflict)
          - trigger_conditions: JSONB (условия триггера)
          - status: ENUM (pending, active, completed, cancelled)
          - participants: UUID[] (array of player IDs)
          - rewards: JSONB (награды за событие)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - npc_id, status
