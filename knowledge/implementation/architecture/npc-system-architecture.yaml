metadata:
  id: npc-system-architecture
  title: Архитектура системы основных NPC
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T14:40:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - npc
    - social
    - game-design
    - ui-ux
  related_systems:
    - social-service
    - economy-service
    - quest-service
    - gameplay-service
    - world-service
  related_documents:
    - id: npc-hiring-system-architecture
      relation: extends
    - id: npc-integration-system-architecture
      relation: extends
  github_issue: 407
  visibility: internal
  audience:
    - architect
    - backend
    - game-design
    - ui-ux
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы основных NPC, включающую:
    - Типы NPC (Фиксер, Торговец, Тренер, Главарь банды, Директор корпорации и др.)
    - Интерфейсы взаимодействия для каждого типа
    - Функционал, доступный при взаимодействии
    - Интеграцию с квестами, экономикой, репутацией, навыками и фракциями
  goal: |
    Создать архитектурную схему системы основных NPC с определением:
    - Компонентов для управления типами NPC и их функционалом
    - REST, WebSocket и Event Bus контрактов
    - Интерфейсов взаимодействия (диалоги, торговля, обучение, фракции)
    - Интеграций с другими системами
    - Структуры БД для NPC, их типов и взаимодействий
    - Технического задания для реализации
  essence: |
    Система основных NPC обеспечивает взаимодействие игроков с различными типами NPC
    (Фиксер, Торговец, Тренер, Главарь банды, Директор корпорации и др.) через специализированные
    интерфейсы (диалоги, торговля, обучение, фракции) с интеграцией в квесты, экономику,
    репутацию, навыки и фракционную систему.

architecture:
  overview: |
    Система основных NPC состоит из следующих компонентов:
    1. NPC Type Manager - управление типами NPC и их функционалом
    2. NPC Interaction Manager - управление взаимодействиями с NPC
    3. Dialogue System - система диалогов с ветвлением
    4. Trading Interface Manager - управление торговыми интерфейсами
    5. Training Interface Manager - управление интерфейсами обучения
    6. Faction Interface Manager - управление фракционными интерфейсами
    7. NPC Quest Provider - предоставление квестов от NPC
    8. NPC Reputation Tracker - отслеживание репутации с NPC
    9. NPC State Manager - управление состоянием NPC

  microservices:
    - name: social-service
      port: 8084
      responsibility: |
        Основной сервис для системы NPC:
        - Управление типами NPC
        - Управление взаимодействиями
        - Система диалогов
        - Управление репутацией с NPC
        - Интеграция с фракциями
      components:
        - NPC Type Manager
        - NPC Interaction Manager
        - Dialogue System
        - NPC Reputation Tracker
        - NPC State Manager
        - Faction Interface Manager
      endpoints:
        - GET /api/v1/social/npc - список NPC
        - GET /api/v1/social/npc/{id} - детали NPC
        - GET /api/v1/social/npc/types - типы NPC
        - GET /api/v1/social/npc/{id}/interact - начать взаимодействие
        - GET /api/v1/social/npc/{id}/dialogue - диалог с NPC
        - POST /api/v1/social/npc/{id}/dialogue/response - ответ в диалоге
        - GET /api/v1/social/npc/{id}/reputation - репутация с NPC
        - GET /api/v1/social/npc/{id}/quests - квесты от NPC

    - name: economy-service
      port: 8085
      responsibility: |
        Торговые интерфейсы для NPC:
        - Управление торговыми интерфейсами
        - Каталоги товаров NPC
        - Покупка/продажа предметов
        - Обмен валют
        - Ремонт и модификация оборудования
        - Специальные предложения
      components:
        - Trading Interface Manager
        - NPC Trader Catalog
        - Currency Exchange Handler
        - Equipment Repair Handler
      endpoints:
        - GET /api/v1/economy/npc/{id}/shop - магазин NPC
        - GET /api/v1/economy/npc/{id}/shop/items - товары в магазине
        - POST /api/v1/economy/npc/{id}/shop/buy - покупка предмета
        - POST /api/v1/economy/npc/{id}/shop/sell - продажа предмета
        - POST /api/v1/economy/npc/{id}/repair - ремонт оборудования
        - GET /api/v1/economy/npc/{id}/currency-exchange - обмен валют

    - name: gameplay-service
      port: 8083
      responsibility: |
        Интерфейсы обучения для NPC:
        - Управление интерфейсами обучения
        - Дерево навыков
        - Обучение новым навыкам
        - Повышение уровня навыков
        - Тренировочные режимы
      components:
        - Training Interface Manager
        - Skill Tree Manager
        - Skill Trainer
        - Training Simulator
      endpoints:
        - GET /api/v1/gameplay/npc/{id}/training - обучение у NPC
        - GET /api/v1/gameplay/npc/{id}/skills - доступные навыки
        - POST /api/v1/gameplay/npc/{id}/skills/{skill_id}/learn - изучить навык
        - POST /api/v1/gameplay/npc/{id}/skills/{skill_id}/upgrade - повысить навык
        - GET /api/v1/gameplay/npc/{id}/training/simulations - тренировочные режимы

    - name: quest-service
      port: 8087
      responsibility: |
        Квесты от NPC:
        - Предоставление квестов от NPC
        - Управление квестовыми цепочками
        - Проверка условий доступности
        - Выдача наград
      components:
        - NPC Quest Provider
        - Quest Chain Manager
        - Quest Condition Validator
      endpoints:
        - GET /api/v1/quests/npc/{id}/available - доступные квесты
        - GET /api/v1/quests/npc/{id}/active - активные квесты
        - POST /api/v1/quests/npc/{id}/quests/{quest_id}/accept - принять квест
        - POST /api/v1/quests/npc/{id}/quests/{quest_id}/complete - завершить квест

  components:
    - name: NPC Type Manager
      location: social-service
      responsibility: |
        Управление типами NPC:
        - Реестр типов NPC (Fixer, Trader, Trainer, Gang Leader, Corporate Director и др.)
        - Функционал каждого типа
        - Специализация NPC
        - Связь с фракциями
      npc_types:
        - Fixer: посредник, контракты, квесты, контакты
        - Trader: торговля, ремонт, модификация, аукционы
        - Trainer: обучение навыкам, тренировки, симуляции
        - Gang Leader: банды, задания, территория, войны
        - Corporate Director: корпорации, контракты, карьера, политика
        - Medic: лечение, импланты, киберимпланты
        - Engineer: крафт, модификация оружия, создание предметов
        - Hacker: взлом, доступ к данным, кибербезопасность
        - Informant: информация, слухи, разведка
        - Bartender: социальный хаб, слухи, встречи
        - Guard: контроль доступа, безопасность территорий
      dependencies:
        - Database
        - Social Service (фракции)

    - name: NPC Interaction Manager
      location: social-service
      responsibility: |
        Управление взаимодействиями:
        - Инициализация взаимодействия
        - Определение доступных действий
        - Переключение между интерфейсами
        - Завершение взаимодействия
        - История взаимодействий
      dependencies:
        - NPC Type Manager
        - Dialogue System
        - Trading Interface Manager
        - Training Interface Manager
        - Faction Interface Manager

    - name: Dialogue System
      location: social-service
      responsibility: |
        Система диалогов:
        - Дерево диалогов с ветвлением
        - Выбор ответов игрока
        - Условия доступности реплик
        - Влияние на репутацию
        - Триггеры квестов и событий
        - Сохранение прогресса диалогов
      dependencies:
        - NPC State Manager
        - NPC Reputation Tracker
        - Quest Service

    - name: Trading Interface Manager
      location: economy-service
      responsibility: |
        Управление торговыми интерфейсами:
        - Каталог товаров NPC
        - Фильтрация и поиск
        - Покупка/продажа предметов
        - Обмен валют
        - Ремонт оборудования
        - Специальные предложения
        - Аукционы
      dependencies:
        - Inventory Service
        - Wallet Service
        - NPC Trader Catalog

    - name: Training Interface Manager
      location: gameplay-service
      responsibility: |
        Управление интерфейсами обучения:
        - Дерево навыков
        - Доступные навыки для обучения
        - Стоимость обучения
        - Требования к обучению
        - Тренировочные режимы
        - Симуляции
      dependencies:
        - Skill System
        - Progression Service
        - Wallet Service

    - name: Faction Interface Manager
      location: social-service
      responsibility: |
        Управление фракционными интерфейсами:
        - Вступление в банду/корпорацию
        - Получение заданий
        - Доступ к ресурсам
        - Управление территорией
        - Войны между фракциями
        - Карьерная лестница
      dependencies:
        - Faction System
        - Quest Service
        - World Service (территории)

    - name: NPC Quest Provider
      location: quest-service
      responsibility: |
        Предоставление квестов от NPC:
        - Список доступных квестов
        - Условия доступности
        - Цепочки квестов
        - Выдача наград
        - Прогресс квестов
      dependencies:
        - Quest System
        - NPC Reputation Tracker
        - NPC State Manager

    - name: NPC Reputation Tracker
      location: social-service
      responsibility: |
        Отслеживание репутации:
        - Репутация с каждым NPC
        - Влияние действий на репутацию
        - Уровни репутации (Hostile, Neutral, Friendly, Trusted)
        - Разблокировка контента по репутации
        - История изменений репутации
      dependencies:
        - Database
        - Relationship System

    - name: NPC State Manager
      location: social-service
      responsibility: |
        Управление состоянием NPC:
        - Текущее состояние (Available, Busy, Unavailable)
        - Расположение NPC
        - Активность NPC
        - История взаимодействий
        - Сохранение прогресса диалогов
      dependencies:
        - Database
        - World Service (локации)

  integrations:
    - name: Quest Service Integration
      description: |
        Интеграция с системой квестов:
        - NPC предоставляют квесты
        - Условия доступности квестов
        - Выдача наград
        - Прогресс квестов
      events:
        - quest.available
        - quest.accepted
        - quest.completed
      endpoints:
        - GET /api/v1/quests/npc/{id}/quests

    - name: Economy Service Integration
      description: |
        Интеграция с экономикой:
        - Торговля с NPC
        - Цены на товары
        - Обмен валют
        - Ремонт оборудования
      events:
        - economy.trade.completed
        - economy.currency.exchanged
      endpoints:
        - GET /api/v1/economy/npc/{id}/shop

    - name: Reputation System Integration
      description: |
        Интеграция с системой репутации:
        - Влияние действий на репутацию
        - Разблокировка контента
        - Уровни доступа
      events:
        - reputation.changed
        - reputation.level_up
      endpoints:
        - GET /api/v1/social/npc/{id}/reputation

    - name: Skill System Integration
      description: |
        Интеграция с системой навыков:
        - Обучение навыкам
        - Повышение уровня
        - Тренировки
      events:
        - skill.learned
        - skill.upgraded
      endpoints:
        - GET /api/v1/gameplay/npc/{id}/training

    - name: Faction System Integration
      description: |
        Интеграция с фракционной системой:
        - Вступление в фракции
        - Задания фракций
        - Доступ к ресурсам
        - Управление территорией
      events:
        - faction.joined
        - faction.quest.available
        - territory.control.changed
      endpoints:
        - GET /api/v1/social/factions/{id}/npc

  database:
    tables:
      - name: npc_types
        description: Типы NPC
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(100) UNIQUE
          - display_name: VARCHAR(255)
          - description: TEXT
          - functionality: JSONB
          - default_interfaces: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npcs
        description: NPC в игре
        columns:
          - id: UUID PRIMARY KEY
          - npc_type_id: UUID REFERENCES npc_types(id)
          - name: VARCHAR(255)
          - location_id: UUID
          - faction_id: UUID NULL
          - state: VARCHAR(50) (AVAILABLE, BUSY, UNAVAILABLE)
          - metadata: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_dialogues
        description: Диалоги с NPC
        columns:
          - id: UUID PRIMARY KEY
          - npc_id: UUID REFERENCES npcs(id)
          - dialogue_tree: JSONB
          - conditions: JSONB
          - reputation_requirements: JSONB
          - quest_triggers: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_dialogue_progress
        description: Прогресс диалогов игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - npc_id: UUID REFERENCES npcs(id)
          - dialogue_id: UUID REFERENCES npc_dialogues(id)
          - current_node: VARCHAR(255)
          - visited_nodes: JSONB
          - choices_made: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_trader_catalogs
        description: Каталоги товаров торговцев
        columns:
          - id: UUID PRIMARY KEY
          - npc_id: UUID REFERENCES npcs(id)
          - item_template_id: UUID
          - price: DECIMAL(20, 4)
          - stock: INTEGER
          - restock_timer: INTEGER
          - special_offer: BOOLEAN DEFAULT FALSE
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_trainer_skills
        description: Навыки, доступные у тренеров
        columns:
          - id: UUID PRIMARY KEY
          - npc_id: UUID REFERENCES npcs(id)
          - skill_id: UUID
          - training_cost: DECIMAL(20, 4)
          - requirements: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_reputation
        description: Репутация игроков с NPC
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - npc_id: UUID REFERENCES npcs(id)
          - reputation_value: INTEGER
          - reputation_level: VARCHAR(50) (HOSTILE, NEUTRAL, FRIENDLY, TRUSTED)
          - last_interaction: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: npc_interaction_history
        description: История взаимодействий с NPC
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - npc_id: UUID REFERENCES npcs(id)
          - interaction_type: VARCHAR(50)
          - interaction_data: JSONB
          - timestamp: TIMESTAMP
          - created_at: TIMESTAMP

  event_bus:
    topics:
      - name: social.npc.interaction.started
        description: Начато взаимодействие с NPC
        schema:
          player_id: UUID
          npc_id: UUID
          interaction_type: string

      - name: social.npc.dialogue.response
        description: Ответ в диалоге
        schema:
          player_id: UUID
          npc_id: UUID
          dialogue_id: UUID
          response_id: string

      - name: social.npc.reputation.changed
        description: Изменена репутация с NPC
        schema:
          player_id: UUID
          npc_id: UUID
          old_reputation: number
          new_reputation: number
          change: number

      - name: economy.npc.trade.completed
        description: Завершена торговля с NPC
        schema:
          player_id: UUID
          npc_id: UUID
          trade_type: string
          items: array
          total_cost: number

      - name: gameplay.npc.skill.learned
        description: Изучен навык у NPC
        schema:
          player_id: UUID
          npc_id: UUID
          skill_id: UUID
          cost: number

  websocket:
    channels:
      - name: npc.{npc_id}.state
        description: Realtime обновления состояния NPC
      - name: npc.{npc_id}.dialogue
        description: Realtime обновления диалога
      - name: npc.{npc_id}.shop
        description: Realtime обновления магазина NPC

  technical_tasks:
    phases:
      phase_1:
        name: Базовая инфраструктура
        tasks:
          - Создание таблиц БД
          - Настройка миграций Liquibase
          - Базовая структура social-service для NPC
          - Интеграция с Event Bus
          - Настройка Redis для кэширования
        estimated_effort: 4 days

      phase_2:
        name: NPC Type Manager
        tasks:
          - Реализация NPC Type Manager
          - Реестр типов NPC
          - Функционал каждого типа
          - Связь с фракциями
        estimated_effort: 3 days

      phase_3:
        name: Dialogue System
        tasks:
          - Реализация Dialogue System
          - Дерево диалогов
          - Выбор ответов
          - Условия доступности
          - Влияние на репутацию
        estimated_effort: 5 days

      phase_4:
        name: Trading Interface
        tasks:
          - Реализация Trading Interface Manager
          - Каталог товаров
          - Покупка/продажа
          - Обмен валют
          - Ремонт оборудования
        estimated_effort: 4 days

      phase_5:
        name: Training Interface
        tasks:
          - Реализация Training Interface Manager
          - Дерево навыков
          - Обучение навыкам
          - Тренировочные режимы
        estimated_effort: 4 days

      phase_6:
        name: Faction Interface
        tasks:
          - Реализация Faction Interface Manager
          - Вступление в фракции
          - Задания фракций
          - Управление территорией
        estimated_effort: 4 days

      phase_7:
        name: Reputation System
        tasks:
          - Реализация NPC Reputation Tracker
          - Влияние действий на репутацию
          - Уровни репутации
          - Разблокировка контента
        estimated_effort: 3 days

      phase_8:
        name: Интеграции
        tasks:
          - Интеграция с Quest Service
          - Интеграция с Economy Service
          - Интеграция с Skill System
          - Интеграция с Faction System
          - WebSocket каналы
        estimated_effort: 4 days

    total_estimated_effort: 31 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> SocialService[Social Service<br/>8084]
        Gateway --> EconomyService[Economy Service<br/>8085]
        Gateway --> GameplayService[Gameplay Service<br/>8083]
        Gateway --> QuestService[Quest Service<br/>8087]
        
        SocialService --> NTM[NPC Type Manager]
        SocialService --> NIM[NPC Interaction Manager]
        SocialService --> DS[Dialogue System]
        SocialService --> NRT[NPC Reputation Tracker]
        SocialService --> NSM[NPC State Manager]
        SocialService --> FIM[Faction Interface Manager]
        
        EconomyService --> TIM[Trading Interface Manager]
        EconomyService --> NTC[NPC Trader Catalog]
        EconomyService --> CEH[Currency Exchange Handler]
        EconomyService --> ERH[Equipment Repair Handler]
        
        GameplayService --> TrIM[Training Interface Manager]
        GameplayService --> STM[Skill Tree Manager]
        GameplayService --> ST[Skill Trainer]
        GameplayService --> TS[Training Simulator]
        
        QuestService --> NQP[NPC Quest Provider]
        QuestService --> QCM[Quest Chain Manager]
        QuestService --> QCV[Quest Condition Validator]
        
        SocialService --> EventBus[Event Bus<br/>Kafka]
        EconomyService --> EventBus
        GameplayService --> EventBus
        QuestService --> EventBus
        
        SocialService --> DB[(NPC System DB)]
        EconomyService --> DB
        GameplayService --> DB
        QuestService --> DB
        
        SocialService --> Cache[(Redis Cache)]
        SocialService --> FactionService[Faction System]
        SocialService --> RelationshipService[Relationship System]
        
        Client --> WSNPC[WebSocket<br/>NPC Interactions]
        WSNPC --> SocialService
    ```

  interaction_flow: |
    ```mermaid
    sequenceDiagram
        participant Client
        participant SocialService
        participant NPCTypeManager
        participant InteractionManager
        participant DialogueSystem
        participant TradingInterface
        participant TrainingInterface
        
        Client->>SocialService: GET /npc/{id}/interact
        SocialService->>NPCTypeManager: Get NPC type
        NPCTypeManager->>InteractionManager: Get available actions
        InteractionManager->>Client: Available actions (dialogue, trade, train, etc.)
        
        Client->>SocialService: POST /npc/{id}/dialogue/start
        SocialService->>DialogueSystem: Start dialogue
        DialogueSystem->>Client: Dialogue tree
        
        Client->>SocialService: POST /npc/{id}/dialogue/response
        SocialService->>DialogueSystem: Process response
        DialogueSystem->>DialogueSystem: Update reputation
        DialogueSystem->>DialogueSystem: Check quest triggers
        DialogueSystem->>Client: Next dialogue node
    ```

  npc_type_functionality: |
    ```mermaid
    graph LR
        Fixer[Fixer] --> Contracts[Контракты]
        Fixer --> Quests[Квесты]
        Fixer --> Contacts[Контакты]
        Fixer --> Locations[Скрытые локации]
        
        Trader[Trader] --> Shop[Магазин]
        Trader --> Repair[Ремонт]
        Trader --> Currency[Обмен валют]
        Trader --> Auctions[Аукционы]
        
        Trainer[Trainer] --> Skills[Навыки]
        Trainer --> Training[Тренировки]
        Trainer --> Simulations[Симуляции]
        
        GangLeader[Gang Leader] --> GangQuests[Задания банды]
        GangLeader --> Territory[Территория]
        GangLeader --> Wars[Войны]
        
        CorporateDirector[Corporate Director] --> CorpContracts[Контракты]
        CorporateDirector --> Career[Карьера]
        CorporateDirector --> Politics[Политика]
    ```




