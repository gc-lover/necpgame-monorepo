metadata:
  id: player-character-management-system-architecture
  title: Архитектура системы управления персонажами игроков (Player Character Management System)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-23T05:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - player-character-management
    - backend
    - character
    - account
  related_systems:
    - character-service-go
    - inventory-service-go
    - quest-service-go
    - session-service-go
  related_documents:
    - id: backend-player-character-management-overview
      relation: extends
    - id: backend-player-character-creation
      relation: extends
    - id: backend-player-character-switching
      relation: extends
  github_issue: 389
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру системы управления
    персонажами игроков для создания, удаления, переключения и управления
    персонажами с поддержкой слотов, восстановления и синхронизации состояния.
  goal: |
    Создать архитектурную схему системы управления персонажами игроков с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы создания персонажей
    - Системы удаления персонажей
    - Системы переключения персонажей
    - Системы управления слотами
    - Технического задания для реализации
  essence: |
    Система управления персонажами игроков для создания, удаления, переключения
    и управления персонажами с поддержкой слотов, восстановления и синхронизации состояния.

architecture:
  overview: |
    Система управления персонажами игроков состоит из семи основных компонентов:
    1. Character Creation Manager - управление созданием персонажей
    2. Character Deletion Manager - управление удалением персонажей (soft delete)
    3. Character Restoration Manager - управление восстановлением персонажей
    4. Character Switching Manager - управление переключением персонажей
    5. Slot Management Manager - управление слотами персонажей
    6. Stats Recalculation Manager - пересчёт боевых статов
    7. Character State Manager - сохранение и загрузка состояния персонажей

  components:
    - name: Character Creation Manager
      location: character-service-go (модуль character-creation)
      responsibility: |
        - Создание персонажей
        - Валидация данных
        - Проверка слотов
        - Выдача стартовых ресурсов
        - Инициализация инвентаря и квестов
      creation_features: |
        - Проверка доступных слотов
        - Валидация имени персонажа (уникальность)
        - Задание атрибутов и навыков по классу и origin
        - Назначение стартовой зоны и валюты
        - Создание инвентаря
        - Выдача начальных квестов
      endpoints:
        - POST /api/v1/character/characters - создание персонажа
        - GET /api/v1/character/characters/validate-name - проверка имени
        - GET /api/v1/character/characters/available-slots - доступные слоты

    - name: Character Deletion Manager
      location: character-service-go (модуль character-deletion)
      responsibility: |
        - Удаление персонажей (soft delete)
        - Освобождение слотов
        - Установка окна восстановления
        - Публикация событий удаления
      deletion_features: |
        - Soft delete (флаг deleted)
        - Установка can_restore_until (30 дней)
        - Освобождение слота
        - Публикация CharacterDeleted события
        - Создание снапшота для восстановления
      endpoints:
        - DELETE /api/v1/character/characters/{character_id} - удаление персонажа
        - GET /api/v1/character/characters/{character_id}/deletion-status - статус удаления

    - name: Character Restoration Manager
      location: character-service-go (модуль character-restoration)
      responsibility: |
        - Восстановление удалённых персонажей
        - Проверка окна восстановления
        - Возврат слотов
        - Восстановление состояния
      restoration_features: |
        - Проверка окна восстановления (30 дней)
        - Возврат слота
        - Восстановление состояния из снапшота
        - Публикация CharacterRestored события
      endpoints:
        - POST /api/v1/character/characters/{character_id}/restore - восстановление персонажа
        - GET /api/v1/character/characters/deleted - список удалённых персонажей

    - name: Character Switching Manager
      location: character-service-go (модуль character-switching)
      responsibility: |
        - Переключение между персонажами
        - Сохранение текущего персонажа
        - Валидация прав доступа
        - Обновление сессии
      switching_features: |
        - Сохранение текущего персонажа
        - Проверка прав на нового персонажа
        - Обновление session (current_character_id)
        - Обновление last_played_at
        - Публикация CharacterSwitched события
      endpoints:
        - POST /api/v1/character/characters/{character_id}/switch - переключение персонажа
        - GET /api/v1/character/characters/current - текущий персонаж

    - name: Slot Management Manager
      location: character-service-go (модуль slot-management)
      responsibility: |
        - Управление слотами персонажей
        - Покупка дополнительных слотов
        - Отслеживание использования слотов
        - Управление базовыми и премиальными слотами
      slot_features: |
        - Базовые слоты (по умолчанию)
        - Премиальные слоты (покупка)
        - Отслеживание used_slots
        - Проверка лимитов
        - Списание валюты при покупке
      endpoints:
        - GET /api/v1/character/slots - информация о слотах
        - POST /api/v1/character/slots/purchase - покупка слота
        - GET /api/v1/character/slots/available - доступные слоты

    - name: Stats Recalculation Manager
      location: character-service-go (модуль stats-recalculation)
      responsibility: |
        - Пересчёт боевых статов персонажа
        - Учёт атрибутов, экипировки и бафов
        - Синхронизация здоровья и брони
        - Защита от переполнения
      stats_features: |
        - Базовые статы из атрибутов
        - Бонусы от экипировки
        - Бонусы от активных бафов
        - Синхронизация здоровья и брони
        - Валидация значений (защита от переполнения)
      endpoints:
        - POST /api/v1/character/characters/{character_id}/recalculate-stats - пересчёт статов
        - GET /api/v1/character/characters/{character_id}/stats - текущие статы

    - name: Character State Manager
      location: character-service-go (модуль character-state)
      responsibility: |
        - Сохранение состояния персонажа
        - Загрузка состояния персонажа
        - Создание снапшотов
        - Синхронизация с другими сервисами
      state_features: |
        - Сохранение основных записей
        - Сохранение инвентаря
        - Сохранение прогресса квестов
        - Сохранение состояния сессии
        - Создание снапшотов для восстановления
      endpoints:
        - POST /api/v1/character/characters/{character_id}/save-state - сохранение состояния
        - GET /api/v1/character/characters/{character_id}/load-state - загрузка состояния
        - POST /api/v1/character/characters/{character_id}/snapshot - создание снапшота

  data_flow:
    character_creation: |
      1. Игрок запрашивает создание персонажа через API
      2. Character Creation Manager проверяет доступные слоты
      3. Валидируется имя персонажа (уникальность)
      4. Создаётся запись персонажа в БД
      5. Задаются атрибуты и навыки по классу и origin
      6. Назначается стартовая зона и валюта
      7. Inventory Service создаёт инвентарь
      8. Quest Service выдаёт начальные квесты
      9. Character Creation Manager публикует CharacterCreated событие
      10. Notification Service уведомляет игрока
      11. Realtime Gateway синхронизирует состояние

    character_deletion: |
      1. Игрок запрашивает удаление персонажа
      2. Character Deletion Manager проверяет права
      3. Создаётся снапшот для восстановления
      4. Устанавливается флаг deleted и can_restore_until (30 дней)
      5. Освобождается слот (уменьшается used_slots)
      6. Character Deletion Manager публикует CharacterDeleted событие
      7. Интеграция с другими сервисами для очистки состояния
      8. Notification Service уведомляет игрока
      9. Realtime Gateway синхронизирует состояние

    character_switching: |
      1. Игрок запрашивает переключение персонажа
      2. Character Switching Manager сохраняет текущего персонажа
      3. Проверяются права на нового персонажа
      4. Обновляется session (current_character_id)
      5. Обновляется last_played_at
      6. Character Switching Manager публикует CharacterSwitched событие
      7. Inventory Service загружает инвентарь нового персонажа
      8. Quest Service загружает квесты нового персонажа
      9. Realtime Gateway синхронизирует состояние

    stats_recalculation: |
      1. Триггер пересчёта статов (изменение атрибутов, экипировки, бафов)
      2. Stats Recalculation Manager получает базовые статы из атрибутов
      3. Добавляются бонусы от экипировки
      4. Добавляются бонусы от активных бафов
      5. Синхронизируются здоровье и броня
      6. Валидируются значения (защита от переполнения)
      7. Сохраняются обновлённые статы в БД
      8. Realtime Gateway синхронизирует состояние

  integrations:
    with_inventory_service: |
      - Создание инвентаря при создании персонажа
      - Загрузка инвентаря при переключении
      - Очистка инвентаря при удалении

    with_quest_service: |
      - Выдача начальных квестов при создании персонажа
      - Загрузка квестов при переключении
      - Очистка квестов при удалении

    with_session_service: |
      - Обновление current_character_id при переключении
      - Сохранение состояния сессии
      - Загрузка состояния сессии

    with_economy_service: |
      - Выдача стартовой валюты при создании персонажа
      - Списание валюты при покупке слотов

    with_notification_service: |
      - Уведомления о создании персонажа
      - Уведомления об удалении персонажа
      - Уведомления о переключении персонажа

    with_realtime_gateway: |
      - Синхронизация состояния персонажа
      - Уведомления о событиях
      - Обновления в реальном времени

  database_schema:
    tables:
      - name: players
        description: Профили игроков (аккаунты)
        fields:
          - id: UUID (PK)
          - account_id: UUID (FK accounts)
          - username: VARCHAR(255)
          - email: VARCHAR(255)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - account_id
          - username

      - name: characters
        description: Персонажи игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK players)
          - name: VARCHAR(255)
          - class: VARCHAR(50)
          - origin: VARCHAR(50)
          - level: INTEGER (default: 1)
          - attributes: JSONB
          - skills: JSONB
          - stats: JSONB
          - current_zone: VARCHAR(100)
          - deleted: BOOLEAN (default: false)
          - deleted_at: TIMESTAMP (nullable)
          - can_restore_until: TIMESTAMP (nullable)
          - last_played_at: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(player_id, name)
        indexes:
          - player_id, deleted
          - name
          - deleted, can_restore_until

      - name: character_slots
        description: Слоты персонажей игроков
        fields:
          - id: UUID (PK)
          - player_id: UUID (FK players)
          - base_slots: INTEGER (default: 3)
          - premium_slots: INTEGER (default: 0)
          - total_slots: INTEGER (computed: base_slots + premium_slots)
          - used_slots: INTEGER (default: 0)
          - premium_slots_purchased: INTEGER (default: 0)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        constraints: |
          - UNIQUE(player_id)
          - CHECK(used_slots <= total_slots)
        indexes:
          - player_id

      - name: character_snapshots
        description: Снапшоты персонажей для восстановления
        fields:
          - id: UUID (PK)
          - character_id: UUID (FK characters)
          - snapshot_data: JSONB
          - created_at: TIMESTAMP
        indexes:
          - character_id, created_at

technical_specification:
  backend_requirements:
    - Реализация модулей в character-service-go:
      - character-creation (создание персонажей)
      - character-deletion (удаление персонажей)
      - character-restoration (восстановление персонажей)
      - character-switching (переключение персонажей)
      - slot-management (управление слотами)
      - stats-recalculation (пересчёт статов)
      - character-state (сохранение и загрузка состояния)
    - Интеграция с inventory-service для инвентаря
    - Интеграция с quest-service для квестов
    - Интеграция с session-service для сессий
    - Интеграция с economy-service для валюты
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация состояния персонажа через WebSocket
    - Уведомления о событиях
    - Обновления в реальном времени

  performance_requirements:
    - Создание персонажа < 500ms
    - Удаление персонажа < 300ms
    - Переключение персонажа < 400ms
    - Пересчёт статов < 200ms
    - Загрузка состояния < 300ms
    - Поддержка до 1M персонажей
    - Поддержка до 100K одновременных переключений

  scalability_requirements:
    - Горизонтальное масштабирование через character-service
    - Распределение нагрузки на персонажей
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование состояния персонажей в Redis
    - Оптимизация интеграций

subtasks:
  - id: character-creation-manager-module
    title: Реализация модуля Character Creation Manager
    description: |
      Создание персонажей
      Валидация данных
      Проверка слотов
      Выдача стартовых ресурсов
    priority: high
    estimated_time: 4-5 дней

  - id: character-deletion-manager
    title: Реализация Character Deletion Manager
    description: |
      Удаление персонажей (soft delete)
      Освобождение слотов
      Установка окна восстановления
    priority: high
    estimated_time: 3-4 дня

  - id: character-restoration-manager
    title: Реализация Character Restoration Manager
    description: |
      Восстановление удалённых персонажей
      Проверка окна восстановления
      Возврат слотов
    priority: high
    estimated_time: 3-4 дня

  - id: character-switching-manager
    title: Реализация Character Switching Manager
    description: |
      Переключение между персонажами
      Сохранение текущего персонажа
      Обновление сессии
    priority: high
    estimated_time: 4-5 дней

  - id: slot-management-manager
    title: Реализация Slot Management Manager
    description: |
      Управление слотами персонажей
      Покупка дополнительных слотов
      Отслеживание использования слотов
    priority: high
    estimated_time: 3-4 дня

  - id: stats-recalculation-manager
    title: Реализация Stats Recalculation Manager
    description: |
      Пересчёт боевых статов
      Учёт атрибутов, экипировки и бафов
      Синхронизация здоровья и брони
    priority: high
    estimated_time: 3-4 дня

  - id: character-state-manager
    title: Реализация Character State Manager
    description: |
      Сохранение состояния персонажа
      Загрузка состояния персонажа
      Создание снапшотов
    priority: high
    estimated_time: 4-5 дней

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование состояния
    priority: medium
    estimated_time: 2-3 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для управления персонажами
      Интеграция с существующим API character-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты создания персонажей
      Тесты удаления персонажей
      Тесты переключения персонажей
      Тесты управления слотами
      Тесты пересчёта статов
      Тесты интеграций
    priority: high
    estimated_time: 5-6 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Character Service"
            CCM[Character Creation Manager]
            CDM[Character Deletion Manager]
            CRM[Character Restoration Manager]
            CSM[Character Switching Manager]
            SMM[Slot Management Manager]
            SRM[Stats Recalculation Manager]
            CSM2[Character State Manager]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>players<br/>characters<br/>character_slots<br/>character_snapshots)]
        end

        subgraph "External Services"
            IS[Inventory Service]
            QS[Quest Service]
            SS[Session Service]
            ES[Economy Service]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|create character| CCM
        CL -->|switch character| CSM
        CCM --> IS
        CCM --> QS
        CSM --> SS
        SMM --> ES
        CDM --> NS
        CSM --> RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant CCM as Character Creation Manager
        participant IS as Inventory Service
        participant QS as Quest Service

        P->>CCM: Create character
        CCM->>IS: Create inventory
        CCM->>QS: Assign initial quests
        CCM->>P: Character created
    ```

decisions:
  - id: adr-player-character-architecture
    summary: |
      Выбрана модульная архитектура внутри character-service-go для обеспечения
      централизованного управления персонажами игроков.

  - id: adr-soft-delete
    summary: |
      Использован soft delete для возможности восстановления персонажей в течение
      30 дней, что улучшает пользовательский опыт.

  - id: adr-slot-management
    summary: |
      Система слотов с базовыми и премиальными слотами обеспечивает гибкость
      в управлении персонажами и монетизацию.

  - id: adr-stats-recalculation
    summary: |
      Пересчёт статов с учётом атрибутов, экипировки и бафов обеспечивает
      актуальность боевых характеристик персонажа.

  - id: adr-character-state
    summary: |
      Система сохранения и загрузки состояния с снапшотами обеспечивает
      надёжность и возможность восстановления данных.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата данных персонажей и слотов

history:
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура системы управления персонажами игроков:
      - Определены компоненты (Character Creation Manager, Character Deletion Manager, Character Restoration Manager, Character Switching Manager, Slot Management Manager, Stats Recalculation Manager, Character State Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (players, characters, character_slots, character_snapshots)
      - Спроектирована система создания персонажей
      - Спроектирована система удаления персонажей (soft delete)
      - Спроектирована система восстановления персонажей
      - Спроектирована система переключения персонажей
      - Спроектирована система управления слотами
      - Спроектирована система пересчёта статов
      - Спроектирована система сохранения и загрузки состояния
      - Создано техническое задание
      - Разбито на подзадачи


