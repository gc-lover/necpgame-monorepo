metadata:
  id: progression-system-architecture
  title: Архитектура системы прогрессии (Progression System)
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-14T15:25:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - progression
    - gameplay
    - backend
  topics:
    - experience-system
    - level-system
    - skill-progression
    - attribute-system
  related_systems:
    - gameplay-service
    - character-service
    - achievement-service
    - notification-service
    - analytics-service
  related_documents:
    - id: progression-backend
      relation: implements
  visibility: internal
  audience:
    - backend
    - gameplay
    - architect
  risk_level: medium

summary:
  problem: Необходима полная архитектурная документация для системы прогрессии персонажей
  goal: Спроектировать масштабируемую систему прогрессии с опытом, уровнями и распределением очков
  essence: Микросервисная архитектура с event-driven интеграциями для обработки опыта и прогрессии
  key_points:
    - Модульная архитектура с разделением ответственности
    - Event-driven система для обработки опыта из различных источников
    - Экспоненциальные формулы расчёта опыта и уровней
    - Валидация распределения очков с ограничениями

content:
  sections:
    - id: system-overview
      title: Обзор системы
      body: |
        Система прогрессии отвечает за обработку опыта, повышение уровней персонажей,
        распределение очков атрибутов и навыков. Система интегрируется с боевой системой,
        квестами и достижениями для комплексного управления прогрессией игрока.

        **Ключевые компоненты:**
        - Experience Calculator: Расчёт и начисление опыта
        - Level Manager: Управление уровнями и требованиями
        - Point Distributor: Распределение очков атрибутов и навыков
        - Progression Tracker: Отслеживание прогресса и статистики

    - id: microservices-architecture
      title: Микросервисная архитектура
      body: |
        **Основной сервис: gameplay-service**
        - Порт: 8083
        - Базовый путь: `/api/v1/gameplay/progression/`
        - Отвечает за всю логику прогрессии

        **Интеграции:**
        - character-service: Обновление параметров персонажа
        - achievement-service: Проверка достижений
        - notification-service: Уведомления игроку
        - analytics-service: Статистика прогрессии
        - inventory-service: Награды за уровни

    - id: modules-structure
      title: Структура модулей
      body: |
        **Core Modules:**
        - `progression/calculator`: Расчёт опыта и формулы
        - `progression/level`: Управление уровнями
        - `progression/points`: Распределение очков
        - `progression/tracker`: Отслеживание прогресса
        - `progression/events`: Публикация событий
        - `progression/validation`: Валидация операций

        **Supporting Modules:**
        - `progression/cache`: Кэширование данных прогрессии
        - `progression/metrics`: Метрики производительности
        - `progression/migration`: Миграции БД

    - id: api-endpoints
      title: API Endpoints (высокоуровнево)
      body: |
        **Experience Management:**
        - `POST /api/v1/gameplay/progression/experience/award` - Начисление опыта
        - `GET /api/v1/gameplay/progression/experience/{characterId}` - Получение текущего опыта

        **Level Management:**
        - `GET /api/v1/gameplay/progression/level/{characterId}` - Текущий уровень
        - `GET /api/v1/gameplay/progression/level/requirements/{level}` - Требования к уровню

        **Points Distribution:**
        - `POST /api/v1/gameplay/progression/points/attribute` - Распределение очков атрибутов
        - `POST /api/v1/gameplay/progression/points/skill` - Распределение очков навыков
        - `GET /api/v1/gameplay/progression/points/available/{characterId}` - Доступные очки

        **Progression Stats:**
        - `GET /api/v1/gameplay/progression/stats/{characterId}` - Статистика прогрессии
        - `GET /api/v1/gameplay/progression/history/{characterId}` - История изменений

    - id: data-flows
      title: Потоки данных и интеграции
      body: |
        **Event-Driven Architecture:**
        - Подписка на события: `combat:enemy-killed`, `quest:completed`, `skill:used`
        - Публикация событий: `character:level-up`, `character:skill-leveled`, `character:attribute-increased`

        **Data Flow:**
        1. Источник опыта → Experience Calculator
        2. Расчёт опыта → Level Manager (проверка уровня)
        3. Повышение уровня → Point Distributor (выдача очков)
        4. Обновление персонажа → Character Service
        5. Уведомления → Notification Service
        6. Достижения → Achievement Service

        **Caching Strategy:**
        - Redis для текущего состояния прогрессии
        - PostgreSQL для исторических данных
        - TTL: 5 минут для активных сессий

    - id: database-schema
      title: Структура базы данных
      body: |
        **character_progression:**
        ```sql
        CREATE TABLE character_progression (
            character_id UUID PRIMARY KEY,
            current_level INTEGER NOT NULL DEFAULT 1,
            current_experience BIGINT NOT NULL DEFAULT 0,
            total_experience BIGINT NOT NULL DEFAULT 0,
            experience_to_next BIGINT NOT NULL,
            available_attribute_points INTEGER NOT NULL DEFAULT 0,
            available_skill_points INTEGER NOT NULL DEFAULT 0,
            created_at TIMESTAMP NOT NULL,
            updated_at TIMESTAMP NOT NULL
        );
        ```

        **character_attributes:**
        ```sql
        CREATE TABLE character_attributes (
            character_id UUID NOT NULL,
            attribute_type VARCHAR(50) NOT NULL,
            base_value INTEGER NOT NULL DEFAULT 0,
            bonus_value INTEGER NOT NULL DEFAULT 0,
            total_value INTEGER NOT NULL DEFAULT 0,
            created_at TIMESTAMP NOT NULL,
            updated_at TIMESTAMP NOT NULL,
            PRIMARY KEY (character_id, attribute_type)
        );
        ```

        **character_skills:**
        ```sql
        CREATE TABLE character_skills (
            character_id UUID NOT NULL,
            skill_id VARCHAR(100) NOT NULL,
            current_level INTEGER NOT NULL DEFAULT 0,
            current_experience BIGINT NOT NULL DEFAULT 0,
            experience_to_next BIGINT NOT NULL,
            created_at TIMESTAMP NOT NULL,
            updated_at TIMESTAMP NOT NULL,
            PRIMARY KEY (character_id, skill_id)
        );
        ```

        **experience_sources:**
        ```sql
        CREATE TABLE experience_sources (
            id UUID PRIMARY KEY,
            character_id UUID NOT NULL,
            source_type VARCHAR(50) NOT NULL, -- combat, quest, skill, etc.
            source_id VARCHAR(100), -- enemy_id, quest_id, etc.
            experience_amount BIGINT NOT NULL,
            awarded_at TIMESTAMP NOT NULL,
            metadata JSONB
        );
        ```

        **Индексы:**
        - character_progression(character_id)
        - character_attributes(character_id)
        - character_skills(character_id, skill_id)
        - experience_sources(character_id, awarded_at)

    - id: experience-calculation
      title: Система расчёта опыта
      body: |
        **Exponential Formula:**
        ```
        experience_required(level) = base_experience * (growth_rate ^ (level - 1))
        ```

        **Parameters:**
        - base_experience: 1000 (опыт для 1 уровня)
        - growth_rate: 1.15 (15% рост на уровень)
        - max_level: 100

        **Experience Sources:**
        - Combat: enemy_level * base_multiplier * difficulty_modifier
        - Quests: quest_difficulty * completion_bonus
        - Skills: skill_usage * skill_level_multiplier
        - Exploration: discovery_points * rarity_multiplier

        **Modifiers:**
        - First-time bonus: +25%
        - Group size penalty: -10% per additional member
        - Time bonus: +50% for speed runs

    - id: level-up-system
      title: Система повышения уровня
      body: |
        **Level Up Process:**
        1. Проверка достижения порога опыта
        2. Блокировка операций прогрессии
        3. Расчёт выдаваемых очков
        4. Обновление уровня и статистики
        5. Публикация события level-up
        6. Отправка уведомления игроку

        **Points Awarded:**
        - Attribute Points: 5 per level
        - Skill Points: 3 per level (every 2nd level)
        - Bonus Points: Special events/milestones

        **Validation:**
        - Максимальный уровень: 100
        - Минимальный опыт для уровня
        - Проверка на дублирование операций

    - id: points-distribution
      title: Система распределения очков
      body: |
        **Attribute Points:**
        - Strength, Agility, Intelligence, Vitality
        - Base cap: 100 per attribute
        - Soft cap scaling: +10 per 10 levels
        - Validation: Available points >= requested

        **Skill Points:**
        - Tree-based skill system
        - Prerequisites for advanced skills
        - Level caps per skill tier
        - Refund mechanism: 50% experience back

        **Distribution Rules:**
        - Atomic operations (all or nothing)
        - Race condition prevention
        - Audit logging for all changes
        - Real-time validation

    - id: error-handling
      title: Обработка ошибок и отказоустойчивость
      body: |
        **Circuit Breaker Pattern:**
        - DB failures: Fallback to cached data
        - External service failures: Queue operations
        - Validation failures: Detailed error messages

        **Retry Logic:**
        - Exponential backoff: 1s, 2s, 4s, 8s
        - Max retries: 3 attempts
        - Dead letter queue for permanent failures

        **Data Consistency:**
        - ACID transactions for point distribution
        - Eventual consistency for cross-service updates
        - Compensation transactions for rollbacks

    - id: performance-optimization
      title: Оптимизации производительности
      body: |
        **Caching Strategy:**
        - Redis: Character progression data (TTL: 5min)
        - In-memory: Experience formulas (no TTL)
        - CDN: Static progression tables

        **Batch Operations:**
        - Bulk experience awards
        - Mass level calculations
        - Batch notifications

        **Async Processing:**
        - Event publishing (Kafka/RabbitMQ)
        - Background analytics updates
        - Scheduled cleanup tasks

        **Performance Targets:**
        - Experience award: <10ms P95
        - Level up check: <5ms P95
        - Point distribution: <20ms P95

    - id: monitoring-analytics
      title: Мониторинг и аналитика
      body: |
        **Metrics:**
        - Experience awarded per minute
        - Level up events per hour
        - Point distribution success rate
        - Cache hit/miss ratios

        **Analytics:**
        - Player progression velocity
        - Popular skill/attribute choices
        - Experience source effectiveness
        - Bottleneck identification

        **Alerts:**
        - Failed experience awards
        - Invalid level up attempts
        - High error rates

appendix:
  glossary:
    - term: Experience Points (XP)
      definition: Валюта прогрессии, получаемая из различных игровых активностей
    - term: Attribute Points
      definition: Очки для улучшения базовых характеристик персонажа
    - term: Skill Points
      definition: Очки для изучения и улучшения навыков
    - term: Level Cap
      definition: Максимальный уровень, который может достичь персонаж

  references:
    - type: api
      path: /api/v1/gameplay/progression/
    - type: database
      path: infrastructure/liquibase/migrations/gameplay/progression/
    - type: events
      path: knowledge/implementation/backend/events/progression-events.yaml

  decisions:
    - id: adr-progression-architecture
      summary: Одобрена event-driven архитектура с разделением на микросервисы
    - id: adr-experience-formula
      summary: Выбрана экспоненциальная формула роста опыта с коэффициентом 1.15
    - id: adr-points-system
      summary: Реализовано разделение на attribute points и skill points с валидацией

implementation:
  needs_task: false
  github_issue: 164
  subtasks:
    - id: progression-service-implementation
      title: Реализация основного сервиса прогрессии
      description: Создание базового сервиса с обработкой опыта и уровней
      estimated_hours: 40
      dependencies: []

    - id: progression-database-migration
      title: Миграции базы данных для прогрессии
      description: Создание таблиц и индексов для хранения данных прогрессии
      estimated_hours: 8
      dependencies: []

    - id: progression-api-implementation
      title: Реализация REST API для прогрессии
      description: Создание HTTP endpoints для управления прогрессией
      estimated_hours: 24
      dependencies: [progression-service-implementation]

    - id: progression-event-system
      title: Система событий прогрессии
      description: Публикация и подписка на события изменения прогрессии
      estimated_hours: 16
      dependencies: [progression-service-implementation]

    - id: progression-points-system
      title: Система распределения очков
      description: Логика распределения и валидации очков атрибутов и навыков
      estimated_hours: 20
      dependencies: [progression-service-implementation]

    - id: progression-cache-integration
      title: Интеграция кэширования
      description: Добавление Redis кэширования для производительности
      estimated_hours: 12
      dependencies: [progression-service-implementation]

    - id: progression-testing
      title: Тестирование системы прогрессии
      description: Unit, integration и load тестирование
      estimated_hours: 16
      dependencies:
        [progression-service-implementation, progression-api-implementation]

    - id: progression-documentation
      title: Документация API и интеграций
      description: Создание OpenAPI спецификаций и документации
      estimated_hours: 8
      dependencies: [progression-api-implementation]

  blockers: []
  priority: high

history:
  - version: "1.0.0"
    date: 2025-12-14
    author: Architect Agent
    changes: Создана полная архитектурная документация системы прогрессии

validation:
  checksum: ""
  schema_version: "1.0"
