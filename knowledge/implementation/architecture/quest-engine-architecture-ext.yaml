- quest_instance_id: UUID (FK quest_instances)
- objective_id: VARCHAR(100)
- current_progress: INTEGER
- target_progress: INTEGER
- is_completed: BOOLEAN
- completed_at: TIMESTAMP (nullable)
indexes:
  - quest_instance_id, is_completed
  - quest_instance_id, objective_id

technical_specification:
  backend_requirements:
    - Реализация модулей в gameplay-service-go:
        - quest (управление квестами)
        - quest-state (state machine)
        - quest-dialogue (диалоги)
        - quest-skill-checks (проверки навыков)
        - quest-conditions (условия)
        - quest-rewards (награды)
        - quest-events (события)
    - Интеграция с character-service для проверок
    - Интеграция с economy-service для наград
    - Интеграция с narrative-coherence-system
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация состояния квестов через WebSocket
    - Обновления прогресса в реальном времени
    - Уведомления о событиях квестов

  performance_requirements:
    - Начало квеста < 100ms
    - Обновление прогресса < 50ms
    - Завершение квеста < 200ms
    - Обработка skill check < 50ms
    - Поддержка до 100 активных квестов на игрока
    - Поддержка до 10K активных квестов одновременно

  scalability_requirements:
    - Горизонтальное масштабирование через gameplay-service
    - Распределение нагрузки на квесты
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование определений квестов

subtasks:
  - id: quest-manager-module
    title: Реализация модуля Quest Manager
    description: |
      Управление квестами
      CRUD операции
      Жизненный цикл квестов
    priority: high
    estimated_time: 4-5 дней

  - id: quest-state-machine-implementation
    title: Реализация Quest State Machine
    description: |
      Управление состоянием квестов
      Переходы между состояниями
      Сохранение и восстановление состояния
    priority: high
    estimated_time: 4-5 дней

  - id: dialogue-engine-development
    title: Реализация Dialogue Engine
    description: |
      Обработка диалогов
      Ветвления диалогов
      Выборы игрока
    priority: high
    estimated_time: 4-5 дней

  - id: skill-check-processor
    title: Реализация Skill Check Processor
    description: |
      Обработка проверок навыков
      Расчёт результатов
      Интеграция с character-service
    priority: high
    estimated_time: 3-4 дня

  - id: quest-condition-evaluator
    title: Реализация Quest Condition Evaluator
    description: |
      Оценка условий квестов
      Проверка требований
      Интеграция с другими сервисами
    priority: high
    estimated_time: 3-4 дня

  - id: quest-reward-distributor
    title: Реализация Quest Reward Distributor
    description: |
      Распределение наград
      Выдача опыта, валюты, предметов
      Интеграция с economy и mail
    priority: high
    estimated_time: 3-4 дня

  - id: quest-event-handler
    title: Реализация Quest Event Handler
    description: |
      Обработка событий квестов
      Публикация событий
      Подписка на события
    priority: high
    estimated_time: 3-4 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование определений квестов
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для квестов
      Интеграция с существующим API gameplay-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты управления квестами
      Тесты state machine
      Тесты диалогов
      Тесты skill checks
      Тесты интеграций
    priority: high
    estimated_time: 3-4 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Gameplay Service"
            QM[Quest Manager]
            QSM[Quest State Machine]
            DE[Dialogue Engine]
            SCP[Skill Check Processor]
            QCE[Quest Condition Evaluator]
            QRD[Quest Reward Distributor]
            QEH[Quest Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>quest_instances<br/>quest_definitions<br/>dialogue_state<br/>skill_check_results)]
        end

        subgraph "External Services"
            CS[Character Service]
            ES[Economy Service]
            SS[Social Service]
            MS[Mail Service]
            NCS[Narrative Coherence System]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|start quest| QM
        QM --> QSM
        QM --> QCE
        QM --> DE
        QM --> SCP
        QM --> QRD
        QM --> QEH
        QM -->|store| DB
        SCP -->|check skills| CS
        QCE -->|check requirements| CS
        QCE -->|check reputation| SS
        QRD -->|distribute rewards| ES
        QRD -->|send rewards| MS
        QEH -->|update world state| NCS
        QEH -->|notify| NS
        QM -->|sync state| RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant QM as Quest Manager
        participant QCE as Quest Condition Evaluator
        participant QSM as Quest State Machine
        participant DE as Dialogue Engine
        participant QEH as Quest Event Handler
        participant QRD as Quest Reward Distributor

        P->>QM: Start quest
        QM->>QCE: Check requirements
        QCE->>QM: Requirements OK
        QM->>QSM: Initialize state
        QM->>DE: Initialize dialogue
        QEH->>QEH: Publish quest:started
    
        P->>DE: Make dialogue choice
        DE->>QSM: Update state
        QSM->>QEH: Publish progress
    
        P->>QM: Complete quest
        QM->>QRD: Distribute rewards
        QRD->>QRD: Send rewards
        QSM->>QSM: Update to COMPLETED
        QEH->>QEH: Publish quest:completed
    ```

decisions:
  - id: adr-quest-architecture
    summary: |
      Выбрана модульная архитектура внутри gameplay-service-go для обеспечения
      тесной интеграции с игровым процессом.

  - id: adr-state-machine
    summary: |
      State machine обеспечивает надёжное управление состоянием квестов и
      предотвращает некорректные переходы.

  - id: adr-dialogue-engine
    summary: |
      Dialogue Engine с поддержкой ветвлений обеспечивает интерактивные диалоги
      и выборы игрока, влияющие на сюжет.

  - id: adr-skill-checks
    summary: |
      Система skill checks добавляет глубину геймплея и учитывает характеристики
      персонажа при прохождении квестов.

  - id: adr-quest-integration
    summary: |
      Интеграция с Narrative Coherence System обеспечивает целостность сюжета
      и динамическую адаптацию квестов к выбору игрока.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата state machine

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния квестов
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (начало квеста, завершение квеста с наградами)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для операций с квестами, диалогами, skill checks и realtime обновлений
  - version: '1.0.0'
    date: 2025-11-22
    author: Architect Agent
    changes: |
      Создана полная архитектура движка квестов:
      - Определены компоненты (Quest Manager, Quest State Machine, Dialogue Engine, Skill Check Processor, Quest Condition Evaluator, Quest Reward Distributor, Quest Event Handler)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (quest_instances, quest_definitions, dialogue_state, skill_check_results, quest_objective_progress)
      - Спроектирована система state machine для квестов
      - Спроектирована система диалогов
      - Спроектирована система skill checks
      - Создано техническое задание
      - Разбито на подзадачи

