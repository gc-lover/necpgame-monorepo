metadata:
  id: quest-engine-architecture
  title: Архитектура движка квестов (Quest Engine)
  document_type: architecture
  category: systems
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-22T22:45:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - quest
    - backend
    - gameplay
  related_systems:
    - gameplay-service-go
    - character-service-go
    - economy-service-go
    - social-service-go
    - narrative-coherence-system
  related_documents:
    - id: quest-engine-backend
      relation: extends
    - id: narrative-coherence-system-architecture
      relation: references
  github_issue: 154
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру движка квестов
    для обработки state machine, диалогов, skill checks, ветвящихся сценариев
    и интеграции с другими игровыми системами.
  goal: |
    Создать архитектурную схему движка квестов с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы state machine для квестов
    - Системы диалогов
    - Системы skill checks
    - Технического задания для реализации
  essence: |
    Игровой движок для обработки квестов с поддержкой state machine, диалогов,
    skill checks, ветвящихся сценариев и интеграции с другими системами.

architecture:
  overview: |
    Движок квестов состоит из семи основных компонентов:
    1. Quest Manager - управление квестами
    2. Quest State Machine - управление состоянием квестов
    3. Dialogue Engine - обработка диалогов
    4. Skill Check Processor - обработка проверок навыков
    5. Quest Condition Evaluator - оценка условий квестов
    6. Quest Reward Distributor - распределение наград
    7. Quest Event Handler - обработка событий квестов

  components:
    - name: Quest Manager
      location: gameplay-service-go (модуль quest)
      responsibility: |
        - Управление жизненным циклом квестов
        - Создание и инициализация квестов
        - Завершение и отмена квестов
        - Получение информации о квестах
        - Интеграция с другими модулями
      port: 8083 (gameplay-service-go)
      endpoints:
        - POST /api/v1/gameplay/quests/start - начало квеста
        - GET /api/v1/gameplay/quests/{quest_id} - информация о квесте
        - GET /api/v1/gameplay/quests/player/{player_id} - квесты игрока
        - POST /api/v1/gameplay/quests/{quest_id}/complete - завершение квеста
        - POST /api/v1/gameplay/quests/{quest_id}/cancel - отмена квеста

    - name: Quest State Machine
      location: gameplay-service-go (модуль quest-state)
      responsibility: |
        - Управление состоянием квестов
        - Переходы между состояниями
        - Обработка ветвлений
        - Сохранение состояния
        - Восстановление состояния
      quest_states: |
        - NOT_STARTED: квест не начат
        - IN_PROGRESS: квест в процессе
        - COMPLETED: квест завершён
        - FAILED: квест провален
        - CANCELLED: квест отменён
      state_transitions: |
        - NOT_STARTED -> IN_PROGRESS (при старте)
        - IN_PROGRESS -> COMPLETED (при выполнении всех целей)
        - IN_PROGRESS -> FAILED (при провале условий)
        - IN_PROGRESS -> CANCELLED (при отмене)
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/state - состояние квеста
        - POST /api/v1/gameplay/quests/{quest_id}/state/update - обновление состояния

    - name: Dialogue Engine
      location: gameplay-service-go (модуль quest-dialogue)
      responsibility: |
        - Обработка диалогов в квестах
        - Управление ветвлениями диалогов
        - Обработка выборов игрока
        - Сохранение состояния диалогов
        - Интеграция с skill checks
      dialogue_features: |
        - Ветвящиеся диалоги
        - Выборы игрока
        - Условные ответы
        - Skill checks в диалогах
        - Сохранение выбранных путей
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/dialogue - текущий диалог
        - POST /api/v1/gameplay/quests/{quest_id}/dialogue/choice - выбор в диалоге
        - GET /api/v1/gameplay/quests/{quest_id}/dialogue/history - история диалогов

    - name: Skill Check Processor
      location: gameplay-service-go (модуль quest-skill-checks)
      responsibility: |
        - Обработка проверок навыков
        - Расчёт результатов проверок
        - Интеграция с character-service
        - Обработка успешных/неуспешных проверок
      skill_check_types: |
        - Attribute check: проверка атрибутов
        - Skill check: проверка навыков
        - Item check: проверка предметов
        - Reputation check: проверка репутации
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/skill-check - выполнение проверки
        - GET /api/v1/gameplay/quests/{quest_id}/skill-checks - история проверок

    - name: Quest Condition Evaluator
      location: gameplay-service-go (модуль quest-conditions)
      responsibility: |
        - Оценка условий квестов
        - Проверка требований для старта
        - Проверка условий для завершения
        - Проверка условий для целей
        - Интеграция с другими сервисами
      condition_types: |
        - Level requirement: требование уровня
        - Item requirement: требование предмета
        - Quest prerequisite: требование предыдущего квеста
        - Reputation requirement: требование репутации
        - Location requirement: требование местоположения
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/conditions/check - проверка условий
        - GET /api/v1/gameplay/quests/{quest_id}/requirements - требования квеста

    - name: Quest Reward Distributor
      location: gameplay-service-go (модуль quest-rewards)
      responsibility: |
        - Распределение наград за квесты
        - Выдача опыта
        - Выдача валюты
        - Выдача предметов
        - Выдача репутации
        - Интеграция с economy-service и mail-service
      reward_types: |
        - Experience: опыт
        - Currency: валюта
        - Items: предметы
        - Reputation: репутация
        - Titles: титулы
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/rewards/distribute - распределение наград
        - GET /api/v1/gameplay/quests/{quest_id}/rewards - награды квеста

    - name: Quest Event Handler
      location: gameplay-service-go (модуль quest-events)
      responsibility: |
        - Обработка событий квестов
        - Публикация событий в event bus
        - Подписка на события от других систем
        - Обработка событий для обновления прогресса
      quest_events_published: |
        - quest:started
        - quest:objective-completed
        - quest:completed
        - quest:failed
        - quest:cancelled
      quest_events_consumed: |
        - combat:enemy-killed
        - inventory:item-added
        - social:reputation-changed
        - character:level-up
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/events - события квеста

  data_flow:
    quest_start: |
      1. Игрок запрашивает начало квеста
      2. Quest Manager проверяет требования через Quest Condition Evaluator
      3. Если требования выполнены - создаётся инстанс квеста
      4. Quest State Machine инициализирует состояние (NOT_STARTED -> IN_PROGRESS)
      5. Dialogue Engine инициализирует диалог (если есть)
      6. Quest Event Handler публикует quest:started
      7. Notification Service уведомляет игрока
      8. Realtime Gateway синхронизирует состояние

    quest_progress: |
      1. Игровое событие происходит (убийство врага, получение предмета)
      2. Quest Event Handler получает событие
      3. Quest Condition Evaluator проверяет условия целей
      4. Если цель выполнена - обновляется прогресс
      5. Quest State Machine обновляет состояние
      6. Если все цели выполнены - квест готов к завершению
      7. Realtime Gateway синхронизирует обновления

    quest_completion: |
      1. Игрок завершает квест
      2. Quest Manager проверяет все условия
      3. Quest Reward Distributor распределяет награды
      4. Economy Service получает валюту/предметы
      5. Mail Service отправляет награды (если нужно)
      6. Quest State Machine обновляет состояние (IN_PROGRESS -> COMPLETED)
      7. Quest Event Handler публикует quest:completed
      8. Narrative Coherence System обновляет world state
      9. Realtime Gateway уведомляет игрока

  integrations:
    with_character_service: |
      - Получение данных персонажа для проверок
      - Проверка уровня, атрибутов, навыков
      - Обновление опыта и уровня

    with_economy_service: |
      - Выдача валюты за квесты
      - Выдача предметов через inventory
      - Интеграция с экономической системой

    with_social_service: |
      - Проверка репутации
      - Обновление репутации за квесты
      - Интеграция с социальными системами

    with_mail_service: |
      - Отправка наград через почту
      - Уведомления о завершении квестов

    with_narrative_coherence_system: |
      - Обновление world state при завершении квестов
      - Активация зависимых квестов
      - Интеграция с системой сюжета

    with_notification_service: |
      - Уведомления о начале квестов
      - Уведомления о прогрессе
      - Уведомления о завершении

    with_realtime_gateway: |
      - Синхронизация состояния квестов
      - Обновления прогресса в реальном времени
      - Уведомления о событиях

  database_schema:
    tables:
      - name: quest_instances
        description: Инстансы квестов игроков
        fields:
          - id: UUID (PK)
          - quest_id: UUID (FK quest_definitions)
          - player_id: UUID (FK accounts)
          - state: ENUM (NOT_STARTED, IN_PROGRESS, COMPLETED, FAILED, CANCELLED)
          - current_objective: INTEGER
          - progress_data: JSONB
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)
          - updated_at: TIMESTAMP
        indexes:
          - player_id, state
          - quest_id, player_id
          - state, started_at

      - name: quest_definitions
        description: Определения квестов
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - description: TEXT
          - type: ENUM (main, side, daily, event)
          - requirements: JSONB
          - objectives: JSONB
          - rewards: JSONB
          - dialogue_tree: JSONB
          - is_active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - type, is_active
          - is_active

      - name: dialogue_state
        description: Состояние диалогов в квестах
        fields:
          - id: UUID (PK)
          - quest_instance_id: UUID (FK quest_instances)
          - current_node_id: VARCHAR(100)
          - visited_nodes: VARCHAR(100)[]
          - choices_made: JSONB
          - skill_check_results: JSONB
          - updated_at: TIMESTAMP
        indexes:
          - quest_instance_id

      - name: skill_check_results
        description: Результаты проверок навыков
        fields:
          - id: UUID (PK)
          - quest_instance_id: UUID (FK quest_instances)
          - check_type: ENUM (attribute, skill, item, reputation)
          - check_target: VARCHAR(100)
          - required_value: INTEGER
          - actual_value: INTEGER
          - passed: BOOLEAN
          - checked_at: TIMESTAMP
        indexes:
          - quest_instance_id
          - check_type, passed

      - name: quest_objective_progress
        description: Прогресс по целям квестов
        fields:
          - id: UUID (PK)
          - quest_instance_id: UUID (FK quest_instances)
          - objective_id: VARCHAR(100)
          - current_progress: INTEGER
          - target_progress: INTEGER
          - is_completed: BOOLEAN
          - completed_at: TIMESTAMP (nullable)
        indexes:
          - quest_instance_id, is_completed
          - quest_instance_id, objective_id

technical_specification:
  backend_requirements:
    - Реализация модулей в gameplay-service-go:
      - quest (управление квестами)
      - quest-state (state machine)
      - quest-dialogue (диалоги)
      - quest-skill-checks (проверки навыков)
      - quest-conditions (условия)
      - quest-rewards (награды)
      - quest-events (события)
    - Интеграция с character-service для проверок
    - Интеграция с economy-service для наград
    - Интеграция с narrative-coherence-system
    - Оптимизация запросов к БД (индексы, кэширование)

  realtime_requirements:
    - Синхронизация состояния квестов через WebSocket
    - Обновления прогресса в реальном времени
    - Уведомления о событиях квестов

  performance_requirements:
    - Начало квеста < 100ms
    - Обновление прогресса < 50ms
    - Завершение квеста < 200ms
    - Обработка skill check < 50ms
    - Поддержка до 100 активных квестов на игрока
    - Поддержка до 10K активных квестов одновременно

  scalability_requirements:
    - Горизонтальное масштабирование через gameplay-service
    - Распределение нагрузки на квесты
    - Оптимизация запросов к БД (batch, индексы)
    - Кэширование определений квестов

subtasks:
  - id: quest-manager-module
    title: Реализация модуля Quest Manager
    description: |
      Управление квестами
      CRUD операции
      Жизненный цикл квестов
    priority: high
    estimated_time: 4-5 дней

  - id: quest-state-machine-implementation
    title: Реализация Quest State Machine
    description: |
      Управление состоянием квестов
      Переходы между состояниями
      Сохранение и восстановление состояния
    priority: high
    estimated_time: 4-5 дней

  - id: dialogue-engine-development
    title: Реализация Dialogue Engine
    description: |
      Обработка диалогов
      Ветвления диалогов
      Выборы игрока
    priority: high
    estimated_time: 4-5 дней

  - id: skill-check-processor
    title: Реализация Skill Check Processor
    description: |
      Обработка проверок навыков
      Расчёт результатов
      Интеграция с character-service
    priority: high
    estimated_time: 3-4 дня

  - id: quest-condition-evaluator
    title: Реализация Quest Condition Evaluator
    description: |
      Оценка условий квестов
      Проверка требований
      Интеграция с другими сервисами
    priority: high
    estimated_time: 3-4 дня

  - id: quest-reward-distributor
    title: Реализация Quest Reward Distributor
    description: |
      Распределение наград
      Выдача опыта, валюты, предметов
      Интеграция с economy и mail
    priority: high
    estimated_time: 3-4 дня

  - id: quest-event-handler
    title: Реализация Quest Event Handler
    description: |
      Обработка событий квестов
      Публикация событий
      Подписка на события
    priority: high
    estimated_time: 3-4 дня

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование определений квестов
    priority: medium
    estimated_time: 1-2 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для квестов
      Интеграция с существующим API gameplay-service
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты управления квестами
      Тесты state machine
      Тесты диалогов
      Тесты skill checks
      Тесты интеграций
    priority: high
    estimated_time: 3-4 дня

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Gameplay Service"
            QM[Quest Manager]
            QSM[Quest State Machine]
            DE[Dialogue Engine]
            SCP[Skill Check Processor]
            QCE[Quest Condition Evaluator]
            QRD[Quest Reward Distributor]
            QEH[Quest Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>quest_instances<br/>quest_definitions<br/>dialogue_state<br/>skill_check_results)]
        end

        subgraph "External Services"
            CS[Character Service]
            ES[Economy Service]
            SS[Social Service]
            MS[Mail Service]
            NCS[Narrative Coherence System]
            NS[Notification Service]
            RG[Realtime Gateway]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|start quest| QM
        QM --> QSM
        QM --> QCE
        QM --> DE
        QM --> SCP
        QM --> QRD
        QM --> QEH
        QM -->|store| DB
        SCP -->|check skills| CS
        QCE -->|check requirements| CS
        QCE -->|check reputation| SS
        QRD -->|distribute rewards| ES
        QRD -->|send rewards| MS
        QEH -->|update world state| NCS
        QEH -->|notify| NS
        QM -->|sync state| RG
        RG -->|push events| CL
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant P as Player
        participant QM as Quest Manager
        participant QCE as Quest Condition Evaluator
        participant QSM as Quest State Machine
        participant DE as Dialogue Engine
        participant QEH as Quest Event Handler
        participant QRD as Quest Reward Distributor

        P->>QM: Start quest
        QM->>QCE: Check requirements
        QCE->>QM: Requirements OK
        QM->>QSM: Initialize state
        QM->>DE: Initialize dialogue
        QEH->>QEH: Publish quest:started
        
        P->>DE: Make dialogue choice
        DE->>QSM: Update state
        QSM->>QEH: Publish progress
        
        P->>QM: Complete quest
        QM->>QRD: Distribute rewards
        QRD->>QRD: Send rewards
        QSM->>QSM: Update to COMPLETED
        QEH->>QEH: Publish quest:completed
    ```

decisions:
  - id: adr-quest-architecture
    summary: |
      Выбрана модульная архитектура внутри gameplay-service-go для обеспечения
      тесной интеграции с игровым процессом.

  - id: adr-state-machine
    summary: |
      State machine обеспечивает надёжное управление состоянием квестов и
      предотвращает некорректные переходы.

  - id: adr-dialogue-engine
    summary: |
      Dialogue Engine с поддержкой ветвлений обеспечивает интерактивные диалоги
      и выборы игрока, влияющие на сюжет.

  - id: adr-skill-checks
    summary: |
      Система skill checks добавляет глубину геймплея и учитывает характеристики
      персонажа при прохождении квестов.

  - id: adr-quest-integration
    summary: |
      Интеграция с Narrative Coherence System обеспечивает целостность сюжета
      и динамическую адаптацию квестов к выбору игрока.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация API endpoints
  - Создание request/response схем
  - Определение формата state machine

history:
  - version: '1.0.0'
    date: 2025-11-22
    author: Architect Agent
    changes: |
      Создана полная архитектура движка квестов:
      - Определены компоненты (Quest Manager, Quest State Machine, Dialogue Engine, Skill Check Processor, Quest Condition Evaluator, Quest Reward Distributor, Quest Event Handler)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (quest_instances, quest_definitions, dialogue_state, skill_check_results, quest_objective_progress)
      - Спроектирована система state machine для квестов
      - Спроектирована система диалогов
      - Спроектирована система skill checks
      - Создано техническое задание
      - Разбито на подзадачи


