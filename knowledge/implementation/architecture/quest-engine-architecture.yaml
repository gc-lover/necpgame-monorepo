metadata:
  id: quest-engine-architecture
  title: Архитектура движка квестов (Quest Engine)
  document_type: architecture
  category: systems
  status: draft
  version: '1.1.0'
  last_updated: 2025-11-30T19:55:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - quest
    - backend
    - gameplay
  related_systems:
    - gameplay-service-go
    - character-service-go
    - economy-service-go
    - social-service-go
    - narrative-coherence-system
  related_documents:
    - id: quest-engine-backend
      relation: extends
    - id: narrative-coherence-system-architecture
      relation: references
  github_issue: 154
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру движка квестов
    для обработки state machine, диалогов, skill checks, ветвящихся сценариев
    и интеграции с другими игровыми системами.
  goal: |
    Создать архитектурную схему движка квестов с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы state machine для квестов
    - Системы диалогов
    - Системы skill checks
    - Технического задания для реализации
  essence: |
    Игровой движок для обработки квестов с поддержкой state machine, диалогов,
    skill checks, ветвящихся сценариев и интеграции с другими системами.

architecture:
  overview: |
    Движок квестов состоит из семи основных компонентов:
    1. Quest Manager - управление квестами
    2. Quest State Machine - управление состоянием квестов
    3. Dialogue Engine - обработка диалогов
    4. Skill Check Processor - обработка проверок навыков
    5. Quest Condition Evaluator - оценка условий квестов
    6. Quest Reward Distributor - распределение наград
    7. Quest Event Handler - обработка событий квестов

  components:
    - name: Quest Manager
      location: gameplay-service-go (модуль quest)
      responsibility: |
        - Управление жизненным циклом квестов
        - Создание и инициализация квестов
        - Завершение и отмена квестов
        - Получение информации о квестах
        - Интеграция с другими модулями
      port: 8083 (gameplay-service-go)
      endpoints:
        - POST /api/v1/gameplay/quests/start - начало квеста
        - GET /api/v1/gameplay/quests/{quest_id} - информация о квесте
        - GET /api/v1/gameplay/quests/player/{player_id} - квесты игрока
        - POST /api/v1/gameplay/quests/{quest_id}/complete - завершение квеста
        - POST /api/v1/gameplay/quests/{quest_id}/cancel - отмена квеста

    - name: Quest State Machine
      location: gameplay-service-go (модуль quest-state)
      responsibility: |
        - Управление состоянием квестов
        - Переходы между состояниями
        - Обработка ветвлений
        - Сохранение состояния
        - Восстановление состояния
      quest_states: |
        - NOT_STARTED: квест не начат
        - IN_PROGRESS: квест в процессе
        - COMPLETED: квест завершён
        - FAILED: квест провален
        - CANCELLED: квест отменён
      state_transitions: |
        - NOT_STARTED -> IN_PROGRESS (при старте)
        - IN_PROGRESS -> COMPLETED (при выполнении всех целей)
        - IN_PROGRESS -> FAILED (при провале условий)
        - IN_PROGRESS -> CANCELLED (при отмене)
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/state - состояние квеста
        - POST /api/v1/gameplay/quests/{quest_id}/state/update - обновление состояния

    - name: Dialogue Engine
      location: gameplay-service-go (модуль quest-dialogue)
      responsibility: |
        - Обработка диалогов в квестах
        - Управление ветвлениями диалогов
        - Обработка выборов игрока
        - Сохранение состояния диалогов
        - Интеграция с skill checks
      dialogue_features: |
        - Ветвящиеся диалоги
        - Выборы игрока
        - Условные ответы
        - Skill checks в диалогах
        - Сохранение выбранных путей
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/dialogue - текущий диалог
        - POST /api/v1/gameplay/quests/{quest_id}/dialogue/choice - выбор в диалоге
        - GET /api/v1/gameplay/quests/{quest_id}/dialogue/history - история диалогов

    - name: Skill Check Processor
      location: gameplay-service-go (модуль quest-skill-checks)
      responsibility: |
        - Обработка проверок навыков
        - Расчёт результатов проверок
        - Интеграция с character-service
        - Обработка успешных/неуспешных проверок
      skill_check_types: |
        - Attribute check: проверка атрибутов
        - Skill check: проверка навыков
        - Item check: проверка предметов
        - Reputation check: проверка репутации
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/skill-check - выполнение проверки
        - GET /api/v1/gameplay/quests/{quest_id}/skill-checks - история проверок

    - name: Quest Condition Evaluator
      location: gameplay-service-go (модуль quest-conditions)
      responsibility: |
        - Оценка условий квестов
        - Проверка требований для старта
        - Проверка условий для завершения
        - Проверка условий для целей
        - Интеграция с другими сервисами
      condition_types: |
        - Level requirement: требование уровня
        - Item requirement: требование предмета
        - Quest prerequisite: требование предыдущего квеста
        - Reputation requirement: требование репутации
        - Location requirement: требование местоположения
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/conditions/check - проверка условий
        - GET /api/v1/gameplay/quests/{quest_id}/requirements - требования квеста

    - name: Quest Reward Distributor
      location: gameplay-service-go (модуль quest-rewards)
      responsibility: |
        - Распределение наград за квесты
        - Выдача опыта
        - Выдача валюты
        - Выдача предметов
        - Выдача репутации
        - Интеграция с economy-service и mail-service
      reward_types: |
        - Experience: опыт
        - Currency: валюта
        - Items: предметы
        - Reputation: репутация
        - Titles: титулы
      endpoints:
        - POST /api/v1/gameplay/quests/{quest_id}/rewards/distribute - распределение наград
        - GET /api/v1/gameplay/quests/{quest_id}/rewards - награды квеста

    - name: Quest Event Handler
      location: gameplay-service-go (модуль quest-events)
      responsibility: |
        - Обработка событий квестов
        - Публикация событий в event bus
        - Подписка на события от других систем
        - Обработка событий для обновления прогресса
      quest_events_published: |
        - quest:started
        - quest:objective-completed
        - quest:completed
        - quest:failed
        - quest:cancelled
      quest_events_consumed: |
        - combat:enemy-killed
        - inventory:item-added
        - social:reputation-changed
        - character:level-up
      endpoints:
        - GET /api/v1/gameplay/quests/{quest_id}/events - события квеста

  data_flow:
    quest_start: |
      1. Игрок запрашивает начало квеста
      2. Quest Manager проверяет требования через Quest Condition Evaluator
      3. Если требования выполнены - создаётся инстанс квеста
      4. Quest State Machine инициализирует состояние (NOT_STARTED -> IN_PROGRESS)
      5. Dialogue Engine инициализирует диалог (если есть)
      6. Quest Event Handler публикует quest:started
      7. Notification Service уведомляет игрока
      8. Realtime Gateway синхронизирует состояние

    quest_progress: |
      1. Игровое событие происходит (убийство врага, получение предмета)
      2. Quest Event Handler получает событие
      3. Quest Condition Evaluator проверяет условия целей
      4. Если цель выполнена - обновляется прогресс
      5. Quest State Machine обновляет состояние
      6. Если все цели выполнены - квест готов к завершению
      7. Realtime Gateway синхронизирует обновления

    quest_completion: |
      1. Игрок завершает квест
      2. Quest Manager проверяет все условия
      3. Quest Reward Distributor распределяет награды
      4. Economy Service получает валюту/предметы
      5. Mail Service отправляет награды (если нужно)
      6. Quest State Machine обновляет состояние (IN_PROGRESS -> COMPLETED)
      7. Quest Event Handler публикует quest:completed
      8. Narrative Coherence System обновляет world state
      9. Realtime Gateway уведомляет игрока

  integrations:
    with_character_service: |
      - Получение данных персонажа для проверок
      - Проверка уровня, атрибутов, навыков
      - Обновление опыта и уровня

    with_economy_service: |
      - Выдача валюты за квесты
      - Выдача предметов через inventory
      - Интеграция с экономической системой

    with_social_service: |
      - Проверка репутации
      - Обновление репутации за квесты
      - Интеграция с социальными системами

    with_mail_service: |
      - Отправка наград через почту
      - Уведомления о завершении квестов

    with_narrative_coherence_system: |
      - Обновление world state при завершении квестов
      - Активация зависимых квестов
      - Интеграция с системой сюжета

    with_notification_service: |
      - Уведомления о начале квестов
      - Уведомления о прогрессе
      - Уведомления о завершении

    with_realtime_gateway: |
      - Синхронизация состояния квестов
      - Обновления прогресса в реальном времени
      - Уведомления о событиях

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций
    mechanisms:
      - ACID транзакции для начала квеста, обновления прогресса и завершения квеста
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов
      - Валидация перед началом квеста и завершением
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (начало квеста, завершение квеста с наградами, обновление world state)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния квестов (начало квеста, обновление прогресса, завершение квеста)
      записываются как события в Event Store. Это обеспечивает полный аудит,
      возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: QuestStartedEvent, QuestObjectiveCompletedEvent, QuestCompletedEvent, QuestFailedEvent.
    cqrs_pattern: |
      Разделение команд (начало квеста, обновление прогресса, завершение квеста) и запросов
      (получение информации о квесте, получение списка квестов, получение прогресса) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как начало квеста (проверка требований, создание инстанса,
      инициализация state machine) или завершение квеста (проверка условий, распределение наград,
      обновление world state), используется Saga Pattern для обеспечения атомарности операций
      между Gameplay Service, Character Service, Economy Service и Narrative Coherence System.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    quest_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Начало квеста: event-based, ~0.1-0.3 events/sec на игрока
        - Обновление прогресса: event-based, ~0.1-0.5 events/sec на игрока
        - Завершение квеста: event-based, ~0.1-0.2 events/sec на игрока
        - Получение информации о квесте: event-based, ~0.1-0.5 requests/sec на игрока
        - Общий трафик: ~0.3-0.8 KB/sec на игрока
      latency_requirements: < 50-200ms для операций с квестами
      sync_strategy: Strong Consistency (ACID транзакции) для начала квеста, обновления прогресса и завершения

    dialogue_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Получение диалога: event-based, ~0.1-0.3 requests/sec на игрока
        - Выбор в диалоге: event-based, ~0.1-0.2 events/sec на игрока
        - Обновление состояния диалога: event-based, ~0.1-0.2 events/sec на игрока
        - Общий трафик: ~0.2-0.4 KB/sec на игрока
      latency_requirements: < 50-150ms для операций с диалогами
      sync_strategy: Strong Consistency (ACID транзакции) для выбора в диалоге

    skill_check_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Выполнение skill check: event-based, ~0.1-0.2 events/sec на игрока
        - Получение результатов: event-based, ~0.1-0.2 requests/sec на игрока
        - Общий трафик: ~0.1-0.2 KB/sec на игрока
      latency_requirements: < 50-100ms для выполнения skill check
      sync_strategy: Strong Consistency (ACID транзакции) для выполнения skill check

    realtime_updates:
      tickrate: Event-based (on-demand) + 1-5 Hz для синхронизации состояния
      network_load: |
        - Синхронизация состояния квеста: 1-5 Hz, ~0.1-0.3 KB/sec на игрока
        - Уведомления о событиях: event-based, ~0.1-0.2 events/sec на игрока
        - Общий трафик: ~0.2-0.4 KB/sec на игрока
      latency_requirements: < 30-100ms для синхронизации состояния
      sync_strategy: Eventual Consistency для синхронизации состояния

  database_schema:
    tables:
      - name: quest_instances
        description: Инстансы квестов игроков
        fields:
          - id: UUID (PK)
          - quest_id: UUID (FK quest_definitions)
          - player_id: UUID (FK accounts)
          - state: ENUM (NOT_STARTED, IN_PROGRESS, COMPLETED, FAILED, CANCELLED)
          - current_objective: INTEGER
          - progress_data: JSONB
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP (nullable)
          - updated_at: TIMESTAMP
        indexes:
          - player_id, state
          - quest_id, player_id
          - state, started_at

      - name: quest_definitions
        description: Определения квестов
        fields:
          - id: UUID (PK)
          - name: VARCHAR(255)
          - description: TEXT
          - type: ENUM (main, side, daily, event)
          - requirements: JSONB
          - objectives: JSONB
          - rewards: JSONB
          - dialogue_tree: JSONB
          - is_active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
        indexes:
          - type, is_active
          - is_active

      - name: dialogue_state
        description: Состояние диалогов в квестах
        fields:
          - id: UUID (PK)
          - quest_instance_id: UUID (FK quest_instances)
          - current_node_id: VARCHAR(100)
          - visited_nodes: VARCHAR(100)[]
          - choices_made: JSONB
          - skill_check_results: JSONB
          - updated_at: TIMESTAMP
        indexes:
          - quest_instance_id

      - name: skill_check_results
        description: Результаты проверок навыков
        fields:
          - id: UUID (PK)
          - quest_instance_id: UUID (FK quest_instances)
          - check_type: ENUM (attribute, skill, item, reputation)
          - check_target: VARCHAR(100)
          - required_value: INTEGER
          - actual_value: INTEGER
          - passed: BOOLEAN
          - checked_at: TIMESTAMP
        indexes:
          - quest_instance_id
          - check_type, passed

      - name: quest_objective_progress
        description: Прогресс по целям квестов
        fields:
          - id: UUID (PK)
