metadata:
  id: raid-dungeon-affixes-system-architecture
  title: Архитектура системы аффиксов для рейдов и подземелий
  document_type: architecture
  category: systems
  status: final
  version: "1.0.0"
  last_updated: 2025-12-28T12:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - gameplay
    - difficulty
    - affixes
    - raids
    - dungeons
    - hardcore
  related_systems:
    - gameplay-service
    - world-service
    - combat-service
    - analytics-service
    - leaderboard-service
  related_documents:
    - id: raid-dungeon-affixes-idea
      relation: implements
    - id: combat-ai-enemies-architecture
      relation: extends
  github_issue: 1495
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Текущая система сложности рейдов и подземелий ограничена базовыми слоями.
    Не хватает динамических модификаторов, которые бы меняли механики боя и повышали реиграбельность.
  goal: |
    Создать архитектуру системы аффиксов, которая:
    - Добавляет динамическую сложность через модификаторы механик
    - Повышает реиграбельность контента
    - Интегрируется с существующими системами рейдов и подземелий
    - Поддерживает еженедельную ротацию аффиксов
  essence: |
    Система аффиксов добавляет 2-4 случайных модификатора к каждому инстансу рейда или подземелья.
    Аффиксы меняют механики боя, требуют адаптации тактики и влияют на награды.
    Ротация аффиксов происходит еженедельно для поддержания свежести контента.

architecture:
  overview: |
    Система аффиксов состоит из следующих компонентов:
    1. Affix Manager - управление аффиксами и их конфигурациями
    2. Affix Rotation Controller - управление еженедельной ротацией
    3. Affix Applicator - применение аффиксов к инстансам
    4. Affix Effect Engine - обработка эффектов аффиксов в бою
    5. Affix Telemetry Collector - сбор телеметрии для балансировки

  affix_system_design:
    affix_catalog: |
      Каталог содержит 20+ базовых аффиксов, разделенных по категориям:

      Combat Affixes (боевые модификаторы):
      - Volatile: Враги периодически взрываются, нанося AoE урон
      - Raging: Враги получают бонус к урону при низком HP
      - Spiteful: Враги получают бонус к урону при смерти союзников
      - Thundering: Молнии бьют по игрокам с максимальным уроном

      Environmental Affixes (окружающая среда):
      - Storming: Периодические молнии бьют по случайным местам
      - Entangling: Лоза периодически связывает игроков корнями
      - Incorporeal: Враги становятся неуязвимыми на короткое время

      Debuff Affixes (дебаффы и состояния):
      - Afflicted: Игроки получают случайные дебаффы со временем
      - Bolstering: Смерть врага усиливает оставшихся
      - Sanguine: Враги лечатся от урона по игрокам

      Defensive Affixes (защита и выживание):
      - Fortified: Враги получают бонус к защите в определенные периоды
      - Tyrannical: Боссы имеют увеличенное HP и урон
      - Bursting: Враги взрываются при смерти

    affix_selection_algorithm: |
      Для каждого инстанса выбирается 2-4 аффикса из активного пула (8-10 аффиксов):
      1. Проверка совместимости аффиксов (некоторые комбинации запрещены)
      2. Взвешенный случайный выбор с учетом категории
      3. Масштабирование эффектов по количеству игроков и уровню

    affix_compatibility_matrix: |
      Несовместимые комбинации:
      - Raging + Fortified (противоречивые механики)
      - Volatile + Incorporeal (избыточная сложность)
      - Bursting + Sanguine (непредсказуемость)

    affix_scaling_rules: |
      Эффекты масштабируются по:
      - Количеству игроков (меньше игроков = слабее эффекты)
      - Уровню сложности инстанса
      - Типу контента (рейды сложнее подземелий)

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Обработка аффиксов:
        - Управление аффиксами и их конфигурациями
        - Применение аффиксов к инстансам
        - Обработка эффектов аффиксов в бою
        - Сбор телеметрии
      components:
        - affix-manager: управление аффиксами
        - affix-rotation-controller: управление ротацией
        - affix-applicator: применение аффиксов
        - affix-effect-engine: обработка эффектов
        - affix-telemetry-collector: сбор телеметрии
      endpoints:
        # Public endpoints
        - GET /api/v1/gameplay/affixes/active - список активных аффиксов текущей недели
        - GET /api/v1/gameplay/affixes/{id} - детальная информация об аффиксе
        - GET /api/v1/gameplay/instances/{instanceId}/affixes - аффиксы конкретного инстанса
        - GET /api/v1/gameplay/affixes/rotation/current - текущая ротация
        - GET /api/v1/gameplay/affixes/rotation/history - история ротаций

        # Admin endpoints
        - POST /api/v1/gameplay/affixes/rotation/trigger - ручной триггер ротации
        - PUT /api/v1/gameplay/affixes/{id} - обновление конфигурации аффикса
        - POST /api/v1/gameplay/affixes - создание нового аффикса
        - DELETE /api/v1/gameplay/affixes/{id} - удаление аффикса

        # Analytics endpoints
        - GET /api/v1/analytics/affixes/popularity - популярность аффиксов
        - GET /api/v1/analytics/affixes/difficulty - метрики сложности
        - GET /api/v1/analytics/affixes/combinations - анализ комбинаций
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/affixes/rotation - события ротации
      events_published:
        - gameplay.affixes.rotation.changed: смена ротации аффиксов (weekly)
        - gameplay.affixes.applied: применение аффиксов к инстансу
        - gameplay.affixes.telemetry: телеметрия использования аффиксов
        - gameplay.affixes.effect.triggered: срабатывание эффекта аффикса
        - gameplay.affixes.instance.completed: завершение инстанса с аффиксами

      events_consumed:
        - world.season.started: начало нового сезона
        - world.season.ended: окончание сезона
        - gameplay.instance.created: создание инстанса
        - gameplay.instance.completed: завершение инстанса
        - combat.damage.dealt: урон для Sanguine аффикса
        - combat.enemy.died: смерть врага для различных аффиксов

  data_flows:
    affix_application_flow: |
      1. Игрок создает инстанс рейда/подземелья
      2. Affix Applicator запрашивает активные аффиксы через Affix Manager
      3. Affix Applicator выбирает 2-4 случайных аффикса из активных
      4. Affix Applicator проверяет совместимость аффиксов
      5. Affix Applicator применяет аффиксы к инстансу
      6. Affix Effect Engine инициализирует эффекты аффиксов
      7. Gameplay Service публикует событие gameplay.affixes.applied
      8. Realtime Gateway отправляет информацию об аффиксах клиентам

    affix_rotation_flow: |
      1. Еженедельно (понедельник 00:00 UTC) запускается Affix Rotation Controller
      2. Affix Rotation Controller выбирает новый набор активных аффиксов (8-10 из пула)
      3. Affix Rotation Controller проверяет сезонные аффиксы
      4. Affix Rotation Controller сохраняет новую ротацию в БД
      5. Affix Rotation Controller публикует событие gameplay.affixes.rotation.changed
      6. Realtime Gateway отправляет уведомление всем игрокам
      7. Analytics Service логирует смену ротации

    affix_effect_flow: |
      1. В бою Affix Effect Engine отслеживает триггеры аффиксов
      2. При срабатывании триггера Affix Effect Engine применяет эффект
      3. Combat Service обрабатывает модификаторы (урон, HP, способности)
      4. Affix Effect Engine обновляет визуальные эффекты
      5. Realtime Gateway синхронизирует эффекты с клиентами
      6. Affix Telemetry Collector записывает использование аффикса

  database_structure:
    tables:
      - name: affixes
        description: Каталог аффиксов
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - category: ENUM (combat, environmental, debuff, defensive)
          - description: TEXT
          - mechanics: JSONB
          - visual_effects: JSONB
          - reward_modifier: DECIMAL(5,2)
          - difficulty_modifier: DECIMAL(5,2)
          - created_at: TIMESTAMP

      - name: affix_rotations
        description: Ротации аффиксов
        columns:
          - id: UUID PRIMARY KEY
          - week_start: TIMESTAMP
          - week_end: TIMESTAMP
          - active_affixes: JSONB
          - seasonal_affix_id: UUID (nullable)
          - created_at: TIMESTAMP

      - name: instance_affixes
        description: Аффиксы инстансов
        columns:
          - id: UUID PRIMARY KEY
          - instance_id: UUID FOREIGN KEY
          - affix_id: UUID FOREIGN KEY
          - applied_at: TIMESTAMP

      - name: affix_telemetry
        description: Телеметрия аффиксов
        columns:
          - id: UUID PRIMARY KEY
          - instance_id: UUID FOREIGN KEY
          - affix_id: UUID FOREIGN KEY
          - completion_time: INTEGER
          - success: BOOLEAN
          - player_count: INTEGER
          - deaths_count: INTEGER
          - timestamp: TIMESTAMP

  integrations:
    combat_service: |
      - Применение боевых модификаторов (HP, урон, способности)
      - Обработка механик аффиксов в бою
      - Синхронизация с combat session

    world_service: |
      - Хранение конфигураций аффиксов
      - Ротация аффиксов
      - Интеграция с событиями мира

    analytics_service: |
      - Отслеживание успешности комбинаций аффиксов
      - Метрики сложности и наград
      - Балансировка аффиксов

    leaderboard_service: |
      - Рейтинги по сложности аффиксов
      - Сезонные лидерборды
      - Достижения за прохождение с аффиксами

  performance_requirements:
    latency_targets: |
      - Применение аффиксов к инстансу: <50ms
      - Обработка эффектов аффиксов: <10ms per tick
      - API endpoints: <100ms P95
      - WebSocket events: <50ms delivery

    throughput_requirements: |
      - 1000 одновременных инстансов с аффиксами
      - 10000 аффикс эффектов в секунду
      - 100000 телеметрия событий в минуту

    memory_usage: |
      - Affix конфигурации: <10MB total
      - Per-instance аффиксы: <1KB per instance
      - Telemetry buffer: <100MB rolling window

  security_considerations:
    validation: |
      - Валидация аффиксов на сервере (не доверять клиенту)
      - Проверка совместимости комбинаций
      - Защита от аффикс манипуляции

    audit_trail: |
      - Логирование всех изменений аффиксов
      - Трекинг применения аффиксов к инстансам
      - Аудит телеметрии данных

  monitoring_and_observability:
    metrics_collected: |
      - Популярность аффиксов (количество использований)
      - Успешность прохождения по аффиксам
      - Среднее время прохождения с аффиксами
      - Количество жалоб на конкретные аффиксы
      - Производительность системы аффиксов

    alerts_configured: |
      - Высокая нагрузка на Affix Effect Engine
      - Низкая успешность прохождения определенных аффиксов
      - Ошибки применения аффиксов
      - Проблемы с ротацией аффиксов

  technical_tasks:
    phases:
      phase_1:
        name: Affix Manager и Rotation Controller
        tasks:
          - Реализация Affix Manager с CRUD операциями
          - Реализация Affix Rotation Controller с weekly scheduler
          - Создание каталога аффиксов с JSON конфигурациями
          - Еженедельная ротация через cron job
          - Интеграция с World Service для сезонных аффиксов
          - Unit тесты для manager и controller
        estimated_effort: 4 days
        deliverables:
          - AffixManager interface и implementation
          - AffixRotationController с scheduling
          - Database migrations для affix tables
          - API endpoints для управления аффиксами

      phase_2:
        name: Affix Applicator и Effect Engine
        tasks:
          - Реализация Affix Applicator с selection algorithm
          - Реализация Affix Effect Engine с trigger system
          - Интеграция с Combat Service для damage/healing modifiers
          - WebSocket синхронизация эффектов аффиксов
          - Система совместимости аффиксов
          - Performance optimization для hot paths
        estimated_effort: 5 days
        deliverables:
          - AffixApplicator с weighted random selection
          - AffixEffectEngine с event-driven triggers
          - Integration tests с Combat Service
          - Performance benchmarks

      phase_3:
        name: Telemetry и балансировка
        tasks:
          - Реализация Affix Telemetry Collector с async processing
          - Создание dashboard для анализа аффиксов
          - A/B testing framework для новых аффиксов
          - Balance adjustment pipeline на основе телеметрии
          - Интеграция с Analytics Service
          - Documentation и troubleshooting guides
        estimated_effort: 3 days
        deliverables:
          - Telemetry collector с Kafka integration
          - Analytics dashboard для game designers
          - Automated balance suggestions
          - Comprehensive testing suite

  migration_strategy:
    database_migration: |
      - Создание таблиц affixes, affix_rotations, instance_affixes, affix_telemetry
      - Миграция существующих инстансов без аффиксов
      - Backfill исторических данных ротаций

    api_migration: |
      - Добавление новых endpoints без breaking changes
      - Feature flags для постепенного rollout
      - Backward compatibility для клиентов без аффиксов

    content_migration: |
      - Обновление существующих рейдов и подземелий
      - Добавление аффиксов к новым инстансам
      - UI updates для отображения аффиксов

  testing_strategy:
    unit_tests: |
      - Affix selection algorithm tests
      - Effect engine trigger tests
      - Rotation controller tests
      - Compatibility matrix tests

    integration_tests: |
      - End-to-end инстанс creation с аффиксами
      - Combat integration с аффикс эффектами
      - Telemetry pipeline validation

    load_tests: |
      - 1000 concurrent инстансов с аффиксами
      - Peak load simulation (10k аффикс эффектов/sec)
      - Memory leak detection

  rollback_plan:
    immediate_rollback: |
      - Feature flag отключения аффиксов
      - Возврат к оригинальной логике инстансов
      - Очистка аффикс данных из БД

    gradual_degradation: |
      - Отключение сложных аффиксов
      - Fallback на базовые аффиксы
      - Graceful handling аффикс failures

