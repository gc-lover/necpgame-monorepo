# Issue: #390
metadata:
  id: realtime-gateway-system-architecture
  title: Архитектура Realtime Gateway System
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-30T20:50:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - realtime
    - infrastructure
    - networking
  related_systems:
    - realtime-gateway-service
    - world-service
    - gameplay-service
    - social-service
  related_documents:
    - id: backend-realtime-server-overview
      relation: references
    - id: backend-realtime-server-part1-architecture-zones
      relation: references
    - id: backend-realtime-server-part2-protocol-optimization
      relation: references
    - id: backend-realtime-server-part3-performance-profiles
      relation: references
  github_issue: 390
  visibility: internal
  audience:
    - architect
    - backend
    - infrastructure
    - networking
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру Realtime Gateway System
    для обеспечения realtime коммуникации через WebSocket, синхронизации состояния игры
    и push-уведомлений с поддержкой зон, оптимизации протокола и профилей производительности.
  goal: |
    Создать архитектурную схему Realtime Gateway System с определением:
    - Компонентов системы (микросервисы, модули)
    - API endpoints (высокоуровнево)
    - Потоков данных и интеграций
    - Системы зон (zones)
    - Оптимизации протокола
    - Профилей производительности
    - Технического задания для реализации
  essence: |
    Полная архитектура Realtime Gateway System с поддержкой WebSocket коммуникации,
    синхронизации состояния игры, управления зонами, оптимизации протокола и профилей производительности.

architecture:
  overview: |
    Архитектура Realtime Gateway System состоит из следующих компонентов:
    1. Realtime Gateway Manager - управление системой realtime коммуникации
    2. Zone Manager - управление зонами и распределение нагрузки
    3. Connection Manager - управление WebSocket соединениями
    4. Message Router - маршрутизация сообщений по топикам
    5. State Synchronizer - синхронизация состояния игры
    6. Protocol Optimizer - оптимизация протокола и компрессия
    7. Performance Profile Manager - управление профилями производительности
    8. Interest Manager - управление областью интереса (interest management)
    9. Realtime Analytics Collector - сбор аналитики
    10. Realtime Telemetry Collector - сбор телеметрии

  microservices:
    - name: realtime-gateway-service
      port: 8086
      responsibility: |
        Обработка realtime коммуникации:
        - Управление системой realtime коммуникации
        - Управление зонами и распределение нагрузки
        - Управление WebSocket соединениями
        - Маршрутизация сообщений по топикам
        - Синхронизация состояния игры
        - Оптимизация протокола и компрессия
        - Управление профилями производительности
        - Управление областью интереса
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - realtime-gateway-manager: управление системой realtime коммуникации
        - zone-manager: управление зонами и распределение нагрузки
        - connection-manager: управление WebSocket соединениями
        - message-router: маршрутизация сообщений по топикам
        - state-synchronizer: синхронизация состояния игры
        - protocol-optimizer: оптимизация протокола и компрессия
        - performance-profile-manager: управление профилями производительности
        - interest-manager: управление областью интереса
        - realtime-analytics-collector: сбор аналитики
        - realtime-telemetry-collector: сбор телеметрии
      endpoints:
        - WS /ws/game - основной WebSocket endpoint для игровых событий
        - WS /ws/zone/{zoneId}/players - WebSocket для обновлений игроков в зоне
        - WS /ws/character/{characterId}/combat - WebSocket для боевых событий персонажа
        - WS /ws/zone/{zoneId}/chat - WebSocket для чата в зоне
        - WS /ws/world/events - WebSocket для мировых событий
        - GET /api/v1/realtime/zones - список зон
        - GET /api/v1/realtime/zones/{zoneId} - информация о зоне
        - GET /api/v1/realtime/connections - статистика соединений
        - GET /api/v1/realtime/performance - метрики производительности
      websocket_channels:
        - wss://api.necp.game/ws/game - основной канал для игровых событий
        - wss://api.necp.game/ws/zone/{zoneId}/players - обновления игроков в зоне
        - wss://api.necp.game/ws/character/{characterId}/combat - боевые события персонажа
        - wss://api.necp.game/ws/zone/{zoneId}/chat - чат в зоне
        - wss://api.necp.game/ws/world/events - мировые события
      events_published:
        - realtime.connection.opened: открыто соединение
        - realtime.connection.closed: закрыто соединение
        - realtime.zone.joined: присоединение к зоне
        - realtime.zone.left: выход из зоны
        - realtime.state.synchronized: синхронизировано состояние
        - realtime.message.routed: маршрутизировано сообщение
      events_subscribed:
        - character.position-updated: обновлена позиция персонажа
        - combat.action-performed: выполнено боевое действие
        - chat.message-sent: отправлено сообщение в чат
        - world.event-occurred: произошло мировое событие

  zones:
    structure: |
      Зоны описываются в базе данных (таблица zones), включают координаты, лимиты игроков и статусы.
      Каждый game server instance обслуживает 1-5 зон с независимым game loop.
    interest_management: |
      Interest management реализован через ячейки 100x100 м. Игрок видит свою ячейку и 8 соседних ячеек.
      Это минимизирует трафик, отправляя обновления только для видимых игроков.
    zone_types:
      - name: open_world
        description: "Открытый мир - большие зоны с множеством игроков"
        max_players: 500
        tick_rate: 20 Hz
        interest_cell_size: 100

      - name: combat_zone
        description: "Боевая зона - зоны для PvP и PvE боев"
        max_players: 50
        tick_rate: 60 Hz
        interest_cell_size: 50

      - name: raid_zone
        description: "Рейдовая зона - зоны для рейдов"
        max_players: 24
        tick_rate: 30 Hz
        interest_cell_size: 75

      - name: social_zone
        description: "Социальная зона - зоны для общения"
        max_players: 200
        tick_rate: 10 Hz
        interest_cell_size: 150

  protocol_optimization:
    transport: |
      WebSocket (TCP) выбран для универсальной совместимости и надёжной доставки.
      MessagePack используется для сериализации сообщений.
    lag_compensation: |
      Client prediction немедленно применяет вход, хранит очередь pendingInputs и повторно применяет их после ответа сервера.
      На сервере выполняется reconciliation и античит проверки скорости.
      Для боёв реализован rewind positions с проверкой попаданий.
    bandwidth_optimization: |
      Delta-компрессия сохраняет последнее состояние и отправляет только изменения.
      Вводится приоритезация обновлений по близости, боевому статусу и принадлежности к party.
      Ограничение — максимум 50 обновлений за тик.

  performance_profiles:
    - name: esports
      description: "Esports профиль - высокий тикрейт для соревнований"
      tick_rate: 128 Hz
      snapshot_interval: 8 ms
      input_buffer: 3 frames
      max_players: 10
      ai_budget: 5 ms

    - name: siege
      description: "Siege профиль - средний тикрейт для осад"
      tick_rate: 60 Hz
      snapshot_interval: 16 ms
      input_buffer: 2 frames
      max_players: 50
      ai_budget: 10 ms

    - name: extraction
      description: "Extraction профиль - средний тикрейт для экстракций"
      tick_rate: 60 Hz
      snapshot_interval: 16 ms
      input_buffer: 2 frames
      max_players: 20
      ai_budget: 8 ms

    - name: open_world
      description: "Open World профиль - низкий тикрейт для открытого мира"
      tick_rate: 20 Hz
      snapshot_interval: 50 ms
      input_buffer: 1 frame
      max_players: 500
      ai_budget: 20 ms

    - name: raids
      description: "Raids профиль - средний тикрейт для рейдов"
      tick_rate: 30 Hz
      snapshot_interval: 33 ms
      input_buffer: 1 frame
      max_players: 24
      ai_budget: 15 ms

    - name: massive_warfront
      description: "Massive Warfront профиль - низкий тикрейт для массовых битв"
      tick_rate: 20 Hz
      snapshot_interval: 50 ms
      input_buffer: 1 frame
      max_players: 2000
      ai_budget: 30 ms

    - name: casual
      description: "Casual профиль - низкий тикрейт для казуального контента"
      tick_rate: 10 Hz
      snapshot_interval: 100 ms
      input_buffer: 1 frame
      max_players: 100
      ai_budget: 10 ms

    - name: social
      description: "Social профиль - очень низкий тикрейт для социальных зон"
      tick_rate: 5 Hz
      snapshot_interval: 200 ms
      input_buffer: 1 frame
      max_players: 200
      ai_budget: 5 ms

  data_consistency:
    strategy: Eventual Consistency для realtime синхронизации, Strong Consistency для критичных операций (подключение, отключение)
    mechanisms:
      - Eventual Consistency для синхронизации состояния игры (позиции, боевые события)
      - Strong Consistency (ACID транзакции) для подключения/отключения игроков
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении состояния
      - Валидация перед маршрутизацией сообщений
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (подключение к зоне, синхронизация состояния)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния realtime (подключение, отключение, присоединение к зоне, синхронизация состояния)
      записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: ConnectionOpenedEvent, ConnectionClosedEvent, ZoneJoinedEvent, StateSynchronizedEvent.
    cqrs_pattern: |
      Разделение команд (подключение, отключение, присоединение к зоне, отправка сообщений) и запросов
      (получение списка зон, получение информации о зоне, получение статистики соединений) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как подключение к зоне (подключение, присоединение к зоне,
      синхронизация состояния, уведомление других игроков) или синхронизация состояния (получение состояния,
      применение изменений, отправка обновлений клиентам), используется Saga Pattern
      для обеспечения атомарности операций между Realtime Gateway Service, World Service, Gameplay Service и Social Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    connection_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Подключение: event-based, ~0.1-1 events/sec
        - Отключение: event-based, ~0.1-1 events/sec
        - Получение статистики соединений: event-based, ~0.001-0.01 requests/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций соединений
      latency_requirements: < 100-200ms для подключения, < 50-100ms для отключения
      sync_strategy: Strong Consistency (ACID транзакции) для подключения/отключения

    zone_operations:
      tickrate: Event-based (on-demand при присоединении/выходе) + 1-5 Hz для обновления зон
      network_load: |
        - Присоединение к зоне: event-based, ~0.01-0.1 events/sec на игрока
        - Выход из зоны: event-based, ~0.01-0.05 events/sec на игрока
        - Получение списка зон: event-based, ~0.001-0.01 requests/sec на игрока
        - Обновление зон: 1-5 Hz, ~0.01-0.05 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций зон
      latency_requirements: < 200-300ms для присоединения к зоне, < 100-200ms для выхода
      sync_strategy: Strong Consistency (ACID транзакции) для присоединения/выхода из зон

    state_synchronization_operations:
      tickrate: 5-128 Hz (зависит от профиля производительности)
      network_load: |
        - Синхронизация состояния: 5-128 Hz, ~0.5-10 KB/sec на игрока (зависит от профиля)
        - Обновления позиций: 20-60 Hz, ~0.2-2 KB/sec на игрока
        - Боевые события: 60-128 Hz, ~0.5-5 KB/sec на игрока
        - Общий трафик: ~1-20 KB/sec на игрока для синхронизации состояния
      latency_requirements: < 16-200ms для синхронизации состояния (зависит от профиля)
      sync_strategy: Eventual Consistency для синхронизации состояния (delta-компрессия, приоритизация)

    message_routing_operations:
      tickrate: Event-based (on-demand при отправке сообщений) + 1-10 Hz для обработки очереди
      network_load: |
        - Маршрутизация сообщений: event-based, ~0.1-10 events/sec на игрока
        - Обработка очереди: 1-10 Hz, ~0.1-1 events/sec
        - Общий трафик: ~0.2-2 KB/sec для операций маршрутизации
      latency_requirements: < 10-50ms для маршрутизации сообщений
      sync_strategy: Eventual Consistency для маршрутизации сообщений (батчинг, приоритизация)

    interest_management_operations:
      tickrate: 1-5 Hz для обновления области интереса
      network_load: |
        - Обновление области интереса: 1-5 Hz, ~0.01-0.1 events/sec на игрока
        - Получение игроков в области интереса: 1-5 Hz, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec для операций interest management
      latency_requirements: < 50-200ms для обновления области интереса
      sync_strategy: Eventual Consistency для interest management (кэширование результатов)

    protocol_optimization_operations:
      tickrate: Event-based (on-demand при применении оптимизаций) + 1-10 Hz для мониторинга
      network_load: |
        - Применение оптимизаций: event-based, ~0.01-0.1 events/sec
        - Мониторинг производительности: 1-10 Hz, ~0.01-0.05 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций оптимизации протокола
      latency_requirements: < 10-50ms для применения оптимизаций
      sync_strategy: Eventual Consistency для оптимизации протокола (кэширование настроек)

    performance_profile_operations:
      tickrate: Event-based (on-demand при переключении профиля) + 1-5 Hz для мониторинга
      network_load: |
        - Переключение профиля: event-based, ~0.001-0.01 events/sec
        - Мониторинг производительности: 1-5 Hz, ~0.01-0.05 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций профилей производительности
      latency_requirements: < 100-300ms для переключения профиля
      sync_strategy: Strong Consistency (ACID транзакции) для переключения профилей

    stats_operations:
      tickrate: Event-based (on-demand при запросе) + 1-5 Hz для обновления статистики
      network_load: |
        - Получение статистики: event-based, ~0.001-0.01 requests/sec
        - Обновление статистики: 1-5 Hz, ~0.01-0.05 events/sec
        - Общий трафик: ~0.1-0.3 KB/sec для операций статистики
      latency_requirements: < 30-100ms для получения статистики, < 50-100ms для обновления
      sync_strategy: Eventual Consistency для статистики (кэширование в Redis)

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий realtime: event-based, ~0.5-5 events/sec
        - Подписка на события: event-based, ~0.2-2 events/sec
        - Общий трафик: ~0.5-2 KB/sec для событий
      latency_requirements: < 50-200ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  scalability_requirements:
    horizontal_scaling: |
      Realtime Gateway Service может масштабироваться горизонтально через пул game server instances.
      Каждый instance обслуживает 1-5 зон с независимым game loop.
    load_balancing: |
      Нагрузка распределяется через API Gateway с использованием sticky sessions для WebSocket соединений.
    auto_scaling: |
      Автоматическое масштабирование на основе метрик нагрузки (количество соединений, использование CPU/RAM).
    warm_pools: |
      Поддержка warm pools для быстрого масштабирования при пиковых нагрузках.

  data_flows:
    connection_flow: |
      1. Клиент устанавливает WebSocket соединение через API Gateway
      2. Connection Manager валидирует соединение и аутентифицирует игрока
      3. Connection Manager регистрирует соединение в БД
      4. Zone Manager определяет зону для игрока
      5. Interest Manager вычисляет область интереса
      6. Realtime Gateway Manager публикует событие realtime.connection.opened
      7. Realtime Gateway отправляет обновление клиенту

    zone_join_flow: |
      1. Игрок запрашивает присоединение к зоне
      2. Zone Manager проверяет доступность зоны
      3. Zone Manager проверяет лимиты игроков
      4. Interest Manager вычисляет область интереса
      5. State Synchronizer загружает начальное состояние
      6. Realtime Gateway Manager публикует событие realtime.zone.joined
      7. Message Router подписывает игрока на топики зоны
      8. Realtime Gateway отправляет обновление клиенту

    state_sync_flow: |
      1. Игрок отправляет обновление состояния через WebSocket
      2. Protocol Optimizer применяет дельта-компрессию
      3. State Synchronizer валидирует обновление
      4. State Synchronizer применяет изменения к состоянию
      5. Interest Manager определяет игроков в области интереса
      6. Message Router маршрутизирует обновления клиентам
      7. Realtime Gateway Manager публикует событие realtime.state.synchronized
      8. Realtime Gateway отправляет обновления клиентам

  integrations:
    world_service: |
      - Получение информации о зонах
      - Синхронизация позиций персонажей
      - Обновления мировых событий

    gameplay_service: |
      - Обработка боевых событий
      - Синхронизация боевого состояния
      - Валидация боевых действий

    social_service: |
      - Обработка сообщений чата
      - Синхронизация социальных событий
      - Уведомления о социальных взаимодействиях

    character_service: |
      - Получение информации о персонажах
      - Синхронизация характеристик персонажей
      - Обновления прогресса персонажей

    analytics_service: |
      - Логирование всех операций realtime
      - Сбор метрик производительности
      - Анализ паттернов использования
      - Мониторинг производительности

    event_bus: |
      - Публикация событий realtime
      - Подписка на события других сервисов
      - Синхронизация состояния через события

  database_structure:
    tables:
      - name: realtime_connections
        description: WebSocket соединения
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - zone_id: UUID FOREIGN KEY
          - connection_state: ENUM (connecting, connected, disconnecting, disconnected)
          - last_heartbeat: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
          - disconnected_at: TIMESTAMP

      - name: realtime_zones
        description: Зоны realtime
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - type: ENUM (open_world, combat_zone, raid_zone, social_zone)
          - max_players: INTEGER
          - current_players: INTEGER
          - tick_rate: INTEGER
          - interest_cell_size: INTEGER
          - performance_profile: VARCHAR(50)
          - is_active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: realtime_zone_participants
        description: Участники зон
        columns:
          - id: UUID PRIMARY KEY
          - zone_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - connection_id: UUID FOREIGN KEY
          - interest_cell_x: INTEGER
          - interest_cell_y: INTEGER
          - joined_at: TIMESTAMP
          - left_at: TIMESTAMP

      - name: realtime_telemetry
        description: Телеметрия realtime
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - connection_id: UUID FOREIGN KEY
          - zone_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

technical_specification:
  subtasks:
    - id: realtime-gateway-manager
      title: Реализация менеджера realtime коммуникации
      description: |
        Реализация Realtime Gateway Manager с управлением системой realtime коммуникации
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 5 days

    - id: zone-manager
      title: Реализация менеджера зон
      description: |
        Реализация Zone Manager с управлением зонами и распределением нагрузки.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 5 days

    - id: connection-manager
      title: Реализация менеджера соединений
      description: |
        Реализация Connection Manager с управлением WebSocket соединениями.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 4 days

    - id: message-router
      title: Реализация маршрутизатора сообщений
      description: |
        Реализация Message Router с маршрутизацией сообщений по топикам.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 4 days

    - id: state-synchronizer
      title: Реализация синхронизатора состояния
      description: |
        Реализация State Synchronizer с синхронизацией состояния игры.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 5 days

    - id: protocol-optimizer
      title: Реализация оптимизатора протокола
      description: |
        Реализация Protocol Optimizer с оптимизацией протокола и компрессией.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 4 days

    - id: performance-profile-manager
      title: Реализация менеджера профилей производительности
      description: |
        Реализация Performance Profile Manager с управлением профилями производительности.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 3 days

    - id: interest-manager
      title: Реализация менеджера области интереса
      description: |
        Реализация Interest Manager с управлением областью интереса (interest management).
      dependencies: [realtime-gateway-manager]
      estimated_effort: 4 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime коммуникации.
      dependencies: [connection-manager, message-router]
      estimated_effort: 5 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов Realtime Gateway System.
      dependencies: [realtime-gateway-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для соединений, зон, участников и телеметрии
        с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> RealtimeGatewayService[Realtime Gateway Service<br/>8086]
        
        RealtimeGatewayService --> RGM[Realtime Gateway Manager]
        RealtimeGatewayService --> ZM[Zone Manager]
        RealtimeGatewayService --> CM[Connection Manager]
        RealtimeGatewayService --> MR[Message Router]
        RealtimeGatewayService --> SS[State Synchronizer]
        RealtimeGatewayService --> PO[Protocol Optimizer]
        RealtimeGatewayService --> PPM[Performance Profile Manager]
        RealtimeGatewayService --> IM[Interest Manager]
        RealtimeGatewayService --> RAC[Realtime Analytics Collector]
        RealtimeGatewayService --> RTC[Realtime Telemetry Collector]
        
        RGM --> ZM
        RGM --> CM
        RGM --> MR
        RGM --> SS
        RGM --> PO
        RGM --> PPM
        RGM --> IM
        
        RealtimeGatewayService --> WorldService[World Service]
        RealtimeGatewayService --> GameplayService[Gameplay Service]
        RealtimeGatewayService --> SocialService[Social Service]
        RealtimeGatewayService --> CharacterService[Character Service]
        RealtimeGatewayService --> AnalyticsService[Analytics Service]
        
        RealtimeGatewayService --> EventBus[Event Bus<br/>Kafka]
        
        RealtimeGatewayService --> DB[(Realtime Gateway DB)]
        RealtimeGatewayService --> Redis[(Redis Cache)]
        
        Client --> WSGame[WebSocket<br/>/ws/game]
        WSGame --> RealtimeGatewayService
    ```

  connection_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Client as UE5 Client
        participant Gateway as API Gateway
        participant CM as Connection Manager
        participant ZM as Zone Manager
        participant IM as Interest Manager
        participant RGM as Realtime Gateway Manager
        
        Client->>Gateway: WebSocket connection
        Gateway->>CM: Validate connection
        CM->>CM: Authenticate player
        CM->>CM: Register connection
        CM->>ZM: Determine zone
        ZM->>IM: Calculate interest area
        CM->>RGM: Publish connection.opened
        RGM->>Client: Send connection confirmation
    ```

  state_sync_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Client as UE5 Client
        participant PO as Protocol Optimizer
        participant SS as State Synchronizer
        participant IM as Interest Manager
        participant MR as Message Router
        participant RGM as Realtime Gateway Manager
        
        Client->>PO: Send state update
        PO->>PO: Apply delta compression
        PO->>SS: Validate update
        SS->>SS: Apply changes
        SS->>IM: Get players in interest area
        IM->>MR: Route updates to clients
        SS->>RGM: Publish state.synchronized
        MR->>Client: Send state updates
    ```

history:
  - version: '1.0.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Создана полная архитектура Realtime Gateway System:
      - Определены компоненты (Realtime Gateway Manager, Zone Manager, Connection Manager, Message Router, State Synchronizer, Protocol Optimizer, Performance Profile Manager, Interest Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (realtime_connections, realtime_zones, realtime_zone_participants, realtime_telemetry)
      - Спроектирована система зон (zones)
      - Спроектирована оптимизация протокола
      - Спроектированы профили производительности
      - Добавлена детальная синхронизация данных (Event Sourcing, CQRS, Saga Pattern, Outbox Pattern)
      - Добавлена спецификация тикрейта для всех операций
      - Создано техническое задание
      - Разбито на подзадачи

