scalability_requirements:
  - Горизонтальное масштабирование через пул инстансов
  - Автоскейлинг на основе нагрузки
  - Распределение зон по инстансам
  - Edge-ноды для снижения задержки
  - Live-migration зон между инстансами

subtasks:
  - id: websocket-connection-manager-module
    title: Реализация модуля WebSocket Connection Manager
    description: |
      Управление WebSocket соединениями
      Обработка подключений и отключений
      Маршрутизация сообщений
    priority: high
    estimated_time: 5-6 дней

  - id: zone-manager
    title: Реализация Zone Manager
    description: |
      Управление зонами
      Распределение зон по инстансам
      Управление лимитами игроков
    priority: high
    estimated_time: 4-5 дней

  - id: game-loop-manager
    title: Реализация Game Loop Manager
    description: |
      Управление игровым циклом
      Обработка инпута
      Обновление состояния
    priority: high
    estimated_time: 5-6 дней

  - id: interest-management-engine
    title: Реализация Interest Management Engine
    description: |
      Управление областью интереса
      Разделение зон на ячейки
      Определение видимых игроков
    priority: high
    estimated_time: 4-5 дней

  - id: state-synchronization-manager
    title: Реализация State Synchronization Manager
    description: |
      Синхронизация состояния игрока
      Адаптивная частота обновлений
      Client prediction и reconciliation
    priority: high
    estimated_time: 6-7 дней

  - id: protocol-optimization-engine
    title: Реализация Protocol Optimization Engine
    description: |
      Оптимизация протокола
      Сериализация (MessagePack)
      Bandwidth optimization
    priority: high
    estimated_time: 5-6 дней

  - id: performance-profile-manager
    title: Реализация Performance Profile Manager
    description: |
      Управление профилями производительности
      Конфигурация для различных типов контента
      Автоскейлинг
    priority: high
    estimated_time: 4-5 дней

  - id: realtime-event-handler
    title: Реализация Realtime Event Handler
    description: |
      Обработка realtime событий
      Публикация событий в event bus
      Маршрутизация событий клиентам
    priority: high
    estimated_time: 4-5 дней

  - id: database-optimization
    title: Оптимизация БД и запросов
    description: |
      Создание индексов
      Оптимизация запросов
      Кэширование состояния зон
    priority: medium
    estimated_time: 2-3 дня

  - id: api-endpoints
    title: Реализация REST API endpoints
    description: |
      Создание всех endpoints для realtime server
      Интеграция с существующим API realtime-gateway
    priority: high
    estimated_time: 3-4 дня

  - id: integration-testing
    title: Интеграционное тестирование
    description: |
      Тесты WebSocket соединений
      Тесты синхронизации состояния
      Тесты зон и interest management
      Тесты производительности
      Тесты интеграций
    priority: high
    estimated_time: 6-7 дней

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        subgraph "Realtime Gateway"
            WCM[WebSocket Connection Manager]
            ZM[Zone Manager]
            GLM[Game Loop Manager]
            IME[Interest Management Engine]
            SSM[State Synchronization Manager]
            POE[Protocol Optimization Engine]
            PPM[Performance Profile Manager]
            REH[Realtime Event Handler]
        end

        subgraph "Database"
            DB[(PostgreSQL<br/>zones<br/>zone_cells<br/>game_instances<br/>player_connections<br/>realtime_events)]
        end

        subgraph "External Services"
            WS[World Service]
            GS[Gameplay Service]
            SS[Social Service]
            CS[Character Service]
            NS[Notification Service]
            OBS[Observability]
        end

        subgraph "Client"
            CL[UE5 Client]
        end

        CL -->|WebSocket| WCM
        WCM --> ZM
        ZM --> GLM
        GLM --> IME
        IME --> SSM
        SSM --> POE
        POE -->|push updates| CL
        REH --> WS
        REH --> GS
        REH --> SS
    ```

  data_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Client
        participant WCM as WebSocket Connection Manager
        participant GLM as Game Loop Manager
        participant SSM as State Synchronization Manager

        C->>WCM: Connect WebSocket
        WCM->>GLM: Register client
        C->>WCM: Send input
        WCM->>GLM: Process input
        GLM->>SSM: Update state
        SSM->>C: Push updates
    ```

decisions:
  - id: adr-realtime-server-architecture
    summary: |
      Выбрана модульная архитектура внутри realtime-gateway-go для обеспечения
      централизованного управления realtime коммуникацией.

  - id: adr-websocket-protocol
    summary: |
      Использован WebSocket (TCP) вместо UDP для универсальной совместимости
      с браузерами и надёжной доставки сообщений.

  - id: adr-interest-management
    summary: |
      Система interest management с ячейками 100x100 м минимизирует трафик
      и обеспечивает эффективную синхронизацию состояния.

  - id: adr-adaptive-sync
    summary: |
      Адаптивная частота обновлений (combat 60 Hz, movement 20 Hz, idle 5 Hz)
      оптимизирует производительность и bandwidth.

  - id: adr-performance-profiles
    summary: |
      Профили производительности для различных типов контента обеспечивают
      оптимальную конфигурацию для каждого режима игры.

validation:
  architecture_complete: true
  components_defined: true
  microservices_identified: true
  api_endpoints_described: true
  technical_specification_ready: true
  subtasks_defined: true

next_steps:
  - Передача задачи агенту API Designer для создания OpenAPI спецификации
  - Детализация WebSocket протокола
  - Создание схем сообщений
  - Определение формата данных зон и соединений

history:
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура Realtime Server:
      - Определены компоненты (WebSocket Connection Manager, Zone Manager, Game Loop Manager, Interest Management Engine, State Synchronization Manager, Protocol Optimization Engine, Performance Profile Manager, Realtime Event Handler)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (zones, zone_cells, game_instances, player_connections, realtime_events)
      - Спроектирована система зон
      - Спроектирована оптимизация протокола
      - Спроектированы профили производительности
      - Создано техническое задание
      - Разбито на подзадачи

