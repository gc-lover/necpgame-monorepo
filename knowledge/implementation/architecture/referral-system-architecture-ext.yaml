          - milestone_type: ENUM (5, 10, 25, 50, 100)
          - reached_at: TIMESTAMP
          - reward_claimed: BOOLEAN
          - reward_claimed_at: TIMESTAMP

      - name: referral_rewards
        description: Награды реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - referral_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - reward_type: ENUM (welcome, level_10, milestone, bonus)
          - reward_data: JSONB
          - status: ENUM (pending, distributed, claimed, expired)
          - distributed_at: TIMESTAMP
          - claimed_at: TIMESTAMP

      - name: referral_leaderboard
        description: Лидерборд рефералов
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - total_referrals: INTEGER
          - active_referrals: INTEGER
          - milestone_referrals: INTEGER
          - rewards_earned: DECIMAL(10,2)
          - leaderboard_score: DECIMAL(10,2)
          - position: INTEGER
          - last_update: TIMESTAMP

      - name: referral_analytics
        description: Аналитика реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - character_id: UUID FOREIGN KEY
          - referral_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

      - name: referral_telemetry
        description: Телеметрия реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Обновление уровня персонажа
      - Создание персонажа

    economy_service: |
      - Выдача валюты (эдди, премиум валюта)
      - Проверка баланса
      - Обработка транзакций
      - Логирование экономических операций

    reward_service: |
      - Выдача предметов
      - Выдача косметики
      - Выдача опыта
      - Выдача репутации

    notification_service: |
      - Уведомления о новых рефералах
      - Уведомления о достижении milestone
      - Уведомления о доступных наградах
      - Уведомления об обновлении лидерборда

    analytics_service: |
      - Логирование всех операций реферальной системы
      - Сбор метрик эффективности
      - Анализ паттернов рефералов
      - Мониторинг конверсии

    achievement_service: |
      - Интеграция с достижениями
      - Разблокировка достижений за рефералов
      - Обновление прогресса достижений

    realtime_gateway: |
      - Отправка realtime обновлений реферальной системы
      - Синхронизация лидерборда
      - Уведомления о событиях

technical_specification:
  subtasks:
    - id: referral-manager
      title: Реализация менеджера реферальной системы
      description: |
        Реализация Referral Manager с управлением реферальной системой
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: code-generator
      title: Реализация генератора кодов
      description: |
        Реализация Code Generator с генерацией уникальных реферальных кодов,
        проверкой уникальности и сохранением в БД.
      dependencies: [referral-manager]
      estimated_effort: 3 days

    - id: code-validator
      title: Реализация валидатора кодов
      description: |
        Реализация Code Validator с валидацией реферальных кодов,
        проверкой срока действия и доступности.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: registration-handler
      title: Реализация обработчика регистрации
      description: |
        Реализация Registration Handler с обработкой регистрации по коду,
        созданием записи реферала и выдачей приветственных наград.
      dependencies: [code-validator]
      estimated_effort: 4 days

    - id: referral-tracker
      title: Реализация трекера рефералов
      description: |
        Реализация Referral Tracker с трекингом рефералов,
        отслеживанием их активности и обновлением статусов.
      dependencies: [referral-manager]
      estimated_effort: 4 days

    - id: milestone-manager
      title: Реализация менеджера milestone
      description: |
        Реализация Milestone Manager с управлением milestone наградами,
        проверкой достижений и созданием наград.
      dependencies: [referral-tracker]
      estimated_effort: 4 days

    - id: reward-distributor
      title: Реализация распределителя наград
      description: |
        Реализация Reward Distributor с распределением наград,
        интеграцией с Reward Service и Economy Service.
      dependencies: [milestone-manager]
      estimated_effort: 4 days

    - id: leaderboard-manager
      title: Реализация менеджера лидерборда
      description: |
        Реализация Leaderboard Manager с расчетом позиций,
        обновлением лидерборда и кэшированием.
      dependencies: [referral-tracker]
      estimated_effort: 4 days

    - id: referral-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Referral Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [referral-manager]
      estimated_effort: 3 days

    - id: referral-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Referral Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений реферальной системы,
        лидерборда и уведомлений.
      dependencies: [referral-manager, leaderboard-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов реферальной системы.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для реферальных кодов, рефералов, milestone,
        наград, лидерборда, аналитики и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> ReferralService[Referral Service<br/>8090]
        
        ReferralService --> RM[Referral Manager]
        ReferralService --> CG[Code Generator]
        ReferralService --> CV[Code Validator]
        ReferralService --> RH[Registration Handler]
        ReferralService --> RT[Referral Tracker]
        ReferralService --> MM[Milestone Manager]
        ReferralService --> RD[Reward Distributor]
        ReferralService --> LM[Leaderboard Manager]
        ReferralService --> RAC[Referral Analytics Collector]
        ReferralService --> RTC[Referral Telemetry Collector]
        
        RM --> CG
        RM --> CV
        CV --> RH
        RH --> RT
        RT --> MM
        MM --> RD
        RT --> LM
        
        ReferralService --> CharacterService[Character Service]
        ReferralService --> EconomyService[Economy Service]
        ReferralService --> RewardService[Reward Service]
        ReferralService --> NotificationService[Notification Service]
        ReferralService --> AnalyticsService[Analytics Service]
        ReferralService --> AchievementService[Achievement Service]
        
        ReferralService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        ReferralService --> DB[(Referral DB)]
        
        Client --> WSReferral[WebSocket<br/>Referral]
        WSReferral --> ReferralService
    ```

  registration_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant NP as New Player
        participant CV as Code Validator
        participant RH as Registration Handler
        participant RT as Referral Tracker
        participant RD as Reward Distributor
        participant EB as Event Bus
        
        NP->>CV: Enter referral code
        CV->>CV: Validate code
        CV->>RH: Code valid
        RH->>RH: Create referral record
        RH->>RT: Track referral
        RH->>RD: Distribute welcome reward
        RD->>EB: Publish referral.registration-completed
    ```

  milestone_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant R as Referral
        participant RT as Referral Tracker
        participant MM as Milestone Manager
        participant RD as Reward Distributor
        participant LM as Leaderboard Manager
        participant EB as Event Bus
        
        R->>RT: Reach level 10
        RT->>RT: Update referral status
        RT->>MM: Check milestone
        MM->>MM: Create milestone reward
        MM->>RD: Distribute reward
        MM->>LM: Update leaderboard
        LM->>EB: Publish referral.milestone-reached
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния реферальной системы
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (регистрация по коду, выдача наград, обновление лидерборда)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для кодов, регистрации, трекинга, milestone, наград, лидерборда и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура реферальной системы:
      - Определены компоненты (Referral Manager, Code Generator, Code Validator, Registration Handler, Referral Tracker, Milestone Manager, Reward Distributor, Leaderboard Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (referral_codes, referrals, referral_milestones, referral_rewards, referral_leaderboard)
      - Спроектирована система генерации кодов
      - Спроектирована система регистрации по коду
      - Спроектирована система milestone наград
      - Спроектирована система лидерборда
      - Создано техническое задание
      - Разбито на подзадачи
