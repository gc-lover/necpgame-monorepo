metadata:
  id: referral-system-architecture
  title: Архитектура реферальной системы
  document_type: architecture
  category: systems
  status: draft
  version: "1.1.0"
  last_updated: 2025-11-30T20:40:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - growth
    - referral
    - rewards
    - social
  related_systems:
    - referral-service
    - reward-service
    - notification-service
    - character-service
    - economy-service
    - analytics-service
  related_documents:
    - id: backend-referral-system
      relation: implements
  github_issue: 312
  visibility: internal
  audience:
    - architect
    - backend
    - growth
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру реферальной системы, включающую:
    - Генерацию уникальных реферальных кодов
    - Регистрацию новых игроков по коду
    - Трекинг рефералов и их активности
    - Систему milestone наград (5/10/25/50/100 рефералов)
    - Лидерборд рефералов
    - Выдачу наград рефереру и рефералу
    - Интеграции с другими системами
  goal: |
    Создать архитектурную схему реферальной системы с определением:
    - Компонентов для управления рефералами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура реферальной системы с поддержкой генерации кодов,
    регистрации, трекинга, milestone наград и лидерборда.

architecture:
  overview: |
    Архитектура реферальной системы состоит из следующих компонентов:
    1. Referral Manager - управление реферальной системой
    2. Code Generator - генерация уникальных реферальных кодов
    3. Code Validator - валидация реферальных кодов
    4. Registration Handler - обработка регистрации по коду
    5. Referral Tracker - трекинг рефералов и их активности
    6. Milestone Manager - управление milestone наградами
    7. Reward Distributor - распределение наград
    8. Leaderboard Manager - управление лидербордом
    9. Referral Analytics Collector - сбор аналитики
    10. Referral Telemetry Collector - сбор телеметрии

  microservices:
    - name: referral-service
      port: 8090
      responsibility: |
        Обработка реферальной системы:
        - Управление реферальной системой
        - Генерация уникальных кодов
        - Валидация кодов
        - Обработка регистрации по коду
        - Трекинг рефералов
        - Управление milestone наградами
        - Распределение наград
        - Управление лидербордом
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - referral-manager: управление реферальной системой
        - code-generator: генерация уникальных кодов
        - code-validator: валидация реферальных кодов
        - registration-handler: обработка регистрации по коду
        - referral-tracker: трекинг рефералов и их активности
        - milestone-manager: управление milestone наградами
        - reward-distributor: распределение наград
        - leaderboard-manager: управление лидербордом
        - referral-analytics-collector: сбор аналитики
        - referral-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/referral/code/{characterId} - получение реферального кода персонажа
        - POST /api/v1/referral/code/generate - генерация нового кода
        - POST /api/v1/referral/code/validate - валидация кода
        - POST /api/v1/referral/register - регистрация по реферальному коду
        - GET /api/v1/referral/{characterId}/referrals - список рефералов
        - GET /api/v1/referral/{characterId}/stats - статистика рефералов
        - GET /api/v1/referral/{characterId}/milestones - достигнутые milestones
        - POST /api/v1/referral/{characterId}/milestones/{milestoneId}/claim - получение milestone награды
        - GET /api/v1/referral/leaderboard - лидерборд рефералов
        - GET /api/v1/referral/leaderboard/{characterId} - позиция в лидерборде
        - GET /api/v1/referral/rewards/{characterId} - доступные награды
        - POST /api/v1/referral/rewards/{rewardId}/claim - получение награды
      websocket_channels:
        - wss://api.necp.game/v1/referral/{characterId} - поток обновлений реферальной системы
      events_published:
        - referral.code-generated: сгенерирован реферальный код
        - referral.code-validated: код валидирован
        - referral.registration-completed: регистрация по коду завершена
        - referral.referral-created: создан реферал
        - referral.referral-level-reached: реферал достиг уровня 10
        - referral.milestone-reached: достигнут milestone
        - referral.milestone-reward-claimed: получена milestone награда
        - referral.reward-distributed: награда распределена
        - referral.leaderboard-updated: обновлен лидерборд
      events_subscribed:
        - character.created: создан персонаж
        - character.level-up: повышение уровня персонажа
        - economy.transaction: транзакция в экономике
        - achievement.unlocked: разблокировано достижение

  code_generation:
    algorithm: |
      Генерация уникального кода:
      1. Генерация случайной строки (8-12 символов)
      2. Проверка уникальности в БД
      3. Если не уникален - повторная генерация
      4. Сохранение кода в БД
    format: |
      Формат кода: [PREFIX]-[RANDOM]
      Примеры: REF-ABC123XY, REF-XYZ789AB
    validation:
      - uniqueness: "уникальность кода"
      - length: "длина 8-12 символов"
      - characters: "только буквы и цифры"
      - expiration: "срок действия кода (опционально)"

  registration_process:
    steps:
      - code_input: "ввод реферального кода при регистрации"
      - code_validation: "валидация кода"
      - referral_creation: "создание записи реферала"
      - welcome_reward: "выдача приветственного бонуса новому игроку"
      - notification: "уведомление реферера о новом реферале"
    welcome_reward:
      - new_player: "награда новому игроку"
      - referrer: "награда рефереру (опционально)"

  referral_tracking:
    tracked_events:
      - registration: "регистрация по коду"
      - level_10: "достижение уровня 10"
      - milestone: "достижение milestone"
      - activity: "активность реферала"
    statuses:
      - pending: "ожидает активации"
      - active: "активный реферал"
      - milestone_reached: "достиг milestone"
      - inactive: "неактивный реферал"

  milestones:
    levels:
      - milestone: 5
        description: "5 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 10
        description: "10 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 25
        description: "25 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 50
        description: "50 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 100
        description: "100 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
    reward_types:
      - currency: "валюта (эдди, премиум валюта)"
      - items: "предметы"
      - cosmetics: "косметика"
      - experience: "опыт"
      - reputation: "репутация"

  leaderboard:
    types:
      - total_referrals: "общее количество рефералов"
      - active_referrals: "количество активных рефералов"
      - milestone_referrals: "количество рефералов, достигших milestone"
      - rewards_earned: "заработанные награды"
    ranking:
      - calculation: "расчет позиции на основе метрик"
      - update_frequency: "частота обновления (ежедневно, еженедельно)"
      - caching: "кэширование для производительности"
    display:
      - top_n: "топ N игроков"
      - player_position: "позиция конкретного игрока"
      - surrounding_players: "окружающие игроки"

  rewards:
    types:
      - welcome_reward: "приветственная награда новому игроку"
      - level_10_reward: "награда за достижение уровня 10 рефералом"
      - milestone_reward: "награда за достижение milestone"
      - bonus_reward: "бонусная награда"
    distribution:
      - automatic: "автоматическая выдача"
      - manual_claim: "ручное получение"
      - notification: "уведомление о доступной награде"

  data_flows:
    code_generation_flow: |
      1. Игрок запрашивает реферальный код
      2. Code Generator генерирует уникальный код
      3. Code Generator проверяет уникальность
      4. Code Generator сохраняет код в БД
      5. Referral Service публикует событие referral.code-generated
      6. Realtime Gateway отправляет код клиенту

    registration_flow: |
      1. Новый игрок вводит реферальный код при регистрации
      2. Code Validator проверяет код
      3. Registration Handler создает запись реферала
      4. Reward Distributor выдает приветственную награду новому игроку
      5. Referral Tracker обновляет статистику реферера
      6. Referral Service публикует событие referral.registration-completed
      7. Notification Service отправляет уведомление рефереру
      8. Realtime Gateway отправляет обновление клиентам

    milestone_flow: |
      1. Реферал достигает уровня 10
      2. Referral Tracker обновляет статус реферала
      3. Milestone Manager проверяет достижение milestone
      4. Milestone Manager создает milestone награду
      5. Reward Distributor выдает награду рефереру
      6. Leaderboard Manager обновляет лидерборд
      7. Referral Service публикует событие referral.milestone-reached
      8. Notification Service отправляет уведомление рефереру
      9. Realtime Gateway отправляет обновление клиентам

    leaderboard_update_flow: |
      1. Происходит событие, влияющее на лидерборд
      2. Leaderboard Manager пересчитывает позиции
      3. Leaderboard Manager обновляет кэш
      4. Referral Service публикует событие referral.leaderboard-updated
      5. Realtime Gateway отправляет обновление клиентам

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций (регистрация, milestone, награды)
    mechanisms:
      - ACID транзакции для регистрации по коду, создания реферала, выдачи наград и обновления milestone
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении лидерборда
      - Валидация перед регистрацией по коду и выдачей наград
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (регистрация по коду, выдача наград, обновление лидерборда)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния реферальной системы (генерация кода, регистрация по коду, создание реферала,
      достижение milestone, выдача наград, обновление лидерборда) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: ReferralCodeGeneratedEvent, ReferralRegisteredEvent, MilestoneReachedEvent, RewardDistributedEvent, LeaderboardUpdatedEvent.
    cqrs_pattern: |
      Разделение команд (генерация кода, регистрация по коду, выдача наград) и запросов
      (получение кода, получение списка рефералов, получение лидерборда) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как регистрация по коду (валидация кода, создание реферала,
      выдача приветственной награды, уведомление реферера) или выдача milestone награды (проверка milestone,
      создание награды, выдача награды, обновление лидерборда, уведомление реферера), используется Saga Pattern
      для обеспечения атомарности операций между Referral Service, Character Service, Economy Service, Reward Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    code_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Генерация кода: event-based, ~0.001-0.01 events/sec на игрока
        - Валидация кода: event-based, ~0.001-0.01 events/sec на игрока
        - Получение кода: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций кодов
      latency_requirements: < 50-100ms для генерации кода, < 30-50ms для валидации кода
      sync_strategy: Strong Consistency (ACID транзакции) для генерации и валидации кодов

    registration_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Регистрация по коду: event-based, ~0.001-0.01 events/sec на игрока
        - Создание реферала: event-based, ~0.001-0.01 events/sec на игрока
        - Выдача приветственной награды: event-based, ~0.001-0.01 events/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций регистрации
      latency_requirements: < 200-300ms для регистрации по коду, < 100-200ms для создания реферала
      sync_strategy: Strong Consistency (ACID транзакции) для регистрации по коду

    tracking_operations:
      tickrate: Event-based (on-demand при событиях персонажа) + 1-5 Hz для обновления статусов
      network_load: |
        - Обновление статуса реферала: event-based, ~0.01-0.05 events/sec на игрока
        - Получение списка рефералов: event-based, ~0.01-0.02 requests/sec на игрока
        - Получение статистики: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций трекинга
      latency_requirements: < 50-100ms для обновления статуса, < 30-100ms для получения списка
      sync_strategy: Strong Consistency (ACID транзакции) для обновления статуса, Eventual Consistency для статистики

    milestone_operations:
      tickrate: Event-based (on-demand при достижении уровня 10)
      network_load: |
        - Проверка milestone: event-based, ~0.001-0.01 events/sec на игрока
        - Создание milestone награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение milestone: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций milestone
      latency_requirements: < 100-200ms для проверки milestone, < 50-150ms для создания награды
      sync_strategy: Strong Consistency (ACID транзакции) для milestone операций

    reward_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Выдача награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение списка наград: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций наград
      latency_requirements: < 200-300ms для выдачи награды, < 50-150ms для получения награды
      sync_strategy: Strong Consistency (ACID транзакции) для выдачи наград

    leaderboard_operations:
      tickrate: Event-based (on-demand при изменениях) + 1-5 Hz для обновления лидерборда
      network_load: |
        - Обновление лидерборда: 1-5 Hz, ~0.05-0.2 KB/sec
        - Получение лидерборда: event-based, ~0.01-0.05 requests/sec на игрока
        - Получение позиции: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций лидерборда
      latency_requirements: < 50-100ms для обновления лидерборда, < 30-100ms для получения лидерборда
      sync_strategy: Eventual Consistency для лидерборда (кэширование в Redis)

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий реферальной системы: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_structure:
    tables:
      - name: referral_codes
        description: Реферальные коды
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - code: VARCHAR(20) UNIQUE
          - prefix: VARCHAR(10)
          - created_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - is_active: BOOLEAN
          - usage_count: INTEGER
          - max_usage: INTEGER

      - name: referrals
        description: Рефералы
        columns:
          - id: UUID PRIMARY KEY
          - referrer_id: UUID FOREIGN KEY
          - referred_id: UUID FOREIGN KEY
          - referral_code: VARCHAR(20)
          - status: ENUM (pending, active, milestone_reached, inactive)
          - registered_at: TIMESTAMP
          - level_10_reached_at: TIMESTAMP
          - milestone_reached_at: TIMESTAMP
          - welcome_reward_claimed: BOOLEAN
          - level_10_reward_claimed: BOOLEAN
          - milestone_reward_claimed: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: referral_milestones
        description: Milestone рефералов
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - milestone_level: INTEGER
          - milestone_type: ENUM (5, 10, 25, 50, 100)
          - reached_at: TIMESTAMP
          - reward_claimed: BOOLEAN
          - reward_claimed_at: TIMESTAMP

      - name: referral_rewards
        description: Награды реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - referral_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - reward_type: ENUM (welcome, level_10, milestone, bonus)
          - reward_data: JSONB
          - status: ENUM (pending, distributed, claimed, expired)
          - distributed_at: TIMESTAMP
          - claimed_at: TIMESTAMP

      - name: referral_leaderboard
        description: Лидерборд рефералов
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - total_referrals: INTEGER
          - active_referrals: INTEGER
          - milestone_referrals: INTEGER
          - rewards_earned: DECIMAL(10,2)
          - leaderboard_score: DECIMAL(10,2)
          - position: INTEGER
          - last_update: TIMESTAMP

      - name: referral_analytics
        description: Аналитика реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - character_id: UUID FOREIGN KEY
          - referral_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

      - name: referral_telemetry
        description: Телеметрия реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Обновление уровня персонажа
      - Создание персонажа

    economy_service: |
      - Выдача валюты (эдди, премиум валюта)
      - Проверка баланса
      - Обработка транзакций
      - Логирование экономических операций

    reward_service: |
      - Выдача предметов
      - Выдача косметики
      - Выдача опыта
      - Выдача репутации

    notification_service: |
      - Уведомления о новых рефералах
      - Уведомления о достижении milestone
      - Уведомления о доступных наградах
      - Уведомления об обновлении лидерборда

    analytics_service: |
      - Логирование всех операций реферальной системы
      - Сбор метрик эффективности
      - Анализ паттернов рефералов
      - Мониторинг конверсии

    achievement_service: |
      - Интеграция с достижениями
      - Разблокировка достижений за рефералов
      - Обновление прогресса достижений

    realtime_gateway: |
      - Отправка realtime обновлений реферальной системы
      - Синхронизация лидерборда
      - Уведомления о событиях

technical_specification:
  subtasks:
    - id: referral-manager
      title: Реализация менеджера реферальной системы
      description: |
        Реализация Referral Manager с управлением реферальной системой
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: code-generator
      title: Реализация генератора кодов
      description: |
        Реализация Code Generator с генерацией уникальных реферальных кодов,
        проверкой уникальности и сохранением в БД.
      dependencies: [referral-manager]
      estimated_effort: 3 days

    - id: code-validator
      title: Реализация валидатора кодов
      description: |
        Реализация Code Validator с валидацией реферальных кодов,
        проверкой срока действия и доступности.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: registration-handler
      title: Реализация обработчика регистрации
      description: |
        Реализация Registration Handler с обработкой регистрации по коду,
        созданием записи реферала и выдачей приветственных наград.
      dependencies: [code-validator]
      estimated_effort: 4 days

    - id: referral-tracker
      title: Реализация трекера рефералов
      description: |
        Реализация Referral Tracker с трекингом рефералов,
        отслеживанием их активности и обновлением статусов.
      dependencies: [referral-manager]
      estimated_effort: 4 days

    - id: milestone-manager
      title: Реализация менеджера milestone
      description: |
        Реализация Milestone Manager с управлением milestone наградами,
        проверкой достижений и созданием наград.
      dependencies: [referral-tracker]
      estimated_effort: 4 days

    - id: reward-distributor
      title: Реализация распределителя наград
      description: |
        Реализация Reward Distributor с распределением наград,
        интеграцией с Reward Service и Economy Service.
      dependencies: [milestone-manager]
      estimated_effort: 4 days

    - id: leaderboard-manager
      title: Реализация менеджера лидерборда
      description: |
        Реализация Leaderboard Manager с расчетом позиций,
        обновлением лидерборда и кэшированием.
      dependencies: [referral-tracker]
      estimated_effort: 4 days

    - id: referral-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Referral Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [referral-manager]
      estimated_effort: 3 days

    - id: referral-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Referral Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений реферальной системы,
        лидерборда и уведомлений.
      dependencies: [referral-manager, leaderboard-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов реферальной системы.
      dependencies: [referral-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для реферальных кодов, рефералов, milestone,
        наград, лидерборда, аналитики и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> ReferralService[Referral Service<br/>8090]
        
        ReferralService --> RM[Referral Manager]
        ReferralService --> CG[Code Generator]
        ReferralService --> CV[Code Validator]
        ReferralService --> RH[Registration Handler]
        ReferralService --> RT[Referral Tracker]
        ReferralService --> MM[Milestone Manager]
        ReferralService --> RD[Reward Distributor]
        ReferralService --> LM[Leaderboard Manager]
        ReferralService --> RAC[Referral Analytics Collector]
        ReferralService --> RTC[Referral Telemetry Collector]
        
        RM --> CG
        RM --> CV
        CV --> RH
        RH --> RT
        RT --> MM
        MM --> RD
        RT --> LM
        
        ReferralService --> CharacterService[Character Service]
        ReferralService --> EconomyService[Economy Service]
        ReferralService --> RewardService[Reward Service]
        ReferralService --> NotificationService[Notification Service]
        ReferralService --> AnalyticsService[Analytics Service]
        ReferralService --> AchievementService[Achievement Service]
        
        ReferralService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        ReferralService --> DB[(Referral DB)]
        
        Client --> WSReferral[WebSocket<br/>Referral]
        WSReferral --> ReferralService
    ```

  registration_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant NP as New Player
        participant CV as Code Validator
        participant RH as Registration Handler
        participant RT as Referral Tracker
        participant RD as Reward Distributor
        participant EB as Event Bus
        
        NP->>CV: Enter referral code
        CV->>CV: Validate code
        CV->>RH: Code valid
        RH->>RH: Create referral record
        RH->>RT: Track referral
        RH->>RD: Distribute welcome reward
        RD->>EB: Publish referral.registration-completed
    ```

  milestone_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant R as Referral
        participant RT as Referral Tracker
        participant MM as Milestone Manager
        participant RD as Reward Distributor
        participant LM as Leaderboard Manager
        participant EB as Event Bus
        
        R->>RT: Reach level 10
        RT->>RT: Update referral status
        RT->>MM: Check milestone
        MM->>MM: Create milestone reward
        MM->>RD: Distribute reward
        MM->>LM: Update leaderboard
        LM->>EB: Publish referral.milestone-reached
    ```

history:
  - version: '1.1.0'
    date: 2025-11-30
    author: Architect Agent
    changes: |
      Добавлена детальная синхронизация данных:
      - Event Sourcing для всех изменений состояния реферальной системы
      - CQRS Pattern для разделения команд и запросов
      - Saga Pattern для распределенных операций (регистрация по коду, выдача наград, обновление лидерборда)
      - Outbox Pattern для гарантированной доставки событий
      - Обновлена секция data_consistency с механизмами синхронизации
      - Добавлена спецификация тикрейта для кодов, регистрации, трекинга, milestone, наград, лидерборда и обработки событий
  - version: '1.0.0'
    date: 2025-11-23
    author: Architect Agent
    changes: |
      Создана полная архитектура реферальной системы:
      - Определены компоненты (Referral Manager, Code Generator, Code Validator, Registration Handler, Referral Tracker, Milestone Manager, Reward Distributor, Leaderboard Manager)
      - Описаны API endpoints (высокоуровнево)
      - Спроектированы потоки данных
      - Определена структура БД (referral_codes, referrals, referral_milestones, referral_rewards, referral_leaderboard)
      - Спроектирована система генерации кодов
      - Спроектирована система регистрации по коду
      - Спроектирована система milestone наград
      - Спроектирована система лидерборда
      - Создано техническое задание
      - Разбито на подзадачи
