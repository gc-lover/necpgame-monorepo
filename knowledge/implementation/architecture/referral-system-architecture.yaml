metadata:
  id: referral-system-architecture
  title: Архитектура реферальной системы
  document_type: architecture
  category: systems
  status: approved
  version: "1.1.0"
  last_updated: 2025-11-30T20:40:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - growth
    - referral
    - rewards
    - social
  related_systems:
    - referral-service
    - reward-service
    - notification-service
    - character-service
    - economy-service
    - analytics-service
  related_documents:
    - id: backend-referral-system
      relation: implements
  github_issue: 140891087
  visibility: internal
  audience:
    - architect
    - backend
    - growth
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру реферальной системы, включающую:
    - Генерацию уникальных реферальных кодов
    - Регистрацию новых игроков по коду
    - Трекинг рефералов и их активности
    - Систему milestone наград (5/10/25/50/100 рефералов)
    - Лидерборд рефералов
    - Выдачу наград рефереру и рефералу
    - Интеграции с другими системами
  goal: |
    Создать архитектурную схему реферальной системы с определением:
    - Компонентов для управления рефералами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура реферальной системы с поддержкой генерации кодов,
    регистрации, трекинга, milestone наград и лидерборда.

architecture:
  overview: |
    Архитектура реферальной системы состоит из следующих компонентов:
    1. Referral Manager - управление реферальной системой
    2. Code Generator - генерация уникальных реферальных кодов
    3. Code Validator - валидация реферальных кодов
    4. Registration Handler - обработка регистрации по коду
    5. Referral Tracker - трекинг рефералов и их активности
    6. Milestone Manager - управление milestone наградами
    7. Reward Distributor - распределение наград
    8. Leaderboard Manager - управление лидербордом
    9. Referral Analytics Collector - сбор аналитики
    10. Referral Telemetry Collector - сбор телеметрии

  microservices:
    - name: referral-service
      port: 8090
      responsibility: |
        Обработка реферальной системы:
        - Управление реферальной системой
        - Генерация уникальных кодов
        - Валидация кодов
        - Обработка регистрации по коду
        - Трекинг рефералов
        - Управление milestone наградами
        - Распределение наград
        - Управление лидербордом
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - referral-manager: управление реферальной системой
        - code-generator: генерация уникальных кодов
        - code-validator: валидация реферальных кодов
        - registration-handler: обработка регистрации по коду
        - referral-tracker: трекинг рефералов и их активности
        - milestone-manager: управление milestone наградами
        - reward-distributor: распределение наград
        - leaderboard-manager: управление лидербордом
        - referral-analytics-collector: сбор аналитики
        - referral-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/referral/code/{characterId} - получение реферального кода персонажа
        - POST /api/v1/referral/code/generate - генерация нового кода
        - POST /api/v1/referral/code/validate - валидация кода
        - POST /api/v1/referral/register - регистрация по реферальному коду
        - GET /api/v1/referral/{characterId}/referrals - список рефералов
        - GET /api/v1/referral/{characterId}/stats - статистика рефералов
        - GET /api/v1/referral/{characterId}/milestones - достигнутые milestones
        - POST /api/v1/referral/{characterId}/milestones/{milestoneId}/claim - получение milestone награды
        - GET /api/v1/referral/leaderboard - лидерборд рефералов
        - GET /api/v1/referral/leaderboard/{characterId} - позиция в лидерборде
        - GET /api/v1/referral/rewards/{characterId} - доступные награды
        - POST /api/v1/referral/rewards/{rewardId}/claim - получение награды
      websocket_channels:
        - wss://api.necp.game/v1/referral/{characterId} - поток обновлений реферальной системы
      events_published:
        - referral.code-generated: сгенерирован реферальный код
        - referral.code-validated: код валидирован
        - referral.registration-completed: регистрация по коду завершена
        - referral.referral-created: создан реферал
        - referral.referral-level-reached: реферал достиг уровня 10
        - referral.milestone-reached: достигнут milestone
        - referral.milestone-reward-claimed: получена milestone награда
        - referral.reward-distributed: награда распределена
        - referral.leaderboard-updated: обновлен лидерборд
      events_subscribed:
        - character.created: создан персонаж
        - character.level-up: повышение уровня персонажа
        - economy.transaction: транзакция в экономике
        - achievement.unlocked: разблокировано достижение

  code_generation:
    algorithm: |
      Генерация уникального кода:
      1. Генерация случайной строки (8-12 символов)
      2. Проверка уникальности в БД
      3. Если не уникален - повторная генерация
      4. Сохранение кода в БД
    format: |
      Формат кода: [PREFIX]-[RANDOM]
      Примеры: REF-ABC123XY, REF-XYZ789AB
    validation:
      - uniqueness: "уникальность кода"
      - length: "длина 8-12 символов"
      - characters: "только буквы и цифры"
      - expiration: "срок действия кода (опционально)"

  registration_process:
    steps:
      - code_input: "ввод реферального кода при регистрации"
      - code_validation: "валидация кода"
      - referral_creation: "создание записи реферала"
      - welcome_reward: "выдача приветственного бонуса новому игроку"
      - notification: "уведомление реферера о новом реферале"
    welcome_reward:
      - new_player: "награда новому игроку"
      - referrer: "награда рефереру (опционально)"

  referral_tracking:
    tracked_events:
      - registration: "регистрация по коду"
      - level_10: "достижение уровня 10"
      - milestone: "достижение milestone"
      - activity: "активность реферала"
    statuses:
      - pending: "ожидает активации"
      - active: "активный реферал"
      - milestone_reached: "достиг milestone"
      - inactive: "неактивный реферал"

  milestones:
    levels:
      - milestone: 5
        description: "5 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 10
        description: "10 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 25
        description: "25 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 50
        description: "50 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
      - milestone: 100
        description: "100 рефералов достигли уровня 10"
        rewards:
          - referrer: "награда рефереру"
          - bonus: "бонусная награда"
    reward_types:
      - currency: "валюта (эдди, премиум валюта)"
      - items: "предметы"
      - cosmetics: "косметика"
      - experience: "опыт"
      - reputation: "репутация"

  leaderboard:
    types:
      - total_referrals: "общее количество рефералов"
      - active_referrals: "количество активных рефералов"
      - milestone_referrals: "количество рефералов, достигших milestone"
      - rewards_earned: "заработанные награды"
    ranking:
      - calculation: "расчет позиции на основе метрик"
      - update_frequency: "частота обновления (ежедневно, еженедельно)"
      - caching: "кэширование для производительности"
    display:
      - top_n: "топ N игроков"
      - player_position: "позиция конкретного игрока"
      - surrounding_players: "окружающие игроки"

  rewards:
    types:
      - welcome_reward: "приветственная награда новому игроку"
      - level_10_reward: "награда за достижение уровня 10 рефералом"
      - milestone_reward: "награда за достижение milestone"
      - bonus_reward: "бонусная награда"
    distribution:
      - automatic: "автоматическая выдача"
      - manual_claim: "ручное получение"
      - notification: "уведомление о доступной награде"

  data_flows:
    code_generation_flow: |
      1. Игрок запрашивает реферальный код
      2. Code Generator генерирует уникальный код
      3. Code Generator проверяет уникальность
      4. Code Generator сохраняет код в БД
      5. Referral Service публикует событие referral.code-generated
      6. Realtime Gateway отправляет код клиенту

    registration_flow: |
      1. Новый игрок вводит реферальный код при регистрации
      2. Code Validator проверяет код
      3. Registration Handler создает запись реферала
      4. Reward Distributor выдает приветственную награду новому игроку
      5. Referral Tracker обновляет статистику реферера
      6. Referral Service публикует событие referral.registration-completed
      7. Notification Service отправляет уведомление рефереру
      8. Realtime Gateway отправляет обновление клиентам

    milestone_flow: |
      1. Реферал достигает уровня 10
      2. Referral Tracker обновляет статус реферала
      3. Milestone Manager проверяет достижение milestone
      4. Milestone Manager создает milestone награду
      5. Reward Distributor выдает награду рефереру
      6. Leaderboard Manager обновляет лидерборд
      7. Referral Service публикует событие referral.milestone-reached
      8. Notification Service отправляет уведомление рефереру
      9. Realtime Gateway отправляет обновление клиентам

    leaderboard_update_flow: |
      1. Происходит событие, влияющее на лидерборд
      2. Leaderboard Manager пересчитывает позиции
      3. Leaderboard Manager обновляет кэш
      4. Referral Service публикует событие referral.leaderboard-updated
      5. Realtime Gateway отправляет обновление клиентам

  data_consistency:
    strategy: Strong Consistency (ACID транзакции) для критичных операций (регистрация, milestone, награды)
    mechanisms:
      - ACID транзакции для регистрации по коду, создания реферала, выдачи наград и обновления milestone
      - Оптимистичные блокировки (versioning) для предотвращения конфликтов при обновлении лидерборда
      - Валидация перед регистрацией по коду и выдачей наград
      - Синхронизация с другими сервисами через Event Bus
      - Outbox Pattern для гарантированной доставки событий
      - Saga Pattern для распределенных операций (регистрация по коду, выдача наград, обновление лидерборда)

  data_synchronization:
    event_sourcing: |
      Все изменения состояния реферальной системы (генерация кода, регистрация по коду, создание реферала,
      достижение milestone, выдача наград, обновление лидерборда) записываются как события в Event Store.
      Это обеспечивает полный аудит, возможность восстановления состояния и "time travel" для отладки.
      Примеры событий: ReferralCodeGeneratedEvent, ReferralRegisteredEvent, MilestoneReachedEvent, RewardDistributedEvent, LeaderboardUpdatedEvent.
    cqrs_pattern: |
      Разделение команд (генерация кода, регистрация по коду, выдача наград) и запросов
      (получение кода, получение списка рефералов, получение лидерборда) для оптимизации производительности
      и масштабируемости. Read-модели могут быть кэшированы в Redis для быстрых запросов.
    saga_pattern: |
      Для распределенных транзакций, таких как регистрация по коду (валидация кода, создание реферала,
      выдача приветственной награды, уведомление реферера) или выдача milestone награды (проверка milestone,
      создание награды, выдача награды, обновление лидерборда, уведомление реферера), используется Saga Pattern
      для обеспечения атомарности операций между Referral Service, Character Service, Economy Service, Reward Service и Notification Service.
    outbox_pattern: |
      Для гарантированной доставки событий в Event Bus используется Outbox Pattern,
      который записывает события в транзакционную таблицу перед публикацией.

  tickrate_specification:
    code_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Генерация кода: event-based, ~0.001-0.01 events/sec на игрока
        - Валидация кода: event-based, ~0.001-0.01 events/sec на игрока
        - Получение кода: event-based, ~0.01-0.05 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций кодов
      latency_requirements: < 50-100ms для генерации кода, < 30-50ms для валидации кода
      sync_strategy: Strong Consistency (ACID транзакции) для генерации и валидации кодов

    registration_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Регистрация по коду: event-based, ~0.001-0.01 events/sec на игрока
        - Создание реферала: event-based, ~0.001-0.01 events/sec на игрока
        - Выдача приветственной награды: event-based, ~0.001-0.01 events/sec на игрока
        - Общий трафик: ~0.2-0.5 KB/sec на игрока для операций регистрации
      latency_requirements: < 200-300ms для регистрации по коду, < 100-200ms для создания реферала
      sync_strategy: Strong Consistency (ACID транзакции) для регистрации по коду

    tracking_operations:
      tickrate: Event-based (on-demand при событиях персонажа) + 1-5 Hz для обновления статусов
      network_load: |
        - Обновление статуса реферала: event-based, ~0.01-0.05 events/sec на игрока
        - Получение списка рефералов: event-based, ~0.01-0.02 requests/sec на игрока
        - Получение статистики: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций трекинга
      latency_requirements: < 50-100ms для обновления статуса, < 30-100ms для получения списка
      sync_strategy: Strong Consistency (ACID транзакции) для обновления статуса, Eventual Consistency для статистики

    milestone_operations:
      tickrate: Event-based (on-demand при достижении уровня 10)
      network_load: |
        - Проверка milestone: event-based, ~0.001-0.01 events/sec на игрока
        - Создание milestone награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение milestone: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций milestone
      latency_requirements: < 100-200ms для проверки milestone, < 50-150ms для создания награды
      sync_strategy: Strong Consistency (ACID транзакции) для milestone операций

    reward_operations:
      tickrate: Event-based (on-demand)
      network_load: |
        - Выдача награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение награды: event-based, ~0.001-0.01 events/sec на игрока
        - Получение списка наград: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций наград
      latency_requirements: < 200-300ms для выдачи награды, < 50-150ms для получения награды
      sync_strategy: Strong Consistency (ACID транзакции) для выдачи наград

    leaderboard_operations:
      tickrate: Event-based (on-demand при изменениях) + 1-5 Hz для обновления лидерборда
      network_load: |
        - Обновление лидерборда: 1-5 Hz, ~0.05-0.2 KB/sec
        - Получение лидерборда: event-based, ~0.01-0.05 requests/sec на игрока
        - Получение позиции: event-based, ~0.01-0.02 requests/sec на игрока
        - Общий трафик: ~0.1-0.3 KB/sec на игрока для операций лидерборда
      latency_requirements: < 50-100ms для обновления лидерборда, < 30-100ms для получения лидерборда
      sync_strategy: Eventual Consistency для лидерборда (кэширование в Redis)

    event_handling:
      tickrate: Event-based (on-demand)
      network_load: |
        - Публикация событий реферальной системы: event-based, ~0.1-0.5 events/sec
        - Подписка на события: event-based, ~0.05-0.2 events/sec
        - Общий трафик: ~0.2-0.7 KB/sec для событий
      latency_requirements: < 100-300ms для публикации событий
      sync_strategy: Eventual Consistency для событий (через Event Bus)

  database_structure:
    tables:
      - name: referral_codes
        description: Реферальные коды
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - code: VARCHAR(20) UNIQUE
          - prefix: VARCHAR(10)
          - created_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - is_active: BOOLEAN
          - usage_count: INTEGER
          - max_usage: INTEGER

      - name: referrals
        description: Рефералы
        columns:
          - id: UUID PRIMARY KEY
          - referrer_id: UUID FOREIGN KEY
          - referred_id: UUID FOREIGN KEY
          - referral_code: VARCHAR(20)
          - status: ENUM (pending, active, milestone_reached, inactive)
          - registered_at: TIMESTAMP
          - level_10_reached_at: TIMESTAMP
          - milestone_reached_at: TIMESTAMP
          - welcome_reward_claimed: BOOLEAN
          - level_10_reward_claimed: BOOLEAN
          - milestone_reward_claimed: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: referral_milestones
        description: Milestone рефералов
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - milestone_level: INTEGER
          - required_referrals: INTEGER
          - current_referrals: INTEGER
          - reward_type: VARCHAR(50)
          - reward_amount: INTEGER
          - bonus_reward_type: VARCHAR(50)
          - bonus_reward_amount: INTEGER
          - is_completed: BOOLEAN
          - completed_at: TIMESTAMP
          - is_reward_claimed: BOOLEAN
          - reward_claimed_at: TIMESTAMP
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: referral_leaderboard
        description: Лидерборд рефералов
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - rank: INTEGER
          - total_referrals: INTEGER
          - active_referrals: INTEGER
          - milestone_referrals: INTEGER
          - total_rewards: DECIMAL(10,2)
          - last_updated: TIMESTAMP
          - created_at: TIMESTAMP

      - name: referral_rewards
        description: Награды реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - referral_id: UUID FOREIGN KEY
          - reward_type: VARCHAR(50)
          - reward_amount: INTEGER
          - currency_type: VARCHAR(20)
          - item_id: UUID
          - status: ENUM (pending, distributed, claimed, expired)
          - distributed_at: TIMESTAMP
          - claimed_at: TIMESTAMP
          - expires_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: referral_analytics
        description: Аналитические данные реферальной системы
        columns:
          - id: UUID PRIMARY KEY
          - date: DATE
          - total_codes_generated: INTEGER
          - total_registrations: INTEGER
          - total_active_referrals: INTEGER
          - total_milestone_reached: INTEGER
          - total_rewards_distributed: DECIMAL(10,2)
          - conversion_rate: DECIMAL(5,4)
          - created_at: TIMESTAMP

  indexes:
    - table: referral_codes
      columns: [character_id]
      type: btree
      purpose: быстрый поиск кодов по персонажу
    - table: referral_codes
      columns: [code]
      type: hash
      purpose: уникальная проверка кодов
    - table: referrals
      columns: [referrer_id, status]
      type: btree
      purpose: фильтрация рефералов по рефереру и статусу
    - table: referrals
      columns: [referred_id]
      type: btree
      purpose: быстрый поиск реферала по ID
    - table: referral_milestones
      columns: [character_id, is_completed]
      type: btree
      purpose: активные milestones по персонажу
    - table: referral_leaderboard
      columns: [rank]
      type: btree
      purpose: сортировка лидерборда
    - table: referral_rewards
      columns: [character_id, status]
      type: btree
      purpose: награды по персонажу и статусу
    - table: referral_analytics
      columns: [date]
      type: btree
      purpose: аналитика по датам

  security:
    authentication:
      - JWT tokens для всех API запросов
      - Character ID валидация для доступа к персональным данным
      - Rate limiting: 100 requests/minute per character
    authorization:
      - Только владелец персонажа может управлять своими рефералами
      - Только владелец персонажа может получать свои награды
      - Админ доступ для модерации и аналитики
    encryption:
      - HTTPS для всех соединений
      - AES-256 для чувствительных данных в БД
      - JWT подписи с RS256

  monitoring:
    metrics:
      - referral_codes_generated_total
      - referral_registrations_total
      - referral_milestones_completed_total
      - referral_rewards_distributed_total
      - referral_api_response_time
      - referral_db_query_duration
    alerts:
      - Высокая латентность API (>500ms)
      - Высокая нагрузка на БД (>80% CPU)
      - Ошибки генерации кодов (>1% от общего числа)
      - Проблемы с распределением наград
    logging:
      - Структурированные логи с correlation ID
      - Аудит всех операций с наградами
      - Трекинг всех изменений в лидерборде

  integrations:
    character_service:
      events_consumed:
        - character.created - создание нового персонажа
        - character.level-up - повышение уровня персонажа
        - character.deleted - удаление персонажа
      apis_called:
        - GET /api/v1/characters/{id} - получение информации о персонаже
        - GET /api/v1/characters/{id}/level - получение уровня персонажа

    economy_service:
      events_published:
        - economy.transaction.created - создание транзакции награды
      apis_called:
        - POST /api/v1/economy/transactions - создание транзакции
        - GET /api/v1/economy/balances/{characterId} - проверка баланса

    notification_service:
      events_published:
        - notification.referral-milestone - уведомление о milestone
        - notification.referral-reward - уведомление о награде
      apis_called:
        - POST /api/v1/notifications - отправка уведомления

    analytics_service:
      events_published:
        - analytics.referral-event - событие аналитики рефералов
      apis_called:
        - POST /api/v1/analytics/events - отправка события аналитики

    realtime_gateway:
      websockets:
        - wss://api.necpgame.com/v1/referral/{characterId} - поток обновлений
      events_published:
        - realtime.referral-update - обновление реферальных данных

  deployment:
    docker:
      base_image: golang:1.21-alpine
      ports: [8090]
      environment:
        - DB_HOST=referral-db
        - REDIS_HOST=referral-redis
        - KAFKA_HOSTS=kafka-cluster
      healthcheck: /health
    kubernetes:
      replicas: 3
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi
      configmaps:
        - referral-config
      secrets:
        - referral-secrets
    database:
      type: PostgreSQL 15+
      connection_pool: 10-50 connections
      migration_tool: Liquibase
    cache:
      type: Redis Cluster
      purpose: кэширование лидерборда и частых запросов
    message_queue:
      type: Apache Kafka
      topics:
        - referral-events
        - referral-analytics

  scaling:
    horizontal:
      - Автоматическое масштабирование на основе CPU (>70%)
      - Минимум 3 реплики, максимум 10 реплик
    database:
      - Read replicas для запросов аналитики
      - Sharding по character_id для больших объемов данных
    cache:
      - Redis Cluster с автоматическим шардингом
      - TTL для кэшированных данных: 5-30 минут

  technical_requirements:
    implementation:
      - Go 1.21+ с generics
      - Clean Architecture (domain, application, infrastructure layers)
      - CQRS pattern для команд и запросов
      - Event Sourcing для критичных операций
      - Repository pattern для работы с БД
    testing:
      - Unit тесты: ">80% coverage"
      - Integration тесты для всех API endpoints
      - Load тесты: 1000 RPS sustained
      - Chaos engineering для отказоустойчивости
    documentation:
      - OpenAPI 3.0 спецификация
      - API documentation с примерами
      - Architecture Decision Records (ADRs)
      - Runbooks для эксплуатации

  risk_assessment:
    high_risk:
      - Дублирование реферальных кодов (unique constraints)
      - Потеря наград при сбоях (ACID транзакции)
      - Несогласованность лидерборда (eventual consistency)
    mitigation:
      - Валидация уникальности кодов на уровне приложения и БД
      - Saga pattern для распределенных транзакций
      - Conflict resolution для обновления лидерборда
    monitoring:
      - SLIs/SLOs для всех критичных операций
      - Automated canary deployments
      - Rollback procedures

  success_criteria:
    functional:
      - Генерация уникальных кодов: <100ms
      - Регистрация по коду: <300ms
      - Обновление лидерборда: <200ms
      - Выдача наград: 99.9% успешность
    non_functional:
      - 99.9% uptime
      - P95 latency <500ms
      - Support 100,000+ concurrent users
      - Zero data loss for rewards

# Issue: #140891087
