  4. Relationship Effects Applier применяет эффекты
    5. Social Service публикует событие social.relationship.trust-updated
    6. Realtime Gateway отправляет обновление клиентам

  alliance_creation_flow: |
    1. Игрок или клан создает союз через Alliance Manager
    2. Alliance Manager проверяет требования
    3. Alliance Manager отправляет приглашения
    4. Участники принимают приглашения
    5. Alliance Manager создает союз
    6. Relationship Effects Applier применяет эффекты
    7. Social Service публикует событие social.relationship.alliance-created
    8. Realtime Gateway отправляет обновление клиентам

  arbitration_flow: |
    1. Одна из сторон подает запрос на арбитраж
    2. Relationship Arbitration Manager собирает доказательства
    3. Relationship Arbitration Manager анализирует доказательства
    4. Relationship Arbitration Manager выносит решение
    5. Relationship Effects Applier применяет решение
    6. Social Service публикует событие social.relationship.arbitration-resolved
    7. Realtime Gateway отправляет обновление клиентам

  database_structure:
    tables:
      - name: player_relationships
        description: Отношения между игроками
        columns:
          - id: UUID PRIMARY KEY
          - character_id_1: UUID FOREIGN KEY
          - character_id_2: UUID FOREIGN KEY
          - relationship_type: ENUM (friends, close_allies, pact, neutral, enemies, nemesis)
          - reputation_value: INTEGER
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: trust_levels
        description: Уровни доверия между игроками
        columns:
          - id: UUID PRIMARY KEY
          - character_id_1: UUID FOREIGN KEY
          - character_id_2: UUID FOREIGN KEY
          - trust_level: INTEGER
          - trust_value: INTEGER
          - last_update: TIMESTAMP

      - name: trust_contracts
        description: Договоры доверия
        columns:
          - id: UUID PRIMARY KEY
          - character_id_1: UUID FOREIGN KEY
          - character_id_2: UUID FOREIGN KEY
          - contract_type: ENUM (resource_sharing, profit_sharing, base_access)
          - parameters: JSONB
          - start_date: TIMESTAMP
          - end_date: TIMESTAMP
          - status: ENUM (active, terminated, expired)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: alliances
        description: Союзы
        columns:
          - id: UUID PRIMARY KEY
          - alliance_type: ENUM (combat, trade, clan, faction)
          - creator_id: UUID FOREIGN KEY
          - creator_type: ENUM (player, clan, faction)
          - name: VARCHAR(255)
          - description: TEXT
          - member_ids: UUID[]
          - member_types: JSONB
          - parameters: JSONB
          - status: ENUM (pending, active, terminated)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: alliance_members
        description: Участники союзов
        columns:
          - id: UUID PRIMARY KEY
          - alliance_id: UUID FOREIGN KEY
          - member_id: UUID FOREIGN KEY
          - member_type: ENUM (player, clan, faction)
          - role: VARCHAR(50)
          - joined_at: TIMESTAMP
          - left_at: TIMESTAMP

      - name: character_ratings
        description: Рейтинги персонажей
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - rating_type: ENUM (overall, combat, trade, reliability, social_influence)
          - rating_value: DECIMAL(5,2)
          - factors: JSONB
          - last_update: TIMESTAMP

      - name: social_capital
        description: Социальный капитал
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - relationship_count: INTEGER
          - trust_level_average: DECIMAL(5,2)
          - alliance_count: INTEGER
          - rating_average: DECIMAL(5,2)
          - social_capital_score: DECIMAL(10,2)
          - last_update: TIMESTAMP

      - name: interaction_history
        description: История взаимодействий
        columns:
          - id: UUID PRIMARY KEY
          - character_id_1: UUID FOREIGN KEY
          - character_id_2: UUID FOREIGN KEY
          - event_type: ENUM (trade, combat, contracts, quests, disputes, arbitration)
          - event_data: JSONB
          - outcome: JSONB
          - evidence: JSONB
          - created_at: TIMESTAMP

      - name: relationship_arbitration
        description: Арбитраж отношений
        columns:
          - id: UUID PRIMARY KEY
          - complainant_id: UUID FOREIGN KEY
          - defendant_id: UUID FOREIGN KEY
          - reason: TEXT
          - evidence: JSONB
          - status: ENUM (pending, in-review, resolved, dismissed)
          - decision: JSONB
          - resolved_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: relationship_telemetry
        description: Телеметрия отношений
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    reputation_service: |
      - Получение репутации для расчета отношений
      - Обновление репутации на основе отношений
      - Влияние отношений на репутацию

    economy_service: |
      - Проверка торговых лимитов на основе доверия
      - Обработка распределения прибыли
      - Расчет экономических эффектов союзов

    world_service: |
      - Влияние союзов на мир
      - Триггеры событий на основе отношений
      - Обновление влияния фракций

    gameplay_service: |
      - Получение событий игрового процесса
      - Интеграция с системой прогрессии
      - Модификация опыта за взаимодействия

    quest_service: |
      - Интеграция с квестами на основе отношений
      - Триггеры квестов при изменении отношений
      - Обновление прогресса квестов

    analytics_service: |
      - Логирование всех операций отношений
      - Сбор метрик эффективности
      - Анализ паттернов отношений
      - Мониторинг социального капитала

    realtime_gateway: |
      - Отправка realtime обновлений отношений
      - Синхронизация союзов
      - Уведомления о событиях

  technical_specification:
    subtasks:
      - id: relationship-manager
        title: Реализация менеджера отношений
        description: |
          Реализация Relationship Manager с управлением отношениями
          и интеграцией с другими компонентами.
        dependencies: [ ]
        estimated_effort: 5 days

      - id: player-relationship-manager
        title: Реализация менеджера отношений между игроками
        description: |
          Реализация Player Relationship Manager с управлением отношениями
          между игроками и применением эффектов.
        dependencies: [ relationship-manager ]
        estimated_effort: 4 days

      - id: trust-manager
        title: Реализация менеджера доверия
        description: |
          Реализация Trust Manager с расчетом уровня доверия
          и обновлением на основе взаимодействий.
        dependencies: [ relationship-manager ]
        estimated_effort: 4 days

      - id: trust-contract-manager
        title: Реализация менеджера договоров доверия
        description: |
          Реализация Trust Contract Manager с созданием договоров,
          управлением условиями и расторжением.
        dependencies: [ trust-manager ]
        estimated_effort: 4 days

      - id: alliance-manager
        title: Реализация менеджера союзов
        description: |
          Реализация Alliance Manager с созданием союзов,
          управлением участниками и применением эффектов.
        dependencies: [ relationship-manager ]
        estimated_effort: 5 days

      - id: rating-manager
        title: Реализация менеджера рейтингов
        description: |
          Реализация Rating Manager с расчетом рейтингов
          и обновлением на основе взаимодействий.
        dependencies: [ relationship-manager ]
        estimated_effort: 4 days

      - id: social-capital-manager
        title: Реализация менеджера социального капитала
        description: |
          Реализация Social Capital Manager с расчетом социального капитала
          и применением эффектов.
        dependencies: [ rating-manager ]
        estimated_effort: 3 days

      - id: interaction-history-manager
        title: Реализация менеджера истории взаимодействий
        description: |
          Реализация Interaction History Manager с логированием взаимодействий
          и предоставлением истории.
        dependencies: [ relationship-manager ]
        estimated_effort: 3 days

      - id: relationship-arbitration-manager
        title: Реализация менеджера арбитража отношений
        description: |
          Реализация Relationship Arbitration Manager с обработкой жалоб,
          сбором доказательств и вынесением решений.
        dependencies: [ interaction-history-manager ]
        estimated_effort: 4 days

      - id: relationship-effects-applier
        title: Реализация применения эффектов отношений
        description: |
          Реализация Relationship Effects Applier с применением эффектов
          отношений на доступ, экономику и мир.
        dependencies: [ relationship-manager ]
        estimated_effort: 4 days

      - id: relationship-telemetry-collector
        title: Реализация сборщика телеметрии
        description: |
          Реализация Relationship Telemetry Collector с логированием операций,
          сбором метрик и интеграцией с Analytics Service.
        dependencies: [ relationship-manager ]
        estimated_effort: 3 days

      - id: websocket-channels
        title: Реализация WebSocket каналов
        description: |
          Реализация WebSocket каналов для realtime обновлений отношений,
          союзов и уведомлений.
        dependencies: [ relationship-manager, alliance-manager ]
        estimated_effort: 3 days

      - id: event-bus-integration
        title: Интеграция с Event Bus
        description: |
          Реализация публикации и подписки на события через Kafka
          для всех компонентов системы отношений.
        dependencies: [ relationship-manager ]
        estimated_effort: 2 days

      - id: database-schema
        title: Создание схемы БД
        description: |
          Создание таблиц БД для отношений, доверия, договоров, союзов,
          рейтингов, социального капитала, истории взаимодействий, арбитража
          и телеметрии с миграциями Liquibase.
        dependencies: [ ]
        estimated_effort: 4 days

  diagrams:
    component_diagram: |
      ```mermaid
      graph TB
          Client[UE5 Client] --> Gateway[API Gateway]
      
          Gateway --> SocialService[Social Service<br/>8084]
      
          SocialService --> RM[Relationship Manager]
          SocialService --> PRM[Player Relationship Manager]
          SocialService --> TM[Trust Manager]
          SocialService --> TCM[Trust Contract Manager]
          SocialService --> AM[Alliance Manager]
          SocialService --> RTM[Rating Manager]
          SocialService --> SCM[Social Capital Manager]
          SocialService --> IHM[Interaction History Manager]
          SocialService --> RAM[Relationship Arbitration Manager]
          SocialService --> REA[Relationship Effects Applier]
          SocialService --> RTC[Relationship Telemetry Collector]
      
          RM --> PRM
          RM --> TM
          TM --> TCM
          RM --> AM
          RM --> RTM
          RTM --> SCM
          RM --> IHM
          IHM --> RAM
          RM --> REA
      
          SocialService --> ReputationService[Reputation Service]
          SocialService --> EconomyService[Economy Service]
          SocialService --> WorldService[World Service]
          SocialService --> GameplayService[Gameplay Service]
          SocialService --> QuestService[Quest Service]
          SocialService --> AnalyticsService[Analytics Service]
      
          SocialService --> EventBus[Event Bus<br/>Kafka]
          EventBus --> RealtimeGateway[Realtime Gateway]
      
          SocialService --> DB[(Social DB)]
      
          Client --> WSRelationships[WebSocket<br/>Relationships]
          WSRelationships --> SocialService
      ```

    relationship_flow_diagram: |
      ```mermaid
      sequenceDiagram
          participant P1 as Player 1
          participant PRM as Player Relationship Manager
          participant REA as Relationship Effects Applier
          participant EB as Event Bus
      
          P1->>PRM: Set relationship
          PRM->>PRM: Validate requirements
          PRM->>PRM: Update relationship
          PRM->>REA: Apply effects
          REA->>EB: Publish social.relationship.changed
      ```

    alliance_creation_diagram: |
      ```mermaid
      sequenceDiagram
          participant C as Creator
          participant AM as Alliance Manager
          participant P1 as Player 1
          participant P2 as Player 2
          participant EB as Event Bus
      
          C->>AM: Create alliance
          AM->>P1: Send invitation
          AM->>P2: Send invitation
          P1->>AM: Accept invitation
          P2->>AM: Accept invitation
          AM->>AM: Create alliance
          AM->>EB: Publish social.relationship.alliance-created
      ```

