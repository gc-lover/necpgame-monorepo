metadata:
  id: reputation-system-architecture
  title: Архитектура репутационной системы
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T23:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - social
    - reputation
    - progression
  related_systems:
    - social-service
    - economy-service
    - world-service
  related_documents:
    - id: reputation-tiers-detailed
      relation: implements
    - id: reputation-formulas
      relation: implements
  github_issue: 307
  visibility: internal
  audience:
    - architect
    - backend
    - social
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру репутационной системы, включающую:
    - 7 уровней репутации (Hated, Hostile, Unfriendly, Neutral, Friendly, Honored, Legendary)
    - Диапазон -100 до +100
    - Эффекты на экономику, боёвку, доступ
    - Формулы изменения репутации
    - Систему Heat
    - Восстановление репутации
    - Интеграции с другими системами
  goal: |
    Создать архитектурную схему репутационной системы с определением:
    - Компонентов для управления репутацией
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Объединенная архитектура репутационной системы с поддержкой уровней репутации,
    формул изменения, системы Heat и интеграции с экономикой и миром.

architecture:
  overview: |
    Архитектура репутационной системы состоит из следующих компонентов:
    1. Reputation Manager - управление репутацией
    2. Reputation Tier Calculator - расчет уровня репутации
    3. Reputation Change Calculator - расчет изменений репутации
    4. Heat System Manager - управление системой Heat
    5. Access Control Manager - управление доступом на основе репутации
    6. Reputation Recovery Manager - управление восстановлением репутации
    7. Faction Relations Manager - управление отношениями между фракциями
    8. Reputation Effects Applier - применение эффектов репутации
    9. Reputation Telemetry Collector - сбор телеметрии

  microservices:
    - name: social-service
      port: 8084
      responsibility: |
        Обработка репутации:
        - Управление репутацией
        - Расчет уровня репутации
        - Расчет изменений репутации
        - Управление системой Heat
        - Управление доступом
        - Управление восстановлением
        - Управление отношениями между фракциями
        - Применение эффектов репутации
        - Сбор телеметрии
      components:
        - reputation-manager: управление репутацией
        - reputation-tier-calculator: расчет уровня репутации
        - reputation-change-calculator: расчет изменений репутации
        - heat-system-manager: управление системой Heat
        - access-control-manager: управление доступом
        - reputation-recovery-manager: управление восстановлением
        - faction-relations-manager: управление отношениями между фракциями
        - reputation-effects-applier: применение эффектов репутации
        - reputation-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/social/reputation/{characterId} - получение репутации персонажа
        - GET /api/v1/social/reputation/{characterId}/faction/{factionId} - репутация с фракцией
        - POST /api/v1/social/reputation/{characterId}/change - изменение репутации
        - GET /api/v1/social/reputation/{characterId}/tier - получение уровня репутации
        - GET /api/v1/social/reputation/{characterId}/heat - получение Heat
        - POST /api/v1/social/reputation/{characterId}/heat/reduce - снижение Heat
        - GET /api/v1/social/reputation/{characterId}/access - проверка доступа
        - GET /api/v1/social/reputation/{characterId}/discounts - получение скидок
        - POST /api/v1/social/reputation/{characterId}/recovery/start - начало восстановления
        - GET /api/v1/social/reputation/{characterId}/recovery/status - статус восстановления
        - GET /api/v1/social/reputation/{characterId}/faction-relations - отношения с фракциями
        - GET /api/v1/social/reputation/{characterId}/effects - получение эффектов репутации
        - GET /api/v1/social/reputation/{characterId}/history - история изменений репутации
      websocket_channels:
        - wss://api.necp.game/v1/social/reputation/{characterId} - поток изменений репутации и Heat
      events_published:
        - social.reputation.changed: изменение репутации
        - social.reputation.tier-changed: изменение уровня репутации
        - social.reputation.heat-updated: обновление Heat
        - social.reputation.access-updated: обновление доступа
        - social.reputation.recovery-started: начало восстановления
        - social.reputation.recovery-completed: завершение восстановления
        - social.reputation.faction-relation-changed: изменение отношения с фракцией
        - social.reputation.effects-applied: применение эффектов репутации
      events_subscribed:
        - quest.completed: завершение квеста
        - combat.enemy-killed: убийство врага
        - economy.transaction: транзакция в экономике
        - world.event: событие мира
        - npc.interaction: взаимодействие с NPC
        - player.order.completed: выполнение заказа игрока

  reputation_tiers:
    - name: hated
      range: "-100 to -76"
      color: "red"
      description: "Ненависть - блокирует территории, торговлю, вызывает агрессию NPC"
      effects:
        - territory_access: "blocked"
        - trade_access: "blocked"
        - npc_aggression: "high"
        - price_modifier: 2.0
        - quest_access: "none"

    - name: hostile
      range: "-75 to -51"
      color: "orange"
      description: "Враждебность - минимум сервисов с жёсткими наценками и охраной"
      effects:
        - territory_access: "restricted"
        - trade_access: "minimal"
        - npc_aggression: "medium"
        - price_modifier: 1.5
        - quest_access: "limited"

    - name: unfriendly
      range: "-50 to -26"
      color: "yellow"
      description: "Неприязнь - ограничивает квесты и повышает цены"
      effects:
        - territory_access: "restricted"
        - trade_access: "restricted"
        - npc_aggression: "low"
        - price_modifier: 1.2
        - quest_access: "restricted"

    - name: neutral
      range: "-25 to +25"
      color: "gray"
      description: "Нейтральность - стандартные условия и стартовая точка"
      effects:
        - territory_access: "normal"
        - trade_access: "normal"
        - npc_aggression: "none"
        - price_modifier: 1.0
        - quest_access: "normal"

    - name: friendly
      range: "+26 to +50"
      color: "green"
      description: "Дружелюбие - открывает VIP сервисы, скидки и рекрутинг NPC"
      effects:
        - territory_access: "normal"
        - trade_access: "enhanced"
        - npc_aggression: "none"
        - price_modifier: 0.9
        - quest_access: "enhanced"
        - vip_services: true
        - npc_recruitment: true

    - name: honored
      range: "+51 to +75"
      color: "blue"
      description: "Почёт - фракционные бонусы, ускоренный decay и эксклюзивные локации"
      effects:
        - territory_access: "enhanced"
        - trade_access: "enhanced"
        - npc_aggression: "none"
        - price_modifier: 0.8
        - quest_access: "enhanced"
        - vip_services: true
        - npc_recruitment: true
        - faction_bonuses: true
        - exclusive_locations: true
        - heat_decay_bonus: 1.5

    - name: legendary
      range: "+76 to +100"
      color: "purple"
      description: "Легендарность - уникальные награды, поддержка фракций и события по заказу"
      effects:
        - territory_access: "full"
        - trade_access: "full"
        - npc_aggression: "none"
        - price_modifier: 0.7
        - quest_access: "full"
        - vip_services: true
        - npc_recruitment: true
        - faction_bonuses: true
        - exclusive_locations: true
        - unique_rewards: true
        - faction_support: true
        - custom_events: true
        - heat_decay_bonus: 2.0

  reputation_formulas:
    change_formula: |
      reputationChange = baseChange * (1 + classBonus) * (1 + originBonus) * 
                         (1 + questBonus) * (1 + skillCheckBonus) * (1 + conflictModifier)
    
    final_reputation: |
      finalReputation = currentReputation + reputationChange
    
    tier_calculation: |
      if reputation <= -76: tier = Hated
      else if reputation <= -51: tier = Hostile
      else if reputation <= -26: tier = Unfriendly
      else if reputation <= 25: tier = Neutral
      else if reputation <= 50: tier = Friendly
      else if reputation <= 75: tier = Honored
      else: tier = Legendary

  heat_system:
    heat_formula: |
      heat = baseHeat + reputationPenalties + questPenalties + skillCheckPenalties
    
    heat_decay: |
      heatReduction = (timePassed / cooldownTime) * reputationBonus
      newHeat = max(0, currentHeat - heatReduction)
    
    heat_effects: |
      - Увеличение сложности проверок: dcModifier = floor(heat / 10)
      - Шанс негативных событий: eventChance = heat / 100
      - Ограничение доступа к ресурсам

  access_control:
    access_level_formula: |
      accessLevel = floor((reputation + 50) / 25)
    
    discount_formula: |
      discount = min(0.2, floor(reputation / 10) * 0.01)
      finalPrice = basePrice * (1 - discount)

  data_flows:
    reputation_change_flow: |
      1. Событие происходит (квест, убийство врага, транзакция)
      2. Reputation Change Calculator получает событие через Event Bus
      3. Reputation Change Calculator определяет базовое изменение репутации
      4. Reputation Change Calculator применяет модификаторы (класс, происхождение, квест, проверки)
      5. Reputation Change Calculator рассчитывает итоговое изменение
      6. Reputation Manager обновляет репутацию
      7. Reputation Tier Calculator пересчитывает уровень репутации
      8. Reputation Effects Applier применяет эффекты репутации
      9. Social Service публикует событие social.reputation.changed
      10. Realtime Gateway отправляет обновление клиентам

    heat_update_flow: |
      1. Происходит действие, влияющее на Heat
      2. Heat System Manager получает данные о действии
      3. Heat System Manager рассчитывает изменение Heat
      4. Heat System Manager обновляет Heat
      5. Heat System Manager применяет эффекты Heat
      6. Social Service публикует событие social.reputation.heat-updated
      7. Realtime Gateway отправляет обновление клиентам

    access_check_flow: |
      1. Игрок пытается получить доступ к ресурсу
      2. Access Control Manager получает запрос через GET /api/v1/social/reputation/{characterId}/access
      3. Access Control Manager получает текущую репутацию
      4. Access Control Manager рассчитывает уровень доступа
      5. Access Control Manager проверяет требования доступа
      6. Access Control Manager возвращает результат проверки
      7. Social Service публикует событие social.reputation.access-updated

    recovery_flow: |
      1. Игрок начинает восстановление репутации
      2. Reputation Recovery Manager получает запрос через POST /api/v1/social/reputation/{characterId}/recovery/start
      3. Reputation Recovery Manager проверяет возможность восстановления
      4. Reputation Recovery Manager создает задачу восстановления
      5. Reputation Recovery Manager отслеживает прогресс восстановления
      6. Reputation Recovery Manager применяет изменения репутации
      7. Social Service публикует событие social.reputation.recovery-completed
      8. Realtime Gateway отправляет обновление клиентам

    faction_relations_flow: |
      1. Изменяется репутация с одной фракцией
      2. Faction Relations Manager получает событие изменения репутации
      3. Faction Relations Manager определяет союзные и враждебные фракции
      4. Faction Relations Manager применяет матрицу конфликтов
      5. Faction Relations Manager пересчитывает репутацию с другими фракциями
      6. Social Service публикует событие social.reputation.faction-relation-changed
      7. Realtime Gateway отправляет обновление клиентам

  database_structure:
    tables:
      - name: character_reputation
        description: Репутация персонажей с фракциями
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - faction_id: UUID FOREIGN KEY
          - reputation_value: INTEGER (range: -100 to 100)
          - current_tier: ENUM (hated, hostile, unfriendly, neutral, friendly, honored, legendary)
          - heat: INTEGER (default: 0)
          - access_level: INTEGER
          - discount_percentage: DECIMAL(5,2)
          - last_update: TIMESTAMP
          - created_at: TIMESTAMP

      - name: reputation_history
        description: История изменений репутации
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - faction_id: UUID FOREIGN KEY
          - change_amount: INTEGER
          - change_reason: VARCHAR(255)
          - source_event: VARCHAR(100)
          - modifiers_applied: JSONB
          - old_value: INTEGER
          - new_value: INTEGER
          - old_tier: VARCHAR(50)
          - new_tier: VARCHAR(50)
          - timestamp: TIMESTAMP

      - name: reputation_recovery_tasks
        description: Задачи восстановления репутации
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - faction_id: UUID FOREIGN KEY
          - target_reputation: INTEGER
          - current_progress: INTEGER
          - recovery_type: ENUM (quest, bribe, service, time)
          - started_at: TIMESTAMP
          - completed_at: TIMESTAMP
          - status: ENUM (active, completed, cancelled)

      - name: heat_history
        description: История изменений Heat
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - heat_change: INTEGER
          - change_reason: VARCHAR(255)
          - source_event: VARCHAR(100)
          - old_heat: INTEGER
          - new_heat: INTEGER
          - timestamp: TIMESTAMP

      - name: faction_relations_matrix
        description: Матрица отношений между фракциями
        columns:
          - id: UUID PRIMARY KEY
          - faction_a_id: UUID FOREIGN KEY
          - faction_b_id: UUID FOREIGN KEY
          - relation_type: ENUM (allied, neutral, hostile)
          - modifier: DECIMAL(5,2)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: reputation_effects_cache
        description: Кэш эффектов репутации
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - faction_id: UUID FOREIGN KEY
          - effects: JSONB
          - cached_at: TIMESTAMP
          - expires_at: TIMESTAMP

  integrations:
    economy_service: |
      - Применение скидок на основе репутации
      - Ограничение доступа к торговле
      - Модификация цен на основе репутации

    world_service: |
      - Ограничение доступа к территориям
      - Триггеры событий на основе репутации
      - Реакция мира на репутацию

    quest_service: |
      - Ограничение доступа к квестам
      - Модификация наград на основе репутации
      - Триггеры квестов на основе репутации

    npc_service: |
      - Реакция NPC на репутацию
      - Доступ к найму NPC
      - Агрессия NPC на основе репутации

    gameplay_service: |
      - Получение событий боевой системы
      - Интеграция с системой прогрессии
      - Модификация сложности проверок

    analytics_service: |
      - Логирование всех изменений репутации
      - Сбор метрик репутации
      - Анализ паттернов репутации

    realtime_gateway: |
      - Отправка realtime обновлений репутации
      - Синхронизация Heat
      - Уведомления об изменениях доступа

technical_specification:
  subtasks:
    - id: reputation-manager
      title: Реализация менеджера репутации
      description: |
        Реализация Reputation Manager с управлением репутацией персонажей,
        обновлением значений и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 4 days

    - id: reputation-tier-calculator
      title: Реализация калькулятора уровня репутации
      description: |
        Реализация Reputation Tier Calculator с расчетом уровня репутации
        на основе значения и применением эффектов уровня.
      dependencies: [reputation-manager]
      estimated_effort: 3 days

    - id: reputation-change-calculator
      title: Реализация калькулятора изменений репутации
      description: |
        Реализация Reputation Change Calculator с расчетом изменений репутации
        с учетом модификаторов и формул.
      dependencies: [reputation-manager]
      estimated_effort: 4 days

    - id: heat-system-manager
      title: Реализация менеджера системы Heat
      description: |
        Реализация Heat System Manager с управлением Heat,
        расчетом затухания и применением эффектов Heat.
      dependencies: [reputation-manager]
      estimated_effort: 4 days

    - id: access-control-manager
      title: Реализация менеджера контроля доступа
      description: |
        Реализация Access Control Manager с проверкой доступа,
        расчетом скидок и применением ограничений.
      dependencies: [reputation-tier-calculator]
      estimated_effort: 3 days

    - id: reputation-recovery-manager
      title: Реализация менеджера восстановления репутации
      description: |
        Реализация Reputation Recovery Manager с управлением задачами восстановления,
        отслеживанием прогресса и применением изменений.
      dependencies: [reputation-manager]
      estimated_effort: 4 days

    - id: faction-relations-manager
      title: Реализация менеджера отношений фракций
      description: |
        Реализация Faction Relations Manager с управлением матрицей отношений,
        пересчетом репутации с другими фракциями.
      dependencies: [reputation-manager]
      estimated_effort: 4 days

    - id: reputation-effects-applier
      title: Реализация применителя эффектов репутации
      description: |
        Реализация Reputation Effects Applier с применением эффектов репутации
        к экономике, миру и другим системам.
      dependencies: [reputation-tier-calculator]
      estimated_effort: 4 days

    - id: reputation-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Reputation Telemetry Collector с логированием изменений,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [reputation-manager]
      estimated_effort: 3 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений репутации,
        Heat и доступа.
      dependencies: [reputation-manager, heat-system-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов репутационной системы.
      dependencies: [reputation-manager, reputation-change-calculator]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для репутации, истории, восстановления, Heat,
        матрицы отношений и кэша эффектов с миграциями Liquibase.
      dependencies: []
      estimated_effort: 2 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> SocialService[Social Service<br/>8084]
        
        SocialService --> RM[Reputation Manager]
        SocialService --> RTC[Reputation Tier Calculator]
        SocialService --> RCC[Reputation Change Calculator]
        SocialService --> HSM[Heat System Manager]
        SocialService --> ACM[Access Control Manager]
        SocialService --> RRM[Reputation Recovery Manager]
        SocialService --> FRM[Faction Relations Manager]
        SocialService --> REA[Reputation Effects Applier]
        SocialService --> RTColl[Reputation Telemetry Collector]
        
        RM --> RTC
        RM --> RCC
        RM --> HSM
        RTC --> ACM
        RTC --> REA
        RCC --> FRM
        
        SocialService --> EconomyService[Economy Service]
        SocialService --> WorldService[World Service]
        SocialService --> QuestService[Quest Service]
        SocialService --> NPCService[NPC Service]
        SocialService --> GameplayService[Gameplay Service]
        SocialService --> AnalyticsService[Analytics Service]
        
        SocialService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        SocialService --> DB[(Social DB)]
        
        Client --> WSReputation[WebSocket<br/>Reputation]
        WSReputation --> SocialService
    ```

  reputation_change_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant E as Event
        participant RCC as Reputation Change Calculator
        participant RM as Reputation Manager
        participant RTC as Reputation Tier Calculator
        participant REA as Reputation Effects Applier
        participant ES as Economy Service
        participant WS as World Service
        participant EB as Event Bus
        
        E->>RCC: Game event
        RCC->>RCC: Calculate base change
        RCC->>RCC: Apply modifiers
        RCC->>RCC: Calculate final change
        RCC->>RM: Update reputation
        RM->>RTC: Recalculate tier
        RTC->>RTC: Determine new tier
        RTC->>REA: Apply effects
        REA->>ES: Update discounts
        REA->>WS: Update access
        RM->>EB: Publish social.reputation.changed
    ```

  heat_decay_diagram: |
    ```mermaid
    sequenceDiagram
        participant HSM as Heat System Manager
        participant RM as Reputation Manager
        participant RTC as Reputation Tier Calculator
        participant EB as Event Bus
        
        Note over HSM: Time-based decay
        HSM->>HSM: Calculate time passed
        HSM->>RM: Get current reputation
        HSM->>RTC: Get tier bonus
        HSM->>HSM: Calculate heat reduction
        HSM->>HSM: Apply reduction
        HSM->>EB: Publish social.reputation.heat-updated
    ```

