# Issue: #1848
# Архитектура системы управления сессиями

metadata:
  version: "1.1.0"
  created_at: "2025-12-13"
  updated_at: "2025-12-13"
  author: "API Designer Agent"
  status: "completed"
  priority: "high"

## Обзор системы

Система управления сессиями обеспечивает полный жизненный цикл игровых сессий в MMOFPS RPG,
включая создание, мониторинг, переподключение и очистку с гарантией высокой производительности
и безопасности.

### Ключевые требования
- **Производительность**: P99 <50ms, поддержка 10k+ одновременных сессий
- **Надежность**: Автоматическое переподключение ≤5 мин, zero-downtime
- **Безопасность**: Token binding, rate limiting, audit logging
- **Масштабируемость**: Горизонтальное масштабирование session-service

## Архитектурные компоненты

### 1. Session Service (Core)
**Технологии**: Go + ogen, PostgreSQL + Redis кластер
**Масштаб**: 3+ инстансов за load balancer

#### API Endpoints (OpenAPI 3.0)
```yaml
# Основные операции (session-management-service.yaml)
POST /auth/session/create          # Создание сессии
POST /auth/session/heartbeat       # Heartbeat (batch до 100)
POST /auth/session/reconnect       # Переподключение (≤5 мин окно)
POST /auth/session/logout          # Выход
GET  /auth/session/{id}            # Получение сессии
```

#### Модель данных (PostgreSQL)
```sql
-- player_sessions: основная таблица сессий
CREATE TABLE player_sessions (
  id UUID PRIMARY KEY,
  player_id UUID NOT NULL,
  token TEXT UNIQUE NOT NULL,
  status session_status_enum NOT NULL,
  region VARCHAR(50),
  shard_id VARCHAR(50),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  reconnect_until TIMESTAMPTZ,
  client_version VARCHAR(20),
  device_fp TEXT,
  ip INET,
  user_agent TEXT
);

-- Индексы для высокой производительности
CREATE INDEX idx_player_sessions_player_status ON player_sessions(player_id, status);
CREATE INDEX idx_player_sessions_status_last_seen ON player_sessions(status, last_seen_at);
CREATE INDEX idx_player_sessions_expires_at ON player_sessions(expires_at);
CREATE INDEX idx_player_sessions_reconnect_until ON player_sessions(reconnect_until);
```

#### Кеш (Redis Cluster)
```redis
# session:{token} → быстрый lookup сессии
SET session:abc123def456 {
  "session_id": "uuid",
  "player_id": "uuid",
  "status": "ACTIVE",
  "expires_at": "2025-12-13T20:00:00Z",
  "reconnect_until": "2025-12-13T20:05:00Z",
  "shard_id": "shard-01"
} EX 3600

# active_players:{shard} → set активных игроков
SADD active_players:shard-01 session_uuid_1 session_uuid_2

# reconnect:{player_id} → данные переподключения
SET reconnect:player_uuid {
  "session_id": "uuid",
  "window": 300
} EX 300
```

### 2. Event Bus (Kafka/NATS)
**События сессий**:
- `session.created` - сессия создана
- `session.heartbeat` - heartbeat получен
- `session.expired` - сессия истекла
- `session.reconnected` - переподключение
- `session.terminated` - сессия закрыта

**Потребители**:
- Analytics Service: DAU, retention метрики
- Gameplay Service: очистка состояния при disconnect
- Notification Service: push уведомления

### 3. Monitoring & Observability

#### Метрики (Prometheus)
```prometheus
# RPS метрики
session_create_total{status="success"} 1500
session_heartbeat_rps 8500
session_reconnect_success_total 450

# Задержки
histogram_quantile(0.95, session_create_duration) < 0.05
histogram_quantile(0.95, session_heartbeat_duration) < 0.03

# Состояния
session_active_total{shard="shard-01"} 1250
session_expired_total 25
```

#### Алерты (Alertmanager)
- Heartbeat P99 >100ms за 5 мин
- Reconnect fail rate >5% за 5 мин
- Expired sessions surge >20% за 10 мин
- Redis/PostgreSQL error rate >1%

### 4. Security Layer

#### Token Security
- **JWT tokens** с RSA подписанием
- **Token rotation** при reconnect
- **IP binding** с optional step-up auth
- **Device fingerprinting** для anomaly detection

#### Rate Limiting
```yaml
# На игрока
create_session: 5/hour
reconnect_session: 20/day

# Глобальные лимиты
heartbeat_global: 15k RPS
```

### 5. Cleanup System

#### Автоматическая очистка
- **Cleanup Worker**: каждые 5 минут
- **Expired sessions**: TTL > 24 часа
- **Idle sessions**: нет heartbeat > 5 минут
- **Old sessions**: >7 дней в CLOSED статусе

#### Ручная очистка
```bash
# Admin API для принудительной очистки
POST /auth/session/cleanup
{
  "force": true,
  "max_age_hours": 168
}
```

## Производительность и оптимизации

### Backend Optimizations
- **Struct alignment**: поля отсортированы large→small (экономия 30-50% памяти)
- **Memory pooling**: сессии используют object pool
- **Batch operations**: heartbeat до 100 записей за раз
- **Connection pooling**: Redis/PostgreSQL pools с keepalive

### Database Optimizations
- **Partitioning**: сессии по дате создания
- **Archiving**: старые сессии в archive таблицы
- **Read replicas**: analytics читает из replicas
- **Index optimization**: covering indexes для hot queries

### Cache Optimizations
- **TTL strategy**: expires_at = session TTL
- **Redis cluster**: horizontal scaling
- **Cache warming**: preload active sessions on startup

## Масштабирование

### Horizontal Scaling
- **Session affinity**: sticky sessions по player_id
- **Shard-based**: sessions pinned to specific shards
- **Load balancing**: round-robin с health checks

### Vertical Scaling Limits
- **Single instance**: 5k concurrent sessions
- **Cluster**: unlimited (Redis cluster limits)

## Резервное копирование и восстановление

### Backup Strategy
- **PostgreSQL**: ежедневные full backups + WAL shipping
- **Redis**: AOF + snapshots каждые 5 минут
- **Event logs**: Kafka retention 30 дней

### Disaster Recovery
- **RTO**: 15 минут для critical sessions
- **RPO**: 5 минут data loss tolerance
- **Failover**: automated PostgreSQL failover

## Интеграции

### Внешние системы
- **Auth Service**: валидация токенов, user info
- **Gameplay Service**: session state sync
- **Analytics Service**: session metrics aggregation
- **Notification Service**: disconnect notifications

### Внутренние компоненты
- **World Service**: zone assignment
- **Matchmaking Service**: session validation
- **Inventory Service**: session-scoped items

## Мониторинг и поддержка

### Health Checks
```yaml
# Readiness probe
GET /health/ready

# Liveness probe
GET /health/live

# Metrics endpoint
GET /metrics
```

### Debug endpoints (admin only)
```yaml
GET /debug/sessions/active
GET /debug/sessions/{id}/state
GET /debug/cleanup/status
```

## Безопасность и compliance

### Data Protection
- **Encryption at rest**: PostgreSQL TDE
- **Encryption in transit**: TLS 1.3
- **PII masking**: sensitive data masked in logs

### Audit Logging
- **Session events**: все CRUD операции логируются
- **Admin actions**: privileged operations auditable
- **Security events**: token rotation, IP changes

### Compliance
- **GDPR**: session data retention policies
- **CCPA**: data deletion on user request
- **Security audits**: quarterly security reviews

---

## Следующие шаги

### Для Backend Developer
- Реализовать session-service с ogen
- Настроить PostgreSQL + Redis
- Реализовать cleanup worker
- Добавить monitoring

### Для DevOps
- Настроить Kubernetes deployment
- Настроить monitoring stack
- Настроить backup/DR procedures

### Для QA
- Нагрузочное тестирование (10k RPS)
- Reconnect testing (5 мин окно)
- Failover testing

### Для Security
- Реализовать token binding
- Настроить rate limiting
- Настроить audit logging

**Готово к передаче Backend Developer для реализации сервиса.**