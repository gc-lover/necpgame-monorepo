metadata:
  id: stock-exchange-system-architecture
  title: Архитектура системы фондовой биржи
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T14:30:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - economy
    - stock-exchange
    - trading
    - investment
  related_systems:
    - economy-service
    - analytics-service
    - world-service
    - social-service
    - quest-service
  related_documents:
    - id: stock-exchange-overview
      relation: implements
    - id: stock-trading
      relation: implements
    - id: stock-dividends
      relation: implements
    - id: stock-events
      relation: implements
    - id: stock-indices
      relation: implements
    - id: stock-analytics
      relation: implements
    - id: stock-advanced
      relation: implements
    - id: stock-protection
      relation: implements
    - id: stock-integration
      relation: implements
  github_issue: 393
  visibility: internal
  audience:
    - architect
    - backend
    - economy
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы фондовой биржи, которая включает:
    - Торговлю акциями корпораций
    - Систему дивидендов и пассивного дохода
    - Реакцию на игровые события
    - Индексы и аналитику
    - Защиту от манипуляций
    - Интеграции с квестами, фракциями и мировыми событиями
  goal: |
    Создать архитектурную схему системы фондовой биржи с определением:
    - Компонентов для торговли, дивидендов, событий, индексов и аналитики
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД для акций, портфелей, ордеров и дивидендов
    - Технического задания для реализации
  essence: |
    Система фондовой биржи обеспечивает торговлю акциями корпораций, выплату дивидендов,
    реакцию на игровые события, расчет индексов и аналитику. Интегрируется с экономикой,
    квестами, фракциями и мировыми событиями через Event Bus.

architecture:
  overview: |
    Система фондовой биржи состоит из следующих компонентов:
    1. Stock Trading Engine - исполнение ордеров и matching
    2. Stock Pricing Engine - расчет цен на основе спроса/предложения и событий
    3. Dividend Service - расчет и выплата дивидендов
    4. Stock Events Handler - обработка влияния игровых событий на цены
    5. Index Calculator - расчет биржевых индексов
    6. Stock Analytics Engine - аналитика и метрики
    7. Compliance Monitor - защита от манипуляций
    8. Portfolio Manager - управление портфелями игроков
    9. Corporation Registry - реестр корпораций и их акций

  microservices:
    - name: economy-service
      port: 8085
      responsibility: |
        Основной сервис для системы фондовой биржи:
        - Управление корпорациями и их акциями
        - Торговля акциями (matching engine)
        - Расчет цен на основе спроса/предложения
        - Управление портфелями игроков
        - Интеграция с другими экономическими системами
      components:
        - Stock Trading Engine
        - Stock Pricing Engine
        - Portfolio Manager
        - Corporation Registry
        - Order Book Manager
        - Trade Executor
      endpoints:
        - GET /api/v1/economy/stocks - список акций
        - GET /api/v1/economy/stocks/{symbol} - детали акции
        - GET /api/v1/economy/stocks/{symbol}/price - текущая цена
        - GET /api/v1/economy/stocks/{symbol}/history - история цен
        - POST /api/v1/economy/stocks/orders - создать ордер
        - GET /api/v1/economy/stocks/orders/{id} - детали ордера
        - DELETE /api/v1/economy/stocks/orders/{id} - отменить ордер
        - GET /api/v1/economy/stocks/portfolio - портфель игрока
        - GET /api/v1/economy/stocks/portfolio/history - история портфеля
        - GET /api/v1/economy/stocks/corporations - список корпораций
        - GET /api/v1/economy/stocks/corporations/{id} - детали корпорации

    - name: dividend-service
      port: 8088
      responsibility: |
        Управление дивидендами:
        - Расчет дивидендов по корпорациям
        - Распределение выплат игрокам
        - Управление DRIP (Dividend Reinvestment Plan)
        - Налоговый учет дивидендов
        - Уведомления о выплатах
      components:
        - Dividend Calculator
        - Dividend Scheduler
        - DRIP Manager
        - Dividend Distributor
        - Tax Calculator
      endpoints:
        - GET /api/v1/dividends/schedule - расписание дивидендов
        - GET /api/v1/dividends/pending - ожидающие выплаты
        - GET /api/v1/dividends/history - история выплат
        - POST /api/v1/dividends/{id}/reinvest - реинвестировать дивиденды
        - GET /api/v1/dividends/player/{player_id} - дивиденды игрока

    - name: stock-analytics-service
      port: 8089
      responsibility: |
        Аналитика и метрики биржи:
        - Расчет индексов (S&P 500 аналог)
        - P/E, P/B и другие метрики
        - Технический анализ
        - Тренды и прогнозы
        - Рыночная капитализация
      components:
        - Index Calculator
        - Metrics Calculator
        - Technical Analyzer
        - Trend Analyzer
        - Market Cap Calculator
      endpoints:
        - GET /api/v1/analytics/stocks/indices - список индексов
        - GET /api/v1/analytics/stocks/indices/{id} - детали индекса
        - GET /api/v1/analytics/stocks/{symbol}/metrics - метрики акции
        - GET /api/v1/analytics/stocks/{symbol}/technical - технический анализ
        - GET /api/v1/analytics/stocks/trends - рыночные тренды

    - name: compliance-service
      port: 8091
      responsibility: |
        Защита от манипуляций:
        - Мониторинг подозрительных сделок
        - Обнаружение инсайдерской торговли
        - Circuit breakers
        - Лимиты на позиции
        - Временные ограничения
      components:
        - Trade Monitor
        - Insider Trading Detector
        - Circuit Breaker Manager
        - Position Limit Enforcer
        - Suspicious Activity Reporter
      endpoints:
        - GET /api/v1/compliance/alerts - алерты о нарушениях
        - POST /api/v1/compliance/circuit-breaker/{symbol} - активировать circuit breaker
        - GET /api/v1/compliance/limits/{player_id} - лимиты игрока
        - POST /api/v1/compliance/report - сообщить о нарушении

  components:
    - name: Stock Trading Engine
      location: economy-service
      responsibility: |
        Исполнение ордеров на покупку/продажу:
        - Matching buy и sell ордеров
        - Исполнение сделок по best price
        - Обновление портфелей игроков
        - Расчет комиссий
        - Логирование всех сделок
      dependencies:
        - Order Book Manager
        - Portfolio Manager
        - Wallet Service
        - Event Bus

    - name: Stock Pricing Engine
      location: economy-service
      responsibility: |
        Расчет цен на акции:
        - Цена на основе спроса/предложения
        - Реакция на события (price impact)
        - Волатильность и spread
        - Обновление цен в реальном времени
        - История цен
      dependencies:
        - Order Book Manager
        - Stock Events Handler
        - Event Bus

    - name: Portfolio Manager
      location: economy-service
      responsibility: |
        Управление портфелями игроков:
        - Хранение позиций игроков
        - Расчет стоимости портфеля
        - История транзакций
        - P&L (прибыль/убыток)
        - Средняя цена покупки
      dependencies:
        - Stock Pricing Engine
        - Database

    - name: Corporation Registry
      location: economy-service
      responsibility: |
        Реестр корпораций и их акций:
        - Список корпораций на бирже
        - Типы акций (Common, Preferred)
        - IPO и делистинг
        - Базовая информация о корпорациях
        - Связь с фракциями
      dependencies:
        - Database
        - Social Service (фракции)

    - name: Order Book Manager
      location: economy-service
      responsibility: |
        Управление ордербуком:
        - Хранение активных ордеров
        - Сортировка по цене и времени
        - Matching логика
        - Частичное исполнение
        - Time-in-force (GTC, IOC, FOK)
      dependencies:
        - Database
        - Redis (для realtime)

    - name: Trade Executor
      location: economy-service
      responsibility: |
        Исполнение сделок:
        - Создание trade records
        - Обновление балансов
        - Расчет комиссий
        - Публикация событий
        - Уведомления игрокам
      dependencies:
        - Wallet Service
        - Notification Service
        - Event Bus

    - name: Dividend Calculator
      location: dividend-service
      responsibility: |
        Расчет дивидендов:
        - Формулы расчета (фиксированные/переменные)
        - Учет прибыльности корпорации
        - Распределение по акциям
        - Налоговые вычеты
      dependencies:
        - Corporation Registry
        - Portfolio Manager

    - name: Dividend Scheduler
      location: dividend-service
      responsibility: |
        Расписание выплат:
        - Квартальные и годовые графики
        - Declaration, ex-dividend, record, payment даты
        - Автоматические выплаты
        - Уведомления игрокам
      dependencies:
        - Event Scheduler Service
        - Notification Service

    - name: DRIP Manager
      location: dividend-service
      responsibility: |
        Dividend Reinvestment Plan:
        - Автоматическое реинвестирование
        - Настройки игроков
        - Покупка акций на дивиденды
        - Расчет количества акций
      dependencies:
        - Dividend Calculator
        - Stock Trading Engine

    - name: Stock Events Handler
      location: economy-service
      responsibility: |
        Обработка влияния событий на цены:
        - Подписка на игровые события
        - Расчет price impact
        - Применение модификаторов
        - Длительность эффектов
        - История влияний
      dependencies:
        - World Service (события)
        - Quest Service (квесты)
        - Social Service (фракции)
        - Event Bus

    - name: Index Calculator
      location: stock-analytics-service
      responsibility: |
        Расчет биржевых индексов:
        - Методики расчета (price-weighted, market-cap weighted)
        - Перебалансировка
        - История индексов
        - Состав индексов
      dependencies:
        - Stock Pricing Engine
        - Market Cap Calculator

    - name: Metrics Calculator
      location: stock-analytics-service
      responsibility: |
        Расчет финансовых метрик:
        - P/E (Price-to-Earnings)
        - P/B (Price-to-Book)
        - Dividend Yield
        - Market Cap
        - Volume и turnover
      dependencies:
        - Stock Pricing Engine
        - Dividend Service

    - name: Technical Analyzer
      location: stock-analytics-service
      responsibility: |
        Технический анализ:
        - Moving averages
        - RSI, MACD
        - Support/Resistance уровни
        - Тренды
        - Паттерны
      dependencies:
        - Stock Pricing Engine (история цен)

    - name: Trade Monitor
      location: compliance-service
      responsibility: |
        Мониторинг сделок:
        - Обнаружение подозрительных паттернов
        - Аномальные объемы
        - Wash trading detection
        - Price manipulation detection
      dependencies:
        - Stock Trading Engine
        - Analytics Service

    - name: Insider Trading Detector
      location: compliance-service
      responsibility: |
        Обнаружение инсайдерской торговли:
        - Корреляция сделок с событиями
        - Анализ timing сделок
        - Связь с квестами и фракциями
        - Алерты и блокировки
      dependencies:
        - Stock Trading Engine
        - Quest Service
        - Social Service

    - name: Circuit Breaker Manager
      location: compliance-service
      responsibility: |
        Circuit breakers:
        - Автоматическая остановка торговли
        - Пороги падения цен
        - Временные ограничения
        - Восстановление торговли
      dependencies:
        - Stock Pricing Engine
        - Stock Trading Engine

  integrations:
    - name: World Service Integration
      description: |
        Реакция на мировые события:
        - Подписка на world events
        - Price impact от событий
        - Корпоративные кризисы и бумы
      events:
        - world.event.started
        - world.event.ended
        - world.event.effect_applied
      endpoints:
        - POST /api/v1/world/events/{id}/stock-impact - применить влияние на акции

    - name: Quest Service Integration
      description: |
        Влияние квестов на акции:
        - Исходы квестов влияют на корпорации
        - Успех/провал миссий
        - Корпоративные скандалы
      events:
        - quest.completed
        - quest.failed
        - quest.corporate_impact
      endpoints:
        - POST /api/v1/quests/{id}/stock-impact - применить влияние квеста

    - name: Social Service Integration
      description: |
        Связь с фракциями:
        - Корпорации как фракции
        - Влияние фракционных войн
        - Территориальный контроль
      events:
        - faction.war.started
        - faction.war.ended
        - territory.control.changed
      endpoints:
        - GET /api/v1/social/factions/{id}/stock-info - информация об акциях фракции

    - name: Economy Service Integration
      description: |
        Интеграция с экономикой:
        - Влияние на цены ресурсов
        - Курсы валют
        - Экономические кризисы
      events:
        - economy.crisis.started
        - economy.boom.started
        - currency.rate.changed
      endpoints:
        - GET /api/v1/economy/stock-impact - влияние биржи на экономику

    - name: Analytics Service Integration
      description: |
        Аналитика и метрики:
        - Player engagement метрики
        - Trading volume метрики
        - ROI метрики
        - Market health метрики
      events:
        - analytics.stock.metrics.calculated
        - analytics.stock.trend.detected
      endpoints:
        - GET /api/v1/analytics/stocks/engagement - метрики вовлеченности

  database:
    tables:
      - name: corporations
        description: Корпорации на бирже
        columns:
          - id: UUID PRIMARY KEY
          - symbol: VARCHAR(10) UNIQUE
          - name: VARCHAR(255)
          - sector: VARCHAR(100)
          - stock_type: VARCHAR(20) (Common, Preferred)
          - total_shares: BIGINT
          - ipo_date: TIMESTAMP
          - delisted_at: TIMESTAMP NULL
          - faction_id: UUID NULL
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: stock_prices
        description: История цен акций
        columns:
          - id: UUID PRIMARY KEY
          - corporation_id: UUID REFERENCES corporations(id)
          - price: DECIMAL(20, 4)
          - volume: BIGINT
          - high: DECIMAL(20, 4)
          - low: DECIMAL(20, 4)
          - open: DECIMAL(20, 4)
          - close: DECIMAL(20, 4)
          - timestamp: TIMESTAMP
          - event_id: UUID NULL
          - created_at: TIMESTAMP

      - name: stock_orders
        description: Ордера на покупку/продажу
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - corporation_id: UUID REFERENCES corporations(id)
          - order_type: VARCHAR(10) (BUY, SELL)
          - price_type: VARCHAR(10) (MARKET, LIMIT)
          - limit_price: DECIMAL(20, 4) NULL
          - quantity: BIGINT
          - filled_quantity: BIGINT DEFAULT 0
          - status: VARCHAR(20) (PENDING, PARTIAL, FILLED, CANCELLED)
          - time_in_force: VARCHAR(10) (GTC, IOC, FOK)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
          - expires_at: TIMESTAMP NULL

      - name: stock_trades
        description: Исполненные сделки
        columns:
          - id: UUID PRIMARY KEY
          - buy_order_id: UUID REFERENCES stock_orders(id)
          - sell_order_id: UUID REFERENCES stock_orders(id)
          - corporation_id: UUID REFERENCES corporations(id)
          - buyer_id: UUID
          - seller_id: UUID
          - price: DECIMAL(20, 4)
          - quantity: BIGINT
          - buyer_commission: DECIMAL(20, 4)
          - seller_commission: DECIMAL(20, 4)
          - executed_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: player_portfolios
        description: Портфели игроков
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - corporation_id: UUID REFERENCES corporations(id)
          - quantity: BIGINT
          - average_buy_price: DECIMAL(20, 4)
          - total_invested: DECIMAL(20, 4)
          - total_dividends_received: DECIMAL(20, 4)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: dividend_schedules
        description: Расписание дивидендов
        columns:
          - id: UUID PRIMARY KEY
          - corporation_id: UUID REFERENCES corporations(id)
          - dividend_type: VARCHAR(20) (QUARTERLY, ANNUAL)
          - amount_per_share: DECIMAL(20, 4)
          - declaration_date: DATE
          - ex_dividend_date: DATE
          - record_date: DATE
          - payment_date: DATE
          - status: VARCHAR(20) (SCHEDULED, DECLARED, PAID)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: dividend_payments
        description: Выплаты дивидендов
        columns:
          - id: UUID PRIMARY KEY
          - dividend_schedule_id: UUID REFERENCES dividend_schedules(id)
          - player_id: UUID
          - corporation_id: UUID REFERENCES corporations(id)
          - shares_owned: BIGINT
          - dividend_amount: DECIMAL(20, 4)
          - tax_amount: DECIMAL(20, 4)
          - net_amount: DECIMAL(20, 4)
          - reinvested: BOOLEAN DEFAULT FALSE
          - paid_at: TIMESTAMP
          - created_at: TIMESTAMP

      - name: stock_indices
        description: Биржевые индексы
        columns:
          - id: UUID PRIMARY KEY
          - name: VARCHAR(255)
          - symbol: VARCHAR(20) UNIQUE
          - calculation_method: VARCHAR(50) (PRICE_WEIGHTED, MARKET_CAP_WEIGHTED)
          - base_value: DECIMAL(20, 4)
          - current_value: DECIMAL(20, 4)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: index_constituents
        description: Состав индексов
        columns:
          - id: UUID PRIMARY KEY
          - index_id: UUID REFERENCES stock_indices(id)
          - corporation_id: UUID REFERENCES corporations(id)
          - weight: DECIMAL(10, 6)
          - added_at: TIMESTAMP
          - removed_at: TIMESTAMP NULL

      - name: index_history
        description: История индексов
        columns:
          - id: UUID PRIMARY KEY
          - index_id: UUID REFERENCES stock_indices(id)
          - value: DECIMAL(20, 4)
          - change: DECIMAL(20, 4)
          - change_percent: DECIMAL(10, 4)
          - timestamp: TIMESTAMP
          - created_at: TIMESTAMP

      - name: stock_events_impact
        description: Влияние событий на акции
        columns:
          - id: UUID PRIMARY KEY
          - event_id: UUID
          - event_type: VARCHAR(50)
          - corporation_id: UUID REFERENCES corporations(id)
          - impact_percent: DECIMAL(10, 4)
          - base_price: DECIMAL(20, 4)
          - new_price: DECIMAL(20, 4)
          - duration_hours: INTEGER
          - started_at: TIMESTAMP
          - ended_at: TIMESTAMP NULL
          - created_at: TIMESTAMP

      - name: compliance_alerts
        description: Алерты о нарушениях
        columns:
          - id: UUID PRIMARY KEY
          - player_id: UUID
          - alert_type: VARCHAR(50)
          - severity: VARCHAR(20) (LOW, MEDIUM, HIGH, CRITICAL)
          - description: TEXT
          - trade_id: UUID NULL
          - status: VARCHAR(20) (OPEN, INVESTIGATING, RESOLVED)
          - created_at: TIMESTAMP
          - resolved_at: TIMESTAMP NULL

  event_bus:
    topics:
      - name: economy.stocks.order.created
        description: Создан новый ордер
        schema:
          order_id: UUID
          player_id: UUID
          corporation_id: UUID
          order_type: string
          quantity: number
          price: number

      - name: economy.stocks.order.matched
        description: Ордер исполнен
        schema:
          trade_id: UUID
          buy_order_id: UUID
          sell_order_id: UUID
          price: number
          quantity: number

      - name: economy.stocks.price.updated
        description: Обновлена цена акции
        schema:
          corporation_id: UUID
          symbol: string
          old_price: number
          new_price: number
          change_percent: number

      - name: economy.stocks.dividend.declared
        description: Объявлены дивиденды
        schema:
          dividend_schedule_id: UUID
          corporation_id: UUID
          amount_per_share: number
          payment_date: timestamp

      - name: economy.stocks.dividend.paid
        description: Выплачены дивиденды
        schema:
          dividend_payment_id: UUID
          player_id: UUID
          corporation_id: UUID
          amount: number

      - name: economy.stocks.index.rebalanced
        description: Перебалансирован индекс
        schema:
          index_id: UUID
          old_value: number
          new_value: number
          change_percent: number

      - name: economy.stocks.compliance.alert
        description: Алерт о нарушении
        schema:
          alert_id: UUID
          player_id: UUID
          alert_type: string
          severity: string

  websocket:
    channels:
      - name: stocks.{symbol}.price
        description: Realtime обновления цены акции
      - name: stocks.portfolio.{player_id}
        description: Realtime обновления портфеля игрока
      - name: stocks.market.summary
        description: Общая сводка рынка
      - name: stocks.indices.{index_symbol}
        description: Realtime обновления индекса

  technical_tasks:
    phases:
      phase_1:
        name: Базовая инфраструктура
        tasks:
          - Создание таблиц БД
          - Настройка миграций Liquibase
          - Базовая структура economy-service для stocks
          - Интеграция с Event Bus
          - Настройка Redis для кэширования
        estimated_effort: 5 days

      phase_2:
        name: Торговый движок
        tasks:
          - Реализация Order Book Manager
          - Реализация Stock Trading Engine
          - Реализация Trade Executor
          - Реализация Portfolio Manager
          - Тестирование matching логики
        estimated_effort: 8 days

      phase_3:
        name: Pricing Engine
        tasks:
          - Реализация Stock Pricing Engine
          - Расчет цен на основе спроса/предложения
          - История цен
          - Realtime обновления через WebSocket
        estimated_effort: 5 days

      phase_4:
        name: Dividend Service
        tasks:
          - Реализация Dividend Calculator
          - Реализация Dividend Scheduler
          - Реализация DRIP Manager
          - Интеграция с Event Scheduler Service
          - Автоматические выплаты
        estimated_effort: 6 days

      phase_5:
        name: Events Handler
        tasks:
          - Реализация Stock Events Handler
          - Подписка на world events
          - Подписка на quest events
          - Расчет price impact
          - Применение модификаторов
        estimated_effort: 5 days

      phase_6:
        name: Analytics Service
        tasks:
          - Реализация Index Calculator
          - Реализация Metrics Calculator
          - Реализация Technical Analyzer
          - Расчет индексов
          - Перебалансировка
        estimated_effort: 6 days

      phase_7:
        name: Compliance Service
        tasks:
          - Реализация Trade Monitor
          - Реализация Insider Trading Detector
          - Реализация Circuit Breaker Manager
          - Лимиты на позиции
          - Алерты и блокировки
        estimated_effort: 5 days

      phase_8:
        name: Интеграции
        tasks:
          - Интеграция с World Service
          - Интеграция с Quest Service
          - Интеграция с Social Service
          - Интеграция с Analytics Service
          - WebSocket каналы
        estimated_effort: 4 days

    total_estimated_effort: 44 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> EconomyService[Economy Service<br/>8085]
        Gateway --> DividendService[Dividend Service<br/>8088]
        Gateway --> AnalyticsService[Stock Analytics Service<br/>8089]
        Gateway --> ComplianceService[Compliance Service<br/>8091]
        
        EconomyService --> STE[Stock Trading Engine]
        EconomyService --> SPE[Stock Pricing Engine]
        EconomyService --> PM[Portfolio Manager]
        EconomyService --> CR[Corporation Registry]
        EconomyService --> OBM[Order Book Manager]
        EconomyService --> TE[Trade Executor]
        
        DividendService --> DC[Dividend Calculator]
        DividendService --> DS[Dividend Scheduler]
        DividendService --> DRIP[DRIP Manager]
        DividendService --> DD[Dividend Distributor]
        
        AnalyticsService --> IC[Index Calculator]
        AnalyticsService --> MC[Metrics Calculator]
        AnalyticsService --> TA[Technical Analyzer]
        
        ComplianceService --> TM[Trade Monitor]
        ComplianceService --> ITD[Insider Trading Detector]
        ComplianceService --> CBM[Circuit Breaker Manager]
        
        EconomyService --> WorldService[World Service<br/>8086]
        EconomyService --> QuestService[Quest Service]
        EconomyService --> SocialService[Social Service<br/>8084]
        
        EconomyService --> EventBus[Event Bus<br/>Kafka]
        DividendService --> EventBus
        AnalyticsService --> EventBus
        ComplianceService --> EventBus
        
        EconomyService --> DB[(Stock Exchange DB)]
        DividendService --> DB
        AnalyticsService --> DB
        ComplianceService --> DB
        
        EconomyService --> Cache[(Redis Cache)]
        EconomyService --> WalletService[Wallet Service]
        EconomyService --> NotificationService[Notification Service]
        
        Client --> WSStocks[WebSocket<br/>Stock Prices]
        WSStocks --> EconomyService
    ```

  trading_flow: |
    ```mermaid
    sequenceDiagram
        participant Client
        participant EconomyService
        participant OrderBook
        participant TradingEngine
        participant Portfolio
        participant Wallet
        participant EventBus
        
        Client->>EconomyService: POST /orders (BUY)
        EconomyService->>OrderBook: Add order
        OrderBook->>TradingEngine: Check for matches
        TradingEngine->>OrderBook: Find matching SELL order
        TradingEngine->>Portfolio: Update buyer portfolio
        TradingEngine->>Portfolio: Update seller portfolio
        TradingEngine->>Wallet: Transfer funds
        TradingEngine->>Wallet: Charge commissions
        TradingEngine->>EventBus: Publish trade.matched
        TradingEngine->>EventBus: Publish price.updated
        EconomyService->>Client: Order executed
    ```

  dividend_flow: |
    ```mermaid
    sequenceDiagram
        participant Scheduler
        participant DividendService
        participant Calculator
        participant Portfolio
        participant Wallet
        participant EventBus
        
        Scheduler->>DividendService: Payment date reached
        DividendService->>Calculator: Calculate dividends
        Calculator->>Portfolio: Get shareholders
        Calculator->>Calculator: Calculate per player
        DividendService->>Wallet: Transfer dividends
        DividendService->>EventBus: Publish dividend.paid
        DividendService->>NotificationService: Notify players
    ```

  event_impact_flow: |
    ```mermaid
    sequenceDiagram
        participant WorldService
        participant EventBus
        participant StockEventsHandler
        participant PricingEngine
        participant EconomyService
        participant Client
        
        WorldService->>EventBus: world.event.started
        EventBus->>StockEventsHandler: Event notification
        StockEventsHandler->>StockEventsHandler: Calculate impact
        StockEventsHandler->>PricingEngine: Apply price modifier
        PricingEngine->>EconomyService: Update prices
        EconomyService->>EventBus: Publish price.updated
        EconomyService->>Client: WebSocket notification
    ```




