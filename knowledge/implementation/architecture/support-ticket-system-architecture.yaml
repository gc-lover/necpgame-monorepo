metadata:
  id: support-ticket-system-architecture
  title: Архитектура системы тикетов поддержки
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T23:59:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - operations
    - support
    - tickets
  related_systems:
    - support-service
    - notification-service
    - accounts-service
    - analytics-service
  related_documents:
    - id: support-ticket-system
      relation: implements
  github_issue: 334
  visibility: internal
  audience:
    - architect
    - backend
    - operations
    - support
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы тикетов поддержки, включающую:
    - Обработку обращений игроков
    - Контроль приоритетов и SLA
    - Очереди агентов
    - Автокатегоризацию
    - Уведомления
    - Мониторинг SLA
  goal: |
    Создать архитектурную схему системы тикетов поддержки с определением:
    - Компонентов для управления тикетами
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы тикетов поддержки с поддержкой создания тикетов,
    автокатегоризации, назначения приоритетов, очередей агентов и SLA мониторинга.

architecture:
  overview: |
    Архитектура системы тикетов поддержки состоит из следующих компонентов:
    1. Support Ticket Manager - управление системой тикетов
    2. Ticket Creator - создание тикетов
    3. Auto Categorization Engine - автокатегоризация тикетов
    4. Priority Assignment Engine - назначение приоритетов
    5. Agent Queue Manager - управление очередями агентов
    6. SLA Monitor - мониторинг SLA
    7. Ticket Response Manager - управление ответами
    8. Ticket Status Manager - управление статусами
    9. Support Analytics Collector - сбор аналитики
    10. Support Telemetry Collector - сбор телеметрии

  microservices:
    - name: support-service
      port: 8095
      responsibility: |
        Обработка системы тикетов поддержки:
        - Управление системой тикетов
        - Создание тикетов
        - Автокатегоризация тикетов
        - Назначение приоритетов
        - Управление очередями агентов
        - Мониторинг SLA
        - Управление ответами
        - Управление статусами
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - support-ticket-manager: управление системой тикетов
        - ticket-creator: создание тикетов
        - auto-categorization-engine: автокатегоризация тикетов
        - priority-assignment-engine: назначение приоритетов
        - agent-queue-manager: управление очередями агентов
        - sla-monitor: мониторинг SLA
        - ticket-response-manager: управление ответами
        - ticket-status-manager: управление статусами
        - support-analytics-collector: сбор аналитики
        - support-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/support/tickets - список тикетов
        - GET /api/v1/support/tickets/{ticketId} - информация о тикете
        - POST /api/v1/support/tickets - создание тикета
        - PUT /api/v1/support/tickets/{ticketId} - обновление тикета
        - DELETE /api/v1/support/tickets/{ticketId} - удаление тикета
        - POST /api/v1/support/tickets/{ticketId}/assign - назначение агента
        - POST /api/v1/support/tickets/{ticketId}/status - изменение статуса
        - POST /api/v1/support/tickets/{ticketId}/priority - изменение приоритета
        - GET /api/v1/support/tickets/{characterId}/my-tickets - тикеты персонажа
        - GET /api/v1/support/tickets/{agentId}/assigned - назначенные тикеты агента
        - GET /api/v1/support/tickets/queue - очередь тикетов
        - POST /api/v1/support/tickets/{ticketId}/responses - добавление ответа
        - GET /api/v1/support/tickets/{ticketId}/responses - список ответов
        - POST /api/v1/support/tickets/{ticketId}/rate - оценка тикета
        - GET /api/v1/support/tickets/{ticketId}/sla - информация о SLA
        - GET /api/v1/support/tickets/stats - статистика тикетов
      websocket_channels:
        - wss://api.necp.game/v1/support/tickets/{ticketId} - поток обновлений тикета
        - wss://api.necp.game/v1/support/agents/{agentId}/queue - поток очереди агента
      events_published:
        - support.ticket.created: создан тикет
        - support.ticket.updated: обновлен тикет
        - support.ticket.assigned: назначен агент
        - support.ticket.status-changed: изменен статус
        - support.ticket.priority-changed: изменен приоритет
        - support.ticket.response-added: добавлен ответ
        - support.ticket.rated: оценен тикет
        - support.ticket.sla-warning: предупреждение SLA
        - support.ticket.sla-breach: нарушение SLA
      events_subscribed:
        - character.created: создан персонаж
        - character.banned: забанен персонаж
        - payment.failed: неудачный платеж
        - bug.reported: сообщен баг

  ticket_categories:
    - name: technical
      description: "Технические проблемы - баги, лаги, краши"
      auto_categorization_keywords: ["bug", "crash", "lag", "error", "glitch"]

    - name: account
      description: "Проблемы с аккаунтом - вход, восстановление, безопасность"
      auto_categorization_keywords: ["login", "password", "account", "security", "hack"]

    - name: payment
      description: "Проблемы с платежами - оплата, возврат, подписка"
      auto_categorization_keywords: ["payment", "refund", "subscription", "purchase", "money"]

    - name: gameplay
      description: "Вопросы по геймплею - механики, баланс, прогресс"
      auto_categorization_keywords: ["gameplay", "balance", "progress", "quest", "skill"]

    - name: social
      description: "Социальные вопросы - гильдии, друзья, чат"
      auto_categorization_keywords: ["guild", "friend", "chat", "social", "party"]

    - name: report
      description: "Жалобы - читеры, токсичность, нарушение правил"
      auto_categorization_keywords: ["cheat", "toxic", "report", "abuse", "violation"]

    - name: suggestion
      description: "Предложения - идеи, фичи, улучшения"
      auto_categorization_keywords: ["suggestion", "idea", "feature", "improvement", "wish"]

    - name: other
      description: "Прочее - все остальные вопросы"
      auto_categorization_keywords: []

  ticket_priorities:
    - name: low
      description: "Низкий приоритет - не срочные вопросы"
      sla_response_time: "24 hours"
      sla_resolution_time: "7 days"
      auto_assignment_rules:
        - category: suggestion
        - category: other

    - name: medium
      description: "Средний приоритет - стандартные вопросы"
      sla_response_time: "12 hours"
      sla_resolution_time: "3 days"
      auto_assignment_rules:
        - category: gameplay
        - category: social

    - name: high
      description: "Высокий приоритет - важные вопросы"
      sla_response_time: "4 hours"
      sla_resolution_time: "1 day"
      auto_assignment_rules:
        - category: account
        - category: payment

    - name: critical
      description: "Критический приоритет - срочные проблемы"
      sla_response_time: "1 hour"
      sla_resolution_time: "4 hours"
      auto_assignment_rules:
        - category: technical
        - keywords: ["crash", "hack", "security"]

  ticket_statuses:
    - name: open
      description: "Открыт - ожидает назначения агента"
      next_statuses: ["assigned", "closed"]

    - name: assigned
      description: "Назначен - назначен агент, ожидает ответа"
      next_statuses: ["in_progress", "waiting_for_player", "closed"]

    - name: in_progress
      description: "В работе - агент работает над тикетом"
      next_statuses: ["waiting_for_player", "resolved", "closed"]

    - name: waiting_for_player
      description: "Ожидает ответа игрока - агент ждет ответа"
      next_statuses: ["in_progress", "resolved", "closed"]

    - name: resolved
      description: "Решен - проблема решена, ожидает подтверждения"
      next_statuses: ["closed"]

    - name: closed
      description: "Закрыт - тикет закрыт"
      next_statuses: []

  agent_queues:
    types:
      - name: round_robin
        description: "Круговая очередь - равномерное распределение"
        assignment_strategy: "round_robin"

      - name: least_busy
        description: "Наименее загруженный - по количеству активных тикетов"
        assignment_strategy: "least_busy"

      - name: skill_based
        description: "По навыкам - по категориям и экспертизе"
        assignment_strategy: "skill_based"

      - name: priority_based
        description: "По приоритету - критичные тикеты первыми"
        assignment_strategy: "priority_based"

    rules:
      - max_tickets_per_agent: 10
      - max_critical_tickets_per_agent: 3
      - auto_reassign_timeout: "2 hours"
      - queue_refresh_interval: "5 minutes"

  sla_monitoring:
    metrics:
      - first_response_time: "время первого ответа"
      - resolution_time: "время решения"
      - agent_response_time: "время ответа агента"
      - player_response_time: "время ответа игрока"

    thresholds:
      - metric: first_response_time
        warning: "80% от SLA"
        breach: "100% от SLA"

      - metric: resolution_time
        warning: "80% от SLA"
        breach: "100% от SLA"

    actions:
      - warning: "уведомление агента и супервайзера"
      - breach: "эскалация супервайзеру, уведомление менеджмента"

  data_flows:
    ticket_creation_flow: |
      1. Игрок создает тикет через API
      2. Ticket Creator валидирует данные тикета
      3. Auto Categorization Engine определяет категорию
      4. Priority Assignment Engine назначает приоритет
      5. Support Ticket Manager сохраняет тикет в БД
      6. Agent Queue Manager добавляет тикет в очередь
      7. Support Ticket Manager публикует событие support.ticket.created
      8. Notification Service отправляет уведомление игроку
      9. SLA Monitor начинает отслеживание SLA

    ticket_assignment_flow: |
      1. Agent Queue Manager выбирает тикет из очереди
      2. Agent Queue Manager выбирает агента по стратегии
      3. Agent Queue Manager проверяет лимиты агента
      4. Support Ticket Manager назначает агента тикету
      5. Support Ticket Manager обновляет статус на "assigned"
      6. Support Ticket Manager публикует событие support.ticket.assigned
      7. Notification Service отправляет уведомление агенту
      8. Notification Service отправляет уведомление игроку
      9. SLA Monitor обновляет метрики

    ticket_response_flow: |
      1. Агент или игрок добавляет ответ через API
      2. Ticket Response Manager валидирует ответ
      3. Ticket Response Manager сохраняет ответ в БД
      4. Ticket Status Manager обновляет статус тикета
      5. Support Ticket Manager публикует событие support.ticket.response-added
      6. Notification Service отправляет уведомление получателю
      7. SLA Monitor обновляет метрики ответа
      8. Realtime Gateway отправляет обновление клиентам

    sla_monitoring_flow: |
      1. SLA Monitor периодически проверяет активные тикеты
      2. SLA Monitor вычисляет метрики для каждого тикета
      3. SLA Monitor сравнивает метрики с порогами
      4. При достижении warning порога - отправляет предупреждение
      5. При достижении breach порога - эскалирует тикет
      6. Support Ticket Manager публикует событие support.ticket.sla-warning или support.ticket.sla-breach
      7. Notification Service отправляет уведомления
      8. Analytics Service собирает метрики SLA

  database_structure:
    tables:
      - name: support_tickets
        description: Тикеты поддержки
        columns:
          - id: UUID PRIMARY KEY
          - ticket_number: VARCHAR(20) UNIQUE
          - character_id: UUID FOREIGN KEY
          - category: ENUM (technical, account, payment, gameplay, social, report, suggestion, other)
          - priority: ENUM (low, medium, high, critical)
          - status: ENUM (open, assigned, in_progress, waiting_for_player, resolved, closed)
          - assigned_agent_id: UUID FOREIGN KEY
          - subject: VARCHAR(255)
          - description: TEXT
          - attachments: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
          - first_response_at: TIMESTAMP
          - resolved_at: TIMESTAMP
          - closed_at: TIMESTAMP
          - sla_response_deadline: TIMESTAMP
          - sla_resolution_deadline: TIMESTAMP
          - rating: INTEGER
          - rating_comment: TEXT

      - name: ticket_responses
        description: Ответы на тикеты
        columns:
          - id: UUID PRIMARY KEY
          - ticket_id: UUID FOREIGN KEY
          - author_id: UUID FOREIGN KEY
          - author_type: ENUM (player, agent)
          - content: TEXT
          - attachments: JSONB
          - is_internal: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: agent_queues
        description: Очереди агентов
        columns:
          - id: UUID PRIMARY KEY
          - agent_id: UUID FOREIGN KEY
          - queue_type: ENUM (round_robin, least_busy, skill_based, priority_based)
          - active_tickets_count: INTEGER
          - max_tickets: INTEGER
          - skills: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: ticket_sla_metrics
        description: Метрики SLA тикетов
        columns:
          - id: UUID PRIMARY KEY
          - ticket_id: UUID FOREIGN KEY
          - metric_type: VARCHAR(50)
          - metric_value: INTEGER
          - threshold_warning: INTEGER
          - threshold_breach: INTEGER
          - status: ENUM (ok, warning, breach)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: support_telemetry
        description: Телеметрия поддержки
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - ticket_id: UUID FOREIGN KEY
          - agent_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    notification_service: |
      - Уведомления о создании тикета
      - Уведомления о назначении агента
      - Уведомления о новых ответах
      - Уведомления об изменении статуса
      - Уведомления о SLA предупреждениях

    accounts_service: |
      - Получение информации об аккаунте
      - Проверка статуса аккаунта
      - Валидация доступа к тикетам

    character_service: |
      - Получение информации о персонаже
      - Проверка статуса персонажа
      - Валидация доступа к тикетам

    analytics_service: |
      - Логирование всех операций с тикетами
      - Сбор метрик эффективности
      - Анализ паттернов обращений
      - Мониторинг SLA

    realtime_gateway: |
      - Отправка realtime обновлений тикетов
      - Уведомления о новых ответах
      - Синхронизация очереди агентов

technical_specification:
  subtasks:
    - id: support-ticket-manager
      title: Реализация менеджера системы тикетов
      description: |
        Реализация Support Ticket Manager с управлением системой тикетов
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 5 days

    - id: ticket-creator
      title: Реализация создателя тикетов
      description: |
        Реализация Ticket Creator с созданием тикетов,
        валидацией данных и генерацией номеров.
      dependencies: [support-ticket-manager]
      estimated_effort: 3 days

    - id: auto-categorization-engine
      title: Реализация движка автокатегоризации
      description: |
        Реализация Auto Categorization Engine с определением категорий,
        анализом ключевых слов и машинным обучением.
      dependencies: [support-ticket-manager]
      estimated_effort: 5 days

    - id: priority-assignment-engine
      title: Реализация движка назначения приоритетов
      description: |
        Реализация Priority Assignment Engine с назначением приоритетов,
        применением правил и анализом контента.
      dependencies: [support-ticket-manager]
      estimated_effort: 4 days

    - id: agent-queue-manager
      title: Реализация менеджера очередей агентов
      description: |
        Реализация Agent Queue Manager с управлением очередями,
        назначением агентов и стратегиями распределения.
      dependencies: [support-ticket-manager]
      estimated_effort: 5 days

    - id: sla-monitor
      title: Реализация монитора SLA
      description: |
        Реализация SLA Monitor с мониторингом SLA,
        вычислением метрик и отправкой предупреждений.
      dependencies: [support-ticket-manager]
      estimated_effort: 4 days

    - id: ticket-response-manager
      title: Реализация менеджера ответов
      description: |
        Реализация Ticket Response Manager с управлением ответами,
        валидацией и управлением видимостью.
      dependencies: [support-ticket-manager]
      estimated_effort: 3 days

    - id: ticket-status-manager
      title: Реализация менеджера статусов
      description: |
        Реализация Ticket Status Manager с управлением статусами,
        валидацией переходов и обновлением метрик.
      dependencies: [support-ticket-manager]
      estimated_effort: 3 days

    - id: support-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Support Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [support-ticket-manager]
      estimated_effort: 3 days

    - id: support-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Support Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [support-ticket-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений тикетов,
        очереди агентов и уведомлений.
      dependencies: [support-ticket-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы тикетов.
      dependencies: [support-ticket-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для тикетов, ответов, очередей агентов,
        метрик SLA и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> SupportService[Support Service<br/>8095]
        
        SupportService --> STM[Support Ticket Manager]
        SupportService --> TC[Ticket Creator]
        SupportService --> ACE[Auto Categorization Engine]
        SupportService --> PAE[Priority Assignment Engine]
        SupportService --> AQM[Agent Queue Manager]
        SupportService --> SLAM[SLA Monitor]
        SupportService --> TRM[Ticket Response Manager]
        SupportService --> TSM[Ticket Status Manager]
        SupportService --> SAC[Support Analytics Collector]
        SupportService --> STC[Support Telemetry Collector]
        
        STM --> TC
        STM --> ACE
        STM --> PAE
        STM --> AQM
        STM --> SLAM
        STM --> TRM
        STM --> TSM
        
        SupportService --> NotificationService[Notification Service]
        SupportService --> AccountsService[Accounts Service]
        SupportService --> CharacterService[Character Service]
        SupportService --> AnalyticsService[Analytics Service]
        
        SupportService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        SupportService --> DB[(Support DB)]
        
        Client --> WSTickets[WebSocket<br/>Tickets]
        WSTickets --> SupportService
    ```

  ticket_creation_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Player as Player
        participant TC as Ticket Creator
        participant ACE as Auto Categorization Engine
        participant PAE as Priority Assignment Engine
        participant STM as Support Ticket Manager
        participant AQM as Agent Queue Manager
        participant SLAM as SLA Monitor
        participant NS as Notification Service
        
        Player->>TC: Create ticket
        TC->>TC: Validate data
        TC->>ACE: Categorize ticket
        ACE->>ACE: Analyze keywords
        ACE->>TC: Return category
        TC->>PAE: Assign priority
        PAE->>PAE: Apply rules
        PAE->>TC: Return priority
        TC->>STM: Save ticket
        STM->>STM: Generate ticket number
        STM->>AQM: Add to queue
        STM->>SLAM: Start SLA monitoring
        STM->>NS: Notify player
    ```

  ticket_assignment_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant AQM as Agent Queue Manager
        participant STM as Support Ticket Manager
        participant NS as Notification Service
        participant SLAM as SLA Monitor
        
        AQM->>AQM: Select ticket from queue
        AQM->>AQM: Select agent by strategy
        AQM->>AQM: Check agent limits
        AQM->>STM: Assign agent
        STM->>STM: Update status to assigned
        STM->>NS: Notify agent
        STM->>NS: Notify player
        STM->>SLAM: Update metrics
    ```
