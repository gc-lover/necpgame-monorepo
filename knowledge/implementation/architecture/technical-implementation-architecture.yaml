metadata:
  id: technical-implementation-architecture
  title: Архитектура технической реализации NECPGAME
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T14:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - implementation
    - backend
    - frontend
    - infrastructure
    - api
    - database
  related_systems:
    - api-gateway
    - auth-service
    - character-service
    - gameplay-service
    - economy-service
    - social-service
    - world-service
    - progression-service
    - realtime-gateway
  related_documents:
    - id: implementation-tech-stack
      relation: implements
    - id: backend-architecture-compact
      relation: extends
    - id: microservices-overview
      relation: extends
  github_issue: 106
  visibility: internal
  audience:
    - architect
    - backend
    - frontend
    - devops
    - api-designer

summary:
  problem: |
    Требуется спроектировать общую архитектуру технической реализации, охватывающую:
    - Backend Systems (100+ документов) - все бэкенд системы
    - UI (17 документов) - интерфейсы пользователя
    - API (30+ документов) - спецификации API
    - Database - схемы и миграции
    - Content Generation - генерация контента
    - MVP - минимально жизнеспособный продукт
    - Infrastructure - инфраструктура и DevOps
    - Networking - сетевая архитектура
    - Analytics - аналитика и телеметрия
  goal: |
    Создать архитектурную схему технической реализации с определением:
    - Общей архитектуры системы
    - Инфраструктурных компонентов
    - Микросервисов и их взаимодействий
    - Клиентской архитектуры
    - Стратегии данных
    - DevOps и мониторинга
    - Технического задания для реализации
  essence: |
    Объединенная архитектура технической реализации с распределением по слоям:
    клиент, API Gateway, микросервисы, базы данных, инфраструктура.

architecture:
  overview: |
    Техническая архитектура NECPGAME построена на микросервисной архитектуре
    с разделением на следующие слои:
    1. Client Layer - Unreal Engine 5 клиент
    2. API Gateway Layer - единая точка входа
    3. Service Layer - доменные микросервисы
    4. Data Layer - базы данных и хранилища
    5. Infrastructure Layer - оркестрация и мониторинг
    6. Integration Layer - event bus и межсервисная коммуникация

  technology_stack:
    backend:
      language: Java 21
      framework: Spring Boot 3.3.x, Spring Cloud 2024.x
      rpc: gRPC + Protobuf 3.21+
      databases:
        - PostgreSQL 15 (основные данные)
        - Redis 7 Cluster (кэш, сессии)
        - ClickHouse 23.x (аналитика)
        - OpenSearch 2.12 (поиск)
      messaging: Apache Kafka 3.7 + Schema Registry
      storage: S3/MinIO (медиа, логи)
    
    client:
      engine: Unreal Engine 5.4
      networking: QUIC/UDP (бои), WebSocket (лобби)
      serialization: Protobuf (protobuf-cpp 21.x)
    
    infrastructure:
      orchestration: Kubernetes 1.30, Helm, ArgoCD
      gateway: Envoy 1.31
      ci_cd: GitHub Actions
      iac: Terraform
      observability: OpenTelemetry 1.33, Prometheus, Grafana, Loki, Tempo

  layers:
    - name: client-layer
      description: |
        Клиентский слой на Unreal Engine 5:
        - QUIC/UDP для боевых действий и инстансов
        - WebSocket для лобби, чата и социальных систем
        - Protobuf для сериализации
        - Адаптивная частота обновлений на основе QoS
      components:
        - ue5-game-client: основной игровой клиент
        - quic-client: QUIC клиент для боевых действий
        - websocket-client: WebSocket клиент для лобби
        - protobuf-codec: кодирование/декодирование Protobuf
        - qos-manager: управление качеством соединения

    - name: api-gateway-layer
      description: |
        Слой API Gateway:
        - Единая точка входа для всех запросов
        - Маршрутизация к микросервисам
        - Аутентификация и авторизация
        - Rate limiting и защита от DDoS
        - Load balancing
      components:
        - api-gateway: основной gateway (Envoy)
        - auth-filter: фильтр аутентификации
        - rate-limiter: ограничение частоты запросов
        - load-balancer: балансировка нагрузки
        - routing-engine: маршрутизация запросов

    - name: service-layer
      description: |
        Слой микросервисов:
        - Доменные сервисы для каждой области
        - Независимое развертывание и масштабирование
        - Service discovery через Eureka
        - Конфигурация через Config Server
      services:
        - auth-service: аутентификация и авторизация
        - character-service: управление персонажами
        - gameplay-service: игровой процесс и боевая система
        - economy-service: экономика и торговля
        - social-service: социальные системы
        - world-service: мир и события
        - progression-service: прогрессия персонажа
        - realtime-gateway-go: realtime коммуникация (Go)
        - matchmaking-go: матчмейкинг (Go)
        - ws-lobby-go: WebSocket лобби (Go)

    - name: data-layer
      description: |
        Слой данных:
        - PostgreSQL для основных данных
        - Redis для кэша и сессий
        - ClickHouse для аналитики
        - OpenSearch для поиска
        - S3/MinIO для медиа и логов
      components:
        - postgres-cluster: кластер PostgreSQL
        - redis-cluster: кластер Redis
        - clickhouse-cluster: кластер ClickHouse
        - opensearch-cluster: кластер OpenSearch
        - s3-storage: объектное хранилище

    - name: infrastructure-layer
      description: |
        Инфраструктурный слой:
        - Kubernetes для оркестрации
        - Helm для управления релизами
        - ArgoCD для GitOps
        - Мониторинг и логирование
        - CI/CD пайплайны
      components:
        - kubernetes-cluster: кластер Kubernetes
        - helm-charts: Helm чарты для сервисов
        - argocd: GitOps инструмент
        - prometheus: метрики
        - grafana: визуализация метрик
        - loki: логи
        - tempo: трейсинг

    - name: integration-layer
      description: |
        Слой интеграций:
        - Event Bus (Kafka) для асинхронной коммуникации
        - Transactional Outbox для надежной доставки событий
        - Service Discovery для обнаружения сервисов
        - Config Server для централизованной конфигурации
      components:
        - kafka-cluster: кластер Kafka
        - schema-registry: реестр схем
        - eureka: service discovery
        - config-server: сервер конфигурации
        - outbox-processor: обработка outbox паттерна

  microservices:
    - name: auth-service
      port: 8081
      responsibility: Аутентификация и авторизация
      database:
        postgres (schema: auth)
      endpoints_base: /api/v1/auth
      integrations:
        - Keycloak для OIDC
        - Redis для сессий
        - Event Bus для событий регистрации

    - name: character-service
      port: 8082
      responsibility: Управление персонажами
      database:
        postgres (schema: characters)
      endpoints_base: /api/v1/characters
      integrations:
        - Progression Service для атрибутов
        - Economy Service для инвентаря
        - Event Bus для событий персонажей

    - name: gameplay-service
      port: 8083
      responsibility: Игровой процесс и боевая система
      database:
        postgres (schema: gameplay)
      endpoints_base: /api/v1/gameplay
      integrations:
        - Realtime Gateway для боевых действий
        - Progression Service для опыта
        - Economy Service для лута
        - Event Bus для событий боя

    - name: social-service
      port: 8084
      responsibility: Социальные системы
      database:
        postgres (schema: social)
      endpoints_base: /api/v1/social
      integrations:
        - Character Service для данных игроков
        - Economy Service для экономики гильдий
        - Event Bus для социальных событий

    - name: economy-service
      port: 8085
      responsibility: Экономика и торговля
      database:
        postgres (schema: economy)
      endpoints_base: /api/v1/economy
      integrations:
        - Character Service для инвентаря
        - Social Service для гильдий
        - Event Bus для экономических событий

    - name: world-service
      port: 8086
      responsibility: Мир и события
      database:
        postgres (schema: world)
      endpoints_base: /api/v1/world
      integrations:
        - Gameplay Service для рейдов
        - Economy Service для наград
        - Event Bus для мировых событий

    - name: progression-service
      port: 8087
      responsibility: Прогрессия персонажа
      database:
        postgres (schema: progression)
      endpoints_base: /api/v1/progression
      integrations:
        - Character Service для обновления атрибутов
        - Event Bus для событий прогрессии

    - name: realtime-gateway-go
      port: 8080
      responsibility: Realtime коммуникация (QUIC/UDP)
      technology: Go
      protocol: QUIC/UDP
      integrations:
        - Gameplay Service для боевых действий
        - Matchmaking для инстансов

    - name: matchmaking-go
      port: 8088
      responsibility: Матчмейкинг
      technology: Go
      database: redis
      integrations:
        - Gameplay Service для создания сессий
        - Realtime Gateway для подключения игроков

    - name: ws-lobby-go
      port: 8089
      responsibility: WebSocket лобби
      technology: Go
      protocol: WebSocket
      integrations:
        - Social Service для чата
        - Character Service для списка друзей

  data_flows:
    client_to_service_flow: |
      1. Клиент отправляет запрос через QUIC или WebSocket
      2. Запрос проходит через API Gateway
      3. API Gateway проверяет аутентификацию через Auth Service
      4. API Gateway маршрутизирует запрос к нужному сервису
      5. Сервис обрабатывает запрос
      6. Сервис публикует события в Event Bus (если необходимо)
      7. Сервис возвращает ответ через API Gateway
      8. API Gateway отправляет ответ клиенту

    service_to_service_flow: |
      1. Сервис A нуждается в данных от Сервиса B
      2. Сервис A делает синхронный вызов через gRPC или REST
      3. Service Discovery (Eureka) находит адрес Сервиса B
      4. Сервис B обрабатывает запрос
      5. Сервис B возвращает ответ Сервису A
      6. При необходимости Сервис B публикует событие в Event Bus

    event_driven_flow: |
      1. Сервис A выполняет действие
      2. Сервис A создает событие и сохраняет в outbox таблицу
      3. Outbox Processor читает событие из outbox
      4. Outbox Processor публикует событие в Kafka
      5. Сервисы B, C подписанные на событие получают его
      6. Сервисы B, C обрабатывают событие асинхронно
      7. При необходимости сервисы публикуют новые события

    realtime_combat_flow: |
      1. Игрок выполняет боевое действие в клиенте
      2. Клиент отправляет действие через QUIC в Realtime Gateway
      3. Realtime Gateway валидирует действие
      4. Realtime Gateway отправляет в Gameplay Service для обработки
      5. Gameplay Service обрабатывает действие и обновляет состояние
      6. Gameplay Service публикует событие в Event Bus
      7. Realtime Gateway получает обновление состояния
      8. Realtime Gateway отправляет обновление всем игрокам в зоне
      9. Клиенты получают обновление и синхронизируют состояние

  database_strategy:
    per_service_database: |
      Каждый микросервис имеет свою схему в PostgreSQL:
      - auth - для auth-service
      - characters - для character-service
      - gameplay - для gameplay-service
      - social - для social-service
      - economy - для economy-service
      - world - для world-service
      - progression - для progression-service
      - mvp_core - общие справочники
      - mvp_meta - метаданные и outbox

    data_consistency: |
      - Синхронные операции: через транзакции в рамках одного сервиса
      - Асинхронные операции: через Saga паттерн и Event Bus
      - Eventual consistency: для межсервисных операций
      - Transactional Outbox: для надежной доставки событий

    migrations: |
      - Liquibase для управления миграциями
      - Версионирование миграций (V1_0..V1_5)
      - Отдельные changelog файлы для каждого сервиса
      - Автоматическое применение при деплое

  infrastructure:
    deployment: |
      - Kubernetes для оркестрации контейнеров
      - Helm чарты для каждого сервиса
      - ArgoCD для GitOps деплоя
      - Канареечные релизы для постепенного развертывания
      - Автоматическое масштабирование на основе метрик

    monitoring: |
      - Prometheus для сбора метрик
      - Grafana для визуализации
      - Loki для централизованного логирования
      - Tempo для распределенного трейсинга
      - OpenTelemetry для инструментации

    security: |
      - Keycloak для аутентификации
      - mTLS для межсервисной коммуникации
      - TLS/QUIC для клиент-серверной коммуникации
      - Rate limiting на уровне Gateway
      - Secrets через Kubernetes Secrets/External Secrets

  api_strategy:
    rest_api: |
      - REST API для синхронных операций
      - OpenAPI 3.0 спецификации для всех endpoints
      - Версионирование через URL (/api/v1/, /api/v2/)
      - Стандартные HTTP коды и форматы ответов

    grpc_api: |
      - gRPC для межсервисной коммуникации
      - Protobuf для определения контрактов
      - Версионирование через пакеты (v1, v2)
      - Backward compatibility при изменениях

    websocket_api: |
      - WebSocket для realtime коммуникации (лобби, чат)
      - Бинарный Protobuf для эффективности
      - Heartbeat для поддержания соединения
      - Автоматическое переподключение

    quic_api: |
      - QUIC/UDP для боевых действий
      - Низкая задержка для быстрых обновлений
      - Надежная доставка через QUIC протокол
      - Адаптивная частота обновлений

technical_specification:
  subtasks:
    - id: infrastructure-setup
      title: Настройка инфраструктуры
      description: |
        Настройка Kubernetes кластера, Helm чартов, ArgoCD, мониторинга
        и базовой инфраструктуры для развертывания сервисов.
      dependencies: [ ]
      estimated_effort: 5 days

    - id: api-gateway-implementation
      title: Реализация API Gateway
      description: |
        Настройка Envoy Gateway с маршрутизацией, аутентификацией,
        rate limiting и load balancing.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 3 days

    - id: service-discovery-config
      title: Настройка Service Discovery
      description: |
        Настройка Eureka для обнаружения сервисов и Config Server
        для централизованной конфигурации.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 2 days

    - id: event-bus-setup
      title: Настройка Event Bus
      description: |
        Настройка Kafka кластера, Schema Registry и реализация
        Transactional Outbox паттерна.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 4 days

    - id: database-setup
      title: Настройка баз данных
      description: |
        Настройка PostgreSQL кластера, Redis кластера, ClickHouse,
        OpenSearch и создание базовых схем.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 4 days

    - id: monitoring-setup
      title: Настройка мониторинга
      description: |
        Настройка Prometheus, Grafana, Loki, Tempo и OpenTelemetry
        для полной наблюдаемости системы.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 3 days

    - id: ci-cd-pipelines
      title: Настройка CI/CD
      description: |
        Создание GitHub Actions пайплайнов для сборки, тестирования
        и деплоя сервисов.
      dependencies: [ infrastructure-setup ]
      estimated_effort: 3 days

    - id: security-setup
      title: Настройка безопасности
      description: |
        Настройка Keycloak, mTLS, TLS/QUIC, rate limiting
        и управления секретами.
      dependencies: [ infrastructure-setup, api-gateway-implementation ]
      estimated_effort: 4 days

    - id: client-integration
      title: Интеграция клиента
      description: |
        Интеграция UE5 клиента с QUIC, WebSocket, Protobuf
        и настройка QoS менеджера.
      dependencies: [ api-gateway-implementation ]
      estimated_effort: 5 days

    - id: documentation
      title: Документация архитектуры
      description: |
        Создание полной документации по архитектуре, API,
        деплою и операционным процедурам.
      dependencies: [ ]
      estimated_effort: 3 days

diagrams:
  system_overview_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway<br/>Envoy]
    
        Gateway --> AuthService[Auth Service<br/>8081]
        Gateway --> CharacterService[Character Service<br/>8082]
        Gateway --> GameplayService[Gameplay Service<br/>8083]
        Gateway --> SocialService[Social Service<br/>8084]
        Gateway --> EconomyService[Economy Service<br/>8085]
        Gateway --> WorldService[World Service<br/>8086]
        Gateway --> ProgressionService[Progression Service<br/>8087]
    
        Client --> RealtimeGateway[Realtime Gateway<br/>QUIC/UDP<br/>8080]
        Client --> WSLobby[WS Lobby<br/>WebSocket<br/>8089]
    
        RealtimeGateway --> GameplayService
        WSLobby --> SocialService
    
        AuthService --> Keycloak[Keycloak]
        AuthService --> Redis[(Redis)]
    
        CharacterService --> Postgres1[(PostgreSQL<br/>characters)]
        GameplayService --> Postgres2[(PostgreSQL<br/>gameplay)]
        SocialService --> Postgres3[(PostgreSQL<br/>social)]
        EconomyService --> Postgres4[(PostgreSQL<br/>economy)]
        WorldService --> Postgres5[(PostgreSQL<br/>world)]
        ProgressionService --> Postgres6[(PostgreSQL<br/>progression)]
    
        AuthService --> Kafka[Kafka<br/>Event Bus]
        CharacterService --> Kafka
        GameplayService --> Kafka
        SocialService --> Kafka
        EconomyService --> Kafka
        WorldService --> Kafka
        ProgressionService --> Kafka
    
        Kafka --> ClickHouse[(ClickHouse<br/>Analytics)]
    
        Gateway --> Eureka[Eureka<br/>Service Discovery]
        Gateway --> ConfigServer[Config Server]
    
        Gateway --> Prometheus[Prometheus<br/>Metrics]
        Gateway --> Grafana[Grafana<br/>Dashboards]
        Gateway --> Loki[Loki<br/>Logs]
        Gateway --> Tempo[Tempo<br/>Tracing]
    ```

  deployment_architecture_diagram: |
    ```mermaid
    graph TB
        subgraph "Kubernetes Cluster"
            subgraph "Gateway Namespace"
                Envoy[Envoy Gateway]
                Ingress[Ingress Controller]
            end
    
            subgraph "Services Namespace"
                AuthPod[Auth Service Pods]
                CharPod[Character Service Pods]
                GamePod[Gameplay Service Pods]
                SocialPod[Social Service Pods]
                EconPod[Economy Service Pods]
                WorldPod[World Service Pods]
                ProgPod[Progression Service Pods]
            end
    
            subgraph "Infrastructure Namespace"
                EurekaPod[Eureka Pods]
                ConfigPod[Config Server Pods]
                KafkaPod[Kafka Pods]
            end
    
            subgraph "Data Namespace"
                PostgresPod[PostgreSQL Pods]
                RedisPod[Redis Pods]
                ClickHousePod[ClickHouse Pods]
            end
    
            subgraph "Monitoring Namespace"
                PromPod[Prometheus Pods]
                GrafanaPod[Grafana Pods]
                LokiPod[Loki Pods]
                TempoPod[Tempo Pods]
            end
        end
    
        ArgoCD[ArgoCD<br/>GitOps] --> Kubernetes
        GitHub[GitHub Actions<br/>CI/CD] --> ArgoCD
    
        External[External Services] --> Envoy
        Envoy --> AuthPod
        Envoy --> CharPod
        Envoy --> GamePod
        Envoy --> SocialPod
        Envoy --> EconPod
        Envoy --> WorldPod
        Envoy --> ProgPod
    ```

