# Issue: #265
# Архитектура системы голосового чата - 2025

metadata:
  version: "1.0.0"
  created_at: "2026-01-11"
  updated_at: "2026-01-11"
  author: "Architect Agent"
  status: "in_progress"
  priority: "high"

---

## Архитектурный обзор

### Контекст
**Домен:** social-domain
**Назначение:** Система голосового чата для MMOFPS RPG с поддержкой различных типов каналов и WebRTC коммуникации.

### Производительность
**Нагрузка:** 10k одновременных пользователей, 2k активных каналов, P99 <100ms для join/leave операций.
**Модель данных:** Выровненная структура (Large->Small). Размер ~48 байт на участника канала.
**Горячий путь:** POST /api/v1/social/voice/join (500 RPS), WebRTC signaling (1k RPS).

### Компоненты системы

```mermaid
graph TB
subgraph "Client Layer"
UE5[UE5 Client]
Mobile[Mobile Client]
Web[Web Client]
end

subgraph "Edge Layer"
RTC_GW[WebRTC Gateway]
WS_GW[WebSocket Gateway]
CDN[Global CDN]
end

subgraph "Service Layer"
VoiceRouter[Voice Router Service]
ChannelSvc[Channel Service]
ParticipantSvc[Participant Service]
ProximitySvc[Proximity Service]
SpatialSvc[Spatial Audio Service]
end

subgraph "Voice Engine Layer"
WebRTCEngine[WebRTC Engine]
MixerEngine[Audio Mixer Engine]
ProviderEngine[External Provider Engine]
end

subgraph "Data Layer"
PostgreSQL[(PostgreSQL)]
Redis[(Redis Cluster)]
Kafka[(Kafka)]
end

subgraph "External Integrations"
WorldSvc[World Service]
SocialSvc[Social Service]
SessionSvc[Session Service]
end

UE5 --> RTC_GW
Mobile --> RTC_GW
Web --> RTC_GW

RTC_GW --> VoiceRouter
WS_GW --> VoiceRouter

VoiceRouter --> ChannelSvc
VoiceRouter --> ParticipantSvc
VoiceRouter --> ProximitySvc

ChannelSvc --> SpatialSvc
ProximitySvc --> SpatialSvc

VoiceRouter --> WebRTCEngine
WebRTCEngine --> MixerEngine
WebRTCEngine --> ProviderEngine

ChannelSvc --> PostgreSQL
ParticipantSvc --> PostgreSQL
ChannelSvc --> Redis
ParticipantSvc --> Redis

VoiceRouter --> Kafka

VoiceRouter --> WorldSvc
VoiceRouter --> SocialSvc
VoiceRouter --> SessionSvc
```

---

## Микросервисы

### 1. Voice Router Service
**Ответственность:** Маршрутизация запросов, валидация прав доступа, координация компонентов.
**API Endpoints:**
- `POST /api/v1/social/voice/channels` - Создание канала
- `DELETE /api/v1/social/voice/channels/{id}` - Удаление канала
- `POST /api/v1/social/voice/channels/{id}/join` - Присоединение к каналу
- `POST /api/v1/social/voice/channels/{id}/leave` - Выход из канала
- `PUT /api/v1/social/voice/channels/{id}/settings` - Настройки канала

### 2. Channel Service
**Ответственность:** Управление жизненным циклом каналов, типы каналов (party/guild/raid/proximity).
**Хранение:**
- `voice_channels` - метаданные каналов
- `channel_settings` - настройки качества и разрешений

### 3. Participant Service
**Ответственность:** Управление участниками, состояния (mute/deafen/speaking), статистика.
**Хранение:**
- `voice_participants` - активные участники
- `participant_stats` - статистика использования

### 4. Proximity Service
**Ответственность:** Динамическое управление proximity каналами на основе координат игроков.
**Интеграции:**
- World Service для получения позиций
- Spatial Audio Service для расчёта расстояний

### 5. Spatial Audio Service
**Ответственность:** Расчёт пространственного звука, 3D позиционирование, эффекты реверберации.
**Алгоритмы:**
- Distance-based attenuation
- Head-related transfer function (HRTF)
- Room acoustics simulation

---

## Система каналов

### Типы каналов

| Тип | Максимум участников | Качество | Особенности |
|-----|-------------------|----------|-------------|
| Party | 5 | Высокое (48kHz) | Командная координация |
| Guild | 100 | Среднее (32kHz) | Социальное общение |
| Raid | 25 | Высокое (48kHz) | Сабканалы по ролям |
| Proximity | 20 | Переменное | 3D звук, 20м радиус |

### Жизненный цикл канала
```mermaid
stateDiagram-v2
[*] --> Creating: Создание
Creating --> Active: Активация
Active --> Scaling: Масштабирование
Active --> Suspended: Приостановка
Suspended --> Active: Возобновление
Active --> Terminating: Завершение
Terminating --> [*]

Scaling --> Active: Успешное масштабирование
Scaling --> Failed: Ошибка масштабирования
Failed --> Terminating
```

---

## WebRTC архитектура

### Компоненты WebRTC

```mermaid
graph LR
subgraph "Signaling"
Client[Client] --> Signaling[Signaling Server]
Signaling --> SFU[SFU Server]
end

subgraph "Media Flow"
Publisher[Publisher] --> SFU
SFU --> Subscriber1[Subscriber 1]
SFU --> Subscriber2[Subscriber 2]
SFU --> SubscriberN[Subscriber N]
end

subgraph "Fallback"
SFU --> External[External Provider]
External --> SFU
end
```

### Signaling протокол
- **STUN/TURN:** NAT traversal
- **ICE:** Interactive Connectivity Establishment
- **DTLS-SRTP:** Шифрование медиа-потоков
- **SCTP:** Data channels для метаданных

### Fallback стратегия
1. **Primary:** Self-hosted SFU cluster
2. **Secondary:** Agora/Twilio SDK
3. **Fallback:** Peer-to-peer (максимум 4 участника)

---

## Система пространственного звука

### Proximity каналы

```mermaid
graph TD
A[Игрок A] --> P[(Позиция A)]
B[Игрок B] --> Q[(Позиция B)]

P --> D[Расстояние]
Q --> D

D --> V[Объём звука]
D --> Pan[Панорамирование]
D --> R[Реверберация]

V --> M[Микшер]
Pan --> M
R --> M
```

### Алгоритмы позиционирования
- **Distance attenuation:** Логарифмическое затухание
- **Doppler effect:** Эффект Доплера для движущихся источников
- **Occlusion:** Заглушение звука препятствиями
- **Reverb zones:** Зональная реверберация

---

## Структура базы данных

### Основные таблицы

```sql
-- Каналы голосового чата
CREATE TABLE voice_channels (
    id UUID PRIMARY KEY,
    type VARCHAR(20) NOT NULL, -- party, guild, raid, proximity
    owner_id UUID NOT NULL,
    guild_id UUID NULL,
    party_id UUID NULL,
    raid_id UUID NULL,
    max_participants INTEGER NOT NULL,
    quality_preset VARCHAR(20) NOT NULL,
    settings JSONB NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

-- Участники каналов
CREATE TABLE voice_participants (
    id UUID PRIMARY KEY,
    channel_id UUID NOT NULL REFERENCES voice_channels(id),
    player_id UUID NOT NULL,
    state VARCHAR(20) NOT NULL, -- active, muted, deafened
    joined_at TIMESTAMP NOT NULL,
    last_activity TIMESTAMP NOT NULL,
    webrtc_token VARCHAR(500) NOT NULL,
    position_data JSONB NULL -- для proximity каналов
);

-- Статистика каналов
CREATE TABLE channel_stats (
    id UUID PRIMARY KEY,
    channel_id UUID NOT NULL REFERENCES voice_channels(id),
    total_participants INTEGER NOT NULL DEFAULT 0,
    peak_participants INTEGER NOT NULL DEFAULT 0,
    total_duration INTERVAL NOT NULL DEFAULT '0'::INTERVAL,
    created_at DATE NOT NULL
);
```

### Индексы производительности
```sql
-- Горячие запросы
CREATE INDEX idx_voice_channels_type_owner ON voice_channels(type, owner_id);
CREATE INDEX idx_voice_participants_channel ON voice_participants(channel_id);
CREATE INDEX idx_voice_participants_player ON voice_participants(player_id);

-- Proximity оптимизации
CREATE INDEX idx_voice_participants_position ON voice_participants USING GIST (position_data);
```

---

## Потоки данных

### Присоединение к каналу

```mermaid
sequenceDiagram
participant Client
participant VoiceRouter
participant ChannelSvc
participant ParticipantSvc
participant WorldSvc
participant WebRTC

Client->>VoiceRouter: POST /join {channel_id}
VoiceRouter->>ChannelSvc: Validate permissions
ChannelSvc->>VoiceRouter: OK

VoiceRouter->>ParticipantSvc: Create participant record
ParticipantSvc->>VoiceRouter: Participant created

alt Proximity channel
VoiceRouter->>WorldSvc: Get player position
WorldSvc->>VoiceRouter: Position data
end

VoiceRouter->>WebRTC: Generate tokens
WebRTC->>VoiceRouter: Tokens

VoiceRouter->>Client: Join response with tokens
```

### Proximity обновления

```mermaid
sequenceDiagram
participant WorldSvc
participant ProximitySvc
participant ParticipantSvc
participant Client

loop Every 100ms
WorldSvc->>ProximitySvc: Position updates
ProximitySvc->>ProximitySvc: Calculate distances
ProximitySvc->>ParticipantSvc: Update participants
ParticipantSvc->>Client: WebSocket: participant_update
end
```

---

## Оптимизация производительности

### Backend Opt Plan
- [ ] Memory pooling для WebRTC sessions (экономия 40% RAM)
- [ ] Batch operations для bulk participant updates
- [ ] Connection pooling для PostgreSQL (50% снижение latency)
- [ ] Redis caching для channel metadata (80% cache hit rate)
- [ ] Zero allocations на горячих путях join/leave

### Масштабирование
- **Horizontal:** Service instances за балансировщиком
- **Data:** PostgreSQL read replicas, Redis cluster
- **Voice:** SFU sharding по географическим регионам
- **CDN:** Global distribution для signaling

---

## Безопасность

### Аутентификация
- JWT tokens с player_id validation
- Channel ownership verification
- Permission-based access control

### Шифрование
- DTLS-SRTP для медиа-потоков
- TLS 1.3 для signaling
- End-to-end encryption option

### Защита от abuse
- Rate limiting на join/leave операции
- Channel creation limits per player
- Voice activity detection для предотвращения spam

---

## Мониторинг и метрики

### Ключевые метрики
- **Latency:** P50/P95/P99 join time
- **Throughput:** Active channels, concurrent users
- **Quality:** Packet loss, jitter, MOS scores
- **Errors:** Failed connections, auth failures

### Логирование
- Structured logging с correlation IDs
- Voice quality metrics per session
- Performance profiling для оптимизации

---

## Техническое задание

### Фаза 1: Core Infrastructure (2 недели)
- Voice Router Service базовая реализация
- Channel Service с CRUD операциями
- PostgreSQL schema и индексы
- Basic WebRTC integration

### Фаза 2: Channel Types (3 недели)
- Party channels с высоким качеством
- Guild channels с социальными фичами
- Raid channels с сабканалами
- Proximity channels прототип

### Фаза 3: Advanced Features (4 недели)
- Spatial audio system
- External provider fallback
- Advanced permissions и moderation
- Performance optimization

### Фаза 4: Production (2 недели)
- Monitoring и alerting
- Load testing
- Security hardening
- Documentation

---

## Следующие шаги

1. **API Designer:** Создать OpenAPI спецификацию для voice-domain
2. **Database:** Реализовать Liquibase миграции для voice схемы
3. **Backend:** Имплементировать Voice Router Service
4. **Network:** Настроить WebRTC инфраструктуру
5. **QA:** Создать тесты для voice функциональности