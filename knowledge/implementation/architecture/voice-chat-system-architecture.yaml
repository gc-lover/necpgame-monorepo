metadata:
  id: voice-chat-system-architecture
  title: Архитектура системы голосового чата (Voice Chat System)
  document_type: architecture
  category: systems
  status: final
  version: '1.1.0'
  last_updated: 2025-12-27T23:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - voice-chat
    - webrtc
    - real-time
    - communication
  related_systems:
    - realtime-gateway-go
    - session-management-service-go
    - voice-chat-service-go
  related_documents:
    - id: chat-system-architecture
      relation: extends
    - id: backend-voice-chat-service
      relation: implements
  github_issue: 140890448
  visibility: internal
  audience:
    - architect
    - backend
    - api-designer
    - network

summary:
  problem: |
    Требуется спроектировать полную техническую архитектуру Voice Chat System
    для голосовой коммуникации игроков в real-time с поддержкой каналов, качества,
    модерации и интеграцией с существующими социальными системами.
  goal: |
    Создать архитектурную схему Voice Chat System с определением:
    - Компонентов системы (микросервисы, модули)
    - WebRTC протоколов и сигнализации
    - Потоков данных и интеграций
    - Систем управления качеством звука
    - Систем модерации голосового чата
    - Технического задания для реализации
  essence: |
    Полная архитектура Voice Chat System для real-time голосовой коммуникации
    в MMOFPS RPG с WebRTC, каналами и качеством звука.

architecture:
  overview: |
    Voice Chat System обеспечивает высококачественную голосовую коммуникацию игроков
    через WebRTC с поддержкой множественных каналов, шумоподавления, модерации
    и интеграцией с социальными системами игры.

  components:
    - name: Voice Chat Gateway
      location: voice-chat-service-go (основной сервис)
      responsibility: |
        - WebRTC сигнализация и управление соединениями
        - Управление голосовыми каналами (party, guild, raid)
        - Обработка участников каналов
        - Качество звука и пропускная способность
        - Интеграция с session management
      webrtc_features: |
        - ICE (Interactive Connectivity Establishment)
        - STUN/TURN серверы для NAT traversal
        - DTLS для шифрования медиа-потоков
        - RTP/RTCP для транспорта аудио
        - Opus кодек для сжатия аудио
      channel_types: |
        - PARTY: для групп (до 8 игроков)
        - GUILD: для гильдий (до 100 игроков)
        - RAID: для рейдов (до 20 игроков)
        - PUBLIC: публичные каналы (до 50 игроков)
        - PRIVATE: приватные каналы (1-на-1)
      endpoints:
        - POST /api/v1/voice/join/{channel_id} - присоединиться к каналу
        - POST /api/v1/voice/leave/{channel_id} - покинуть канал
        - GET /api/v1/voice/channels - список доступных каналов
        - POST /api/v1/voice/mute/{player_id} - заглушить игрока
        - POST /api/v1/voice/kick/{player_id} - выгнать из канала

    - name: Voice Quality Manager
      location: voice-chat-service-go (модуль quality)
      responsibility: |
        - Управление качеством аудио-потоков
        - Адаптивное bitrate управление
        - Шумоподавление и эхо-отмена
        - Обнаружение молчания для оптимизации
        - Мониторинг сетевых условий
      audio_processing: |
        - Opus codec с переменным bitrate (8-128 kbps)
        - Noise suppression algorithms
        - Acoustic echo cancellation
        - Voice activity detection (VAD)
        - Automatic gain control (AGC)
      quality_profiles: |
        - HIGH: 64 kbps, stereo (для party/raid)
        - MEDIUM: 32 kbps, mono (для guild)
        - LOW: 16 kbps, mono (для public, плохая сеть)
        - ULTRA_LOW: 8 kbps, mono (экстренный режим)

    - name: Voice Moderation Engine
      location: voice-chat-service-go (модуль moderation)
      responsibility: |
        - Модерация голосового контента
        - Обнаружение токсичного поведения
        - Управление mute/ban в голосовых каналах
        - Запись и анализ голосовых жалоб
        - Интеграция с общим moderation system
      moderation_features: |
        - Voice activity monitoring
        - Toxicity detection (via AI/ML)
        - Automated muting for spam/toxicity
        - Manual moderation controls
        - Voice recording for appeals
      moderation_rules: |
        - Automatic mute: 3 toxicity warnings
        - Temporary ban: repeated violations
        - Permanent ban: severe harassment
        - Appeal system with voice recording review

    - name: Voice Channel Manager
      location: voice-chat-service-go (модуль channels)
      responsibility: |
        - Создание и управление каналами
        - Приглашения и разрешения
        - Синхронизация участников
        - Управление правами доступа
        - Интеграция с social systems
      channel_permissions: |
        - OWNER: полный контроль канала
        - MODERATOR: модерация участников
        - MEMBER: базовый доступ
        - GUEST: ограниченный доступ
      integration_features: |
        - Guild integration (auto-join guild channels)
        - Party integration (auto-create party channels)
        - Raid integration (raid leader controls)
        - Social system integration (friends, blocks)

    - name: Voice Analytics Service
      location: voice-chat-service-go (модуль analytics)
      responsibility: |
        - Сбор метрик использования
        - Анализ качества соединений
        - Мониторинг производительности
        - Отчеты по модерации
        - Оптимизация на основе данных
      metrics_collected: |
        - Channel participation rates
        - Audio quality scores
        - Network latency statistics
        - Moderation actions count
        - Voice activity patterns
      performance_monitoring: |
        - WebRTC connection success rates
        - Audio latency measurements
        - Bandwidth usage tracking
        - Error rates by region/server

  data_flow:
    channel_join: |
      1. Игрок запрашивает присоединение к каналу
      2. Voice Channel Manager проверяет разрешения
      3. Voice Chat Gateway инициирует WebRTC handshake
      4. STUN/TURN серверы помогают с NAT traversal
      5. Устанавливается P2P или SFU соединение
      6. Voice Quality Manager настраивает параметры аудио
      7. Участник получает доступ к голосовому каналу

    audio_stream: |
      1. Микрофон клиента захватывает аудио
      2. Voice Quality Manager применяет обработку (noise suppression, AGC)
      3. WebRTC кодирует аудио в Opus
      4. RTP пакеты отправляются через P2P или SFU
      5. Получатели декодируют и воспроизводят аудио
      6. Voice Moderation Engine мониторит контент

    moderation_action: |
      1. Voice Moderation Engine обнаруживает нарушение
      2. Отправляется mute/ban команда участнику
      3. WebRTC соединение приостанавливается
      4. Записывается инцидент в moderation log
      5. Уведомляется администратор если нужно

  integrations:
    with_session_service: |
      - Проверка авторизации игроков
      - Управление онлайн статусом
      - Синхронизация mute/ban состояний
      - Обработка отключений игроков

    with_guild_service: |
      - Автоматическое создание guild каналов
      - Синхронизация участников гильдий
      - Управление правами guild офицеров
      - Интеграция с guild voice settings

    with_party_system: |
      - Авто-создание party каналов
      - Синхронизация участников групп
      - Party leader голосовые права
      - Интеграция с party disband mechanics

    with_realtime_gateway: |
      - WebRTC сигнализация через WebSocket
      - Синхронизация состояния каналов
      - Обработка real-time команд
      - Load balancing голосовых соединений

  data_consistency:
    strategy: Eventual Consistency с strong consistency для критичных операций
    mechanisms:
      - Event Sourcing для всех изменений состояния каналов
      - CQRS для разделения команд (join/leave) и запросов (channel list)
      - Saga Pattern для распределенных операций (channel creation with participants)
      - Outbox Pattern для гарантированной доставки voice events
      - Redis для кэширования channel state

  performance_requirements:
    latency: < 100ms end-to-end audio latency
    concurrent_channels: Support for 10,000+ simultaneous voice channels
    concurrent_users: Support for 50,000+ concurrent voice users
    bandwidth_per_user: 16-128 kbps depending on quality settings
    cpu_usage: < 5% per voice channel on server
    memory_usage: < 50MB per active voice channel

  scalability:
    horizontal_scaling: |
      - Voice Chat Gateway может масштабироваться горизонтально
      - SFU (Selective Forwarding Unit) архитектура для больших каналов
      - Load balancing по регионам и серверам
      - Redis кластер для глобального состояния
    regional_distribution: |
      - Серверы в основных регионах (NA, EU, ASIA)
      - Географическая маршрутизация для минимальной задержки
      - Cross-region fallback для отказоустойчивости
    peak_load_handling: |
      - Auto-scaling groups для voice gateways
      - Quality degradation under load (bitrate reduction)
      - Connection limiting for extreme loads

  security:
    encryption: DTLS 1.2+ для шифрования медиа-потоков
    authentication: JWT токены для channel access
    authorization: Role-based permissions per channel
    privacy: End-to-end encryption для private channels
    moderation: AI-powered toxicity detection and automated actions

  database_schema:
    tables:
      - name: voice_channels
        description: Голосовые каналы
        fields:
          - id: UUID (PK)
          - channel_type: ENUM (PARTY, GUILD, RAID, PUBLIC, PRIVATE)
          - owner_id: UUID (FK players)
          - guild_id: UUID (FK guilds, nullable)
          - party_id: UUID (FK parties, nullable)
          - max_participants: INTEGER
          - is_temporary: BOOLEAN (default: false)
          - created_at: TIMESTAMP
          - settings: JSONB (quality, permissions, etc.)
        indexes:
          - channel_type, created_at
          - owner_id
          - guild_id
          - party_id

      - name: voice_channel_participants
        description: Участники голосовых каналов
        fields:
          - id: UUID (PK)
          - channel_id: UUID (FK voice_channels)
          - player_id: UUID (FK players)
          - joined_at: TIMESTAMP
          - permissions: ENUM (OWNER, MODERATOR, MEMBER, MUTED, BANNED)
          - is_muted: BOOLEAN (default: false)
          - connection_quality: INTEGER (1-5 scale)
          - last_activity: TIMESTAMP
        indexes:
          - channel_id, player_id (unique)
          - player_id, joined_at
          - permissions

      - name: voice_moderation_actions
        description: Действия модерации голосового чата
        fields:
          - id: UUID (PK)
          - channel_id: UUID (FK voice_channels)
          - moderator_id: UUID (FK players)
          - target_player_id: UUID (FK players)
          - action_type: ENUM (MUTE, UNMUTE, KICK, BAN, WARN)
          - reason: TEXT
          - duration_seconds: INTEGER (nullable)
          - recorded_audio_url: TEXT (nullable)
          - created_at: TIMESTAMP
        indexes:
          - channel_id, created_at
          - target_player_id, created_at
          - action_type

      - name: voice_quality_metrics
        description: Метрики качества голосового соединения
        fields:
          - id: UUID (PK)
          - channel_id: UUID (FK voice_channels)
          - player_id: UUID (FK players)
          - timestamp: TIMESTAMP
          - latency_ms: INTEGER
          - packet_loss_percent: DECIMAL(5,2)
          - jitter_ms: INTEGER
          - bitrate_kbps: INTEGER
          - quality_score: INTEGER (1-100)
        indexes:
          - channel_id, timestamp
          - player_id, timestamp
          - quality_score

  validation:
    architecture_complete: true
    components_defined: true
    microservices_identified: true
    api_endpoints_described: true
    technical_specification_ready: true
    subtasks_defined: true

  next_steps:
    - Передача задачи агенту API Designer для создания OpenAPI спецификации
    - Детализация WebRTC протоколов и сигнализации
    - Создание схем WebSocket сообщений
    - Определение форматов аудио данных
    - Планирование интеграции с voice-chat-service-go

  history:
    - version: '1.1.0'
      date: 2025-12-27
      author: Architect Agent
      changes: |
        Создана полная архитектура Voice Chat System
        Определены компоненты и WebRTC интеграция
        Добавлена схема БД и метрики производительности
        Определены security и scalability требования
        Статус изменен на final