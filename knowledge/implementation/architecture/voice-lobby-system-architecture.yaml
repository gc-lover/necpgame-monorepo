metadata:
  id: voice-lobby-system-architecture
  title: Архитектура системы голосовых лобби
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T23:59:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - voice-chat
    - social
    - party-finder
  related_systems:
    - voice-service
    - party-service
    - guild-service
    - clan-service
  related_documents:
    - id: backend-voice-lobby-system
      relation: implements
  github_issue: 338
  visibility: internal
  audience:
    - architect
    - backend
    - voice-chat
    - social
    - api-designer

summary:
  problem: |
    Требуется спроектировать полную архитектуру системы голосовых лобби, включающую:
    - Управление голосовыми комнатами
    - Подбор групп (Party Finder)
    - Управление подканалами
    - Интеграцию с party/guild системами
    - Систему прав доступа
  goal: |
    Создать архитектурную схему системы голосовых лобби с определением:
    - Компонентов для управления лобби
    - REST, WebSocket и Event Bus контрактов
    - Интеграций с другими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Полная архитектура системы голосовых лобби с поддержкой лобби, Party Finder,
    управления подканалами и прав доступа.

architecture:
  overview: |
    Архитектура системы голосовых лобби состоит из следующих компонентов:
    1. Voice Lobby Manager - управление системой лобби
    2. Lobby Directory Manager - управление каталогом лобби
    3. Party Finder Engine - подбор групп
    4. Subchannel Controller - управление подканалами
    5. Permissions Engine - управление правами доступа
    6. Lobby Matchmaker - подбор лобби
    7. Voice Provider Integrator - интеграция с голосовым провайдером
    8. Lobby Analytics Collector - сбор аналитики
    9. Lobby Telemetry Collector - сбор телеметрии

  microservices:
    - name: voice-lobby-service
      port: 8096
      responsibility: |
        Обработка системы голосовых лобби:
        - Управление системой лобби
        - Управление каталогом лобби
        - Подбор групп
        - Управление подканалами
        - Управление правами доступа
        - Подбор лобби
        - Интеграция с голосовым провайдером
        - Сбор аналитики
        - Сбор телеметрии
      components:
        - voice-lobby-manager: управление системой лобби
        - lobby-directory-manager: управление каталогом лобби
        - party-finder-engine: подбор групп
        - subchannel-controller: управление подканалами
        - permissions-engine: управление правами доступа
        - lobby-matchmaker: подбор лобби
        - voice-provider-integrator: интеграция с голосовым провайдером
        - lobby-analytics-collector: сбор аналитики
        - lobby-telemetry-collector: сбор телеметрии
      endpoints:
        - GET /api/v1/voice-lobbies - список лобби
        - GET /api/v1/voice-lobbies/{lobbyId} - информация о лобби
        - POST /api/v1/voice-lobbies - создание лобби
        - PUT /api/v1/voice-lobbies/{lobbyId} - обновление лобби
        - DELETE /api/v1/voice-lobbies/{lobbyId} - удаление лобби
        - POST /api/v1/voice-lobbies/{lobbyId}/join - присоединение к лобби
        - POST /api/v1/voice-lobbies/{lobbyId}/leave - выход из лобби
        - GET /api/v1/voice-lobbies/{lobbyId}/participants - участники лобби
        - POST /api/v1/voice-lobbies/{lobbyId}/subchannels - создание подканала
        - GET /api/v1/voice-lobbies/{lobbyId}/subchannels - список подканалов
        - POST /api/v1/voice-lobbies/{lobbyId}/subchannels/{subchannelId}/move - перемещение в подканал
        - POST /api/v1/voice-lobbies/{lobbyId}/permissions - изменение прав
        - GET /api/v1/voice-lobbies/{lobbyId}/permissions - права доступа
        - POST /api/v1/party-finder/search - поиск группы
        - GET /api/v1/party-finder/{characterId}/active - активный поиск
        - POST /api/v1/party-finder/{characterId}/cancel - отмена поиска
        - GET /api/v1/voice-lobbies/{characterId}/my-lobbies - мои лобби
      websocket_channels:
        - wss://api.necp.game/v1/voice-lobbies/{lobbyId} - поток обновлений лобби
        - wss://api.necp.game/v1/party-finder/{characterId} - поток обновлений поиска
      events_published:
        - voice-lobby.created: создано лобби
        - voice-lobby.updated: обновлено лобби
        - voice-lobby.deleted: удалено лобби
        - voice-lobby.joined: присоединение к лобби
        - voice-lobby.left: выход из лобби
        - voice-lobby.subchannel-created: создан подканал
        - voice-lobby.subchannel-moved: перемещение в подканал
        - voice-lobby.permissions-changed: изменены права
        - party-finder.started: начат поиск группы
        - party-finder.found: найдена группа
        - party-finder.cancelled: отменен поиск
      events_subscribed:
        - party.created: создана группа
        - party.disbanded: распущена группа
        - guild.created: создана гильдия
        - guild.disbanded: распущена гильдия
        - clan.created: создан клан
        - clan.disbanded: распущен клан

  lobby_types:
    - name: activity
      description: "Активность - для игровых активностей"
      max_participants: 8
      max_subchannels: 4
      permissions: ["leader", "member"]

    - name: clan
      description: "Клан - для клановых лобби"
      max_participants: 50
      max_subchannels: 10
      permissions: ["leader", "officer", "member"]

    - name: guild
      description: "Гильдия - для гильдийных лобби"
      max_participants: 100
      max_subchannels: 20
      permissions: ["leader", "officer", "member"]

    - name: raid
      description: "Рейд - для рейдовых лобби"
      max_participants: 24
      max_subchannels: 6
      permissions: ["leader", "commander", "party_leader", "member"]

    - name: tournament
      description: "Турнир - для турнирных лобби"
      max_participants: 16
      max_subchannels: 4
      permissions: ["leader", "commander", "member"]

  subchannel_types:
    - name: main
      description: "Основной канал - главный канал лобби"
      max_participants: null
      auto_create: true

    - name: role_based
      description: "Ролевой канал - для определенных ролей"
      max_participants: null
      auto_create: false

    - name: commander
      description: "Командирский канал - для командиров"
      max_participants: 8
      auto_create: false

    - name: party
      description: "Групповой канал - для групп"
      max_participants: 8
      auto_create: false

  permissions:
    roles:
      - name: leader
        description: "Лидер - полный контроль"
        permissions: ["manage_lobby", "manage_subchannels", "manage_permissions", "kick", "mute", "move"]

      - name: commander
        description: "Командир - управление рейдом"
        permissions: ["manage_subchannels", "kick", "mute", "move"]

      - name: party_leader
        description: "Лидер группы - управление группой"
        permissions: ["manage_subchannels", "kick", "mute", "move"]

      - name: officer
        description: "Офицер - модерация"
        permissions: ["kick", "mute", "move"]

      - name: member
        description: "Участник - базовые права"
        permissions: ["speak", "listen"]

    actions:
      - manage_lobby: "управление лобби"
      - manage_subchannels: "управление подканалами"
      - manage_permissions: "управление правами"
      - kick: "исключение участника"
      - mute: "отключение микрофона"
      - move: "перемещение в подканал"
      - speak: "говорить"
      - listen: "слушать"

  party_finder:
    search_criteria:
      - role: "роль игрока"
      - rating: "рейтинг игрока"
      - activity: "активность"
      - region: "регион"
      - language: "язык"
      - min_level: "минимальный уровень"
      - max_level: "максимальный уровень"

    matching_algorithm:
      - role_matching: "совпадение ролей"
      - rating_range: "диапазон рейтинга (±100)"
      - region_preference: "предпочтение региона"
      - language_preference: "предпочтение языка"
      - level_range: "диапазон уровней (±5)"

    search_states:
      - searching: "поиск активен"
      - found: "группа найдена"
      - cancelled: "поиск отменен"
      - timeout: "таймаут поиска"

  data_flows:
    lobby_creation_flow: |
      1. Игрок создает лобби через API
      2. Voice Lobby Manager валидирует данные лобби
      3. Voice Lobby Manager проверяет лимиты игрока
      4. Voice Provider Integrator создает голосовую комнату
      5. Voice Lobby Manager сохраняет лобби в БД
      6. Lobby Directory Manager добавляет лобби в каталог
      7. Voice Lobby Manager публикует событие voice-lobby.created
      8. Realtime Gateway отправляет обновление клиентам

    lobby_join_flow: |
      1. Игрок присоединяется к лобби через API
      2. Voice Lobby Manager проверяет доступность лобби
      3. Permissions Engine проверяет права доступа
      4. Voice Lobby Manager проверяет лимиты участников
      5. Voice Provider Integrator добавляет игрока в голосовую комнату
      6. Voice Lobby Manager добавляет участника в БД
      7. Voice Lobby Manager публикует событие voice-lobby.joined
      8. Realtime Gateway отправляет обновление всем участникам

    party_finder_flow: |
      1. Игрок начинает поиск группы через API
      2. Party Finder Engine сохраняет критерии поиска
      3. Party Finder Engine добавляет игрока в очередь поиска
      4. Lobby Matchmaker периодически проверяет совпадения
      5. Lobby Matchmaker находит подходящее лобби
      6. Party Finder Engine присоединяет игрока к лобби
      7. Voice Lobby Manager публикует событие party-finder.found
      8. Realtime Gateway отправляет обновление игроку

    subchannel_management_flow: |
      1. Лидер создает подканал через API
      2. Subchannel Controller валидирует данные подканала
      3. Subchannel Controller проверяет лимиты подканалов
      4. Voice Provider Integrator создает подканал в голосовом провайдере
      5. Subchannel Controller сохраняет подканал в БД
      6. Voice Lobby Manager публикует событие voice-lobby.subchannel-created
      7. Realtime Gateway отправляет обновление всем участникам

  database_structure:
    tables:
      - name: voice_lobbies
        description: Голосовые лобби
        columns:
          - id: UUID PRIMARY KEY
          - type: ENUM (activity, clan, guild, raid, tournament)
          - name: VARCHAR(255)
          - description: TEXT
          - owner_id: UUID FOREIGN KEY
          - party_id: UUID FOREIGN KEY
          - guild_id: UUID FOREIGN KEY
          - clan_id: UUID FOREIGN KEY
          - voice_provider_room_id: VARCHAR(255)
          - max_participants: INTEGER
          - max_subchannels: INTEGER
          - region: VARCHAR(50)
          - language: VARCHAR(10)
          - is_public: BOOLEAN
          - is_active: BOOLEAN
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
          - closed_at: TIMESTAMP

      - name: lobby_participants
        description: Участники лобби
        columns:
          - id: UUID PRIMARY KEY
          - lobby_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - role: ENUM (leader, commander, party_leader, officer, member)
          - subchannel_id: UUID FOREIGN KEY
          - is_muted: BOOLEAN
          - is_deafened: BOOLEAN
          - joined_at: TIMESTAMP
          - left_at: TIMESTAMP

      - name: lobby_subchannels
        description: Подканалы лобби
        columns:
          - id: UUID PRIMARY KEY
          - lobby_id: UUID FOREIGN KEY
          - name: VARCHAR(255)
          - type: ENUM (main, role_based, commander, party)
          - voice_provider_channel_id: VARCHAR(255)
          - max_participants: INTEGER
          - role_restrictions: JSONB
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP

      - name: party_finder_searches
        description: Поиски групп
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - role: VARCHAR(50)
          - rating: INTEGER
          - activity: VARCHAR(50)
          - region: VARCHAR(50)
          - language: VARCHAR(10)
          - min_level: INTEGER
          - max_level: INTEGER
          - status: ENUM (searching, found, cancelled, timeout)
          - created_at: TIMESTAMP
          - updated_at: TIMESTAMP
          - found_at: TIMESTAMP

      - name: lobby_telemetry
        description: Телеметрия лобби
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - lobby_id: UUID FOREIGN KEY
          - character_id: UUID FOREIGN KEY
          - event_data: JSONB
          - created_at: TIMESTAMP

  integrations:
    voice_service: |
      - Создание голосовых комнат
      - Управление подканалами
      - Управление участниками
      - Управление правами доступа

    party_service: |
      - Интеграция с группами
      - Автоматическое создание лобби для групп
      - Синхронизация участников

    guild_service: |
      - Интеграция с гильдиями
      - Автоматическое создание лобби для гильдий
      - Синхронизация участников

    clan_service: |
      - Интеграция с кланами
      - Автоматическое создание лобби для кланов
      - Синхронизация участников

    character_service: |
      - Получение информации о персонаже
      - Проверка уровня персонажа
      - Проверка роли персонажа

    analytics_service: |
      - Логирование всех операций с лобби
      - Сбор метрик эффективности
      - Анализ паттернов использования
      - Мониторинг производительности

    realtime_gateway: |
      - Отправка realtime обновлений лобби
      - Уведомления о новых участниках
      - Синхронизация подканалов

technical_specification:
  subtasks:
    - id: voice-lobby-manager
      title: Реализация менеджера системы лобби
      description: |
        Реализация Voice Lobby Manager с управлением системой лобби
        и интеграцией с другими компонентами.
      dependencies: []
      estimated_effort: 5 days

    - id: lobby-directory-manager
      title: Реализация менеджера каталога лобби
      description: |
        Реализация Lobby Directory Manager с управлением каталогом лобби,
        поиском и фильтрацией.
      dependencies: [voice-lobby-manager]
      estimated_effort: 4 days

    - id: party-finder-engine
      title: Реализация движка подбора групп
      description: |
        Реализация Party Finder Engine с подбором групп,
        алгоритмом совпадений и управлением очередью.
      dependencies: [voice-lobby-manager]
      estimated_effort: 5 days

    - id: subchannel-controller
      title: Реализация контроллера подканалов
      description: |
        Реализация Subchannel Controller с управлением подканалами,
        созданием и перемещением участников.
      dependencies: [voice-lobby-manager]
      estimated_effort: 4 days

    - id: permissions-engine
      title: Реализация движка прав доступа
      description: |
        Реализация Permissions Engine с управлением правами доступа,
        проверкой прав и применением ограничений.
      dependencies: [voice-lobby-manager]
      estimated_effort: 4 days

    - id: lobby-matchmaker
      title: Реализация подбора лобби
      description: |
        Реализация Lobby Matchmaker с подбором лобби,
        алгоритмом совпадений и управлением очередью.
      dependencies: [voice-lobby-manager]
      estimated_effort: 4 days

    - id: voice-provider-integrator
      title: Реализация интегратора голосового провайдера
      description: |
        Реализация Voice Provider Integrator с интеграцией голосового провайдера,
        созданием комнат и управлением участниками.
      dependencies: [voice-lobby-manager]
      estimated_effort: 5 days

    - id: lobby-analytics-collector
      title: Реализация сборщика аналитики
      description: |
        Реализация Lobby Analytics Collector с логированием операций,
        сбором метрик и интеграцией с Analytics Service.
      dependencies: [voice-lobby-manager]
      estimated_effort: 3 days

    - id: lobby-telemetry-collector
      title: Реализация сборщика телеметрии
      description: |
        Реализация Lobby Telemetry Collector с логированием событий,
        сбором телеметрии и интеграцией с Analytics Service.
      dependencies: [voice-lobby-manager]
      estimated_effort: 2 days

    - id: websocket-channels
      title: Реализация WebSocket каналов
      description: |
        Реализация WebSocket каналов для realtime обновлений лобби,
        поиска групп и уведомлений.
      dependencies: [voice-lobby-manager]
      estimated_effort: 3 days

    - id: event-bus-integration
      title: Интеграция с Event Bus
      description: |
        Реализация публикации и подписки на события через Kafka
        для всех компонентов системы лобби.
      dependencies: [voice-lobby-manager]
      estimated_effort: 2 days

    - id: database-schema
      title: Создание схемы БД
      description: |
        Создание таблиц БД для лобби, участников, подканалов,
        поисков групп и телеметрии с миграциями Liquibase.
      dependencies: []
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> VoiceLobbyService[Voice Lobby Service<br/>8096]
        
        VoiceLobbyService --> VLM[Voice Lobby Manager]
        VoiceLobbyService --> LDM[Lobby Directory Manager]
        VoiceLobbyService --> PFE[Party Finder Engine]
        VoiceLobbyService --> SC[Subchannel Controller]
        VoiceLobbyService --> PE[Permissions Engine]
        VoiceLobbyService --> LM[Lobby Matchmaker]
        VoiceLobbyService --> VPI[Voice Provider Integrator]
        VoiceLobbyService --> LAC[Lobby Analytics Collector]
        VoiceLobbyService --> LTC[Lobby Telemetry Collector]
        
        VLM --> LDM
        VLM --> PFE
        VLM --> SC
        VLM --> PE
        VLM --> LM
        VLM --> VPI
        
        VoiceLobbyService --> VoiceService[Voice Service]
        VoiceLobbyService --> PartyService[Party Service]
        VoiceLobbyService --> GuildService[Guild Service]
        VoiceLobbyService --> ClanService[Clan Service]
        VoiceLobbyService --> CharacterService[Character Service]
        VoiceLobbyService --> AnalyticsService[Analytics Service]
        
        VoiceLobbyService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        VoiceLobbyService --> DB[(Voice Lobby DB)]
        
        Client --> WSLobbies[WebSocket<br/>Lobbies]
        WSLobbies --> VoiceLobbyService
    ```

  lobby_creation_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Player as Player
        participant VLM as Voice Lobby Manager
        participant VPI as Voice Provider Integrator
        participant LDM as Lobby Directory Manager
        participant EB as Event Bus
        
        Player->>VLM: Create lobby
        VLM->>VLM: Validate data
        VLM->>VLM: Check limits
        VLM->>VPI: Create voice room
        VPI->>VPI: Create room in provider
        VPI->>VLM: Return room ID
        VLM->>VLM: Save to DB
        VLM->>LDM: Add to directory
        VLM->>EB: Publish voice-lobby.created
    ```

  party_finder_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant Player as Player
        participant PFE as Party Finder Engine
        participant LM as Lobby Matchmaker
        participant VLM as Voice Lobby Manager
        participant EB as Event Bus
        
        Player->>PFE: Start search
        PFE->>PFE: Save search criteria
        PFE->>PFE: Add to queue
        LM->>LM: Check matches
        LM->>LM: Find matching lobby
        LM->>VLM: Join player to lobby
        VLM->>EB: Publish party-finder.found
    ```
