metadata:
  id: weapon-special-mechanics-architecture
  title: Архитектура специальных механик оружия
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-29T19:00:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - combat
    - weapons
    - special-mechanics
    - magic-analogue
  related_systems:
    - gameplay-service
    - combat-shooting-service
    - economy-service
    - inventory-service
    - ability-service
    - analytics-service
  related_documents:
    - id: combat-shooting-architecture
      relation: extends
    - id: procedural-equipment-matrix-architecture
      relation: extends
    - id: weapon-special-mechanics-working
      relation: implements
    - id: weapon-special-mechanics-architecture-details
      relation: details
  github_issues:
    - 1550
    - 1551
    - 1552
    - 1553
    - 1554
    - 1555
    - 1556
    - 1557
    - 1558
    - 1559
    - 1560
    - 1561
    - 1562
    - 1563
    - 1564
    - 1565
    - 1566
    - 1567
    - 1568
    - 1569
    - 1570
    - 1571
    - 1572
    - 1573
    - 1574
    - 1575
    - 1576
    - 1577
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - combat
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы специальных механик оружия, которая будет аналогом
    магической системы в фентези-играх. Система должна поддерживать:
    - 30+ различных специальных механик оружия
    - Персистентные эффекты (снаряды в теле, DoT)
    - Цепной урон (молнии, EMP волны)
    - Разрушение окружения и частей тела
    - Размещаемое оружие (мины, ловушки, турели)
    - Лазерное оружие (непрерывные лучи, импульсы, рельсы)
    - Ближний бой с уникальными механиками
    - Стихийные эффекты (огонь, лед, яд, кислота)
    - Временные эффекты (вампиризм, ускорение, замедление)
    - Контроль и манипуляцию (психотропное, гравитационное, телепортационное)
    - Призыв и поддержку (дроны, лечение)
    - Уникальные формы проджектайлов (точка, линия, веер, спираль, волна, круг, квадрат, цепь)
    - Матрицу комбинаций оружия (Borderlands-стиль)
    - Связь с классами персонажей
    - Двойное оружие
    - Модификаторы (обвес, чипы, прошивки)
    - Интеграцию с существующей системой стрельбы и матрицей экипировки
  goal: |
    Создать архитектурную схему системы специальных механик оружия с определением:
    - Компонентов для управления специальными механиками
    - Микросервисов и их ответственности
    - API endpoints (высокоуровнево)
    - Event Sourcing и CQRS паттернов для синхронизации
    - Тикрейта и требований к сетевой нагрузке
    - Интеграций с существующими системами
    - Структуры БД
    - Технического задания для реализации
  essence: |
    Объединенная архитектура системы специальных механик оружия, интегрированная с существующей
    системой стрельбы и матрицей экипировки, поддерживающая все типы специальных эффектов и механик.

architecture:
  overview: |
    Архитектура системы специальных механик оружия состоит из следующих компонентов:
    1. Special Mechanics Manager - управление всеми специальными механиками
    2. Persistent Effects Manager - управление персистентными эффектами (снаряды в теле, DoT)
    3. Chain Damage Manager - управление цепным уроном (молнии, EMP)
    4. Environment Destruction Manager - управление разрушением окружения
    5. Deployable Weapons Manager - управление размещаемым оружием
    6. Laser Weapons Manager - управление лазерным оружием
    7. Melee Combat Manager - управление ближним боем
    8. Elemental Effects Manager - управление стихийными эффектами
    9. Temporal Effects Manager - управление временными эффектами
    10. Control & Manipulation Manager - управление контролем и манипуляцией
    11. Summon & Support Manager - управление призывом и поддержкой
    12. Projectile Forms Manager - управление формами проджектайлов
    13. Weapon Combination Matrix Manager - управление матрицей комбинаций
    14. Class Synergy Manager - управление синергиями с классами
    15. Dual Wielding Manager - управление двойным оружием
    16. Weapon Modifiers Manager - управление модификаторами оружия
    17. Visual & Audio Effects Manager - управление визуальными и звуковыми эффектами

  microservices:
    - name: gameplay-service
      port: 8083
      responsibility: |
        Основной сервис для специальных механик оружия:
        - Управление всеми специальными механиками
        - Обработка персистентных эффектов
        - Обработка цепного урона
        - Обработка разрушения окружения
        - Управление размещаемым оружием
        - Управление лазерным оружием
        - Управление ближним боем
        - Управление стихийными эффектами
        - Управление временными эффектами
        - Управление контролем и манипуляцией
        - Управление призывом и поддержкой
        - Управление формами проджектайлов
        - Управление синергиями с классами
        - Управление двойным оружием
        - Интеграция с системой стрельбы
      components:
        - Special Mechanics Manager
        - Persistent Effects Manager
        - Chain Damage Manager
        - Environment Destruction Manager
        - Deployable Weapons Manager
        - Laser Weapons Manager
        - Melee Combat Manager
        - Elemental Effects Manager
        - Temporal Effects Manager
        - Control & Manipulation Manager
        - Summon & Support Manager
        - Projectile Forms Manager
        - Class Synergy Manager
        - Dual Wielding Manager
      endpoints:
        - POST /api/v1/gameplay/combat/weapons/special-mechanics/apply - применение специальной механики
        - GET /api/v1/gameplay/combat/weapons/special-mechanics/{weaponId} - получение механик оружия
        - POST /api/v1/gameplay/combat/weapons/persistent-effects/create - создание персистентного эффекта
        - GET /api/v1/gameplay/combat/weapons/persistent-effects/{targetId} - получение персистентных эффектов цели
        - POST /api/v1/gameplay/combat/weapons/chain-damage/calculate - расчет цепного урона
        - POST /api/v1/gameplay/combat/weapons/environment/destroy - разрушение окружения
        - POST /api/v1/gameplay/combat/weapons/deployable/place - размещение оружия
        - GET /api/v1/gameplay/combat/weapons/deployable/{deploymentId} - получение размещенного оружия
        - POST /api/v1/gameplay/combat/weapons/laser/fire - стрельба лазером
        - POST /api/v1/gameplay/combat/weapons/melee/attack - атака ближнего боя
        - POST /api/v1/gameplay/combat/weapons/elemental/apply - применение стихийного эффекта
        - POST /api/v1/gameplay/combat/weapons/temporal/apply - применение временного эффекта
        - POST /api/v1/gameplay/combat/weapons/control/apply - применение контроля
        - POST /api/v1/gameplay/combat/weapons/summon/create - создание призванного существа
        - POST /api/v1/gameplay/combat/weapons/projectile-forms/calculate - расчет формы проджектайла
        - POST /api/v1/gameplay/combat/weapons/class-synergy/calculate - расчет синергии с классом
        - POST /api/v1/gameplay/combat/weapons/dual-wielding/fire - стрельба с двух оружий
      websocket_channels:
        - wss://api.necp.game/v1/gameplay/combat/weapons/special-mechanics/{sessionId} - поток специальных механик в реальном времени
        - wss://api.necp.game/v1/gameplay/combat/weapons/persistent-effects/{sessionId} - поток персистентных эффектов
        - wss://api.necp.game/v1/gameplay/combat/weapons/chain-damage/{sessionId} - поток цепного урона
        - wss://api.necp.game/v1/gameplay/combat/weapons/deployable/{sessionId} - поток размещенного оружия
      events_published:
        - combat.weapon.special-mechanics-applied: применение специальной механики
        - combat.weapon.persistent-effect-created: создание персистентного эффекта
        - combat.weapon.persistent-effect-removed: удаление персистентного эффекта
        - combat.weapon.chain-damage-triggered: срабатывание цепного урона
        - combat.weapon.environment-destroyed: разрушение окружения
        - combat.weapon.deployable-placed: размещение оружия
        - combat.weapon.deployable-activated: активация размещенного оружия
        - combat.weapon.laser-fired: стрельба лазером
        - combat.weapon.melee-attack: атака ближнего боя
        - combat.weapon.elemental-effect-applied: применение стихийного эффекта
        - combat.weapon.temporal-effect-applied: применение временного эффекта
        - combat.weapon.control-applied: применение контроля
        - combat.weapon.summon-created: создание призванного существа
        - combat.weapon.projectile-form-calculated: расчет формы проджектайла
        - combat.weapon.class-synergy-calculated: расчет синергии с классом
        - combat.weapon.dual-wielding-fired: стрельба с двух оружий
      events_subscribed:
        - combat.shooting.weapon-fired: выстрел оружия
        - combat.shooting.hit-registered: регистрация попадания
        - combat.session.started: начало боевой сессии
        - combat.session.ended: окончание боевой сессии
        - combat.weapon.equipped: экипировка оружия
        - combat.weapon.unequipped: снятие оружия
        - progression.skill-updated: обновление навыков
        - progression.class-changed: изменение класса
        - inventory.item-updated: обновление предмета
        - ability.activated: активация способности

    - name: economy-service
      port: 8085
      responsibility: |
        Управление матрицей комбинаций оружия и модификаторами:
        - Управление матрицей комбинаций оружия (Borderlands-стиль)
        - Генерация комбинаций оружия
        - Управление модификаторами оружия (обвес, чипы, прошивки)
        - Интеграция с процедурной матрицей экипировки
        - Управление корпорациями и их специализациями
      components:
        - Weapon Combination Matrix Manager
        - Weapon Modifiers Manager
        - Corporation Specializations Manager
      endpoints:
        - POST /api/v1/economy/weapons/combinations/generate - генерация комбинации оружия
        - GET /api/v1/economy/weapons/combinations/matrix - матрица комбинаций
        - GET /api/v1/economy/weapons/modifiers - список модификаторов
        - POST /api/v1/economy/weapons/modifiers/apply - применение модификатора
        - GET /api/v1/economy/weapons/corporations - список корпораций и специализаций
      events_published:
        - economy.weapon.combination-generated: генерация комбинации оружия
        - economy.weapon.modifier-applied: применение модификатора
        - economy.weapon.corporation-specialization-updated: обновление специализации корпорации
      events_subscribed:
        - equipment.generated: генерация экипировки
        - equipment.matrix-updated: обновление матрицы экипировки

    - name: client-service
      port: 8089
      responsibility: |
        Управление визуальными и звуковыми эффектами:
        - Управление визуальными эффектами специальных механик
        - Управление звуковым оформлением
        - Синхронизация эффектов с клиентом (UE5)
      components:
        - Visual & Audio Effects Manager
      endpoints:
        - POST /api/v1/client/effects/visual/trigger - триггер визуального эффекта
        - POST /api/v1/client/effects/audio/trigger - триггер звукового эффекта
        - GET /api/v1/client/effects/{effectId} - получение эффекта
      events_subscribed:
        - combat.weapon.special-mechanics-applied: применение специальной механики
        - combat.weapon.persistent-effect-created: создание персистентного эффекта
        - combat.weapon.chain-damage-triggered: срабатывание цепного урона
        - combat.weapon.environment-destroyed: разрушение окружения
        - combat.weapon.laser-fired: стрельба лазером
        - combat.weapon.melee-attack: атака ближнего боя
        - combat.weapon.elemental-effect-applied: применение стихийного эффекта

  event_sourcing:
    overview: |
      Система использует Event Sourcing для синхронизации состояния специальных механик оружия
      между сервисами и клиентами. Все события сохраняются в Event Store и используются для
      восстановления состояния и репликации.

    event_store:
      type: Kafka
      topics:
        - weapon-special-mechanics-events: все события специальных механик
        - weapon-persistent-effects-events: события персистентных эффектов
        - weapon-chain-damage-events: события цепного урона
        - weapon-environment-events: события разрушения окружения
        - weapon-deployable-events: события размещенного оружия
        - weapon-laser-events: события лазерного оружия
        - weapon-melee-events: события ближнего боя
        - weapon-elemental-events: события стихийных эффектов
        - weapon-temporal-events: события временных эффектов
        - weapon-control-events: события контроля
        - weapon-summon-events: события призыва
        - weapon-projectile-forms-events: события форм проджектайлов
        - weapon-class-synergy-events: события синергий с классами
        - weapon-dual-wielding-events: события двойного оружия
        - weapon-modifiers-events: события модификаторов
        - weapon-combination-matrix-events: события матрицы комбинаций

    event_types:
      - WeaponSpecialMechanicsApplied
      - PersistentEffectCreated
      - PersistentEffectRemoved
      - PersistentEffectTick
      - ChainDamageTriggered
      - ChainDamageJumped
      - EnvironmentDestroyed
      - DeployableWeaponPlaced
      - DeployableWeaponActivated
      - DeployableWeaponDestroyed
      - LaserFired
      - LaserOverheated
      - MeleeAttack
      - MeleeCombo
      - ElementalEffectApplied
      - ElementalEffectStacked
      - TemporalEffectApplied
      - TemporalEffectExpired
      - ControlApplied
      - ControlExpired
      - SummonCreated
      - SummonDestroyed
      - ProjectileFormCalculated
      - ClassSynergyCalculated
      - DualWieldingFired
      - WeaponModifierApplied
      - WeaponCombinationGenerated

  cqrs:
    overview: |
      Система использует CQRS для разделения команд (запись) и запросов (чтение).
      Команды обрабатываются через Command Handlers, запросы через Query Handlers.

    command_handlers:
      - ApplySpecialMechanicsCommand
      - CreatePersistentEffectCommand
      - RemovePersistentEffectCommand
      - CalculateChainDamageCommand
      - DestroyEnvironmentCommand
      - PlaceDeployableWeaponCommand
      - FireLaserCommand
      - PerformMeleeAttackCommand
      - ApplyElementalEffectCommand
      - ApplyTemporalEffectCommand
      - ApplyControlCommand
      - CreateSummonCommand
      - CalculateProjectileFormCommand
      - CalculateClassSynergyCommand
      - FireDualWieldingCommand
      - ApplyWeaponModifierCommand
      - GenerateWeaponCombinationCommand

    query_handlers:
      - GetWeaponSpecialMechanicsQuery
      - GetPersistentEffectsQuery
      - GetChainDamageTargetsQuery
      - GetDeployableWeaponsQuery
      - GetLaserWeaponStateQuery
      - GetMeleeComboStateQuery
      - GetElementalEffectsQuery
      - GetTemporalEffectsQuery
      - GetControlEffectsQuery
      - GetSummonsQuery
      - GetProjectileFormQuery
      - GetClassSynergyQuery
      - GetDualWieldingStateQuery
      - GetWeaponModifiersQuery
      - GetWeaponCombinationMatrixQuery

  tickrate_and_network:
    overview: |
      Требования к тикрейту и сетевой нагрузке для различных механик оружия.

    tickrate_requirements:
      persistent_effects:
        server_tickrate: 10 Hz
        client_tickrate: 60 Hz
        description: "Персистентные эффекты (DoT) обновляются на сервере 10 раз в секунду, клиент интерполирует"

      chain_damage:
        server_tickrate: 60 Hz
        client_tickrate: 60 Hz
        description: "Цепной урон требует высокой частоты для плавности визуализации"

      environment_destruction:
        server_tickrate: 30 Hz
        client_tickrate: 60 Hz
        description: "Разрушение окружения обновляется на сервере 30 раз в секунду"

      deployable_weapons:
        server_tickrate: 20 Hz
        client_tickrate: 60 Hz
        description: "Размещенное оружие обновляется на сервере 20 раз в секунду"

      laser_weapons:
        server_tickrate: 60 Hz
        client_tickrate: 60 Hz
        description: "Лазерное оружие требует высокой частоты для точности"

      melee_combat:
        server_tickrate: 60 Hz
        client_tickrate: 60 Hz
        description: "Ближний бой требует высокой частоты для отзывчивости"

      elemental_effects:
        server_tickrate: 20 Hz
        client_tickrate: 60 Hz
        description: "Стихийные эффекты обновляются на сервере 20 раз в секунду"

      temporal_effects:
        server_tickrate: 10 Hz
        client_tickrate: 60 Hz
        description: "Временные эффекты обновляются на сервере 10 раз в секунду"

      projectile_forms:
        server_tickrate: 60 Hz
        client_tickrate: 60 Hz
        description: "Формы проджектайлов требуют высокой частоты для точности"

    network_bandwidth:
      persistent_effects:
        bytes_per_tick: 50
        description: "Персистентные эффекты: ID эффекта, цель, урон, время"

      chain_damage:
        bytes_per_tick: 200
        description: "Цепной урон: список целей, урон по каждой, визуальные данные"

      environment_destruction:
        bytes_per_tick: 500
        description: "Разрушение окружения: ID объекта, тип разрушения, позиция, осколки"

      deployable_weapons:
        bytes_per_tick: 100
        description: "Размещенное оружие: ID, позиция, состояние, цели"

      laser_weapons:
        bytes_per_tick: 150
        description: "Лазерное оружие: позиция луча, цели, урон, перегрев"

      melee_combat:
        bytes_per_tick: 100
        description: "Ближний бой: тип атаки, цель, урон, комбо"

      elemental_effects:
        bytes_per_tick: 80
        description: "Стихийные эффекты: тип эффекта, цель, стаки, урон"

      temporal_effects:
        bytes_per_tick: 60
        description: "Временные эффекты: тип эффекта, цель, длительность, модификаторы"

      projectile_forms:
        bytes_per_tick: 120
        description: "Формы проджектайлов: тип формы, траектория, цели"

    optimization_strategies:
      - Использование delta compression для обновлений состояния
      - Приоритизация важных событий (попадания, активации)
      - Батчинг мелких обновлений (DoT, эффекты)
      - Кэширование статических данных (матрицы, модификаторы)
      - Использование UDP для realtime обновлений
      - Использование TCP для критичных команд (размещение оружия, призыв)

  details_file: weapon-special-mechanics-architecture-details.yaml
