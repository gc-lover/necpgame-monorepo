metadata:
  id: weapon-synergies-architecture
  title: Архитектура системы синергий оружия и имплантов
  document_type: architecture
  category: combat
  status: draft
  version: "1.0.0"
  last_updated: 2025-12-06T21:45:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - combat
    - weapons
    - implants
    - synergies
    - interactions
  related_systems:
    - weapon-system
    - implant-system
    - combat-engine
    - character-system
  related_documents:
    - id: weapon-special-mechanics-working
      relation: implements
  github_issue: 1562
  visibility: internal
  audience:
    - architect
    - backend
    - gameplay
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы синергий между оружием,
    имплантами и окружением, включающую классовые бонусы, эксклюзивные
    способности и динамические взаимодействия для создания уникальных стилей игры.
  goal: |
    Создать архитектурную схему с определением компонентов, API, потоков данных
    и оптимизаций для системы синергий оружия и имплантов.
  essence: |
    Полная архитектура синергий оружия и имплантов с поддержкой комплексных
    взаимодействий и персонализированными боевыми стилями для каждого класса.

architecture:
  overview: |
    Архитектура системы синергий оружия и имплантов состоит из следующих компонентов:
    1. Synergy Manager - управление синергиями
    2. Weapon-Implant Matcher - сопоставление оружия и имплантов
    3. Class Synergy Calculator - расчет классовых синергий
    4. Environmental Synergy Processor - обработка синергий с окружением
    5. Ability Synergy Activator - активация синергетических способностей
    6. Synergy Balance Validator - валидация баланса синергий
    7. Synergy Effect Combiner - комбинирование эффектов синергий
    8. Synergy Visual Coordinator - координация визуальных эффектов
    9. Synergy Audio Controller - управление звуковыми эффектами
    10. Synergy Telemetry Analyzer - анализ телеметрии синергий

  microservices:
    - name: weapon-synergies-service
      port: 8104
      responsibility: |
        Обработка синергий оружия и имплантов:
        - Управление синергиями оружия и имплантов
        - Расчет классовых бонусов
        - Обработка синергий с окружением
        - Активация способностей синергий
        - Сбор телеметрии
      components:
        - synergy-manager: управление синергиями
        - weapon-implant-matcher: сопоставление оружия и имплантов
        - class-synergy-calculator: расчет классовых синергий
        - environmental-synergy-processor: обработка синергий окружения
        - ability-synergy-activator: активация способностей
        - synergy-balance-validator: валидация баланса
        - synergy-effect-combiner: комбинирование эффектов
        - synergy-visual-coordinator: визуальная координация
        - synergy-audio-controller: звуковой контроль
        - synergy-telemetry-analyzer: анализ телеметрии
      endpoints:
        - POST /api/v1/weapon-synergies/calculate - расчет синергий
        - GET /api/v1/weapon-synergies/{characterId}/active - активные синергии
        - POST /api/v1/weapon-synergies/ability/activate - активация способности
        - GET /api/v1/weapon-synergies/class/{classId}/bonuses - классовые бонусы
        - POST /api/v1/weapon-synergies/environmental/check - проверка окружения
      websocket_channels:
        - wss://api.necp.game/v1/weapon-synergies/{characterId} - обновления синергий
      events_published:
        - synergy.activated: активация синергии
        - synergy.calculated: расчет синергии
        - synergy.ability_triggered: срабатывание способности
        - synergy.bonus_applied: применение бонуса
        - synergy.balance_adjusted: корректировка баланса
      events_subscribed:
        - weapon.equipped: экипировка оружия
        - implant.installed: установка импланта
        - character.class_changed: смена класса
        - environment.entered: вход в зону окружения
        - combat.started: начало боя

  synergy_types:
    weapon_implant_synergies:
      description: "Синергии между оружием и имплантами"
      categories:
        - cybernetic_weapons: кибернетическое оружие + импланты
        - smart_weapon_links: умное оружие + нейроинтерфейсы
        - energy_weapon_synergies: энергетическое оружие + энергосистемы
        - projectile_enhancements: снарядное оружие + системы наведения
        - melee_implant_combos: ближний бой + боевые импланты
      mechanics:
        - stat_multipliers: множители статов
        - ability_unlocks: разблокировка способностей
        - damage_modifiers: модификаторы урона
        - effect_enhancements: усиление эффектов

    class_synergies:
      description: "Классовые синергии с оружием"
      solo_synergies:
        - firearms_mastery: мастерство огнестрельного оружия
        - quickdraw_expert: эксперт быстрой стрельбы
        - tactical_reloading: тактическая перезарядка
        - combat_adaptability: адаптивность в бою
      netrunner_synergies:
        - cyber_hacking: кибер-взлом через оружие
        - smart_weapon_control: контроль умного оружия
        - data_damage_boost: усиление урона данными
        - network_synergy: синергия с сетевыми эффектами
      techie_synergies:
        - weapon_modding: модификация оружия
        - drone_control: контроль дронов
        - explosive_expertise: экспертиза взрывчатки
        - repair_synergy: синергия ремонта
      medtech_synergies:
        - healing_weapons: лечебное оружие
        - regeneration_boost: усиление регенерации
        - chemical_synergy: химическая синергия
        - medical_drones: медицинские дроны

    environmental_synergies:
      description: "Синергии с окружающей средой"
      elemental_environments:
        - fire_zones: огненные зоны усиления
        - water_zones: водные зоны модификации
        - electric_fields: электрические поля проводимости
        - toxic_areas: токсичные зоны усиления
      structural_interactions:
        - metal_surfaces: металлические поверхности для проводимости
        - water_sources: водные источники для распространения
        - explosive_barrels: взрывоопасные объекты
        - reflective_surfaces: отражающие поверхности

  synergy_calculation:
    matching_algorithm:
      weapon_analysis:
        - weapon_type: тип оружия (firearm, melee, energy, etc.)
        - weapon_mods: модификации оружия
        - weapon_effects: эффекты оружия
        - weapon_stats: характеристики оружия
      implant_analysis:
        - implant_type: тип импланта (cybernetic, neural, etc.)
        - implant_tier: уровень импланта
        - implant_effects: эффекты импланта
        - implant_compatibility: совместимость
      compatibility_scoring:
        - perfect_match: 100% совместимость
        - good_match: 75% совместимость
        - moderate_match: 50% совместимость
        - poor_match: 25% совместимость

    synergy_activation:
      trigger_conditions:
        - weapon_equipped: экипировка оружия
        - implant_active: активный имплант
        - environment_match: соответствие окружению
        - combat_state: состояние боя
      activation_priority:
        - critical_synergies: приоритетные синергии
        - class_synergies: классовые синергии
        - environmental_synergies: синергии окружения
        - weapon_implant_synergies: синергии оружия-имплантов

  data_flows:
    synergy_calculation_flow: |
      1. Character equips weapon or installs implant
      2. Synergy Manager receives equipment change
      3. Weapon-Implant Matcher analyzes compatibility
      4. Class Synergy Calculator applies class bonuses
      5. Environmental Synergy Processor checks surroundings
      6. Synergy Effect Combiner merges all effects
      7. Synergy Balance Validator ensures balance
      8. Event synergy.calculated published

    ability_activation_flow: |
      1. Combat conditions met for synergy ability
      2. Ability Synergy Activator evaluates triggers
      3. Synergy requirements checked
      4. Ability effects calculated and applied
      5. Visual and audio effects triggered
      6. Event synergy.ability_triggered published

    environmental_synergy_flow: |
      1. Character enters new environmental zone
      2. Environmental Synergy Processor analyzes zone
      3. Weapon-implant combinations evaluated
      4. Applicable synergies activated
      5. Effect modifiers applied
      6. Event synergy.environmental_activated published

  data_consistency:
    strategy: Strong Consistency для активации синергий, Eventual Consistency для расчетов
    mechanisms:
      - ACID транзакции для применения синергий и модификаторов
      - Optimistic locking для предотвращения конфликтов расчетов
      - Event Sourcing для истории активации синергий
      - Saga Pattern для комплексных синергий с несколькими компонентами

  performance_optimizations:
    memory_optimization:
      synergy_pooling:
        synergy_calculation_pool: size 5000, reuse calculation objects
        matcher_pool: size 2000, reuse matcher instances
        combiner_pool: size 1000, reuse combiner objects

      struct_alignment:
        synergy_struct: [ synergy_id(uuid), character_id(uuid), synergy_type(uint16), strength(float32), active(bool) ]
        compatibility_struct: [ weapon_id(uuid), implant_id(uuid), score(float32), match_type(uint16) ]

    computation_optimization:
      caching_strategy: cache synergy calculations for common combinations
      precomputation: pre-calculate synergies for equipped loadouts
      batch_processing: group synergy updates per character
      spatial_indexing: quick environmental synergy lookups

    network_optimization:
      synergy_delta: send only changed synergy states
      compression_enabled: compress complex synergy data
      priority_streaming: critical synergies sent first
      prediction_support: client-side synergy prediction

  tickrate_specification:
    synergy_processing:
      tickrate: 10-30 Hz для активных синергий, Event-based для расчетов
      network_load: |
        - Synergy calculations: ~0.1-0.4 KB/sec per calculation
        - Ability activations: ~0.2-0.6 KB/sec per activation
        - Environmental checks: ~0.05-0.2 KB/sec per zone change
        - Status updates: ~0.1-0.3 KB/sec per active synergy
        - Total synergy traffic: ~0.5-1.5 KB/sec per player in combat
      latency_requirements: < 50ms для расчетов синергий, < 100ms для активации способностей

  database_structure:
    tables:
      - name: weapon_synergies_definitions
        description: Определения синергий оружия
        columns:
          - id: UUID PRIMARY KEY
          - synergy_type: ENUM (weapon_implant, class_bonus, environmental)
          - weapon_type: VARCHAR(50)
          - implant_type: VARCHAR(50)
          - class_restriction: VARCHAR(50)
          - environmental_condition: VARCHAR(100)
          - effects: JSONB
          - balance_parameters: JSONB
          - created_at: TIMESTAMP

      - name: character_synergies
        description: Активные синергии персонажей
        columns:
          - id: UUID PRIMARY KEY
          - character_id: UUID FOREIGN KEY
          - synergy_id: UUID FOREIGN KEY
          - is_active: BOOLEAN
          - strength_modifier: DECIMAL
          - last_calculated: TIMESTAMP
          - activation_count: INTEGER

      - name: synergy_compatibility_matrix
        description: Матрица совместимости синергий
        columns:
          - id: UUID PRIMARY KEY
          - weapon_type: VARCHAR(50)
          - implant_type: VARCHAR(50)
          - compatibility_score: DECIMAL
          - synergy_effects: JSONB
          - last_updated: TIMESTAMP

      - name: environmental_synergies
        description: Синергии с окружением
        columns:
          - id: UUID PRIMARY KEY
          - zone_type: VARCHAR(50)
          - synergy_type: VARCHAR(50)
          - effect_modifiers: JSONB
          - active_conditions: JSONB
          - created_at: TIMESTAMP

      - name: synergy_telemetry
        description: Телеметрия синергий
        columns:
          - id: UUID PRIMARY KEY
          - event_type: VARCHAR(50)
          - character_id: UUID FOREIGN KEY
          - synergy_type: VARCHAR(50)
          - weapon_id: UUID
          - implant_id: UUID
          - effect_value: DECIMAL
          - created_at: TIMESTAMP

  integrations:
    weapon_system: |
      - Получение данных об экипированном оружии
      - Применение модификаторов от синергий
      - Активация специальных эффектов оружия
      - Синхронизация статов оружия

    implant_system: |
      - Получение данных об установленных имплантах
      - Применение бонусов совместимости
      - Активация имплантных способностей
      - Управление энергетическими системами

    character_system: |
      - Получение данных о классе персонажа
      - Применение классовых бонусов
      - Управление уровнем персонажа для синергий
      - Синхронизация статов персонажа

    environment_system: |
      - Получение данных об окружающей среде
      - Применение модификаторов окружения
      - Активация зональных эффектов
      - Управление динамическими зонами

technical_specification:
  subtasks:
    - id: synergy-manager
      title: Реализация менеджера синергий
      description: |
        Реализация Synergy Manager с координацией всех типов синергий
        и управлением их жизненным циклом.
      dependencies: [ ]
      estimated_effort: 4 days

    - id: weapon-implant-matcher
      title: Реализация сопоставителя оружия и имплантов
      description: |
        Реализация Weapon-Implant Matcher с алгоритмами совместимости
        и расчетом коэффициентов синергии.
      dependencies: [ synergy-manager ]
      estimated_effort: 3 days

    - id: class-synergy-calculator
      title: Реализация калькулятора классовых синергий
      description: |
        Реализация Class Synergy Calculator с правилами классовых бонусов
        и специальными способностями для каждого класса.
      dependencies: [ synergy-manager ]
      estimated_effort: 4 days

    - id: environmental-synergy-processor
      title: Реализация процессора синергий окружения
      description: |
        Реализация Environmental Synergy Processor с анализом зон,
        применением модификаторов и управлением эффектами.
      dependencies: [ synergy-manager ]
      estimated_effort: 3 days

    - id: ability-synergy-activator
      title: Реализация активатора способностей синергий
      description: |
        Реализация Ability Synergy Activator с проверкой условий,
        активацией способностей и управлением кулдаунами.
      dependencies: [ synergy-manager ]
      estimated_effort: 3 days

    - id: synergy-balance-validator
      title: Реализация валидатора баланса синергий
      description: |
        Реализация Synergy Balance Validator с правилами баланса
        для PvP/PvE и автоматической корректировкой.
      dependencies: [ synergy-manager ]
      estimated_effort: 4 days

    - id: synergy-effect-combiner
      title: Реализация комбинатора эффектов синергий
      description: |
        Реализация Synergy Effect Combiner с объединением эффектов
        из разных источников и разрешением конфликтов.
      dependencies: [ synergy-manager ]
      estimated_effort: 3 days

    - id: synergy-visual-coordinator
      title: Реализация визуального координатора
      description: |
        Реализация Synergy Visual Coordinator с управлением
        визуальными эффектами синергий и анимациями.
      dependencies: [ synergy-manager ]
      estimated_effort: 2 days

    - id: synergy-audio-controller
      title: Реализация звукового контроллера
      description: |
        Реализация Synergy Audio Controller с звуковыми эффектами
        для активации синергий и специальных способностей.
      dependencies: [ synergy-manager ]
      estimated_effort: 2 days

    - id: synergy-telemetry-analyzer
      title: Реализация анализатора телеметрии
      description: |
        Реализация Synergy Telemetry Analyzer с сбором данных
        об использовании синергий и аналитикой баланса.
      dependencies: [ synergy-manager ]
      estimated_effort: 2 days

    - id: database-schema-synergies
      title: Создание схемы БД для синергий
      description: |
        Создание таблиц для определений синергий, совместимости
        и телеметрии с индексами и миграциями.
      dependencies: [ ]
      estimated_effort: 3 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]

        Gateway --> WeaponSynergiesService[Weapon Synergies Service<br/>8104]

        WeaponSynergiesService --> SM[Synergy Manager]
        WeaponSynergiesService --> WIM[Weapon-Implant Matcher]
        WeaponSynergiesService --> CSC[Class Synergy Calculator]
        WeaponSynergiesService --> ESP[Environmental Synergy Processor]
        WeaponSynergiesService --> ASA[Ability Synergy Activator]
        WeaponSynergiesService --> SBV[Synergy Balance Validator]
        WeaponSynergiesService --> SEC[Synergy Effect Combiner]
        WeaponSynergiesService --> SVC[Synergy Visual Coordinator]
        WeaponSynergiesService --> SAC[Synergy Audio Controller]
        WeaponSynergiesService --> STA[Synergy Telemetry Analyzer]

        SM --> WIM
        SM --> CSC
        SM --> ESP
        SM --> ASA
        SM --> SBV
        SM --> SEC
        SM --> SVC
        SM --> SAC

        WeaponSynergiesService --> WeaponSystem[Weapon System]
        WeaponSynergiesService --> ImplantSystem[Implant System]
        WeaponSynergiesService --> CharacterSystem[Character System]
        WeaponSynergiesService --> EnvironmentSystem[Environment System]

        WeaponSynergiesService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]

        WeaponSynergiesService --> DB[(Weapon Synergies DB)]
    ```

  synergy_flow_diagram: |
    ```mermaid
    sequenceDiagram
        participant C as Character
        participant SM as Synergy Manager
        participant WIM as Weapon-Implant Matcher
        participant CSC as Class Synergy Calculator
        participant ESP as Environmental Synergy Processor
        participant SEC as Synergy Effect Combiner

        C->>SM: Equip weapon/install implant
        SM->>WIM: Check weapon-implant compatibility
        WIM->>SM: Return compatibility score
        SM->>CSC: Calculate class bonuses
        CSC->>SM: Return class modifiers
        SM->>ESP: Check environmental synergies
        ESP->>SM: Return environmental modifiers
        SM->>SEC: Combine all effects
        SEC->>SM: Return final synergy effects
    ```

history:
  - version: "1.0.0"
    date: 2025-12-06
    author: Architect Agent
    changes: |
      Создана полная архитектура системы синергий оружия и имплантов:
      - Определены компоненты для всех типов синергий (оружие-импланты, классовые, окружение)
      - Спроектирована система совместимости и расчетов синергий
      - Определены API endpoints и WebSocket каналы
      - Спроектированы потоки данных и интеграции с системами
      - Добавлены оптимизации производительности и спецификации тикрейта
      - Создан план подзадач и диаграммы архитектуры
      - Определена структура БД для синергий и совместимости
