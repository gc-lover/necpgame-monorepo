metadata:
  id: world-events-system-architecture
  title: Архитектура системы мировых событий
  document_type: architecture
  category: systems
  status: draft
  version: "1.0.0"
  last_updated: 2025-11-23T23:50:00Z
  owners:
    - role: architect
      contact: architect@necp.game
  tags:
    - architecture
    - world
    - events
    - live-ops
    - narrative
  related_systems:
    - world-service
    - social-service
    - gameplay-service
    - economy-service
    - analytics-service
    - quest-service
    - reputation-service
  related_documents:
    - id: analysis-ideas-2025-11-03-events-brainstorm
      relation: implements
    - id: travel-events-system-architecture
      relation: extends
    - id: economy-events-system-architecture
      relation: extends
  github_issue: 464
  visibility: internal
  audience:
    - architect
    - backend
    - world
    - live-ops
    - api-designer

summary:
  problem: |
    Требуется спроектировать архитектуру системы мировых событий для управления крупными событиями,
    которые влияют на весь мир игры или большие регионы:
    - События разных типов (технологические, политические, военные, спортивные, экологические, сюжетные)
    - События разных масштабов (глобальные, региональные, городские, локальные)
    - События разной частоты (разовые, периодические, регулярные)
    - Влияние на множественные системы (экономика, фракции, социальная динамика, боевая система)
    - Координация между множеством сервисов
    - Планирование и автоматический запуск событий
    - Коммуникация с игроками (баннеры, уведомления, новости)
  goal: |
    Создать архитектурную схему системы мировых событий с определением:
    - Микросервисов для управления событиями
    - Компонентов для планирования, выполнения и мониторинга событий
    - API endpoints (высокоуровнево)
    - Интеграций с другими системами
    - Структуры БД для хранения событий и их эффектов
    - Технического задания для реализации
  essence: |
    Система мировых событий управляет жизненным циклом крупных событий, влияющих на мир игры,
    координирует изменения в множественных системах, синхронизирует через Event Bus и предоставляет
    API для мониторинга и управления событиями.

architecture:
  overview: |
    Система мировых событий состоит из следующих компонентов:
    1. World Events Manager - управление жизненным циклом событий
    2. Event Scheduler - планирование и автоматический запуск событий
    3. Event Effects Coordinator - координация применения эффектов к различным системам
    4. Event Monitor - мониторинг активных событий и метрик
    5. Event Communication Manager - коммуникация с игроками (баннеры, уведомления, новости)
    6. Event Analytics Collector - сбор аналитики по событиям
    7. Event Integration Manager - интеграция с другими сервисами
    8. Event State Manager - управление состоянием событий
    9. Event Scale Manager - управление масштабом событий (глобальные, региональные, городские, локальные)
    10. Event Type Handler - обработчики для разных типов событий

  microservices:
    - name: world-service
      port: 8086
      responsibility: |
        Основной сервис для управления мировыми событиями:
        - CRUD операции с событиями
        - Управление жизненным циклом событий
        - Координация эффектов с другими сервисами
        - Управление масштабом и типом событий
      components:
        - World Events Manager
        - Event Effects Coordinator
        - Event State Manager
        - Event Scale Manager
        - Event Type Handler
      endpoints:
        - GET /api/v1/world/events - список событий
        - GET /api/v1/world/events/{id} - детали события
        - POST /api/v1/world/events - создание события
        - PUT /api/v1/world/events/{id} - обновление события
        - DELETE /api/v1/world/events/{id} - удаление события
        - POST /api/v1/world/events/{id}/announce - анонс события
        - POST /api/v1/world/events/{id}/activate - активация события
        - POST /api/v1/world/events/{id}/deactivate - деактивация события
        - GET /api/v1/world/events/active - активные события
        - GET /api/v1/world/events/planned - запланированные события
        - GET /api/v1/world/events/by-scale/{scale} - события по масштабу
        - GET /api/v1/world/events/by-type/{type} - события по типу
        - GET /api/v1/world/events/by-frequency/{frequency} - события по частоте

    - name: event-scheduler-service
      port: 8090
      responsibility: |
        Планирование и автоматический запуск событий:
        - Cron-задачи для запланированных событий
        - Триггеры от квестов и симуляции
        - Ограничения на количество активных событий
        - Минимальные перерывы между событиями
        - Управление периодическими и регулярными событиями
      components:
        - Event Scheduler
        - Trigger Manager
        - Constraint Validator
        - Frequency Manager
      endpoints:
        - POST /api/v1/scheduler/world-events/schedule - запланировать событие
        - GET /api/v1/scheduler/world-events/scheduled - запланированные события
        - POST /api/v1/scheduler/world-events/{id}/trigger - ручной запуск
        - GET /api/v1/scheduler/world-events/calendar - календарь событий

    - name: economy-service
      port: 8085
      responsibility: |
        Применение экономических эффектов от мировых событий:
        - Модификация цен на ресурсы
        - Изменение курсов валют
        - Влияние на торговлю
        - Экономические кризисы и бумы
      components:
        - Economic Effects Handler
        - Price Modifier Calculator
      endpoints:
        - POST /api/v1/economy/apply-world-event-effects - применить эффекты события
        - GET /api/v1/economy/world-event-effects/{event_id} - эффекты события

    - name: social-service
      port: 8084
      responsibility: |
        Применение социальных эффектов от мировых событий:
        - Изменение репутации фракций
        - Влияние на отношения между фракциями
        - Социальные движения и протесты
        - Изменение настроений NPC
      components:
        - Social Effects Handler
        - Faction Relations Modifier
      endpoints:
        - POST /api/v1/social/apply-world-event-effects - применить эффекты события
        - GET /api/v1/social/world-event-effects/{event_id} - эффекты события

    - name: gameplay-service
      port: 8083
      responsibility: |
        Применение игровых эффектов от мировых событий:
        - Изменение TTK (Time To Kill)
        - Модификация боевых параметров
        - Влияние на доступность контента
        - Военные конфликты и операции
      components:
        - Gameplay Effects Handler
        - Combat Modifier Calculator
      endpoints:
        - POST /api/v1/gameplay/apply-world-event-effects - применить эффекты события
        - GET /api/v1/gameplay/world-event-effects/{event_id} - эффекты события

    - name: analytics-service
      port: 8095
      responsibility: |
        Сбор и анализ метрик по мировым событиям:
        - Player Engagement (вовлеченность игроков)
        - Economic Impact (экономическое влияние)
        - Social Impact (социальное влияние)
        - Event Uptime (время активности событий)
        - Алерты при нарушении прогнозов
      components:
        - Event Analytics Collector
        - Metrics Calculator
        - Alert Manager
      endpoints:
        - GET /api/v1/analytics/world-events/{id}/metrics - метрики события
        - GET /api/v1/analytics/world-events/{id}/engagement - вовлеченность
        - GET /api/v1/analytics/world-events/{id}/impact - влияние на системы
        - GET /api/v1/analytics/world-events/alerts - активные алерты

    - name: notification-service
      port: 8092
      responsibility: |
        Коммуникация с игроками о мировых событиях:
        - Баннеры и уведомления
        - Новости и объявления
        - In-game сообщения
        - Push-уведомления
      components:
        - Event Communication Manager
        - Notification Dispatcher
      endpoints:
        - POST /api/v1/notifications/world-events/{id}/announce - анонс события
        - GET /api/v1/notifications/world-events/active - активные уведомления

  components:
    - name: World Events Manager
      location: world-service
      responsibility: |
        Управление жизненным циклом событий:
        - Создание, обновление, удаление событий
        - Переходы между состояниями (PLANNED → ANNOUNCED → ACTIVE → COOLDOWN → ARCHIVED)
        - Валидация данных событий
        - Управление версиями событий
        - Управление зависимостями между событиями
      dependencies:
        - Event State Manager
        - Event Type Handler
        - Event Scale Manager

    - name: Event Scheduler
      location: event-scheduler-service
      responsibility: |
        Планирование и автоматический запуск событий:
        - Cron-задачи для запланированных событий
        - Триггеры от квестов и симуляции
        - Ограничения на количество активных событий
        - Минимальные перерывы между событиями
        - Управление периодическими и регулярными событиями
      dependencies:
        - World Events Manager
        - Constraint Validator
        - Frequency Manager

    - name: Event Effects Coordinator
      location: world-service
      responsibility: |
        Координация применения эффектов к различным системам:
        - Определение целевых систем для эффектов
        - Последовательное применение эффектов
        - Откат эффектов при завершении события
        - Управление конфликтами между эффектами
      dependencies:
        - Economy Service
        - Social Service
        - Gameplay Service
        - Event State Manager

    - name: Event Monitor
      location: world-service
      responsibility: |
        Мониторинг активных событий и метрик:
        - Отслеживание состояния событий
        - Сбор метрик производительности
        - Мониторинг влияния на системы
        - Алерты при проблемах
      dependencies:
        - Analytics Service
        - Event State Manager

    - name: Event Communication Manager
      location: notification-service
      responsibility: |
        Коммуникация с игроками о мировых событиях:
        - Генерация баннеров и уведомлений
        - Создание новостей и объявлений
        - In-game сообщения
        - Push-уведомления
      dependencies:
        - World Events Manager
        - Notification Dispatcher

    - name: Event Analytics Collector
      location: analytics-service
      responsibility: |
        Сбор аналитики по событиям:
        - Player Engagement метрики
        - Economic Impact метрики
        - Social Impact метрики
        - Event Uptime метрики
        - Генерация отчетов
      dependencies:
        - World Events Manager
        - Event Monitor

    - name: Event Integration Manager
      location: world-service
      responsibility: |
        Интеграция с другими сервисами:
        - Синхронизация через Event Bus
        - Управление зависимостями
        - Обработка ошибок интеграции
        - Retry логика
      dependencies:
        - Event Bus (Kafka)
        - All related services

    - name: Event State Manager
      location: world-service
      responsibility: |
        Управление состоянием событий:
        - Хранение состояния событий
        - Переходы между состояниями
        - Валидация переходов
        - История изменений состояния
      dependencies:
        - Database

    - name: Event Scale Manager
      location: world-service
      responsibility: |
        Управление масштабом событий:
        - Глобальные события (весь мир)
        - Региональные события (регион)
        - Городские события (город)
        - Локальные события (область)
        - Определение целевых регионов
      dependencies:
        - World Events Manager

    - name: Event Type Handler
      location: world-service
      responsibility: |
        Обработчики для разных типов событий:
        - Сюжетные события
        - Технологические события
        - Экономические события
        - Политические события
        - Военные события
        - Спортивные события
        - Экологические события
      dependencies:
        - World Events Manager
        - Event Effects Coordinator

  data_models:
    world_event:
      fields:
        - id: UUID
        - title: string
        - description: string
        - type: enum (STORY, TECHNOLOGICAL, ECONOMIC, POLITICAL, MILITARY, SPORTS, ENVIRONMENTAL)
        - scale: enum (GLOBAL, REGIONAL, CITY, LOCAL)
        - frequency: enum (ONE_TIME, PERIODIC, REGULAR)
        - status: enum (PLANNED, ANNOUNCED, ACTIVE, COOLDOWN, ARCHIVED)
        - start_time: timestamp
        - end_time: timestamp
        - duration: duration
        - effects: array of EventEffect
        - target_regions: array of string
        - target_factions: array of UUID
        - prerequisites: array of UUID
        - cooldown_duration: duration
        - max_concurrent: integer
        - created_at: timestamp
        - updated_at: timestamp
        - version: integer

    event_effect:
      fields:
        - id: UUID
        - event_id: UUID
        - target_system: enum (ECONOMY, SOCIAL, GAMEPLAY, REPUTATION, QUEST)
        - effect_type: string
        - parameters: json
        - start_time: timestamp
        - end_time: timestamp
        - is_active: boolean

    event_schedule:
      fields:
        - id: UUID
        - event_id: UUID
        - scheduled_time: timestamp
        - trigger_type: enum (CRON, MANUAL, QUEST, SIMULATION)
        - trigger_parameters: json
        - status: enum (SCHEDULED, TRIGGERED, CANCELLED)
        - created_at: timestamp

  api_endpoints:
    world_service:
      base_path: /api/v1/world/events
      endpoints:
        - method: GET
          path: /
          description: Список всех событий с фильтрацией
          query_params:
            - status: enum (PLANNED, ANNOUNCED, ACTIVE, COOLDOWN, ARCHIVED)
            - type: enum (STORY, TECHNOLOGICAL, ECONOMIC, POLITICAL, MILITARY, SPORTS, ENVIRONMENTAL)
            - scale: enum (GLOBAL, REGIONAL, CITY, LOCAL)
            - frequency: enum (ONE_TIME, PERIODIC, REGULAR)
            - limit: integer
            - offset: integer
          response: array of WorldEvent

        - method: GET
          path: /{id}
          description: Детали конкретного события
          response: WorldEvent

        - method: POST
          path: /
          description: Создание нового события
          request_body: CreateWorldEventRequest
          response: WorldEvent

        - method: PUT
          path: /{id}
          description: Обновление события
          request_body: UpdateWorldEventRequest
          response: WorldEvent

        - method: DELETE
          path: /{id}
          description: Удаление события
          response: void

        - method: POST
          path: /{id}/announce
          description: Анонс события
          response: WorldEvent

        - method: POST
          path: /{id}/activate
          description: Активация события
          response: WorldEvent

        - method: POST
          path: /{id}/deactivate
          description: Деактивация события
          response: WorldEvent

        - method: GET
          path: /active
          description: Список активных событий
          response: array of WorldEvent

        - method: GET
          path: /planned
          description: Список запланированных событий
          response: array of WorldEvent

        - method: GET
          path: /by-scale/{scale}
          description: События по масштабу
          response: array of WorldEvent

        - method: GET
          path: /by-type/{type}
          description: События по типу
          response: array of WorldEvent

        - method: GET
          path: /by-frequency/{frequency}
          description: События по частоте
          response: array of WorldEvent

    event_scheduler_service:
      base_path: /api/v1/scheduler/world-events
      endpoints:
        - method: POST
          path: /schedule
          description: Запланировать событие
          request_body: ScheduleWorldEventRequest
          response: EventSchedule

        - method: GET
          path: /scheduled
          description: Запланированные события
          response: array of EventSchedule

        - method: POST
          path: /{id}/trigger
          description: Ручной запуск события
          response: WorldEvent

        - method: GET
          path: /calendar
          description: Календарь событий
          query_params:
            - start_date: date
            - end_date: date
          response: array of EventSchedule

  integrations:
    event_bus:
      type: Kafka
      topics:
        - world-events.created
        - world-events.updated
        - world-events.announced
        - world-events.activated
        - world-events.deactivated
        - world-events.effects-applied
        - world-events.effects-removed
      consumers:
        - economy-service
        - social-service
        - gameplay-service
        - notification-service
        - analytics-service
        - realtime-gateway

    database:
      type: PostgreSQL
      schema: world_events
      tables:
        - world_events
        - event_effects
        - event_schedules
        - event_history
        - event_analytics

    cache:
      type: Redis
      keys:
        - world-events:active
        - world-events:planned
        - world-events:{id}
      ttl: 300 seconds

  technical_specification:
    implementation_phases:
      phase_1:
        name: Базовая инфраструктура
        tasks:
          - Создание структуры БД для мировых событий
          - Реализация World Events Manager
          - Реализация Event State Manager
          - Базовые CRUD endpoints
          - Интеграция с Event Bus
        estimated_effort: 5 days

      phase_2:
        name: Планирование и запуск
        tasks:
          - Реализация Event Scheduler
          - Реализация Trigger Manager
          - Реализация Constraint Validator
          - Поддержка периодических и регулярных событий
          - Календарь событий
        estimated_effort: 4 days

      phase_3:
        name: Эффекты и интеграции
        tasks:
          - Реализация Event Effects Coordinator
          - Интеграция с Economy Service
          - Интеграция с Social Service
          - Интеграция с Gameplay Service
          - Управление конфликтами эффектов
        estimated_effort: 6 days

      phase_4:
        name: Масштаб и типы
        tasks:
          - Реализация Event Scale Manager
          - Реализация Event Type Handler
          - Поддержка всех типов событий
          - Управление целевыми регионами
        estimated_effort: 4 days

      phase_5:
        name: Коммуникация и аналитика
        tasks:
          - Реализация Event Communication Manager
          - Интеграция с Notification Service
          - Реализация Event Analytics Collector
          - Интеграция с Analytics Service
          - Мониторинг и алерты
        estimated_effort: 5 days

    total_estimated_effort: 24 days

diagrams:
  component_diagram: |
    ```mermaid
    graph TB
        Client[UE5 Client] --> Gateway[API Gateway]
        
        Gateway --> WorldService[World Service<br/>8086]
        
        WorldService --> WEM[World Events Manager]
        WorldService --> EEC[Event Effects Coordinator]
        WorldService --> ESM[Event State Manager]
        WorldService --> ESCM[Event Scale Manager]
        WorldService --> ETH[Event Type Handler]
        
        Gateway --> EventScheduler[Event Scheduler Service<br/>8090]
        
        EventScheduler --> ES[Event Scheduler]
        EventScheduler --> TM[Trigger Manager]
        EventScheduler --> CV[Constraint Validator]
        EventScheduler --> FM[Frequency Manager]
        
        WorldService --> EconomyService[Economy Service<br/>8085]
        WorldService --> SocialService[Social Service<br/>8084]
        WorldService --> GameplayService[Gameplay Service<br/>8083]
        WorldService --> NotificationService[Notification Service<br/>8092]
        WorldService --> AnalyticsService[Analytics Service<br/>8095]
        
        WorldService --> EventBus[Event Bus<br/>Kafka]
        EventBus --> RealtimeGateway[Realtime Gateway]
        
        WorldService --> DB[(World Events DB)]
        WorldService --> Cache[(Redis Cache)]
        
        Client --> WSWorld[WebSocket<br/>World Events]
        WSWorld --> WorldService
    ```

  event_lifecycle_diagram: |
    ```mermaid
    stateDiagram-v2
        [*] --> PLANNED: Create Event
        PLANNED --> ANNOUNCED: Announce
        ANNOUNCED --> ACTIVE: Activate
        ACTIVE --> COOLDOWN: Complete
        COOLDOWN --> ARCHIVED: Archive
        ACTIVE --> ARCHIVED: Cancel
        ANNOUNCED --> PLANNED: Cancel Announcement
        COOLDOWN --> ACTIVE: Reactivate (Periodic)
    ```

  event_effects_flow: |
    ```mermaid
    graph LR
        Event[World Event] --> Coordinator[Event Effects Coordinator]
        Coordinator --> Economy[Economy Service]
        Coordinator --> Social[Social Service]
        Coordinator --> Gameplay[Gameplay Service]
        Economy --> Prices[Price Changes]
        Economy --> Currency[Currency Changes]
        Social --> Reputation[Reputation Changes]
        Social --> Relations[Faction Relations]
        Gameplay --> TTK[TTK Changes]
        Gameplay --> Content[Content Availability]
    ```








