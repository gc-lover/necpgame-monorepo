metadata:
  id: implementation-player-character-mgmt-part2
  title: "Player Character Management — Part 2: Switching & Management"
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.1'
  last_updated: 2025-11-08T02:08:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: character_system_owner
      contact: characters@necp.game
  tags:
    - character-management
    - sessions
    - stats
  topics:
    - switching
    - state-management
    - snapshots
  related_systems:
    - session-service
    - inventory-service
    - buff-service
  related_documents:
    - id: implementation-player-character-mgmt-part1
      relation: references
  source: shared/docs/knowledge/implementation/backend/player-character-mgmt/part2-switching-management.md
  visibility: internal
  audience:
    - backend
    - gameplay
    - qa
  risk_level: medium
review:
  chain:
    - role: character_system_owner
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: "Нужно обеспечить безопасное переключение персонажей и управление их состоянием во время сессии."
  goal: "Задокументировать сервисы, пересчёт статов и сохранение/загрузку состояния при смене персонажей."
  essence: "Документ описывает workflow switchCharacter, пересчёт статов, сохранение и загрузку состояния, а также систему snapshot."
  key_points:
    - "`switchCharacter` сохраняет текущее состояние, проверяет права, обновляет сессию и публикует события."
    - "Функции пересчёта статов объединяют базовые атрибуты, экипировку и активные бафы."
    - "Сохранение состояния охватывает инвентарь, квесты, позицию, данные сессии и опциональные snapshot."
    - "Восстановление состояния включает загрузку инвентаря, экипировки, прогресса и аренду транспорта."
content:
  sections:
    - id: switching
      title: Переключение персонажей
      body: |
        Метод `switchCharacter` обрабатывает завершение текущей сессии, валидацию нового персонажа, обновление session store,
        установку таймстемпов и публикацию `CharacterSwitchedEvent`.
      mechanics_links: []
      assets: []
    - id: stats
      title: Пересчёт характеристик
      body: |
        Процедура `recalculateCharacterStats` собирает атрибуты, экипировку, бафы, вычисляет итоговые значения здоровья/брони
        и обеспечивает кламп текущего здоровья.
      mechanics_links: []
      assets: []
    - id: save-load
      title: Сохранение и загрузка состояния
      body: |
        `saveCharacterState` и `loadCharacterState` синхронизируют персонажа, инвентарь, экипировку, прогресс квестов,
        состояние сессии и снимают snapshot при необходимости.
      mechanics_links: []
      assets: []
    - id: transport
      title: Управление транспортом и квестами
      body: |
        Документ описывает образцы кода для аренды транспорта, переносов активных заказов и синхронизации с quest-service
        при переключении персонажа.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.1'
    date: 2025-11-07
    author: character_system_owner
    changes: Добавлены процедуры пересчёта статов и snapshots после обновления session сервиса.
validation:
  checksum: ''
  schema_version: '1.0'

