metadata:
  id: trade-system
  title: Backend системы обмена (P2P)
  document_type: implementation
  category: systems
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-09T01:30:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-09T01:30:00Z
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - economy
    - trade
    - backend
  topics:
    - p2p-trading
    - anti-fraud
  related_systems:
    - economy-service
    - inventory-service
    - world-service
  related_documents:
    - id: progression-backend
      relation: references
  source: ''
  visibility: internal
  audience:
    - concept
    - economy
    - backend
  risk_level: high
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: 2025-11-09T01:30:00Z
      status: approved
  next_actions: []
summary:
  problem: Игрокам нужен безопасный механизм обмена предметами и валютой без мошенничества.
  goal: Реализовать backend P2P трейда с двойным подтверждением, аудиторией и контролем расстояния.
  essence: Economy-service обрабатывает trade sessions, проверяет владение предметами, синхронизирует инвентарь и публикует события о сделках.
  key_points:
    - Двухстороннее окно обмена с подтверждением и блокировкой предложений.
    - Лог трейдов и ограничения (bind-on-pickup, дистанция, таймауты).
    - Интеграция с инвентарём, сессиями и событиями экономики.
content:
  sections:
    - id: architecture
      title: Архитектура и интеграции
      body: |
        Сервис трейда работает внутри economy-service (порт 8085) и доступен по маршруту
        `/api/v1/economy/trade/*`. Он публикует события `trade:started`, `trade:completed`,
        `trade:cancelled` и подписывается на перемещение персонажей, завершение сессий и обновления
        инвентаря. Circuit breaker защищает вызовы inventory-service; при недоступности обмен отменяется.
      mechanics_links: []
      assets: []
    - id: data-model
      title: Модель данных
      body: |
        Таблица `trade_sessions` хранит участников, предложения, подтверждения, статус и зону.
        Дополнительная таблица `trade_history` фиксирует завершённые сделки для аудита и расследований.
        Индексы по участникам, статусу и истечению помогают быстро находить активные трейды.
      mechanics_links: []
      assets: []
    - id: flow
      title: Процесс обмена
      body: |
        Инициатор проверяется на онлайн-статус, расстояние и наличие активных трейдов, затем создаёт
        сессию с тайм-аутом 5 минут. Обе стороны формируют предложения, подтверждают и блокируют их;
        при двойном подтверждении сервис переносит предметы и валюту, публикует историю и уведомляет игроков.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references:
    - type: api
      path: api/v1/economy/trade/
    - type: repository
      path: shared/code/backend/economy/trade-service/
  decisions:
    - id: adr-trade-system
      summary: Утверждён кросс-сервисный P2P trade с audit trail и антифрод-инструментами.
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-09
    author: Concept Director
    changes: Утверждён backend P2P трейда с безопасными проверками и аудитом.
validation:
  checksum: ''
  schema_version: '1.0'

