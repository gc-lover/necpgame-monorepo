metadata:
  id: global-state-core
  title: Global State Core Architecture
  document_type: implementation
  category: systems
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T06:00:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T06:00:00Z
  owners:
    - role: ai_brain_manager
      contact: brain@necp.game
  tags:
    - global-state
    - event-sourcing
    - architecture
  topics:
    - backend_platform
    - persistence
  related_systems:
    - state-service
    - analytics-service
    - event-bus
  related_documents:
    - id: global-state-events
      relation: expands
    - id: global-state-management
      relation: expands
    - id: global-state-sync
      relation: expands
    - id: global-state-operations
      relation: expands
  source: shared/docs/knowledge/implementation/global-state/global-state-core.md
  visibility: internal
  audience:
    - backend
    - platform
    - analytics
  risk_level: critical
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Требуется единая система отслеживания состояния мира с полной историей событий.
  goal: Определить архитектуру Global State Core на базе Event Sourcing с описанием схем и процессов.
  essence: Архитектура строится вокруг Event Store, менеджера глобального состояния и механизмов реконструкции и снапшотов.
  key_points:
    - Event Sourcing фиксирует каждое изменение через `game_events`.
    - Состояние хранится в `global_state` с версионностью и ссылками на события.
    - Снапшоты ускоряют реконструкцию и обеспечивают контроль версий.
content:
  sections:
    - id: introduction
      title: 'Краткое описание'
      body: |
        Global State Core агрегирует игровые события через Event Sourcing. Система служит источником правды для состояния игрока, мира и экономики, поддерживая аудит, откаты и аналитику.
      mechanics_links:
        - services/backend/global-state/overview.yaml
      assets: []
    - id: architecture
      title: 'Архитектура'
      body: |
        Клиент взаимодействует через WebSocket и API Gateway. Бэкенд-сервисы публикуют события в шину (Kafka или RabbitMQ), после чего Event Store Writer сохраняет их в PostgreSQL. Global State Manager и аналитика используют данные для реконструкции и метрик, кешируя активные состояния в Redis.
      mechanics_links:
        - services/backend/global-state/architecture-diagram.png
      assets: []
    - id: event_sourcing
      title: 'Паттерн Event Sourcing'
      body: |
        Отказ от CRUD в пользу хранения последовательности событий. Каждое событие отражает изменение состояния, а итоговые данные реконструируются через replay. Это обеспечивает полную историю и гибкие проверки соответствия.
      mechanics_links:
        - mechanics/backend/event-sourcing-guidelines.yaml
      assets: []
    - id: event_store_schema
      title: 'Схема Event Store'
      body: |
        Таблица `game_events` хранит идентификаторы, тип, агрегат, метаданные, полезную нагрузку, контекст и статус обработки. Индексы обеспечивают выборки по агрегату, типу и времени, а поля `correlation_id` и `causation_id` фиксируют цепочки действий.
        ```sql
        CREATE TABLE game_events (
            id BIGSERIAL PRIMARY KEY,
            event_id UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),
            event_type VARCHAR(100) NOT NULL,
            aggregate_type VARCHAR(50) NOT NULL,
            aggregate_id VARCHAR(200) NOT NULL,
            event_version INTEGER NOT NULL DEFAULT 1,
            correlation_id UUID,
            causation_id UUID,
            event_data JSONB NOT NULL,
            metadata JSONB,
            server_id VARCHAR(100) NOT NULL,
            player_id UUID,
            session_id UUID,
            event_timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            processed_at TIMESTAMP,
            state_changes JSONB,
            affected_players JSONB,
            is_processed BOOLEAN DEFAULT FALSE,
            processing_error TEXT,
            retry_count INTEGER DEFAULT 0,
            created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        );
        ```
      mechanics_links:
        - services/backend/global-state/database-schema.yaml
      assets: []
    - id: state_store_schema
      title: 'Схема Global State'
      body: |
        Таблица `global_state` содержит актуальные значения ключей состояния, типы, владельцев, регион, версию и ссылку на событие, которое изменило запись. Индексирование поддерживает быстрый доступ по категории, ключу и владельцу.
      mechanics_links:
        - services/backend/global-state/database-schema.yaml
      assets: []
    - id: snapshots
      title: 'Снапшоты'
      body: |
        Таблица `state_snapshots` хранит агрегированные состояния для ускорения восстановления. Снапшоты создаются каждые 1000 событий, каждый час и при смене лиги. Метаданные фиксируют размер, длительность создания и последний обработанный event.
      mechanics_links:
        - services/backend/global-state/snapshot-strategy.yaml
      assets: []
    - id: key_hierarchy
      title: 'Иерархия ключей состояния'
      body: |
        Ключи формируются по схеме `category.entity.attribute`, что унифицирует доступ к данным игрока, мира и экономики. Примеры включают `player.{playerId}.level`, `world.territory.watson.controller` и `economy.item.mantisBlades.price`.
      mechanics_links:
        - mechanics/world/state-keys.yaml
      assets: []
    - id: integrations
      title: 'Связанные документы'
      body: |
        Дополнительные микрофичи описывают типы событий, управление состоянием, синхронизацию и операции. Они расширяют архитектуру и используют схему Event Store как базу.
      mechanics_links:
        - services/backend/global-state/index.yaml
      assets: []
appendix:
  glossary:
    - term: Event Sourcing
      definition: Паттерн, при котором состояние системы выводится из последовательности неизменяемых событий.
  references:
    - id: global-state-system-split
      description: Исторический документ разделения глобальной системы на микрофичи.
  decisions: []
implementation:
  github_issue: 136
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: AI Brain Manager
    changes: Зафиксирована архитектура Global State Core.
validation:
  checksum: ''
  schema_version: '1.0'

