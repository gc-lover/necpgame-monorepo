metadata:
  id: infrastructure-error-handling-logging
  title: Error Handling & Logging
  document_type: implementation
  category: infrastructure
  status: draft
  version: '1.0.0'
  last_updated: 2025-11-07T00:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: infrastructure_lead
      contact: infrastructure@necp.game
  tags:
    - logging
    - monitoring
    - error-handling
  topics:
    - observability
    - platform
  related_systems:
    - monitoring-service
    - logging-stack
  related_documents:
    - id: infrastructure-api-gateway-architecture
      relation: references
    - id: infrastructure-database-architecture
      relation: references
  source: shared/docs/knowledge/implementation/infrastructure/error-handling-logging.md
  visibility: internal
  audience:
    - infrastructure
    - devops
    - backend
  risk_level: high
review:
  chain:
    - role: infrastructure_lead
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Логи и ошибки разбросаны по сервисам, отсутствует централизованная стратегия наблюдаемости и оповещений.
  goal: Описать целевую архитектуру обработки ошибок и логирования для микросервисов NECPGAME.
  essence: Документ задаёт стек ELK, distributed tracing, структуру логов, SLA по уровням логирования, мониторинг, алертинг и принципы клиентских/серверных ответов.
  key_points:
    - Централизованное хранение логов через ELK и трассировка запросов по trace_id.
    - Единые уровни логирования и формат JSON с обязательными полями.
    - Разделение ошибок на клиентские и серверные с стандартизированными payload.
    - Метрики, алерты и инструменты мониторинга, включая Prometheus, Grafana, Sentry.
content:
  sections:
    - id: architecture_overview
      title: Микросервисная архитектура
      body: |
        Централизованная система основана на стеке ELK: микросервисы отправляют логи в Logstash, который передаёт
        записи в Elasticsearch, а визуализация и поиск выполняются в Kibana. Все сервисы (auth, character, gameplay,
        social, economy, world) публикуют структурированные события.

        Для распределённых запросов применяется трассировка (Zipkin/Jaeger). Клиентский запрос получает trace_id в API
        Gateway и передаёт его по цепочке сервисов. Все логи с одинаковым trace_id позволяют восстановить путь запроса.
      mechanics_links: []
    - id: logging_levels
      title: Уровни и политика логирования
      body: |
        Иерархия уровней: TRACE, DEBUG, INFO, WARN, ERROR, FATAL. В production включены только INFO и выше. DEBUG/TRACE
        используются локально для отладки. Для каждого сервиса определяется политика хранения и ротации.
      mechanics_links: []
    - id: log_structure
      title: Формат логов
      body: |
        Логи сериализуются в JSON и содержат timestamp, уровень, сервис, trace_id, player_id, message, описание ошибки
        и контекст. Формат унифицирован для анализа и интеграции со сторонними инструментами.
      mechanics_links: []
    - id: error_handling
      title: Ответы об ошибках
      body: |
        Клиентские ошибки (400) возвращают структурированное тело с кодом, сообщением и полем. Серверные ошибки (500)
        скрывают детали внутренней реализации и включают trace_id для диагностики. Запрещено раскрывать стек трейс клиенту.
      mechanics_links: []
    - id: monitoring
      title: Мониторинг и метрики
      body: |
        Метрические показатели включают request rate, error rate, латентность p50/p95/p99. Пороговые значения (например,
        error rate > 1%) инициируют алерты. Используются Prometheus для метрик, Grafana для дашбордов, Sentry для
        отслеживания ошибок и Elastic Stack для логов.
      mechanics_links: []
    - id: alerting
      title: Алерты и реагирование
      body: |
        Алерты настраиваются для ключевых порогов (ошибки, недоступность БД, деградация latency). Уведомления отправляются
        в Slack, по email и в PagerDuty. Для критических инцидентов предусмотрены телефонные вызовы on-call инженерам.
      mechanics_links: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-06
    author: infrastructure_lead
    changes: Стартовое описание централизованной системы обработки ошибок и логирования.
validation:
  checksum: ''
  schema_version: '1.0'

