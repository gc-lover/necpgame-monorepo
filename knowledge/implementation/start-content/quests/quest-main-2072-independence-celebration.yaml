# Issue: #15
metadata:
  id: quest-main-2072-independence-celebration
  title: "Основной квест: Празднование независимости (2072)"
  document_type: implementation
  category: start-content
  status: in-review
  version: '2.0.0'
  last_updated: 2025-12-01T00:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - questline
    - downtown
    - security
  topics:
    - quests
    - social
    - combat
  related_systems:
    - gameplay-service
    - quest-service
    - narrative-service
    - character-service
    - economy-service
  related_documents:
    - id: quest-main-2065-gray-theater
      relation: precedes
  source: shared/docs/knowledge/implementation/start-content/quests/quest-main-2072-independence-celebration.md
  visibility: internal
  audience:
    - concept
    - gameplay
    - analytics
  risk_level: medium
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: [ ]
summary:
  problem: Ежегодное празднование независимости в Downtown может перерасти в хаос из-за заговорщиков и толпы.
  goal: Описать shooter-сценарий патрулирования, расследования и деэскалации для защиты события.
  essence: Игрок помогает Саре Миллер выявить угрозы, удержать площадь под контролем и завершить мероприятие без жертв.
  key_points:
    - Стадии патруля с проверками PERCEPTION/COOL/INVESTIGATION.
    - Диалоговое дерево на 24 узла, ведущее к складу заговорщиков.
    - Награды и API-мэппинг, учитывающие социальные и боевые исходы.
quest_definition:
  quest_type: main
  level_min: 8
  level_max: null
  requirements:
    required_quests: [ ]
    required_flags: [ ]
    required_reputation: { }
    required_items: [ ]
  objectives:
    - id: accept_quest
      text: "Принять задание у Сары Миллер"
      type: interact
      target: npc-sarah-miller
      count: 1
      optional: false
    - id: patrol_area
      text: "Патрулировать площадь и выявить угрозы (PERCEPTION 16 для обнаружения закладок, COOL 16 для деэскалации толпы, INVESTIGATION 15 для выявления канала заговорщиков)"
      type: perform
      target: downtown-square-patrol
      count: 1
      optional: false
    - id: prevent_incidents
      text: "Предотвратить инциденты и задержать заговорщиков (Recon Sweep, Crowd De-escalation, Conspiracy Trace)"
      type: perform
      target: incident-prevention
      count: 1
      optional: false
    - id: handle_encounters
      text: "Обработать боевые сценарии (Street Clash, Warehouse Raid, Patrol Ambush) при необходимости"
      type: combat
      target: conspiracy-encounters
      count: 1
      optional: true
    - id: report_to_sarah
      text: "Вернуться к Саре Миллер с отчётом"
      type: interact
      target: npc-sarah-miller
      count: 1
      optional: false
  rewards:
    experience: 680
    currency: 900
    items: [ ]
    reputation:
      ncpd: 25
    flags:
      - independence-celebration-quest-completed
      - downtown-security-unlocked
  branches:
    - id: perception_path
      unlock_condition:
        type: skill_check
        skill: perception
        min_value: 16
      consequences:
        experience: 100
        currency: 0
        reputation:
          ncpd: 5
        flags:
          - perception-master-unlocked
        unlocked_content:
          - quest_type: side
            category: investigation
            location: global
    - id: cool_deescalation_path
      unlock_condition:
        type: skill_check
        skill: cool
        min_value: 16
      consequences:
        experience: 100
        currency: 100
        reputation:
          ncpd: 10
        flags:
          - social-master-unlocked
        unlocked_content:
          - quest_type: side
            category: social
            location: global
    - id: investigation_path
      unlock_condition:
        type: skill_check
        skill: investigation
        min_value: 15
      consequences:
        experience: 100
        currency: 50
        reputation:
          ncpd: 5
        flags:
          - investigation-master-unlocked
          - warehouse-raid-unlocked
        unlocked_content:
          - quest_type: side
            category: investigation
            location: downtown
content:
  sections:
    - id: synopsis
      title: Синопсис
      body: |
        - ID: `quest-main-2072-independence-celebration`
        - Контакт: `npc-sarah-miller`
        - Локация: `loc-downtown-001`
        - Уровень: 8
        - Основные роли: patrol, investigation, de-escalation
      mechanics_links:
        - mechanics/quests/quest-system.yaml
    - id: objectives
      title: Цели и ветвления
      body: |
        Основной маршрут:
        1. Принять задание у Сары Миллер.
        2. Патрулировать площадь и выявить угрозы.
        3. Предотвратить инциденты и задержать заговорщиков.
        4. Вернуться к Саре с отчётом.

        Ветви:
        - PERCEPTION 16 — заранее обнаружить закладки, снизить число боёв.
        - COOL 16 — деэскалация толпы, бонус к репутации NCPD.
        - INVESTIGATION 15 — выявить канал заговорщиков, открыть ветку склада.
      mechanics_links:
        - mechanics/combat/combat-shooter-core.yaml
    - id: interactions
      title: Shooter взаимодействия
      body: |
        - `Recon Sweep`: PERCEPTION 16, equipment `optic_suite`, событие `quest.recon.scan`, уменьшает встречи.
        - `Crowd De-escalation`: COOL 16, ресурс `NCPD megaphone`, событие `quest.social.presence`, бонус репутации.
        - `Conspiracy Trace`: INVESTIGATION 15, событие `quest.investigation.trace`, открывает склад.
      mechanics_links:
        - mechanics/combat/combat-overview.yaml
    - id: encounters
      title: Боевые сценарии
      body: |
        - `Street Clash`: 2 нарушителя (defense 180–190), инициируется при провале COOL.
        - `Warehouse Raid`: 3 лидера (defense 200), альтернатива сдаче через COOL 16.
        - `Patrol Ambush`: triggered при провале INVESTIGATION, 2–3 врага.
      mechanics_links:
        - mechanics/combat/combat-shooter-core.yaml
    - id: dialogue
      title: Диалоговое дерево
      body: |
        24 узла: старт у Сары, ветви угроз, патруля, слежки за складом и финальный отчёт. Узлы `p_cool_ok`, `p_invest_ok`, `p_surrender` формируют основные исходы.
      mechanics_links:
        - mechanics/social/social-mechanics-overview.yaml
    - id: rewards
      title: Награды и баланс
      body: |
        Базовые награды: 680 XP, 900 eddies, +25 репутации NCPD.
        Бонусы: успехи PERCEPTION/COOL/INVESTIGATION дают доп. репутацию и XP, снижают количество боёв.
        Штрафы: провал проверок добавляет встречи, поражение в бою → медпункт и −10% денег.
      mechanics_links:
        - mechanics/economy/stock-exchange/stock-analytics.yaml
    - id: interfaces
      title: API и телеметрия
      body: |
        REST:
        - `POST /api/v1/quests/{id}/accept`
        - `POST /api/v1/skill-check`
        - `POST /api/v1/combat/start`
        - `POST /api/v1/quests/{id}/complete`

        Kafka:
        - `quest.progress.main`
        - `combat.shooter.encounter`
        - `analytics.quest.ncpd`

        SLA: latency ≤ 180 мс на патрульных ивентах, отслеживание деэскалаций.
      mechanics_links:
        - implementation/backend/quest-engine-backend.yaml
    - id: qa
      title: Тестирование
      body: |
        - Social Path: успешная деэскалация, минимум боёв.
        - Combat Path: провал проверок, складовое сражение.
        - Investigation Path: слежка, задержание лидеров без боя.
        - Failure Loop: поражение и возврат через медпункт.
      mechanics_links:
        - mechanics/quests/quest-system.yaml
appendix:
  glossary: [ ]
  references: [ ]
  decisions: [ ]
implementation:
  needs_task: false
  github_issue: 15
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#quest-main-2072-independence-celebration
  blockers: [ ]
history:
  - version: '2.0.0'
    date: 2025-12-01
    author: content_writer
    changes: 'Добавлен Issue в начало файла. Добавлена полная структура quest_definition с objectives, rewards и branches согласно архитектуре системы квестов. Создано 5 objectives на основе контента квеста (принять задание, патрулировать площадь, предотвратить инциденты, обработать боевые сценарии, вернуться с отчётом). Добавлены rewards: 680 XP, 900 currency, репутация ncpd: 25, флаги для разблокировки контента. Добавлены 3 branches (perception_path, cool_deescalation_path, investigation_path) с правильной структурой unlock_condition и consequences, учитывающие проверки навыков PERCEPTION 16, COOL 16, INVESTIGATION 15.'
  - version: '1.0.0'
    date: 2025-11-06
    author: concept_team
    changes: Первичная shooter-спецификация праздника независимости.
validation:
  checksum: ''
  schema_version: '1.0'

