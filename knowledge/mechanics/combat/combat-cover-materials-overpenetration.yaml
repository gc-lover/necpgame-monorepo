# Issue: #1768
metadata:
  id: combat-cover-materials-overpenetration
  title: 'Разрушаемое укрытие по материалам (over-penetration)'
  document_type: mechanics
  category: combat
  status: draft
  version: '0.1.0'
  last_updated: 2025-12-12T00:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: game_balance
      contact: balance@necp.game
  tags:
    - cover
    - penetration
    - ricochet
    - risk_reward
  topics:
    - combat_effects
    - environment
  related_systems:
    - gameplay-service
    - combat-service
    - realtime-service
    - ai-service
  related_documents:
    - id: combat-shooter-core
      relation: interacts_with
    - id: combat-suppression-sound-ai
      relation: complements
  source: ''
  visibility: internal
  audience:
    - combat
    - gameplay
    - analytics
  risk_level: medium
review:
  chain:
    - role: game_balance_lead
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: [ ]
summary:
  problem: Нужна таблица материалов укрытий, пробитие/over-penetration и реакция AI/UX.
  goal: Определить HP укрытий, pen-модификаторы, модель потери урона после пробития, рикошеты и индикацию прочности.
  essence: Разные материалы имеют свои HP и pen-резисты; высокие калибры пробивают, но теряют урон при over-penetration. Игрок и AI получают визуальные подсказки о прочности.
  key_points:
    - Материалы с HP и pen_mod.
    - Over-penetration: потеря урона/скорости пули.
    - AI реагирует на ломание, UX показывает состояние укрытия.
content:
  sections:
    - id: materials_table
      title: Материалы и HP
      body: |
        Таблица (hp_cover — суммарная прочность, pen_mod — множитель к требуемому pen):
        - Стекло: hp 60, pen_mod 0.6, ricochet 2%.
        - Дерево: hp 140, pen_mod 0.8, ricochet 5%.
        - Гипс/легкие панели: hp 110, pen_mod 0.9, ricochet 4%.
        - Композит: hp 240, pen_mod 1.1, ricochet 8%.
        - Кирпич: hp 320, pen_mod 1.2, ricochet 10%.
        - Бетон: hp 480, pen_mod 1.35, ricochet 14%.
        - Армированная сталь: hp 720, pen_mod 1.6, ricochet 18%.
        Укреплённые укрытия используют слои (см. hardcode/pen docs), но для базовой модели применяем однослойно.
    - id: penetration_model
      title: Пробитие и урон после пробития
      body: |
        Требование к пробитию: bullet_pen >= pen_mod * material_threshold.
        material_threshold для калибров: pistol 80, smg 100, rifle 130, dmr 170, ap 220, sniper 260.
        Over-penetration потеря урона: `dmg_after = dmg * clamp(1 - 0.18 * (thickness / bullet_pen), 0.4, 1)`.
        Потеря скорости пули: `vel_after = vel * clamp(1 - 0.22 * (thickness / bullet_pen), 0.35, 1)`.
        thickness для материалов: стекло 0.5, дерево 1.0, гипс 0.8, композит 1.2, кирпич 1.4, бетон 1.8, сталь 2.2.
    - id: cover_break
      title: Ломание укрытий и UX
      body: |
        Прочность укрытия уменьшается суммарным нанесённым уроном (до брони). При 50% HP появляется трещина VFX, при 20% — предкритический VFX + звук.
        Индикация игроку: пиктограмма слоя (3 состояния). Для AI/союзников — упрощённый битфлаг (intact/damaged/critical).
        После разрушения укрытие становится «обломками» с pen_mod 0.5 и hp 30 (для шрапнели).
    - id: ricochet
      title: Рикошеты
      body: |
        Шанс рикошета = base_ricochet * angle_mod, где base_ricochet из таблицы, angle_mod = clamp((impact_angle - 35)/25, 0, 1).
        При рикошете пуля теряет 40% урона и меняет траекторию на отражённый угол + случайный дрейф 6°.
    - id: ai_reaction
      title: Реакция AI
      body: |
        При HP укрытия <40% AI помечает укрытие как unsafe, ищет новое в радиусе 12 м.
        При разрушении: AI триггерит «break_cover» — отступление/фланг или дым.
        В PvE элитные AI имеют «brace» перк: игнорируют первое падение до 70% HP укрытия.
    - id: telemetry
      title: Телеметрия
      body: |
        Логировать:
        - `cover.break_events` (материал, время жизни).
        - `cover.penetrations` (type, dmg_after, vel_after).
        - `cover.ricochet_events`.
        - `cover.ai_reacts` (unsafe, break_cover).
appendix:
  glossary:
    - term: pen_mod
      definition: Множитель к требуемому пробитию для материала.
  formulas:
    - name: dmg_after
      expression: dmg_after = dmg * clamp(1 - 0.18 * (thickness / bullet_pen), 0.4, 1)
      notes: Потеря урона после пробития; thickness материал, bullet_pen — рейтинг боеприпаса.
implementation:
  needs_task: false
  github_issue: 1768
  queue_reference: [ ]
  blockers: [ ]
history:
  - version: '0.1.0'
    date: 2025-12-12
    author: game_balance_team
    changes: Базовая таблица материалов, модель over-penetration, UX/AI и телеметрия.
validation:
  checksum: ''
  schema_version: '1.0'

