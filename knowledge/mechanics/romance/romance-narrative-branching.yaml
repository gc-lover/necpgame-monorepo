metadata:
  id: romance-narrative-branching
  title: Нарративное ветвление в романтических историях NECPGAME
  document_type: mechanics
  category: romance
  status: draft
  version: '1.0.0'
  last_updated: 2025-12-20T07:00:00Z
  concept_approved: false
  concept_reviewed_at: ''
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - romance
    - narrative
    - branching
    - social
  topics:
    - story-branching
    - relationship-dynamics
  related_systems:
    - romance-service
    - narrative-service
    - quest-service
  related_documents:
    - id: romance-relationship-progression
      relation: complements
    - id: quest-system-branching-stories
      relation: references
  source: shared/docs/knowledge/mechanics/romance/romance-narrative-branching.md
  visibility: internal
  audience:
    - concept
    - narrative
    - systems
  risk_level: high
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Романтические истории развивались линейно без учета выборов игрока и динамики отношений.
  goal: Создать систему ветвящихся романтических нарративов с множественными концовками и последствиями выборов.
  essence: Каждая романтическая линия имеет 3-5 основных ветвей с уникальными событиями, диалогами и исходами.
  key_points:
    - 4 типа ветвления с разными механиками
    - Система флагов и состояний отношений
    - Динамическое влияние на основной сюжет
    - Множественные концовки для каждой романтической линии
content:
  sections:
    - id: branching_types
      title: Типы нарративного ветвления
      body: |
        Романтические истории используют четыре типа ветвления:

        **Ветвление по выбору (Choice Branching):**
        - Прямые диалоговые выборы определяют направление
        - Немедленные последствия для RP
        - Влияние на будущие взаимодействия

        **Ветвление по поведению (Behavioral Branching):**
        - Долгосрочные паттерны поведения формируют ветвь
        - Автоматическое определение на основе действий
        - Требует времени для проявления

        **Ветвление по событиям (Event Branching):**
        - Внешние события изменяют направление истории
        - Случайные и сюжетные триггеры
        - Влияние мира на романтические отношения

        **Ветвление по конфликтам (Conflict Branching):**
        - Разрешение конфликтов определяет исход
        - Множественные пути восстановления
        - Альтернативные концовки отношений
      mechanics_links:
        - mechanics/quests/quest-system.yaml
      assets: []

    - id: romance_flags_system
      title: Система флагов романтических отношений
      body: |
        Флаги отслеживают состояние и историю отношений:

        **Основные флаги состояния:**
        - `romance_stage`: текущая стадия отношений (1-7)
        - `romance_type`: тип романтической связи (romantic/partner/forbidden/etc.)
        - `trust_level`: уровень доверия (0-100)
        - `intimacy_level`: уровень близости (0-100)

        **Исторические флаги:**
        - `first_meeting_date`: дата первого знакомства
        - `major_events`: массив значимых событий
        - `conflict_history`: история конфликтов и их разрешения
        - `shared_secrets`: уровень раскрытия личной информации

        **Динамические флаги:**
        - `current_mood`: текущее эмоциональное состояние
        - `recent_interactions`: последние 10 взаимодействий
        - `pending_events`: предстоящие события отношений
        - `relationship_health`: общий статус здоровья отношений (0-100)
      mechanics_links:
        - mechanics/social/npc-relationships-system.yaml
      assets: []

    - id: choice_driven_branching
      title: Ветвление через выборы игрока
      body: |
        Диалоговые выборы формируют уникальные нарративные пути:

        **Критические выборы (Major Choices):**
        - Определяют основное направление истории
        - Блокирующий эффект на другие ветви
        - Значительное влияние на RP (±50-200)

        **Второстепенные выборы (Minor Choices):**
        - Влияют на детали и атмосферу
        - Накапливающийся эффект на отношения
        - Малое влияние на RP (±5-25)

        **Последовательные выборы (Chain Choices):**
        - Серия связанных выборов
        - Каждый выбор влияет на следующие опции
        - Кумулятивный эффект на исход

        **Моральные дилеммы:**
        - Выбор между любовью и принципами
        - Конфликт лояльностей (партнер vs друзья/семья)
        - Этические компромиссы ради отношений
      mechanics_links:
        - mechanics/romance/romance-conflict-resolution.yaml
      assets: []

    - id: behavioral_branching_mechanics
      title: Механики поведенческого ветвления
      body: |
        Поведение игрока автоматически формирует нарративные пути:

        **Паттерны поведения:**
        - **Романтический:** Частые комплименты, подарки, внимание
        - **Практичный:** Фокус на взаимной выгоде, совместные цели
        - **Рискованный:** Совместные авантюры, игнорирование опасностей
        - **Надежный:** Стабильность, поддержка, предсказуемость

        **Определение доминирующего паттерна:**
        ```
        pattern_score = sum(action_weights) / action_count
        dominant_pattern = max(pattern_scores)
        ```

        **Переключение паттернов:**
        - Требует последовательных действий
        - Минимальный период для смены (7 дней)
        - RP бонус/штраф за резкие изменения

        **Влияние на нарратив:**
        - Разные события для каждого паттерна
        - Уникальные диалоги и взаимодействия
        - Альтернативные концовки
      mechanics_links:
        - mechanics/social/reputation-formulas.yaml
      assets: []

    - id: event_driven_branching
      title: Ветвление через события мира
      body: |
        Внешние события Night City влияют на романтические истории:

        **Корпоративные события:**
        - Слияния компаний влияют на карьеру партнера
        - Корпоративные интриги создают конфликты
        - Экономические кризисы меняют приоритеты

        **Уличные события:**
        - Бандитские войны требуют защиты
        - Полицейские рейды создают напряжение
        - Уличные фестивали создают романтическую атмосферу

        **Глобальные события:**
        - Изменения в законодательстве о модификациях
        - Эпидемии и пандемии влияют на взаимодействия
        - Технологические прорывы меняют динамику отношений

        **Случайные события:**
        - Неожиданные встречи в городе
        - Совместные проблемы требующие решения
        - Внешние угрозы требующие защиты
      mechanics_links:
        - mechanics/world/dynamic-events-system.yaml
      assets: []

    - id: romance_endings_system
      title: Система концовок романтических историй
      body: |
        Каждая романтическая линия имеет множественные исходы:

        **Положительные концовки:**
        - **Счастливая любовь:** Совместная жизнь, поддержка, рост
        - **Страстная связь:** Интенсивные отношения, приключения
        - **Надежное партнерство:** Стабильность, взаимная выгода
        - **Эпическая история:** Легендарная любовь, влияющая на город

        **Нейтральные концовки:**
        - **Дружба:** Переход в крепкую дружбу
        - **Профессиональные отношения:** Совместная работа
        - **Воспоминания:** Завершенная глава жизни

        **Негативные концовки:**
        - **Болезненный разрыв:** Эмоциональные травмы, горе
        - **Вражда:** Превращение в противников
        - **Трагедия:** Потеря из-за внешних обстоятельств
        - **Пустота:** Постепенное угасание без конфликта

        **Факторы, влияющие на концовку:**
        - Общий RP на момент завершения
        - Количество разрешенных конфликтов
        - Выполненные совместные цели
        - Внешние события и вмешательства
      mechanics_links:
        - mechanics/romance/romance-outcome-determination.yaml
      assets: []

    - id: romance_interactions_main_plot
      title: Взаимодействие с основным сюжетом
      body: |
        Романтические линии влияют на основной нарратив игры:

        **Влияние на основной сюжет:**
        - Альянсы и коалиции через романтические связи
        - Доступ к эксклюзивным квестам и локациям
        - Изменение репутации в разных фракциях
        - Альтернативные сюжетные ветви

        **Романтические NPC в сюжете:**
        - Возможность вовлечь партнера в сюжетные события
        - Конфликты лояльности между любовью и миссиями
        - Совместные сюжетные арки
        - Влияние на решения и концовки игры

        **Динамическое влияние:**
        - Решения в отношениях влияют на доступные сюжетные пути
        - Романтические события могут блокировать или открывать сюжетные ветви
        - RP влияет на исход ключевых сюжетных моментов
        - Возможность романтических суб-сюжетов
      mechanics_links:
        - mechanics/quests/quest-system.yaml
      assets: []

    - id: romance_replayability
      title: Переигрываемость романтических историй
      body: |
        Система обеспечивает высокую переигрываемость:

        **Множественные пути:**
        - 3-5 основных ветвей на романтическую линию
        - 8-12 различных концовок
        - 20+ значимых выборов на линию

        **Динамические элементы:**
        - Случайные события влияют на исход
        - Внешние факторы меняют доступные опции
        - Поведение NPC реагирует на действия игрока

        **Сохранение прогресса:**
        - Возможность возобновления отношений в новых прохождениях
        - Перенос романтических достижений между сохранениями
        - Альтернативные timeline для тех же персонажей

        **Рандомизация элементов:**
        - Варьирующиеся детали в повторных прохождениях
        - Случайные побочные события
        - Динамические NPC реакции на выборы
      mechanics_links:
        - mechanics/world/procedural-generation-algorithms.yaml
      assets: []

    - id: implementation_considerations
      title: Особенности реализации
      body: |
        Технические аспекты системы ветвления:

        **Хранение состояния:**
        - Redis для быстрого доступа к флагам отношений
        - PostgreSQL для исторических данных
        - Кэширование часто используемых состояний

        **Производительность:**
        - Предварительный расчет возможных ветвей
        - Ленивая загрузка неактивных романтических линий
        - Оптимизация запросов к состоянию отношений

        **Масштабируемость:**
        - Поддержка множественных активных романтических линий
        - Независимое состояние для каждого NPC
        - Возможность паузы/возобновления отношений

        **Тестирование:**
        - Автоматизированные тесты всех ветвей
        - Ручное тестирование нарративной связности
        - Баланс-тестирование влияния выборов на RP
      mechanics_links:
        - mechanics/social/social-service-architecture.yaml
      assets: []
appendix:
  glossary:
    - term: "RP (Relationship Points)"
      definition: "Очки отношений, определяющие прогрессию и исход"
    - term: "Behavioral Branching"
      definition: "Ветвление на основе паттернов поведения игрока"
    - term: "Event Branching"
      definition: "Ветвление под влиянием внешних событий мира"
  references:
    - "Narrative Branching in Open World RPGs"
    - "Cyberpunk 2077 Romance System Design"
  decisions:
    - date: 2025-12-20
      decision: "4 типа ветвления для максимальной гибкости нарратива"
      rationale: "Позволяет создать глубокие и вариативные романтические истории"
  implementation:
    needs_task: true
    github_issue: 82
    queue_reference:
      - shared/trackers/queues/concept/queued.yaml
    blockers: []
history:
  - version: '1.0.0'
    date: 2025-12-20
    author: Idea Writer Agent
    changes: Создана система нарративного ветвления для романтических историй с 4 типами ветвления и множественными концовками
validation:
  checksum: ''
  schema_version: '1.0'


