openapi: 3.0.3
info:
  title: AI Adaptive Service API
  description: |
    API для системы адаптивного AI: анализ тактик игроков, адаптация поведения врагов,
    применение контр-стратегий и обучение моделей машинного обучения.
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8090/api/v1/ai
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1/ai
    description: Продакшен сервер

tags:
  - name: Tactics Analysis
    description: Анализ тактик игроков
  - name: Adaptations
    description: Адаптации AI
  - name: Training
    description: Обучение моделей

paths:
  /analyze/tactics:
    post:
      tags:
        - Tactics Analysis
      summary: Проанализировать тактики команды
      description: |
        Анализирует тактики команды игроков в реальном времени: позиции, способности,
        паттерны атак и определяет слабые места для применения контр-стратегий.
      operationId: analyzeTactics
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalyzeTacticsRequest'
            example:
              encounter_id: 'aa0e8400-e29b-41d4-a716-446655440000'
              player_actions:
                - player_id: '110e8400-e29b-41d4-a716-446655440000'
                  position: { x: 10.5, y: 5.2, z: 2.1 }
                  abilities_used: ['fire_blast', 'shield_wall']
                  damage_dealt: 1250
                  damage_taken: 350
                  movement_pattern: 'aggressive'
                - player_id: '110e8400-e29b-41d4-a716-446655440001'
                  position: { x: 8.3, y: 6.1, z: 2.0 }
                  abilities_used: ['heal', 'buff']
                  damage_dealt: 200
                  damage_taken: 150
                  movement_pattern: 'defensive'
      responses:
        '200':
          description: Результаты анализа тактик
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TacticsAnalysisResult'
              example:
                encounter_id: 'aa0e8400-e29b-41d4-a716-446655440000'
                analysis_id: 'bb0e8400-e29b-41d4-a716-446655440000'
                weak_points:
                  - type: positioning
                    description: Команда группируется, уязвима к AOE атакам
                    severity: high
                  - type: support_focus
                    description: Саппорт часто на передовой, легко доступен
                    severity: medium
                recommended_adaptations:
                  - type: aoe_focus
                    priority: high
                  - type: support_targeting
                    priority: medium
                analyzed_at: '2025-12-01T10:30:00Z'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /adaptations/{encounter_id}:
    get:
      tags:
        - Adaptations
      summary: Получить текущие адаптации AI
      description: |
        Возвращает список активных адаптаций AI для конкретного энкаунтера,
        включая тип адаптации и примененные модификаторы.
      operationId: getAdaptations
      security:
        - BearerAuth: []
      parameters:
        - name: encounter_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID энкаунтера
      responses:
        '200':
          description: Текущие адаптации AI
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdaptationsResponse'
              example:
                encounter_id: 'aa0e8400-e29b-41d4-a716-446655440000'
                adaptations:
                  - id: 'cc0e8400-e29b-41d4-a716-446655440000'
                    enemy_id: 'dd0e8400-e29b-41d4-a716-446655440000'
                    adaptation_type: aoe_focus
                    adaptation_data:
                      aoe_ability_usage: 1.5
                      target_selection: 'grouped_players'
                    applied_at: '2025-12-01T10:25:00Z'
                  - id: 'cc0e8400-e29b-41d4-a716-446655440001'
                    enemy_id: 'dd0e8400-e29b-41d4-a716-446655440001'
                    adaptation_type: support_targeting
                    adaptation_data:
                      target_priority: 'support'
                      attack_frequency: 1.3
                    applied_at: '2025-12-01T10:27:00Z'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '404':
          $ref: 'common.yaml#/components/responses/NotFound'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /training/data:
    post:
      tags:
        - Training
      summary: Отправить данные для обучения моделей
      description: |
        Отправляет данные о тактиках игроков и эффективности адаптаций AI
        для обучения моделей машинного обучения.
      operationId: submitTrainingData
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrainingDataRequest'
            example:
              encounter_id: 'aa0e8400-e29b-41d4-a716-446655440000'
              tactics_data:
                player_positions: [{ x: 10.5, y: 5.2, z: 2.1 }]
                ability_usage: ['fire_blast', 'shield_wall']
                damage_patterns: { burst: 0.6, sustained: 0.4 }
              adaptation_data:
                adaptations_applied: ['aoe_focus', 'support_targeting']
                effectiveness: 0.75
              outcome: success
              completion_time: 1200
      responses:
        '200':
          description: Данные успешно приняты
          content:
            application/json:
              schema:
                $ref: 'common.yaml#/components/schemas/SuccessResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /models/status:
    get:
      tags:
        - Training
      summary: Получить статус моделей AI
      description: |
        Возвращает статус моделей машинного обучения: версия, дата обучения,
        метрики эффективности и статус развертывания.
      operationId: getModelsStatus
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Статус моделей
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsStatus'
              example:
                models:
                  - name: tactics_analyzer
                    version: '2.1.0'
                    status: active
                    trained_at: '2025-11-28T00:00:00Z'
                    accuracy: 0.87
                    effectiveness: 0.82
                  - name: adaptation_engine
                    version: '1.5.0'
                    status: active
                    trained_at: '2025-11-25T00:00:00Z'
                    accuracy: 0.79
                    effectiveness: 0.75
                last_training: '2025-11-28T00:00:00Z'
                next_training: '2025-12-05T00:00:00Z'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      $ref: 'common.yaml#/components/securitySchemes/BearerAuth'

  schemas:
    PlayerAction:
      type: object
      properties:
        player_id:
          type: string
          format: uuid
        position:
          type: object
          properties:
            x:
              type: number
              format: float
            y:
              type: number
              format: float
            z:
              type: number
              format: float
        abilities_used:
          type: array
          items:
            type: string
        damage_dealt:
          type: integer
          minimum: 0
        damage_taken:
          type: integer
          minimum: 0
        movement_pattern:
          type: string
          enum: [aggressive, defensive, balanced, evasive]

    AnalyzeTacticsRequest:
      type: object
      required:
        - encounter_id
        - player_actions
      properties:
        encounter_id:
          type: string
          format: uuid
        player_actions:
          type: array
          items:
            $ref: '#/components/schemas/PlayerAction'
          minItems: 1

    WeakPoint:
      type: object
      properties:
        type:
          type: string
          enum: [positioning, support_focus, ability_usage, coordination, resource_management]
        description:
          type: string
        severity:
          type: string
          enum: [low, medium, high, critical]

    RecommendedAdaptation:
      type: object
      properties:
        type:
          type: string
          enum: [aoe_focus, support_targeting, ability_interrupt, positioning_change, resource_depletion]
        priority:
          type: string
          enum: [low, medium, high, critical]

    TacticsAnalysisResult:
      type: object
      properties:
        encounter_id:
          type: string
          format: uuid
        analysis_id:
          type: string
          format: uuid
        weak_points:
          type: array
          items:
            $ref: '#/components/schemas/WeakPoint'
        recommended_adaptations:
          type: array
          items:
            $ref: '#/components/schemas/RecommendedAdaptation'
        analyzed_at:
          type: string
          format: date-time

    Adaptation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        enemy_id:
          type: string
          format: uuid
        adaptation_type:
          type: string
          enum: [aoe_focus, support_targeting, ability_interrupt, positioning_change, resource_depletion]
        adaptation_data:
          type: object
          additionalProperties: true
          description: Данные адаптации (зависят от типа)
        applied_at:
          type: string
          format: date-time

    AdaptationsResponse:
      type: object
      properties:
        encounter_id:
          type: string
          format: uuid
        adaptations:
          type: array
          items:
            $ref: '#/components/schemas/Adaptation'

    TrainingDataRequest:
      type: object
      required:
        - encounter_id
        - tactics_data
        - adaptation_data
        - outcome
      properties:
        encounter_id:
          type: string
          format: uuid
        tactics_data:
          type: object
          properties:
            player_positions:
              type: array
              items:
                type: object
            ability_usage:
              type: array
              items:
                type: string
            damage_patterns:
              type: object
              additionalProperties:
                type: number
          additionalProperties: true
        adaptation_data:
          type: object
          properties:
            adaptations_applied:
              type: array
              items:
                type: string
            effectiveness:
              type: number
              format: float
              minimum: 0.0
              maximum: 1.0
          additionalProperties: true
        outcome:
          type: string
          enum: [success, failure, timeout]
        completion_time:
          type: integer
          minimum: 0

    ModelStatus:
      type: object
      properties:
        name:
          type: string
        version:
          type: string
        status:
          type: string
          enum: [active, training, deprecated, error]
        trained_at:
          type: string
          format: date-time
        accuracy:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        effectiveness:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0

    ModelsStatus:
      type: object
      properties:
        models:
          type: array
          items:
            $ref: '#/components/schemas/ModelStatus'
        last_training:
          type: string
          format: date-time
        next_training:
          type: string
          format: date-time


