openapi: 3.0.3
info:
  title: Anti-Cheat Reconciliation Service API
  description: API для reconciliation клиент-сервер состояний
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8086/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер

tags:
  - name: Reconciliation
    description: Reconciliation клиент-сервер

paths:
  /anti-cheat/reconciliation/compare:
    post:
      tags:
        - Reconciliation
      summary: Сравнение состояний клиент-сервер
      description: Сравнение клиентского и серверного состояния для обнаружения расхождений
      operationId: compareStates
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReconciliationCompareRequest'
      responses:
        '200':
          description: Результат сравнения состояний
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationCompareResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /anti-cheat/reconciliation/resolve:
    post:
      tags:
        - Reconciliation
      summary: Разрешение конфликтов состояний
      description: Разрешение конфликтов между клиентским и серверным состоянием
      operationId: resolveConflicts
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReconciliationResolveRequest'
      responses:
        '200':
          description: Результат разрешения конфликтов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationResolveResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      $ref: 'common.yaml#/components/securitySchemes/BearerAuth'

  schemas:
    ReconciliationCompareRequest:
      type: object
      required:
        - player_id
        - client_state
        - server_state
      properties:
        player_id:
          type: string
          format: uuid
          description: ID игрока
        client_state:
          $ref: 'anti-cheat-common.yaml#/components/schemas/GameState'
          description: Состояние на клиенте
        server_state:
          $ref: 'anti-cheat-common.yaml#/components/schemas/GameState'
          description: Состояние на сервере
        reconciliation_window:
          type: integer
          default: 500
          description: Окно reconciliation в миллисекундах
          minimum: 0
          maximum: 5000

    ReconciliationCompareResponse:
      type: object
      properties:
        states_match:
          type: boolean
          description: Состояния совпадают
        discrepancy_percentage:
          type: number
          format: float
          description: Процент расхождения
          minimum: 0
          maximum: 100
        discrepancies:
          type: array
          items:
            $ref: 'anti-cheat-common.yaml#/components/schemas/StateDiscrepancy'
          description: Список расхождений
        requires_resolution:
          type: boolean
          description: Требуется разрешение конфликтов

    ReconciliationResolveRequest:
      type: object
      required:
        - player_id
        - discrepancies
      properties:
        player_id:
          type: string
          format: uuid
          description: ID игрока
        discrepancies:
          type: array
          items:
            $ref: 'anti-cheat-common.yaml#/components/schemas/StateDiscrepancy'
          description: Список расхождений для разрешения
        resolution_strategy:
          type: string
          enum:
            - SERVER_WINS
            - CLIENT_WINS
            - MERGE
          default: SERVER_WINS
          description: Стратегия разрешения конфликтов

    ReconciliationResolveResponse:
      type: object
      properties:
        resolved:
          type: boolean
          description: Конфликты разрешены
        resolved_state:
          $ref: 'anti-cheat-common.yaml#/components/schemas/GameState'
          description: Разрешённое состояние
        corrections:
          type: array
          items:
            $ref: 'anti-cheat-common.yaml#/components/schemas/StateCorrection'
          description: Список применённых коррекций
        violation_logged:
          type: boolean
          description: Нарушение залогировано

security:
  - BearerAuth: []

