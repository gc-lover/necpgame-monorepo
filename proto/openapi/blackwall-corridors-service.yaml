openapi: 3.0.3
info:
  title: Blackwall Warm Corridors Service API
  description: |
    API для системы создания и поддержания тёплых коридоров через Blackwall.
    
    **Основные возможности:**
    - Создание временных проходов через барьер
    - Координация команды для поддержания стабильности
    - Обработка угроз (AI, NetWatch)
    - Использование коридора для передачи данных и прохода
    
    **Риски:**
    - Обнаружение NetWatch (15-30%)
    - Атака rogue AI (10-30%)
    - Преждевременное закрытие коридора
    - Оставление игроков за Blackwall при закрытии
    
    **Роли команды:**
    - Stabilizer - поддержание стабильности узлов
    - Guard - защита от угроз
    - Navigator - направление потока данных
    - Coordinator - координация команды
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necpgame.com

servers:
  - url: http://localhost:8083
    description: Gameplay Service
  - url: https://gameplay.necpgame.com
    description: Gameplay Service (продакшн)

tags:
  - name: Corridors
    description: Тёплые коридоры
  - name: Team
    description: Координация команды
  - name: Maintenance
    description: Поддержание коридора

paths:
  /api/v1/blackwall/corridor/create:
    post:
      tags:
        - Corridors
      summary: Создание коридора
      description: |
        Начинает процесс создания тёплого коридора через Blackwall.
        
        Требует команду из 2-3 игроков и карту с отмеченными слабыми зонами.
      operationId: createCorridor
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCorridorRequest"
      responses:
        "200":
          description: Коридор в процессе создания
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CorridorSession"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"

  /api/v1/blackwall/corridor/{corridor_id}/nodes/place:
    post:
      tags:
        - Corridors
      summary: Размещение узла
      description: |
        Размещает узел коридора в киберпространстве.
        
        Все узлы должны быть синхронизированы для активации коридора.
      operationId: placeNode
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PlaceNodeRequest"
      responses:
        "200":
          description: Узел размещён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NodePlacementResult"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"

  /api/v1/blackwall/corridor/{corridor_id}/activate:
    post:
      tags:
        - Corridors
      summary: Активация коридора
      description: |
        Активирует коридор после размещения всех узлов.
        
        Создаёт временный проход на 15-60 минут в зависимости от стабильности.
      operationId: activateCorridor
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - all_nodes_ready
              properties:
                all_nodes_ready:
                  type: boolean
      responses:
        "200":
          description: Коридор активирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CorridorActivated"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"

  /api/v1/blackwall/corridor/{corridor_id}/status:
    get:
      tags:
        - Corridors
      summary: Статус коридора
      description: |
        Возвращает текущий статус активного коридора.
        
        Включает стабильность, время жизни, статус команды и активные угрозы.
      operationId: getCorridorStatus
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Статус коридора
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CorridorStatus"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"

  /api/v1/blackwall/corridor/{corridor_id}/maintain:
    post:
      tags:
        - Maintenance
      summary: Поддержание коридора
      description: |
        Выполняет действия для поддержания стабильности коридора.
        
        Требует активных действий команды каждые 30-60 секунд.
      operationId: maintainCorridor
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintainCorridorRequest"
      responses:
        "200":
          description: Поддержание выполнено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceResult"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"

  /api/v1/blackwall/corridor/{corridor_id}/use:
    post:
      tags:
        - Corridors
      summary: Использование коридора
      description: |
        Использует коридор для передачи данных или прохода игроков.
        
        Использование влияет на стабильность коридора.
      operationId: useCorridor
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UseCorridorRequest"
      responses:
        "200":
          description: Использование выполнено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CorridorUsageResult"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"

  /api/v1/blackwall/corridor/{corridor_id}/close:
    post:
      tags:
        - Corridors
      summary: Закрытие коридора
      description: |
        Закрывает коридор (автоматически или вручную).
        
        Игроки, оставшиеся за Blackwall, могут быть в опасности.
      operationId: closeCorridor
      security:
        - BearerAuth: []
      parameters:
        - name: corridor_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Коридор закрыт
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CorridorClosed"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"

components:
  securitySchemes:
    BearerAuth:
      $ref: "common.yaml#/components/securitySchemes/BearerAuth"
  schemas:
    CreateCorridorRequest:
      type: object
      required:
        - team_leader_id
        - team_members
        - location_id
        - weak_zone_id
      properties:
        team_leader_id:
          type: string
          format: uuid
        team_members:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 3
          description: Члены команды (без лидера)
        location_id:
          type: string
          format: uuid
        map_id:
          type: string
          format: uuid
        weak_zone_id:
          type: string
          format: uuid
          description: ID слабой зоны из карты
        equipment_ids:
          type: array
          items:
            type: string
            format: uuid

    CorridorSession:
      type: object
      required:
        - corridor_id
        - status
        - preparation_required
      properties:
        corridor_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [preparing, active, unstable, closed]
        preparation_required:
          type: boolean
        estimated_prep_time:
          type: integer
          format: int64
          description: Ожидаемое время подготовки в секундах
        node_positions:
          type: array
          items:
            $ref: "#/components/schemas/NodePosition"
        risk_assessment:
          type: object

    NodePosition:
      type: object
      properties:
        node_number:
          type: integer
          minimum: 1
        coordinates:
          type: object
          description: Координаты в киберпространстве

    PlaceNodeRequest:
      type: object
      required:
        - node_number
        - position
        - character_id
      properties:
        node_number:
          type: integer
          minimum: 1
        position:
          type: object
          description: Позиция узла в киберпространстве
        character_id:
          type: string
          format: uuid
        skill_check:
          type: object

    NodePlacementResult:
      type: object
      required:
        - node_placed
        - stability_contribution
      properties:
        node_placed:
          type: boolean
        stability_contribution:
          type: integer
          minimum: 0
          maximum: 100
          description: Вклад узла в общую стабильность
        synchronization_status:
          type: object
          description: Статус синхронизации всех узлов

    CorridorActivated:
      type: object
      required:
        - corridor_active
        - initial_stability
        - lifetime
      properties:
        corridor_active:
          type: boolean
        initial_stability:
          type: integer
          minimum: 0
          maximum: 100
        lifetime:
          type: integer
          format: int64
          description: Время жизни в секундах
        warnings:
          type: array
          items:
            type: string

    CorridorStatus:
      type: object
      required:
        - stability
        - time_remaining
      properties:
        stability:
          type: integer
          minimum: 0
          maximum: 100
          description: Текущая стабильность (0-100%)
        time_remaining:
          type: integer
          format: int64
          description: Оставшееся время в секундах
        team_status:
          type: array
          items:
            $ref: "#/components/schemas/TeamMemberStatus"
        active_threats:
          type: array
          items:
            $ref: "#/components/schemas/Threat"
        warnings:
          type: array
          items:
            type: string

    TeamMemberStatus:
      type: object
      required:
        - character_id
        - role
        - status
      properties:
        character_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [stabilizer, guard, navigator, coordinator]
        status:
          type: string
          enum: [active, afk, disconnected]

    Threat:
      type: object
      required:
        - threat_type
        - severity
      properties:
        threat_type:
          type: string
          enum: [rogue_ai_attack, netwatch_detection, digital_anomaly]
        severity:
          type: integer
          minimum: 0
          maximum: 100

    MaintainCorridorRequest:
      type: object
      required:
        - character_id
        - role
      properties:
        character_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [stabilizer, guard, navigator, coordinator]
        action_data:
          type: object
          description: Данные действий для поддержания

    MaintenanceResult:
      type: object
      required:
        - maintenance_success
        - stability_change
      properties:
        maintenance_success:
          type: boolean
        stability_change:
          type: integer
          description: Изменение стабильности
        team_sync:
          type: object
          description: Синхронизация команды

    UseCorridorRequest:
      type: object
      required:
        - usage_type
      properties:
        usage_type:
          type: string
          enum: [data_transfer, player_passage]
        data_volume:
          type: integer
          description: Объём данных в МБ (для data_transfer)
        character_ids:
          type: array
          items:
            type: string
            format: uuid
          description: ID игроков для прохода (для player_passage)

    CorridorUsageResult:
      type: object
      required:
        - success
        - stability_impact
      properties:
        success:
          type: boolean
        stability_impact:
          type: integer
          description: Влияние на стабильность (отрицательное = снижение)
        warnings:
          type: array
          items:
            type: string
        rewards:
          type: object
          description: Награды за использование

    CorridorClosed:
      type: object
      properties:
        closure_reason:
          type: string
          enum: [manual, stability_zero, netwatch, ai_attack, timeout]
        players_trapped:
          type: array
          items:
            type: string
            format: uuid
          description: Игроки, оставшиеся за Blackwall
        equipment_lost:
          type: array
          items:
            type: string
            format: uuid
        consequences:
          type: object
          description: Последствия закрытия

