# Issue: #2197
openapi: 3.0.3
info:
  title: Specialized Domain - Real-time Combat API
  description: |
    **Enterprise-Grade Real-time Combat API** for NECPGAME MMOFPS RPG.

    **Module Purpose:** Real-time combat state management, WebSocket-based live combat updates, position synchronization, damage events, and combat session orchestration.

    **Architecture:** Event-driven microservice with WebSocket connections, Kafka event streaming, and Redis for state caching.

    **Core Features:**
    - WebSocket real-time combat sessions (10k+ concurrent connections)
    - Live position updates and movement synchronization
    - Real-time damage calculation and application
    - Combat state events (start/end, join/leave, victory/defeat)
    - Anti-cheat position validation and lag compensation
    - Combat statistics and performance monitoring
    - Cross-session communication and team coordination

    **Performance Targets:**
    - WebSocket connections: 10k+ concurrent, <50MB memory per 1000 connections
    - Position updates: 1000+ updates/sec, P99 <10ms latency
    - Damage events: 2000+ events/sec, <5ms processing time
    - Combat sessions: 500+ active sessions, <20ms state sync
    - Event throughput: 5000+ events/sec via Kafka
    - Cache hit rate: >98% (Redis for active combat states)

    **BACKEND NOTE:** WebSocket worker pools required. Memory per connection: ~5KB.
    Position validation algorithms for anti-cheat. Event sourcing for combat replay.
  version: 1.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  contact:
    name: NECPGAME Combat API Support
    url: https://necpgame.com/support
    email: api@combat.necpgame.com

servers:
  - url: http://localhost:8085/api/v1/specialized-domain/combat/realtime
    description: Real-time Combat Service Development Server
  - url: https://combat.necpgame.com/api/v1
    description: Real-time Combat Service Production Server

security:
  - BearerAuth: [ ]

tags:
  - name: Combat Sessions
    description: Combat session management and lifecycle
  - name: Tournament
    description: Tournament match management and brackets
  - name: Leaderboard
    description: Real-time leaderboard and ranking systems
  - name: Spectator
    description: Spectator mode and viewing capabilities
  - name: Analytics
    description: Combat analytics and performance metrics
  - name: WebSocket
    description: Real-time WebSocket communication endpoints
  - name: Real-time Updates
    description: WebSocket-based real-time combat updates
  - name: Position Sync
    description: Player position synchronization and validation
  - name: Combat Events
    description: Combat event streaming and notifications
  - name: Statistics
    description: Combat performance statistics and analytics
  - name: System
    description: Health checks and system operations

paths:
  # Session management
  /health:
    get:
      summary: Real-time combat service health check
      operationId: realtimeCombatHealth
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '../common/schemas/health.yaml#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Combat session endpoints
  /sessions:
    post:
      summary: Create new combat session
      description: |
        Creates a new real-time combat session with WebSocket support.

        **BACKEND NOTE:** Initializes Redis cache, Kafka topics, WebSocket room.
        Session supports 2-50 players with configurable rules.
      operationId: createCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
                $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '201':
          description: Combat session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          description: Invalid session parameters
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Session creation rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  /sessions/{session_id}:
    get:
      summary: Get combat session details
      description: Retrieves current state and metadata of a combat session.
      operationId: getCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      responses:
        '200':
          description: Session details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

    put:
      summary: Update combat session
      description: |
        Updates combat session parameters (game mode, settings, etc.).

        **BACKEND NOTE:** Validates session state before update.
        Notifies all connected players via WebSocket.
      operationId: updateCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
                $ref: '#/components/schemas/UpdateSessionRequest'
      responses:
        '200':
          description: Session updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          description: Invalid update parameters
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to update session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

    delete:
      summary: End combat session
      description: |
        Terminates a combat session and cleans up resources.

        **BACKEND NOTE:** Closes all WebSocket connections, archives session data.
        Publishes final statistics to Kafka.
      operationId: endCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      responses:
        '204':
          description: Session ended successfully (No Content)
        '403':
          description: Not authorized to end session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  /sessions/{session_id}/join:
    post:
      summary: Join combat session
      description: |
        Allows a player to join an active combat session.

        **BACKEND NOTE:** Validates player eligibility, assigns to team.
        Establishes WebSocket connection for real-time updates.
      operationId: joinCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
                $ref: '#/components/schemas/JoinSessionRequest'
      responses:
        '200':
          description: Successfully joined session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinSessionResponse'
        '400':
          description: Invalid join request or session full
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to join session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  /sessions/{session_id}/leave:
    post:
      summary: Leave combat session
      description: Allows a player to leave an active combat session.
      operationId: leaveCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      responses:
        '200':
          description: Successfully left session
          content:
            application/json:
              schema:
                $ref: '../common/responses/success.yaml#/components/schemas/SuccessResponse'
        '403':
          description: Not authorized to leave session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  /sessions/{session_id}/spectate:
    post:
      summary: Spectate combat session
      description: |
        Allows a player to spectate an active combat session.

        **BACKEND NOTE:** Grants read-only access to session events.
        Supports multiple camera modes (free, follow_player, overview, cinematic).
        Establishes WebSocket connection for spectator updates.
      operationId: spectateCombatSession
      tags:
        - Combat Sessions
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/session-schemas.yaml#/components/schemas/SpectateRequest'
      responses:
        '200':
          description: Successfully joined as spectator
          content:
            application/json:
              schema:
                $ref: './schemas/session-schemas.yaml#/components/schemas/SpectateResponse'
        '400':
          description: Invalid spectate request
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to spectate session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Too many spectators for session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # WebSocket endpoint for real-time updates
  /ws/sessions/{session_id}:
    get:
      summary: WebSocket connection for real-time combat updates
      description: |
        Establishes WebSocket connection for real-time combat updates.

        **BACKEND NOTE:** Long-lived connection (10k+ concurrent).
        Message format: JSON with event types. Heartbeat every 15 seconds.
        Supports position updates, damage events, state changes.
      operationId: combatWebSocket
      tags:
        - Real-time Updates
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: JWT authentication token
        - name: client_version
          in: query
          schema:
            type: string
            default: "1.0.0"
          description: Client application version
      responses:
        '101':
          description: WebSocket connection established
          headers:
            Sec-WebSocket-Accept:
              schema:
                type: string
              description: WebSocket handshake confirmation
        '400':
          description: Invalid connection parameters
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to join session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Connection rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Spectator WebSocket endpoint
  /ws/sessions/{session_id}/spectate:
    get:
      summary: WebSocket connection for spectator updates
      description: |
        Establishes WebSocket connection for spectator real-time updates.

        **BACKEND NOTE:** Read-only connection for spectators.
        Supports camera mode changes, session event streaming.
        Lower priority than player connections.
      operationId: spectatorWebSocket
      tags:
        - Real-time Updates
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: JWT authentication token
        - name: camera_mode
          in: query
          schema:
            type: string
            enum: [ free, follow_player, overview, cinematic ]
            default: free
          description: Initial spectator camera mode
        - name: follow_target
          in: query
          schema:
            type: string
            format: uuid
          description: Player ID to follow (if camera_mode is follow_player)
      responses:
        '101':
          description: Spectator WebSocket connection established
          headers:
            Sec-WebSocket-Accept:
              schema:
                type: string
              description: WebSocket handshake confirmation
        '400':
          description: Invalid spectator connection parameters
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to spectate session
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Position synchronization
  /sessions/{session_id}/positions:
    post:
      summary: Update player position
      description: |
        Updates player position for anti-cheat validation and synchronization.

        **BACKEND NOTE:** High-frequency endpoint (1000+ RPS).
        Validates position against server physics, lag compensation.
        Broadcasts to other players in session.
      operationId: updatePlayerPosition
      tags:
        - Position Sync
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/position-schemas.yaml#/components/schemas/PositionUpdateRequest'
      responses:
        '200':
          description: Position updated successfully
          content:
            application/json:
              schema:
                $ref: './schemas/position-schemas.yaml#/components/schemas/PositionUpdateResponse'
        '400':
          description: Invalid position data
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to update position
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Position update rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Combat statistics
  /sessions/{session_id}/stats:
    get:
      summary: Get combat session statistics
      description: Retrieves real-time statistics for a combat session.
      operationId: getSessionStats
      tags:
        - Statistics
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: './schemas/stats-schemas.yaml#/components/schemas/CombatStatsResponse'
        '403':
          description: Not authorized to view statistics
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Damage events - CRITICAL for real-time combat
  /sessions/{session_id}/damage:
    post:
      summary: Apply damage to target
      description: |
        Applies damage from attacker to target with validation and effects.

        **BACKEND NOTE:** High-frequency endpoint (500+ RPS expected).
        Validates damage calculation, applies status effects, updates health.
        Publishes damage event to Kafka for analytics and replay.
        Critical for combat balance and anti-cheat systems.
      operationId: applyDamage
      tags:
        - Combat Events
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/damage-schemas.yaml#/components/schemas/DamageRequest'
      responses:
        '200':
          description: Damage applied successfully
          content:
            application/json:
              schema:
                $ref: './schemas/damage-schemas.yaml#/components/schemas/DamageResponse'
        '400':
          description: Invalid damage request or validation failed
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to apply damage
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session or target not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Damage application rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Combat actions (abilities, attacks)
  /sessions/{session_id}/actions:
    post:
      summary: Execute combat action
      description: |
        Executes a combat action (attack, ability, special move) with validation.

        **BACKEND NOTE:** High-frequency endpoint (300+ RPS expected).
        Validates action cooldowns, resource costs, targeting.
        Applies action effects, updates combat state.
        Supports combo systems and ability synergies.
      operationId: executeCombatAction
      tags:
        - Combat Events
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/action-schemas.yaml#/components/schemas/CombatActionRequest'
      responses:
        '200':
          description: Action executed successfully
          content:
            application/json:
              schema:
                $ref: './schemas/action-schemas.yaml#/components/schemas/CombatActionResponse'
        '400':
          description: Invalid action request or validation failed
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to execute action
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Action execution rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Spectator mode


  # Combat replay
  /sessions/{session_id}/replay:
    get:
      summary: Get combat session replay data
      description: |
        Retrieves replay data for combat session analysis and review.

        **BACKEND NOTE:** Event-sourced replay system.
        Supports time-based filtering and speed control.
        Critical for tournament analysis and anti-cheat review.
      operationId: getCombatReplay
      tags:
        - Combat Events
      security:
        - BearerAuth: [ ]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session unique identifier
        - name: start_time
          in: query
          schema:
            type: integer
            description: Start timestamp for replay (Unix milliseconds)
        - name: end_time
          in: query
          schema:
            type: integer
            description: End timestamp for replay (Unix milliseconds)
        - name: speed
          in: query
          schema:
            type: number
            format: float
            minimum: 0.1
            maximum: 10.0
            default: 1.0
            description: Replay speed multiplier
      responses:
        '200':
          description: Replay data retrieved successfully
          content:
            application/json:
              schema:
                $ref: './schemas/replay-schemas.yaml#/components/schemas/CombatReplayResponse'
        '400':
          description: Invalid replay parameters
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '403':
          description: Not authorized to view replay
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Combat session or replay data not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Tournament Management
  /tournaments/{tournament_id}/sessions:
    get:
      summary: Get tournament combat sessions
      description: |
        Retrieves all combat sessions for a specific tournament.

        **BACKEND NOTE:** Used for tournament brackets, scheduling, and spectator navigation.
      operationId: getTournamentSessions
      tags:
        - Tournament
      security:
        - BearerAuth: []
      parameters:
        - name: tournament_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tournament identifier
        - name: status
          in: query
          schema:
            type: string
            enum: [scheduled, in_progress, completed, cancelled]
          description: Filter by session status
        - name: bracket_round
          in: query
          schema:
            type: string
          description: Filter by bracket round (e.g., "quarterfinal", "semifinal")
      responses:
        '200':
          description: Tournament sessions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  tournament_id:
                    type: string
                    format: uuid
                  sessions:
                    type: array
                    items:
                      $ref: './schemas/session-schemas.yaml#/components/schemas/TournamentSession'
                  total_sessions:
                    type: integer
                    minimum: 0
        '404':
          description: Tournament not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  /tournaments/{tournament_id}/leaderboard:
    get:
      summary: Get tournament leaderboard
      description: |
        Retrieves current tournament leaderboard with real-time updates.

        **BACKEND NOTE:** Aggregates scores across all tournament matches. Updates in real-time during active sessions.
      operationId: getTournamentLeaderboard
      tags:
        - Tournament
        - Leaderboard
      security:
        - BearerAuth: []
      parameters:
        - name: tournament_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tournament identifier
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of entries to return
        - name: include_stats
          in: query
          schema:
            type: boolean
            default: true
          description: Include detailed statistics
      responses:
        '200':
          description: Tournament leaderboard retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  tournament_id:
                    type: string
                    format: uuid
                  leaderboard:
                    type: array
                    items:
                      $ref: './schemas/session-schemas.yaml#/components/schemas/LeaderboardEntry'
                  last_updated:
                    type: string
                    format: date-time
                  total_participants:
                    type: integer
                    minimum: 0
        '404':
          description: Tournament not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Real-time Leaderboard
  /sessions/{session_id}/leaderboard:
    get:
      summary: Get session leaderboard
      description: |
        Retrieves real-time leaderboard for a combat session.

        **BACKEND NOTE:** Returns current rankings, scores, and statistics. Optimized for frequent polling.
      operationId: getSessionLeaderboard
      tags:
        - Leaderboard
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session identifier
        - name: include_spectators
          in: query
          schema:
            type: boolean
            default: false
          description: Include spectator statistics
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [score, kills, accuracy, rank]
            default: score
          description: Sort leaderboard by this metric
      responses:
        '200':
          description: Session leaderboard retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
                    format: uuid
                  leaderboard:
                    type: array
                    items:
                      $ref: './schemas/session-schemas.yaml#/components/schemas/LeaderboardEntry'
                  session_stats:
                    type: object
                    properties:
                      total_players:
                        type: integer
                        minimum: 0
                      average_score:
                        type: number
                        format: float
                      highest_score:
                        type: integer
                        minimum: 0
                      total_kills:
                        type: integer
                        minimum: 0
                  last_updated:
                    type: string
                    format: date-time
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'


  # Tournament Spectator Mode
  /tournaments/{tournament_id}/spectate:
    post:
      summary: Join tournament as spectator
      description: |
        Join a tournament match as a spectator with advanced viewing options.

        **BACKEND NOTE:** Creates spectator session with tournament-specific features.
        Supports multiple camera angles and match selection.
      operationId: joinTournamentSpectator
      tags:
        - Tournament
        - Spectator
      security:
        - BearerAuth: []
      parameters:
        - name: tournament_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tournament identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                preferred_match:
                  type: string
                  format: uuid
                  description: Specific match to spectate (optional)
                camera_mode:
                  type: string
                  enum: [free, follow_player, overview, cinematic, tournament_overview]
                  default: tournament_overview
                  description: Initial camera mode
                follow_player:
                  type: string
                  format: uuid
                  description: Player to follow (if camera_mode is follow_player)
                quality_preference:
                  type: string
                  enum: [low, medium, high, ultra]
                  default: high
                  description: Stream quality preference
      responses:
        '200':
          description: Spectator session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  spectator_session:
                    $ref: './schemas/session-schemas.yaml#/components/schemas/SpectateResponse'
                  tournament_info:
                    type: object
                    properties:
                      current_round:
                        type: string
                        example: "quarterfinals"
                      active_matches:
                        type: integer
                        minimum: 0
                      total_matches:
                        type: integer
                        minimum: 0
                      next_match_start:
                        type: string
                        format: date-time
                  available_matches:
                    type: array
                    items:
                      type: object
                      properties:
                        match_id:
                          type: string
                          format: uuid
                        bracket_position:
                          type: string
                        participants:
                          type: array
                          items:
                            type: string
                            maxLength: 50
                        status:
                          type: string
                          enum: [waiting, in_progress, completed]
                        spectator_count:
                          type: integer
                          minimum: 0
        '400':
          description: Invalid spectator request
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '404':
          description: Tournament not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'
        '429':
          description: Tournament spectator limit reached
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

  # Advanced Combat Analytics
  /analytics/combat/{session_id}:
    get:
      summary: Get combat analytics for session
      description: |
        Retrieves detailed combat analytics and statistics for a session.

        **BACKEND NOTE:** Aggregates real-time data for performance analysis, balance testing, and player insights.
        Includes heatmaps, player paths, and statistical breakdowns.
      operationId: getCombatAnalytics
      tags:
        - Analytics
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Combat session identifier
        - name: include_heatmaps
          in: query
          schema:
            type: boolean
            default: false
          description: Include position heatmaps (resource intensive)
        - name: include_player_paths
          in: query
          schema:
            type: boolean
            default: false
          description: Include player movement paths
        - name: time_range
          in: query
          schema:
            type: string
            enum: [full_session, last_5_minutes, last_1_minute]
            default: full_session
          description: Time range for analytics
      responses:
        '200':
          description: Combat analytics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
                    format: uuid
                  duration_seconds:
                    type: integer
                    minimum: 0
                  player_count:
                    type: integer
                    minimum: 0
                  statistics:
                    type: object
                    properties:
                      total_shots:
                        type: integer
                        minimum: 0
                      total_hits:
                        type: integer
                        minimum: 0
                      accuracy_percentage:
                        type: number
                        format: float
                        minimum: 0.0
                        maximum: 100.0
                      average_response_time:
                        type: number
                        format: float
                        description: Average player response time in milliseconds
                      peak_concurrent_players:
                        type: integer
                        minimum: 0
                  heatmaps:
                    type: object
                    description: Position heatmaps (if requested)
                    additionalProperties:
                      type: array
                      items:
                        type: array
                        items:
                          type: number
                          format: float
                  player_paths:
                    type: array
                    items:
                      type: object
                      properties:
                        player_id:
                          type: string
                          format: uuid
                        path:
                          type: array
                          items:
                            $ref: './schemas/position-schemas.yaml#/components/schemas/Vector3'
                        timestamps:
                          type: array
                          items:
                            type: string
                            format: date-time
                    description: Player movement paths (if requested)
                  combat_events:
                    type: array
                    items:
                      $ref: './schemas/action-schemas.yaml#/components/schemas/CombatActionRequest'
                    description: Timeline of combat events
        '404':
          description: Combat session not found
          content:
            application/json:
              schema:
                $ref: '../common/responses/error.yaml#/components/schemas/Error'

components:
  schemas:
    # Combat Session Schemas
    CombatSession:
      type: object
      required:
        - session_id
        - status
        - players
        - max_players
      properties:
        session_id:
          type: string
          format: uuid
          description: Unique combat session identifier
        status:
          type: string
          enum: [waiting, active, paused, finished, cancelled]
          description: Current session status
        game_mode:
          type: string
          enum: [deathmatch, team_deathmatch, capture_flag, king_of_hill]
          description: Combat game mode
        players:
          type: array
          items:
            $ref: '#/components/schemas/Player'
          minItems: 2
          maxItems: 50
        max_players:
          type: integer
          minimum: 2
          maximum: 50
          default: 10
        current_round:
          type: integer
          minimum: 1
          default: 1
        time_limit:
          type: integer
          description: Time limit in seconds
          minimum: 60
          maximum: 3600
        score_limit:
          type: integer
          description: Score limit for victory
          minimum: 10
          maximum: 1000
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        websocket_url:
          type: string
          description: WebSocket URL for real-time updates
        kafka_topic:
          type: string
          description: Kafka topic for session events

    CreateSessionRequest:
      type: object
      required:
        - game_mode
        - max_players
      properties:
        game_mode:
          type: string
          enum: [deathmatch, team_deathmatch, capture_flag, king_of_hill]
        max_players:
          type: integer
          minimum: 2
          maximum: 50
          default: 10
        time_limit:
          type: integer
          minimum: 60
          maximum: 3600
        score_limit:
          type: integer
          minimum: 10
          maximum: 1000
        private_session:
          type: boolean
          default: false
        password:
          type: string
          minLength: 4
          maxLength: 32
        custom_rules:
          type: object
          description: Custom game rules and settings

    UpdateSessionRequest:
      type: object
      properties:
        status:
          type: string
          enum: [active, paused, finished, cancelled]
        time_limit:
          type: integer
          minimum: 60
          maximum: 3600
        score_limit:
          type: integer
          minimum: 10
          maximum: 1000

    Player:
      type: object
      required:
        - player_id
        - username
        - team
      properties:
        player_id:
          type: string
          format: uuid
        username:
          type: string
          minLength: 3
          maxLength: 32
        team:
          type: string
          enum: [red, blue, spectator]
        health:
          type: integer
          minimum: 0
          maximum: 100
          default: 100
        armor:
          type: integer
          minimum: 0
          maximum: 100
          default: 0
        position:
          $ref: '#/components/schemas/Position'
        score:
          type: integer
          default: 0
        kills:
          type: integer
          default: 0
        deaths:
          type: integer
          default: 0
        joined_at:
          type: string
          format: date-time

    Position:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: float
        y:
          type: number
          format: float
        z:
          type: number
          format: float
        rotation:
          type: number
          format: float
          description: Yaw rotation in degrees

    JoinSessionRequest:
      type: object
      required:
        - session_id
      properties:
        session_id:
          type: string
          format: uuid
        team:
          type: string
          enum: [red, blue, auto]
          default: auto
        password:
          type: string
          description: Required if session is private

    JoinSessionResponse:
      type: object
      required:
        - session
        - player
        - websocket_url
      properties:
        session:
          $ref: '#/components/schemas/CombatSession'
        player:
          $ref: '#/components/schemas/Player'
        websocket_url:
          type: string
        auth_token:
          type: string
          description: Short-lived token for WebSocket authentication

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: JWT Bearer token authentication
