# Issue: #169
openapi: 3.0.3
info:
  title: Combat Systems Wave 1 Service API
  version: 1.0.0
  description: |
    Unified Combat Systems Wave 1 API for MMOFPS RPG.

    ## Wave 1 Components
    - Combat Sessions: Core session management and lifecycle
    - AI Systems: Enemy profiles, behavior, and coordination
    - Abilities: Player skills and activation system
    - Shooting: Advanced ballistic and weapon systems
    - Combos: Synergy systems and combo mechanics
    - Freerun: Parkour and movement mechanics
    - Hacking: Cybernetic enhancement and countermeasures
    - Stealth: Infiltration and detection systems
    - Extraction: Mission completion and reward systems
    - Arena: PvP combat arenas
    - Cyberspace: Digital realm interactions

    ## Architecture Overview
    - Server-authoritative combat system with client prediction
    - Event-driven architecture with Kafka integration
    - Realtime state synchronization via WebSocket
    - Integrated anti-cheat validation and telemetry

    ## Performance Requirements
    - Session management: 500+ RPS with P99 <50ms
    - Action processing: 1000+ RPS with P99 <25ms
    - Memory optimized with struct alignment
    - Context timeouts on all operations
    - Zero allocations on hot paths

servers:
  - url: http://localhost:8100
    description: Local development
  - url: https://api.necpgame.com/v1
    description: Production API

tags:
  - name: sessions
    description: Combat session lifecycle management
  - name: ai
    description: AI enemy behavior and coordination
  - name: abilities
    description: Player ability activation and management
  - name: shooting
    description: Weapon systems and ballistic calculations
  - name: combos
    description: Combo synergies and execution
  - name: freerun
    description: Parkour movement mechanics
  - name: hacking
    description: Cybernetic hacking systems
  - name: stealth
    description: Stealth and detection mechanics
  - name: extraction
    description: Mission completion systems
  - name: arena
    description: PvP arena management
  - name: cyberspace
    description: Digital realm interactions

security:
  - BearerAuth: []

paths:
  # Combat Sessions
  /gameplay/combat/sessions:
    post:
      tags: [sessions]
      summary: Create combat session
      operationId: createCombatSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSessionRequest"
      responses:
        "201":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CombatSession"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "409":
          description: Session conflict
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

    get:
      tags: [sessions]
      summary: List active combat sessions
      operationId: listCombatSessions
      parameters:
        - name: player_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [active, paused, completed]
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Sessions list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CombatSession"

  /gameplay/combat/sessions/{session_id}:
    get:
      tags: [sessions]
      summary: Get session details
      operationId: getCombatSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Session details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CombatSession"
        "404":
          $ref: common.yaml#/components/responses/NotFound

    put:
      tags: [sessions]
      summary: Update session state
      operationId: updateCombatSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSessionRequest"
      responses:
        "200":
          description: Session updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CombatSession"

    delete:
      tags: [sessions]
      summary: End combat session
      operationId: endCombatSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Session ended
        "404":
          $ref: common.yaml#/components/responses/NotFound

  # AI Systems
  /gameplay/combat/ai/profiles:
    get:
      tags: [ai]
      summary: Get AI enemy profiles
      operationId: getAIProfiles
      parameters:
        - name: zone_id
          in: query
          schema:
            type: string
            format: uuid
        - name: difficulty
          in: query
          schema:
            type: string
            enum: [easy, normal, hard, nightmare]
      responses:
        "200":
          description: AI profiles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AIProfile"

  /gameplay/combat/ai/behavior/{profile_id}:
    post:
      tags: [ai]
      summary: Update AI behavior state
      operationId: updateAIBehavior
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AIBehaviorUpdate"
      responses:
        "200":
          description: Behavior updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AIState"

  # Abilities
  /gameplay/combat/abilities/{character_id}/activate:
    post:
      tags: [abilities]
      summary: Activate player ability
      operationId: activateAbility
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AbilityActivationRequest"
      responses:
        "200":
          description: Ability activated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AbilityState"
        "400":
          description: Invalid activation (cooldown, resources, etc.)
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  # Shooting
  /gameplay/combat/shooting/calculate:
    post:
      tags: [shooting]
      summary: Calculate ballistic trajectory
      operationId: calculateBallistics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BallisticRequest"
      responses:
        "200":
          description: Trajectory calculated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BallisticResult"

  /gameplay/combat/shooting/hit:
    post:
      tags: [shooting]
      summary: Process hit validation
      operationId: processHit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HitRequest"
      responses:
        "200":
          description: Hit processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HitResult"

  # Combos
  /gameplay/combat/combos/{character_id}/execute:
    post:
      tags: [combos]
      summary: Execute combo sequence
      operationId: executeCombo
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ComboExecutionRequest"
      responses:
        "200":
          description: Combo executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ComboResult"

  # Freerun
  /gameplay/combat/freerun/{character_id}/move:
    post:
      tags: [freerun]
      summary: Process freerun movement
      operationId: processFreerunMove
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FreerunMoveRequest"
      responses:
        "200":
          description: Movement processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FreerunState"

  # Hacking
  /gameplay/combat/hacking/{target_id}/attempt:
    post:
      tags: [hacking]
      summary: Attempt cybernetic hack
      operationId: attemptHack
      parameters:
        - name: target_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HackAttemptRequest"
      responses:
        "200":
          description: Hack result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HackResult"

  # Stealth
  /gameplay/combat/stealth/{character_id}/visibility:
    get:
      tags: [stealth]
      summary: Get stealth visibility status
      operationId: getStealthVisibility
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Visibility status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StealthVisibility"

    post:
      tags: [stealth]
      summary: Update stealth state
      operationId: updateStealthState
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StealthUpdateRequest"
      responses:
        "200":
          description: Stealth updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StealthState"

  # Extraction
  /gameplay/combat/extraction/{session_id}/attempt:
    post:
      tags: [extraction]
      summary: Attempt mission extraction
      operationId: attemptExtraction
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExtractionRequest"
      responses:
        "200":
          description: Extraction result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExtractionResult"

  # Arena
  /gameplay/combat/arena/matches:
    post:
      tags: [arena]
      summary: Create arena match
      operationId: createArenaMatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateArenaMatchRequest"
      responses:
        "201":
          description: Match created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArenaMatch"

    get:
      tags: [arena]
      summary: List arena matches
      operationId: listArenaMatches
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [waiting, active, completed]
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Matches list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ArenaMatch"

  # Cyberspace
  /gameplay/combat/cyberspace/{character_id}/enter:
    post:
      tags: [cyberspace]
      summary: Enter cyberspace
      operationId: enterCyberspace
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CyberspaceEntryRequest"
      responses:
        "200":
          description: Cyberspace entered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CyberspaceState"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Combat Sessions
    CreateSessionRequest:
      type: object
      required: [player_ids, zone_id, difficulty]
      properties:
        player_ids:
          type: array
          items:
            type: string
            format: uuid
        zone_id:
          type: string
          format: uuid
        difficulty:
          type: string
          enum: [easy, normal, hard, nightmare]
        mission_type:
          type: string
          enum: [raid, patrol, extraction, arena]

    CombatSession:
      type: object
      required: [id, player_ids, status, created_at]
      properties:
        id:
          type: string
          format: uuid
        player_ids:
          type: array
          items:
            type: string
            format: uuid
        zone_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [active, paused, completed, failed]
        difficulty:
          type: string
          enum: [easy, normal, hard, nightmare]
        mission_type:
          type: string
          enum: [raid, patrol, extraction, arena]
        score:
          type: integer
          minimum: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateSessionRequest:
      type: object
      properties:
        status:
          type: string
          enum: [paused, resumed]
        score:
          type: integer
          minimum: 0

    # AI Systems
    AIProfile:
      type: object
      required: [id, type, difficulty, health, damage]
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [turret, drone, assault, sniper, berserker, chameleon]
        difficulty:
          type: string
          enum: [easy, normal, hard, nightmare]
        health:
          type: integer
          minimum: 1
        damage:
          type: integer
          minimum: 0
        speed:
          type: number
          minimum: 0
        detection_range:
          type: number
          minimum: 0

    AIBehaviorUpdate:
      type: object
      required: [state, target_id]
      properties:
        state:
          type: string
          enum: [patrol, combat, alerted, fleeing]
        target_id:
          type: string
          format: uuid
        position:
          $ref: "#/components/schemas/Vector3"

    AIState:
      type: object
      required: [profile_id, current_state, last_update]
      properties:
        profile_id:
          type: string
          format: uuid
        current_state:
          type: string
          enum: [idle, patrol, combat, alerted, fleeing, dead]
        health:
          type: integer
          minimum: 0
        position:
          $ref: "#/components/schemas/Vector3"
        target_id:
          type: string
          format: uuid
        last_update:
          type: string
          format: date-time

    # Abilities
    AbilityActivationRequest:
      type: object
      required: [ability_id]
      properties:
        ability_id:
          type: string
          format: uuid
        target_position:
          $ref: "#/components/schemas/Vector3"
        target_id:
          type: string
          format: uuid

    AbilityState:
      type: object
      required: [ability_id, status, cooldown_remaining]
      properties:
        ability_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [ready, active, cooldown, disabled]
        cooldown_remaining:
          type: number
          minimum: 0
        duration_remaining:
          type: number
          minimum: 0

    # Shooting
    BallisticRequest:
      type: object
      required: [weapon_id, start_position, direction]
      properties:
        weapon_id:
          type: string
          format: uuid
        start_position:
          $ref: "#/components/schemas/Vector3"
        direction:
          $ref: "#/components/schemas/Vector3"
        muzzle_velocity:
          type: number
          minimum: 0

    BallisticResult:
      type: object
      required: [trajectory_points, impact_point, damage]
      properties:
        trajectory_points:
          type: array
          items:
            $ref: "#/components/schemas/Vector3"
        impact_point:
          $ref: "#/components/schemas/Vector3"
        damage:
          type: integer
          minimum: 0
        ricochet:
          type: boolean
        penetration:
          type: boolean

    HitRequest:
      type: object
      required: [session_id, shooter_id, target_id, weapon_id, hit_position]
      properties:
        session_id:
          type: string
          format: uuid
        shooter_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        weapon_id:
          type: string
          format: uuid
        hit_position:
          $ref: "#/components/schemas/Vector3"
        damage:
          type: integer
          minimum: 0
        hit_type:
          type: string
          enum: [headshot, bodyshot, limb]

    HitResult:
      type: object
      required: [valid, damage_dealt, target_health_remaining]
      properties:
        valid:
          type: boolean
        damage_dealt:
          type: integer
          minimum: 0
        target_health_remaining:
          type: integer
          minimum: 0
        critical_hit:
          type: boolean
        armor_penetration:
          type: boolean

    # Combos
    ComboExecutionRequest:
      type: object
      required: [combo_id, sequence]
      properties:
        combo_id:
          type: string
          format: uuid
        sequence:
          type: array
          items:
            type: string
            enum: [light_attack, heavy_attack, dodge, ability]
        target_id:
          type: string
          format: uuid

    ComboResult:
      type: object
      required: [combo_id, success, damage_multiplier]
      properties:
        combo_id:
          type: string
          format: uuid
        success:
          type: boolean
        damage_multiplier:
          type: number
          minimum: 1
        synergy_activated:
          type: boolean
        bonus_effects:
          type: array
          items:
            type: string

    # Freerun
    FreerunMoveRequest:
      type: object
      required: [move_type, start_position, end_position]
      properties:
        move_type:
          type: string
          enum: [vault, wall_run, air_dash, slide]
        start_position:
          $ref: "#/components/schemas/Vector3"
        end_position:
          $ref: "#/components/schemas/Vector3"
        momentum:
          type: number
          minimum: 0

    FreerunState:
      type: object
      required: [character_id, current_position, momentum, stamina]
      properties:
        character_id:
          type: string
          format: uuid
        current_position:
          $ref: "#/components/schemas/Vector3"
        momentum:
          type: number
          minimum: 0
        stamina:
          type: integer
          minimum: 0
        move_type:
          type: string
          enum: [ground, wall_run, air_dash, slide]
        last_update:
          type: string
          format: date-time

    # Hacking
    HackAttemptRequest:
      type: object
      required: [hack_type, target_system]
      properties:
        hack_type:
          type: string
          enum: [quickhack, breach, overload, ping]
        target_system:
          type: string
          enum: [turret, camera, door, enemy_implant]
        quickhack_id:
          type: string
          format: uuid

    HackResult:
      type: object
      required: [success, hack_type, target_system]
      properties:
        success:
          type: boolean
        hack_type:
          type: string
          enum: [quickhack, breach, overload, ping]
        target_system:
          type: string
          enum: [turret, camera, door, enemy_implant]
        duration:
          type: number
          minimum: 0
        damage_dealt:
          type: integer
          minimum: 0
        detection_risk:
          type: number
          minimum: 0
          maximum: 1

    # Stealth
    StealthVisibility:
      type: object
      required: [character_id, visibility_level, detection_risk]
      properties:
        character_id:
          type: string
          format: uuid
        visibility_level:
          type: number
          minimum: 0
          maximum: 1
        detection_risk:
          type: number
          minimum: 0
          maximum: 1
        nearby_enemies:
          type: array
          items:
            type: string
            format: uuid
        last_detected:
          type: string
          format: date-time

    StealthUpdateRequest:
      type: object
      required: [action_type]
      properties:
        action_type:
          type: string
          enum: [crouch, prone, move_silently, use_cover]
        position:
          $ref: "#/components/schemas/Vector3"
        noise_level:
          type: number
          minimum: 0

    StealthState:
      type: object
      required: [character_id, visibility_level, detection_risk]
      properties:
        character_id:
          type: string
          format: uuid
        visibility_level:
          type: number
          minimum: 0
          maximum: 1
        detection_risk:
          type: number
          minimum: 0
          maximum: 1
        current_action:
          type: string
          enum: [standing, crouching, prone, moving]
        last_update:
          type: string
          format: date-time

    # Extraction
    ExtractionRequest:
      type: object
      required: [extraction_point_id]
      properties:
        extraction_point_id:
          type: string
          format: uuid
        team_members:
          type: array
          items:
            type: string
            format: uuid
        loot_items:
          type: array
          items:
            type: string
            format: uuid

    ExtractionResult:
      type: object
      required: [success, session_id, rewards]
      properties:
        success:
          type: boolean
        session_id:
          type: string
          format: uuid
        rewards:
          type: object
          properties:
            experience:
              type: integer
              minimum: 0
            credits:
              type: integer
              minimum: 0
            items:
              type: array
              items:
                type: string
                format: uuid
        completion_time:
          type: string
          format: date-time

    # Arena
    CreateArenaMatchRequest:
      type: object
      required: [player_ids, arena_type, ruleset]
      properties:
        player_ids:
          type: array
          items:
            type: string
            format: uuid
        arena_type:
          type: string
          enum: [deathmatch, team_deathmatch, capture_flag]
        ruleset:
          type: string
          enum: [standard, hardcore, ranked]

    ArenaMatch:
      type: object
      required: [id, player_ids, arena_type, status, created_at]
      properties:
        id:
          type: string
          format: uuid
        player_ids:
          type: array
          items:
            type: string
            format: uuid
        arena_type:
          type: string
          enum: [deathmatch, team_deathmatch, capture_flag]
        ruleset:
          type: string
          enum: [standard, hardcore, ranked]
        status:
          type: string
          enum: [waiting, active, completed]
        winner_id:
          type: string
          format: uuid
        score:
          type: object
          additionalProperties:
            type: integer
        created_at:
          type: string
          format: date-time

    # Cyberspace
    CyberspaceEntryRequest:
      type: object
      required: [entry_point_id]
      properties:
        entry_point_id:
          type: string
          format: uuid
        implant_level:
          type: integer
          minimum: 1
          maximum: 5
        duration:
          type: integer
          minimum: 30
          maximum: 300

    CyberspaceState:
      type: object
      required:
        [character_id, current_node, connection_strength, time_remaining]
      properties:
        character_id:
          type: string
          format: uuid
        current_node:
          type: string
          format: uuid
        connection_strength:
          type: number
          minimum: 0
          maximum: 1
        time_remaining:
          type: integer
          minimum: 0
        active_hacks:
          type: array
          items:
            type: string
        last_update:
          type: string
          format: date-time

    # Common
    Vector3:
      type: object
      required: [x, y, z]
      properties:
        x:
          type: number
        y:
          type: number
        z:
          type: number
