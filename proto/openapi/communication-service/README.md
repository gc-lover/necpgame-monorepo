# Communication Service - OpenAPI Specification

## üìã **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

Communication Service –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –¥–ª—è NECPGAME - enterprise-grade API –¥–ª—è —á–∞—Ç–∞,
—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏
–≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—É—é –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏ –≤ –∫–∏–±–µ—Ä–ø–∞–Ω–∫ MMOFPS RPG.

## üéØ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

### **üí¨ Chat System (–ß–∞—Ç)**

- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –∫–∞–Ω–∞–ª—ã**: –ì–ª–æ–±–∞–ª—å–Ω—ã–π, –≥–∏–ª—å–¥–µ–π—Å–∫–∏–π, –ø–∞—Ä—Ç–∏–π–Ω—ã–π –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
- **Rich Text Messages**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–ª–æ–∂–µ–Ω–∏–π –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
- **Real-time Delivery**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ WebSocket
- **Message History**: –ü–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å –ø–æ–∏—Å–∫–æ–º
- **Reactions**: –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

### **üîî Notification System (–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)**

- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –°–∏—Å—Ç–µ–º–∞, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —Ç–æ—Ä–≥–æ–≤–ª—è, –±–æ–π, –≥–∏–ª—å–¥–∏–∏
- **–ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –∏ –∫–∞–Ω–∞–ª–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏
- **Priority System**: –£—Ä–æ–≤–Ω–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –æ—Ç low –¥–æ critical
- **Bulk Operations**: –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è UI –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Scheduled Delivery**: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **üé§ Voice Channels (–ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã)**

- **Spatial Audio**: –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∞—É–¥–∏–æ –¥–ª—è –∏–º–º–µ—Ä—Å–∏–≤–Ω–æ–≥–æ –æ–ø—ã—Ç–∞
- **WebRTC Integration**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–ª—è –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **Capacity Management**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –∫–∞–Ω–∞–ª–æ–≤
- **Quality Settings**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –±–∏—Ç—Ä–µ–π—Ç –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞
- **Real-time Status**: –°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### **üõ°Ô∏è Moderation System (–ú–æ–¥–µ—Ä–∞—Ü–∏—è)**

- **Content Reports**: –°–∏—Å—Ç–µ–º–∞ –∂–∞–ª–æ–± –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Automated Actions**: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
- **Audit Trail**: –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
- **Escalation System**: –≠—Å–∫–∞–ª–∞—Ü–∏—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π
- **Evidence Management**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π

## üìÅ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**

```
communication-service/
‚îú‚îÄ‚îÄ main.yaml           # –û—Å–Ω–æ–≤–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îú‚îÄ‚îÄ README.md          # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ chat/              # –ß–∞—Ç-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
‚îú‚îÄ‚îÄ notifications/     # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
‚îú‚îÄ‚îÄ voice/             # –ì–æ–ª–æ—Å–æ–≤—ã–µ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
‚îî‚îÄ‚îÄ moderation/        # –ú–æ–¥–µ—Ä–∞—Ü–∏—è-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
```

## üîó **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**

### **Common Architecture (SOLID/DRY)**

- **common/schemas/social-entities.yaml**: `UserProfileEntity`, `ChatChannelEntity`, `ChatMessageEntity`
- **common/schemas/common.yaml**: `BaseEntity`, `UUID`, `Timestamp`
- **common/responses/**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏
- **common/security/**: JWT Bearer authentication

### **External Services**

- **user-profile-service**: –î–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —á–∞—Ç–µ
- **guild-service**: –î–ª—è –≥–∏–ª—å–¥–µ–π—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- **party-service**: –î–ª—è –ø–∞—Ä—Ç–∏–π–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π

## üìä **Performance**

### **Response Times (P99)**

- **Health Check**: <1ms
- **Send Chat Message**: <20ms
- **Get Notifications**: <50ms (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
- **Join Voice Channel**: <25ms
- **Moderation Action**: <45ms

### **Throughput**

- **Chat Messages**: 10,000+ msg/sec peak
- **Notifications**: 5,000+ notifications/sec peak
- **Voice Channels**: 50,000+ concurrent connections
- **WebSocket Connections**: 100,000+ simultaneous

### **Scalability**

- **Horizontal Scaling**: Stateless design –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- **Database Sharding**: –ü–æ user_id –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- **Redis Caching**: 95% –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- **CDN Integration**: –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å—Å–µ—Ç–æ–≤ (–∞–≤–∞—Ç–∞—Ä—ã, —ç–º–æ–¥–∑–∏)

### **Memory Usage**

- **Per User Session**: <50KB
- **Chat Message Cache**: <256 bytes per message
- **Notification Queue**: <512 bytes per notification
- **WebSocket Connection**: <1KB per connection

## üöÄ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**

### **–í–∞–ª–∏–¥–∞—Ü–∏—è**

```bash
# Redocly linting
npx @redocly/cli lint main.yaml

# Bundle –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ $ref
npx @redocly/cli bundle main.yaml -o bundled.yaml
```

### **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go –∫–æ–¥–∞**

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ bundled —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
ogen --target ../../services/communication-service-go/pkg/api \
     --package api --clean bundled.yaml
```

### **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

```bash
# HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
npx @redocly/cli build-docs main.yaml -o docs/index.html

# Swagger UI playground
npx @redocly/cli build-docs main.yaml --template swagger-ui -o docs/playground.html
```

## üîß **Backend Implementation Notes**

### **Database Design**

```sql
-- Chat messages (partitioned by channel_id)
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL,
    sender_id UUID NOT NULL,
    content TEXT NOT NULL,
    sent_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    edited_at TIMESTAMPTZ,
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE
) PARTITION BY HASH (channel_id);

-- Notifications (partitioned by user_id)
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    type VARCHAR(20) NOT NULL,
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    read BOOLEAN NOT NULL DEFAULT FALSE,
    priority VARCHAR(10) NOT NULL DEFAULT 'normal',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
) PARTITION BY HASH (user_id);

-- Voice channels (with spatial indexing)
CREATE TABLE voice_channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    type VARCHAR(20) NOT NULL,
    max_participants INTEGER NOT NULL DEFAULT 10,
    current_participants INTEGER NOT NULL DEFAULT 0,
    region VARCHAR(20) NOT NULL
);

-- Moderation reports
CREATE TABLE moderation_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reporter_id UUID NOT NULL,
    reported_content_type VARCHAR(20) NOT NULL,
    reported_content_id UUID NOT NULL,
    reason VARCHAR(30) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    priority VARCHAR(10) NOT NULL DEFAULT 'medium',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### **WebSocket Implementation**

```go
// Real-time chat and voice status
type WebSocketHub struct {
    clients    map[*WebSocketClient]bool
    broadcast  chan []byte
    register   chan *WebSocketClient
    unregister chan *WebSocketClient
    rooms      map[string]map[*WebSocketClient]bool
}

func (h *WebSocketHub) run() {
    for {
        select {
        case client := <-h.register:
            h.clients[client] = true
            if room, exists := h.rooms[client.roomID]; exists {
                room[client] = true
            } else {
                h.rooms[client.roomID] = make(map[*WebSocketClient]bool)
                h.rooms[client.roomID][client] = true
            }

        case client := <-h.unregister:
            if _, ok := h.clients[client]; ok {
                delete(h.clients, client)
                if room, exists := h.rooms[client.roomID]; exists {
                    delete(room, client)
                    if len(room) == 0 {
                        delete(h.rooms, client.roomID)
                    }
                }
            }

        case message := <-h.broadcast:
            // Broadcast to all clients in the same room
            for client := range h.clients {
                select {
                case client.send <- message:
                default:
                    close(client.send)
                    delete(h.clients, client)
                }
            }
        }
    }
}
```

### **Redis Caching Strategy**

```go
// User notification settings cache
userNotifSettingsKey := fmt.Sprintf("user:%s:notif_settings", userID)

// Channel participant counts
channelParticipantsKey := fmt.Sprintf("channel:%s:participants", channelID)

// Recent chat messages (LRU cache)
chatHistoryKey := fmt.Sprintf("chat:%s:history", channelID)

// Voice channel metadata
voiceChannelKey := fmt.Sprintf("voice:%s:metadata", channelID)
```

### **Rate Limiting**

```go
// Chat message rate limiting
chatLimiter := tollbooster.NewLimiter(10, time.Minute) // 10 messages per minute

// Notification sending limits
notifLimiter := tollbooster.NewLimiter(100, time.Hour) // 100 notifications per hour

// Moderation action limits
moderationLimiter := tollbooster.NewLimiter(50, time.Hour) // 50 actions per hour
```

## üîê **Security Considerations**

### **Authentication**

- JWT Bearer tokens —Å expiration
- Service-to-service authentication –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- API key fallback –¥–ª—è legacy integrations

### **Authorization**

- Role-based access control (RBAC)
- Channel-specific permissions
- Guild membership validation
- Content moderation permissions

### **Data Protection**

- End-to-end encryption –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Message content encryption at rest
- PII data minimization
- GDPR compliance –¥–ª—è user data

### **Spam Prevention**

- Message rate limiting per user/channel
- Content filtering –∏ moderation
- CAPTCHA integration –¥–ª—è suspicious activity
- Automated bot detection

## üìà **Monitoring & Observability**

### **Key Metrics**

```prometheus
# Chat system metrics
chat_messages_total{channel_type="guild"} 1250000
chat_active_connections 8500
chat_message_latency_p95 45

# Notification system metrics
notifications_sent_total{type="achievement"} 50000
notifications_delivery_rate 0.98
notifications_queue_size 150

# Voice system metrics
voice_channels_active 1200
voice_connections_total 45000
voice_audio_latency_p95 25

# Moderation metrics
moderation_reports_pending 45
moderation_actions_total{type="ban"} 1200
moderation_response_time_p95 30
```

### **Logging Strategy**

```json
{
  "timestamp": "2025-12-28T10:30:00Z",
  "level": "INFO",
  "service": "communication-service",
  "operation": "send_chat_message",
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "channel_id": "987fcdeb-51a2-43d7-8f9e-123456789abc",
  "message_length": 150,
  "processing_time_ms": 12,
  "ip_address": "192.168.1.100",
  "user_agent": "NECPGAME-Client/1.0.0"
}
```

### **Health Checks**

```yaml
# Comprehensive health check endpoints
/health:
  status: "healthy"
  uptime: "15d 4h 23m"
  version: "1.2.3"
  dependencies:
    database: "healthy"
    redis: "healthy"
    websocket: "healthy"

/health/batch:
  overall_status: "healthy"
  services:
    chat: "healthy"
    notifications: "healthy"
    voice: "healthy"
    moderation: "healthy"

/health/ws:
  websocket_status: "healthy"
  active_connections: 8547
  message_rate: 1250
  latency_ms: 15
```

## üéØ **API Design Principles**

### **SOLID/DRY Compliance**

- **Single Responsibility**: –ö–∞–∂–¥—ã–π endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é
- **Open/Closed**: –õ–µ–≥–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ common inheritance
- **DRY**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ common schemas –∏ responses
- **SOLID Inheritance**: Domain-specific entity extension

### **RESTful Design**

- **Resource-Based URLs**: `/chat/channels/{id}/messages`
- **HTTP Methods**: GET, POST, PUT, DELETE appropriately
- **Status Codes**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 200, 201, 204, 400, 403, 404
- **Content Negotiation**: JSON responses —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ headers

### **Real-time Communication**

- **WebSocket Protocol**: –î–ª—è real-time messaging –∏ voice
- **Event-Driven**: Server-sent events –¥–ª—è notifications
- **Connection Management**: Graceful handling of disconnects
- **Backpressure**: Prevention of message flooding

### **Error Handling**

- **Consistent Error Format**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ error responses
- **Detailed Error Messages**: –î–ª—è debugging –±–µ–∑ sensitive data exposure
- **Graceful Degradation**: Fallback behavior –ø—Ä–∏ failures
- **Retry Logic**: Exponential backoff –¥–ª—è transient failures

---

## üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã**

**–ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Communication Service:**

- **Tech Lead**: @communication-tech-lead
- **Backend**: @communication-backend
- **Frontend**: @communication-frontend
- **DevOps**: @communication-devops

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞:**

- **SRE Team**: @platform-sre
- **Security**: @platform-security
- **Documentation**: docs@necpgame.com

---

*–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é enterprise-grade –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã NECPGAME —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å,
–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.*
