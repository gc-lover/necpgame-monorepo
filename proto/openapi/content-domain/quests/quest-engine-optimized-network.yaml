# Issue: #51 - Network optimization for quest system
openapi: 3.0.3
info:
  title: Quest Engine Optimized Network API
  version: 2.0.0
  description: |
    Optimized network communication for quest system in MMOFPS RPG.

    ## Network Optimizations Applied

    ### 1. Protocol Selection Strategy
    - **REST API**: Quest CRUD operations, content loading
    - **WebSocket**: Real-time quest state updates (<100ms latency)
    - **UDP**: Critical quest events (rewards, completions) for sub-50ms delivery

    ### 2. Message Compression
    - LZ4 compression for WebSocket messages
    - Delta encoding for quest state updates
    - Binary Protocol Buffers for UDP packets

    ### 3. Connection Optimization
    - Connection pooling (max 2000 connections per server)
    - Heartbeat optimization (30s intervals, 5min timeout)
    - Automatic protocol switching based on quest activity

    ### 4. Message Batching
    - Batch objective updates (max 10 objectives per message)
    - Batch reward notifications (max 5 rewards per message)
    - Batch dialogue updates (max 3 dialogue states per message)

servers:
  - url: http://localhost:8083/api/v1
    description: Quest REST API
  - url: ws://localhost:8301
    description: Quest WebSocket API
  - url: udp://localhost:8302
    description: Quest UDP API (critical events)

paths:
  # REST API for quest management
  /gameplay/quests/content/reload:
    post:
      summary: Reload quest content (compressed YAML)
      operationId: reloadQuestContentOptimized
      requestBody:
        required: true
        content:
          application/x-lz4: # LZ4 compressed JSON
            schema:
              type: object
              properties:
                quest_id:
                  type: string
                yaml_content_compressed:
                  type: string
                  description: LZ4 compressed YAML content
                content_hash:
                  type: string
                  description: SHA-256 hash for integrity verification
      responses:
        '200':
          description: Quest content reloaded
          content:
            application/x-protobuf: # Binary response
              schema:
                $ref: '#/components/schemas/ReloadResponse'

  # WebSocket channels for real-time updates
  /ws/quests/instance/{instance_id}:
    get:
      summary: WebSocket connection for quest instance updates
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
        - name: compress
          in: query
          schema:
            type: boolean
            default: true
          description: Enable LZ4 compression
      responses:
        '101':
          description: WebSocket connection established
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebSocketConnectionAck'

  # UDP endpoint for critical quest events
  /udp/quests/critical-events:
    post:
      summary: UDP endpoint for critical quest events
      operationId: sendCriticalQuestEvent
      requestBody:
        content:
          application/x-protobuf:
            schema:
              $ref: '#/components/schemas/QuestCriticalEvent'
      responses:
        '200':
          description: Event processed
          content:
            application/x-protobuf:
              schema:
                $ref: '#/components/schemas/EventAck'

components:
  schemas:
    ReloadResponse:
      type: object
      properties:
        success:
          type: boolean
        quest_id:
          type: string
        processing_time_ms:
          type: integer
        compression_ratio:
          type: number
          format: float

    WebSocketConnectionAck:
      type: object
      properties:
        connection_id:
          type: string
        heartbeat_interval_ms:
          type: integer
          default: 30000
        compression_enabled:
          type: boolean
          default: true
        max_batch_size:
          type: integer
          default: 10

    QuestCriticalEvent:
      type: object
      properties:
        event_type:
          type: string
          enum: [ quest_completed, reward_claimed, objective_critical ]
        quest_instance_id:
          type: string
        player_id:
          type: string
        timestamp_ms:
          type: integer
        event_data:
          type: object
          description: Event-specific data (compressed)

    EventAck:
      type: object
      properties:
        event_id:
          type: string
        processed:
          type: boolean
        processing_time_us:
          type: integer
