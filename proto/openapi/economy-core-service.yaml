# Issue: #171
openapi: 3.0.3
info:
  title: Economy Core Service API
  version: 1.0.0
  description: |
    Economy Core API for MMOFPS RPG - Inventory and P2P Trade Systems.

    ## Core Components
    - Inventory System: Item storage, equipment, transfer operations
    - Trade System: P2P trading sessions with anti-fraud validation
    - Stash System: Extended storage with organization features

    ## Architecture Overview
    - Server-authoritative economy with validation
    - Event-driven architecture with Kafka
    - Anti-fraud checks and audit logging
    - Real-time inventory synchronization

    ## Performance Requirements
    - Inventory operations: 2000+ RPS with P99 <100ms
    - Trade operations: 500+ RPS with P99 <200ms
    - Memory optimized with field alignment
    - Context timeouts for all operations

servers:
  - url: http://localhost:8200
    description: Local development
  - url: https://api.necpgame.com/v1
    description: Production API

tags:
  - name: inventory
    description: Inventory management operations
  - name: equipment
    description: Character equipment system
  - name: stash
    description: Extended storage system
  - name: trade
    description: P2P trading operations
  - name: transfer
    description: Item transfer operations

security:
  - BearerAuth: []

paths:
  # ============================================================================
  # INVENTORY SYSTEM
  # ============================================================================

  /gameplay/economy/inventory/{character_id}/slots:
    get:
      tags: [inventory]
      summary: Get character inventory slots
      operationId: getInventorySlots
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: include_items
          in: query
          schema:
            type: boolean
            default: true
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Inventory slots
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/InventorySlot"
        "404":
          $ref: common.yaml#/components/responses/NotFound

    post:
      tags: [inventory]
      summary: Add item to inventory
      operationId: addItemToInventory
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddItemRequest"
      responses:
        "201":
          description: Item added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventorySlot"
        "400":
          description: Invalid item or inventory full
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error
        "409":
          description: Item conflicts
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /gameplay/economy/inventory/{character_id}/slots/{slot_id}:
    get:
      tags: [inventory]
      summary: Get specific inventory slot
      operationId: getInventorySlot
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Inventory slot details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventorySlot"
        "404":
          $ref: common.yaml#/components/responses/NotFound

    put:
      tags: [inventory]
      summary: Update inventory slot
      operationId: updateInventorySlot
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSlotRequest"
      responses:
        "200":
          description: Slot updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventorySlot"
        "400":
          $ref: common.yaml#/components/responses/BadRequest

    delete:
      tags: [inventory]
      summary: Remove item from slot
      operationId: removeItemFromSlot
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: slot_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Item removed
        "404":
          $ref: common.yaml#/components/responses/NotFound

  /gameplay/economy/inventory/{character_id}/transfer:
    post:
      tags: [transfer]
      summary: Transfer item between slots
      operationId: transferItem
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransferRequest"
      responses:
        "200":
          description: Transfer completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransferResult"
        "400":
          description: Invalid transfer
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  # ============================================================================
  # EQUIPMENT SYSTEM
  # ============================================================================

  /gameplay/economy/equipment/{character_id}/slots:
    get:
      tags: [equipment]
      summary: Get character equipment slots
      operationId: getEquipmentSlots
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Equipment slots
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/EquipmentSlot"

  /gameplay/economy/equipment/{character_id}/slots/{slot_type}:
    post:
      tags: [equipment]
      summary: Equip item to slot
      operationId: equipItem
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: slot_type
          in: path
          required: true
          schema:
            type: string
            enum:
              [
                head,
                torso,
                arms,
                legs,
                weapon_primary,
                weapon_secondary,
                cyberware,
              ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EquipRequest"
      responses:
        "200":
          description: Item equipped
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EquipmentSlot"
        "400":
          description: Cannot equip item
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

    delete:
      tags: [equipment]
      summary: Unequip item from slot
      operationId: unequipItem
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: slot_type
          in: path
          required: true
          schema:
            type: string
            enum:
              [
                head,
                torso,
                arms,
                legs,
                weapon_primary,
                weapon_secondary,
                cyberware,
              ]
      responses:
        "200":
          description: Item unequipped
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnequipResult"

  # ============================================================================
  # STASH SYSTEM
  # ============================================================================

  /gameplay/economy/stash/{character_id}/pages:
    get:
      tags: [stash]
      summary: Get stash pages
      operationId: getStashPages
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Stash pages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StashPage"

  /gameplay/economy/stash/{character_id}/transfer:
    post:
      tags: [stash]
      summary: Transfer item to/from stash
      operationId: stashTransfer
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StashTransferRequest"
      responses:
        "200":
          description: Transfer completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StashTransferResult"

  # ============================================================================
  # TRADE SYSTEM
  # ============================================================================

  /gameplay/economy/trade/sessions:
    post:
      tags: [trade]
      summary: Create trade session
      operationId: createTradeSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTradeSessionRequest"
      responses:
        "201":
          description: Trade session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TradeSession"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "409":
          description: Trade conflict
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

    get:
      tags: [trade]
      summary: List active trade sessions
      operationId: listTradeSessions
      parameters:
        - name: participant_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, active, completed, cancelled]
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Trade sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TradeSession"

  /gameplay/economy/trade/sessions/{session_id}:
    get:
      tags: [trade]
      summary: Get trade session details
      operationId: getTradeSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trade session details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TradeSession"
        "404":
          $ref: common.yaml#/components/responses/NotFound

    delete:
      tags: [trade]
      summary: Cancel trade session
      operationId: cancelTradeSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CancelTradeRequest"
      responses:
        "200":
          description: Session cancelled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TradeSession"
        "404":
          $ref: common.yaml#/components/responses/NotFound

  /gameplay/economy/trade/sessions/{session_id}/offers:
    post:
      tags: [trade]
      summary: Add offer to trade session
      operationId: addTradeOffer
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddOfferRequest"
      responses:
        "200":
          description: Offer added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TradeOffer"
        "400":
          description: Invalid offer
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /gameplay/economy/trade/sessions/{session_id}/confirm:
    post:
      tags: [trade]
      summary: Confirm trade session
      operationId: confirmTradeSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmTradeRequest"
      responses:
        "200":
          description: Trade completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TradeResult"
        "400":
          description: Confirmation failed
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /gameplay/economy/trade/history:
    get:
      tags: [trade]
      summary: Get trade history
      operationId: getTradeHistory
      parameters:
        - name: character_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: since
          in: query
          schema:
            type: string
            format: date-time
        - $ref: common.yaml#/components/parameters/Limit
      responses:
        "200":
          description: Trade history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TradeHistoryEntry"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ============================================================================
    # INVENTORY SCHEMAS
    # ============================================================================

    InventorySlot:
      type: object
      required: [slot_id, slot_type, position_x, position_y]
      properties:
        slot_id:
          type: string
          format: uuid
        slot_type:
          type: string
          enum: [inventory, equipment, stash]
        position_x:
          type: integer
          minimum: 0
        position_y:
          type: integer
          minimum: 0
        item:
          $ref: "#/components/schemas/InventoryItem"
        is_locked:
          type: boolean
          default: false
        last_updated:
          type: string
          format: date-time

    InventoryItem:
      type: object
      required: [item_id, template_id, quantity, quality]
      properties:
        item_id:
          type: string
          format: uuid
        template_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        quality:
          type: string
          enum: [common, uncommon, rare, epic, legendary, iconic]
        durability:
          type: integer
          minimum: 0
        max_durability:
          type: integer
          minimum: 1
        custom_properties:
          type: object
          additionalProperties: true
        is_bound:
          type: boolean
          default: false
        bound_on:
          type: string
          enum: [pickup, equip, account]
        created_at:
          type: string
          format: date-time

    AddItemRequest:
      type: object
      required: [template_id, quantity]
      properties:
        template_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        quality:
          type: string
          enum: [common, uncommon, rare, epic, legendary, iconic]
          default: common
        custom_properties:
          type: object
          additionalProperties: true
        source:
          type: string
          enum: [loot, craft, purchase, reward, admin]

    UpdateSlotRequest:
      type: object
      properties:
        quantity:
          type: integer
          minimum: 0
        durability:
          type: integer
          minimum: 0
        custom_properties:
          type: object
          additionalProperties: true

    TransferRequest:
      type: object
      required: [from_slot_id, to_slot_id, quantity]
      properties:
        from_slot_id:
          type: string
          format: uuid
        to_slot_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        split_stack:
          type: boolean
          default: false

    TransferResult:
      type: object
      required: [from_slot, to_slot, transferred_quantity]
      properties:
        from_slot:
          $ref: "#/components/schemas/InventorySlot"
        to_slot:
          $ref: "#/components/schemas/InventorySlot"
        transferred_quantity:
          type: integer
        transfer_fee:
          type: integer
          minimum: 0

    # ============================================================================
    # EQUIPMENT SCHEMAS
    # ============================================================================

    EquipmentSlot:
      type: object
      required: [slot_type, is_equipped]
      properties:
        slot_type:
          type: string
          enum:
            [
              head,
              torso,
              arms,
              legs,
              weapon_primary,
              weapon_secondary,
              cyberware,
            ]
        item:
          $ref: "#/components/schemas/InventoryItem"
        is_equipped:
          type: boolean
        equipped_at:
          type: string
          format: date-time
        requirements_met:
          type: boolean
        stat_bonuses:
          type: object
          additionalProperties:
            type: number

    EquipRequest:
      type: object
      required: [item_id]
      properties:
        item_id:
          type: string
          format: uuid
        ignore_requirements:
          type: boolean
          default: false

    UnequipResult:
      type: object
      required: [slot_type, unequipped_item]
      properties:
        slot_type:
          type: string
        unequipped_item:
          $ref: "#/components/schemas/InventoryItem"
        returned_to_inventory:
          type: boolean
        unequipped_at:
          type: string
          format: date-time

    # ============================================================================
    # STASH SCHEMAS
    # ============================================================================

    StashPage:
      type: object
      required: [page_id, page_number, slots]
      properties:
        page_id:
          type: string
          format: uuid
        page_number:
          type: integer
          minimum: 1
        slots:
          type: array
          items:
            $ref: "#/components/schemas/InventorySlot"
        is_unlocked:
          type: boolean
        unlock_cost:
          type: integer

    StashTransferRequest:
      type: object
      required: [direction, item_id, quantity]
      properties:
        direction:
          type: string
          enum: [to_stash, from_stash]
        item_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        stash_page:
          type: integer
          minimum: 1
        stash_slot_x:
          type: integer
          minimum: 0
        stash_slot_y:
          type: integer
          minimum: 0

    StashTransferResult:
      type: object
      required: [success, direction, transferred_quantity]
      properties:
        success:
          type: boolean
        direction:
          type: string
        transferred_quantity:
          type: integer
        stash_fee:
          type: integer
          minimum: 0
        inventory_slot:
          $ref: "#/components/schemas/InventorySlot"
        stash_slot:
          $ref: "#/components/schemas/InventorySlot"

    # ============================================================================
    # TRADE SCHEMAS
    # ============================================================================

    CreateTradeSessionRequest:
      type: object
      required: [initiator_id, target_id, initiator_items, target_items]
      properties:
        initiator_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        initiator_items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        target_items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        initiator_credits:
          type: integer
          minimum: 0
          default: 0
        target_credits:
          type: integer
          minimum: 0
          default: 0
        timeout_seconds:
          type: integer
          minimum: 30
          maximum: 300
          default: 120

    TradeSession:
      type: object
      required: [session_id, initiator_id, target_id, status, created_at]
      properties:
        session_id:
          type: string
          format: uuid
        initiator_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            [
              pending,
              active,
              confirmed_by_initiator,
              confirmed_by_target,
              completed,
              cancelled,
              timed_out,
            ]
        initiator_items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        target_items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        initiator_credits:
          type: integer
          minimum: 0
        target_credits:
          type: integer
          minimum: 0
        timeout_seconds:
          type: integer
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    TradeItem:
      type: object
      required: [item_id, quantity]
      properties:
        item_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1

    AddOfferRequest:
      type: object
      required: [participant_id, items, credits]
      properties:
        participant_id:
          type: string
          format: uuid
        items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        credits:
          type: integer
          minimum: 0

    TradeOffer:
      type: object
      required: [offer_id, participant_id, items, credits, offered_at]
      properties:
        offer_id:
          type: string
          format: uuid
        participant_id:
          type: string
          format: uuid
        items:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        credits:
          type: integer
          minimum: 0
        offered_at:
          type: string
          format: date-time

    CancelTradeRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          enum: [user_cancelled, timeout, fraud_detected, system_error]
        participant_id:
          type: string
          format: uuid

    ConfirmTradeRequest:
      type: object
      required: [participant_id]
      properties:
        participant_id:
          type: string
          format: uuid
        anti_fraud_token:
          type: string

    TradeResult:
      type: object
      required:
        [
          session_id,
          success,
          initiator_items_transferred,
          target_items_transferred,
        ]
      properties:
        session_id:
          type: string
          format: uuid
        success:
          type: boolean
        initiator_items_transferred:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        target_items_transferred:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        initiator_credits_transferred:
          type: integer
        target_credits_transferred:
          type: integer
        completed_at:
          type: string
          format: date-time
        trade_fee:
          type: integer

    TradeHistoryEntry:
      type: object
      required:
        [
          session_id,
          character_id,
          partner_id,
          items_given,
          items_received,
          credits_given,
          credits_received,
          completed_at,
        ]
      properties:
        session_id:
          type: string
          format: uuid
        character_id:
          type: string
          format: uuid
        partner_id:
          type: string
          format: uuid
        items_given:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        items_received:
          type: array
          items:
            $ref: "#/components/schemas/TradeItem"
        credits_given:
          type: integer
        credits_received:
          type: integer
        completed_at:
          type: string
          format: date-time
        trade_fee:
          type: integer
