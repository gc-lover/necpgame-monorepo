# Issue: #140894825
openapi: 3.0.3
info:
  title: Stock Protection Comprehensive Service API
  description: |
    Комплексный API для защиты фондового рынка в MMOFPS RPG.

    **Основные возможности:**
    - Защита от манипуляций рынком
    - Предотвращение инсайдерской торговли
    - Мониторинг волатильности и рисков
    - Автоматические защитные механизмы
    - Регуляторный надзор и compliance
    - Анти-фрод системы и обнаружение мошенничества
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8080/api/v1/stock-protection
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1/stock-protection
    description: Продакшен сервер

tags:
  - name: Stock Protection
    description: Комплексная защита фондового рынка

paths:
  /market-integrity/monitor:
    get:
      tags:
        - Stock Protection
      summary: Мониторинг целостности рынка
      description: |
        Комплексный мониторинг состояния рынка с выявлением потенциальных угроз целостности.
        Включает анализ паттернов торговли, обнаружение манипуляций и оценку рисков.
      operationId: monitorMarketIntegrity
      parameters:
        - name: time_window
          in: query
          schema:
            type: string
            enum: [1h, 4h, 24h, 7d]
            default: 24h
            description: Временное окно для анализа
        - name: risk_threshold
          in: query
          schema:
            type: number
            minimum: 0
            maximum: 1
            default: 0.7
            description: Порог риска для тревог (0-1)
        - name: include_historical
          in: query
          schema:
            type: boolean
            default: false
            description: Включать исторические данные
      responses:
        "200":
          description: Состояние целостности рынка
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketIntegrityStatus"

  /market-manipulation/detect:
    post:
      tags:
        - Stock Protection
      summary: Обнаружение манипуляций рынком
      description: |
        Анализ торговой активности для выявления потенциальных манипуляций рынком.
        Использует продвинутые алгоритмы обнаружения паттернов и аномалий.
      operationId: detectMarketManipulation
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ManipulationDetectionRequest"
      responses:
        "200":
          description: Результаты анализа на манипуляции
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManipulationDetectionResult"
        "400":
          $ref: "../../common-schemas.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../../common-schemas.yaml#/components/responses/Unauthorized"

  /insider-trading/monitor:
    get:
      tags:
        - Stock Protection
      summary: Мониторинг инсайдерской торговли
      description: |
        Отслеживание подозрительной торговой активности, которая может указывать на инсайдерскую торговлю.
        Анализирует связи между трейдерами и корпоративными инсайдерами.
      operationId: monitorInsiderTrading
      parameters:
        - name: stock_id
          in: query
          schema:
            type: string
            format: uuid
            description: ID акции для анализа
        - name: trader_id
          in: query
          schema:
            type: string
            format: uuid
            description: ID трейдера для проверки
        - name: sensitivity_level
          in: query
          schema:
            type: string
            enum: [low, medium, high]
            default: medium
            description: Уровень чувствительности обнаружения
      responses:
        "200":
          description: Результаты мониторинга инсайдерской торговли
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InsiderTradingAnalysis"

  /volatility-protection/activate:
    post:
      tags:
        - Stock Protection
      summary: Активация защиты от волатильности
      description: |
        Активирует защитные механизмы при обнаружении повышенной волатильности рынка.
        Включает ограничения на торговлю, дополнительные проверки и стабилизирующие меры.
      operationId: activateVolatilityProtection
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VolatilityProtectionRequest"
      responses:
        "200":
          description: Защитные меры активированы
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VolatilityProtectionResponse"
        "400":
          $ref: "../../common-schemas.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../../common-schemas.yaml#/components/responses/Unauthorized"
        "403":
          description: Недостаточно прав для активации защиты

  /fraud-detection/scan:
    post:
      tags:
        - Stock Protection
      summary: Сканирование на мошенничество
      description: |
        Комплексное сканирование транзакций и торговой активности на признаки мошенничества.
        Использует машинное обучение и правила-based анализ.
      operationId: scanForFraud
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FraudScanRequest"
      responses:
        "200":
          description: Результаты сканирования на мошенничество
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FraudScanResult"
        "400":
          $ref: "../../common-schemas.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../../common-schemas.yaml#/components/responses/Unauthorized"

  /circuit-breakers/status:
    get:
      tags:
        - Stock Protection
      summary: Статус автоматических выключателей
      description: |
        Получение статуса автоматических защитных выключателей рынка.
        Показывает активные ограничения и условия их активации.
      operationId: getCircuitBreakersStatus
      responses:
        "200":
          description: Статус выключателей
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CircuitBreakersStatus"

  /regulatory-compliance/check:
    post:
      tags:
        - Stock Protection
      summary: Проверка регуляторного compliance
      description: |
        Проверка соответствия торговой деятельности регуляторным требованиям.
        Включает анализ disclosure, reporting и compliance с правилами рынка.
      operationId: checkRegulatoryCompliance
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ComplianceCheckRequest"
      responses:
        "200":
          description: Результаты проверки compliance
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ComplianceCheckResult"
        "400":
          $ref: "../../common-schemas.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../../common-schemas.yaml#/components/responses/Unauthorized"

  /market-surveillance/report:
    get:
      tags:
        - Stock Protection
      summary: Отчет о рыночном надзоре
      description: |
        Комплексный отчет о состоянии рыночного надзора с выявленными инцидентами,
        принятыми мерами и рекомендациями по улучшению.
      operationId: getMarketSurveillanceReport
      parameters:
        - name: report_period
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly]
            default: daily
            description: Период отчета
        - name: include_recommendations
          in: query
          schema:
            type: boolean
            default: true
            description: Включать рекомендации
      responses:
        "200":
          description: Отчет о рыночном надзоре
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketSurveillanceReport"

  /risk-assessment/portfolio:
    post:
      tags:
        - Stock Protection
      summary: Оценка рисков портфеля
      description: |
        Комплексная оценка рисков инвестиционного портфеля с учетом рыночных условий,
        волатильности и потенциальных угроз.
      operationId: assessPortfolioRisk
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PortfolioRiskAssessmentRequest"
      responses:
        "200":
          description: Оценка рисков портфеля
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortfolioRiskAssessment"
        "400":
          $ref: "../../common-schemas.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../../common-schemas.yaml#/components/responses/Unauthorized"

components:
  schemas:
    MarketIntegrityStatus:
      type: object
      description: Состояние целостности рынка
      properties:
        overall_integrity_score:
          type: number
          minimum: 0
          maximum: 100
          description: Общий балл целостности рынка (%)
        risk_indicators:
          type: object
          description: Индикаторы рисков
          properties:
            manipulation_risk:
              type: number
              minimum: 0
              maximum: 100
              description: Риск манипуляций (%)
            insider_trading_risk:
              type: number
              minimum: 0
              maximum: 100
              description: Риск инсайдерской торговли (%)
            volatility_risk:
              type: number
              minimum: 0
              maximum: 100
              description: Риск волатильности (%)
            fraud_risk:
              type: number
              minimum: 0
              maximum: 100
              description: Риск мошенничества (%)
        active_protections:
          type: array
          description: Активные защитные меры
          items:
            type: object
            properties:
              protection_type:
                type: string
                enum: [circuit_breaker, trading_limits, enhanced_monitoring, suspension]
              activation_reason:
                type: string
              activation_time:
                type: string
                format: date-time
              expected_duration:
                type: string
                description: "Ожидаемая длительность (например: '2 hours')"
        recent_incidents:
          type: array
          description: Недавние инциденты
          items:
            type: object
            properties:
              incident_type:
                type: string
                enum: [suspicious_trading, price_manipulation, insider_activity, fraud_attempt]
              severity:
                type: string
                enum: [low, medium, high, critical]
              timestamp:
                type: string
                format: date-time
              status:
                type: string
                enum: [investigating, resolved, ongoing]

    ManipulationDetectionRequest:
      type: object
      description: Запрос на обнаружение манипуляций
      required:
        - target_stocks
        - analysis_period
      properties:
        target_stocks:
          type: array
          items:
            type: string
            format: uuid
          description: Акции для анализа
        analysis_period:
          type: object
          description: Период анализа
          properties:
            start_time:
              type: string
              format: date-time
            end_time:
              type: string
              format: date-time
        detection_sensitivity:
          type: string
          enum: [low, medium, high]
          default: medium
          description: Чувствительность обнаружения
        include_pattern_analysis:
          type: boolean
          default: true
          description: Включать анализ паттернов

    ManipulationDetectionResult:
      type: object
      description: Результаты обнаружения манипуляций
      properties:
        scan_timestamp:
          type: string
          format: date-time
        analyzed_transactions:
          type: integer
          description: Количество проанализированных транзакций
        detected_manipulations:
          type: array
          description: Обнаруженные манипуляции
          items:
            type: object
            properties:
              manipulation_type:
                type: string
                enum: [pump_and_dump, spoofing, layering, wash_trading, cornering]
              confidence_score:
                type: number
                minimum: 0
                maximum: 100
                description: Уровень уверенности (%)
              affected_stocks:
                type: array
                items:
                  type: string
                  format: uuid
              estimated_impact:
                type: object
                description: Ожидаемое влияние
                properties:
                  price_distortion:
                    type: number
                    description: Искажение цены (%)
                  volume_artificially_inflated:
                    type: number
                    description: Искусственное завышение объема (%)
              recommended_actions:
                type: array
                items:
                  type: string
                  description: Рекомендуемые меры
        clean_transactions_ratio:
          type: number
          minimum: 0
          maximum: 100
          description: Доля чистых транзакций (%)

    InsiderTradingAnalysis:
      type: object
      description: Анализ инсайдерской торговли
      properties:
        analysis_period:
          type: string
        suspicious_activities:
          type: array
          description: Подозрительная активность
          items:
            type: object
            properties:
              trader_id:
                type: string
                format: uuid
              stock_id:
                type: string
                format: uuid
              activity_type:
                type: string
                enum: [unusual_timing, connected_trading, information_advantage]
              risk_score:
                type: number
                minimum: 0
                maximum: 100
              evidence_strength:
                type: string
                enum: [weak, moderate, strong, conclusive]
              timeline:
                type: array
                description: Хронология событий
                items:
                  type: object
                  properties:
                    event:
                      type: string
                    timestamp:
                      type: string
                      format: date-time
        network_connections:
          type: object
          description: Связи в сети
          properties:
            identified_connections:
              type: integer
              description: Выявленные связи
            high_risk_connections:
              type: integer
              description: Высоко рискованные связи
            monitoring_recommendations:
              type: array
              items:
                type: string
        compliance_status:
          type: string
          enum: [compliant, under_review, non_compliant]
          description: Статус соответствия

    VolatilityProtectionRequest:
      type: object
      description: Запрос на активацию защиты от волатильности
      required:
        - trigger_condition
        - protection_level
      properties:
        trigger_condition:
          type: string
          enum: [price_drop_threshold, volume_spike, index_crash, manual_activation]
          description: Условие активации
        protection_level:
          type: string
          enum: [light, moderate, heavy, emergency]
          description: Уровень защиты
        affected_markets:
          type: array
          items:
            type: string
            format: uuid
          description: Затронутые рынки
        duration_minutes:
          type: integer
          minimum: 5
          maximum: 480
          default: 60
          description: Длительность защиты (минуты)
        additional_measures:
          type: array
          items:
            type: string
            enum: [halt_trading, increase_margins, limit_positions, enhanced_reporting]
          description: Дополнительные меры

    VolatilityProtectionResponse:
      type: object
      description: Ответ на активацию защиты от волатильности
      properties:
        protection_id:
          type: string
          format: uuid
        activation_status:
          type: string
          enum: [activated, pending, failed]
        activated_measures:
          type: array
          description: Активированные меры
          items:
            type: object
            properties:
              measure_type:
                type: string
              implementation_status:
                type: string
                enum: [implemented, pending, failed]
              expected_impact:
                type: string
        monitoring_parameters:
          type: object
          description: Параметры мониторинга
          properties:
            volatility_threshold:
              type: number
              description: Порог волатильности для деактивации
            reassessment_interval:
              type: integer
              description: Интервал переоценки (минуты)
        deactivation_criteria:
          type: array
          items:
            type: string
            description: Критерии деактивации

    FraudScanRequest:
      type: object
      description: Запрос на сканирование мошенничества
      required:
        - scan_scope
      properties:
        scan_scope:
          type: object
          description: Область сканирования
          properties:
            time_range:
              type: object
              properties:
                start_time:
                  type: string
                  format: date-time
                end_time:
                  type: string
                  format: date-time
            trader_ids:
              type: array
              items:
                type: string
                format: uuid
            stock_ids:
              type: array
              items:
                type: string
                format: uuid
        scan_intensity:
          type: string
          enum: [quick, standard, deep]
          default: standard
          description: Интенсивность сканирования
        include_ai_analysis:
          type: boolean
          default: true
          description: Включать AI анализ

    FraudScanResult:
      type: object
      description: Результаты сканирования мошенничества
      properties:
        scan_id:
          type: string
          format: uuid
        scan_duration_seconds:
          type: number
        scanned_transactions:
          type: integer
        fraud_indicators:
          type: array
          description: Индикаторы мошенничества
          items:
            type: object
            properties:
              fraud_type:
                type: string
                enum: [identity_theft, money_laundering, market_abuse, false_trading]
              severity:
                type: string
                enum: [low, medium, high, critical]
              affected_accounts:
                type: integer
              estimated_loss:
                type: number
                description: Ожидаемые потери
              detection_method:
                type: string
                enum: [rule_based, statistical, ai_model, manual_review]
        risk_assessment:
          type: object
          description: Оценка рисков
          properties:
            overall_fraud_risk:
              type: number
              minimum: 0
              maximum: 100
            trending_risk:
              type: string
              enum: [decreasing, stable, increasing]
        recommended_actions:
          type: array
          items:
            type: string
            description: Рекомендуемые действия

    CircuitBreakersStatus:
      type: object
      description: Статус автоматических выключателей
      properties:
        circuit_breakers:
          type: array
          description: Выключатели
          items:
            type: object
            properties:
              breaker_id:
                type: string
                format: uuid
              breaker_type:
                type: string
                enum: [price_limit, volume_limit, volatility_breaker, custom_rule]
              status:
                type: string
                enum: [inactive, monitoring, triggered, cooling_down]
              trigger_threshold:
                type: number
                description: Порог активации
              current_value:
                type: number
                description: Текущее значение
              last_triggered:
                type: string
                format: date-time
              cooldown_remaining:
                type: integer
                description: Остаток cooldown (секунды)
        system_health:
          type: object
          description: Здоровье системы
          properties:
            all_breakers_operational:
              type: boolean
            average_response_time:
              type: number
              description: Среднее время отклика (мс)
            last_system_check:
              type: string
              format: date-time

    ComplianceCheckRequest:
      type: object
      description: Запрос на проверку compliance
      required:
        - check_target
      properties:
        check_target:
          type: object
          description: Цель проверки
          properties:
            trader_id:
              type: string
              format: uuid
            corporation_id:
              type: string
              format: uuid
            transaction_ids:
              type: array
              items:
                type: string
                format: uuid
        compliance_areas:
          type: array
          items:
            type: string
            enum: [disclosure, reporting, trading_limits, conflict_of_interest, data_protection]
          default: ["disclosure", "reporting", "trading_limits"]
        include_recommendations:
          type: boolean
          default: true

    ComplianceCheckResult:
      type: object
      description: Результаты проверки compliance
      properties:
        check_id:
          type: string
          format: uuid
        overall_compliance_score:
          type: number
          minimum: 0
          maximum: 100
          description: Общий балл соответствия (%)
        area_results:
          type: object
          description: Результаты по областям
          additionalProperties:
            type: object
            properties:
              compliant:
                type: boolean
              violations:
                type: array
                items:
                  type: object
                  properties:
                    violation_type:
                      type: string
                    severity:
                      type: string
                      enum: [minor, moderate, major]
                    description:
                      type: string
        required_actions:
          type: array
          description: Требуемые действия
          items:
            type: object
            properties:
              action_type:
                type: string
                enum: [immediate, within_24h, within_week, discretionary]
              description:
                type: string
              priority:
                type: string
                enum: [low, medium, high, critical]

    MarketSurveillanceReport:
      type: object
      description: Отчет о рыночном надзоре
      properties:
        report_period:
          type: string
        report_generated_at:
          type: string
          format: date-time
        executive_summary:
          type: object
          description: Исполнительное резюме
          properties:
            incidents_detected:
              type: integer
            major_violations:
              type: integer
            market_stability_index:
              type: number
              minimum: 0
              maximum: 100
            overall_risk_level:
              type: string
              enum: [low, moderate, elevated, high, critical]
        detailed_findings:
          type: object
          description: Детальные результаты
          properties:
            manipulation_incidents:
              $ref: "#/components/schemas/ManipulationDetectionResult"
            insider_trading_cases:
              type: integer
            fraud_attempts:
              type: integer
            volatility_events:
              type: integer
        protection_system_performance:
          type: object
          description: Производительность систем защиты
          properties:
            false_positive_rate:
              type: number
              minimum: 0
              maximum: 100
            detection_accuracy:
              type: number
              minimum: 0
              maximum: 100
            response_time_avg:
              type: number
              description: Среднее время отклика (секунды)
        recommendations:
          type: array
          items:
            type: string
            description: Рекомендации по улучшению

    PortfolioRiskAssessmentRequest:
      type: object
      description: Запрос на оценку рисков портфеля
      required:
        - portfolio_id
      properties:
        portfolio_id:
          type: string
          format: uuid
        assessment_depth:
          type: string
          enum: [basic, standard, comprehensive]
          default: standard
        include_market_factors:
          type: boolean
          default: true
        risk_time_horizon:
          type: string
          enum: [short_term, medium_term, long_term]
          default: medium_term
        stress_test_scenarios:
          type: array
          items:
            type: string
            enum: [market_crash, sector_crisis, geopolitical_event, liquidity_crisis]
          description: Сценарии стресс-тестирования

    PortfolioRiskAssessment:
      type: object
      description: Оценка рисков портфеля
      properties:
        portfolio_id:
          type: string
          format: uuid
        overall_risk_score:
          type: number
          minimum: 0
          maximum: 100
          description: Общий балл риска (%)
        risk_breakdown:
          type: object
          description: Разбивка рисков
          properties:
            market_risk:
              type: number
              minimum: 0
              maximum: 100
            liquidity_risk:
              type: number
              minimum: 0
              maximum: 100
            credit_risk:
              type: number
              minimum: 0
              maximum: 100
            operational_risk:
              type: number
              minimum: 0
              maximum: 100
            systemic_risk:
              type: number
              minimum: 0
              maximum: 100
        stress_test_results:
          type: object
          description: Результаты стресс-тестирования
          additionalProperties:
            type: object
            properties:
              loss_percentage:
                type: number
                description: Потери (%)
              recovery_time:
                type: string
                description: Время восстановления
        risk_mitigation_suggestions:
          type: array
          items:
            type: object
            properties:
              risk_type:
                type: string
              suggestion:
                type: string
              expected_impact:
                type: string
              implementation_complexity:
                type: string
                enum: [low, medium, high]
        diversification_score:
          type: number
          minimum: 0
          maximum: 100
          description: Балл диверсификации (%)

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
