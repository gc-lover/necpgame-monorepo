# Issue: #62
openapi: 3.0.3
info:
  title: Economy Equipment Service API
  description: |
    API для системы оборудования в NECPGAME.

    **Основные возможности:**
    - Каталог оборудования (ручной срез ключевых предметов)
    - Временная линия культового оборудования (Iconic Equipment Timeline)
    - Процедурная генерация оборудования
    - Управление матрицей характеристик
    - Аналитика оборудования

    **Интеграции:**
    - inventory-service - добавление предметов в инвентарь
    - economy-service - торговля оборудованием
    - gameplay-service - расчет характеристик
    - narrative-service - разблокировка культового через квесты
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8085/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер

tags:
  - name: Equipment Catalog
    description: Каталог оборудования
  - name: Iconic Equipment
    description: Культовое оборудование
  - name: Equipment Matrix
    description: Процедурная матрица снаряжения
  - name: Equipment Analytics
    description: Аналитика оборудования

paths:
  /economy/equipment/catalog:
    get:
      tags:
        - Equipment Catalog
      summary: Получить каталог оборудования
      description: |
        Возвращает каталог оборудования с возможностью фильтрации.
      operationId: getEquipmentCatalog
      security:
        - BearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
          description: Фильтр по категории
        - name: brand_id
          in: query
          schema:
            type: string
            format: uuid
          description: Фильтр по бренду
        - name: rarity
          in: query
          schema:
            $ref: "#/components/schemas/EquipmentRarity"
          description: Фильтр по редкости
        - $ref: "common.yaml#/components/parameters/Limit"
        - $ref: "common.yaml#/components/parameters/Offset"
      responses:
        "200":
          description: Каталог оборудования
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/CatalogItem"
                  total:
                    type: integer
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/catalog/{id}:
    get:
      tags:
        - Equipment Catalog
      summary: Получить предмет из каталога
      description: |
        Возвращает детальную информацию о предмете из каталога.
      operationId: getCatalogItem
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор предмета
      responses:
        "200":
          description: Информация о предмете
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CatalogItem"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/iconic/timeline:
    get:
      tags:
        - Iconic Equipment
      summary: Получить временную линию культового оборудования
      description: |
        Возвращает временную линию культового оборудования по годам (2020-2093).
      operationId: getIconicTimeline
      security:
        - BearerAuth: []
      parameters:
        - name: year
          in: query
          schema:
            type: integer
            minimum: 2020
            maximum: 2093
          description: Фильтр по году
        - name: unlocked_only
          in: query
          schema:
            type: boolean
          description: Только разблокированное оборудование
        - $ref: "common.yaml#/components/parameters/Limit"
        - $ref: "common.yaml#/components/parameters/Offset"
      responses:
        "200":
          description: Временная линия культового оборудования
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/IconicItem"
                  total:
                    type: integer
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/iconic/{id}:
    get:
      tags:
        - Iconic Equipment
      summary: Получить культовый предмет
      description: |
        Возвращает детальную информацию о культовом предмете.
      operationId: getIconicItem
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор культового предмета
      responses:
        "200":
          description: Информация о культовом предмете
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IconicItem"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/analytics:
    get:
      tags:
        - Equipment Analytics
      summary: Получить аналитику оборудования
      description: |
        Возвращает аналитику по использованию оборудования.
      operationId: getEquipmentAnalytics
      security:
        - BearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month, year]
          description: Период аналитики
        - name: category
          in: query
          schema:
            type: string
          description: Фильтр по категории
      responses:
        "200":
          description: Аналитика оборудования
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EquipmentAnalytics"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/generate:
    post:
      tags:
        - Equipment Matrix
      summary: Генерация предмета процедурно
      operationId: generateEquipment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerateEquipmentRequest"
      responses:
        "200":
          description: Предмет сгенерирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GeneratedItem"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/matrix:
    get:
      tags:
        - Equipment Matrix
      summary: Получить матрицу характеристик
      operationId: getEquipmentMatrix
      security:
        - BearerAuth: []
      parameters:
        - name: brand_id
          in: query
          schema:
            type: string
            format: uuid
        - name: item_type
          in: query
          schema:
            $ref: "#/components/schemas/EquipmentItemType"
        - name: rarity
          in: query
          schema:
            $ref: "#/components/schemas/EquipmentRarity"
      responses:
        "200":
          description: Матрица характеристик
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EquipmentMatrix"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/brands:
    get:
      tags:
        - Equipment Matrix
      summary: Получить список брендов
      operationId: getEquipmentBrands
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Список брендов
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BrandsListResponse"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/rarities:
    get:
      tags:
        - Equipment Matrix
      summary: Получить список редкостей
      operationId: getEquipmentRarities
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Список редкостей
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RaritiesListResponse"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/stat-pools:
    get:
      tags:
        - Equipment Matrix
      summary: Получить пулы характеристик
      operationId: getStatPools
      security:
        - BearerAuth: []
      parameters:
        - name: item_type
          in: query
          schema:
            $ref: "#/components/schemas/EquipmentItemType"
      responses:
        "200":
          description: Список пулов характеристик
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatPoolsListResponse"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

  /economy/equipment/validate-balance:
    post:
      tags:
        - Equipment Matrix
      summary: Валидация баланса предмета
      operationId: validateEquipmentBalance
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidateBalanceRequest"
      responses:
        "200":
          description: Результат валидации баланса
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BalanceValidationResult"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
        "500":
          $ref: "common.yaml#/components/responses/InternalServerError"

components:
  securitySchemes:
    BearerAuth:
      $ref: "common.yaml#/components/securitySchemes/BearerAuth"

  schemas:
    GenerateEquipmentRequest:
      type: object
      required:
        - item_type
      properties:
        item_type:
          $ref: "#/components/schemas/EquipmentItemType"
        brand_id:
          type: string
          format: uuid
          nullable: true
        rarity:
          $ref: "#/components/schemas/EquipmentRarity"
          nullable: true
        seed:
          type: string
          nullable: true
        source:
          type: string
          enum: [LOOT, CRAFT, PURCHASE, QUEST]
          nullable: true

    GeneratedItem:
      type: object
      required:
        - id
        - seed
        - brand_id
        - item_type
        - rarity
        - stats
        - generated_at
      properties:
        id:
          type: string
          format: uuid
        seed:
          type: string
        brand_id:
          type: string
          format: uuid
        item_type:
          $ref: "#/components/schemas/EquipmentItemType"
        rarity:
          $ref: "#/components/schemas/EquipmentRarity"
        stats:
          type: object
          additionalProperties: true
        modifiers:
          type: array
          items:
            type: string
            format: uuid
        mod_slots:
          type: integer
          minimum: 0
        generated_at:
          type: string
          format: date-time

    EquipmentItemType:
      type: string
      enum: [WEAPON, IMPLANT, ARMOR, ACCESSORY]

    EquipmentRarity:
      type: string
      enum: [COMMON, UNCOMMON, RARE, EPIC, LEGENDARY]

    EquipmentMatrix:
      type: object
      required:
        - id
        - brand_id
        - item_type
        - rarity
        - stat_pools
        - created_at
        - updated_at
        - version
      properties:
        id:
          type: string
          format: uuid
        brand_id:
          type: string
          format: uuid
        item_type:
          $ref: "#/components/schemas/EquipmentItemType"
        rarity:
          $ref: "#/components/schemas/EquipmentRarity"
        stat_pools:
          type: array
          items:
            $ref: "#/components/schemas/StatPool"
        modifiers:
          type: array
          items:
            $ref: "#/components/schemas/Modifier"
        brand_bonuses:
          type: object
          additionalProperties: true
        version:
          type: integer

    StatPool:
      type: object
      required:
        - id
        - name
        - stat_type
        - min_value
        - max_value
        - distribution
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        stat_type:
          $ref: "#/components/schemas/StatType"
        min_value:
          type: number
          format: float
        max_value:
          type: number
          format: float
        distribution:
          $ref: "#/components/schemas/StatDistribution"
        rarity_modifiers:
          type: object
          additionalProperties: true

    StatType:
      type: string
      enum:
        [
          DAMAGE,
          ACCURACY,
          RANGE,
          FIRE_RATE,
          RELOAD_SPEED,
          MAGAZINE_SIZE,
          CRIT_CHANCE,
          CRIT_DAMAGE,
          STABILITY,
          HANDLING,
          DURABILITY,
          ENERGY_COST,
          COOLDOWN,
          EFFECT_DURATION,
        ]

    StatDistribution:
      type: string
      enum: [UNIFORM, NORMAL, EXPONENTIAL]

    Modifier:
      type: object
      required:
        - id
        - name
        - modifier_type
        - value
        - rarity
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        modifier_type:
          $ref: "#/components/schemas/ModifierType"
        value:
          type: number
          format: float
        rarity:
          $ref: "#/components/schemas/EquipmentRarity"
        compatibility:
          type: array
          items:
            type: string
        restrictions:
          type: object
          additionalProperties: true

    ModifierType:
      type: string
      enum:
        [
          DAMAGE_BOOST,
          CRIT_CHANCE,
          ELEMENTAL_DAMAGE,
          STATUS_EFFECT,
          STAT_BOOST,
          REDUCTION,
          MULTIPLIER,
        ]

    Brand:
      type: object
      required:
        - id
        - name
        - description
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        identity:
          type: string
        bonuses:
          type: object
          additionalProperties: true
        faction_exclusives:
          type: array
          items:
            type: string
            format: uuid

    BrandsListResponse:
      type: object
      required:
        - brands
      properties:
        brands:
          type: array
          items:
            $ref: "#/components/schemas/Brand"

    Rarity:
      type: object
      required:
        - name
        - level
      properties:
        name:
          $ref: "#/components/schemas/EquipmentRarity"
        level:
          type: integer
          minimum: 0
        drop_chance:
          type: number
          format: float
        color:
          type: string

    RaritiesListResponse:
      type: object
      required:
        - rarities
      properties:
        rarities:
          type: array
          items:
            $ref: "#/components/schemas/Rarity"

    StatPoolsListResponse:
      type: object
      required:
        - stat_pools
      properties:
        stat_pools:
          type: array
          items:
            $ref: "#/components/schemas/StatPool"

    ValidateBalanceRequest:
      type: object
      required:
        - item_id
      properties:
        item_id:
          type: string
          format: uuid
        league:
          type: string
          nullable: true
        game_mode:
          type: string
          enum: [PVE, PVP, EXTRACT]
          nullable: true

    BalanceValidationResult:
      type: object
      required:
        - valid
        - item_id
      properties:
        valid:
          type: boolean
        item_id:
          type: string
          format: uuid
        issues:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              message:
                type: string
              severity:
                type: string
                enum: [LOW, MEDIUM, HIGH, CRITICAL]
        ttk_estimate:
          type: number
          format: float
          nullable: true
        cyberpsychosis_risk:
          type: number
          format: float
          nullable: true
        temperature_restrictions:
          type: object
          additionalProperties: true
          nullable: true

    CatalogItem:
      type: object
      required:
        - id
        - name
        - category
        - rarity
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        category:
          type: string
        brand_id:
          type: string
          format: uuid
        brand_name:
          type: string
        rarity:
          $ref: "#/components/schemas/EquipmentRarity"
        stats:
          type: object
          additionalProperties: true
        icon_url:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time

    IconicItem:
      type: object
      required:
        - id
        - name
        - year
        - unlocked
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        year:
          type: integer
          minimum: 2020
          maximum: 2093
        category:
          type: string
        brand_id:
          type: string
          format: uuid
        brand_name:
          type: string
        rarity:
          type: string
          enum: [ICONIC]
        stats:
          type: object
          additionalProperties: true
        unique_ability:
          type: string
        unlock_condition:
          type: string
        unlocked:
          type: boolean
        icon_url:
          type: string
          format: uri
        timeline_position:
          type: integer
        created_at:
          type: string
          format: date-time

    EquipmentAnalytics:
      type: object
      required:
        - period
        - total_items
      properties:
        period:
          type: string
          enum: [day, week, month, year]
        total_items:
          type: integer
        items_by_category:
          type: object
          additionalProperties:
            type: integer
        items_by_rarity:
          type: object
          additionalProperties:
            type: integer
        most_popular_brands:
          type: array
          items:
            type: object
            properties:
              brand_id:
                type: string
                format: uuid
              brand_name:
                type: string
              count:
                type: integer
        generation_stats:
          type: object
          properties:
            total_generated:
              type: integer
            by_source:
              type: object
              additionalProperties:
                type: integer
        iconic_unlocks:
          type: integer

security:
  - BearerAuth: []
