openapi: 3.0.3
info:
  title: Economy Player Market Listings Service API
  description: |
    API для управления объявлениями на P2P торговой площадке NECPGAME.
    
    **Основные возможности:**
    - Создание объявлений (listings)
    - Поиск и фильтрация
    - Просмотр деталей
    - Удаление объявлений
    - Покупка предметов
    
    **Ограничения:**
    - До 20 активных объявлений на игрока
    - Срок жизни: 7 дней
    - Диапазон цен: 1 - 999,999,999 ED
    - Комиссия: 1%
    - Пагинация: до 50 позиций
    
    **Фокус:**
    - Мгновенная купля-продажа по фиксированной цене
    - Быстрый доступ к предложениям
    - Прямая коммуникация
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necpgame.com

servers:
  - url: http://localhost:8084
    description: Economy Service (локальная разработка)
  - url: https://economy.necpgame.com
    description: Economy Service (продакшн)

tags:
  - name: Listings
    description: Объявления
  - name: Purchase
    description: Покупка

paths:
  /api/v1/market/listings:
    get:
      tags:
        - Listings
      summary: Поиск объявлений
      description: |
        Поиск и фильтрация объявлений на рынке.
        
        **Фильтры:**
        - Текстовый поиск, тип предмета, качество
        - Диапазон цен, уровень, продавец, регион
        
        **Сортировка:**
        - По цене, дате, популярности, рейтингу продавца
      operationId: searchListings
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: item_type
          in: query
          schema:
            type: string
        - name: quality
          in: query
          schema:
            type: string
            enum: [common, uncommon, rare, epic, legendary, artifact]
        - name: min_price
          in: query
          schema:
            type: number
        - name: max_price
          in: query
          schema:
            type: number
        - name: seller_id
          in: query
          schema:
            type: string
            format: uuid
        - name: region
          in: query
          schema:
            type: string
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [price, date, popularity, seller_rating]
        - $ref: "common.yaml#/components/parameters/Page"
        - $ref: "common.yaml#/components/parameters/PageSize"
      responses:
        "200":
          description: Список объявлений
          content:
            application/json:
              schema:
                type: object
                properties:
                  listings:
                    type: array
                    items:
                      $ref: "#/components/schemas/Listing"
                  pagination:
                    $ref: "common.yaml#/components/schemas/Pagination"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

    post:
      tags:
        - Listings
      summary: Создать объявление
      description: |
        Создаёт новое объявление о продаже.
        
        **Проверки:**
        - Наличие предмета, лимит объявлений (20)
        - Диапазон цены, количество
      operationId: createListing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateListingRequest"
      responses:
        "201":
          description: Объявление создано
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListingCreated"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/market/listings/{listing_id}:
    get:
      tags:
        - Listings
      summary: Детали объявления
      description: Возвращает детальную информацию об объявлении
      operationId: getListing
      parameters:
        - name: listing_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Детали объявления
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListingDetailed"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

    delete:
      tags:
        - Listings
      summary: Удалить объявление
      description: Отменяет активное объявление
      operationId: deleteListing
      parameters:
        - name: listing_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Объявление удалено
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/market/listings/{listing_id}/buy:
    post:
      tags:
        - Purchase
      summary: Купить предмет
      description: |
        Покупает предмет из объявления.
        
        **Атомарная транзакция:**
        - Списание средств, удержание комиссии
        - Перенос предмета, фиксация в истории
        - Уведомления
      operationId: buyListing
      parameters:
        - name: listing_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BuyRequest"
      responses:
        "200":
          description: Покупка выполнена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BuyResult"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/market/my-listings:
    get:
      tags:
        - Listings
      summary: Мои объявления
      description: Возвращает список объявлений игрока
      operationId: getMyListings
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, sold, expired, cancelled]
      responses:
        "200":
          description: Мои объявления
          content:
            application/json:
              schema:
                type: object
                properties:
                  listings:
                    type: array
                    items:
                      $ref: "#/components/schemas/Listing"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      $ref: "common.yaml#/components/securitySchemes/BearerAuth"

  schemas:
    Listing:
      type: object
      properties:
        id:
          type: string
          format: uuid
        seller_id:
          type: string
          format: uuid
        seller_name:
          type: string
        item_id:
          type: string
          format: uuid
        item_name:
          type: string
        item_type:
          type: string
        quality:
          type: string
        quantity:
          type: integer
        price:
          type: number
        total_price:
          type: number
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    ListingDetailed:
      allOf:
        - $ref: "#/components/schemas/Listing"
        - type: object
          properties:
            item_details:
              type: object
              description: Детали предмета
            seller_rating:
              type: number
              description: Рейтинг продавца
            seller_trades:
              type: integer
              description: Количество сделок

    CreateListingRequest:
      type: object
      required:
        - item_id
        - quantity
        - price
      properties:
        item_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        price:
          type: number
          minimum: 1
          maximum: 999999999

    ListingCreated:
      type: object
      properties:
        listing_id:
          type: string
          format: uuid
        expires_at:
          type: string
          format: date-time

    BuyRequest:
      type: object
      required:
        - quantity
      properties:
        quantity:
          type: integer
          minimum: 1

    BuyResult:
      type: object
      properties:
        trade_id:
          type: string
          format: uuid
        amount_paid:
          type: number
        commission:
          type: number



