openapi: 3.0.3
info:
  title: Feedback Service API
  description: |
    API для системы обратной связи от игроков: создание обращений, голосование, доска идей,
    модерация и интеграция с GitHub Issues.
    
    Система позволяет игрокам:
    - Отправлять предложения, идеи и пожелания прямо из игры
    - Видеть статус своих предложений
    - Получать уведомления о рассмотрении предложений
    - Автоматически создавать GitHub Issues для обработки предложений агентами
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8090/api/v1/feedback
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1/feedback
    description: Продакшен сервер

tags:
  - name: Feedback
    description: Управление обращениями от игроков
  - name: Voting
    description: Голосование за предложения
  - name: Board
    description: Доска идей (публичные предложения)
  - name: Stats
    description: Статистика обращений

paths:
  /submit:
    post:
      tags:
        - Feedback
      summary: Создание нового обращения
      operationId: submitFeedback
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitFeedbackRequest'
            example:
              type: feature_request
              category: gameplay
              title: Добавить новую систему крафта
              description: Предлагаю добавить систему крафта оружия с модификациями
              priority: medium
              game_context:
                version: 1.0.0
                location: watson
                character_level: 25
                active_quests: ["quest-001", "quest-002"]
                playtime_hours: 150
              screenshots:
                - https://cdn.necp.game/screenshots/001.jpg
      responses:
        '201':
          description: Обращение успешно создано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitFeedbackResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /{id}:
    get:
      tags:
        - Feedback
      summary: Получение обращения по ID
      operationId: getFeedback
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID обращения
      responses:
        '200':
          description: Информация об обращении
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feedback'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /player/{player_id}:
    get:
      tags:
        - Feedback
      summary: История обращений игрока
      operationId: getPlayerFeedback
      security:
        - BearerAuth: []
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID игрока
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, in_review, approved, rejected, merged, closed]
          description: Фильтр по статусу
        - name: type
          in: query
          schema:
            type: string
            enum: [feature_request, bug_report, wishlist, feedback]
          description: Фильтр по типу
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Количество записей на странице
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Смещение для пагинации
      responses:
        '200':
          description: Список обращений игрока
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /{id}/update-status:
    post:
      tags:
        - Feedback
      summary: Обновление статуса обращения
      operationId: updateFeedbackStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID обращения
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusRequest'
            example:
              status: in_review
              github_issue_number: 1234
              github_issue_url: https://github.com/gc-lover/necpgame-monorepo/issues/1234
      responses:
        '200':
          description: Статус успешно обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feedback'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /board:
    get:
      tags:
        - Board
      summary: Доска идей (публичные предложения)
      operationId: getFeedbackBoard
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [gameplay, balance, content, technical, lore, ui_ux, other]
          description: Фильтр по категории
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, in_review, approved]
          description: Фильтр по статусу
        - name: sort
          in: query
          schema:
            type: string
            enum: [votes_desc, votes_asc, created_desc, created_asc]
            default: votes_desc
          description: Сортировка
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Количество записей на странице
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Смещение для пагинации
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по заголовку и описанию
      responses:
        '200':
          description: Список публичных предложений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackBoardList'

  /{id}/vote:
    post:
      tags:
        - Voting
      summary: Голосование за предложение
      operationId: voteFeedback
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID обращения
      responses:
        '200':
          description: Голос успешно добавлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    delete:
      tags:
        - Voting
      summary: Отзыв голоса
      operationId: unvoteFeedback
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID обращения
      responses:
        '200':
          description: Голос успешно отозван
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /stats:
    get:
      tags:
        - Stats
      summary: Статистика обращений
      operationId: getFeedbackStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Статистика обращений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackStats'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    SubmitFeedbackRequest:
      type: object
      required: [type, category, title, description]
      properties:
        type:
          type: string
          enum: [feature_request, bug_report, wishlist, feedback]
        category:
          type: string
          enum: [gameplay, balance, content, technical, lore, ui_ux, other]
        title:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 2000
        priority:
          type: string
          enum: [low, medium, high, critical]
        game_context:
          $ref: '#/components/schemas/GameContext'
        screenshots:
          type: array
          maxItems: 3
          items:
            type: string
            format: uri
    SubmitFeedbackResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, in_review, approved, rejected, merged, closed]
        github_issue_number:
          type: integer
          nullable: true
        github_issue_url:
          type: string
          format: uri
          nullable: true
        created_at:
          type: string
          format: date-time
    Feedback:
      type: object
      properties:
        id:
          type: string
          format: uuid
        player_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [feature_request, bug_report, wishlist, feedback]
        category:
          type: string
          enum: [gameplay, balance, content, technical, lore, ui_ux, other]
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [low, medium, high, critical]
          nullable: true
        game_context:
          $ref: '#/components/schemas/GameContext'
        screenshots:
          type: array
          items:
            type: string
            format: uri
        github_issue_number:
          type: integer
          nullable: true
        github_issue_url:
          type: string
          format: uri
          nullable: true
        status:
          type: string
          enum: [pending, in_review, approved, rejected, merged, closed]
        votes_count:
          type: integer
          minimum: 0
        merged_into:
          type: string
          format: uuid
          nullable: true
        moderation_status:
          type: string
          enum: [pending, approved, rejected]
          nullable: true
        moderation_reason:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    GameContext:
      type: object
      properties:
        version:
          type: string
        location:
          type: string
        character_level:
          type: integer
          minimum: 1
        active_quests:
          type: array
          items:
            type: string
        playtime_hours:
          type: number
          minimum: 0
    FeedbackList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Feedback'
        total:
          type: integer
          minimum: 0
        limit:
          type: integer
        offset:
          type: integer
    UpdateStatusRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [pending, in_review, approved, rejected, merged, closed]
        github_issue_number:
          type: integer
          nullable: true
        github_issue_url:
          type: string
          format: uri
          nullable: true
    FeedbackBoardList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/FeedbackBoardItem'
        total:
          type: integer
          minimum: 0
        limit:
          type: integer
        offset:
          type: integer
    FeedbackBoardItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [feature_request, bug_report, wishlist, feedback]
        category:
          type: string
          enum: [gameplay, balance, content, technical, lore, ui_ux, other]
        title:
          type: string
        description:
          type: string
        votes_count:
          type: integer
          minimum: 0
        status:
          type: string
          enum: [pending, in_review, approved]
        github_issue_number:
          type: integer
          nullable: true
        github_issue_url:
          type: string
          format: uri
          nullable: true
        created_at:
          type: string
          format: date-time
    VoteResponse:
      type: object
      properties:
        feedback_id:
          type: string
          format: uuid
        votes_count:
          type: integer
          minimum: 0
        has_voted:
          type: boolean
    FeedbackStats:
      type: object
      properties:
        total:
          type: integer
          minimum: 0
        by_status:
          type: object
          properties:
            pending:
              type: integer
              minimum: 0
            in_review:
              type: integer
              minimum: 0
            approved:
              type: integer
              minimum: 0
            rejected:
              type: integer
              minimum: 0
            merged:
              type: integer
              minimum: 0
            closed:
              type: integer
              minimum: 0
        by_type:
          type: object
          properties:
            feature_request:
              type: integer
              minimum: 0
            bug_report:
              type: integer
              minimum: 0
            wishlist:
              type: integer
              minimum: 0
            feedback:
              type: integer
              minimum: 0
        by_category:
          type: object
          properties:
            gameplay:
              type: integer
              minimum: 0
            balance:
              type: integer
              minimum: 0
            content:
              type: integer
              minimum: 0
            technical:
              type: integer
              minimum: 0
            lore:
              type: integer
              minimum: 0
            ui_ux:
              type: integer
              minimum: 0
            other:
              type: integer
              minimum: 0
        total_votes:
          type: integer
          minimum: 0
        average_votes_per_feedback:
          type: number
          minimum: 0
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
            schema:
              $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
            schema:
              $ref: '#/components/schemas/Error'

    Forbidden:
      description: Доступ запрещен
      content:
        application/json:
            schema:
              $ref: '#/components/schemas/Error'

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
            schema:
              $ref: '#/components/schemas/Error'

    TooManyRequests:
      description: Превышен лимит запросов
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
      headers:
        Retry-After:
          schema:
            type: integer
          description: Количество секунд до следующего запроса

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

