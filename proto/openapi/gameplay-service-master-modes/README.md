# NECP Game - Gameplay Service Master Modes API

## Обзор

Этот OpenAPI документ определяет API для системы **мастер-режимов и Challenge modes** в NECP Game. Система предоставляет фиксированные уровни повышенной сложности для опытных игроков, с уникальными ограничениями и наградами.

## Архитектурные принципы

### MMOFPS-оптимизации
- **Struct alignment**: оптимизация памяти для снижения GC pressure
- **Connection pooling**: эффективное управление соединениями с БД и Redis
- **Context timeouts**: защита от зависших операций
- **Async processing**: неблокирующая обработка для высокой производительности

### Безопасность и производительность
- **Server-side validation**: валидация всех данных на сервере
- **Anti-cheat protection**: защита от читерства и эксплойтов
- **Rate limiting**: защита от DDoS и abuse
- **Memory pooling**: повторное использование объектов для снижения аллокаций

## Режимы сложности

### Master Mode
- **HP Modifier**: +100% (враги имеют 2x здоровья)
- **Damage Modifier**: +50% (враги наносят 1.5x урона)
- **Ограничения**: стандартное время, 3 респавна, 2 чекпоинта
- **Награды**: 2x очки опыта и валюты

### Grandmaster Mode
- **HP Modifier**: +200% (враги имеют 3x здоровья)
- **Damage Modifier**: +100% (враги наносят 2x урона)
- **Ограничения**: -25% времени, 1 респавн, 1 чекпоинт
- **Награды**: 3x очки опыта и валюты

### Legendary Mode
- **HP Modifier**: +300% (враги имеют 4x здоровья)
- **Damage Modifier**: +150% (враги наносят 2.5x урона)
- **Ограничения**: -50% времени, 0 респавнов (permadeath), 0 чекпоинтов
- **Награды**: 5x очки опыта и валюты, уникальные предметы

## Компоненты системы

### Difficulty Mode Manager
Управляет режимами сложности, проверяет требования доступа, применяет модификаторы.

### Restriction Controller
Отслеживает ограничения в реальном времени:
- Лимиты времени
- Количество респавнов
- Использование чекпоинтов

### Difficulty Modifier Engine
Применяет модификаторы к игровым объектам:
- Увеличение здоровья врагов
- Увеличение урона врагов
- Специальные механики (time dilation, enhanced AI)

### Achievement Tracker
Отслеживает достижения в мастер-режимах:
- Первое завершение режима
- Скоростные рекорды
- Комбо-серии

### Reward Calculator
Рассчитывает награды на основе:
- Уровня сложности
- Времени завершения
- Качества выполнения

## API Endpoints

### Public Endpoints
- `GET /gameplay/difficulty-modes` - список всех режимов
- `GET /gameplay/difficulty-modes/{modeId}` - детали режима
- `GET /gameplay/content/{contentId}/difficulty-modes` - режимы для контента
- `POST /gameplay/instances/{instanceId}/difficulty` - выбор режима для сессии
- `GET /gameplay/difficulty-modes/stats` - статистика по режимам

### Admin Endpoints
- `POST /admin/gameplay/difficulty-modes` - создание режима
- `PUT /admin/gameplay/difficulty-modes` - обновление режима

## Интеграции

### Progression Service
- Проверка требований для доступа к режимам
- Начисление опыта и валюты
- Обновление прогресса игрока

### Achievement Service
- Выдача достижений и титулов
- Уведомления о новых рекордах
- Специальные награды

### Leaderboard Service
- Глобальные рейтинги по режимам
- Сезонные таблицы лидеров
- Рекорды по времени и счету

### Combat Service
- Применение модификаторов к врагам
- Отслеживание урона и здоровья
- Специальные эффекты режимов

## База данных

### Основные таблицы

#### difficulty_modes
Хранит конфигурацию режимов сложности.

#### content_difficulty_modes
Связывает контент с доступными режимами.

#### instance_difficulty_sessions
Отслеживает активные сессии с режимами.

#### difficulty_telemetry
Собирает статистику и аналитику по режимам.

## Мониторинг и аналитика

### Метрики производительности
- Количество активных сессий в мастер-режимах
- Среднее время завершения
- Процент успешных завершений
- Нагрузка на сервер во время пиковых нагрузок

### Аналитика игроков
- Популярность режимов
- Успеваемость по уровням сложности
- Поведение игроков в экстремальных условиях

## Безопасность

### Валидация
- Server-side проверка всех параметров
- Защита от SQL-инъекций
- Валидация UUID и enum значений

### Anti-cheat
- Проверка консистентности данных
- Обнаружение аномального поведения
- Защита от эксплойтов ограничений

### Аудит
- Полное логирование всех операций
- Трассировка изменений в режимах
- Аудит доступа к административным функциям

## Производительность

### Оптимизации
- Кеширование часто используемых данных в Redis
- Асинхронная обработка телеметрии
- Memory pooling для часто создаваемых объектов
- Lazy loading для больших наборов данных

### Масштабируемость
- Поддержка 1000+ одновременных игроков в мастер-режимах
- Горизонтальное масштабирование сервисов
- Оптимизированные запросы к БД
- Эффективное использование сетевых ресурсов

## Разработка и развертывание

### Code Generation
API генерируется с помощью `ogen` из этой OpenAPI спецификации.

### Тестирование
- Unit тесты для всех компонентов
- Integration тесты для API endpoints
- Performance тесты для высокой нагрузки
- Chaos testing для отказоустойчивости

### Мониторинг
- Prometheus метрики
- Jaeger трейсинг
- ELK стек для логов
- Grafana dashboards

## Связанные документы

- `knowledge/idea/master-modes-challenge-system.yaml` - концепция системы
- `knowledge/implementation/architecture/master-challenge-modes-system-architecture.yaml` - архитектура
- `services/gameplay-service-go/` - реализация сервиса
