openapi: 3.0.3
info:
  title: Gameplay Service API
  description: API для игрового процесса: прогрессия персонажей, квесты, диалоги, боевые сессии, Narrative Coherence, World State
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8083/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер

tags:
  - name: Progression
    description: Система прогрессии персонажей
  - name: Quests
    description: Система квестов и заданий
  - name: Combat
    description: Боевые сессии
  - name: Narrative
    description: Система Narrative Coherence для целостности сюжета
  - name: WorldState
    description: Управление состоянием мира

paths:
  /gameplay/progression/{characterId}:
    get:
      tags:
        - Progression
      summary: Получить информацию о прогрессе персонажа
      operationId: getCharacterProgression
      parameters:
        - name: characterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Информация о прогрессе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterProgression'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/progression/{characterId}/experience:
    post:
      tags:
        - Progression
      summary: Начислить опыт персонажу
      operationId: addExperience
      parameters:
        - name: characterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddExperienceRequest'
      responses:
        '200':
          description: Опыт начислен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterProgression'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/progression/{characterId}/attributes:
    post:
      tags:
        - Progression
      summary: Распределить очки атрибутов
      operationId: distributeAttributePoints
      parameters:
        - name: characterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DistributeAttributePointsRequest'
      responses:
        '200':
          description: Очки распределены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterProgression'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/progression/{characterId}/skills:
    post:
      tags:
        - Progression
      summary: Распределить очки навыков
      operationId: distributeSkillPoints
      parameters:
        - name: characterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DistributeSkillPointsRequest'
      responses:
        '200':
          description: Очки распределены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterProgression'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests:
    get:
      tags:
        - Quests
      summary: Получить список доступных квестов
      operationId: getAvailableQuests
      parameters:
        - name: characterId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список доступных квестов
          content:
            application/json:
              schema:
                type: object
                properties:
                  quests:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quest'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests/{questId}/start:
    post:
      tags:
        - Quests
      summary: Начать выполнение квеста
      operationId: startQuest
      parameters:
        - name: questId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartQuestRequest'
      responses:
        '200':
          description: Квест начат
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestInstance'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests/instances/{instanceId}:
    get:
      tags:
        - Quests
      summary: Получить информацию о квесте
      operationId: getQuestInstance
      parameters:
        - name: instanceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Информация о квесте
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestInstance'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests/instances/{instanceId}/dialogue:
    post:
      tags:
        - Quests
      summary: Выбрать вариант диалога
      operationId: selectDialogueOption
      parameters:
        - name: instanceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DialogueOptionRequest'
      responses:
        '200':
          description: Вариант диалога выбран
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestInstance'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests/instances/{instanceId}/skill-check:
    post:
      tags:
        - Quests
      summary: Выполнить проверку навыка
      operationId: performSkillCheck
      parameters:
        - name: instanceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SkillCheckRequest'
      responses:
        '200':
          description: Проверка навыка выполнена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkillCheckResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quests/instances/{instanceId}/complete:
    post:
      tags:
        - Quests
      summary: Завершить квест
      operationId: completeQuest
      parameters:
        - name: instanceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Квест завершен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestCompletionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions:
    post:
      tags:
        - Combat
      summary: Создать боевую сессию
      operationId: createCombatSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCombatSessionRequest'
      responses:
        '201':
          description: Боевая сессия создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}:
    get:
      tags:
        - Combat
      summary: Получить состояние боевой сессии
      operationId: getCombatState
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Состояние боевой сессии
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Combat
      summary: Обновить боевую сессию
      operationId: updateCombatSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCombatSessionRequest'
      responses:
        '200':
          description: Сессия обновлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Combat
      summary: Отменить боевую сессию
      operationId: cancelCombatSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Сессия отменена
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: cancelled
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/join:
    put:
      tags:
        - Combat
      summary: Присоединиться к боевой сессии
      operationId: joinCombatSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinCombatSessionRequest'
      responses:
        '200':
          description: Присоединение успешно
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/leave:
    put:
      tags:
        - Combat
      summary: Покинуть боевую сессию
      operationId: leaveCombatSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveCombatSessionRequest'
      responses:
        '200':
          description: Выход успешен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/start:
    post:
      tags:
        - Combat
      summary: Запустить боевую сессию
      operationId: startCombatSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Бой запущен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/attack:
    post:
      tags:
        - Combat
      summary: Выполнить атаку
      operationId: processAttack
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttackRequest'
      responses:
        '200':
          description: Атака обработана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttackResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/ability:
    post:
      tags:
        - Combat
      summary: Использовать способность в бою
      operationId: useCombatAbility
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UseAbilityRequest'
      responses:
        '200':
          description: Способность использована
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatActionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/defend:
    post:
      tags:
        - Combat
      summary: Защититься в бою
      operationId: defendInCombat
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DefendRequest'
      responses:
        '200':
          description: Защита активирована
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatActionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/item:
    post:
      tags:
        - Combat
      summary: Использовать предмет в бою
      operationId: useCombatItem
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UseItemRequest'
      responses:
        '200':
          description: Предмет использован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatActionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/turn-order:
    get:
      tags:
        - Combat
      summary: Получить порядок ходов
      operationId: getTurnOrder
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Порядок ходов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TurnOrder'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/current-turn:
    get:
      tags:
        - Combat
      summary: Получить текущий ход
      operationId: getCurrentTurn
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Текущий ход
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentTurn'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/next-turn:
    post:
      tags:
        - Combat
      summary: Перейти к следующему ходу
      operationId: nextTurn
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Следующий ход
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentTurn'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/skip-turn:
    post:
      tags:
        - Combat
      summary: Пропустить ход
      operationId: skipTurn
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SkipTurnRequest'
      responses:
        '200':
          description: Ход пропущен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentTurn'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/calculate-damage:
    post:
      tags:
        - Combat
      summary: Рассчитать урон
      operationId: calculateDamage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateDamageRequest'
      responses:
        '200':
          description: Урон рассчитан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DamageCalculationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/apply-effects:
    post:
      tags:
        - Combat
      summary: Применить эффекты
      operationId: applyEffects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplyEffectsRequest'
      responses:
        '200':
          description: Эффекты применены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EffectsResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/combat/sessions/{sessionId}/end:
    post:
      tags:
        - Combat
      summary: Завершить боевую сессию
      operationId: endCombat
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Боевая сессия завершена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/quest-graph:
    get:
      tags:
        - Narrative
      summary: Получить граф квестов
      operationId: getQuestGraph
      parameters:
        - name: account_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Граф квестов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestGraph'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/quest-graph/{quest_id}/dependencies:
    get:
      tags:
        - Narrative
      summary: Получить зависимости квеста
      operationId: getQuestDependencies
      parameters:
        - name: quest_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Зависимости квеста
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestDependencies'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/quest-graph/validate:
    post:
      tags:
        - Narrative
      summary: Валидировать граф квестов
      operationId: validateQuestGraph
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateQuestGraphRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/timeline/check:
    get:
      tags:
        - Narrative
      summary: Проверить временную линию
      operationId: checkTimeline
      parameters:
        - name: quest_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: npc_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: faction_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Результат проверки временной линии
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineCheckResult'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/timeline/validate:
    post:
      tags:
        - Narrative
      summary: Валидировать временную линию
      operationId: validateTimeline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTimelineRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/coherence/check:
    get:
      tags:
        - Narrative
      summary: Проверить консистентность
      operationId: checkCoherence
      parameters:
        - name: account_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Результат проверки консистентности
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoherenceCheckResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/narrative/coherence/resolve:
    post:
      tags:
        - Narrative
      summary: Разрешить конфликты консистентности
      operationId: resolveCoherenceConflicts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveCoherenceRequest'
      responses:
        '200':
          description: Конфликты разрешены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoherenceResolveResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/personal/{account_id}:
    get:
      tags:
        - WorldState
      summary: Получить личное состояние мира
      operationId: getPersonalWorldState
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Личное состояние мира
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/server:
    get:
      tags:
        - WorldState
      summary: Получить серверное состояние мира
      operationId: getServerWorldState
      responses:
        '200':
          description: Серверное состояние мира
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/faction/{faction_id}:
    get:
      tags:
        - WorldState
      summary: Получить фракционное состояние мира
      operationId: getFactionWorldState
      parameters:
        - name: faction_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Фракционное состояние мира
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/personal/{account_id}/update:
    post:
      tags:
        - WorldState
      summary: Обновить личное состояние мира
      operationId: updatePersonalWorldState
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorldStateRequest'
      responses:
        '200':
          description: Состояние обновлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/server/update:
    post:
      tags:
        - WorldState
      summary: Обновить серверное состояние мира
      operationId: updateServerWorldState
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorldStateRequest'
      responses:
        '200':
          description: Состояние обновлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/faction/{faction_id}/update:
    post:
      tags:
        - WorldState
      summary: Обновить фракционное состояние мира
      operationId: updateFactionWorldState
      parameters:
        - name: faction_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorldStateRequest'
      responses:
        '200':
          description: Состояние обновлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/world-state/resolve-conflict:
    post:
      tags:
        - WorldState
      summary: Разрешить конфликт состояний мира
      operationId: resolveWorldStateConflict
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveConflictRequest'
      responses:
        '200':
          description: Конфликт разрешен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorldState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quest-graph/available/{account_id}:
    get:
      tags:
        - Narrative
      summary: Получить доступные квесты
      operationId: getAvailableQuests
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список доступных квестов
          content:
            application/json:
              schema:
                type: object
                properties:
                  quests:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quest-graph/{quest_id}/prerequisites:
    get:
      tags:
        - Narrative
      summary: Получить предпосылки квеста
      operationId: getQuestPrerequisites
      parameters:
        - name: quest_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Предпосылки квеста
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestPrerequisites'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quest-graph/{quest_id}/unlocks:
    get:
      tags:
        - Narrative
      summary: Получить квесты, которые открывает данный квест
      operationId: getQuestUnlocks
      parameters:
        - name: quest_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Квесты, которые открывает данный квест
          content:
            application/json:
              schema:
                type: object
                properties:
                  unlocked_quests:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quest-graph/{quest_id}/check-availability:
    post:
      tags:
        - Narrative
      summary: Проверить доступность квеста
      operationId: checkQuestAvailability
      parameters:
        - name: quest_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckQuestAvailabilityRequest'
      responses:
        '200':
          description: Результат проверки доступности
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestAvailabilityResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/quest-graph/calculate-probabilities:
    post:
      tags:
        - Narrative
      summary: Рассчитать вероятности квестов
      operationId: calculateQuestProbabilities
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateProbabilitiesRequest'
      responses:
        '200':
          description: Вероятности квестов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestProbabilities'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/timeline/validate-quest/{quest_id}:
    post:
      tags:
        - Narrative
      summary: Валидировать временную линию квеста
      operationId: validateQuestTimeline
      parameters:
        - name: quest_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTimelineRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/timeline/validate-npc/{npc_id}:
    post:
      tags:
        - Narrative
      summary: Валидировать временную линию NPC
      operationId: validateNpcTimeline
      parameters:
        - name: npc_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTimelineRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/timeline/validate-faction/{faction_id}:
    post:
      tags:
        - Narrative
      summary: Валидировать временную линию фракции
      operationId: validateFactionTimeline
      parameters:
        - name: faction_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTimelineRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/timeline/validate-location/{location_id}:
    post:
      tags:
        - Narrative
      summary: Валидировать временную линию локации
      operationId: validateLocationTimeline
      parameters:
        - name: location_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTimelineRequest'
      responses:
        '200':
          description: Результат валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /gameplay/timeline/conflicts:
    get:
      tags:
        - Narrative
      summary: Получить список временных конфликтов
      operationId: getTimelineConflicts
      parameters:
        - name: quest_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: npc_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: faction_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список конфликтов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineConflicts'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    CharacterProgression:
      type: object
      properties:
        character_id:
          type: string
          format: uuid
        level:
          type: integer
          minimum: 1
        experience:
          type: integer
          minimum: 0
        experience_to_next_level:
          type: integer
          minimum: 0
        available_attribute_points:
          type: integer
          minimum: 0
        available_skill_points:
          type: integer
          minimum: 0
        attributes:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
        skills:
          type: array
          items:
            $ref: '#/components/schemas/SkillProgress'

    SkillProgress:
      type: object
      properties:
        skill_id:
          type: string
        skill_name:
          type: string
        level:
          type: integer
          minimum: 0
        experience:
          type: integer
          minimum: 0

    AddExperienceRequest:
      type: object
      required:
        - amount
        - source
      properties:
        amount:
          type: integer
          minimum: 1
          description: Количество опыта
        source:
          type: string
          enum:
            - combat
            - quest
            - skill_use
            - exploration
          description: Источник опыта

    DistributeAttributePointsRequest:
      type: object
      required:
        - attribute
        - points
      properties:
        attribute:
          type: string
          description: Название атрибута
        points:
          type: integer
          minimum: 1
          description: Количество очков

    DistributeSkillPointsRequest:
      type: object
      required:
        - skill_id
        - points
      properties:
        skill_id:
          type: string
          description: ID навыка
        points:
          type: integer
          minimum: 1
          description: Количество очков

    Quest:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        quest_type:
          type: string
          enum:
            - main
            - side
            - faction
            - world
        requirements:
          type: object
          properties:
            level:
              type: integer
              minimum: 1
            completed_quests:
              type: array
              items:
                type: string
                format: uuid

    QuestInstance:
      type: object
      properties:
        id:
          type: string
          format: uuid
        quest_id:
          type: string
          format: uuid
        character_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - active
            - completed
            - failed
            - abandoned
        current_node:
          type: string
        dialogue_state:
          type: object
          additionalProperties: true
        objectives:
          type: array
          items:
            $ref: '#/components/schemas/QuestObjective'
        started_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    QuestObjective:
      type: object
      properties:
        id:
          type: string
        description:
          type: string
        status:
          type: string
          enum:
            - pending
            - in_progress
            - completed
            - failed

    StartQuestRequest:
      type: object
      required:
        - character_id
      properties:
        character_id:
          type: string
          format: uuid

    DialogueOptionRequest:
      type: object
      required:
        - option_id
      properties:
        option_id:
          type: string
          description: ID выбранного варианта диалога

    SkillCheckRequest:
      type: object
      required:
        - skill_id
        - difficulty
      properties:
        skill_id:
          type: string
          description: ID навыка для проверки
        difficulty:
          type: integer
          minimum: 1
          maximum: 100
          description: Сложность проверки

    SkillCheckResult:
      type: object
      properties:
        success:
          type: boolean
        skill_level:
          type: integer
        roll:
          type: integer
        difficulty:
          type: integer
        message:
          type: string

    QuestCompletionResult:
      type: object
      properties:
        instance_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - completed
            - failed
        rewards:
          type: object
          properties:
            experience:
              type: integer
            currency:
              type: integer
            items:
              type: array
            items:
              type: object

    CreateCombatSessionRequest:
      type: object
      required:
        - participants
      properties:
        participants:
          type: array
          items:
            $ref: '#/components/schemas/CombatParticipant'
          minItems: 2
        combat_type:
          type: string
          enum:
            - pve
            - pvp
            - raid
          default: pve
        settings:
          type: object
          additionalProperties: true

    UpdateCombatSessionRequest:
      type: object
      properties:
        status:
          type: string
          enum:
            - active
            - paused
            - completed
            - cancelled
        settings:
          type: object
          additionalProperties: true

    JoinCombatSessionRequest:
      type: object
      required:
        - participant_id
      properties:
        participant_id:
          type: string
          format: uuid
        participant_type:
          type: string
          enum:
            - player
            - npc
            - enemy

    LeaveCombatSessionRequest:
      type: object
      required:
        - participant_id
      properties:
        participant_id:
          type: string
          format: uuid

    StartCombatRequest:
      type: object
      required:
        - character_id
        - participants
      properties:
        character_id:
          type: string
          format: uuid
        participants:
          type: array
          items:
            $ref: '#/components/schemas/CombatParticipant'
          minItems: 2
        combat_type:
          type: string
          enum:
            - pve
            - pvp
            - raid
          default: pve

    CombatParticipant:
      type: object
      required:
        - id
        - type
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - player
            - npc
            - enemy
        name:
          type: string

    CombatSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - active
            - completed
            - cancelled
        participants:
          type: array
          items:
            $ref: '#/components/schemas/CombatParticipantState'
        current_turn:
          type: string
          format: uuid
        turn_order:
          type: array
          items:
            type: string
            format: uuid
        round:
          type: integer
          minimum: 1
        started_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CombatParticipantState:
      type: object
      properties:
        participant_id:
          type: string
          format: uuid
        health:
          type: integer
          minimum: 0
        max_health:
          type: integer
          minimum: 1
        status_effects:
          type: array
          items:
            type: object

    AttackRequest:
      type: object
      required:
        - attacker_id
        - target_id
        - attack_type
      properties:
        attacker_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        attack_type:
          type: string
          enum:
            - melee
            - ranged
            - ability
        ability_id:
          type: string
          nullable: true

    AttackResult:
      type: object
      properties:
        damage:
          type: integer
          minimum: 0
        critical:
          type: boolean
        status_effects_applied:
          type: array
          items:
            type: object
        target_health_after:
          type: integer
        turn_ended:
          type: boolean
        next_turn:
          type: string
          format: uuid
          nullable: true

    CombatResult:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        winner:
          type: string
          format: uuid
          nullable: true
        rewards:
          type: object
          properties:
            experience:
              type: integer
            currency:
              type: integer
            items:
              type: array
              items:
                type: object
        ended_at:
          type: string
          format: date-time

    UseAbilityRequest:
      type: object
      required:
        - attacker_id
        - ability_id
      properties:
        attacker_id:
          type: string
          format: uuid
        ability_id:
          type: string
        target_id:
          type: string
          format: uuid
          nullable: true

    DefendRequest:
      type: object
      required:
        - defender_id
      properties:
        defender_id:
          type: string
          format: uuid
        defense_type:
          type: string
          enum:
            - block
            - dodge
            - parry

    UseItemRequest:
      type: object
      required:
        - user_id
        - item_id
      properties:
        user_id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
          nullable: true

    CombatActionResult:
      type: object
      properties:
        success:
          type: boolean
        action_type:
          type: string
        damage:
          type: integer
          nullable: true
        effects_applied:
          type: array
          items:
            type: object
        turn_ended:
          type: boolean
        next_turn:
          type: string
          format: uuid
          nullable: true

    TurnOrder:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        order:
          type: array
          items:
            type: object
            properties:
              participant_id:
                type: string
                format: uuid
              initiative:
                type: integer
              position:
                type: integer

    CurrentTurn:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        current_participant_id:
          type: string
          format: uuid
        turn_number:
          type: integer
        time_remaining:
          type: integer
          description: Время до окончания хода в секундах
        phase:
          type: string
          enum:
            - preparation
            - combat
            - completion

    SkipTurnRequest:
      type: object
      required:
        - participant_id
      properties:
        participant_id:
          type: string
          format: uuid

    CalculateDamageRequest:
      type: object
      required:
        - attacker_id
        - target_id
        - attack_type
      properties:
        attacker_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        attack_type:
          type: string
          enum:
            - melee
            - ranged
            - ability
        ability_id:
          type: string
          nullable: true
        modifiers:
          type: object
          additionalProperties: true

    DamageCalculationResult:
      type: object
      properties:
        base_damage:
          type: integer
        final_damage:
          type: integer
        critical:
          type: boolean
        modifiers:
          type: object
          additionalProperties: true
        blocked:
          type: boolean
        blocked_amount:
          type: integer
          nullable: true

    ApplyEffectsRequest:
      type: object
      required:
        - target_id
        - effects
      properties:
        target_id:
          type: string
          format: uuid
        effects:
          type: array
          items:
            type: object
            properties:
              effect_type:
                type: string
              duration:
                type: integer
              value:
                type: integer
              source:
                type: string
                format: uuid

    EffectsResult:
      type: object
      properties:
        target_id:
          type: string
          format: uuid
        effects_applied:
          type: array
          items:
            type: object
        effects_removed:
          type: array
          items:
            type: object
        current_status_effects:
          type: array
          items:
            type: object

    QuestGraph:
      type: object
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/QuestGraphNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/QuestGraphEdge'

    QuestGraphNode:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - quest
            - choice
            - world_state
            - event
        data:
          type: object
          additionalProperties: true

    QuestGraphEdge:
      type: object
      properties:
        from:
          type: string
          format: uuid
        to:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - REQUIRES
            - UNLOCKS
            - BLOCKS
            - INFLUENCES
        conditions:
          type: object
          additionalProperties: true

    QuestDependencies:
      type: object
      properties:
        quest_id:
          type: string
          format: uuid
        prerequisites:
          type: array
          items:
            $ref: '#/components/schemas/Quest'
        required_by:
          type: array
          items:
            $ref: '#/components/schemas/Quest'
        blocks:
          type: array
          items:
            $ref: '#/components/schemas/Quest'
        influences:
          type: array
          items:
            $ref: '#/components/schemas/Quest'

    QuestPrerequisites:
      type: object
      properties:
        quest_id:
          type: string
          format: uuid
        prerequisites:
          type: array
          items:
            $ref: '#/components/schemas/Quest'
        world_state_requirements:
          type: object
          additionalProperties: true

    ValidateQuestGraphRequest:
      type: object
      required:
        - quest_ids
      properties:
        quest_ids:
          type: array
          items:
            type: string
            format: uuid

    ValidationResult:
      type: object
      properties:
        valid:
          type: boolean
        errors:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              message:
                type: string
              details:
                type: object
                additionalProperties: true
        warnings:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              message:
                type: string

    TimelineCheckResult:
      type: object
      properties:
        valid:
          type: boolean
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/TimelineConflict'
        timeline:
          type: object
          additionalProperties: true

    TimelineConflict:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum:
            - quest
            - npc
            - faction
            - location
        entity_id:
          type: string
          format: uuid
        conflict_type:
          type: string
        description:
          type: string
        severity:
          type: string
          enum:
            - low
            - medium
            - high
            - critical

    TimelineConflicts:
      type: object
      properties:
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/TimelineConflict'
        total:
          type: integer

    ValidateTimelineRequest:
      type: object
      properties:
        entity_id:
          type: string
          format: uuid
        entity_type:
          type: string
          enum:
            - quest
            - npc
            - faction
            - location
        timeline_data:
          type: object
          additionalProperties: true

    CoherenceCheckResult:
      type: object
      properties:
        account_id:
          type: string
          format: uuid
        coherent:
          type: boolean
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/CoherenceConflict'
        recommendations:
          type: array
          items:
            type: string

    CoherenceConflict:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
        description:
          type: string
        affected_entities:
          type: array
          items:
            type: string
            format: uuid
        resolution_options:
          type: array
          items:
            type: object

    ResolveCoherenceRequest:
      type: object
      required:
        - account_id
        - conflict_id
        - resolution
      properties:
        account_id:
          type: string
          format: uuid
        conflict_id:
          type: string
          format: uuid
        resolution:
          type: object
          additionalProperties: true

    CoherenceResolveResult:
      type: object
      properties:
        resolved:
          type: boolean
        updated_world_state:
          type: object
          additionalProperties: true
        affected_quests:
          type: array
          items:
            $ref: '#/components/schemas/Quest'

    WorldState:
      type: object
      properties:
        level:
          type: string
          enum:
            - personal
            - server
            - faction
        account_id:
          type: string
          format: uuid
          nullable: true
        faction_id:
          type: string
          format: uuid
          nullable: true
        state:
          type: object
          additionalProperties: true
        updated_at:
          type: string
          format: date-time

    UpdateWorldStateRequest:
      type: object
      required:
        - state
      properties:
        state:
          type: object
          additionalProperties: true
        priority:
          type: string
          enum:
            - personal
            - server
            - faction
          default: personal

    ResolveConflictRequest:
      type: object
      required:
        - conflict_id
        - resolution
      properties:
        conflict_id:
          type: string
          format: uuid
        resolution:
          type: object
          additionalProperties: true
        priority:
          type: string
          enum:
            - personal
            - server
            - faction

    CheckQuestAvailabilityRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: string
          format: uuid
        check_dependencies:
          type: boolean
          default: true
        check_world_state:
          type: boolean
          default: true
        check_timeline:
          type: boolean
          default: true

    QuestAvailabilityResult:
      type: object
      properties:
        quest_id:
          type: string
          format: uuid
        available:
          type: boolean
        reasons:
          type: array
          items:
            type: string
        missing_prerequisites:
          type: array
          items:
            $ref: '#/components/schemas/Quest'
        world_state_blocks:
          type: array
          items:
            type: string

    CalculateProbabilitiesRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: string
          format: uuid
        quest_ids:
          type: array
          items:
            type: string
            format: uuid
        include_weights:
          type: boolean
          default: true

    QuestProbabilities:
      type: object
      properties:
        quests:
          type: array
          items:
            type: object
            properties:
              quest_id:
                type: string
                format: uuid
              probability:
                type: number
                minimum: 0
                maximum: 1
              weight:
                type: number
                nullable: true
              factors:
                type: object
                additionalProperties: true

    Error:
      type: object
      properties:
        error:
          type: string

  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

security:
  - BearerAuth: []

