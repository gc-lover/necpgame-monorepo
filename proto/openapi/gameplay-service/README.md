# Gameplay Service - Enterprise-Grade Affixes Management

## Назначение

Gameplay Service предоставляет enterprise-grade API для управления динамическими модификаторами сложности (аффиксами) в NECPGAME. Сервис отвечает за применение аффиксов к инстансам рейдов и подземелий, управление еженедельными ротациями и сбор телеметрии.

## Функциональность

- **Управление аффиксами**: CRUD операции для конфигураций аффиксов и механик
- **Динамическая ротация**: Еженедельная система ротации с сезонными аффиксами
- **Применение к инстансам**: Real-time выбор и применение аффиксов к игровым инстансам
- **Обработка эффектов**: Event-driven триггеры эффектов аффиксов и синхронизация
- **Сбор телеметрии**: Комплексная аналитика для баланса и опыта игроков
- **Интеграция с лидербордами**: Статистика прохождений с аффиксами

## Структура

```
gameplay-service/
├── main.yaml              # Основная спецификация API
└── README.md              # Эта документация
```

## Зависимости

- **common**: Общие схемы и ответы
- **world-service**: Хранение конфигураций аффиксов и ротаций
- **combat-service**: Интеграция с боевой системой для эффектов
- **analytics-service**: Сбор и анализ телеметрии аффиксов
- **leaderboard-service**: Рейтинги и достижения за аффиксы

## Performance

- **P99 Latency**: <50ms для операций с аффиксами
- **Memory**: <10MB для конфигураций, <1KB per instance
- **Concurrent Instances**: 1000+ одновременных применений аффиксов
- **Telemetry Throughput**: 100000 events/minute

## Категории аффиксов

### Combat Affixes (боевые модификаторы)
- Volatile: Враги периодически взрываются, нанося AoE урон
- Raging: Враги получают бонус к урону при низком HP
- Spiteful: Враги получают бонус к урону при смерти союзников
- Thundering: Молнии бьют по игрокам с максимальным уроном

### Environmental Affixes (окружающая среда)
- Storming: Периодические молнии бьют по случайным местам
- Entangling: Лоза периодически связывает игроков корнями
- Incorporeal: Враги становятся неуязвимыми на короткое время

### Debuff Affixes (дебаффы и состояния)
- Afflicted: Игроки получают случайные дебаффы со временем
- Bolstering: Смерть врага усиливает оставшихся
- Sanguine: Враги лечатся от урона по игрокам

### Defensive Affixes (защита и выживание)
- Fortified: Враги получают бонус к защите в определенные периоды
- Tyrannical: Боссы имеют увеличенное HP и урон
- Bursting: Враги взрываются при смерти

## API Endpoints

### Public Endpoints
- `GET /api/v1/gameplay/affixes/active` - Список активных аффиксов
- `GET /api/v1/gameplay/affixes/{id}` - Детальная информация об аффиксе
- `GET /api/v1/gameplay/instances/{instanceId}/affixes` - Аффиксы инстанса
- `GET /api/v1/gameplay/affixes/rotation/current` - Текущая ротация
- `GET /api/v1/gameplay/affixes/rotation/history` - История ротаций

### Instance Management
- `POST /api/v1/gameplay/instances/{instanceId}/affixes/apply` - Применить аффиксы к инстансу

### Analytics Endpoints
- `GET /api/v1/gameplay/analytics/affixes/popularity` - Популярность аффиксов
- `GET /api/v1/gameplay/analytics/affixes/difficulty` - Метрики сложности

### Admin Endpoints
- `POST /api/v1/admin/gameplay/affixes/rotation/trigger` - Ручной триггер ротации
- `POST /api/v1/admin/gameplay/affixes` - Создание аффикса
- `PUT /api/v1/admin/gameplay/affixes` - Обновление аффикса
- `DELETE /api/v1/admin/gameplay/affixes` - Удаление аффикса

## Использование

### Валидация

```bash
npx @redocly/cli lint main.yaml
```

### Генерация Go кода

```bash
ogen --target ../../services/gameplay-service-go/pkg/api \
     --package api --clean main.yaml
```

### Документация

```bash
npx @redocly/cli build-docs main.yaml -o docs/index.html
```

## Алгоритм выбора аффиксов

1. Проверка совместимости аффиксов (некоторые комбинации запрещены)
2. Взвешенный случайный выбор с учетом категории
3. Масштабирование эффектов по количеству игроков и уровню сложности

## Несовместимые комбинации

- Raging + Fortified (противоречивые механики)
- Volatile + Incorporeal (избыточная сложность)
- Bursting + Sanguine (непредсказуемость)

## Еженедельная ротация

- Каждый понедельник в 00:00 UTC происходит смена активных аффиксов
- Из общего пула (20+ аффиксов) выбирается 8-10 для текущей недели
- Сезонные аффиксы добавляются автоматически
- Игроки получают уведомления через realtime gateway

## Телеметрия и аналитика

Система собирает данные для балансировки:
- Популярность аффиксов (количество использований)
- Успешность прохождения по аффиксам
- Среднее время прохождения с аффиксами
- Количество жалоб на конкретные аффиксы

## Интеграции

### Combat Service
- Применение боевых модификаторов (HP, урон, способности)
- Обработка механик аффиксов в бою
- Синхронизация с combat session

### World Service
- Хранение конфигураций аффиксов
- Ротация аффиксов
- Интеграция с событиями мира

### Analytics Service
- Отслеживание успешности комбинаций аффиксов
- Метрики сложности и наград
- Балансировка аффиксов

### Leaderboard Service
- Рейтинги по сложности аффиксов
- Сезонные лидерборды
- Достижения за прохождение с аффиксами
