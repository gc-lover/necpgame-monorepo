openapi: 3.0.3
info:
  title: Gameplay Weapon Special Mechanics Core Service API
  description: |
    API для основных специальных механик оружия.
    
    **Основные возможности:**
    - Общие специальные механики оружия
    - Персистентные эффекты (снаряды в теле, DoT)
    - Цепной урон (молнии, EMP волны)
    - Разрушение окружения и частей тела
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8083/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер

tags:
  - name: Special Mechanics
    description: Общие специальные механики оружия
  - name: Persistent Effects
    description: Персистентные эффекты (снаряды в теле, DoT)
  - name: Chain Damage
    description: Цепной урон (молнии, EMP волны)
  - name: Environment Destruction
    description: Разрушение окружения и частей тела

paths:
  /gameplay/combat/weapons/special-mechanics/apply:
    post:
      tags:
        - Special Mechanics
      summary: Применить специальную механику оружия
      description: Применяет специальную механику оружия к цели
      operationId: applySpecialMechanics
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplySpecialMechanicsRequest'
            example:
              weapon_id: "550e8400-e29b-41d4-a716-446655440000"
              character_id: "550e8400-e29b-41d4-a716-446655440001"
              target_id: "550e8400-e29b-41d4-a716-446655440002"
              mechanic_type: "persistent_effect"
              mechanic_data:
                projectile_type: "bolt"
                damage_per_tick: 5.0
                tick_interval: 0.1
      responses:
        '200':
          description: Механика успешно применена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplySpecialMechanicsResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /gameplay/combat/weapons/special-mechanics/{weaponId}:
    get:
      tags:
        - Special Mechanics
      summary: Получить механики оружия
      description: Возвращает список всех специальных механик для указанного оружия
      operationId: getWeaponSpecialMechanics
      security:
        - BearerAuth: []
      parameters:
        - name: weaponId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID оружия
      responses:
        '200':
          description: Список механик оружия
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeaponSpecialMechanicsResponse'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '404':
          $ref: 'common.yaml#/components/responses/NotFound'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /gameplay/combat/weapons/persistent-effects/create:
    post:
      tags:
        - Persistent Effects
      summary: Создать персистентный эффект
      description: Создает персистентный эффект для снаряда (болт, стрела, сюрикен), застрявшего в теле цели
      operationId: createPersistentEffect
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePersistentEffectRequest'
            example:
              target_id: "550e8400-e29b-41d4-a716-446655440002"
              projectile_type: "bolt"
              position:
                x: 0.5
                y: 0.3
                z: 0.2
              damage_per_tick: 5.0
              tick_interval: 0.1
              remaining_ticks: 30
      responses:
        '201':
          description: Персистентный эффект создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersistentEffect'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /gameplay/combat/weapons/persistent-effects/{targetId}:
    get:
      tags:
        - Persistent Effects
      summary: Получить персистентные эффекты цели
      description: Возвращает все активные персистентные эффекты для указанной цели
      operationId: getPersistentEffects
      security:
        - BearerAuth: []
      parameters:
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID цели
      responses:
        '200':
          description: Список персистентных эффектов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersistentEffectsResponse'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '404':
          $ref: 'common.yaml#/components/responses/NotFound'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /gameplay/combat/weapons/chain-damage/calculate:
    post:
      tags:
        - Chain Damage
      summary: Рассчитать цепной урон
      description: Рассчитывает цепной урон от электрического оружия (молнии, EMP волны)
      operationId: calculateChainDamage
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateChainDamageRequest'
            example:
              source_target_id: "550e8400-e29b-41d4-a716-446655440002"
              weapon_id: "550e8400-e29b-41d4-a716-446655440000"
              damage_type: "lightning"
              base_damage: 100.0
              max_jumps: 5
              jump_damage_reduction: 0.25
      responses:
        '200':
          description: Результат расчета цепного урона
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChainDamageResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /gameplay/combat/weapons/environment/destroy:
    post:
      tags:
        - Environment Destruction
      summary: Разрушить окружение
      description: Разрушает окружение и части тела взрывным оружием
      operationId: destroyEnvironment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DestroyEnvironmentRequest'
            example:
              explosion_position:
                x: 10.5
                y: 2.3
                z: 15.7
              explosion_radius: 5.0
              weapon_id: "550e8400-e29b-41d4-a716-446655440000"
              damage: 150.0
      responses:
        '200':
          description: Результат разрушения окружения
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentDestructionResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      $ref: 'common.yaml#/components/securitySchemes/BearerAuth'

  schemas:
    ApplySpecialMechanicsRequest:
      type: object
      required:
        - weapon_id
        - character_id
        - target_id
        - mechanic_type
      properties:
        weapon_id:
          type: string
          format: uuid
          description: ID оружия
        character_id:
          type: string
          format: uuid
          description: ID персонажа
        target_id:
          type: string
          format: uuid
          description: ID цели
        mechanic_type:
          type: string
          enum:
            - persistent_effect
            - chain_damage
            - environment_destruction
            - deployable
            - laser
            - melee
            - elemental
            - temporal
            - control
            - summon
            - projectile_form
          description: Тип специальной механики
        mechanic_data:
          type: object
          additionalProperties: true
          description: Данные механики (зависит от типа)

    ApplySpecialMechanicsResponse:
      type: object
      properties:
        effect_id:
          type: string
          format: uuid
          description: ID созданного эффекта
        mechanic_type:
          type: string
          description: Тип примененной механики
        applied_at:
          type: string
          format: date-time
          description: Время применения

    WeaponSpecialMechanicsResponse:
      type: object
      properties:
        weapon_id:
          type: string
          format: uuid
        mechanics:
          type: array
          items:
            $ref: '#/components/schemas/WeaponMechanic'

    WeaponMechanic:
      type: object
      properties:
        id:
          type: string
          format: uuid
        mechanic_type:
          type: string
        mechanic_data:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    CreatePersistentEffectRequest:
      type: object
      required:
        - target_id
        - projectile_type
        - position
        - damage_per_tick
        - tick_interval
      properties:
        target_id:
          type: string
          format: uuid
          description: ID цели
        projectile_type:
          type: string
          enum:
            - bolt
            - arrow
            - shuriken
          description: Тип снаряда
        position:
          $ref: '#/components/schemas/Position3D'
          description: Позиция снаряда в теле
        damage_per_tick:
          type: number
          format: float
          minimum: 0
          description: Урон за тик
        tick_interval:
          type: number
          format: float
          minimum: 0
          description: Интервал между тиками (секунды)
        remaining_ticks:
          type: integer
          minimum: 0
          description: Количество оставшихся тиков

    PersistentEffect:
      type: object
      properties:
        id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        projectile_type:
          type: string
        position:
          $ref: '#/components/schemas/Position3D'
        damage_per_tick:
          type: number
          format: float
        tick_interval:
          type: number
          format: float
        remaining_ticks:
          type: integer
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    PersistentEffectsResponse:
      type: object
      properties:
        target_id:
          type: string
          format: uuid
        effects:
          type: array
          items:
            $ref: '#/components/schemas/PersistentEffect'

    CalculateChainDamageRequest:
      type: object
      required:
        - source_target_id
        - weapon_id
        - damage_type
        - base_damage
      properties:
        source_target_id:
          type: string
          format: uuid
          description: ID исходной цели
        weapon_id:
          type: string
          format: uuid
          description: ID оружия
        damage_type:
          type: string
          enum:
            - lightning
            - emp
          description: Тип цепного урона
        base_damage:
          type: number
          format: float
          minimum: 0
          description: Базовый урон
        max_jumps:
          type: integer
          minimum: 1
          maximum: 10
          default: 5
          description: Максимальное количество прыжков
        jump_damage_reduction:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.25
          description: Снижение урона при каждом прыжке

    ChainDamageResponse:
      type: object
      properties:
        source_target_id:
          type: string
          format: uuid
        jumps:
          type: array
          items:
            $ref: '#/components/schemas/ChainDamageJump'
        total_damage:
          type: number
          format: float
          description: Общий урон по всем целям

    ChainDamageJump:
      type: object
      properties:
        jump_number:
          type: integer
          description: Номер прыжка
        target_id:
          type: string
          format: uuid
        damage:
          type: number
          format: float

    DestroyEnvironmentRequest:
      type: object
      required:
        - explosion_position
        - explosion_radius
        - weapon_id
        - damage
      properties:
        explosion_position:
          $ref: '#/components/schemas/Position3D'
          description: Позиция взрыва
        explosion_radius:
          type: number
          format: float
          minimum: 0
          description: Радиус взрыва
        weapon_id:
          type: string
          format: uuid
          description: ID оружия
        damage:
          type: number
          format: float
          minimum: 0
          description: Урон взрыва

    EnvironmentDestructionResponse:
      type: object
      properties:
        destroyed_objects:
          type: array
          items:
            $ref: '#/components/schemas/DestroyedObject'
        affected_targets:
          type: array
          items:
            $ref: '#/components/schemas/AffectedTarget'

    DestroyedObject:
      type: object
      properties:
        object_id:
          type: string
          format: uuid
        destruction_type:
          type: string
          enum:
            - wall
            - barrier
            - body_part
            - debris
        position:
          $ref: '#/components/schemas/Position3D'

    AffectedTarget:
      type: object
      properties:
        target_id:
          type: string
          format: uuid
        damage:
          type: number
          format: float
        body_parts_destroyed:
          type: array
          items:
            type: string

    Position3D:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: float
        y:
          type: number
          format: float
        z:
          type: number
          format: float

