# Mail Service - Enterprise-Grade Domain Service

## Назначение

Mail Service предоставляет enterprise-grade API для управления почтовой системой персонажей в NECPGAME. Сервис отвечает
за отправку сообщений, управление вложениями, анти-спам валидацию и массовые рассылки.

## Функциональность

- **Отправка почты**: Отправка сообщений между игроками с вложениями
- **Управление вложениями**: Безопасная передача предметов и валюты через почту
- **Анти-спам защита**: Продвинутая детекция спама и модерация контента
- **Массовые рассылки**: Системные объявления и массовые уведомления
- **Уведомления**: Push-уведомления и оповещения в игре
- **Поиск и фильтры**: Продвинутый поиск по почте с фильтрами
- **Архив и удаление**: Управление почтовыми папками и очистка

## Структура

```
mail-service/
├── main.yaml              # Основная спецификация API
└── README.md              # Эта документация
```

## Зависимости

- **common**: Общие схемы и ответы
- **inventory-service**: Интеграция с системой инвентаря для вложений
- **notification-service**: Push-уведомления и оповещения
- **analytics-service**: Аналитика использования почты
- **moderation-service**: Модерация контента и анти-спам

## Performance

- **P99 Latency**: <8ms для операций с почтой
- **Memory per Instance**: <6KB
- **Concurrent Users**: 65,000+ одновременных операций с почтой
- **Delivery Rate**: 5000+ сообщений в секунду

## API Endpoints

### Отправка и получение почты
- `POST /mail` - Отправить почту
- `GET /mail` - Получить список почты
- `GET /mail/{id}` - Получить детали письма
- `DELETE /mail/{id}` - Удалить письмо

### Управление почтой
- `POST /mail/{id}/read` - Отметить как прочитанное
- `POST /mail/{id}/archive` - Переместить в архив
- `POST /mail/{id}/attachments/claim` - Забрать вложения

### Массовые операции
- `POST /mail/batch` - Пакетные операции над почтой
- `POST /mail/bulk/send` - Массовую рассылку (admin)

### Уведомления и поиск
- `GET /mail/notifications` - Получить уведомления о непрочитанной почте
- `GET /mail/search` - Поиск по почте

### Аналитика и модерация
- `GET /mail/analytics/summary` - Аналитика использования почты
- `POST /mail/moderation/report` - Пожаловаться на письмо
- `POST /mail/validate` - Валидация контента на спам

### AI и адаптация
- `POST /mail/adaptive/train` - Обучение AI на данных почты
- `GET /mail/adaptive/recommend` - AI рекомендации по управлению почтой

## Типы вложений

- **item**: Предметы из инвентаря
- **currency**: Валюта (евродоллары, уличный кредит)
- **cosmetic**: Косметические предметы
- **experience**: Опыт персонажа
- **reputation**: Репутация и статус

## Типы почты

- **player_to_player**: Почта между игроками
- **system_notification**: Системные уведомления
- **event_announcement**: Объявления о событиях
- **trade_offer**: Торговые предложения
- **guild_message**: Сообщения гильдии
- **admin_message**: Сообщения администрации

## Приоритеты почты

- **low**: Низкий приоритет
- **normal**: Обычный приоритет
- **high**: Высокий приоритет
- **urgent**: Срочная почта

## Анти-спам система

### Детекция спама
- Анализ частоты отправки
- Проверка контента на подозрительные паттерны
- Валидация репутации отправителя
- AI-powered анализ поведения

### Модерация контента
- Автоматическая проверка на запрещенный контент
- Ручная модерация для спорных случаев
- Карантин подозрительной почты
- Отчеты пользователей о спаме

## Поиск и фильтры

### Параметры поиска
- **query**: Поиск по теме, тексту, имени отправителя
- **mailbox_type**: Тип почтового ящика (inbox, sent, archive)
- **status**: Статус прочтения (read, unread)
- **has_attachments**: Наличие вложений
- **date_from/to**: Диапазон дат

### Продвинутые фильтры
- Фильтр по отправителю
- Фильтр по типу почты
- Фильтр по приоритету
- Фильтр по наличию вложений

## Уведомления

### Типы уведомлений
- Новое письмо
- Вложения доступны для получения
- Истечение срока действия письма
- Системные объявления
- Торговые предложения

### Настройки уведомлений
- Push-уведомления
- Внутриигровые оповещения
- Email уведомления
- Отключение по типам почты

## Использование

### Валидация

```bash
npx @redocly/cli lint main.yaml
```

### Генерация Go кода

```bash
ogen --target ../../services/mail-service-go/pkg/api \
     --package api --clean main.yaml
```

### Документация

```bash
npx @redocly/cli build-docs main.yaml -o docs/index.html
```

## Безопасность

### Защита от спама
- Rate limiting по отправителю
- Content filtering
- CAPTCHA для подозрительной активности
- Блокировка аккаунтов с высокой spam-оценкой

### Защита вложений
- Валидация прав собственности на предметы
- Проверка баланса валюты
- Откат транзакций при ошибках
- Аудит всех операций с вложениями

### Модерация
- Автоматическая детекция запрещенного контента
- Ручная проверка спорных случаев
- Возможность блокировки пользователей
- Журналирование всех модераторских действий




