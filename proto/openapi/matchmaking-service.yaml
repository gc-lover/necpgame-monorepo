openapi: 3.0.3
info:
  title: Matchmaking Service API
  description: API для системы матчмейкинга: подбор игроков в PvP, PvE и рейды с учётом рейтинга, очередей и алгоритмов подбора
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game

servers:
  - url: http://localhost:8088/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер

tags:
  - name: Queue
    description: Управление очередями матчмейкинга
  - name: Match
    description: Управление матчами
  - name: Rating
    description: Система рейтинга
  - name: Balance
    description: Балансировка команд
  - name: Quality
    description: Качество матча
  - name: Anti-Smurf
    description: Обнаружение смурфов
  - name: Session
    description: Игровые сессии

paths:
  /matchmaking/queue/join:
    post:
      tags:
        - Queue
      summary: Войти в очередь матчмейкинга
      operationId: joinMatchmakingQueue
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinQueueRequest'
      responses:
        '200':
          description: Игрок добавлен в очередь
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/queue/leave:
    delete:
      tags:
        - Queue
      summary: Выйти из очереди матчмейкинга
      operationId: leaveMatchmakingQueue
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveQueueRequest'
      responses:
        '200':
          description: Игрок удалён из очереди
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: left
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/queue/status:
    get:
      tags:
        - Queue
      summary: Получить статус очереди
      operationId: getQueueStatus
      security:
        - BearerAuth: []
      parameters:
        - name: queue_type
          in: query
          required: true
          schema:
            type: string
            enum:
              - pvp
              - pve
              - raid
              - ranked
              - casual
        - name: character_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Статус очереди
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/queue/estimate:
    get:
      tags:
        - Queue
      summary: Получить оценку времени ожидания
      operationId: getQueueEstimate
      security:
        - BearerAuth: []
      parameters:
        - name: queue_type
          in: query
          required: true
          schema:
            type: string
            enum:
              - pvp
              - pve
              - raid
              - ranked
              - casual
        - name: character_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Оценка времени ожидания
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueEstimate'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/match/find:
    post:
      tags:
        - Match
      summary: Найти матч
      operationId: findMatch
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FindMatchRequest'
      responses:
        '200':
          description: Матч найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Match'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/match/{match_id}:
    get:
      tags:
        - Match
      summary: Получить информацию о матче
      operationId: getMatch
      security:
        - BearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Информация о матче
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Match'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/match/{match_id}/accept:
    post:
      tags:
        - Match
      summary: Принять матч
      operationId: acceptMatch
      security:
        - BearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptMatchRequest'
      responses:
        '200':
          description: Матч принят
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Match'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/match/{match_id}/decline:
    post:
      tags:
        - Match
      summary: Отклонить матч
      operationId: declineMatch
      security:
        - BearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclineMatchRequest'
      responses:
        '200':
          description: Матч отклонён
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: declined
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/rating/{player_id}:
    get:
      tags:
        - Rating
      summary: Получить рейтинг игрока
      operationId: getPlayerRating
      security:
        - BearerAuth: []
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: queue_type
          in: query
          schema:
            type: string
            enum:
              - pvp
              - pve
              - raid
              - ranked
              - casual
      responses:
        '200':
          description: Рейтинг игрока
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerRating'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/rating/leaderboard:
    get:
      tags:
        - Rating
      summary: Получить лидерборд рейтинга
      operationId: getRatingLeaderboard
      security:
        - BearerAuth: []
      parameters:
        - name: queue_type
          in: query
          required: true
          schema:
            type: string
            enum:
              - pvp
              - pve
              - raid
              - ranked
              - casual
        - name: tier
          in: query
          schema:
            type: string
            enum:
              - bronze
              - silver
              - gold
              - platinum
              - diamond
              - master
              - grandmaster
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Лидерборд рейтинга
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RatingLeaderboardResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/rating/update:
    post:
      tags:
        - Rating
      summary: Обновить рейтинг игрока
      operationId: updatePlayerRating
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRatingRequest'
      responses:
        '200':
          description: Рейтинг обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerRating'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/balance/calculate:
    post:
      tags:
        - Balance
      summary: Рассчитать баланс команд
      operationId: calculateTeamBalance
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateBalanceRequest'
      responses:
        '200':
          description: Баланс рассчитан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamBalanceResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/balance/redistribute:
    post:
      tags:
        - Balance
      summary: Перераспределить игроков между командами
      operationId: redistributeTeams
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RedistributeTeamsRequest'
      responses:
        '200':
          description: Команды перераспределены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamBalanceResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/quality/{match_id}:
    get:
      tags:
        - Quality
      summary: Получить качество матча
      operationId: getMatchQuality
      security:
        - BearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Качество матча
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchQuality'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/quality/calculate:
    post:
      tags:
        - Quality
      summary: Рассчитать качество матча
      operationId: calculateMatchQuality
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateQualityRequest'
      responses:
        '200':
          description: Качество рассчитано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchQuality'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/anti-smurf/check:
    post:
      tags:
        - Anti-Smurf
      summary: Проверить игрока на смурф
      operationId: checkSmurf
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckSmurfRequest'
      responses:
        '200':
          description: Результат проверки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SmurfCheckResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/anti-smurf/status/{player_id}:
    get:
      tags:
        - Anti-Smurf
      summary: Получить статус проверки игрока
      operationId: getSmurfStatus
      security:
        - BearerAuth: []
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Статус проверки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SmurfStatus'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/session/create:
    post:
      tags:
        - Session
      summary: Создать игровую сессию
      operationId: createMatchSession
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '200':
          description: Сессия создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchSession'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /matchmaking/session/{session_id}:
    get:
      tags:
        - Session
      summary: Получить информацию о сессии
      operationId: getMatchSession
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Информация о сессии
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchSession'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    JoinQueueRequest:
      type: object
      required:
        - character_id
        - queue_type
      properties:
        character_id:
          type: string
          format: uuid
        queue_type:
          type: string
          enum:
            - pvp
            - pve
            - raid
            - ranked
            - casual
        role:
          type: string
        party_id:
          type: string
          format: uuid
          nullable: true

    LeaveQueueRequest:
      type: object
      required:
        - character_id
        - queue_type
      properties:
        character_id:
          type: string
          format: uuid
        queue_type:
          type: string
          enum:
            - pvp
            - pve
            - raid
            - ranked
            - casual

    QueueStatus:
      type: object
      properties:
        character_id:
          type: string
          format: uuid
        queue_type:
          type: string
        status:
          type: string
          enum:
            - queued
            - searching
            - found
            - not_queued
        position:
          type: integer
        estimated_wait_time:
          type: integer
        search_range_expanded:
          type: boolean
        queued_at:
          type: string
          format: date-time

    QueueEstimate:
      type: object
      properties:
        queue_type:
          type: string
        estimated_wait_time_seconds:
          type: integer
        players_in_queue:
          type: integer
        average_wait_time:
          type: integer

    FindMatchRequest:
      type: object
      required:
        - character_id
        - queue_type
      properties:
        character_id:
          type: string
          format: uuid
        queue_type:
          type: string
          enum:
            - pvp
            - pve
            - raid
            - ranked
            - casual
        party_id:
          type: string
          format: uuid
          nullable: true

    Match:
      type: object
      properties:
        id:
          type: string
          format: uuid
        queue_type:
          type: string
        status:
          type: string
          enum:
            - found
            - accepted
            - declined
            - cancelled
            - started
        teams:
          type: array
          items:
            $ref: '#/components/schemas/Team'
        quality_score:
          type: number
          format: float
        found_at:
          type: string
          format: date-time
        accepted_at:
          type: string
          format: date-time
          nullable: true

    Team:
      type: object
      properties:
        id:
          type: string
          format: uuid
        players:
          type: array
          items:
            $ref: '#/components/schemas/MatchPlayer'
        average_rating:
          type: number
          format: float

    MatchPlayer:
      type: object
      properties:
        character_id:
          type: string
          format: uuid
        role:
          type: string
        rating:
          type: number
          format: float
        accepted:
          type: boolean
        accepted_at:
          type: string
          format: date-time
          nullable: true

    AcceptMatchRequest:
      type: object
      required:
        - character_id
      properties:
        character_id:
          type: string
          format: uuid

    DeclineMatchRequest:
      type: object
      required:
        - character_id
      properties:
        character_id:
          type: string
          format: uuid
        reason:
          type: string

    PlayerRating:
      type: object
      properties:
        player_id:
          type: string
          format: uuid
        queue_type:
          type: string
        rating:
          type: number
          format: float
        tier:
          type: string
          enum:
            - bronze
            - silver
            - gold
            - platinum
            - diamond
            - master
            - grandmaster
        wins:
          type: integer
        losses:
          type: integer
        win_rate:
          type: number
          format: float
        streak:
          type: integer
        last_updated:
          type: string
          format: date-time

    RatingLeaderboardResponse:
      type: object
      properties:
        leaderboard:
          type: array
          items:
            $ref: '#/components/schemas/PlayerRating'
        total:
          type: integer

    UpdateRatingRequest:
      type: object
      required:
        - player_id
        - queue_type
        - match_result
      properties:
        player_id:
          type: string
          format: uuid
        queue_type:
          type: string
        match_result:
          type: string
          enum:
            - win
            - loss
            - draw
        opponent_rating:
          type: number
          format: float
        match_quality:
          type: number
          format: float

    CalculateBalanceRequest:
      type: object
      required:
        - teams
      properties:
        teams:
          type: array
          items:
            $ref: '#/components/schemas/Team'
        strategy:
          type: string
          enum:
            - snake_draft
            - role_based
            - rating_based
            - skill_based

    RedistributeTeamsRequest:
      type: object
      required:
        - match_id
        - strategy
      properties:
        match_id:
          type: string
          format: uuid
        strategy:
          type: string
          enum:
            - snake_draft
            - role_based
            - rating_based
            - skill_based

    TeamBalanceResult:
      type: object
      properties:
        teams:
          type: array
          items:
            $ref: '#/components/schemas/Team'
        balance_score:
          type: number
          format: float
        is_balanced:
          type: boolean

    MatchQuality:
      type: object
      properties:
        match_id:
          type: string
          format: uuid
        quality_score:
          type: number
          format: float
        factors:
          type: object
          properties:
            rating_spread:
              type: number
              format: float
            wait_time:
              type: integer
            latency:
              type: number
              format: float
            team_balance:
              type: number
              format: float
            role_composition:
              type: number
              format: float

    CalculateQualityRequest:
      type: object
      required:
        - match_id
      properties:
        match_id:
          type: string
          format: uuid

    CheckSmurfRequest:
      type: object
      required:
        - player_id
      properties:
        player_id:
          type: string
          format: uuid

    SmurfCheckResult:
      type: object
      properties:
        player_id:
          type: string
          format: uuid
        is_smurf:
          type: boolean
        confidence:
          type: number
          format: float
        reasons:
          type: array
          items:
            type: string
        restrictions_applied:
          type: array
          items:
            type: string

    SmurfStatus:
      type: object
      properties:
        player_id:
          type: string
          format: uuid
        is_smurf:
          type: boolean
        checked_at:
          type: string
          format: date-time
        restrictions:
          type: array
          items:
            type: string

    CreateSessionRequest:
      type: object
      required:
        - match_id
      properties:
        match_id:
          type: string
          format: uuid
        game_mode:
          type: string
        parameters:
          type: object
          additionalProperties: true

    MatchSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
        match_id:
          type: string
          format: uuid
        game_mode:
          type: string
        status:
          type: string
          enum:
            - created
            - active
            - ended
        players:
          type: array
          items:
            type: string
            format: uuid
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        ended_at:
          type: string
          format: date-time
          nullable: true

    Error:
      type: object
      properties:
        error:
          type: string

  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

security:
  - BearerAuth: []

