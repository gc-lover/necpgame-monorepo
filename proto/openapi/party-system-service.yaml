# Issue: #1850
openapi: 3.0.3
info:
  title: Party System Service API
  description: |
    Полная API спецификация для системы управления группами игроков.
    Поддерживает создание групп, приглашения, распределение лута и совместные задания.

    **Ключевые возможности:**
    - Управление группами до 5 игроков
    - Система приглашений с таймаутами
    - Распределение лута (4 режима)
    - Координация совместных заданий
    - Realtime синхронизация состояния
  version: 2.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necpgame.com

servers:
  - url: http://localhost:8084/api/v1
    description: Party System Service (локальная разработка)
  - url: https://party.necpgame.com/api/v1
    description: Party System Service (продакшен)

tags:
  - name: Party Management
    description: Управление группами и их состоянием
  - name: Member Management
    description: Управление участниками групп
  - name: Invitations
    description: Система приглашений
  - name: Loot Distribution
    description: Распределение лута
  - name: Quest Coordination
    description: Координация совместных заданий
  - name: Monitoring
    description: Мониторинг и статистика

paths:
  # Party Management
  /social/party:
    post:
      tags:
        - Party Management
      summary: Создать новую группу
      description: |
        Создаёт новую группу с текущим игроком в качестве лидера.
        Максимальный размер группы: 5 игроков.
      operationId: createParty
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePartyRequest"
      responses:
        "200":
          description: Группа создана успешно
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "409":
          description: Игрок уже состоит в группе
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RateLimitError"

  /social/party/my:
    get:
      tags:
        - Party Management
      summary: Получить текущую группу игрока
      description: Возвращает информацию о группе, в которой состоит текущий игрок
      operationId: getMyParty
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Информация о группе
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "404":
          description: Игрок не состоит в группе
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /social/party/{partyId}:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: ID группы

    get:
      tags:
        - Party Management
      summary: Получить информацию о группе
      description: Возвращает полную информацию о группе по её ID
      operationId: getParty
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Информация о группе
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "403":
          $ref: common.yaml#/components/responses/Forbidden
        "404":
          $ref: common.yaml#/components/responses/NotFound

    put:
      tags:
        - Party Management
      summary: Обновить настройки группы
      description: Обновляет настройки группы (только лидер)
      operationId: updateParty
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePartyRequest"
      responses:
        "200":
          description: Настройки обновлены
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

    delete:
      tags:
        - Party Management
      summary: Распустить группу
      description: Распускает группу (только лидер)
      operationId: disbandParty
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Группа распущена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  # Member Management
  /social/party/{partyId}/members:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Member Management
      summary: Добавить участника в группу
      description: Добавляет игрока в группу (только лидер)
      operationId: addPartyMember
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddMemberRequest"
      responses:
        "200":
          description: Участник добавлен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartyMember"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "403":
          $ref: common.yaml#/components/responses/Forbidden
        "409":
          description: Группа полная или игрок уже в группе
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /social/party/{partyId}/members/{accountId}:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: accountId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags:
        - Member Management
      summary: Изменить роль участника
      description: Изменяет роль участника группы (только лидер)
      operationId: updateMemberRole
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateRoleRequest"
      responses:
        "200":
          description: Роль обновлена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartyMember"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

    delete:
      tags:
        - Member Management
      summary: Удалить участника из группы
      description: Удаляет участника из группы (лидер или сам участник)
      operationId: removePartyMember
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Участник удалён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  /social/party/{partyId}/leave:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Member Management
      summary: Покинуть группу
      description: Позволяет участнику покинуть группу
      operationId: leaveParty
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Игрок покинул группу
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"

  # Invitations
  /social/party/{partyId}/invitations:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Invitations
      summary: Пригласить игрока в группу
      description: Отправляет приглашение игроку присоединиться к группе
      operationId: sendPartyInvitation
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendInvitationRequest"
      responses:
        "200":
          description: Приглашение отправлено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartyInvitation"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "403":
          $ref: common.yaml#/components/responses/Forbidden
        "404":
          description: Игрок не найден
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /social/party/invitations/my:
    get:
      tags:
        - Invitations
      summary: Получить мои приглашения
      description: Возвращает список активных приглашений для текущего игрока
      operationId: getMyInvitations
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Список приглашений
          content:
            application/json:
              schema:
                type: object
                properties:
                  invitations:
                    type: array
                    items:
                      $ref: "#/components/schemas/PartyInvitation"

  /social/party/invitations/{invitationId}/accept:
    parameters:
      - name: invitationId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Invitations
      summary: Принять приглашение
      description: Принимает приглашение в группу
      operationId: acceptInvitation
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Приглашение принято
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "404":
          $ref: common.yaml#/components/responses/NotFound
        "410":
          description: Приглашение истекло
          content:
            application/json:
              schema:
                $ref: common.yaml#/components/schemas/Error

  /social/party/invitations/{invitationId}/decline:
    parameters:
      - name: invitationId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Invitations
      summary: Отклонить приглашение
      description: Отклоняет приглашение в группу
      operationId: declineInvitation
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Приглашение отклонено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
        "404":
          $ref: common.yaml#/components/responses/NotFound

  # Loot Distribution
  /social/party/{partyId}/loot-mode:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Loot Distribution
      summary: Получить режим распределения лута
      description: Возвращает текущий режим распределения лута группы
      operationId: getLootMode
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Режим распределения лута
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LootModeResponse"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

    put:
      tags:
        - Loot Distribution
      summary: Изменить режим распределения лута
      description: Изменяет режим распределения лута группы (только лидер)
      operationId: setLootMode
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetLootModeRequest"
      responses:
        "200":
          description: Режим изменён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LootModeResponse"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  /social/party/{partyId}/loot/distribute:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Loot Distribution
      summary: Распределить лут
      description: Распределяет предметы между участниками группы согласно выбранному режиму
      operationId: distributeLoot
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DistributeLootRequest"
      responses:
        "200":
          description: Лут распределён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LootDistributionResult"
        "400":
          $ref: common.yaml#/components/responses/BadRequest
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  # Quest Coordination
  /social/party/{partyId}/quests:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Quest Coordination
      summary: Получить задания группы
      description: Возвращает список активных заданий группы
      operationId: getPartyQuests
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Задания группы
          content:
            application/json:
              schema:
                type: object
                properties:
                  quests:
                    type: array
                    items:
                      $ref: "#/components/schemas/PartyQuest"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  /social/party/{partyId}/quests/{questId}/sync:
    parameters:
      - name: partyId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: questId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Quest Coordination
      summary: Синхронизировать прогресс задания
      description: Синхронизирует прогресс задания между участниками группы
      operationId: syncQuestProgress
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncQuestRequest"
      responses:
        "200":
          description: Прогресс синхронизирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuestSyncResult"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

  # Monitoring
  /social/party/stats:
    get:
      tags:
        - Monitoring
      summary: Получить статистику групп
      description: Возвращает общую статистику системы групп
      operationId: getPartyStats
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Статистика групп
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartyStats"
        "403":
          $ref: common.yaml#/components/responses/Forbidden

components:
  securitySchemes:
    BearerAuth:
      $ref: common.yaml#/components/securitySchemes/BearerAuth

  schemas:
    # Party Management
    CreatePartyRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 50
          description: Название группы (опционально)
        loot_mode:
          $ref: "#/components/schemas/LootMode"
        settings:
          type: object
          description: Дополнительные настройки группы
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    UpdatePartyRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 50
        loot_mode:
          $ref: "#/components/schemas/LootMode"
        settings:
          type: object
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    Party:
      type: object
      properties:
        id:
          type: string
          format: uuid
        leader_id:
          type: string
          format: uuid
        name:
          type: string
          nullable: true
        loot_mode:
          $ref: "#/components/schemas/LootMode"
        status:
          $ref: "#/components/schemas/PartyStatus"
        max_members:
          type: integer
          default: 5
        current_members:
          type: integer
        members:
          type: array
          items:
            $ref: "#/components/schemas/PartyMember"
        settings:
          type: object
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    PartyStatus:
      type: string
      enum: [active, disbanded]
      description: Статус группы

    PartyMember:
      type: object
      properties:
        account_id:
          type: string
          format: uuid
        character_id:
          type: string
          format: uuid
          nullable: true
        role:
          $ref: "#/components/schemas/MemberRole"
        joined_at:
          type: string
          format: date-time
        last_active_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    MemberRole:
      type: string
      enum: [leader, member]
      description: Роль участника в группе

    # Invitations
    SendInvitationRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: string
          format: uuid
          description: ID приглашаемого игрока
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    PartyInvitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        party_id:
          type: string
          format: uuid
        inviter_id:
          type: string
          format: uuid
        invitee_id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/InvitationStatus"
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    InvitationStatus:
      type: string
      enum: [pending, accepted, declined, expired]

    # Member Management
    AddMemberRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: string
          format: uuid
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    UpdateRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          $ref: "#/components/schemas/MemberRole"
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    # Loot Distribution
    LootMode:
      type: string
      enum: [free_for_all, need_before_greed, master_looter, round_robin]
      description: Режим распределения лута

    LootModeResponse:
      type: object
      properties:
        loot_mode:
          $ref: "#/components/schemas/LootMode"
        set_by:
          type: string
          format: uuid
          description: ID игрока, установившего режим
        set_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    SetLootModeRequest:
      type: object
      required:
        - loot_mode
      properties:
        loot_mode:
          $ref: "#/components/schemas/LootMode"
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    DistributeLootRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/LootItem"
        source:
          type: string
          enum: [combat, quest, container]
          description: Источник лута
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    LootItem:
      type: object
      required:
        - item_id
      properties:
        item_id:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
        quality:
          type: string
          enum: [common, uncommon, rare, epic, legendary]
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    LootDistributionResult:
      type: object
      properties:
        distributions:
          type: array
          items:
            $ref: "#/components/schemas/ItemDistribution"
        mode_used:
          $ref: "#/components/schemas/LootMode"
        completed_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    ItemDistribution:
      type: object
      properties:
        item_id:
          type: string
          format: uuid
        distributed_to:
          type: string
          format: uuid
        quantity:
          type: integer
        method:
          type: string
          enum: [assigned, rolled, traded]
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    # Quest Coordination
    PartyQuest:
      type: object
      properties:
        quest_id:
          type: string
          format: uuid
        title:
          type: string
        progress:
          type: object
          description: Прогресс выполнения задания
        participants:
          type: array
          items:
            type: string
            format: uuid
          description: Участники, работающие над заданием
        started_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    SyncQuestRequest:
      type: object
      required:
        - progress_data
      properties:
        progress_data:
          type: object
          description: Данные прогресса для синхронизации
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    QuestSyncResult:
      type: object
      properties:
        quest_id:
          type: string
          format: uuid
        synced_progress:
          type: object
        synced_at:
          type: string
          format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    # Monitoring
    PartyStats:
      type: object
      properties:
        total_parties:
          type: integer
        active_parties:
          type: integer
        disbanded_parties_today:
          type: integer
        average_party_size:
          type: number
          format: float
        loot_distributions_today:
          type: integer
        invitations_sent_today:
          type: integer
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    # Common
    StatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
        message:
          type: string
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

    RateLimitError:
      allOf:
        - $ref: common.yaml#/components/schemas/Error
        - type: object
          properties:
            retry_after_seconds:
              type: integer
            limit:
              type: integer
            remaining:
              type: integer
            reset_at:
              type: string
              format: date-time
      description: "BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%."

security:
  - BearerAuth: []
