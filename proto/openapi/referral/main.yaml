openapi: 3.0.3
info:
  title: Referral Domain API - Enterprise-Grade
  description: '**Enterprise-Grade Referral Domain API for NECPGAME**

    This domain provides comprehensive referral system functionality including code
    generation, registration tracking, milestone rewards, and leaderboard management.

    ## Key Features

    - **Code Management**: Generate and validate unique referral codes - **Registration
    Tracking**: Track referrals and their progression - **Milestone System**: Multi-level
    rewards based on referral achievements - **Leaderboard**: Competitive ranking
    system for referrers - **Reward Distribution**: Automated reward claiming and
    distribution - **Analytics**: Comprehensive referral system analytics

    ## Domain Purpose

    The Referral Domain handles all aspects of player-to-player referrals, enabling
    viral growth through incentivized player acquisition and engagement.

    ## Performance Targets

    - P99 Latency: <100ms for hot paths (code validation, registration) - Memory:
    <50KB per player instance - Concurrent users: 10,000+ simultaneous connections
    - Data consistency: ACID for critical operations, Eventual for analytics

    '
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necpgame.com
servers:
- url: http://localhost:8080/api/v1
  description: Development server
- url: https://api.necpgame.com/api/v1
  description: Production server
security:
- BearerAuth: []
tags:
- name: Referral Codes
  description: Referral code generation and management
- name: Referral Registration
  description: Registration and referral tracking
- name: Referral Statistics
  description: Referral statistics and analytics
- name: Referral Milestones
  description: Milestone management and rewards
- name: Referral Leaderboard
  description: Leaderboard and ranking
- name: Referral Rewards
  description: Reward distribution and claiming
- name: System
  description: System health and monitoring
paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags:
      - System
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
          headers:
            Cache-Control:
              schema:
                type: string
                example: max-age=300, s-maxage=600
            ETag:
              schema:
                type: string
                example: '"referral-health-v1.0"'
            Content-Encoding:
              schema:
                type: string
                enum:
                - gzip
                - deflate
                - br
  /health/batch:
    post:
      summary: Batch health check for multiple domains
      operationId: batchHealthCheck
      tags:
      - System
      description: 'Performance optimization: Check multiple domain health in single
        request'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - domains
              properties:
                domains:
                  type: array
                  items:
                    type: string
                  maxItems: 10
      responses:
        '200':
          description: Batch health results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/HealthResponse'
                  total_time_ms:
                    type: integer
                    description: Total processing time
  /health/ws:
    get:
      summary: Real-time health monitoring WebSocket
      operationId: healthWebSocket
      tags:
      - System
      description: Real-time health updates without polling
      responses:
        '101':
          description: WebSocket connection established
  /api/v1/referral/code/{characterId}:
    get:
      summary: Get referral code for character
      operationId: getReferralCode
      tags:
      - Referral Codes
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Referral code retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferralCodeResponse'
        '404':
          description: Referral code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/code/generate:
    post:
      summary: Generate new referral code
      operationId: generateReferralCode
      tags:
      - Referral Codes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCodeRequest'
      responses:
        '201':
          description: Referral code generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferralCodeResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/code/validate:
    post:
      summary: Validate referral code
      operationId: validateReferralCode
      tags:
      - Referral Codes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateCodeRequest'
      responses:
        '200':
          description: Code is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateCodeResponse'
        '400':
          description: Invalid code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/register:
    post:
      summary: Register with referral code
      operationId: registerWithReferral
      tags:
      - Referral Registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReferralRegistrationRequest'
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferralRegistrationResponse'
        '400':
          description: Invalid referral code or registration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/{characterId}/referrals:
    get:
      summary: Get referrals for character
      operationId: getCharacterReferrals
      tags:
      - Referral Registration
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: status
        in: query
        schema:
          type: string
          enum:
          - pending
          - active
          - milestone_reached
          - inactive
      - name: limit
        in: query
        schema:
          type: integer
          minimum: 1
          maximum: 100
          default: 50
      - name: offset
        in: query
        schema:
          type: integer
          minimum: 0
          default: 0
      responses:
        '200':
          description: Referrals retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferralListResponse'
        '404':
          description: Character not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/{characterId}/stats:
    get:
      summary: Get referral statistics for character
      operationId: getReferralStats
      tags:
      - Referral Statistics
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferralStatsResponse'
        '404':
          description: Character not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/{characterId}/milestones:
    get:
      summary: Get milestones for character
      operationId: getCharacterMilestones
      tags:
      - Referral Milestones
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Milestones retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MilestoneListResponse'
  /api/v1/referral/{characterId}/milestones/{milestoneId}/claim:
    post:
      summary: Claim milestone reward
      operationId: claimMilestoneReward
      tags:
      - Referral Milestones
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: milestoneId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Reward claimed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardClaimResponse'
        '400':
          description: Milestone not eligible for claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/referral/leaderboard:
    get:
      summary: Get referral leaderboard
      operationId: getReferralLeaderboard
      tags:
      - Referral Leaderboard
      parameters:
      - name: limit
        in: query
        schema:
          type: integer
          minimum: 1
          maximum: 100
          default: 50
      - name: offset
        in: query
        schema:
          type: integer
          minimum: 0
          default: 0
      responses:
        '200':
          description: Leaderboard retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaderboardResponse'
  /api/v1/referral/leaderboard/{characterId}:
    get:
      summary: Get character position in leaderboard
      operationId: getCharacterLeaderboardPosition
      tags:
      - Referral Leaderboard
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Position retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaderboardPositionResponse'
  /api/v1/referral/rewards/{characterId}:
    get:
      summary: Get available rewards for character
      operationId: getCharacterRewards
      tags:
      - Referral Rewards
      parameters:
      - name: characterId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: status
        in: query
        schema:
          type: string
          enum:
          - pending
          - distributed
          - claimed
          - expired
      responses:
        '200':
          description: Rewards retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardListResponse'
  /api/v1/referral/rewards/{rewardId}/claim:
    post:
      summary: Claim specific reward
      operationId: claimReward
      tags:
      - Referral Rewards
      parameters:
      - name: rewardId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Reward claimed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardClaimResponse'
        '400':
          description: Reward not eligible for claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    HealthResponse:
      $ref: ../common/schemas/health.yaml#/HealthResponse
    Error:
      $ref: ../common/schemas/error.yaml#/Error
    WebSocketHealthMessage:
      type: object
      required:
      - type
      - message_timestamp
      - health
      properties:
        type:
          type: string
          enum:
          - health_update
          - health_alert
          - service_down
        message_timestamp:
          type: string
          format: date-time
          description: Timestamp of the health message
        health:
          $ref: '#/components/schemas/HealthResponse'
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small).
        Expected memory savings: 30-50%.'
    ReferralCodeResponse:
      type: object
      required:
      - code
      - character_id
      - created_at
      - is_active
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the referral code
        character_id:
          type: string
          format: uuid
          description: Character that owns this code
        code:
          type: string
          example: REF-ABC123XY
          description: The referral code
        prefix:
          type: string
          example: REF
          description: Code prefix
        created_at:
          type: string
          format: date-time
          description: When the code was created
        expires_at:
          type: string
          format: date-time
          description: When the code expires (optional)
        is_active:
          type: boolean
          description: Whether the code is active
        usage_count:
          type: integer
          description: How many times the code has been used
        max_usage:
          type: integer
          description: Maximum usage count (optional)
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small).
        Expected memory savings: 30-50%.'
    GenerateCodeRequest:
      type: object
      required:
      - character_id
      properties:
        character_id:
          type: string
          format: uuid
          description: Character requesting the code
        expires_in_days:
          type: integer
          minimum: 1
          maximum: 365
          description: Days until code expires (optional)
        max_usage:
          type: integer
          minimum: 1
          description: Maximum usage count (optional)
    ValidateCodeRequest:
      type: object
      required:
      - code
      properties:
        code:
          type: string
          description: Referral code to validate
    ValidateCodeResponse:
      type: object
      required:
      - is_valid
      - code
      properties:
        is_valid:
          type: boolean
          description: Whether the code is valid
        code:
          type: string
          description: The validated code
        character_id:
          type: string
          format: uuid
          description: Owner of the code (if valid)
        usage_count:
          type: integer
          description: Current usage count
        max_usage:
          type: integer
          description: Maximum usage count
        expires_at:
          type: string
          format: date-time
          description: Expiration date
    ReferralRegistrationRequest:
      type: object
      required:
      - referral_code
      - new_character_id
      properties:
        referral_code:
          type: string
          description: The referral code used
        new_character_id:
          type: string
          format: uuid
          description: New character being registered
    ReferralRegistrationResponse:
      type: object
      required:
      - referral_id
      - referrer_id
      - referred_id
      - status
      properties:
        referral_id:
          type: string
          format: uuid
          description: ID of the created referral
        referrer_id:
          type: string
          format: uuid
          description: Character who owns the code
        referred_id:
          type: string
          format: uuid
          description: New character being referred
        status:
          type: string
          enum:
          - pending
          - active
          - milestone_reached
          - inactive
          description: Initial status of the referral
        welcome_reward_granted:
          type: boolean
          description: Whether welcome reward was granted
    ReferralListResponse:
      type: object
      required:
      - referrals
      - total_count
      properties:
        referrals:
          type: array
          items:
            $ref: '#/components/schemas/ReferralInfo'
        total_count:
          type: integer
          description: Total number of referrals
        limit:
          type: integer
          description: Requested limit
        offset:
          type: integer
          description: Requested offset
    ReferralInfo:
      type: object
      required:
      - id
      - referrer_id
      - referred_id
      - status
      - registered_at
      properties:
        id:
          type: string
          format: uuid
          description: Referral ID
        referrer_id:
          type: string
          format: uuid
          description: Referrer character ID
        referred_id:
          type: string
          format: uuid
          description: Referred character ID
        referral_code:
          type: string
          description: Code used for referral
        status:
          type: string
          enum:
          - pending
          - active
          - milestone_reached
          - inactive
          description: Current status
        registered_at:
          type: string
          format: date-time
          description: When referral was registered
        level_10_reached_at:
          type: string
          format: date-time
          description: When referred character reached level 10
        milestone_reached_at:
          type: string
          format: date-time
          description: When milestone was reached
        welcome_reward_claimed:
          type: boolean
          description: Whether welcome reward was claimed
        level_10_reward_claimed:
          type: boolean
          description: Whether level 10 reward was claimed
        milestone_reward_claimed:
          type: boolean
          description: Whether milestone reward was claimed
    ReferralStatsResponse:
      type: object
      required:
      - character_id
      - total_referrals
      - active_referrals
      - milestone_referrals
      properties:
        character_id:
          type: string
          format: uuid
          description: Character ID
        total_referrals:
          type: integer
          description: Total number of referrals
        active_referrals:
          type: integer
          description: Number of active referrals (level 10+)
        milestone_referrals:
          type: integer
          description: Number of referrals that reached milestones
        pending_referrals:
          type: integer
          description: Number of pending referrals
        inactive_referrals:
          type: integer
          description: Number of inactive referrals
        total_rewards_earned:
          type: number
          format: decimal
          description: Total rewards earned in game currency
        conversion_rate:
          type: number
          format: decimal
          description: Percentage of referrals that became active
    MilestoneListResponse:
      type: object
      required:
      - milestones
      properties:
        milestones:
          type: array
          items:
            $ref: '#/components/schemas/MilestoneInfo'
    MilestoneInfo:
      type: object
      required:
      - id
      - milestone_level
      - required_referrals
      - current_referrals
      - is_completed
      properties:
        id:
          type: string
          format: uuid
          description: Milestone ID
        milestone_level:
          type: integer
          description: Milestone level (5, 10, 25, 50, 100)
        required_referrals:
          type: integer
          description: Required number of referrals
        current_referrals:
          type: integer
          description: Current number of referrals
        reward_type:
          type: string
          description: Type of reward
        reward_amount:
          type: integer
          description: Amount of reward
        bonus_reward_type:
          type: string
          description: Type of bonus reward
        bonus_reward_amount:
          type: integer
          description: Amount of bonus reward
        is_completed:
          type: boolean
          description: Whether milestone is completed
        completed_at:
          type: string
          format: date-time
          description: When milestone was completed
        is_reward_claimed:
          type: boolean
          description: Whether reward was claimed
        reward_claimed_at:
          type: string
          format: date-time
          description: When reward was claimed
    RewardClaimResponse:
      type: object
      required:
      - reward_id
      - claimed_at
      - reward_type
      - reward_amount
      properties:
        reward_id:
          type: string
          format: uuid
          description: ID of the claimed reward
        claimed_at:
          type: string
          format: date-time
          description: When reward was claimed
        reward_type:
          type: string
          description: Type of reward
        reward_amount:
          type: integer
          description: Amount rewarded
        currency_type:
          type: string
          description: Type of currency (optional)
        item_id:
          type: string
          format: uuid
          description: Item ID if item reward (optional)
    LeaderboardResponse:
      type: object
      required:
      - entries
      - total_count
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/LeaderboardEntry'
        total_count:
          type: integer
          description: Total number of entries
        last_updated:
          type: string
          format: date-time
          description: When leaderboard was last updated
    LeaderboardEntry:
      type: object
      required:
      - rank
      - character_id
      - total_referrals
      - active_referrals
      - milestone_referrals
      properties:
        rank:
          type: integer
          description: Current rank
        character_id:
          type: string
          format: uuid
          description: Character ID
        total_referrals:
          type: integer
          description: Total referrals
        active_referrals:
          type: integer
          description: Active referrals
        milestone_referrals:
          type: integer
          description: Milestone referrals
        total_rewards:
          type: number
          format: decimal
          description: Total rewards earned
    LeaderboardPositionResponse:
      type: object
      required:
      - character_id
      - rank
      - total_entries
      properties:
        character_id:
          type: string
          format: uuid
          description: Character ID
        rank:
          type: integer
          description: Current rank
        total_entries:
          type: integer
          description: Total entries in leaderboard
        surrounding_players:
          type: array
          items:
            $ref: '#/components/schemas/LeaderboardEntry'
          description: Players around this position
    RewardListResponse:
      type: object
      required:
      - rewards
      properties:
        rewards:
          type: array
          items:
            $ref: '#/components/schemas/RewardInfo'
    RewardInfo:
      type: object
      required:
      - id
      - character_id
      - reward_type
      - status
      properties:
        id:
          type: string
          format: uuid
          description: Reward ID
        character_id:
          type: string
          format: uuid
          description: Character ID
        referral_id:
          type: string
          format: uuid
          description: Associated referral ID (optional)
        reward_type:
          type: string
          description: Type of reward
        reward_amount:
          type: integer
          description: Amount of reward
        currency_type:
          type: string
          description: Type of currency
        item_id:
          type: string
          format: uuid
          description: Item ID if applicable
        status:
          type: string
          enum:
          - pending
          - distributed
          - claimed
          - expired
          description: Current status
        distributed_at:
          type: string
          format: date-time
          description: When reward was distributed
        claimed_at:
          type: string
          format: date-time
          description: When reward was claimed
        expires_at:
          type: string
          format: date-time
          description: When reward expires
    PaginationParams:
      $ref: ../common/schemas/pagination.yaml#/PaginationParams
    PaginatedResponse:
      $ref: ../common/schemas/pagination.yaml#/PaginatedResponse
  responses:
    OK:
      $ref: ../common/responses/success.yaml#/OK
    Created:
      $ref: ../common/responses/success.yaml#/Created
    BadRequest:
      $ref: ../common/responses/error.yaml#/BadRequest
    Unauthorized:
      $ref: ../common/responses/error.yaml#/Unauthorized
    Forbidden:
      $ref: ../common/responses/error.yaml#/Forbidden
    NotFound:
      $ref: ../common/responses/error.yaml#/NotFound
    Conflict:
      $ref: ../common/responses/error.yaml#/Conflict
    InternalServerError:
      $ref: ../common/responses/error.yaml#/InternalServerError
    HealthOK:
      $ref: ../common/responses/success.yaml#/HealthOK
    HealthBatchSuccess:
      $ref: ../common/responses/success.yaml#/HealthBatchSuccess
  securitySchemes:
    BearerAuth:
      $ref: ../common/security/security.yaml#/BearerAuth
    ApiKeyAuth:
      $ref: ../common/security/security.yaml#/ApiKeyAuth
    ServiceAuth:
      $ref: ../common/security/security.yaml#/ServiceAuth
