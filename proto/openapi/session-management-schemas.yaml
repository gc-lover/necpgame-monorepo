openapi: 3.0.3
info:
  title: Session Management Service Schemas
  description: Схемы данных для Session Management Service API
  version: 1.0.0

servers: []

paths: {}

components:
  schemas:
    SessionState:
      type: string
      enum:
        - CREATED
        - ACTIVE
        - IDLE
        - AFK
        - DISCONNECTED
        - EXPIRED
        - CLOSED
      description: |
        Состояние сессии:
        - `CREATED` - сессия создана
        - `ACTIVE` - сессия активна
        - `IDLE` - сессия в режиме ожидания
        - `AFK` - игрок отсутствует
        - `DISCONNECTED` - сессия отключена
        - `EXPIRED` - сессия истекла
        - `CLOSED` - сессия закрыта

    CreateSessionRequest:
      type: object
      required:
        - player_id
      properties:
        player_id:
          type: string
          format: uuid
          description: ID игрока
        character_id:
          type: string
          format: uuid
          description: ID персонажа (опционально)
        ip_address:
          type: string
          format: ipv4
          description: IP адрес клиента
        user_agent:
          type: string
          description: User-Agent клиента
        server_id:
          type: string
          description: ID игрового сервера
        zone_id:
          type: string
          description: ID зоны (опционально)

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Уникальный ID сессии
        player_id:
          type: string
          format: uuid
          description: ID игрока
        character_id:
          type: string
          format: uuid
          nullable: true
          description: ID персонажа
        session_token:
          type: string
          description: Токен сессии
        refresh_token:
          type: string
          nullable: true
          description: Refresh токен
        state:
          $ref: '#/components/schemas/SessionState'
        ip_address:
          type: string
          format: ipv4
          description: IP адрес клиента
        user_agent:
          type: string
          description: User-Agent клиента
        server_id:
          type: string
          description: ID игрового сервера
        zone_id:
          type: string
          nullable: true
          description: ID зоны
        last_heartbeat_at:
          type: string
          format: date-time
          nullable: true
          description: Время последнего heartbeat
        last_activity_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней активности
        created_at:
          type: string
          format: date-time
          description: Время создания сессии
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Время истечения сессии
        closed_at:
          type: string
          format: date-time
          nullable: true
          description: Время закрытия сессии

    LogoutResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        logged_out_at:
          type: string
          format: date-time

    HeartbeatResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        last_heartbeat_at:
          type: string
          format: date-time
        next_heartbeat_due:
          type: string
          format: date-time
          description: Время следующего ожидаемого heartbeat

    HeartbeatStatus:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        is_active:
          type: boolean
        last_heartbeat_at:
          type: string
          format: date-time
          nullable: true
        inactivity_timeout_seconds:
          type: integer
          description: Таймаут неактивности в секундах (5 минут)
        absolute_timeout_seconds:
          type: integer
          description: Абсолютный таймаут в секундах (24 часа)
        time_until_inactivity_timeout:
          type: integer
          description: Секунд до таймаута неактивности
        time_until_absolute_timeout:
          type: integer
          description: Секунд до абсолютного таймаута

    ReconnectRequest:
      type: object
      required:
        - session_token
        - reconnection_token
      properties:
        session_token:
          type: string
          description: Токен сессии
        reconnection_token:
          type: string
          description: Токен переподключения
        ip_address:
          type: string
          format: ipv4
          description: IP адрес клиента

    ReconnectResponse:
      type: object
      properties:
        session:
          $ref: '#/components/schemas/Session'
        state_restored:
          type: boolean
          description: Было ли восстановлено состояние
        reconnected_at:
          type: string
          format: date-time

    ReconnectStatus:
      type: object
      properties:
        can_reconnect:
          type: boolean
        reconnection_window_seconds:
          type: integer
          description: Окно переподключения в секундах (5 минут)
        time_until_window_expires:
          type: integer
          description: Секунд до истечения окна переподключения
        session_state:
          $ref: '#/components/schemas/SessionState'

    SessionStateData:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        state:
          $ref: '#/components/schemas/SessionState'
        state_data:
          type: object
          description: Данные состояния (JSON)
        cached_in_redis:
          type: boolean
          description: Кэшировано ли в Redis
        last_synced_at:
          type: string
          format: date-time
          nullable: true
          description: Время последней синхронизации с БД

    UpdateSessionStateRequest:
      type: object
      required:
        - state_data
      properties:
        state_data:
          type: object
          description: Данные состояния для обновления (JSON)
        sync_to_db:
          type: boolean
          description: Синхронизировать ли с БД немедленно
          default: false

    CleanupResult:
      type: object
      properties:
        expired_sessions_cleaned:
          type: integer
          description: Количество очищенных истекших сессий
        old_sessions_cleaned:
          type: integer
          description: Количество очищенных старых сессий (старше 7 дней)
        redis_keys_cleaned:
          type: integer
          description: Количество очищенных ключей Redis
        resources_freed:
          type: array
          items:
            type: object
            properties:
              resource_type:
                type: string
                enum:
                  - party
                  - combat
                  - trade
              resource_count:
                type: integer
          description: Освобожденные ресурсы
        cleanup_duration_ms:
          type: integer
          description: Время выполнения очистки в миллисекундах

    CleanupStats:
      type: object
      properties:
        total_sessions:
          type: integer
        active_sessions:
          type: integer
        expired_sessions:
          type: integer
        old_sessions:
          type: integer
          description: Сессии старше 7 дней
        last_cleanup_at:
          type: string
          format: date-time
          nullable: true
        next_cleanup_at:
          type: string
          format: date-time
          nullable: true

    SecurityValidationRequest:
      type: object
      required:
        - session_id
        - ip_address
      properties:
        session_id:
          type: string
          format: uuid
        ip_address:
          type: string
          format: ipv4
          description: IP адрес для проверки
        token:
          type: string
          description: Токен для проверки

    SecurityValidationResult:
      type: object
      properties:
        is_valid:
          type: boolean
        ip_match:
          type: boolean
          description: Совпадает ли IP адрес
        token_valid:
          type: boolean
          description: Валиден ли токен
        rate_limit_ok:
          type: boolean
          description: Не превышен ли rate limit
        security_score:
          type: integer
          description: Оценка безопасности (0-100)
          minimum: 0
          maximum: 100
        warnings:
          type: array
          items:
            type: string
          description: Предупреждения безопасности

    TokenRotationResult:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        old_token:
          type: string
          description: Старый токен (для логирования)
        new_token:
          type: string
          description: Новый токен
        rotated_at:
          type: string
          format: date-time

    MonitoringStats:
      type: object
      properties:
        time_range:
          type: string
        total_sessions:
          type: integer
          description: Общее количество сессий
        active_sessions:
          type: integer
          description: Активные сессии
        created_sessions:
          type: integer
          description: Созданные сессии
        closed_sessions:
          type: integer
          description: Закрытые сессии
        reconnections:
          type: integer
          description: Количество переподключений
        timeouts:
          type: integer
          description: Количество таймаутов
        errors:
          type: integer
          description: Количество ошибок
        sessions_by_state:
          type: object
          additionalProperties:
            type: integer
          description: Количество сессий по состояниям
        trends:
          type: object
          description: Тренды сессий

    TerminateSessionRequest:
      type: object
      required:
        - session_id
        - reason
      properties:
        session_id:
          type: string
          format: uuid
        reason:
          type: string
          description: Причина принудительного закрытия
        notify_player:
          type: boolean
          description: Уведомить ли игрока
          default: true

