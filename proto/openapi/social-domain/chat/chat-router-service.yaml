openapi: 3.0.3
info:
  title: Chat Router Service API
  description: 'API для маршрутизации сообщений чата в обновленной архитектуре 2025.


    **Основные возможности:**

    - WebSocket connection management с health monitoring

    - Message routing по каналам с load balancing

    - Real-time broadcasting с оптимизацией

    - Rate limiting на уровне соединений

    - Cross-region message routing


    **Производительность:** P99 <50ms, 100k+ msg/sec

    '
  version: 2.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necp.game
servers:
- url: http://localhost:8085/api/v1
  description: Chat Router Service (локальная разработка)
- url: https://chat-router.necpgame.com/api/v1
  description: Chat Router Service (продакшен)
tags:
- name: Connection Management
  description: Управление WebSocket соединениями
- name: Message Routing
  description: Маршрутизация сообщений
- name: Broadcasting
  description: Широковещательная рассылка
- name: Health Monitoring
  description: Мониторинг здоровья сервиса
paths:
  /chat/ws:
    get:
      tags:
      - Connection Management
      summary: WebSocket соединение для чата
      description: 'Устанавливает WebSocket соединение для real-time коммуникации.


        **Протокол:**

        - JSON-RPC 2.0 over WebSocket

        - Heartbeat каждые 30 секунд

        - Automatic reconnection support

        - Message compression (gzip)


        **Rate Limits:**

        - 100 messages/minute per connection

        - Automatic throttling on overload

        '
      operationId: websocketConnection
      parameters:
      - name: token
        in: query
        required: true
        schema:
          type: string
          description: JWT токен аутентификации
      - name: client_version
        in: query
        required: true
        schema:
          type: string
          description: Версия клиента (для совместимости)
      - name: region
        in: query
        required: false
        schema:
          type: string
          description: Предпочитаемый регион (auto-detected)
      responses:
        '101':
          description: WebSocket upgrade successful
        '400':
          $ref: common.yaml#/components/responses/BadRequest
        '401':
          $ref: common.yaml#/components/responses/Unauthorized
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
  /chat/router/route:
    post:
      tags:
      - Message Routing
      summary: Маршрутизировать сообщение
      description: 'Маршрутизирует сообщение в соответствующие каналы с учетом permissions,

        load balancing и cross-region delivery.

        '
      operationId: routeMessage
      security:
      - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RouteMessageRequest'
      responses:
        '200':
          description: Сообщение маршрутизировано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RouteMessageResponse'
        '400':
          $ref: common.yaml#/components/responses/BadRequest
        '401':
          $ref: common.yaml#/components/responses/Unauthorized
        '403':
          $ref: common.yaml#/components/responses/Forbidden
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
  /chat/router/broadcast:
    post:
      tags:
      - Broadcasting
      summary: Глобальная широковещательная рассылка
      description: 'Отправляет сообщение всем подключенным клиентам или группе клиентов.

        Используется для системных announcements и emergency broadcasts.

        '
      operationId: broadcastMessage
      security:
      - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BroadcastRequest'
      responses:
        '200':
          description: Broadcast отправлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastResponse'
        '400':
          $ref: common.yaml#/components/responses/BadRequest
        '401':
          $ref: common.yaml#/components/responses/Unauthorized
        '403':
          $ref: common.yaml#/components/responses/Forbidden
  /chat/router/connections:
    get:
      tags:
      - Connection Management
      summary: Получить статистику соединений
      description: Возвращает статистику активных WebSocket соединений
      operationId: getConnectionStats
      security:
      - BearerAuth: []
      responses:
        '200':
          description: Статистика соединений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionStats'
        '401':
          $ref: common.yaml#/components/responses/Unauthorized
        '403':
          $ref: common.yaml#/components/responses/Forbidden
  /chat/health:
    get:
      tags:
      - Health Monitoring
      summary: Health check сервиса
      description: 'Проверяет здоровье Chat Router Service и зависимостей.

        Используется Kubernetes liveness/readiness probes.

        '
      operationId: healthCheck
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
components:
  securitySchemes:
    BearerAuth:
      $ref: common.yaml#/components/securitySchemes/BearerAuth
  schemas:
    RouteMessageRequest:
      type: object
      required:
      - message
      - channel_id
      properties:
        channel_id:
          type: string
          format: uuid
          description: ID канала назначения
        priority:
          type: string
          enum:
          - low
          - normal
          - high
          - critical
          default: normal
          description: Приоритет доставки
        message:
          $ref: '#/components/schemas/ChatMessage'
        ttl_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          default: 300
          description: Time-to-live в секундах
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    RouteMessageResponse:
      type: object
      properties:
        message_id:
          type: string
          format: uuid
          description: Уникальный ID сообщения
        routed_at:
          type: string
          format: date-time
          description: Время маршрутизации
        routing_regions:
          type: array
          items:
            type: string
          description: Регионы, куда отправлено сообщение
        recipient_count:
          type: integer
          description: Количество получателей
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    BroadcastRequest:
      type: object
      required:
      - message
      - scope
      properties:
        scope:
          type: string
          enum:
          - global
          - region
          - shard
          - channel
          description: Область вещания
        message:
          $ref: '#/components/schemas/ChatMessage'
        target_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Конкретные IDs для targeted broadcast (optional)
        exclude_ids:
          type: array
          items:
            type: string
            format: uuid
          description: IDs для исключения из broadcast
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    BroadcastResponse:
      type: object
      properties:
        broadcast_id:
          type: string
          format: uuid
        sent_at:
          type: string
          format: date-time
        regions_reached:
          type: array
          items:
            type: string
        total_recipients:
          type: integer
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    ChatMessage:
      type: object
      required:
      - sender_id
      - content
      - message_type
      properties:
        sender_id:
          type: string
          format: uuid
        sender_name:
          type: string
        content:
          type: string
          maxLength: 2000
        message_type:
          type: string
          enum:
          - text
          - emoji
          - system
          - command
        formatting:
          type: object
          properties:
            bold:
              type: array
              items:
                type: array
                items:
                  type: integer
                minItems: 2
                maxItems: 2
            italic:
              type: array
              items:
                type: array
                items:
                  type: integer
                minItems: 2
                maxItems: 2
            links:
              type: array
              items:
                type: object
                properties:
                  url:
                    type: string
                  text:
                    type: string
                  start:
                    type: integer
                  end:
                    type: integer
        metadata:
          type: object
          description: Дополнительные метаданные (translation, sentiment, etc.)
        mentions:
          type: array
          items:
            type: object
            properties:
              user_id:
                type: string
                format: uuid
              username:
                type: string
              position:
                type: integer
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    ConnectionStats:
      type: object
      properties:
        connections_by_region:
          type: object
          additionalProperties:
            type: integer
        connections_by_client_version:
          type: object
          additionalProperties:
            type: integer
        total_connections:
          type: integer
        active_connections:
          type: integer
        peak_connections_last_hour:
          type: integer
        average_connection_duration_seconds:
          type: number
          format: float
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    HealthStatus:
      type: object
      properties:
        version:
          type: string
        status:
          type: string
          enum:
          - healthy
          - degraded
          - unhealthy
        last_health_check:
          type: string
          format: date-time
        dependencies:
          type: object
          properties:
            redis:
              type: string
              enum:
              - up
              - down
              - degraded
            kafka:
              type: string
              enum:
              - up
              - down
              - degraded
            database:
              type: string
              enum:
              - up
              - down
              - degraded
        uptime_seconds:
          type: integer
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    RateLimitError:
      type: object
      properties:
        error:
          type: string
          enum:
          - rate_limit_exceeded
        reset_at:
          type: string
          format: date-time
        retry_after_seconds:
          type: integer
        limit:
          type: integer
        remaining:
          type: integer
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
security:
- BearerAuth: []
