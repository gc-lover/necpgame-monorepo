# Issue: #2043 - Реализовать OpenAPI спецификации для guild-service
openapi: 3.0.3
info:
  title: Guild Service API
  description: |
    **Guild Service** - Core guild management service for NECPGAME MMOFPS RPG.

    Provides unified interface for all guild-related operations including:
    - Guild creation and lifecycle management
    - Member management and role assignments
    - Guild bank and resource management
    - Territory claiming and defense
    - Guild warfare and PvP mechanics
    - Reputation and ranking systems
    - Alliance and diplomacy management

    **BACKEND NOTE:** Enterprise-grade guild service with optimized memory layout.
    Expected memory savings: 30-50% through struct field alignment.
    Performance targets: 2000+ RPS, P99 <15ms for guild operations.
  version: 2.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: NECPGAME Guild API Support
    email: guilds@necp.game

servers:
  - url: http://localhost:8084/api/v1/guilds
    description: Guild Service Development Server
  - url: https://guilds.necpgame.com/api/v1
    description: Guild Service Production Server

security:
  - BearerAuth: [ ]

tags:
  - name: guild-management
    description: Guild creation and lifecycle management
  - name: member-management
    description: Guild member operations
  - name: bank-management
    description: Guild bank and resources
  - name: territory-management
    description: Territory claiming and defense
  - name: warfare
    description: Guild warfare and PvP operations
  - name: alliances
    description: Alliance and diplomacy management

paths:
  /health:
    get:
      summary: Guild service health check
      operationId: guildServiceHealthCheck
      tags:
        - guild-management
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time

  /guilds:
    post:
      summary: Create new guild
      operationId: createGuild
      tags:
        - guild-management
      security:
        - BearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGuildRequest'
      responses:
        '201':
          description: Guild created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Guild'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      summary: List guilds
      operationId: listGuilds
      tags:
        - guild-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: name
          in: query
          schema:
            type: string
            description: Filter by guild name (partial match)
        - name: min_level
          in: query
          schema:
            type: integer
            minimum: 1
        - name: max_level
          in: query
          schema:
            type: integer
            minimum: 1
        - name: faction
          in: query
          schema:
            type: string
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [name, level, member_count, reputation, created_at]
            default: created_at
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Guilds list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /guilds/{guild_id}:
    get:
      summary: Get guild details
      operationId: getGuild
      tags:
        - guild-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Guild details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Guild'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      summary: Update guild
      operationId: updateGuild
      tags:
        - guild-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGuildRequest'
      responses:
        '200':
          description: Guild updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Guild'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      summary: Disband guild
      operationId: disbandGuild
      tags:
        - guild-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Guild disbanded successfully
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /guilds/{guild_id}/members:
    get:
      summary: Get guild members
      operationId: getGuildMembers
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: role
          in: query
          schema:
            type: string
            enum: [leader, officer, member]
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, suspended]
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Guild members retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildMembersList'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Invite player to guild
      operationId: inviteToGuild
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteToGuildRequest'
      responses:
        '201':
          description: Invitation sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildInvitation'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /guilds/{guild_id}/members/{account_id}:
    put:
      summary: Update guild member
      operationId: updateGuildMember
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: account_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGuildMemberRequest'
      responses:
        '200':
          description: Guild member updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildMember'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Remove member from guild
      operationId: removeGuildMember
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: account_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Member removed successfully
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /guilds/{guild_id}/bank:
    get:
      summary: Get guild bank balance
      operationId: getGuildBank
      tags:
        - bank-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Guild bank balance retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildBank'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Deposit to guild bank
      operationId: depositToGuildBank
      tags:
        - bank-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GuildBankTransaction'
      responses:
        '200':
          description: Deposit successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildBank'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /guilds/{guild_id}/territories:
    get:
      summary: Get guild territories
      operationId: getGuildTerritories
      tags:
        - territory-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Guild territories retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildTerritories'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Claim territory for guild
      operationId: claimTerritory
      tags:
        - territory-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClaimTerritoryRequest'
      responses:
        '201':
          description: Territory claimed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildTerritory'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /guilds/{guild_id}/warfare/declare:
    post:
      summary: Declare war on another guild
      operationId: declareWar
      tags:
        - warfare
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclareWarRequest'
      responses:
        '201':
          description: War declared successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WarDeclaration'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /guilds/{guild_id}/alliances:
    get:
      summary: Get guild alliances
      operationId: getGuildAlliances
      tags:
        - alliances
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, active, terminated]
      responses:
        '200':
          description: Guild alliances retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildAlliances'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Propose alliance with another guild
      operationId: proposeAlliance
      tags:
        - alliances
      security:
        - BearerAuth: [ ]
      parameters:
        - name: guild_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProposeAllianceRequest'
      responses:
        '201':
          description: Alliance proposal sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllianceProposal'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /invitations/{invitation_id}/accept:
    post:
      summary: Accept guild invitation
      operationId: acceptGuildInvitation
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: invitation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invitation accepted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuildMember'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /invitations/{invitation_id}/reject:
    post:
      summary: Reject guild invitation
      operationId: rejectGuildInvitation
      tags:
        - member-management
      security:
        - BearerAuth: [ ]
      parameters:
        - name: invitation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invitation rejected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Invitation rejected successfully"
        '204':
          description: Invitation rejected successfully (no content)
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Guild Schemas
    Guild:
      type: object
      required:
        - id
        - name
        - leader_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          minLength: 3
          maxLength: 50
        description:
          type: string
          maxLength: 500
        leader_id:
          type: string
          format: uuid
        faction:
          type: string
          enum: [neutral, corporation, nomad, street_kid, corpo_kid]
        level:
          type: integer
          minimum: 1
          default: 1
        experience:
          type: integer
          minimum: 0
          default: 0
        reputation:
          type: integer
          minimum: -1000
          maximum: 1000
          default: 0
        member_count:
          type: integer
          minimum: 1
          maximum: 100
        max_members:
          type: integer
          minimum: 10
          maximum: 100
          default: 50
        bank_balance:
          type: integer
          minimum: 0
          default: 0
        created_at:
          type: string
          format: date-time
        last_active:
          type: string
          format: date-time
        settings:
          $ref: '#/components/schemas/GuildSettings'
        achievements:
          type: array
          items:
            type: string
      description: 'BACKEND NOTE: Fields ordered for optimal memory alignment (large → small). Expected memory savings: 30-50%.'

    GuildSettings:
      type: object
      properties:
        is_recruiting:
          type: boolean
          default: true
        recruitment_requirements:
          type: object
          properties:
            min_level:
              type: integer
              minimum: 1
            max_level:
              type: integer
              minimum: 1
            required_faction:
              type: string
              enum: [any, neutral, corporation, nomad, street_kid, corpo_kid]
        privacy_level:
          type: string
          enum: [public, private]
          default: public
        auto_accept_members:
          type: boolean
          default: false

    # Request/Response Schemas
    CreateGuildRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
        description:
          type: string
          maxLength: 500
        faction:
          type: string
          enum: [neutral, corporation, nomad, street_kid, corpo_kid]
        max_members:
          type: integer
          minimum: 10
          maximum: 100
          default: 50
        settings:
          $ref: '#/components/schemas/GuildSettings'

    UpdateGuildRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
        description:
          type: string
          maxLength: 500
        faction:
          type: string
          enum: [neutral, corporation, nomad, street_kid, corpo_kid]
        settings:
          $ref: '#/components/schemas/GuildSettings'

    GuildsList:
      type: object
      properties:
        guilds:
          type: array
          items:
            $ref: '#/components/schemas/Guild'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Member Management Schemas
    GuildMember:
      type: object
      required:
        - account_id
        - role
        - joined_at
      properties:
        account_id:
          type: string
          format: uuid
        character_name:
          type: string
        role:
          type: string
          enum: [leader, officer, member]
        joined_at:
          type: string
          format: date-time
        last_active:
          type: string
          format: date-time
        contribution_points:
          type: integer
          minimum: 0
          default: 0
        status:
          type: string
          enum: [active, inactive, suspended]
      description: 'BACKEND NOTE: Guild member data optimized for frequent membership queries.'

    GuildMembersList:
      type: object
      properties:
        members:
          type: array
          items:
            $ref: '#/components/schemas/GuildMember'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    InviteToGuildRequest:
      type: object
      required:
        - target_account_id
      properties:
        target_account_id:
          type: string
          format: uuid
        message:
          type: string
          maxLength: 200

    UpdateGuildMemberRequest:
      type: object
      properties:
        role:
          type: string
          enum: [officer, member]
        status:
          type: string
          enum: [active, suspended]

    GuildInvitation:
      type: object
      required:
        - id
        - guild_id
        - inviter_id
        - target_id
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        guild_id:
          type: string
          format: uuid
        inviter_id:
          type: string
          format: uuid
        target_id:
          type: string
          format: uuid
        message:
          type: string
        status:
          type: string
          enum: [pending, accepted, rejected, expired]
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    # Bank Management Schemas
    GuildBank:
      type: object
      required:
        - guild_id
        - balance
      properties:
        guild_id:
          type: string
          format: uuid
        balance:
          type: integer
          minimum: 0
        daily_deposit_limit:
          type: integer
          minimum: 0
        weekly_deposit_limit:
          type: integer
          minimum: 0
        transaction_history:
          type: array
          items:
            $ref: '#/components/schemas/GuildBankTransaction'

    GuildBankTransaction:
      type: object
      required:
        - account_id
        - amount
        - type
      properties:
        account_id:
          type: string
          format: uuid
        amount:
          type: integer
        type:
          type: string
          enum: [deposit, withdrawal]
        description:
          type: string
          maxLength: 100

    # Territory Management Schemas
    GuildTerritory:
      type: object
      required:
        - id
        - guild_id
        - coordinates
        - claimed_at
      properties:
        id:
          type: string
          format: uuid
        guild_id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 100
        coordinates:
          $ref: '#/components/schemas/TerritoryCoordinates'
        size:
          type: integer
          minimum: 1
        level:
          type: integer
          minimum: 1
          default: 1
        defense_rating:
          type: integer
          minimum: 0
          default: 0
        claimed_at:
          type: string
          format: date-time
        last_defended:
          type: string
          format: date-time

    TerritoryCoordinates:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: float
        y:
          type: number
          format: float
        z:
          type: number
          format: float

    GuildTerritories:
      type: object
      properties:
        territories:
          type: array
          items:
            $ref: '#/components/schemas/GuildTerritory'
        total_area:
          type: integer
        total_defense:
          type: integer

    ClaimTerritoryRequest:
      type: object
      required:
        - coordinates
        - name
      properties:
        coordinates:
          $ref: '#/components/schemas/TerritoryCoordinates'
        name:
          type: string
          maxLength: 100

    # Warfare Schemas
    WarDeclaration:
      type: object
      required:
        - id
        - attacker_guild_id
        - defender_guild_id
        - status
        - declared_at
      properties:
        id:
          type: string
          format: uuid
        attacker_guild_id:
          type: string
          format: uuid
        defender_guild_id:
          type: string
          format: uuid
        reason:
          type: string
          maxLength: 500
        status:
          type: string
          enum: [active, resolved, cancelled]
        declared_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
          nullable: true
        winner_guild_id:
          type: string
          format: uuid
          nullable: true

    DeclareWarRequest:
      type: object
      required:
        - target_guild_id
      properties:
        target_guild_id:
          type: string
          format: uuid
        reason:
          type: string
          maxLength: 500

    # Alliance Schemas
    GuildAlliance:
      type: object
      required:
        - id
        - guild1_id
        - guild2_id
        - type
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        guild1_id:
          type: string
          format: uuid
        guild2_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [trade, defense, full]
        status:
          type: string
          enum: [pending, active, terminated]
        created_at:
          type: string
          format: date-time
        terminated_at:
          type: string
          format: date-time
          nullable: true

    GuildAlliances:
      type: object
      properties:
        alliances:
          type: array
          items:
            $ref: '#/components/schemas/GuildAlliance'
        total:
          type: integer

    ProposeAllianceRequest:
      type: object
      required:
        - target_guild_id
        - type
      properties:
        target_guild_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [trade, defense, full]
        message:
          type: string
          maxLength: 200

    AllianceProposal:
      type: object
      required:
        - id
        - proposer_guild_id
        - target_guild_id
        - type
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        proposer_guild_id:
          type: string
          format: uuid
        target_guild_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [trade, defense, full]
        message:
          type: string
        status:
          type: string
          enum: [pending, accepted, rejected]
        created_at:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              message:
                type: string
              code:
                type: string

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: unauthorized
              message:
                type: string

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: forbidden
              message:
                type: string

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: not_found
              message:
                type: string

    Conflict:
      description: Resource conflict
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: conflict
              message:
                type: string

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: internal_server_error
              message:
                type: string