openapi: 3.0.3
info:
  title: Stock Analytics Tools Service API
  description: |
    API для инструментов аналитики и дашбордов фондовой биржи NECPGAME.
    
    **Основные возможности:**
    - Тепловые карты секторов
    - Стаканы заявок (order book)
    - Система алертов
    - Портфельный дашборд
    - Обзор рынка
    - Центр оповещений
    
    **Инструменты:**
    - Heatmap для визуализации секторов
    - Order book для анализа глубины
    - Alerts для пользовательских условий
    
    **Интеграции:**
    - notification-service для доставки алертов
    - economy-events для аннотаций событий
    - economy-investments для рекомендаций
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necpgame.com

servers:
  - url: http://localhost:8080
    description: Analytics Service (локальная разработка)
  - url: https://analytics.necpgame.com
    description: Analytics Service (продакшн)

tags:
  - name: Tools
    description: Дополнительные инструменты
  - name: Alerts
    description: Алерты
  - name: Dashboards
    description: Дашборды

paths:
  /api/v1/analytics/heatmap:
    get:
      tags:
        - Tools
      summary: Тепловая карта секторов
      description: |
        Возвращает тепловую карту для визуализации производительности секторов.
        
        **Данные:**
        - Изменение цены по секторам (%)
        - Объём торгов
        - Количество тикеров в секторе
        
        **Использование:**
        - Быстрая оценка рынка
        - Выявление трендов по секторам
        - Корреляционный анализ
      operationId: getHeatmap
      parameters:
        - name: period
          in: query
          required: true
          schema:
            type: string
            enum: [1d, 1w, 1m]
          description: Период (день, неделя, месяц)
      responses:
        "200":
          description: Тепловая карта
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Heatmap"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/analytics/orderbook/{ticker}:
    get:
      tags:
        - Tools
      summary: Стакан заявок
      description: |
        Возвращает данные стакана заявок (order book).
        
        **Данные:**
        - Лучшие bid/ask заявки
        - Глубина стакана
        - Spread (разница между bid и ask)
        
        **Использование:**
        - Анализ ликвидности
        - Определение уровней поддержки/сопротивления
        - Оценка spread для торговли
      operationId: getOrderBook
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
        - name: depth
          in: query
          schema:
            type: integer
            default: 10
          description: Глубина стакана (количество уровней)
      responses:
        "200":
          description: Стакан заявок
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderBook"
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/analytics/alerts:
    post:
      tags:
        - Alerts
      summary: Создать алерт
      description: |
        Создаёт алерт по пользовательским условиям.
        
        **Типы условий:**
        - price_above - цена выше порога
        - price_below - цена ниже порога
        - rsi_above - RSI выше порога (>70 перекупленность)
        - rsi_below - RSI ниже порога (<30 перепроданность)
        - volume_spike - всплеск объёма торгов
        
        **Каналы уведомлений:**
        - in_game - внутриигровое уведомление
        - email - email уведомление
        - push - push уведомление
      operationId: createAlert
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAlertRequest"
      responses:
        "201":
          description: Алерт создан
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alert"
        "400":
          $ref: "common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

    get:
      tags:
        - Alerts
      summary: Список алертов
      description: Возвращает алерты игрока с фильтрацией по активности
      operationId: listAlerts
      parameters:
        - name: active_only
          in: query
          schema:
            type: boolean
            default: true
          description: Только активные алерты
        - $ref: "common.yaml#/components/parameters/Limit"
        - $ref: "common.yaml#/components/parameters/Offset"
      responses:
        "200":
          description: Список алертов
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: "#/components/schemas/Alert"
                  pagination:
                    $ref: "common.yaml#/components/schemas/PaginationResponse"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/analytics/alerts/{alert_id}:
    delete:
      tags:
        - Alerts
      summary: Удалить алерт
      description: Удаляет алерт из системы
      operationId: deleteAlert
      parameters:
        - name: alert_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Алерт удалён
        "404":
          $ref: "common.yaml#/components/responses/NotFound"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/analytics/dashboards/portfolio:
    get:
      tags:
        - Dashboards
      summary: Портфельный дашборд
      description: |
        Возвращает дашборд портфеля игрока.
        
        **Данные:**
        - P&L (Profit & Loss) - прибыль/убыток
        - Распределение активов по секторам
        - Риски портфеля
        - Топ позиций (лучшие/худшие)
        
        **Использование:**
        - Мониторинг портфеля
        - Диверсификация
        - Risk management
      operationId: getPortfolioDashboard
      responses:
        "200":
          description: Портфельный дашборд
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortfolioDashboard"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

  /api/v1/analytics/dashboards/market:
    get:
      tags:
        - Dashboards
      summary: Обзор рынка
      description: |
        Возвращает обзор рынка.
        
        **Данные:**
        - Лидеры роста (top gainers)
        - Лидеры падения (top losers)
        - События рынка (market events)
        - Объём торгов (total volume)
        
        **Использование:**
        - Быстрый обзор рынка
        - Выявление трендов
        - Мониторинг событий
      operationId: getMarketDashboard
      responses:
        "200":
          description: Обзор рынка
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketDashboard"
        "401":
          $ref: "common.yaml#/components/responses/Unauthorized"
      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      $ref: "common.yaml#/components/securitySchemes/BearerAuth"

  schemas:
    Heatmap:
      type: object
      properties:
        period:
          type: string
          description: Период
        sectors:
          type: array
          items:
            type: object
            properties:
              sector:
                type: string
                description: Название сектора
              change_percent:
                type: number
                description: Изменение в %
              volume:
                type: integer
                description: Объём торгов
              tickers_count:
                type: integer
                description: Количество тикеров

    OrderBook:
      type: object
      properties:
        ticker:
          type: string
          description: Тикер акции
        bids:
          type: array
          items:
            $ref: "#/components/schemas/Order"
          description: Заявки на покупку
        asks:
          type: array
          items:
            $ref: "#/components/schemas/Order"
          description: Заявки на продажу
        spread:
          type: number
          description: Разница между лучшими bid и ask

    Order:
      type: object
      properties:
        price:
          type: number
          description: Цена заявки
        quantity:
          type: integer
          description: Количество акций

    CreateAlertRequest:
      type: object
      required:
        - ticker
        - condition_type
        - threshold
      properties:
        ticker:
          type: string
          description: Тикер акции
        condition_type:
          type: string
          enum: [price_above, price_below, rsi_above, rsi_below, volume_spike]
          description: Тип условия
        threshold:
          type: number
          description: Пороговое значение
        notification_channel:
          type: string
          enum: [in_game, email, push]
          description: Канал уведомления

    Alert:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID алерта
        player_id:
          type: string
          format: uuid
          description: ID игрока
        ticker:
          type: string
          description: Тикер акции
        condition_type:
          type: string
          description: Тип условия
        threshold:
          type: number
          description: Пороговое значение
        is_active:
          type: boolean
          description: Активен ли алерт
        triggered_at:
          type: string
          format: date-time
          description: Время срабатывания
        created_at:
          type: string
          format: date-time
          description: Время создания

    PortfolioDashboard:
      type: object
      properties:
        total_value:
          type: number
          description: Общая стоимость портфеля
        pnl:
          type: number
          description: Прибыль/убыток
        pnl_percent:
          type: number
          description: Прибыль/убыток в %
        asset_distribution:
          type: array
          items:
            type: object
          description: Распределение активов
        top_positions:
          type: array
          items:
            type: object
          description: Топ позиций
        risk_metrics:
          type: object
          description: Метрики риска

    MarketDashboard:
      type: object
      properties:
        top_gainers:
          type: array
          items:
            type: object
          description: Лидеры роста
        top_losers:
          type: array
          items:
            type: object
          description: Лидеры падения
        market_events:
          type: array
          items:
            type: object
          description: События рынка
        total_volume:
          type: integer
          description: Общий объём торгов

