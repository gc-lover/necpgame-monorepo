# Circuit breaker management schemas
# Issue: #2068

components:
  schemas:
    # Circuit breaker entity - memory optimized
    CircuitBreaker:
      type: object
      required:
        - circuit_breaker_id
        - service_name
        - endpoint
        - state
        - created_at
        - failure_threshold
        - recovery_timeout_seconds
        - monitoring_window_seconds
      properties:
        # Large types first
        circuit_breaker_id:
          type: string
          format: uuid
          description: Unique circuit breaker identifier
          example: "550e8400-e29b-41d4-a716-446655440000"

        service_name:
          type: string
          description: Name of the protected service
          example: "guild-service"

        endpoint:
          type: string
          description: Protected endpoint or service method
          example: "/api/v1/guilds/{guild_id}/members"

        fallback_service:
          type: string
          description: Optional fallback service for graceful degradation
          example: "guild-cache-service"

        fallback_endpoint:
          type: string
          description: Optional fallback endpoint
          example: "/api/v1/guilds/cache/{guild_id}/members"

        created_at:
          type: string
          format: date-time
          description: Circuit breaker creation timestamp
          example: "2025-12-20T21:40:00Z"

        last_state_change:
          type: string
          format: date-time
          description: Last state transition timestamp
          example: "2025-12-20T21:45:30Z"

        # Medium types
        state:
          type: string
          enum: [closed, open, half_open]
          description: Current circuit breaker state
          example: "closed"

        failure_count:
          type: integer
          minimum: 0
          description: Current consecutive failure count
          example: 0

        success_count:
          type: integer
          minimum: 0
          description: Current consecutive success count
          example: 15

        total_requests:
          type: integer
          minimum: 0
          description: Total requests processed
          example: 12500

        total_failures:
          type: integer
          minimum: 0
          description: Total failures recorded
          example: 125

        # Small types
        failure_threshold:
          type: integer
          minimum: 1
          maximum: 100
          description: Failure threshold to open circuit
          example: 5

        success_threshold:
          type: integer
          minimum: 1
          maximum: 100
          description: Success threshold to close circuit
          example: 3

        recovery_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          description: Time before attempting recovery
          example: 60

        monitoring_window_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          description: Time window for failure counting
          example: 60

        timeout_milliseconds:
          type: integer
          minimum: 1
          maximum: 30000
          description: Request timeout in milliseconds
          example: 5000

        max_concurrent_requests:
          type: integer
          minimum: 1
          maximum: 1000
          description: Maximum concurrent requests when half-open
          example: 10

    # Create circuit breaker request
    CreateCircuitBreakerRequest:
      type: object
      required:
        - service_name
        - endpoint
        - failure_threshold
        - recovery_timeout_seconds
        - monitoring_window_seconds
      properties:
        service_name:
          type: string
          description: Name of the service to protect
          example: "guild-service"
        endpoint:
          type: string
          description: Specific endpoint or method to protect
          example: "/api/v1/guilds/{guild_id}/members"
        failure_threshold:
          type: integer
          minimum: 1
          maximum: 100
          default: 5
          description: Consecutive failures to trigger open state
        success_threshold:
          type: integer
          minimum: 1
          maximum: 100
          default: 3
          description: Consecutive successes to close circuit
        recovery_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          default: 60
          description: Time to wait before trying half-open
        monitoring_window_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          default: 60
          description: Time window for failure counting
        timeout_milliseconds:
          type: integer
          minimum: 1
          maximum: 30000
          default: 5000
          description: Request timeout
        max_concurrent_requests:
          type: integer
          minimum: 1
          maximum: 1000
          default: 10
          description: Max concurrent requests in half-open state
        fallback_service:
          type: string
          description: Optional fallback service for graceful degradation
        fallback_endpoint:
          type: string
          description: Optional fallback endpoint

    # Update circuit breaker request
    UpdateCircuitBreakerRequest:
      type: object
      properties:
        failure_threshold:
          type: integer
          minimum: 1
          maximum: 100
          description: New failure threshold
        success_threshold:
          type: integer
          minimum: 1
          maximum: 100
          description: New success threshold
        recovery_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          description: New recovery timeout
        monitoring_window_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          description: New monitoring window
        timeout_milliseconds:
          type: integer
          minimum: 1
          maximum: 30000
          description: New request timeout
        max_concurrent_requests:
          type: integer
          minimum: 1
          maximum: 1000
          description: New max concurrent requests
        fallback_service:
          type: string
          description: Update fallback service
        fallback_endpoint:
          type: string
          description: Update fallback endpoint

    # Circuit breaker list response
    CircuitBreakerListResponse:
      type: object
      required:
        - circuit_breakers
        - total_count
      properties:
        circuit_breakers:
          type: array
          items:
            $ref: '#/components/schemas/CircuitBreaker'
          description: List of circuit breakers
        total_count:
          type: integer
          minimum: 0
          description: Total number of circuit breakers
        limit:
          type: integer
          description: Items per page
        offset:
          type: integer
          description: Items skipped

    # Manual state control request
    StateControlRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [open, close, reset]
          description: State control action
          example: "open"
        reason:
          type: string
          maxLength: 500
          description: Reason for manual intervention
          example: "Emergency maintenance window"
        force:
          type: boolean
          default: false
          description: Force action even if conditions not met

    # Bulk state control request
    BulkStateControlRequest:
      type: object
      required:
        - circuit_breaker_ids
        - action
      properties:
        circuit_breaker_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 50
          description: Circuit breaker IDs to control
        action:
          type: string
          enum: [open, close, reset]
          description: Bulk state control action
        reason:
          type: string
          maxLength: 500
          description: Reason for bulk operation
        service_filter:
          type: string
          description: Optional service name filter

    # Bulk state control response
    BulkStateControlResponse:
      type: object
      required:
        - total_requested
        - successful
        - failed
      properties:
        total_requested:
          type: integer
          description: Total circuit breakers requested for control
        successful:
          type: integer
          description: Number of successful operations
        failed:
          type: integer
          description: Number of failed operations
        results:
          type: array
          items:
            type: object
            properties:
              circuit_breaker_id:
                type: string
                format: uuid
              success:
                type: boolean
              error:
                type: string
          description: Detailed results for each circuit breaker
