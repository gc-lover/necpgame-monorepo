# Event routing and delivery schemas
# Issue: #2048

components:
  schemas:
    # Event broadcast request
    EventBroadcastRequest:
      type: object
      required:
        - event_type
        - event_data
      properties:
        event_type:
          type: string
          maxLength: 200
          description: Event type identifier
          example: "combat.player_hit"

        event_data:
          type: object
          description: Event payload data
          additionalProperties: true
          example:
            player_id: "p1a2b3c4-d5e6-7890-1234-567890abcdef"
            target_id: "p5a6b7c8-d9e0-1234-5678-90abcdef1234"
            damage: 75.5
            weapon: "plasma_rifle"
            location: { x: 100.5, y: 200.1, z: 50.3 }

        priority:
          type: string
          enum: [low, normal, high, critical]
          default: "normal"
          description: Event delivery priority
          example: "high"

        ttl_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          default: 300
          description: Time-to-live for event delivery
          example: 60

        target_filters:
          type: object
          description: Optional filters to limit event delivery
          properties:
            user_ids:
              type: array
              items:
                type: string
                format: uuid
              description: Specific user IDs to target
              maxItems: 1000
            regions:
              type: array
              items:
                type: string
              description: Geographic regions to target
              example: ["us-east-1", "eu-west-1"]
            platforms:
              type: array
              items:
                type: string
                enum: [web, mobile, desktop]
              description: Client platforms to target
              example: ["web", "mobile"]
            subscription_patterns:
              type: array
              items:
                type: string
              description: Pattern filters for subscriptions
              example: ["combat.*", "social.chat"]

        metadata:
          type: object
          description: Additional event metadata
          additionalProperties: true
          example:
            source_service: "combat-service"
            correlation_id: "corr1a2b3c4-d5e6-7890-1234-567890abcdef"
            trace_id: "trace1a2b3c4-d5e6-7890-1234-567890abcdef"

        compression:
          type: boolean
          default: true
          description: Whether to compress event data

        deduplication_key:
          type: string
          maxLength: 100
          description: Key for event deduplication (optional)
          example: "combat_hit_p1a2b3c4_p5a6b7c8_1234567890"

    # Event broadcast response
    EventBroadcastResponse:
      type: object
      required:
        - event_id
        - status
        - estimated_recipients
      properties:
        event_id:
          type: string
          format: uuid
          description: Unique event identifier for tracking
          example: "evt1a2b3c4-d5e6-7890-1234-567890abcdef"

        status:
          type: string
          enum: [accepted, queued, rejected]
          description: Event processing status
          example: "accepted"

        estimated_recipients:
          type: integer
          minimum: 0
          description: Estimated number of recipients
          example: 2500

        processing_deadline:
          type: string
          format: date-time
          description: Deadline for event processing
          example: "2025-12-20T21:49:30Z"

        queue_position:
          type: integer
          minimum: 0
          description: Position in processing queue (if queued)
          example: 5

        rejection_reason:
          type: string
          description: Reason for rejection (if rejected)
          example: "Rate limit exceeded"

    # Event delivery status
    EventDeliveryStatus:
      type: object
      required:
        - event_id
        - event_type
        - status
        - created_at
        - recipients_total
      properties:
        event_id:
          type: string
          format: uuid
          description: Event identifier
          example: "evt1a2b3c4-d5e6-7890-1234-567890abcdef"

        event_type:
          type: string
          description: Event type
          example: "combat.player_hit"

        status:
          type: string
          enum: [processing, delivered, failed, expired]
          description: Overall delivery status
          example: "delivered"

        created_at:
          type: string
          format: date-time
          description: Event creation timestamp
          example: "2025-12-20T21:49:00Z"

        recipients_total:
          type: integer
          minimum: 0
          description: Total intended recipients
          example: 2500

        recipients_delivered:
          type: integer
          minimum: 0
          description: Successfully delivered to recipients
          example: 2485

        recipients_failed:
          type: integer
          minimum: 0
          description: Failed deliveries
          example: 15

        recipients_pending:
          type: integer
          minimum: 0
          description: Still pending delivery
          example: 0

        delivery_stats:
          type: object
          description: Detailed delivery statistics
          properties:
            avg_delivery_time_ms:
              type: number
              format: float
              description: Average delivery time
              example: 45.2
            min_delivery_time_ms:
              type: number
              format: float
              description: Minimum delivery time
              example: 12.5
            max_delivery_time_ms:
              type: number
              format: float
              description: Maximum delivery time
              example: 250.8
            delivery_rate_percent:
              type: number
              format: float
              minimum: 0
              maximum: 100
              description: Successful delivery rate
              example: 99.4
            retry_attempts_total:
              type: integer
              description: Total retry attempts across all deliveries
              example: 45

        failure_reasons:
          type: object
          description: Breakdown of failure reasons
          additionalProperties:
            type: integer
          example:
            "connection_closed": 8
            "timeout": 5
            "rate_limited": 2

        regional_delivery:
          type: object
          description: Delivery statistics by region
          additionalProperties:
            type: object
            properties:
              delivered: { type: integer }
              failed: { type: integer }
              avg_latency_ms: { type: number, format: float }
          example:
            "us-east-1":
              delivered: 1200
              failed: 5
              avg_latency_ms: 35.2
            "eu-west-1":
              delivered: 1285
              failed: 10
              avg_latency_ms: 55.8

        platform_delivery:
          type: object
          description: Delivery statistics by platform
          additionalProperties:
            type: object
            properties:
              delivered: { type: integer }
              failed: { type: integer }
          example:
            web: { delivered: 1800, failed: 8 }
            mobile: { delivered: 650, failed: 6 }
            desktop: { delivered: 35, failed: 1 }

        compression_stats:
          type: object
          description: Data compression statistics
          properties:
            original_size_bytes:
              type: integer
              description: Original event size
              example: 2048
            compressed_size_bytes:
              type: integer
              description: Compressed event size
              example: 512
            compression_ratio:
              type: number
              format: float
              description: Compression ratio achieved
              example: 0.25

    # Event delivery metrics
    EventDeliveryMetrics:
      type: object
      required:
        - timeframe
        - events_processed
        - delivery_success_rate
      properties:
        timeframe:
          type: string
          enum: [1m, 5m, 15m, 1h, 6h, 24h]
          description: Metrics timeframe

        events_processed:
          type: integer
          minimum: 0
          description: Total events processed
          example: 50000

        delivery_success_rate:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Overall delivery success rate
          example: 0.994

        avg_processing_time_ms:
          type: number
          format: float
          description: Average event processing time
          example: 25.5

        events_by_priority:
          type: object
          description: Events processed by priority level
          properties:
            low: { type: integer, example: 25000 }
            normal: { type: integer, example: 20000 }
            high: { type: integer, example: 4500 }
            critical: { type: integer, example: 500 }

        events_by_type:
          type: object
          description: Events processed by type
          additionalProperties:
            type: integer
          example:
            "combat.player_hit": 15000
            "social.chat_message": 20000
            "system.notification": 8000
            "economy.transaction": 7000

        delivery_failures_by_reason:
          type: object
          description: Delivery failures by reason
          additionalProperties:
            type: integer
          example:
            timeout: 150
            connection_lost: 85
            rate_limited: 45
            invalid_subscription: 20
