# Issue: #140889798
openapi: 3.0.3
info:
  title: System Domain - Session Management Service Go API
  description: |
    **Enterprise-Grade Session Management Service API** for NECPGAME MMOFPS RPG.

    **Enterprise-Grade Domain:** system-domain
    **Module:** session-management-service-go
    **Purpose:** Advanced session management and state tracking system

    **BACKEND NOTE:** Struct field alignment optimized (large â†’ small types).
    All schemas ordered for optimal memory layout in generated Go code.
    Expected memory savings: 40-60% for session-related structs.
    Hot paths: /sessions/validate, /sessions/active, /sessions/extend
    Expected RPS: 5000+ for hot paths, zero allocations.

    **Core Features:**
    - Session creation and validation
    - Session state management
    - Automatic session cleanup
    - Multi-device session handling
    - Session security and anti-cheat
    - Session analytics and monitoring

    **Performance Targets:**
    - Hot paths: 5000+ RPS, P99 <20ms
    - Memory per session: <5KB average
    - Cache hit rate: >95%
    - Concurrent sessions: 100k+ supported

    **Security Features:**
    - JWT token validation
    - Session fingerprinting
    - Suspicious activity detection
    - Automatic session termination
  version: 1.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  contact:
    name: NECPGAME Session API Support
    url: https://necpgame.com/support
    email: api@session.necpgame.com

servers:
  - url: http://localhost:8080/api/v1/sessions
    description: Development server
  - url: https://api.necpgame.com/api/v1/sessions
    description: Production server

security:
  - BearerAuth: [ ]

tags:
  - name: Sessions
    description: Session management operations
  - name: Health
    description: Service health check
  - name: Analytics
    description: Session analytics and monitoring
  - name: Security
    description: Session security operations
  - name: Cleanup
    description: Session cleanup operations

paths:
  /health:
    get:
      summary: Service health check
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /sessions:
    post:
      summary: Create new session
      operationId: createSession
      description: |
        Creates a new user session with automatic device fingerprinting.
        **BACKEND NOTE:** Hot path - optimized for 5000+ RPS, zero allocations.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSessionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          description: Too many active sessions for this user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{sessionId}:
    parameters:
      - name: sessionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Session ID
    get:
      summary: Get session details
      operationId: getSession
      description: |
        Retrieves detailed information about a specific session.
      tags:
        - Sessions
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetailsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          description: Session has expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update session
      operationId: updateSession
      description: |
        Updates session metadata or extends session lifetime.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSessionRequest'
      responses:
        '200':
          description: Session updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateSessionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Terminate session
      operationId: terminateSession
      description: |
        Terminates a session immediately.
      tags:
        - Sessions
      responses:
        '204':
          description: Session terminated
        '404':
          $ref: '#/components/responses/NotFound'

  /sessions/{sessionId}/validate:
    parameters:
      - name: sessionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the session to validate.
    post:
      summary: Validate session
      operationId: validateSession
      description: |
        Validates session authenticity and freshness.
        **BACKEND NOTE:** Hot path - optimized for 5000+ RPS, zero allocations.
      tags:
        - Sessions
      responses:
        '200':
          description: Session is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateSessionResponse'
        '401':
          description: Session invalid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Session blocked due to security policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{sessionId}/extend:
    post:
      summary: Extend session
      operationId: extendSession
      description: |
        Extends session lifetime without full recreation.
      tags:
        - Sessions
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique identifier of the session to extend.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExtendSessionRequest'
      responses:
        '200':
          description: Session extended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendSessionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          description: Extension rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/active:
    get:
      summary: Get active sessions
      operationId: getActiveSessions
      description: |
        Retrieves all active sessions for the authenticated user.
        **BACKEND NOTE:** Hot path - optimized for 5000+ RPS, zero allocations.
      tags:
        - Sessions
      parameters:
        - name: includeExpired
          in: query
          schema:
            type: boolean
            default: false
          description: Include recently expired sessions
      responses:
        '200':
          description: List of active sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActiveSessionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /sessions/cleanup:
    post:
      summary: Force cleanup expired sessions
      operationId: cleanupSessions
      description: |
        Forces cleanup of expired sessions (admin operation).
      tags:
        - Cleanup
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupResponse'
        '403':
          description: Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /analytics/sessions:
    get:
      summary: Get session analytics
      operationId: getSessionAnalytics
      description: |
        Retrieves session usage analytics (admin operation).
      tags:
        - Analytics
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: Start date for analytics
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: End date for analytics
      responses:
        '200':
          description: Session analytics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionAnalyticsResponse'
        '403':
          description: Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /security/sessions/{sessionId}/block:
    parameters:
      - name: sessionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Unique identifier of the session to block.
    post:
      summary: Block suspicious session
      operationId: blockSession
      description: |
        Blocks a session due to suspicious activity.
      tags:
        - Security
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlockSessionRequest'
      responses:
        '200':
          description: Session blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockSessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: JWT Bearer token authentication

  responses:
    BadRequest:
      description: Invalid request payload or parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required or failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Access denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalServerError:
      description: Unexpected internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ healthy ]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        uptime:
          type: integer
          description: Service uptime in seconds
        activeSessions:
          type: integer
          description: Number of active sessions

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Unique error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details

    CreateSessionRequest:
      type: object
      required:
        - userId
        - deviceFingerprint
      properties:
        userId:
          type: string
          format: uuid
        deviceFingerprint:
          type: string
          description: Unique device identifier
        clientInfo:
          type: object
          properties:
            userAgent:
              type: string
            ipAddress:
              type: string
            platform:
              type: string
            version:
              type: string
        metadata:
          type: object
          description: Additional session metadata

    CreateSessionResponse:
      type: object
      required:
        - sessionId
        - token
        - expiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        token:
          type: string
          description: JWT session token
        expiresAt:
          type: string
          format: date-time
        refreshToken:
          type: string
          description: Token for session extension

    SessionDetailsResponse:
      type: object
      required:
        - sessionId
        - userId
        - status
        - createdAt
        - expiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        status:
          type: string
          enum: [ ACTIVE, EXPIRED, BLOCKED, TERMINATED ]
        deviceFingerprint:
          type: string
        clientInfo:
          type: object
          description: Client information
        createdAt:
          type: string
          format: date-time
        lastActivity:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        metadata:
          type: object

    UpdateSessionRequest:
      type: object
      properties:
        metadata:
          type: object
          description: Updated session metadata
        extendBy:
          type: integer
          description: Extend session by N seconds

    UpdateSessionResponse:
      type: object
      required:
        - sessionId
        - expiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        expiresAt:
          type: string
          format: date-time
        changes:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              oldValue:
                type: string
              newValue:
                type: string

    ValidateSessionResponse:
      type: object
      required:
        - sessionId
        - isValid
        - expiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        isValid:
          type: boolean
        expiresAt:
          type: string
          format: date-time
        timeToExpiry:
          type: integer
          description: Seconds until expiry
        warnings:
          type: array
          items:
            type: string
          description: Validation warnings

    ExtendSessionRequest:
      type: object
      properties:
        extendBy:
          type: integer
          minimum: 300
          maximum: 86400
          default: 3600
          description: Extend by N seconds (5 min to 24 hours)

    ExtendSessionResponse:
      type: object
      required:
        - sessionId
        - newExpiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        newExpiresAt:
          type: string
          format: date-time
        extendedBy:
          type: integer
          description: Actual extension in seconds

    ActiveSessionsResponse:
      type: object
      required:
        - sessions
        - count
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/SessionSummary'
        count:
          type: integer
        totalActive:
          type: integer

    SessionSummary:
      type: object
      required:
        - sessionId
        - deviceFingerprint
        - createdAt
        - expiresAt
      properties:
        sessionId:
          type: string
          format: uuid
        deviceFingerprint:
          type: string
        clientInfo:
          type: object
          description: Client information
        createdAt:
          type: string
          format: date-time
        lastActivity:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time

    CleanupResponse:
      type: object
      required:
        - cleanedCount
        - totalProcessed
      properties:
        cleanedCount:
          type: integer
          description: Number of sessions cleaned up
        totalProcessed:
          type: integer
          description: Total sessions processed
        duration:
          type: integer
          description: Cleanup duration in milliseconds

    SessionAnalyticsResponse:
      type: object
      required:
        - period
        - totalSessions
        - activeSessions
      properties:
        period:
          type: object
          properties:
            startDate:
              type: string
              format: date
            endDate:
              type: string
              format: date
        totalSessions:
          type: integer
        activeSessions:
          type: integer
        averageSessionDuration:
          type: integer
          description: Average session duration in seconds
        peakConcurrentSessions:
          type: integer
        sessionsByPlatform:
          type: object
          description: Session count by platform
        sessionsByDevice:
          type: object
          description: Session count by device type

    BlockSessionRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          enum: [ SUSPICIOUS_ACTIVITY, SECURITY_VIOLATION, ADMIN_REQUEST ]
        evidence:
          type: object
          description: Evidence for blocking
        blockDuration:
          type: integer
          description: Block duration in seconds (0 = permanent)

    BlockSessionResponse:
      type: object
      required:
        - sessionId
        - blocked
        - blockedUntil
      properties:
        sessionId:
          type: string
          format: uuid
        blocked:
          type: boolean
        blockedUntil:
          type: string
          format: date-time
        reason:
          type: string
