# Event streaming and publishing schemas
# Issue: #2053

components:
  schemas:
    # Event base structure - memory optimized
    Event:
      type: object
      required:
        - event_id
        - event_type
        - timestamp
        - source
      properties:
        # Large types first
        event_id:
          type: string
          format: uuid
          description: Unique event identifier
          example: "550e8400-e29b-41d4-a716-446655440000"

        correlation_id:
          type: string
          format: uuid
          description: Correlation ID for event tracing
          example: "550e8400-e29b-41d4-a716-446655440001"

        source_service:
          type: string
          description: Service that generated the event
          example: "guild-service"

        source_instance:
          type: string
          description: Service instance identifier
          example: "guild-service-01"

        player_id:
          type: string
          format: uuid
          description: Primary player associated with event
          example: "550e8400-e29b-41d4-a716-446655440002"

        target_player_id:
          type: string
          format: uuid
          description: Target player (if applicable)
          example: "550e8400-e29b-41d4-a716-446655440003"

        event_data:
          type: object
          description: Event-specific payload data
          additionalProperties: true
          example:
            guild_id: "550e8400-e29b-41d4-a716-446655440004"
            old_level: 5
            new_level: 6

        metadata:
          type: object
          description: Event metadata
          additionalProperties: true
          example:
            region: "us-east-1"
            shard: "shard-01"

        timestamp:
          type: string
          format: date-time
          description: Event generation timestamp
          example: "2025-12-20T21:40:00Z"

        # Medium types
        event_type:
          type: string
          description: Hierarchical event type (dot-separated)
          example: "guild.member.joined"

        source:
          type: string
          description: Event source identifier
          example: "guild-service"

        priority:
          type: string
          enum: [low, normal, high, critical]
          description: Event priority level
          example: "normal"

        # Small types
        version:
          type: integer
          minimum: 1
          description: Event schema version
          example: 1

        ttl_seconds:
          type: integer
          minimum: 0
          maximum: 86400
          description: Time-to-live in seconds
          example: 3600

        retry_count:
          type: integer
          minimum: 0
          description: Number of delivery retries
          example: 0

    # Publish single event request
    PublishEventRequest:
      type: object
      required:
        - event_type
        - event_data
      properties:
        event_type:
          type: string
          description: Event type to publish
          example: "guild.member.joined"

        event_data:
          type: object
          description: Event payload data
          additionalProperties: true
          example:
            guild_id: "550e8400-e29b-41d4-a716-446655440004"
            player_id: "550e8400-e29b-41d4-a716-446655440002"
            joined_at: "2025-12-20T21:40:00Z"

        priority:
          type: string
          enum: [low, normal, high, critical]
          default: "normal"
          description: Event priority

        ttl_seconds:
          type: integer
          minimum: 0
          maximum: 86400
          default: 3600
          description: Time-to-live in seconds

        target_filters:
          type: object
          description: Optional filters to target specific subscribers
          additionalProperties: true
          example:
            guild_id: "550e8400-e29b-41d4-a716-446655440004"
            region: "us-east"

    # Publish event response
    PublishEventResponse:
      type: object
      required:
        - event_id
        - status
        - subscriber_count
      properties:
        event_id:
          type: string
          format: uuid
          description: Published event identifier
        status:
          type: string
          enum: [accepted, queued, rejected]
          description: Publishing status
        subscriber_count:
          type: integer
          minimum: 0
          description: Number of matching subscribers
        estimated_delivery_time_ms:
          type: integer
          minimum: 0
          description: Estimated delivery time

    # Batch publish events request
    PublishEventsBatchRequest:
      type: object
      required:
        - events
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/PublishEventRequest'
          minItems: 1
          maxItems: 100
          description: Events to publish in batch

        batch_options:
          type: object
          description: Batch processing options
          properties:
            atomic_delivery:
              type: boolean
              default: false
              description: Deliver all events atomically
            priority_ordering:
              type: boolean
              default: true
              description: Deliver events in priority order

    # Batch publish response
    PublishEventsBatchResponse:
      type: object
      required:
        - batch_id
        - status
        - events_count
        - total_subscribers
      properties:
        batch_id:
          type: string
          format: uuid
          description: Batch identifier
        status:
          type: string
          enum: [accepted, partial, rejected]
          description: Batch publishing status
        events_count:
          type: integer
          description: Number of events in batch
        total_subscribers:
          type: integer
          minimum: 0
          description: Total matching subscribers across all events
        event_results:
          type: array
          items:
            $ref: '#/components/schemas/PublishEventResponse'
          description: Individual event results

    # WebSocket event message
    WebSocketEventMessage:
      type: object
      required:
        - type
        - event
        - subscription_id
      properties:
        type:
          type: string
          enum: [event, heartbeat, subscription_update]
          description: Message type
          example: "event"

        event:
          $ref: '#/components/schemas/Event'
          description: The event data

        subscription_id:
          type: string
          format: uuid
          description: Matching subscription identifier
          example: "550e8400-e29b-41d4-a716-446655440005"

        sequence_number:
          type: integer
          minimum: 0
          description: Message sequence number for ordering
          example: 12345

        delivered_at:
          type: string
          format: date-time
          description: Delivery timestamp
          example: "2025-12-20T21:40:05Z"
