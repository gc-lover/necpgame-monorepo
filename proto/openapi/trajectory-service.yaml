# Issue: #1560

openapi: 3.0.3
info:
  title: Trajectory Service API
  description: API для расчета траекторий проджектайлов
  version: 1.0.0

servers:
  - url: http://localhost:8092
    description: Development server
  - url: http://trajectory-service:8092
    description: Kubernetes service

security:
  - BearerAuth: []

paths:
  /api/v1/trajectory/calculate:
    post:
      summary: Рассчитать траекторию проджектайла
      operationId: calculateTrajectory
      tags:
        - Trajectory Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateTrajectoryRequest'
      responses:
        '200':
          description: Траектория рассчитана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrajectoryResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '401':
          $ref: 'common.yaml#/components/responses/Unauthorized'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /api/v1/trajectory/chain:
    post:
      summary: Рассчитать цепную траекторию
      operationId: calculateChainTrajectory
      tags:
        - Trajectory Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChainTrajectoryRequest'
      responses:
        '200':
          description: Цепная траектория рассчитана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChainTrajectoryResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /api/v1/trajectory/ricochet:
    post:
      summary: Рассчитать траекторию с рикошетами
      operationId: calculateRicochetTrajectory
      tags:
        - Trajectory Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RicochetTrajectoryRequest'
      responses:
        '200':
          description: Траектория с рикошетами рассчитана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RicochetTrajectoryResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /api/v1/trajectory/split:
    post:
      summary: Рассчитать траекторию с разделением
      operationId: calculateSplitTrajectory
      tags:
        - Trajectory Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SplitTrajectoryRequest'
      responses:
        '200':
          description: Траектория с разделением рассчитана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SplitTrajectoryResponse'
        '400':
          $ref: 'common.yaml#/components/responses/BadRequest'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

  /api/v1/trajectory/algorithms:
    get:
      summary: Получить список алгоритмов траекторий
      operationId: getTrajectoryAlgorithms
      tags:
        - Algorithms
      parameters:
        - name: form_type
          in: query
          description: Фильтр по типу формы
          schema:
            type: string
      responses:
        '200':
          description: Список алгоритмов
          content:
            application/json:
              schema:
                type: object
                required:
                  - algorithms
                properties:
                  algorithms:
                    type: array
                    items:
                      $ref: '#/components/schemas/TrajectoryAlgorithm'
        '500':
          $ref: 'common.yaml#/components/responses/InternalServerError'

components:
  schemas:
    Vector3:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: float
        y:
          type: number
          format: float
        z:
          type: number
          format: float

    ProjectileFormType:
      type: string
      enum:
        - point
        - line
        - fan
        - spiral
        - wave
        - circle
        - square
        - chain
        - split
        - ricochet
        - phasing

    TrajectoryParameters:
      type: object
      description: Параметры траектории
      properties:
        spread_angle:
          type: number
          format: float
          description: Угол рассеивания (для веера)
          example: 30.0
        projectile_count:
          type: integer
          description: Количество снарядов
          example: 8
        spiral_radius:
          type: number
          format: float
          description: Радиус спирали
          example: 0.5
        rotation_speed:
          type: number
          format: float
          description: Скорость вращения (град/сек)
          example: 360.0
        wave_amplitude:
          type: number
          format: float
          description: Амплитуда волны
          example: 1.0
        wave_frequency:
          type: number
          format: float
          description: Частота волны
          example: 2.0
        chain_max_targets:
          type: integer
          description: Максимум целей для цепи
          example: 5
        chain_radius:
          type: number
          format: float
          description: Радиус цепной реакции
          example: 10.0
        ricochet_count:
          type: integer
          description: Количество рикошетов
          example: 5
        split_count:
          type: integer
          description: Количество частей при разделении
          example: 5
        max_penetration_depth:
          type: number
          format: float
          description: Максимальная глубина проникновения
          example: 2.0

    CalculateTrajectoryRequest:
      type: object
      required:
        - form
        - origin
        - direction
      properties:
        form:
          $ref: '#/components/schemas/ProjectileFormType'
        origin:
          $ref: '#/components/schemas/Vector3'
        direction:
          $ref: '#/components/schemas/Vector3'
        velocity:
          type: number
          format: float
          default: 100.0
        parameters:
          $ref: '#/components/schemas/TrajectoryParameters'
        time_limit:
          type: number
          format: float
          description: Максимальное время симуляции (сек)
          default: 5.0

    TrajectoryPoint:
      type: object
      required:
        - position
        - time
      properties:
        position:
          $ref: '#/components/schemas/Vector3'
        time:
          type: number
          format: float
          description: Время от начала (сек)
        velocity:
          $ref: '#/components/schemas/Vector3'

    TrajectoryResponse:
      type: object
      required:
        - trajectory_points
        - total_time
      properties:
        trajectory_points:
          type: array
          items:
            $ref: '#/components/schemas/TrajectoryPoint'
        total_time:
          type: number
          format: float
          description: Общее время полета
        distance:
          type: number
          format: float
          description: Общая дистанция

    ChainTarget:
      type: object
      required:
        - target_id
        - position
      properties:
        target_id:
          type: string
        position:
          $ref: '#/components/schemas/Vector3'

    ChainTrajectoryRequest:
      type: object
      required:
        - origin
        - initial_target
        - potential_targets
      properties:
        origin:
          $ref: '#/components/schemas/Vector3'
        initial_target:
          $ref: '#/components/schemas/ChainTarget'
        potential_targets:
          type: array
          items:
            $ref: '#/components/schemas/ChainTarget'
        max_chain_targets:
          type: integer
          default: 5
        chain_radius:
          type: number
          format: float
          default: 10.0
        damage_falloff:
          type: array
          items:
            type: number
            format: float
          example: [1.0, 0.7, 0.5, 0.3, 0.2]

    ChainTrajectoryResponse:
      type: object
      required:
        - chain_segments
        - total_targets
      properties:
        chain_segments:
          type: array
          items:
            type: object
            properties:
              from:
                $ref: '#/components/schemas/Vector3'
              to:
                $ref: '#/components/schemas/Vector3'
              target_id:
                type: string
              damage_multiplier:
                type: number
                format: float
        total_targets:
          type: integer

    RicochetTrajectoryRequest:
      type: object
      required:
        - origin
        - direction
      properties:
        origin:
          $ref: '#/components/schemas/Vector3'
        direction:
          $ref: '#/components/schemas/Vector3'
        velocity:
          type: number
          format: float
          default: 100.0
        max_bounces:
          type: integer
          default: 5
        bounce_factor:
          type: number
          format: float
          description: Коэффициент отскока
          default: 0.9

    RicochetTrajectoryResponse:
      type: object
      required:
        - bounces
        - total_bounces
      properties:
        bounces:
          type: array
          items:
            type: object
            properties:
              position:
                $ref: '#/components/schemas/Vector3'
              bounce_number:
                type: integer
              damage_multiplier:
                type: number
                format: float
        total_bounces:
          type: integer

    SplitTrajectoryRequest:
      type: object
      required:
        - origin
        - direction
      properties:
        origin:
          $ref: '#/components/schemas/Vector3'
        direction:
          $ref: '#/components/schemas/Vector3'
        velocity:
          type: number
          format: float
          default: 100.0
        split_distance:
          type: number
          format: float
          description: Дистанция до разделения
          default: 5.0
        split_count:
          type: integer
          description: Количество частей
          default: 5
        split_angle:
          type: number
          format: float
          description: Угол разделения
          default: 30.0

    SplitTrajectoryResponse:
      type: object
      required:
        - split_point
        - child_trajectories
      properties:
        split_point:
          $ref: '#/components/schemas/Vector3'
        child_trajectories:
          type: array
          items:
            $ref: '#/components/schemas/TrajectoryResponse'

    TrajectoryAlgorithm:
      type: object
      required:
        - id
        - name
        - algorithm_type
        - performance_cost
      properties:
        id:
          type: string
          example: "algo_linear"
        name:
          type: string
          example: "Linear Trajectory"
        projectile_form_id:
          type: string
          example: "form_point"
        algorithm_type:
          type: string
          enum:
            - linear_trajectory
            - parallel_lines
            - cone_spread
            - helical_trajectory
            - sinusoidal_trajectory
            - radial_spread
            - grid_pattern
            - chain_reaction
            - split_trajectory
            - bounce_trajectory
            - penetration_trajectory
        parameters:
          type: object
          additionalProperties: true
        performance_cost:
          type: integer
          minimum: 1
          maximum: 10
          description: Стоимость расчета (1-10)
        description:
          type: string

  securitySchemes:
    BearerAuth:
      $ref: 'common.yaml#/components/securitySchemes/BearerAuth'

