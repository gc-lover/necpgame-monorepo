# Issue: #2232 - Real-time Combat API Specification - COMPLETE MMOFPS IMPLEMENTATION
openapi: 3.0.3
info:
  title: Real-time Combat API - Complete MMOFPS Implementation
  version: 2.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  description: |
    Enterprise-grade REST API for managing real-time combat interactions in NECPGAME MMOFPS RPG.

    ## Core Features

    - **Weapon Systems**: Assault rifles, shotguns, pistols, melee weapons, explosives
    - **Damage Calculation**: Ballistic, explosive, melee, environmental damage
    - **Anti-Cheat Protection**: Pattern detection, anomaly scoring, rate limiting
    - **Real-time State Sync**: Player positions, health, equipment, effects
    - **Event Streaming**: Kill events, objective updates, match statistics
    - **Match Management**: Round-based, team deathmatch, capture the flag modes

    ## Performance Requirements

    - **Latency**: P99 <20ms for combat-critical operations
    - **Throughput**: 10,000+ events/second per server
    - **Concurrency**: 100+ simultaneous players per match
    - **Reliability**: 99.99% uptime with automatic failover

    ## Security Features

    - JWT authentication with session validation
    - Rate limiting (100 req/sec per player)
    - Anti-cheat pattern detection
    - Input validation and sanitization
    - DDoS protection and traffic filtering

servers:
  - url: http://localhost:8110
    description: Local development
  - url: https://api.necpgame.com/v1/realtime/combat
    description: Production API
  - url: https://combat-api-staging.necpgame.com/v1
    description: Staging environment

tags:
  - name: combat-session
    description: Combat session lifecycle management
  - name: weapons
    description: Weapon systems and configurations
  - name: damage
    description: Damage calculation and application
  - name: state-sync
    description: Real-time state synchronization
  - name: events
    description: Combat event streaming and notifications
  - name: anti-cheat
    description: Anti-cheat protection and analytics
  - name: matchmaking
    description: Match creation and player assignment

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Core Combat Entities
    CombatSession:
      type: object
      required:
        - id
        - mode
        - map_id
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique combat session identifier
        mode:
          type: string
          enum: [team_deathmatch, capture_flag, domination, elimination, free_for_all]
          description: Game mode
        map_id:
          type: string
          description: Map identifier
        status:
          type: string
          enum: [waiting, starting, active, paused, completed, cancelled]
          description: Session status
        max_players:
          type: integer
          minimum: 2
          maximum: 100
          default: 12
        current_players:
          type: integer
          minimum: 0
        teams:
          type: array
          items:
            $ref: '#/components/schemas/CombatTeam'
        settings:
          $ref: '#/components/schemas/CombatSettings'
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
        winner:
          type: string
          description: Winning team/player ID

    CombatTeam:
      type: object
      required:
        - id
        - name
        - players
      properties:
        id:
          type: string
          description: Team identifier
        name:
          type: string
          maxLength: 50
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        players:
          type: array
          items:
            $ref: '#/components/schemas/CombatPlayer'
        score:
          type: integer
          default: 0

    CombatPlayer:
      type: object
      required:
        - id
        - name
        - team_id
        - health
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 50
        team_id:
          type: string
        health:
          type: number
          format: float
          minimum: 0
          maximum: 100
          default: 100
        armor:
          type: number
          format: float
          minimum: 0
          maximum: 200
          default: 0
        position:
          $ref: '#/components/schemas/Vector3D'
        rotation:
          $ref: '#/components/schemas/Vector3D'
        velocity:
          $ref: '#/components/schemas/Vector3D'
        weapons:
          type: array
          items:
            $ref: '#/components/schemas/PlayerWeapon'
          maxItems: 3
        active_weapon:
          type: integer
          minimum: 0
          maximum: 2
        effects:
          type: array
          items:
            $ref: '#/components/schemas/ActiveEffect'
        stats:
          $ref: '#/components/schemas/PlayerCombatStats'
        is_alive:
          type: boolean
          default: true
        respawn_timer:
          type: number
          format: float
          minimum: 0

    Vector3D:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: float
        y:
          type: number
          format: float
        z:
          type: number
          format: float

    # Weapon Systems
    Weapon:
      type: object
      required:
        - id
        - name
        - type
        - damage
        - fire_rate
      properties:
        id:
          type: string
          description: Weapon identifier
        name:
          type: string
          description: Display name
        type:
          type: string
          enum: [assault_rifle, shotgun, pistol, sniper, melee, grenade, explosive]
        damage:
          type: number
          format: float
          minimum: 0
        damage_type:
          type: string
          enum: [ballistic, explosive, melee, energy, environmental]
        fire_rate:
          type: number
          format: float
          minimum: 0
          description: Rounds per second
        magazine_size:
          type: integer
          minimum: 1
        reload_time:
          type: number
          format: float
          minimum: 0
        range:
          type: number
          format: float
          minimum: 0
        accuracy:
          type: number
          format: float
          minimum: 0
          maximum: 1
        recoil:
          type: number
          format: float
          minimum: 0
        penetration:
          type: number
          format: float
          minimum: 0
          maximum: 1
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/WeaponAttachment'

    WeaponAttachment:
      type: object
      required:
        - type
        - name
      properties:
        type:
          type: string
          enum: [sight, grip, muzzle, magazine, stock]
        name:
          type: string
        effects:
          type: object
          additionalProperties:
            type: number
            format: float

    PlayerWeapon:
      type: object
      required:
        - weapon_id
        - ammo_current
        - ammo_reserve
      properties:
        weapon_id:
          type: string
        ammo_current:
          type: integer
          minimum: 0
        ammo_reserve:
          type: integer
          minimum: 0
        attachments:
          type: array
          items:
            type: string

    # Damage System
    DamageEvent:
      type: object
      required:
        - id
        - session_id
        - attacker_id
        - victim_id
        - weapon_id
        - damage
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        attacker_id:
          type: string
          format: uuid
        victim_id:
          type: string
          format: uuid
        weapon_id:
          type: string
        damage:
          type: number
          format: float
          minimum: 0
        damage_type:
          type: string
          enum: [ballistic, explosive, melee, energy, environmental, fall]
        hit_location:
          type: string
          enum: [head, torso, arms, legs]
        was_critical:
          type: boolean
        armor_damage:
          type: number
          format: float
          minimum: 0
        final_damage:
          type: number
          format: float
          minimum: 0
        timestamp:
          type: string
          format: date-time
        position:
          $ref: '#/components/schemas/Vector3D'

    KillEvent:
      type: object
      required:
        - id
        - session_id
        - killer_id
        - victim_id
        - weapon_id
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        killer_id:
          type: string
          format: uuid
        victim_id:
          type: string
          format: uuid
        weapon_id:
          type: string
        kill_type:
          type: string
          enum: [normal, headshot, melee, explosion, environmental]
        timestamp:
          type: string
          format: date-time
        position:
          $ref: '#/components/schemas/Vector3D'
        kill_distance:
          type: number
          format: float
          minimum: 0

    # Effects System
    ActiveEffect:
      type: object
      required:
        - id
        - type
        - duration
        - applied_at
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [stun, burn, poison, heal, speed_boost, shield, invisibility, slow]
        duration:
          type: number
          format: float
          minimum: 0
        applied_at:
          type: string
          format: date-time
        source_id:
          type: string
          format: uuid
        parameters:
          type: object
          additionalProperties: true

    # Anti-Cheat System
    AntiCheatEvent:
      type: object
      required:
        - id
        - player_id
        - event_type
        - severity
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        player_id:
          type: string
          format: uuid
        event_type:
          type: string
          enum: [speed_hack, aimbot, wallhack, teleport, rapid_fire, damage_hack, position_anomaly]
        severity:
          type: string
          enum: [low, medium, high, critical]
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        details:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
        ip_address:
          type: string
        user_agent:
          type: string

    CheatDetectionResult:
      type: object
      required:
        - player_id
        - risk_score
        - flags
        - last_updated
      properties:
        player_id:
          type: string
          format: uuid
        risk_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
        flags:
          type: array
          items:
            type: string
        last_updated:
          type: string
          format: date-time
        ban_recommended:
          type: boolean
        review_required:
          type: boolean

    # State Synchronization
    CombatStateSnapshot:
      type: object
      required:
        - session_id
        - timestamp
        - players
        - events
      properties:
        session_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        sequence_number:
          type: integer
          minimum: 0
        players:
          type: array
          items:
            $ref: '#/components/schemas/CombatPlayer'
        projectiles:
          type: array
          items:
            $ref: '#/components/schemas/Projectile'
        effects:
          type: array
          items:
            $ref: '#/components/schemas/ActiveEffect'
        objectives:
          type: array
          items:
            $ref: '#/components/schemas/ObjectiveState'
        events:
          type: array
          items:
            $ref: '#/components/schemas/CombatEvent'
        checksum:
          type: string
          description: State integrity checksum

    Projectile:
      type: object
      required:
        - id
        - type
        - position
        - velocity
        - owner_id
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [bullet, grenade, rocket, arrow]
        position:
          $ref: '#/components/schemas/Vector3D'
        velocity:
          $ref: '#/components/schemas/Vector3D'
        owner_id:
          type: string
          format: uuid
        weapon_id:
          type: string
        damage:
          type: number
          format: float
        lifetime:
          type: number
          format: float
          minimum: 0

    # Match Statistics
    PlayerCombatStats:
      type: object
      properties:
        kills:
          type: integer
          default: 0
        deaths:
          type: integer
          default: 0
        assists:
          type: integer
          default: 0
        score:
          type: integer
          default: 0
        accuracy:
          type: number
          format: float
          minimum: 0
          maximum: 1
        headshots:
          type: integer
          default: 0
        longest_kill_distance:
          type: number
          format: float
        time_alive:
          type: number
          format: float
        damage_dealt:
          type: number
          format: float
        damage_taken:
          type: number
          format: float
        objectives_completed:
          type: integer
          default: 0

    MatchStatistics:
      type: object
      required:
        - session_id
        - duration
        - winner
        - final_scores
      properties:
        session_id:
          type: string
          format: uuid
        duration:
          type: number
          format: float
          description: Match duration in seconds
        winner:
          type: string
        final_scores:
          type: object
          additionalProperties:
            type: integer
        total_kills:
          type: integer
        total_deaths:
          type: integer
        player_stats:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/PlayerCombatStats'

    # Configuration
    CombatSettings:
      type: object
      properties:
        friendly_fire:
          type: boolean
          default: false
        respawn_time:
          type: number
          format: float
          default: 5.0
        match_duration:
          type: number
          format: float
          description: Match duration in minutes
        max_score:
          type: integer
        starting_health:
          type: number
          format: float
          default: 100
        starting_armor:
          type: number
          format: float
          default: 0
        fall_damage:
          type: boolean
          default: true
        headshot_multiplier:
          type: number
          format: float
          default: 2.0

paths:
  # Health and Status
  /health:
    get:
      summary: Service health check
      operationId: getHealth
      tags: [combat-session]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  version:
                    type: string
                  uptime:
                    type: number
                    format: float

  # Session Management
  /sessions:
    post:
      summary: Create new combat session
      operationId: createCombatSession
      tags: [combat-session]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - mode
                - map_id
              properties:
                mode:
                  type: string
                  enum: [team_deathmatch, capture_flag, domination, elimination, free_for_all]
                map_id:
                  type: string
                max_players:
                  type: integer
                  minimum: 2
                  maximum: 100
                  default: 12
                settings:
                  $ref: '#/components/schemas/CombatSettings'
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized

    get:
      summary: List active combat sessions
      operationId: listCombatSessions
      tags: [combat-session]
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [waiting, starting, active, paused, completed]
        - name: mode
          in: query
          schema:
            type: string
            enum: [team_deathmatch, capture_flag, domination, elimination, free_for_all]
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of combat sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/CombatSession'
                  total:
                    type: integer
                  has_more:
                    type: boolean

  /sessions/{session_id}:
    get:
      summary: Get combat session details
      operationId: getCombatSession
      tags: [combat-session]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '404':
          description: Session not found

    put:
      summary: Update combat session
      operationId: updateCombatSession
      tags: [combat-session]
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [waiting, starting, active, paused, completed, cancelled]
                settings:
                  $ref: '#/components/schemas/CombatSettings'
      responses:
        '200':
          description: Session updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatSession'
        '403':
          description: Not authorized to modify session
        '404':
          description: Session not found

  # Player Management
  /sessions/{session_id}/players:
    post:
      summary: Join combat session as player
      operationId: joinCombatSession
      tags: [combat-session]
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
                - team_id
              properties:
                player_id:
                  type: string
                  format: uuid
                team_id:
                  type: string
                loadout:
                  type: array
                  items:
                    type: string
                  maxItems: 3
      responses:
        '200':
          description: Successfully joined session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatPlayer'
        '403':
          description: Session is full or not accepting players
        '404':
          description: Session not found

    get:
      summary: Get session players
      operationId: getSessionPlayers
      tags: [combat-session]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of session players
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CombatPlayer'

  # Weapon Systems
  /weapons:
    get:
      summary: Get available weapons
      operationId: getWeapons
      tags: [weapons]
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [assault_rifle, shotgun, pistol, sniper, melee, grenade, explosive]
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: List of available weapons
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Weapon'

  /weapons/{weapon_id}:
    get:
      summary: Get weapon details
      operationId: getWeapon
      tags: [weapons]
      parameters:
        - name: weapon_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Weapon details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Weapon'
        '404':
          description: Weapon not found

  # Damage Events
  /sessions/{session_id}/damage:
    post:
      summary: Report damage event
      operationId: reportDamage
      tags: [damage]
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DamageEvent'
      responses:
        '201':
          description: Damage event recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DamageEvent'
        '400':
          description: Invalid damage event
        '429':
          description: Rate limit exceeded

    get:
      summary: Get damage events for session
      operationId: getDamageEvents
      tags: [damage]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: player_id
          in: query
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: since
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: List of damage events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DamageEvent'

  # State Synchronization
  /sessions/{session_id}/state:
    get:
      summary: Get current combat state
      operationId: getCombatState
      tags: [state-sync]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: include_history
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Current combat state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CombatStateSnapshot'
        '404':
          description: Session not found

    post:
      summary: Synchronize player state
      operationId: syncPlayerState
      tags: [state-sync]
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
                - position
                - health
              properties:
                player_id:
                  type: string
                  format: uuid
                position:
                  $ref: '#/components/schemas/Vector3D'
                rotation:
                  $ref: '#/components/schemas/Vector3D'
                health:
                  type: number
                  format: float
                  minimum: 0
                  maximum: 100
                armor:
                  type: number
                  format: float
                  minimum: 0
                active_weapon:
                  type: integer
                  minimum: 0
                  maximum: 2
      responses:
        '200':
          description: State synchronized
        '400':
          description: Invalid state data
        '429':
          description: Rate limit exceeded

  # Events Streaming
  /sessions/{session_id}/events:
    get:
      summary: Stream combat events (SSE)
      operationId: streamCombatEvents
      tags: [events]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: event_types
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [kill, damage, objective, player_join, player_leave, match_start, match_end]
      responses:
        '200':
          description: Server-sent events stream
          content:
            text/event-stream:
              schema:
                type: object
                properties:
                  event:
                    type: string
                  data:
                    type: string
                  id:
                    type: string

  # Anti-Cheat System
  /anti-cheat/events:
    post:
      summary: Report anti-cheat event (internal)
      operationId: reportAntiCheatEvent
      tags: [anti-cheat]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AntiCheatEvent'
      responses:
        '201':
          description: Anti-cheat event recorded
        '400':
          description: Invalid event data

  /anti-cheat/players/{player_id}/risk:
    get:
      summary: Get player risk assessment
      operationId: getPlayerRiskAssessment
      tags: [anti-cheat]
      security:
        - BearerAuth: []
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Player risk assessment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheatDetectionResult'
        '404':
          description: Player not found

  # Match Statistics
  /sessions/{session_id}/statistics:
    get:
      summary: Get match statistics
      operationId: getMatchStatistics
      tags: [combat-session]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Match statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchStatistics'
        '404':
          description: Session not found

  /leaderboards/{mode}:
    get:
      summary: Get leaderboard for game mode
      operationId: getLeaderboard
      tags: [combat-session]
      parameters:
        - name: mode
          in: path
          required: true
          schema:
            type: string
            enum: [kills, score, accuracy, headshots]
        - name: timeframe
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly, all_time]
            default: weekly
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Leaderboard rankings
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    rank:
                      type: integer
                    player_id:
                      type: string
                      format: uuid
                    player_name:
                      type: string
                    value:
                      type: number
                    change:
                      type: integer

  # Matchmaking
  /matchmaking/join:
    post:
      summary: Join matchmaking queue
      operationId: joinMatchmaking
      tags: [matchmaking]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
                - preferred_modes
              properties:
                player_id:
                  type: string
                  format: uuid
                preferred_modes:
                  type: array
                  items:
                    type: string
                    enum: [team_deathmatch, capture_flag, domination, elimination, free_for_all]
                skill_level:
                  type: string
                  enum: [beginner, intermediate, advanced, expert]
                region:
                  type: string
      responses:
        '202':
          description: Added to matchmaking queue
          content:
            application/json:
              schema:
                type: object
                properties:
                  queue_id:
                    type: string
                    format: uuid
                  estimated_wait_time:
                    type: number
                    format: float
                  position_in_queue:
                    type: integer
        '400':
          description: Invalid request or already in queue

  /matchmaking/status:
    get:
      summary: Get matchmaking status
      operationId: getMatchmakingStatus
      tags: [matchmaking]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current matchmaking status
          content:
            application/json:
              schema:
                type: object
                properties:
                  in_queue:
                    type: boolean
                  queue_position:
                    type: integer
                  estimated_wait_time:
                    type: number
                    format: float
                  matched_session:
                    type: string
                    format: uuid

  /matchmaking/leave:
    post:
      summary: Leave matchmaking queue
      operationId: leaveMatchmaking
      tags: [matchmaking]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Removed from matchmaking queue
        '404':
          description: Not in matchmaking queue
