#!/usr/bin/env python3
"""
Test parsing a specific error line
"""

import re


def parse_error_line(line, all_lines, index):
    """Parse a single error line from codeframe redocly output"""

    # Pattern for codeframe output: [N] file:line:col at path
    pattern = r'\[(\d+)\]\s+(.+?):(\d+):(\d+)\s+(.+)'
    match = re.search(pattern, line)

    if match:
        error_num, file_path, line_num, col_num, rest = match.groups()

        # Get description from next lines until "Error was generated" or next error
        description = ""
        error_type = "unknown"
        is_warning = False

        i = index + 1
        while i < len(all_lines):
            line_content = all_lines[i].strip()
            if not line_content:
                i += 1
                continue

            # Stop at next error/warning or end marker
            if line_content.startswith('[') or line_content.startswith(
                    'Error was generated') or line_content.startswith('Warning was generated'):
                if "Warning was generated" in line_content:
                    is_warning = True
                break

            description += line_content + " "

            # Try to extract error type from description
            if "Can't resolve" in description:
                error_type = "no-unresolved-refs"
            elif "Operation must have" in description and "4XX" in description:
                error_type = "operation-4xx-response"
            elif "Operation must have" in description and "2XX" in description:
                error_type = "operation-2xx-response"

            i += 1

        return {
            'file': file_path,
            'line': int(line_num),
            'column': int(col_num),
            'type': error_type,
            'description': description.strip(),
            'solution': f'Fix the {error_type} issue',
            'is_warning': is_warning
        }

    return None


# Test on the actual error line
test_lines = [
    "[1] proto\\openapi\\world-domain\\main.yaml:194:7 at #/components/schemas/CityTimelineEntry",
    "",
    "Can't resolve $ref",
    "",
    "192 |   $ref: \"./cities/world-cities-service.yaml#/components/schemas/Region\"",
    "193 | CityTimelineEntry:",
    "194 |   $ref: \"./cities/world-cities-service.yaml#/components/schemas/CityTimelineEntry\"",
    "    |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^",
    "195 |",
    "196 | # World Bosses Service Schemas Integration - enterprise-grade world boss events management",
    "",
    "Error was generated by the no-unresolved-refs rule."
]

result = parse_error_line(test_lines[0], test_lines, 0)
print("Parsed result:")
print(result)
