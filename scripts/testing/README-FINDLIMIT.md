# Gateway Limit Finder

Автоматизированный инструмент для поиска максимального предела клиентов для Gateway.

## Описание

`findlimit` - это инструмент, который автоматически находит максимальное количество клиентов, которое может обработать
Gateway при заданных параметрах. Он постепенно увеличивает нагрузку и отслеживает метрики производительности и ошибок.

## Возможности

- OK Автоматическое увеличение нагрузки (step-by-step)
- OK Отслеживание метрик: ошибки, пропускная способность, задержки
- OK Определение точки отказа (error threshold)
- OK Детальный отчет с результатами всех тестов
- OK Рекомендация максимального предела

## Использование

### Запуск через PowerShell скрипт (рекомендуется)

```powershell
.\scripts\testing\run-findlimit.ps1
```

### Запуск напрямую

```bash
cd services/realtime-gateway-go
.\findlimit.exe -url "ws://127.0.0.1:18080/ws?token=test" -start 10 -max 500 -step 20 -duration 20s -hz 60 -error-threshold 1.0 -cooldown 5s
```

### Параметры

- `-url` - URL WebSocket сервера (по умолчанию: `ws://127.0.0.1:18080/ws?token=test`)
- `-start` - Начальное количество клиентов (по умолчанию: `10`)
- `-max` - Максимальное количество клиентов для тестирования (по умолчанию: `500`)
- `-step` - Шаг увеличения количества клиентов (по умолчанию: `20`)
- `-duration` - Длительность каждого теста (по умолчанию: `20s`)
- `-hz` - Частота отправки PlayerInput (по умолчанию: `60` Hz)
- `-error-threshold` - Порог ошибок в процентах (по умолчанию: `1.0%`)
- `-cooldown` - Пауза между тестами (по умолчанию: `5s`)

## Пример вывода

```
=== Gateway Limit Finder ===
Server URL: ws://127.0.0.1:18080/ws?token=test
Starting clients: 10
Maximum clients: 500
Step size: 20
Test duration per iteration: 20s
PlayerInput Hz: 60
Error threshold: 1.00%
Cooldown between tests: 5s

Starting limit search...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Testing with 10 clients...
OK PASSED: 10 clients - Error rate: 0.00%, Throughput: 600.00 msg/s
  Connections: 10 (failed: 0)
  PlayerInput sent: 12000 (600.00 msg/s)
  GameState received: 0
  Errors: 0 (0.00%)
  Bytes sent: 444000 (433.59 KB)
  Bytes received: 0 (0.00 KB)
  Latency: avg=0.50 ms, min=0.10 ms, max=2.00 ms

Cooldown: waiting 5s before next test...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Testing with 30 clients...
OK PASSED: 30 clients - Error rate: 0.00%, Throughput: 1800.00 msg/s
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
=== LIMIT SEARCH RESULTS ===

Maximum tested: 200 clients
Maximum successful: 180 clients

OK RECOMMENDED LIMIT: 180 clients
   (with error threshold: 1.00%)

=== Detailed Results ===

Clients    | Success    | Input (msg/s) | Errors       | Error %    | Conn Failed | Latency (ms)
---------------------------------------------------------------------------------------
10         | OK PASS    | 600.00        | 0            | 0.00       | 0           | 0.50
30         | OK PASS    | 1800.00       | 0            | 0.00       | 0           | 0.60
50         | OK PASS    | 3000.00       | 0            | 0.00       | 0           | 0.80
...
180        | OK PASS    | 10800.00      | 0            | 0.00       | 0           | 1.20
200        | ❌ FAIL    | 10500.00      | 150          | 1.43       | 5           | 2.50
```

## Критерии успешности теста

Тест считается **успешным**, если:

- OK Процент ошибок меньше порога (`-error-threshold`)
- OK Нет неудачных подключений
- OK Все клиенты успешно подключились

Тест считается **провальным**, если:

- ❌ Процент ошибок превышает порог
- ❌ Есть неудачные подключения
- ❌ Процент ошибок превышает двойной порог (тест останавливается)

## Рекомендации

1. **Начальные параметры**: Начните с небольших значений (`-start 10`, `-step 10`) для быстрого тестирования
2. **Длительность теста**: Используйте минимум 20 секунд для стабильных результатов
3. **Порог ошибок**: Используйте `1.0%` для строгих требований или `5.0%` для более мягких
4. **Cooldown**: Оставляйте паузу между тестами (5-10 секунд) для восстановления Gateway
5. **Частота обновлений**: Используйте `60 Hz` для реальных условий игры

## Интерпретация результатов

- **Maximum successful** - максимальное количество клиентов, при котором Gateway работает стабильно
- **Recommended limit** - рекомендуемый предел для production (обычно на 10-20% меньше максимального)
- **Error rate** - процент ошибок при отправке сообщений (должен быть близок к 0%)
- **Throughput** - пропускная способность (msg/s) - должна расти линейно с количеством клиентов
- **Latency** - задержка отправки сообщений (должна быть стабильной, < 5ms)

## Устранение неполадок

### Gateway не отвечает

```
❌ Gateway is not available at http://127.0.0.1:9093
```

**Решение**: Запустите Gateway:

```bash
docker-compose up -d realtime-gateway
```

### Слишком много ошибок при малом количестве клиентов

**Возможные причины**:

- Gateway перегружен
- Проблемы с сетью
- Недостаточно ресурсов

**Решение**:

- Проверьте логи Gateway: `docker-compose logs realtime-gateway`
- Увеличьте `-cooldown` между тестами
- Проверьте метрики Gateway: `curl http://localhost:9093/metrics`

### Тест останавливается раньше времени

**Причина**: Процент ошибок превышает двойной порог

**Решение**: Увеличьте `-error-threshold` или найдите узкое место в Gateway

