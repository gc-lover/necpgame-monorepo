# Тестирование базовой синхронизации

## Подготовка

1. Запустить инфраструктуру:

```bash
docker-compose up -d
```

2. Go Gateway уже запущен в Docker (realtime-gateway)

3. Запустить UE5 Dedicated Server (в PIE режиме)

4. Запустить UE5 клиент (один или несколько)

## Запуск Automation тестов в UE5.7

**Важно:** В UE5.7 путь к тестам изменился!

1. Убедитесь, что плагин **Editor Tests** включен:
    - **Edit → Plugins → Testing → Editor Tests**

2. Откройте **Window → Test Automation** (не Developer Tools!)

3. Найдите категорию: **LyraGame.Network.WebSocket**

4. Выберите тесты и нажмите **Start Tests**

## Тесты

### Тест 1: Одиночный клиент

**Цель**: Проверить базовый цикл синхронизации

**Шаги**:

1. Подключить один клиент к Gateway
2. Двигаться (WASD) и стрелять
3. Проверить в логах:
    - PlayerInput отправляется каждые ~15-17 мс
    - GameState получается каждые ~16.67 мс
    - Tick инкрементируется последовательно

**Ожидаемый результат**:

- Клиент видит свое движение
- Нет ошибок в логах
- Метрики Prometheus показывают стабильные значения

### Тест 2: Множественные клиенты (2-4)

**Цель**: Проверить синхронизацию между несколькими клиентами

**Шаги**:

1. Подключить 2-4 клиента
2. Двигаться на каждом клиенте
3. Проверить:
    - Все клиенты видят друг друга
    - Позиции синхронизируются корректно
    - Нет десинхронизации

**Ожидаемый результат**:

- Все клиенты видят позиции других игроков
- Нет задержек или рывков
- Метрики показывают корректное количество клиентов

### Тест 3: Стабильность (30+ минут)

**Цель**: Проверить долгосрочную стабильность

**Шаги**:

1. Запустить тест на 30+ минут
2. Мониторить:
    - Утечки памяти
    - Стабильность соединений
    - Корректность Tick инкрементирования

**Ожидаемый результат**:

- Нет утечек памяти
- Соединения стабильны
- Tick продолжает инкрементироваться

## Метрики для проверки

### Prometheus метрики (http://localhost:9090)

**Клиентские метрики**:

- `player_input_received_total` - количество полученных PlayerInput
- `player_input_forwarded_total` - количество пересланных PlayerInput
- `message_size_bytes{type="player_input"}` - размер PlayerInput сообщений

**Серверные метрики**:

- `gamestate_received_total` - количество полученных GameState от сервера
- `gamestate_broadcasted_total` - количество рассланных GameState
- `gamestate_broadcast_duration_seconds` - время рассылки GameState
- `message_size_bytes{type="gamestate"}` - размер GameState сообщений

**Соединения**:

- `active_clients` - количество активных клиентов
- `active_server_connection` - наличие соединения с сервером (1 или 0)
- `websocket_connections_active` - общее количество активных соединений

## Ожидаемые значения

- **Частота PlayerInput**: ~60 Hz (каждые 15-17 мс)
- **Частота GameState**: ~60 Hz (каждые 16.67 мс)
- **Размер PlayerInput**: ~47 байт
- **Размер GameState**: зависит от количества игроков (базовый размер + ~30 байт на игрока)
- **RTT**: <50 мс для локальной сети
- **Задержка рассылки GameState**: <10 мс для 10 клиентов

## Проблемы и решения

### Проблема: Высокая задержка рассылки GameState

**Причина**: Много клиентов или медленная сеть

**Решение**:

- Оптимизировать BroadcastToClients (параллельная рассылка)
- Реализовать дельта-компрессию
- Снизить частоту обновлений для дальних объектов

### Проблема: Десинхронизация позиций

**Причина**: Потеря пакетов или неправильная обработка Tick

**Решение**:

- Добавить проверку последовательности Tick
- Реализовать интерполяцию позиций
- Добавить реконсиляцию состояния

### Проблема: Высокий размер GameState

**Причина**: Отправляется полный snapshot для всех игроков

**Решение**:

- Реализовать дельта-компрессию
- Отправлять только измененные данные
- Использовать сжатие (gzip/zstd)

