<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="062-create-player-character-lifecycle-tables" author="backend">
        <addColumn tableName="characters">
            <column name="status" type="VARCHAR(32)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
            <column name="is_deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="restore_until" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="last_active_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>

        <addColumn tableName="character_appearances">
            <column name="hair_style" type="VARCHAR(100)"/>
            <column name="tattoos_json" type="TEXT"/>
            <column name="scars_json" type="TEXT"/>
            <column name="implants_visible_json" type="TEXT"/>
            <column name="makeup_preset" type="VARCHAR(100)"/>
            <column name="seed" type="VARCHAR(32)"/>
        </addColumn>

        <createTable tableName="player_profiles">
            <column name="account_id" type="UUID">
                <constraints primaryKey="true" nullable="false" foreignKeyName="fk_player_profiles_account"
                             references="accounts(id)"/>
            </column>
            <column name="premium_currency" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_playtime_seconds" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="VARCHAR(16)" defaultValue="ru">
                <constraints nullable="false"/>
            </column>
            <column name="timezone" type="VARCHAR(64)" defaultValue="Europe/Moscow">
                <constraints nullable="false"/>
            </column>
            <column name="settings_ui_json" type="TEXT"/>
            <column name="settings_audio_json" type="TEXT"/>
            <column name="settings_graphics_json" type="TEXT"/>
            <column name="friends_json" type="TEXT"/>
            <column name="blocked_json" type="TEXT"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="character_slot_states">
            <column name="account_id" type="UUID">
                <constraints primaryKey="true" nullable="false" foreignKeyName="fk_character_slot_states_account"
                             references="accounts(id)"/>
            </column>
            <column name="total_slots" type="INTEGER" defaultValueNumeric="3">
                <constraints nullable="false"/>
            </column>
            <column name="used_slots" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="premium_slots_purchased" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="max_slots" type="INTEGER" defaultValueNumeric="10">
                <constraints nullable="false"/>
            </column>
            <column name="next_tier_currency" type="VARCHAR(32)"/>
            <column name="next_tier_amount" type="INTEGER"/>
            <column name="next_tier_requires_approval" type="BOOLEAN"/>
            <column name="restrictions_json" type="TEXT"/>
            <column name="active_character_id" type="UUID">
                <constraints foreignKeyName="fk_character_slot_states_active_character"
                             references="characters(id)"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="character_slot_payments">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_character_slot_payments_account"
                             references="accounts(id)"/>
            </column>
            <column name="reference_id" type="VARCHAR(64)"/>
            <column name="amount" type="INTEGER"/>
            <column name="status" type="VARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="character_slot_payments" indexName="idx_character_slot_payments_account">
            <column name="account_id"/>
        </createIndex>

        <createTable tableName="character_restore_queue">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_character_restore_queue_account"
                             references="accounts(id)"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_character_restore_queue_character"
                             references="characters(id)"/>
            </column>
            <column name="queued_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(16)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
            <column name="reason" type="TEXT"/>
        </createTable>

        <createIndex tableName="character_restore_queue" indexName="idx_character_restore_queue_account">
            <column name="account_id"/>
        </createIndex>

        <createTable tableName="character_activity_log">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_character_activity_account"
                             references="accounts(id)"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints foreignKeyName="fk_character_activity_character"
                             references="characters(id)"/>
            </column>
            <column name="activity_type" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="actor_type" type="VARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="actor_id" type="UUID"/>
            <column name="occurred_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="ip_address" type="VARCHAR(64)"/>
            <column name="location" type="VARCHAR(128)"/>
            <column name="metadata_json" type="TEXT"/>
        </createTable>

        <createIndex tableName="character_activity_log" indexName="idx_character_activity_account">
            <column name="account_id"/>
        </createIndex>
        <createIndex tableName="character_activity_log" indexName="idx_character_activity_occurred_at">
            <column name="occurred_at"/>
        </createIndex>

        <createTable tableName="character_snapshots">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_character_snapshots_character"
                             references="characters(id)"/>
            </column>
            <column name="taken_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="reason" type="VARCHAR(255)"/>
            <column name="storage_path" type="VARCHAR(255)"/>
        </createTable>

        <createIndex tableName="character_snapshots" indexName="idx_character_snapshots_character">
            <column name="character_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

