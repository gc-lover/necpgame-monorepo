<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="095-create-player-management-tables" author="backend-agent">
        <createTable tableName="players">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="premium_currency" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="settings" type="JSONB" defaultValueComputed="'{}'::jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="active_character_id" type="UUID"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="players" indexName="idx_players_account_id" unique="true">
            <column name="account_id"/>
        </createIndex>

        <createIndex tableName="players" indexName="idx_players_active_character">
            <column name="active_character_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="players"
                                 baseColumnNames="account_id"
                                 referencedTableName="accounts"
                                 referencedColumnNames="id"
                                 constraintName="fk_players_account"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="players"
                                 baseColumnNames="active_character_id"
                                 referencedTableName="characters"
                                 referencedColumnNames="id"
                                 constraintName="fk_players_active_character"
                                 onDelete="SET NULL"
                                 deferrable="false"
                                 initiallyDeferred="false"/>

        <createTable tableName="character_slots">
            <column name="player_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="slot_number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="slot_type" type="VARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="is_unlocked" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="character_id" type="UUID"/>
            <column name="reserved_until" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="character_slots"
                       columnNames="player_id, slot_number"
                       constraintName="pk_character_slots"/>

        <addUniqueConstraint tableName="character_slots"
                             columnNames="character_id"
                             constraintName="uc_character_slots_character"/>

        <addForeignKeyConstraint baseTableName="character_slots"
                                 baseColumnNames="player_id"
                                 referencedTableName="players"
                                 referencedColumnNames="id"
                                 constraintName="fk_character_slots_player"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="character_slots"
                                 baseColumnNames="character_id"
                                 referencedTableName="characters"
                                 referencedColumnNames="id"
                                 constraintName="fk_character_slots_character"
                                 onDelete="SET NULL"/>

        <createTable tableName="character_stats_snapshots">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="character_id" type="UUID">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="slot_number" type="INTEGER"/>
            <column name="payload" type="JSONB" defaultValueComputed="'{}'::jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="character_stats_snapshots"
                                 baseColumnNames="character_id"
                                 referencedTableName="characters"
                                 referencedColumnNames="id"
                                 constraintName="fk_character_stats_snapshots_character"
                                 onDelete="CASCADE"/>

        <addColumn tableName="characters">
            <column name="player_id" type="UUID"/>
        </addColumn>

        <addColumn tableName="characters">
            <column name="is_deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="characters">
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>

        <addColumn tableName="characters">
            <column name="restore_deadline" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>

        <createIndex tableName="characters" indexName="idx_characters_player_id">
            <column name="player_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="characters"
                                 baseColumnNames="player_id"
                                 referencedTableName="players"
                                 referencedColumnNames="id"
                                 constraintName="fk_characters_player"
                                 onDelete="SET NULL"/>
    </changeSet>

</databaseChangeLog>
