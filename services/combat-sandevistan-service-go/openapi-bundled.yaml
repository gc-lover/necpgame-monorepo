openapi: 3.0.3
info:
  title: Combat Sandevistan Service API
  description: |
    API для управления имплантом Sandevistan - временной овердрайв системы.

    Функционал:
    - Активация и деактивация Sandevistan
    - Управление фазами (подготовка, активная, рекуперация)
    - Action Priority Budget
    - Перегрев и охлаждение
    - Temporal Marks (пометка целей)
    - Контрплей механики
  version: 1.0.0
  contact:
    name: NECPGAME API Support
    email: api@necp.game
servers:
  - url: http://localhost:8080/api/v1
    description: Локальный сервер разработки
  - url: https://api.necp.game/api/v1
    description: Продакшен сервер
security:
  - BearerAuth: [ ]
tags:
  - name: sandevistan
    description: Операции с Sandevistan имплантом
  - name: cooling
    description: Управление охлаждением
paths:
  /combat/players/{player_id}/sandevistan/activate:
    post:
      tags:
        - sandevistan
      summary: Активировать Sandevistan
      operationId: activateSandevistan
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Sandevistan активирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SandevistanActivation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Невозможно активировать (перегрев или кулдаун)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/deactivate:
    post:
      tags:
        - sandevistan
      summary: Досрочно деактивировать Sandevistan
      operationId: deactivateSandevistan
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Sandevistan деактивирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/status:
    get:
      tags:
        - sandevistan
      summary: Получить статус Sandevistan
      operationId: getSandevistanStatus
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Статус успешно получен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SandevistanStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/action-budget:
    post:
      tags:
        - sandevistan
      summary: Использовать Action Budget
      operationId: useActionBudget
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - actions
              properties:
                actions:
                  type: array
                  maxItems: 3
                  items:
                    $ref: '#/components/schemas/Action'
      responses:
        '200':
          description: Действия выполнены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionBudgetResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Action Budget исчерпан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/temporal-marks:
    post:
      tags:
        - sandevistan
      summary: Установить Temporal Marks на цели
      operationId: setTemporalMarks
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - target_ids
              properties:
                target_ids:
                  type: array
                  maxItems: 3
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: Temporal Marks установлены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
    get:
      tags:
        - sandevistan
      summary: Получить активные Temporal Marks
      operationId: getTemporalMarks
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Список Temporal Marks
          content:
            application/json:
              schema:
                type: object
                properties:
                  marks:
                    type: array
                    items:
                      $ref: '#/components/schemas/TemporalMark'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/apply-temporal-marks:
    post:
      tags:
        - sandevistan
      summary: Применить Temporal Marks (delayed burst damage)
      operationId: applyTemporalMarks
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Temporal Marks применены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemporalMarksApplied'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/bonuses:
    get:
      tags:
        - sandevistan
      summary: Получить текущие бонусы Sandevistan
      operationId: getSandevistanBonuses
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Текущие бонусы Sandevistan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SandevistanBonuses'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/perception-drag:
    post:
      tags:
        - sandevistan
      summary: Опубликовать Perception Drag событие
      operationId: publishPerceptionDragEvent
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока с Sandevistan
          example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PerceptionDragEvent'
      responses:
        '200':
          description: Perception Drag событие опубликовано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/cooling:
    post:
      tags:
        - cooling
      summary: Использовать охлаждающий картридж
      operationId: applyCoolingCartridge
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - cartridge_id
              properties:
                cartridge_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Охлаждение применено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoolingResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/heat:
    get:
      tags:
        - cooling
      summary: Получить статус перегрева
      operationId: getHeatStatus
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Статус перегрева
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeatStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /combat/players/{player_id}/sandevistan/counterplay:
    post:
      tags:
        - sandevistan
      summary: Применить контрплей эффект
      description: Chrono-Jammer, EMP или dilation_break
      operationId: applyCounterplay
      security:
        - BearerAuth: [ ]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор игрока
          example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - effect_type
                - source_player_id
              properties:
                effect_type:
                  type: string
                  enum:
                    - chrono_jammer
                    - emp
                    - dilation_break
                source_player_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Контрплей применен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CounterplayResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен для аутентификации
  schemas:
    SandevistanActivation:
      type: object
      required:
        - activation_id
        - phase
        - started_at
        - expires_at
      properties:
        activation_id:
          type: string
          format: uuid
          description: Идентификатор активации
          example: 550e8400-e29b-41d4-a716-446655440001
        phase:
          type: string
          enum:
            - preparation
            - active
            - recuperation
          description: Фаза активации
          example: active
        started_at:
          type: string
          format: date-time
          description: Время начала активации
          example: '2025-11-29T10:00:00Z'
        expires_at:
          type: string
          format: date-time
          description: Время окончания активации
          example: '2025-11-29T10:15:00Z'
        bonuses:
          type: object
          description: Бонусы активации
          properties:
            movement_boost:
              type: number
              format: float
              description: Увеличение скорости движения
              example: 1.5
            fire_rate_boost:
              type: number
              format: float
              description: Увеличение скорости стрельбы
              example: 2
            dash_distance:
              type: number
              format: float
              description: Дистанция рывка
              example: 10
        action_budget_remaining:
          type: integer
          minimum: 0
          maximum: 3
          description: Оставшийся Action Budget
          example: 2
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    SandevistanStatus:
      type: object
      required:
        - is_active
        - phase
        - cooldown_remaining
      properties:
        activation_id:
          type: string
          format: uuid
          nullable: true
          description: Идентификатор текущей активации
        phase:
          type: string
          enum:
            - inactive
            - preparation
            - active
            - recuperation
          description: Текущая фаза
          example: active
        cooldown_remaining:
          type: integer
          minimum: 0
          description: Секунды до следующей активации
          example: 30
        heat_stacks:
          type: integer
          minimum: 0
          maximum: 4
          description: Количество стаков перегрева
          example: 1
        action_budget_remaining:
          type: integer
          minimum: 0
          maximum: 3
          description: Оставшийся Action Budget
          example: 2
        temporal_marks_count:
          type: integer
          minimum: 0
          maximum: 3
          description: Количество активных Temporal Marks
          example: 1
        is_active:
          type: boolean
          description: Активен ли Sandevistan
          example: true
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    Action:
      type: object
      required:
        - type
      properties:
        target_id:
          type: string
          format: uuid
          nullable: true
          description: Идентификатор цели
        type:
          type: string
          enum:
            - dash
            - shoot
            - melee
            - reload
          description: Тип действия
          example: dash
        target_position:
          type: object
          description: Позиция цели
          properties:
            x:
              type: number
              format: float
            'y':
              type: number
              format: float
            z:
              type: number
              format: float
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    ActionBudgetResult:
      type: object
      required:
        - executed_actions
        - budget_remaining
      properties:
        executed_actions:
          type: array
          description: Выполненные действия
          items:
            type: object
            properties:
              action_type:
                type: string
                description: Тип действия
              success:
                type: boolean
                description: Успешность выполнения
              timestamp:
                type: string
                format: date-time
                description: Время выполнения
        budget_remaining:
          type: integer
          minimum: 0
          maximum: 3
          description: Оставшийся Action Budget
          example: 1
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    TemporalMark:
      type: object
      required:
        - mark_id
        - target_id
        - marked_at
        - expires_at
      properties:
        mark_id:
          type: string
          format: uuid
          description: Идентификатор метки
          example: 550e8400-e29b-41d4-a716-446655440002
        target_id:
          type: string
          format: uuid
          description: Идентификатор цели
          example: 550e8400-e29b-41d4-a716-446655440003
        marked_at:
          type: string
          format: date-time
          description: Время установки метки
          example: '2025-11-29T10:00:00Z'
        expires_at:
          type: string
          format: date-time
          description: Время истечения метки
          example: '2025-11-29T10:15:00Z'
        delayed_burst_damage:
          type: number
          format: float
          description: Отложенный урон взрыва
          example: 100
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    CoolingResult:
      type: object
      required:
        - heat_stacks_removed
        - new_heat_level
      properties:
        heat_stacks_removed:
          type: integer
          minimum: 0
          description: Количество удаленных стаков перегрева
          example: 2
        new_heat_level:
          type: integer
          minimum: 0
          maximum: 4
          description: Новый уровень перегрева
          example: 0
        cooldown_reduced:
          type: integer
          minimum: 0
          description: Секунды снятия с кулдауна
          example: 10
        cyberpsychosis_risk:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Риск киберпсихоза
          example: 0.1
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    HeatStatus:
      type: object
      required:
        - current_stacks
        - max_stacks
        - is_overstress
      properties:
        overstress_penalty:
          type: object
          nullable: true
          description: Штрафы за перегрузку
          properties:
            hp_loss_percent:
              type: number
              format: float
              description: Потеря HP в процентах
            cooldown_multiplier:
              type: number
              format: float
              description: Множитель кулдауна
        current_stacks:
          type: integer
          minimum: 0
          maximum: 4
          description: Текущие стаки перегрева
          example: 2
        max_stacks:
          type: integer
          description: Максимальное количество стаков
          example: 4
        cyberpsychosis_risk:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Риск киберпсихоза
          example: 0.2
        is_overstress:
          type: boolean
          description: Состояние перегрузки
          example: false
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    CounterplayResult:
      type: object
      required:
        - effect_applied
        - sandevistan_interrupted
      properties:
        effect_applied:
          type: string
          enum:
            - chrono_jammer
            - emp
            - dilation_break
          description: Примененный эффект
          example: chrono_jammer
        action_budget_reduced:
          type: integer
          minimum: 0
          description: Уменьшение Action Budget
          example: 1
        sandevistan_interrupted:
          type: boolean
          description: Прерван ли Sandevistan
          example: true
        phase_ended:
          type: boolean
          description: Завершена ли фаза
          example: false
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    TemporalMarksApplied:
      type: object
      required:
        - marks_applied
        - damage_dealt
        - targets_hit
      properties:
        marks_applied:
          type: integer
          minimum: 0
          description: Количество применённых temporal marks
          example: 2
        damage_dealt:
          type: integer
          minimum: 0
          description: Общий нанесённый урон
          example: 150
        targets_hit:
          type: array
          items:
            type: string
            format: uuid
          description: Список ID целей, которым был нанесён урон
          example:
            - 550e8400-e29b-41d4-a716-446655440002
            - 550e8400-e29b-41d4-a716-446655440003
      description: 'BACKEND NOTE: Fields ordered for struct alignment (large → small). Expected memory savings: 30-50%.'
    SandevistanBonuses:
      type: object
      required:
        - is_active
        - phase
        - movement_boost
        - fire_rate_boost
        - dash_distance
        - auto_target_enabled
      properties:
        is_active:
          type: boolean
          description: Активен ли Sandevistan
          example: true
        phase:
          type: string
          enum:
            - idle
            - preparation
            - active
            - recovery
          description: Текущая фаза
          example: active
        movement_boost:
          type: number
          format: float
          description: Множитель скорости движения (1.0 = базовая скорость)
          example: 1.4
        fire_rate_boost:
          type: number
          format: float
          description: Множитель скорости стрельбы (1.0 = базовая скорость)
          example: 1.25
        dash_distance:
          type: number
          format: float
          description: Дистанция auto-target dash в метрах
          example: 15
        auto_target_enabled:
          type: boolean
          description: Включен ли auto-target dash
          example: true
      description: 'BACKEND NOTE: Current Sandevistan gameplay bonuses. Used by combat-service for real-time effect application.'
    PerceptionDragEvent:
      type: object
      required:
        - event_type
        - player_id
        - activation_id
        - phase
        - timestamp
        - affected_players
        - drag_duration_ms
        - drag_intensity
      properties:
        event_type:
          type: string
          enum:
            - sandevistan_activated
            - sandevistan_deactivated
            - phase_changed
          description: Тип события Perception Drag
          example: sandevistan_activated
        player_id:
          type: string
          format: uuid
          description: ID игрока с Sandevistan
          example: 550e8400-e29b-41d4-a716-446655440000
        activation_id:
          type: string
          format: uuid
          description: ID активации Sandevistan
          example: 550e8400-e29b-41d4-a716-446655440001
        phase:
          type: string
          enum:
            - preparation
            - active
            - recovery
            - idle
          description: Фаза Sandevistan
          example: active
        timestamp:
          type: string
          format: date-time
          description: Время события
          example: '2025-11-29T10:00:00Z'
        affected_players:
          type: array
          items:
            type: string
            format: uuid
          description: Список игроков, подверженных Perception Drag
          example:
            - 550e8400-e29b-41d4-a716-446655440002
            - 550e8400-e29b-41d4-a716-446655440003
        drag_duration_ms:
          type: integer
          minimum: 0
          maximum: 5000
          description: Длительность Perception Drag в миллисекундах
          example: 120
        drag_intensity:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Интенсивность эффекта (0.0 = нет эффекта, 1.0 = максимальный)
          example: 0.8
      description: 'BACKEND NOTE: Event for Perception Drag effects. Published to realtime-service for client-side visual effects.'
    StatusResponse:
      type: object
      properties:
        status:
          type: string
          description: Статус операции
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Тип ошибки
        message:
          type: string
          description: Сообщение об ошибке
        code:
          type: string
          description: Код ошибки
          nullable: true
        details:
          type: object
          additionalProperties: true
          description: Дополнительные детали ошибки
          nullable: true
  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: BadRequest
            message: Неверные параметры запроса
            code: INVALID_PARAMETERS
    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            message: Требуется аутентификация
            code: AUTH_REQUIRED
    InternalServerError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: InternalServerError
            message: Внутренняя ошибка сервера
            code: INTERNAL_ERROR
    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: NotFound
            message: Ресурс не найден
            code: RESOURCE_NOT_FOUND
