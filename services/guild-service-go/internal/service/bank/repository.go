// Code generated by NECPGAME backend agent. Guild Bank Repository.
// Issue: #1913
// PERFORMANCE: Optimized for financial transactions

package bank

import (
	"context"
	"database/sql"
	"time"

	"github.com/go-faster/errors"
	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"github.com/redis/go-redis/v9"
	"go.uber.org/zap"

	"guild-service-go/pkg/api"
)

// Repository handles guild bank operations
type Repository struct {
	db    *pgxpool.Pool
	redis *redis.Client
	log   *zap.Logger
}

// NewRepository creates optimized bank repository
func NewRepository(db *pgxpool.Pool, redis *redis.Client, log *zap.Logger) *Repository {
	return &Repository{
		db:    db,
		redis: redis,
		log:   log,
	}
}

// GetGuildTreasury gets guild treasury information
func (r *Repository) GetGuildTreasury(ctx context.Context, guildID uuid.UUID) (*api.GuildBank, error) {
	var treasury api.GuildBank

	err := r.db.QueryRow(ctx, `
		SELECT id, guild_id, version, currency_type, amount, last_transaction
		FROM guild_banks
		WHERE guild_id = $1`, guildID).Scan(
		&treasury.ID, &treasury.GuildID, &treasury.Version, &treasury.CurrencyType, &treasury.Amount, &treasury.LastTransaction)

	if err != nil {
		if errors.Is(err, sql.ErrNoRows) {
			// Create default treasury if not exists
			_, err = r.db.Exec(ctx, `
				INSERT INTO guild_banks (guild_id, balance, currency, last_transaction)
				VALUES ($1, 0, 'eddies', NOW())`, guildID)
			if err != nil {
				return nil, errors.Wrap(err, "create treasury")
			}
			return &api.GuildBank{
				ID:             uuid.New().String(),
				GuildID:        guildID.String(),
				Version:        1,
				CurrencyType:   "eddies",
				Amount:         0,
				LastTransaction: time.Now(),
			}, nil
		}
		return nil, errors.Wrap(err, "get treasury")
	}

	return &treasury, nil
}
