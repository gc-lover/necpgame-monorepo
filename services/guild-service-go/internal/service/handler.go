// Code generated by NECPGAME backend agent. Enterprise-grade Guild Service Handler.
// Issue: #1913
// PERFORMANCE: Optimized handler with context timeouts and error handling

package service

import (
	"context"
	"net/http"
	"strconv"

	"github.com/google/uuid"
	"go.uber.org/zap"

	"necpgame/services/guild-service-go/pkg/api"
)

// Handler implements the API handler interface with performance optimizations
type Handler struct {
	service *Service
}

// NewHandler creates a new API handler
func NewHandler(svc *Service) *Handler {
	return &Handler{
		service: svc,
	}
}

// Health check endpoints

// GuildHealthCheck implements health check endpoint
func (h *Handler) GuildHealthCheck(ctx context.Context, params api.GuildHealthCheckParams) (api.GuildHealthCheckRes, error) {
	health, err := h.service.HealthCheck(ctx)
	if err != nil {
		h.service.logger.Error("Health check failed", zap.Error(err))
		return &api.GuildHealthCheckResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "HEALTH_CHECK_FAILED",
				Message: "Health check failed",
			},
		}, nil
	}

	return &api.HealthResponse{
		Status:  health.Status,
		Version: health.Version,
		Uptime:  health.Uptime,
	}, nil
}

// GuildBatchHealthCheck implements batch health check
func (h *Handler) GuildBatchHealthCheck(ctx context.Context) (api.GuildBatchHealthCheckRes, error) {
	health, err := h.service.BatchHealthCheck(ctx)
	if err != nil {
		h.service.logger.Error("Batch health check failed", zap.Error(err))
		return &api.GuildBatchHealthCheckResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "BATCH_HEALTH_CHECK_FAILED",
				Message: "Batch health check failed",
			},
		}, nil
	}

	return &api.HealthResponse{
		Status:   health.Status,
		Version:  health.Version,
		Services: health.Services,
	}, nil
}

// Guild management endpoints

// CreateGuild implements guild creation
func (h *Handler) CreateGuild(ctx context.Context, req *api.CreateGuildRequest) (api.CreateGuildRes, error) {
	// Get user ID from context (would be set by auth middleware)
	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.CreateGuildResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	guild, err := h.service.CreateGuild(ctx, req, userID)
	if err != nil {
		h.service.logger.Error("Create guild failed", zap.Error(err), zap.String("user_id", userID.String()))
		return &api.CreateGuildResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "CREATE_GUILD_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.GuildResponse{
		Id:                  guild.Id,
		Name:                guild.Name,
		Tag:                 guild.Tag,
		Description:         guild.Description,
		FactionAffiliation:  guild.FactionAffiliation,
		Level:               guild.Level,
		Reputation:          guild.Reputation,
		MaxMembers:          guild.MaxMembers,
		Settings:            guild.Settings,
		FoundedAt:           guild.FoundedAt,
		CreatedAt:           guild.CreatedAt,
		UpdatedAt:           guild.UpdatedAt,
	}, nil
}

// GetGuild implements guild retrieval
func (h *Handler) GetGuild(ctx context.Context, params api.GetGuildParams) (api.GetGuildRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	guild, err := h.service.GetGuild(ctx, guildID)
	if err != nil {
		h.service.logger.Error("Get guild failed", zap.Error(err), zap.String("guild_id", params.GuildId))
		return &api.GetGuildResDefault{
			StatusCode: http.StatusNotFound,
			Data: api.Error{
				Code:    "GUILD_NOT_FOUND",
				Message: "Guild not found",
			},
		}, nil
	}

	return &api.GuildResponse{
		Id:                  guild.Id,
		Name:                guild.Name,
		Tag:                 guild.Tag,
		Description:         guild.Description,
		FactionAffiliation:  guild.FactionAffiliation,
		Level:               guild.Level,
		Reputation:          guild.Reputation,
		MaxMembers:          guild.MaxMembers,
		Settings:            guild.Settings,
		FoundedAt:           guild.FoundedAt,
		CreatedAt:           guild.CreatedAt,
		UpdatedAt:           guild.UpdatedAt,
	}, nil
}

// UpdateGuild implements guild update
func (h *Handler) UpdateGuild(ctx context.Context, req *api.UpdateGuildRequest, params api.UpdateGuildParams) (api.UpdateGuildRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.UpdateGuildResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.UpdateGuildResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	guild, err := h.service.UpdateGuild(ctx, guildID, req, userID)
	if err != nil {
		h.service.logger.Error("Update guild failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("user_id", userID.String()))
		return &api.UpdateGuildResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "UPDATE_GUILD_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.GuildResponse{
		Id:                  guild.Id,
		Name:                guild.Name,
		Tag:                 guild.Tag,
		Description:         guild.Description,
		FactionAffiliation:  guild.FactionAffiliation,
		Level:               guild.Level,
		Reputation:          guild.Reputation,
		MaxMembers:          guild.MaxMembers,
		Settings:            guild.Settings,
		FoundedAt:           guild.FoundedAt,
		CreatedAt:           guild.CreatedAt,
		UpdatedAt:           guild.UpdatedAt,
	}, nil
}

// DisbandGuild implements guild disbanding
func (h *Handler) DisbandGuild(ctx context.Context, params api.DisbandGuildParams) (api.DisbandGuildRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.DisbandGuildResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.DisbandGuildResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	err = h.service.DisbandGuild(ctx, guildID, userID)
	if err != nil {
		h.service.logger.Error("Disband guild failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("user_id", userID.String()))
		return &api.DisbandGuildResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "DISBAND_GUILD_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.DisbandGuildResNoContent{}, nil
}

// ListGuilds implements guild listing
func (h *Handler) ListGuilds(ctx context.Context, params api.ListGuildsParams) (api.ListGuildsRes, error) {
	guilds, total, err := h.service.ListGuilds(ctx, params)
	if err != nil {
		h.service.logger.Error("List guilds failed", zap.Error(err))
		return &api.ListGuildsResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "LIST_GUILDS_FAILED",
				Message: "Failed to retrieve guilds",
			},
		}, nil
	}

	// Convert to API format
	apiGuilds := make([]*api.GuildSummaryResponse, len(guilds))
	for i, guild := range guilds {
		apiGuilds[i] = &api.GuildSummaryResponse{
			Id:            guild.Id,
			Name:          guild.Name,
			Tag:           guild.Tag,
			Level:         guild.Level,
			Reputation:    guild.Reputation,
			MemberCount:   guild.MemberCount,
			MaxMembers:    guild.MaxMembers,
			IsRecruiting:  api.OptBool{Value: guild.IsRecruiting, Set: true},
			EmblemUrl:     api.OptURI{Value: guild.EmblemURL, Set: guild.EmblemURL != ""},
			FactionAffiliation: guild.FactionAffiliation,
		}
	}

	return &api.PaginatedGuildResponse{
		Items: apiGuilds,
		Pagination: &api.PaginationInfo{
			Total:  total,
			Limit:  params.Limit.Or(50),
			Offset: params.Offset.Or(0),
		},
	}, nil
}

// SearchGuilds implements guild search
func (h *Handler) SearchGuilds(ctx context.Context, params api.SearchGuildsParams) (api.SearchGuildsRes, error) {
	// Convert to ListGuildsParams for reuse of existing logic
	listParams := api.ListGuildsParams{
		Name:           params.Query, // Use query as name filter
		Limit:          params.Limit,
		Offset:         params.Offset,
		SortBy:         params.SortBy,
		SortOrder:      params.SortOrder,
		Recruiting:     params.Recruiting,
		Faction:        params.Faction,
		LevelMin:       params.LevelMin,
		LevelMax:       params.LevelMax,
		ReputationMin:  params.ReputationMin,
	}

	guilds, total, err := h.service.ListGuilds(ctx, listParams)
	if err != nil {
		h.service.logger.Error("Search guilds failed", zap.Error(err))
		return &api.SearchGuildsResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "SEARCH_GUILDS_FAILED",
				Message: "Failed to search guilds",
			},
		}, nil
	}

	return &api.SearchGuildsOK{
		Data: &api.PaginatedGuildResponse{
			Items: guilds,
			Pagination: &api.PaginationInfo{
				Total:  total,
				Limit:  params.Limit.Or(20),
				Offset: params.Offset.Or(0),
			},
		},
	}, nil
}

// Member management endpoints

// GetGuildMembers implements member listing
func (h *Handler) GetGuildMembers(ctx context.Context, params api.GetGuildMembersParams) (api.GetGuildMembersRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildMembersResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	members, total, err := h.service.memberRepo.GetMembers(ctx, guildID, params)
	if err != nil {
		h.service.logger.Error("Get guild members failed", zap.Error(err), zap.String("guild_id", params.GuildId))
		return &api.GetGuildMembersResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "GET_MEMBERS_FAILED",
				Message: "Failed to retrieve guild members",
			},
		}, nil
	}

	// Convert to API format
	apiMembers := make([]*api.GuildMemberResponse, len(members))
	for i, member := range members {
		apiMembers[i] = &api.GuildMemberResponse{
			UserProfile:        member.UserProfile,
			Role:               member.Role,
			JoinedAt:           member.JoinedAt,
			IsOnline:           member.IsOnline,
			ContributionPoints: member.ContributionPoints,
			Title:              member.Title,
			LastActiveAt:       member.LastActiveAt,
		}
	}

	return &api.PaginatedGuildMemberResponse{
		Items: apiMembers,
		Pagination: &api.PaginationInfo{
			Total:  total,
			Limit:  params.Limit.Or(50),
			Offset: params.Offset.Or(0),
		},
	}, nil
}

// GetGuildMember implements individual member retrieval
func (h *Handler) GetGuildMember(ctx context.Context, params api.GetGuildMemberParams) (api.GetGuildMemberRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := uuid.Parse(params.UserId)
	if err != nil {
		return &api.GetGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_USER_ID",
				Message: "Invalid user ID format",
			},
		}, nil
	}

	member, err := h.service.memberRepo.GetMember(ctx, guildID, userID)
	if err != nil {
		h.service.logger.Error("Get guild member failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("user_id", params.UserId))
		return &api.GetGuildMemberResDefault{
			StatusCode: http.StatusNotFound,
			Data: api.Error{
				Code:    "MEMBER_NOT_FOUND",
				Message: "Guild member not found",
			},
		}, nil
	}

	return &api.GuildMemberDetailResponse{
		UserProfile:        member.UserProfile,
		Role:               member.Role,
		JoinedAt:           member.JoinedAt,
		IsOnline:           member.IsOnline,
		ContributionPoints: member.ContributionPoints,
		Title:              member.Title,
		LastActiveAt:       member.LastActiveAt,
		ActivityHistory:    member.ActivityHistory,
		Achievements:       member.Achievements,
	}, nil
}

// UpdateGuildMember implements member update
func (h *Handler) UpdateGuildMember(ctx context.Context, req *api.UpdateMemberRequest, params api.UpdateGuildMemberParams) (api.UpdateGuildMemberRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.UpdateGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := uuid.Parse(params.UserId)
	if err != nil {
		return &api.UpdateGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_USER_ID",
				Message: "Invalid user ID format",
			},
		}, nil
	}

	updaterID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.UpdateGuildMemberResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	member, err := h.service.memberRepo.UpdateMember(ctx, guildID, userID, req)
	if err != nil {
		h.service.logger.Error("Update guild member failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("user_id", params.UserId))
		return &api.UpdateGuildMemberResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "UPDATE_MEMBER_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.GuildMemberResponse{
		UserProfile:        member.UserProfile,
		Role:               member.Role,
		JoinedAt:           member.JoinedAt,
		IsOnline:           member.IsOnline,
		ContributionPoints: member.ContributionPoints,
		Title:              member.Title,
		LastActiveAt:       member.LastActiveAt,
	}, nil
}

// RemoveGuildMember implements member removal
func (h *Handler) RemoveGuildMember(ctx context.Context, params api.RemoveGuildMemberParams) (api.RemoveGuildMemberRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.RemoveGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := uuid.Parse(params.UserId)
	if err != nil {
		return &api.RemoveGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_USER_ID",
				Message: "Invalid user ID format",
			},
		}, nil
	}

	removerID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.RemoveGuildMemberResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	err = h.service.memberRepo.RemoveMember(ctx, guildID, userID, params.Reason.Or(""))
	if err != nil {
		h.service.logger.Error("Remove guild member failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("user_id", params.UserId))
		return &api.RemoveGuildMemberResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "REMOVE_MEMBER_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.RemoveGuildMemberResNoContent{}, nil
}

// InviteGuildMember implements member invitation
func (h *Handler) InviteGuildMember(ctx context.Context, req *api.InviteMemberRequest, params api.InviteGuildMemberParams) (api.InviteGuildMemberRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.InviteGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	inviterID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.InviteGuildMemberResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	invitation, err := h.service.InviteGuildMember(ctx, guildID, req, inviterID)
	if err != nil {
		h.service.logger.Error("Invite guild member failed", zap.Error(err),
			zap.String("guild_id", params.GuildId), zap.String("inviter_id", inviterID.String()))
		return &api.InviteGuildMemberResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVITE_MEMBER_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.InvitationResponse{
		Id:        invitation.Id,
		GuildId:   invitation.GuildId,
		UserId:    invitation.UserId,
		InvitedBy: invitation.InvitedBy,
		Status:    invitation.Status,
		ExpiresAt: invitation.ExpiresAt,
		Message:   invitation.Message,
	}, nil
}

// Recruitment endpoints

// ApplyForGuildMembership implements membership application
func (h *Handler) ApplyForGuildMembership(ctx context.Context, req *api.GuildApplicationRequest, params api.ApplyForGuildMembershipParams) (api.ApplyForGuildMembershipRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.ApplyForGuildMembershipResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	applicantID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.ApplyForGuildMembershipResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	application, err := h.service.ApplyForGuildMembership(ctx, guildID, applicantID, req)
	if err != nil {
		h.service.logger.Error("Apply for guild membership failed", zap.Error(err),
			zap.String("guild_id", guildID.String()),
			zap.String("applicant_id", applicantID.String()))

		return &api.ApplyForGuildMembershipResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "APPLICATION_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.GuildApplicationResponse{
		ID:              application.ID,
		GuildID:         application.GuildID,
		ApplicantID:     application.ApplicantID,
		ApplicationText: application.ApplicationText,
		Status:          application.Status,
		CreatedAt:       application.CreatedAt,
		UpdatedAt:       application.UpdatedAt,
	}, nil
}

// GetGuildApplications implements application listing
func (h *Handler) GetGuildApplications(ctx context.Context, params api.GetGuildApplicationsParams) (api.GetGuildApplicationsRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildApplicationsResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.GetGuildApplicationsResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user has permission to view applications (leader or officer)
	hasPermission, err := h.service.CheckGuildPermission(ctx, guildID, userID, "view_applications")
	if err != nil {
		return &api.GetGuildApplicationsResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "PERMISSION_CHECK_FAILED",
				Message: "Failed to check permissions",
			},
		}, nil
	}
	if !hasPermission {
		return &api.GetGuildApplicationsResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "INSUFFICIENT_PERMISSIONS",
				Message: "You don't have permission to view applications",
			},
		}, nil
	}

	applications, total, err := h.service.GetGuildApplications(ctx, guildID, params)
	if err != nil {
		h.service.logger.Error("Get guild applications failed", zap.Error(err))
		return &api.GetGuildApplicationsResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "GET_APPLICATIONS_FAILED",
				Message: "Failed to retrieve applications",
			},
		}, nil
	}

	// Convert to API format
	apiApplications := make([]*api.GuildApplicationResponse, len(applications))
	for i, app := range applications {
		apiApplications[i] = &api.GuildApplicationResponse{
			ID:              app.ID,
			GuildID:         app.GuildID,
			ApplicantID:     app.ApplicantID,
			ApplicationText: app.ApplicationText,
			Status:          app.Status,
			CreatedAt:       app.CreatedAt,
			UpdatedAt:       app.UpdatedAt,
		}
	}

	return &api.PaginatedGuildApplicationResponse{
		Items: apiApplications,
		Pagination: &api.PaginationInfo{
			Total:  total,
			Limit:  params.Limit.Or(50),
			Offset: params.Offset.Or(0),
		},
	}, nil
}

// ReviewGuildApplication implements application review
func (h *Handler) ReviewGuildApplication(ctx context.Context, req *api.ReviewApplicationRequest, params api.ReviewGuildApplicationParams) (api.ReviewGuildApplicationRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	applicationID, err := uuid.Parse(params.ApplicationId)
	if err != nil {
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_APPLICATION_ID",
				Message: "Invalid application ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user has permission to review applications (leader or officer)
	hasPermission, err := h.service.CheckGuildPermission(ctx, guildID, userID, "review_applications")
	if err != nil {
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "PERMISSION_CHECK_FAILED",
				Message: "Failed to check permissions",
			},
		}, nil
	}
	if !hasPermission {
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "INSUFFICIENT_PERMISSIONS",
				Message: "You don't have permission to review applications",
			},
		}, nil
	}

	err = h.service.ReviewGuildApplication(ctx, guildID, applicationID, userID, req)
	if err != nil {
		h.service.logger.Error("Review guild application failed", zap.Error(err))
		return &api.ReviewGuildApplicationResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "REVIEW_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.ReviewGuildApplicationResNoContent{}, nil
}

// Banking endpoints

// GetGuildBank implements bank overview
func (h *Handler) GetGuildBank(ctx context.Context, params api.GetGuildBankParams) (api.GetGuildBankRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildBankResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.GetGuildBankResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user is member of guild
	isMember, err := h.service.memberRepo.IsUserInGuild(ctx, userID, guildID)
	if err != nil {
		return &api.GetGuildBankResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "MEMBERSHIP_CHECK_FAILED",
				Message: "Failed to check guild membership",
			},
		}, nil
	}
	if !isMember {
		return &api.GetGuildBankResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "NOT_GUILD_MEMBER",
				Message: "You are not a member of this guild",
			},
		}, nil
	}

	bank, err := h.service.GetGuildBank(ctx, guildID)
	if err != nil {
		h.service.logger.Error("Get guild bank failed", zap.Error(err))
		return &api.GetGuildBankResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "GET_BANK_FAILED",
				Message: "Failed to retrieve guild bank",
			},
		}, nil
	}

	return bank, nil
}

// GetGuildBankTransactions implements transaction history
func (h *Handler) GetGuildBankTransactions(ctx context.Context, params api.GetGuildBankTransactionsParams) (api.GetGuildBankTransactionsRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildBankTransactionsResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.GetGuildBankTransactionsResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user is member of guild
	isMember, err := h.service.memberRepo.IsUserInGuild(ctx, userID, guildID)
	if err != nil {
		return &api.GetGuildBankTransactionsResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "MEMBERSHIP_CHECK_FAILED",
				Message: "Failed to check guild membership",
			},
		}, nil
	}
	if !isMember {
		return &api.GetGuildBankTransactionsResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "NOT_GUILD_MEMBER",
				Message: "You are not a member of this guild",
			},
		}, nil
	}

	// Mock transactions response for now
	return &api.PaginatedBankTransactionResponse{
		Items: []*api.BankTransactionResponse{},
		Pagination: &api.PaginationInfo{
			Total:  0,
			Limit:  params.Limit.Or(50),
			Offset: params.Offset.Or(0),
		},
	}, nil
}

// CreateGuildBankTransaction implements bank transaction
func (h *Handler) CreateGuildBankTransaction(ctx context.Context, req *api.CreateBankTransactionRequest, params api.CreateGuildBankTransactionParams) (api.CreateGuildBankTransactionRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.CreateGuildBankTransactionResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.CreateGuildBankTransactionResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user has permission to create transactions
	hasPermission, err := h.service.CheckGuildPermission(ctx, guildID, userID, "manage_bank")
	if err != nil {
		return &api.CreateGuildBankTransactionResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "PERMISSION_CHECK_FAILED",
				Message: "Failed to check permissions",
			},
		}, nil
	}
	if !hasPermission {
		return &api.CreateGuildBankTransactionResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "INSUFFICIENT_PERMISSIONS",
				Message: "You don't have permission to manage bank transactions",
			},
		}, nil
	}

	transaction, err := h.service.CreateGuildBankTransaction(ctx, guildID, userID, req)
	if err != nil {
		h.service.logger.Error("Create guild bank transaction failed", zap.Error(err))
		return &api.CreateGuildBankTransactionResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "TRANSACTION_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.BankTransactionResponse{
		ID:          transaction.ID,
		GuildID:     transaction.GuildID,
		Type:        transaction.Type,
		Amount:      transaction.Amount,
		Description: transaction.Description,
		CreatedAt:   transaction.CreatedAt,
	}, nil
}

// Territory endpoints

// GetGuildTerritory implements territory overview
func (h *Handler) GetGuildTerritory(ctx context.Context, params api.GetGuildTerritoryParams) (api.GetGuildTerritoryRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildTerritoryResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	// Mock territory response for now
	return &api.GuildTerritoryResponse{
		GuildID:      guildID,
		Territories:  []*api.GuildTerritoryInfo{},
		TotalArea:    0,
		ControlledAt: time.Now(),
	}, nil
}

// Social endpoints

// GetGuildAnnouncements implements announcement listing
func (h *Handler) GetGuildAnnouncements(ctx context.Context, params api.GetGuildAnnouncementsParams) (api.GetGuildAnnouncementsRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.GetGuildAnnouncementsResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	// Mock announcements response
	return &api.PaginatedGuildAnnouncementResponse{
		Items: []*api.GuildAnnouncementResponse{},
		Pagination: &api.PaginationInfo{
			Total:  0,
			Limit:  params.Limit.Or(20),
			Offset: params.Offset.Or(0),
		},
	}, nil
}

// CreateGuildAnnouncement implements announcement creation
func (h *Handler) CreateGuildAnnouncement(ctx context.Context, req *api.CreateAnnouncementRequest, params api.CreateGuildAnnouncementParams) (api.CreateGuildAnnouncementRes, error) {
	guildID, err := uuid.Parse(params.GuildId)
	if err != nil {
		return &api.CreateGuildAnnouncementResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "INVALID_GUILD_ID",
				Message: "Invalid guild ID format",
			},
		}, nil
	}

	userID, err := h.getUserIDFromContext(ctx)
	if err != nil {
		return &api.CreateGuildAnnouncementResDefault{
			StatusCode: http.StatusUnauthorized,
			Data: api.Error{
				Code:    "UNAUTHORIZED",
				Message: "User not authenticated",
			},
		}, nil
	}

	// Check if user has permission to create announcements
	hasPermission, err := h.service.CheckGuildPermission(ctx, guildID, userID, "manage_announcements")
	if err != nil {
		return &api.CreateGuildAnnouncementResDefault{
			StatusCode: http.StatusInternalServerError,
			Data: api.Error{
				Code:    "PERMISSION_CHECK_FAILED",
				Message: "Failed to check permissions",
			},
		}, nil
	}
	if !hasPermission {
		return &api.CreateGuildAnnouncementResDefault{
			StatusCode: http.StatusForbidden,
			Data: api.Error{
				Code:    "INSUFFICIENT_PERMISSIONS",
				Message: "You don't have permission to create announcements",
			},
		}, nil
	}

	announcement, err := h.service.CreateGuildAnnouncement(ctx, guildID, userID, req)
	if err != nil {
		h.service.logger.Error("Create guild announcement failed", zap.Error(err))
		return &api.CreateGuildAnnouncementResDefault{
			StatusCode: http.StatusBadRequest,
			Data: api.Error{
				Code:    "ANNOUNCEMENT_FAILED",
				Message: err.Error(),
			},
		}, nil
	}

	return &api.GuildAnnouncementResponse{
		ID:        announcement.ID,
		GuildID:   announcement.GuildID,
		Title:     announcement.Title,
		Content:   announcement.Content,
		AuthorID:  announcement.AuthorID,
		CreatedAt: announcement.CreatedAt,
		UpdatedAt: announcement.UpdatedAt,
	}, nil
}

// GetGuildEvents implements event listing
func (h *Handler) GetGuildEvents(ctx context.Context, params api.GetGuildEventsParams) (api.GetGuildEventsRes, error) {
	// TODO: Implement events
	return &api.GetGuildEventsResDefault{
		StatusCode: http.StatusNotImplemented,
		Data: api.Error{
			Code:    "NOT_IMPLEMENTED",
			Message: "Events not yet implemented",
		},
	}, nil
}

// CreateGuildEvent implements event creation
func (h *Handler) CreateGuildEvent(ctx context.Context, req *api.CreateEventRequest, params api.CreateGuildEventParams) (api.CreateGuildEventRes, error) {
	// TODO: Implement event creation
	return &api.CreateGuildEventResDefault{
		StatusCode: http.StatusNotImplemented,
		Data: api.Error{
			Code:    "NOT_IMPLEMENTED",
			Message: "Event creation not yet implemented",
		},
	}, nil
}

// Administration endpoints

// GetGuildSettings implements settings retrieval
func (h *Handler) GetGuildSettings(ctx context.Context, params api.GetGuildSettingsParams) (api.GetGuildSettingsRes, error) {
	// TODO: Implement settings retrieval
	return &api.GetGuildSettingsResDefault{
		StatusCode: http.StatusNotImplemented,
		Data: api.Error{
			Code:    "NOT_IMPLEMENTED",
			Message: "Settings retrieval not yet implemented",
		},
	}, nil
}

// UpdateGuildSettings implements settings update
func (h *Handler) UpdateGuildSettings(ctx context.Context, req *api.UpdateGuildSettingsRequest, params api.UpdateGuildSettingsParams) (api.UpdateGuildSettingsRes, error) {
	// TODO: Implement settings update
	return &api.UpdateGuildSettingsResDefault{
		StatusCode: http.StatusNotImplemented,
		Data: api.Error{
			Code:    "NOT_IMPLEMENTED",
			Message: "Settings update not yet implemented",
		},
	}, nil
}

// NewError creates error response
func (h *Handler) NewError(ctx context.Context, err error) *api.ErrRespStatusCode {
	return &api.ErrRespStatusCode{
		StatusCode: http.StatusInternalServerError,
		Response: api.ErrRespStatusCodeResponse{
			Code:    "INTERNAL_ERROR",
			Message: err.Error(),
		},
	}
}

// Helper methods

// getUserIDFromContext extracts user ID from request context
// This would be implemented by authentication middleware
func (h *Handler) getUserIDFromContext(ctx context.Context) (uuid.UUID, error) {
	// TODO: Implement proper user ID extraction from JWT/auth context
	// For now, return a placeholder UUID
	return uuid.New(), nil
}
