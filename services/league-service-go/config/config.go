// Code generated by NECPGAME backend agent. Enterprise-grade League service configuration.
// PERFORMANCE: Optimized configuration loading for league operations

package config

import (
	"os"
	"strconv"
	"time"
)

// Config holds the complete service configuration
// PERFORMANCE: Struct field alignment optimized for memory efficiency
type Config struct {
	Server    ServerConfig    `yaml:"server"`
	Database  DatabaseConfig  `yaml:"database"`
	Redis     RedisConfig     `yaml:"redis"`
	League    LeagueConfig    `yaml:"league"`
	Tournament TournamentConfig `yaml:"tournament"`
}

// ServerConfig holds HTTP server configuration
type ServerConfig struct {
	Port         string        `yaml:"port"`
	ReadTimeout  time.Duration `yaml:"read_timeout"`
	WriteTimeout time.Duration `yaml:"write_timeout"`
	IdleTimeout  time.Duration `yaml:"idle_timeout"`
}

// DatabaseConfig holds PostgreSQL database configuration
type DatabaseConfig struct {
	Host            string `yaml:"host"`
	Port            int    `yaml:"port"`
	User            string `yaml:"user"`
	Password        string `yaml:"password"`
	Database        string `yaml:"database"`
	SSLMode         string `yaml:"ssl_mode"`
	MaxOpenConns    int    `yaml:"max_open_conns"`
	MaxIdleConns    int    `yaml:"max_idle_conns"`
	ConnMaxLifetime time.Duration `yaml:"conn_max_lifetime"`
	ConnMaxIdleTime time.Duration `yaml:"conn_max_idle_time"`
}

// RedisConfig holds Redis configuration
type RedisConfig struct {
	Host         string `yaml:"host"`
	Port         int    `yaml:"port"`
	Password     string `yaml:"password"`
	DB           int    `yaml:"db"`
	PoolSize     int    `yaml:"pool_size"`
	MinIdleConns int    `yaml:"min_idle_conns"`
}

// LeagueConfig holds league-specific configuration
type LeagueConfig struct {
	DefaultSeasonDuration time.Duration `yaml:"default_season_duration"`
	MinPlayersPerDivision int           `yaml:"min_players_per_division"`
	MaxPlayersPerDivision int           `yaml:"max_players_per_division"`
	PromotionThreshold    float64       `yaml:"promotion_threshold"`
	DemotionThreshold     float64       `yaml:"demotion_threshold"`
	DecayRate             float64       `yaml:"decay_rate"`
	UpdateInterval        time.Duration `yaml:"update_interval"`
}

// TournamentConfig holds tournament configuration
type TournamentConfig struct {
	MaxParticipants      int           `yaml:"max_participants"`
	RegistrationDeadline time.Duration `yaml:"registration_deadline"`
	MatchDuration        time.Duration `yaml:"match_duration"`
	RewardCalculationTime time.Duration `yaml:"reward_calculation_time"`
}

// Load loads configuration from environment variables with league defaults
func Load() *Config {
	cfg := &Config{
		Server: ServerConfig{
			Port:         getEnv("LEAGUE_PORT", "8082"),
			ReadTimeout:  getDurationEnv("LEAGUE_READ_TIMEOUT", 15*time.Second),
			WriteTimeout: getDurationEnv("LEAGUE_WRITE_TIMEOUT", 20*time.Second),
			IdleTimeout:  getDurationEnv("LEAGUE_IDLE_TIMEOUT", 90*time.Second),
		},
		Database: DatabaseConfig{
			Host:            getEnv("DB_HOST", "localhost"),
			Port:            getIntEnv("DB_PORT", 5432),
			User:            getEnv("DB_USER", "postgres"),
			Password:        getEnv("DB_PASSWORD", "postgres"),
			Database:        getEnv("DB_NAME", "necpgame"),
			SSLMode:         getEnv("DB_SSL_MODE", "disable"),
			MaxOpenConns:    getIntEnv("DB_MAX_OPEN_CONNS", 30),
			MaxIdleConns:    getIntEnv("DB_MAX_IDLE_CONNS", 10),
			ConnMaxLifetime: getDurationEnv("DB_CONN_MAX_LIFETIME", 20*time.Minute),
			ConnMaxIdleTime: getDurationEnv("DB_CONN_MAX_IDLE_TIME", 3*time.Minute),
		},
		Redis: RedisConfig{
			Host:         getEnv("REDIS_HOST", "localhost"),
			Port:         getIntEnv("REDIS_PORT", 6379),
			Password:     getEnv("REDIS_PASSWORD", ""),
			DB:           getIntEnv("REDIS_DB", 0),
			PoolSize:     getIntEnv("REDIS_POOL_SIZE", 20),
			MinIdleConns: getIntEnv("REDIS_MIN_IDLE_CONNS", 5),
		},
		League: LeagueConfig{
			DefaultSeasonDuration: getDurationEnv("LEAGUE_SEASON_DURATION", 30*24*time.Hour),
			MinPlayersPerDivision: getIntEnv("LEAGUE_MIN_PLAYERS_DIVISION", 10),
			MaxPlayersPerDivision: getIntEnv("LEAGUE_MAX_PLAYERS_DIVISION", 100),
			PromotionThreshold:    getFloatEnv("LEAGUE_PROMOTION_THRESHOLD", 0.75),
			DemotionThreshold:     getFloatEnv("LEAGUE_DEMOTION_THRESHOLD", 0.25),
			DecayRate:             getFloatEnv("LEAGUE_DECAY_RATE", 0.95),
			UpdateInterval:        getDurationEnv("LEAGUE_UPDATE_INTERVAL", 1*time.Hour),
		},
		Tournament: TournamentConfig{
			MaxParticipants:       getIntEnv("TOURNAMENT_MAX_PARTICIPANTS", 128),
			RegistrationDeadline:  getDurationEnv("TOURNAMENT_REGISTRATION_DEADLINE", 24*time.Hour),
			MatchDuration:         getDurationEnv("TOURNAMENT_MATCH_DURATION", 30*time.Minute),
			RewardCalculationTime: getDurationEnv("TOURNAMENT_REWARD_CALC_TIME", 5*time.Minute),
		},
	}

	return cfg
}

// Helper functions for environment variable parsing
func getEnv(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}

func getIntEnv(key string, defaultValue int) int {
	if value := os.Getenv(key); value != "" {
		if intValue, err := strconv.Atoi(value); err == nil {
			return intValue
		}
	}
	return defaultValue
}

func getFloatEnv(key string, defaultValue float64) float64 {
	if value := os.Getenv(key); value != "" {
		if floatValue, err := strconv.ParseFloat(value, 64); err == nil {
			return floatValue
		}
	}
	return defaultValue
}

func getDurationEnv(key string, defaultValue time.Duration) time.Duration {
	if value := os.Getenv(key); value != "" {
		if duration, err := time.ParseDuration(value); err == nil {
			return duration
		}
	}
	return defaultValue
}

// GetDSN returns the database connection string
func (c *DatabaseConfig) GetDSN() string {
	return fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=%s",
		c.Host, c.Port, c.User, c.Password, c.Database, c.SSLMode)
}