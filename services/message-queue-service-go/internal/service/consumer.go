// Code generated by NECPGAME backend agent. Consumer manager for message processing.
// PERFORMANCE: Optimized for concurrent message consumption

package service

import (
	"context"
	"sync"
	"time"

	"go.uber.org/zap"

	"necpgame/services/message-queue-service-go/config"
	"necpgame/services/message-queue-service-go/internal/models"
)

// ConsumerManager manages message consumers
type ConsumerManager struct {
	config     *config.Config
	logger     *zap.Logger
	consumers  map[string]*models.Consumer
	groups     map[string][]string // groupID -> consumerIDs
	mu         sync.RWMutex
	ctx        context.Context
	cancel     context.CancelFunc
}

// NewConsumerManager creates a new consumer manager
func NewConsumerManager(cfg *config.Config, logger *zap.Logger) *ConsumerManager {
	ctx, cancel := context.WithCancel(context.Background())

	return &ConsumerManager{
		config:    cfg,
		logger:    logger,
		consumers: make(map[string]*models.Consumer),
		groups:    make(map[string][]string),
		ctx:       ctx,
		cancel:    cancel,
	}
}

// RegisterConsumer registers a new consumer
func (cm *ConsumerManager) RegisterConsumer(ctx context.Context, consumer *models.Consumer) error {
	cm.mu.Lock()
	defer cm.mu.Unlock()

	cm.consumers[consumer.ConsumerID] = consumer
	cm.groups[consumer.GroupID] = append(cm.groups[consumer.GroupID], consumer.ConsumerID)

	cm.logger.Info("Consumer registered",
		zap.String("consumer_id", consumer.ConsumerID),
		zap.String("group_id", consumer.GroupID),
		zap.Strings("topics", consumer.Topics))

	return nil
}

// UnregisterConsumer unregisters a consumer
func (cm *ConsumerManager) UnregisterConsumer(ctx context.Context, consumerID string) error {
	cm.mu.Lock()
	defer cm.mu.Unlock()

	consumer, exists := cm.consumers[consumerID]
	if !exists {
		return nil // Consumer not found, nothing to do
	}

	delete(cm.consumers, consumerID)

	// Remove from group
	groupConsumers := cm.groups[consumer.GroupID]
	for i, id := range groupConsumers {
		if id == consumerID {
			cm.groups[consumer.GroupID] = append(groupConsumers[:i], groupConsumers[i+1:]...)
			break
		}
	}

	cm.logger.Info("Consumer unregistered",
		zap.String("consumer_id", consumerID),
		zap.String("group_id", consumer.GroupID))

	return nil
}

// GetConsumer returns a consumer by ID
func (cm *ConsumerManager) GetConsumer(ctx context.Context, consumerID string) (*models.Consumer, error) {
	cm.mu.RLock()
	defer cm.mu.RUnlock()

	consumer, exists := cm.consumers[consumerID]
	if !exists {
		return nil, nil // Consumer not found
	}

	return consumer, nil
}

// ListConsumers returns all registered consumers
func (cm *ConsumerManager) ListConsumers(ctx context.Context) ([]*models.Consumer, error) {
	cm.mu.RLock()
	defer cm.mu.RUnlock()

	consumers := make([]*models.Consumer, 0, len(cm.consumers))
	for _, consumer := range cm.consumers {
		consumers = append(consumers, consumer)
	}

	return consumers, nil
}

// Start starts the consumer manager
func (cm *ConsumerManager) Start() error {
	cm.logger.Info("Starting consumer manager")

	// Start heartbeat monitoring
	go cm.monitorConsumers()

	return nil
}

// Stop stops the consumer manager
func (cm *ConsumerManager) Stop() error {
	cm.logger.Info("Stopping consumer manager")

	cm.cancel()

	return nil
}

// monitorConsumers monitors consumer health and removes inactive ones
func (cm *ConsumerManager) monitorConsumers() {
	ticker := time.NewTicker(30 * time.Second)
	defer ticker.Stop()

	for {
		select {
		case <-cm.ctx.Done():
			return
		case <-ticker.C:
			cm.checkConsumerHealth()
		}
	}
}

// checkConsumerHealth checks and updates consumer health status
func (cm *ConsumerManager) checkConsumerHealth() {
	cm.mu.Lock()
	defer cm.mu.Unlock()

	now := time.Now()
	inactiveThreshold := 2 * time.Minute

	for consumerID, consumer := range cm.consumers {
		if now.Sub(consumer.LastSeen) > inactiveThreshold {
			consumer.Status = models.ConsumerStatusInactive
			cm.logger.Warn("Consumer marked as inactive",
				zap.String("consumer_id", consumerID),
				zap.Duration("inactive_duration", now.Sub(consumer.LastSeen)))
		}
	}
}