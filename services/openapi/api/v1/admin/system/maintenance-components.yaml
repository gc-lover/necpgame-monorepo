# Target Architecture:
# - Microservice: admin-service (port 8088)
# - API Base: /api/v1/admin/system/maintenance
# - Dependencies: notification-service, session-service, realtime-service, auth-service, analytics-service, incident-service, deployment-service
# - Frontend Module: modules/system/maintenance (useMaintenanceStore)
# - UI: MaintenanceDashboard, MaintenanceScheduleTable, MaintenanceCountdown, PlayerNotificationBanner, MaintenanceStatusCard, MaintenanceAuditLog
# - Forms: ScheduleMaintenanceForm, EmergencyMaintenanceForm, MaintenanceNotificationForm, MaintenanceRollbackForm
# - Hooks: useMaintenance, useMaintenanceStatus, useMaintenanceNotifications, useMaintenanceAudit

openapi: 3.0.3
info:
  title: Maintenance Mode Components
  version: 1.0.0
  description: Базовые параметры и схемы для Maintenance Mode API.
  x-microservice:
    name: admin-service
    port: 8088
    domain: admin
    base-path: /api/v1/admin/system/maintenance
    package: com.necpgame.adminservice
paths: {}
components:
  parameters:
    WindowId:
      name: windowId
      in: path
      required: true
      description: Идентификатор окна обслуживания.
      schema: { type: string, format: uuid }

  schemas:
    MaintenanceWindow:
      type: object
      required: [windowId, title, type, environment, status, startAt, createdBy]
      properties:
        windowId: { type: string, format: uuid }
        title: { type: string }
        description: { type: string }
        type: { type: string, enum: [SCHEDULED, EMERGENCY] }
        environment: { type: string, enum: [PRODUCTION, STAGING, TEST] }
        zones:
          type: array
          items: { type: string }
        services:
          type: array
          items: { type: string }
        startAt: { type: string, format: date-time }
        endAt: { type: string, format: date-time }
        expectedDurationMinutes: { type: integer }
        status: { type: string, enum: [PLANNED, APPROVED, IN_PROGRESS, PAUSED, COMPLETED, CANCELLED, ROLLED_BACK] }
        createdBy: { type: string }
        approvedBy: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        shutdownPlan: { $ref: '#/components/schemas/ShutdownPlan' }
        notificationPlan: { $ref: '#/components/schemas/NotificationPlan' }
        hooks: { $ref: '#/components/schemas/IntegrationHooks' }

    MaintenanceWindowList:
      type: object
      required: [windows]
      properties:
        windows:
          type: array
          items: { $ref: '#/components/schemas/MaintenanceWindow' }
        page: { $ref: '../../shared/common/pagination.yaml#/components/schemas/Page' }

    MaintenanceWindowCreateRequest:
      type: object
      required: [title, type, environment, startAt, notificationPlan]
      properties:
        title: { type: string }
        description: { type: string }
        type: { type: string, enum: [SCHEDULED, EMERGENCY] }
        environment: { type: string, enum: [PRODUCTION, STAGING, TEST] }
        zones:
          type: array
          items: { type: string }
        services:
          type: array
          items: { type: string }
        startAt: { type: string, format: date-time }
        endAt: { type: string, format: date-time }
        expectedDurationMinutes: { type: integer, minimum: 5 }
        shutdownPlan: { $ref: '#/components/schemas/ShutdownPlan' }
        notificationPlan: { $ref: '#/components/schemas/NotificationPlan' }
        hooks: { $ref: '#/components/schemas/IntegrationHooks' }
        approvalsRequired: { type: array, items: { type: string } }

    MaintenanceWindowUpdateRequest:
      type: object
      properties:
        title: { type: string }
        description: { type: string }
        startAt: { type: string, format: date-time }
        endAt: { type: string, format: date-time }
        expectedDurationMinutes: { type: integer }
        notificationPlan: { $ref: '#/components/schemas/NotificationPlan' }
        shutdownPlan: { $ref: '#/components/schemas/ShutdownPlan' }
        hooks: { $ref: '#/components/schemas/IntegrationHooks' }
        notes: { type: string }

    ShutdownPlan:
      type: object
      properties:
        gracePeriodMinutes: { type: integer, default: 15 }
        drainSteps:
          type: array
          items:
            type: object
            required: [step, description]
            properties:
              step: { type: integer }
              description: { type: string }
              targetService: { type: string }
        queueLock: { type: boolean, default: true }
        forceKickAt: { type: string, format: date-time }
        healthChecks:
          type: array
          items: { type: string }

    NotificationPlan:
      type: object
      required: [channels]
      properties:
        channels:
          type: array
          items: { type: string, enum: [IN_GAME, EMAIL, PUSH, STATUS_PAGE, DISCORD] }
        templates:
          type: array
          items:
            type: object
            required: [channel, templateId]
            properties:
              channel: { type: string }
              templateId: { type: string }
              localization: { type: array, items: { type: string } }
        schedule:
          type: array
          items:
            type: object
            required: [offsetMinutes, channel]
            properties:
              offsetMinutes: { type: integer }
              channel: { type: string }
        audience:
          type: object
          properties:
            segments: { type: array, items: { type: string } }
            includeGuildLeaders: { type: boolean }
            includeOnlinePlayers: { type: boolean }

    IntegrationHooks:
      type: object
      properties:
        deployment:
          $ref: '#/components/schemas/IntegrationHook'
        incident:
          $ref: '#/components/schemas/IntegrationHook'
        statusPage:
          $ref: '#/components/schemas/IntegrationHook'

    IntegrationHook:
      type: object
      required: [type, url]
      properties:
        hookId: { type: string, format: uuid }
        type: { type: string, enum: [DEPLOYMENT, INCIDENT, STATUS_PAGE] }
        url: { type: string, format: uri }
        secret: { type: string }
        enabled: { type: boolean, default: true }

    MaintenanceStatus:
      type: object
      required: [status, updatedAt]
      properties:
        status: { type: string, enum: [NONE, UPCOMING, IN_PROGRESS, PAUSED, COMPLETED, EMERGENCY] }
        progressPercent: { type: number, format: float, minimum: 0, maximum: 100 }
        affectedServices:
          type: array
          items: { type: string }
        playerCount: { type: integer }
        sessionDrain:
          type: object
          properties:
            activeSessions: { type: integer }
            drainedSessions: { type: integer }
            estimatedCompletion: { type: string, format: date-time }
        timeline:
          type: array
          items:
            type: object
            properties:
              timestamp: { type: string, format: date-time }
              message: { type: string }
              actor: { type: string }
        updatedAt: { type: string, format: date-time }

    MaintenanceActionResponse:
      type: object
      required: [windowId, status]
      properties:
        windowId: { type: string, format: uuid }
        status: { type: string }
        message: { type: string }
        auditEntryId: { type: string, format: uuid }

    MaintenanceAuditEntry:
      type: object
      required: [entryId, windowId, action, timestamp]
      properties:
        entryId: { type: string, format: uuid }
        windowId: { type: string, format: uuid }
        actor: { type: string }
        role: { type: string }
        action: { type: string }
        details: { type: string }
        attachments:
          type: array
          items:
            type: object
            properties:
              attachmentId: { type: string, format: uuid }
              filename: { type: string }
              url: { type: string, format: uri }
        timestamp: { type: string, format: date-time }

    MaintenanceAuditResponse:
      type: object
      required: [entries]
      properties:
        entries:
          type: array
          items: { $ref: '#/components/schemas/MaintenanceAuditEntry' }
        page: { $ref: '../../shared/common/pagination.yaml#/components/schemas/Page' }

    MaintenanceStatusPayload:
      type: object
      required: [status, timestamp]
      properties:
        status: { type: string }
        progressPercent: { type: number, format: float }
        timestamp: { type: string, format: date-time }
        message: { type: string }
        public: { type: boolean }

    MaintenanceStatusUpdateRequest:
      type: object
      required: [status]
      properties:
        status: { type: string }
        message: { type: string }
        public: { type: boolean }

    MaintenanceHookTriggerRequest:
      type: object
      required: [windowId, payload]
      properties:
        windowId: { type: string, format: uuid }
        hookType: { type: string, enum: [DEPLOYMENT, INCIDENT, STATUS_PAGE] }
        payload: { type: object, additionalProperties: true }

    MaintenanceError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [WINDOW_NOT_FOUND, INVALID_SCHEDULE, CONFLICTING_WINDOW, NOT_AUTHORIZED, NOT_ACTIVE, HOOK_FAILED, ROLLBACK_FAILED, AUDIT_REQUIRED]
        message: { type: string }
        details: { type: object, additionalProperties: true }

servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
