openapi: 3.0.3
info:
  title: Companion Components
  version: 1.0.0
  x-microservice:
    name: gameplay-service
    port: 8083
    domain: gameplay
    base-path: /api/v1/gameplay
    package: com.necpgame.gameplayservice
paths: {}

components:
  parameters:
    CompanionId:
      name: companionId
      in: path
      required: true
      description: UUID компаньона
      schema: { type: string }
    AbilityId:
      name: abilityId
      in: path
      required: true
      description: Идентификатор способности компаньона
      schema: { type: string }
  schemas:
    CreateCompanionRequest:
      type: object
      required: [playerId, type]
      properties:
        playerId:
          type: string
          description: "Аккаунт игрока, создающего компаньона"
        type:
          type: string
          enum: [combat, utility, social]
          description: "Архетип компаньона"
        subType:
          type: string
          description: "Класс внутри архетипа (assault_drone, medic_hound)"
        rarity:
          type: string
          enum: [common, rare, epic, legendary, mythic]
        nickname:
          type: string
          maxLength: 32
        startingAbilities:
          type: array
          maxItems: 4
          items: { $ref: '#/components/schemas/AbilitySlotAssignment' }
    AbilitySlotAssignment:
      type: object
      required: [slot, abilityId]
      properties:
        slot: { type: string, description: "Слот способности (active_1, passive_1, ultimate)" }
        abilityId: { type: string, description: "Идентификатор способности из каталога" }
    CompanionDetail:
      type: object
      required: [companionId, playerId, type, status]
      properties:
        companionId: { type: string }
        playerId: { type: string }
        type: { type: string, enum: [combat, utility, social] }
        subType: { type: string }
        rarity: { type: string }
        nickname: { type: string }
        status: { type: string, enum: [ACTIVE, IN_MISSION, SUSPENDED, ARCHIVED] }
        loyalty: { type: integer, minimum: 0, maximum: 100 }
        bonding:
          type: object
          properties:
            level: { type: integer }
            emotionState: { type: string }
        aiMode: { type: string, enum: [assist, defend, sentry, autonomous] }
        progression: { $ref: '#/components/schemas/CompanionProgression' }
        loadout: { $ref: '#/components/schemas/CompanionLoadout' }
        missionSlots: { type: integer, description: "Доступные слоты миссий" }
        lastUsedAt: { type: string, format: date-time }
        createdAt: { type: string, format: date-time }
        antiAbuse: { $ref: '#/components/schemas/AntiAbuseStatus' }
    CompanionRosterResponse:
      type: object
      properties:
        playerId: { type: string }
        limitActive: { type: integer }
        companions:
          type: array
          items: { $ref: '#/components/schemas/CompanionDetail' }
    UpdateCompanionRequest:
      type: object
      properties:
        nickname: { type: string, maxLength: 32 }
        aiMode: { type: string, enum: [assist, defend, sentry, autonomous] }
        cosmetics:
          type: object
          properties:
            skinId: { type: string }
            trailColor: { type: string }
            voicePackId: { type: string }
        voicePackId: { type: string }
    LoadoutUpdateRequest:
      type: object
      required: [abilitySlots]
      properties:
        abilitySlots:
          type: array
          maxItems: 5
          items: { $ref: '#/components/schemas/AbilitySlotAssignment' }
        modSlots:
          type: array
          maxItems: 5
          items: { $ref: '#/components/schemas/ModSlotAssignment' }
        passiveEffects:
          type: array
          items: { type: string }
    ModSlotAssignment:
      type: object
      required: [slot, modId]
      properties:
        slot: { type: string, description: "Слот модуля (core, augment, chip)" }
        modId: { type: string }
        rarityRequirement: { type: string }
    CompanionLoadout:
      type: object
      properties:
        abilitySlots:
          type: array
          items: { $ref: '#/components/schemas/AbilitySlotAssignment' }
        modSlots:
          type: array
          items: { $ref: '#/components/schemas/ModSlotAssignment' }
        cooldownState:
          type: array
          items: { $ref: '#/components/schemas/CooldownInfo' }
        passiveEffects:
          type: array
          items: { type: string }
    CooldownInfo:
      type: object
      properties:
        abilityId: { type: string }
        remainingSeconds: { type: integer }
        lastUsedAt: { type: string, format: date-time }
    AbilityActivationRequest:
      type: object
      required: [context]
      properties:
        context: { type: string, enum: [pve, arena, raid] }
        targetId: { type: string }
        manualOverride: { type: boolean }
        energyOverride: { type: integer, description: "Новое значение энергии при ручном триггере" }
    AbilityActivationResponse:
      type: object
      properties:
        abilityId: { type: string }
        startedAt: { type: string, format: date-time }
        cooldownEndsAt: { type: string, format: date-time }
        energyCost: { type: integer }
        events:
          type: array
          items: { $ref: '#/components/schemas/CompanionEvent' }
    MissionAssignmentRequest:
      type: object
      required: [missionId, durationMinutes]
      properties:
        missionId: { type: string }
        durationMinutes: { type: integer, minimum: 5, maximum: 480 }
        difficulty: { type: string, enum: [low, medium, high, elite] }
        targetZone: { type: string }
        rewardPreview: { $ref: '#/components/schemas/MissionRewardPreview' }
        notifyChannels:
          type: array
          items: { type: string, enum: [ingame, push, email] }
    MissionTicket:
      type: object
      required: [missionInstanceId, companionId, status]
      properties:
        missionInstanceId: { type: string }
        companionId: { type: string }
        status: { type: string, enum: [IN_PROGRESS, COMPLETED, FAILED] }
        startedAt: { type: string, format: date-time }
        eta: { type: string, format: date-time }
        successChance: { type: integer, minimum: 0, maximum: 100 }
        rewardsEarned: { $ref: '#/components/schemas/MissionRewardPreview' }
    MissionRewardPreview:
      type: object
      properties:
        credits: { type: integer }
        xpGain: { type: integer }
        items:
          type: array
          items: { $ref: '#/components/schemas/RewardItem' }
        reputation:
          type: object
          properties:
            factionId: { type: string }
            amount: { type: integer }
    MissionBoardResponse:
      type: object
      properties:
        playerId: { type: string }
        missions:
          type: array
          items: { $ref: '#/components/schemas/MissionTicket' }
    RewardItem:
      type: object
      properties:
        itemId: { type: string }
        rarity: { type: string }
        quantity: { type: integer, default: 1 }
    BondingActivityRequest:
      type: object
      required: [activityType]
      properties:
        activityType: { type: string, enum: [dialogue, training, patrol, gift, mission_support] }
        itemId: { type: string }
        bondingDelta: { type: integer, minimum: 0, maximum: 25 }
        emotionTag: { type: string }
        notes: { type: string }
    BondingActivityResponse:
      type: object
      properties:
        newBondingLevel: { type: integer }
        newEmotionState: { type: string }
        xpGranted: { type: integer }
        loyaltyDelta: { type: integer }
        cooldownUntil: { type: string, format: date-time }
    CompanionProgression:
      type: object
      properties:
        level: { type: integer }
        xp: { type: integer }
        xpToNext: { type: integer }
        skillPoints: { type: integer }
        unlockedAbilities:
          type: array
          items: { type: string }
        synergyScore: { type: integer, description: "Синергия с классом игрока" }
    XpAdjustmentRequest:
      type: object
      required: [source, delta]
      properties:
        source: { type: string, enum: [quest_reward, gm_command, compensation, sanction] }
        delta: { type: integer }
        reason: { type: string }
    PromotionRequest:
      type: object
      required: [targetRarity]
      properties:
        targetRarity: { type: string, enum: [rare, epic, legendary, mythic] }
        requirements:
          type: array
          items: { type: string }
        consumeItems:
          type: array
          items: { $ref: '#/components/schemas/RewardItem' }
    CompanionLeaderboardResponse:
      type: object
      properties:
        metric: { type: string }
        range: { type: string }
        entries:
          type: array
          items: { $ref: '#/components/schemas/LeaderboardEntry' }
        pagination: { $ref: '../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    LeaderboardEntry:
      type: object
      required: [rank, playerId, companionId]
      properties:
        rank: { type: integer }
        playerId: { type: string }
        companionId: { type: string }
        score: { type: integer }
        metrics:
          type: object
          properties:
            missionsCompleted: { type: integer }
            arenaWins: { type: integer }
            bondingScore: { type: integer }
    CompanionAnalyticsResponse:
      type: object
      properties:
        snapshotAt: { type: string, format: date-time }
        filters:
          type: object
          properties:
            playerId: { type: string }
            type: { type: string }
            range: { type: string }
        usageStats:
          type: array
          items: { $ref: '#/components/schemas/CompanionUsageStat' }
        abilityUsage:
          type: array
          items: { $ref: '#/components/schemas/AbilityUsageStat' }
        missionPerformance:
          type: object
          properties:
            successRate: { type: number }
            averageDuration: { type: number }
            lootValueMean: { type: number }
            missionsPerDay: { type: number }
    CompanionUsageStat:
      type: object
      properties:
        type: { type: string }
        activeCount: { type: integer }
        avgBondingLevel: { type: number }
        retentionDay7: { type: number }
        winContribution: { type: number }
    AbilityUsageStat:
      type: object
      properties:
        abilityId: { type: string }
        uses: { type: integer }
        winContribution: { type: number }
        averageCooldown: { type: number }
    SuspendRequest:
      type: object
      required: [reason]
      properties:
        reason: { type: string, enum: [anti_abuse, maintenance, player_request] }
        durationHours: { type: integer, minimum: 1, maximum: 168 }
        initiatedBy: { type: string }
        notes: { type: string }
    AntiAbuseStatus:
      type: object
      properties:
        flag: { type: string, enum: [none, suspicious_activity, cooldown_enforced, suspended] }
        cooldownEndsAt: { type: string, format: date-time }
        violations:
          type: array
          items: { type: string }
    CompanionError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [COMPANION_NOT_FOUND, MAX_ACTIVE_REACHED, ABILITY_ON_COOLDOWN, MISSION_SLOT_FULL, BONDING_LIMIT_REACHED, REQUIREMENTS_NOT_MET, ALREADY_SUSPENDED]
        message: { type: string }
        retryAfterSeconds: { type: integer }
    CompanionEvent:
      type: object
      properties:
        eventType: { type: string, enum: [companion.created, companion.mission.started, companion.mission.completed, companion.ability.used, companion.bonding.updated] }
        emittedAt: { type: string, format: date-time }
        payload: { type: object, additionalProperties: true }
servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
