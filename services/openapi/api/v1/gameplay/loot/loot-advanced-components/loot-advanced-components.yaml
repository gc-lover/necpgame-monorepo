openapi: 3.0.3
info:
  title: Advanced Loot Components
  version: 1.0.0
  x-microservice:
    name: gameplay-service
    port: 8083
    domain: gameplay
    base-path: /api/v1/gameplay/loot
    package: com.necpgame.gameplayservice
paths: {}

components:
  parameters:
    DropId:
      name: dropId
      in: path
      required: true
      description: Идентификатор дропа
      schema: { type: string }
    RollId:
      name: rollId
      in: path
      required: true
      description: Идентификатор ролла
      schema: { type: string }
    BossId:
      name: bossId
      in: path
      required: true
      description: Идентификатор босса или encounter
      schema: { type: string }
  schemas:
    LootDropsResponse:
      type: object
      properties:
        drops:
          type: array
          items: { $ref: '#/components/schemas/LootDrop' }
    LootDrop:
      type: object
      properties:
        dropId: { type: string }
        source: { type: string, enum: [BOSS, CHEST, WORLD, QUEST] }
        location: { type: object, additionalProperties: true }
        partyId: { type: string }
        expiresAt: { type: string, format: date-time }
        items:
          type: array
          items: { $ref: '#/components/schemas/LootItem' }
    LootItem:
      type: object
      properties:
        itemId: { type: string }
        rarity: { type: string }
        quantity: { type: integer }
        smartLootTags:
          type: array
          items: { type: string }
        guaranteed: { type: boolean }
    LootClaimRequest:
      type: object
      required: [claimMode]
      properties:
        claimMode: { type: string, enum: [AUTO, NEED_GREED, DIRECT_ASSIGN] }
        partyId: { type: string }
        initiatorId: { type: string }
        smartLootOverride: { type: boolean }
    LootRoll:
      type: object
      properties:
        rollId: { type: string }
        dropId: { type: string }
        status: { type: string, enum: [PENDING, COMPLETED, CANCELLED] }
        expiresAt: { type: string, format: date-time }
        items:
          type: array
          items: { $ref: '#/components/schemas/LootItem' }
        participants:
          type: array
          items: { $ref: '#/components/schemas/RollParticipant' }
        winner: { type: string }
        history:
          type: array
          items: { $ref: '#/components/schemas/RollHistoryEntry' }
    RollParticipant:
      type: object
      properties:
        playerId: { type: string }
        class: { type: string }
        eligible: { type: boolean }
        bonuses:
          type: object
          properties:
            guildBonus: { type: number }
            streakBonus: { type: number }
            badLuckBonus: { type: number }
        submission: { $ref: '#/components/schemas/RollSubmission' }
    RollSubmission:
      type: object
      properties:
        rollType: { type: string, enum: [NEED, GREED, PASS, AUTO] }
        value: { type: integer }
        bonus: { type: integer }
        submittedAt: { type: string, format: date-time }
    RollSubmissionRequest:
      type: object
      required: [rollType]
      properties:
        rollType: { type: string, enum: [NEED, GREED, PASS] }
        autoAccept: { type: boolean }
        reason: { type: string }
    RollResolveRequest:
      type: object
      properties:
        forceWinnerId: { type: string }
        note: { type: string }
    ActiveRollsResponse:
      type: object
      properties:
        rolls:
          type: array
          items: { $ref: '#/components/schemas/LootRoll' }
    LootSettingsResponse:
      type: object
      properties:
        smartLoot: { $ref: '#/components/schemas/SmartLootSetting' }
        autoLoot: { $ref: '#/components/schemas/AutoLootSetting' }
    LootSettingsUpdateRequest:
      type: object
      properties:
        smartLoot: { $ref: '#/components/schemas/SmartLootSetting' }
        autoLoot: { $ref: '#/components/schemas/AutoLootSetting' }
    SmartLootSetting:
      type: object
      properties:
        classPreferences:
          type: array
          items: { type: string }
        minRarity: { type: string }
        autoAssignLegendary: { type: boolean }
        blacklist:
          type: array
          items: { type: string }
    AutoLootSetting:
      type: object
      properties:
        enabled: { type: boolean }
        pickupRadius: { type: number }
        rarityThreshold: { type: string }
    BossLootInfo:
      type: object
      properties:
        bossId: { type: string }
        guaranteedItems:
          type: array
          items: { $ref: '#/components/schemas/LootItem' }
        randomTableId: { type: string }
        partyDistribution: { type: string, enum: [SHARED, INDIVIDUAL] }
        achievements:
          type: array
          items: { type: string }
    BossLootDistributeRequest:
      type: object
      required: [partyId]
      properties:
        partyId: { type: string }
        overrideWinnerId: { type: string }
        skipSmartLoot: { type: boolean }
    BossLootDistributeResponse:
      type: object
      properties:
        assigned:
          type: array
          items: { $ref: '#/components/schemas/LootAssignment' }
        guaranteedAwarded: { type: boolean }
    LootAssignment:
      type: object
      properties:
        playerId: { type: string }
        item: { $ref: '#/components/schemas/LootItem' }
        rollType: { type: string }
        rollValue: { type: integer }
    LootHistoryResponse:
      type: object
      properties:
        entries:
          type: array
          items: { $ref: '#/components/schemas/LootHistoryEntry' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    LootHistoryEntry:
      type: object
      properties:
        timestamp: { type: string, format: date-time }
        item: { $ref: '#/components/schemas/LootItem' }
        source: { type: string }
        rollType: { type: string }
        rollValue: { type: integer }
        participants:
          type: array
          items: { type: string }
        result: { type: string }
    BadLuckProtection:
      type: object
      properties:
        lastLegendaryAt: { type: string, format: date-time }
        protectionActive: { type: boolean }
        nextGuaranteedIn: { type: string }
        progressPercent: { type: number }
    DuplicateCheckRequest:
      type: object
      required: [playerId, itemId]
      properties:
        playerId: { type: string }
        itemId: { type: string }
        includeStash: { type: boolean }
    DuplicateCheckResponse:
      type: object
      properties:
        hasDuplicate: { type: boolean }
        locations:
          type: array
          items: { type: string }
        suggestedAction: { type: string, enum: [ALTERNATIVE_REWARD, ALLOW] }
    AdminRerollRequest:
      type: object
      required: [dropId, reason]
      properties:
        dropId: { type: string }
        reason: { type: string }
        executorId: { type: string }
        force: { type: boolean }
    RollHistoryEntry:
      type: object
      properties:
        playerId: { type: string }
        rollType: { type: string }
        value: { type: integer }
        bonus: { type: integer }
        timestamp: { type: string, format: date-time }
    RollEvent:
      type: object
      properties:
        roll: { $ref: '#/components/schemas/LootRoll' }
        event: { type: string, enum: [STARTED, UPDATED] }
        occurredAt: { type: string, format: date-time }
    RollCompletedEvent:
      type: object
      properties:
        roll: { $ref: '#/components/schemas/LootRoll' }
        winnerId: { type: string }
        occurredAt: { type: string, format: date-time }
    LootAssignedEvent:
      type: object
      properties:
        dropId: { type: string }
        playerId: { type: string }
        item: { $ref: '#/components/schemas/LootItem' }
        partyId: { type: string }
        occurredAt: { type: string, format: date-time }
    BadLuckEvent:
      type: object
      properties:
        playerId: { type: string }
        protection: { $ref: '#/components/schemas/BadLuckProtection' }
        occurredAt: { type: string, format: date-time }
    DuplicateEvent:
      type: object
      properties:
        playerId: { type: string }
        itemId: { type: string }
        locations:
          type: array
          items: { type: string }
        occurredAt: { type: string, format: date-time }
    LootAdvancedError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [ROLL_EXPIRED, PARTY_REQUIRED, NEED_NOT_ALLOWED, DUPLICATE_FOUND, BOSS_LOCKED, BAD_LUCK_INACTIVE]
        message: { type: string }
        traceId: { type: string }
        details: { type: object, additionalProperties: true }
servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
