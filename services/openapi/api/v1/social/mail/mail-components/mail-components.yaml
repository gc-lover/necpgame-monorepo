openapi: 3.0.3
info:
  title: Mail Components
  version: 1.0.0
  x-microservice:
    name: social-service
    port: 8084
    domain: social
    base-path: /api/v1/social/mail
    package: com.necpgame.socialservice
paths: {}
components:
  parameters:
    MailId:
      name: mailId
      in: path
      required: true
      description: Идентификатор письма
      schema: { type: string }
  schemas:
    MailSummary:
      type: object
      properties:
        mailId: { type: string }
        senderId: { type: string }
        senderName: { type: string }
        recipientId: { type: string }
        subject: { type: string }
        hasAttachments: { type: boolean }
        isCOD: { type: boolean }
        status: { type: string, enum: [SENT, DELIVERED, READ, CLAIMED, RETURNED, EXPIRED] }
        sentAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
    MailListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/MailSummary' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    MailDetail:
      type: object
      properties:
        mailId: { type: string }
        senderId: { type: string }
        senderName: { type: string }
        recipientId: { type: string }
        recipientName: { type: string }
        subject: { type: string }
        body: { type: string }
        channel: { type: string, enum: [PLAYER, SYSTEM, GM] }
        isCOD: { type: boolean }
        codInfo: { $ref: '#/components/schemas/CODInfo' }
        attachments:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
        status: { type: string }
        history:
          type: array
          items: { $ref: '#/components/schemas/MailHistoryEntry' }
        sentAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
    MailSendRequest:
      type: object
      required: [recipients, subject, body]
      properties:
        recipients:
          type: array
          items: { type: string }
        subject: { type: string }
        body: { type: string }
        attachments:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
        codInfo: { $ref: '#/components/schemas/CODInfo' }
        idempotencyKey: { type: string }
        metadata: { type: object, additionalProperties: true }
    Attachment:
      type: object
      required: [type]
      properties:
        attachmentId: { type: string }
        type: { type: string, enum: [ITEM, CURRENCY, TOKEN] }
        item:
          type: object
          properties:
            itemId: { type: string }
            itemInstanceId: { type: string }
            quantity: { type: integer }
            metadata: { type: object, additionalProperties: true }
        currency:
          type: object
          properties:
            currencyId: { type: string }
            amount: { type: integer }
        token:
          type: object
          properties:
            tokenId: { type: string }
            amount: { type: integer }
    AttachmentClaimRequest:
      type: object
      properties:
        attachmentIds:
          type: array
          items: { type: string }
    AttachmentClaimResponse:
      type: object
      properties:
        claimed:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
        reservedItems:
          type: array
          items: { type: string }
    CODInfo:
      type: object
      properties:
        amount: { type: integer }
        currencyId: { type: string }
        paid: { type: boolean }
        paidAt: { type: string, format: date-time }
        payerId: { type: string }
        autoAccept: { type: boolean }
    CODPaymentRequest:
      type: object
      required: [paymentMethod]
      properties:
        paymentMethod: { type: string, enum: [WALLET, CASH, TOKEN] }
        confirmationCode: { type: string }
    CODPaymentResponse:
      type: object
      properties:
        mailId: { type: string }
        codInfo: { $ref: '#/components/schemas/CODInfo' }
        attachments:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
    MailReturnRequest:
      type: object
      properties:
        reason: { type: string }
        includeAttachments: { type: boolean, default: true }
    MailFlagRequest:
      type: object
      required: [reason]
      properties:
        reason: { type: string }
        details: { type: string }
        category: { type: string, enum: [SPAM, SCAM, ABUSE, OTHER] }
    MailSettings:
      type: object
      properties:
        autoDeleteExpired: { type: boolean }
        autoAcceptCOD: { type: boolean }
        blockedSenders:
          type: array
          items: { type: string }
        filters:
          type: array
          items:
            type: object
            properties:
              filterId: { type: string }
              type: { type: string }
              value: { type: string }
    MailSettingsUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/MailSettings'
    SystemMailRequest:
      type: object
      required: [templateId, recipients]
      properties:
        templateId: { type: string }
        locale: { type: string }
        recipients:
          type: array
          items: { type: string }
        segments:
          type: array
          items: { type: string }
        subjectOverrides: { type: string }
        bodyVariables: { type: object, additionalProperties: true }
        attachments:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
        scheduleAt: { type: string, format: date-time }
    SystemMailBatchRequest:
      type: object
      required: [batchId, systemMail]
      properties:
        batchId: { type: string }
        systemMail: { $ref: '#/components/schemas/SystemMailRequest' }
        idempotencyKey: { type: string }
    MailHistoryResponse:
      type: object
      properties:
        entries:
          type: array
          items: { $ref: '#/components/schemas/MailHistoryEntry' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    MailHistoryEntry:
      type: object
      properties:
        event: { type: string }
        actorId: { type: string }
        actorType: { type: string }
        timestamp: { type: string, format: date-time }
        details: { type: object, additionalProperties: true }
    MailStats:
      type: object
      properties:
        range: { type: string }
        totalSent: { type: integer }
        totalReceived: { type: integer }
        codSuccessRate: { type: number }
        attachmentClaimRate: { type: number }
        flaggedCount: { type: integer }
    MailEvent:
      type: object
      properties:
        mailId: { type: string }
        recipientId: { type: string }
        senderId: { type: string }
        subject: { type: string }
        eventType: { type: string, enum: [RECEIVED, READ, RETURNED] }
        occurredAt: { type: string, format: date-time }
    AttachmentEvent:
      type: object
      properties:
        mailId: { type: string }
        recipientId: { type: string }
        attachments:
          type: array
          items: { $ref: '#/components/schemas/Attachment' }
        occurredAt: { type: string, format: date-time }
    Codevent:
      type: object
      properties:
        mailId: { type: string }
        recipientId: { type: string }
        codInfo: { $ref: '#/components/schemas/CODInfo' }
        occurredAt: { type: string, format: date-time }
    MailFlagEvent:
      type: object
      properties:
        mailId: { type: string }
        reporterId: { type: string }
        reason: { type: string }
        reportedAt: { type: string, format: date-time }
    MailError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [MAILBOX_FULL, ATTACHMENT_INVALID, COD_REQUIRED, COD_FAILED, MAIL_EXPIRED, RATE_LIMIT, ATTACHMENT_LOCKED, SPAM_BLOCKED]
        message: { type: string }
        traceId: { type: string }
servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
