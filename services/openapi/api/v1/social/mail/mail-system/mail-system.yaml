# Target Architecture:
# - Microservice: social-service (port 8084)
# - API Base: /api/v1/social/mail
# - Dependencies: auth-service, economy-service, notification-service, analytics-service, moderation-service, template-service, support-service
# - Frontend Module: modules/social/mail (useMailStore)
# - UI: MailInbox, MailViewer, MailComposer, MailAttachmentList, CODSummary, MailFilters
# - Forms: MailComposeForm, CODForm, AttachmentPickerForm, MailSearchForm
# - Hooks: useMail, useMailComposer, useMailFilters, useMailNotifications

openapi: 3.0.3
info:
  title: Mail System API
  description: "Внутриигровая почта NECPGAME: отправка, вложения, COD, системные рассылки и история операций."
  version: 1.0.0
  x-microservice:
    name: social-service
    port: 8084
    domain: social
    base-path: /api/v1/social/mail
    package: com.necpgame.socialservice
servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
security:
  - BearerAuth: []
tags:
  - name: Inbox
    description: Работа с входящими письмами
  - name: Outbox
    description: Управление отправленными письмами
  - name: Mail
    description: Операции с письмами и вложениями
  - name: Settings
    description: Настройки почтовой системы
  - name: System Mail
    description: Системные и GM рассылки
  - name: Analytics
    description: Статистика и история
paths:
  /social/mail/inbox:
    get:
      tags: [Inbox]
      summary: Список входящих писем
      parameters:
        - in: query
          name: unread
          schema: { type: boolean }
        - in: query
          name: attachments
          schema: { type: boolean }
        - in: query
          name: from
          schema: { type: string }
        - in: query
          name: system
          schema: { type: boolean }
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageNumber'
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageSize'
      responses:
        '200':
          description: Входящие письма
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailListResponse' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/outbox:
    get:
      tags: [Outbox]
      summary: Список отправленных писем
      parameters:
        - in: query
          name: status
          schema: { type: string }
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageNumber'
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageSize'
      responses:
        '200':
          description: Отправленные письма
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailListResponse' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    get:
      tags: [Mail]
      summary: Получить детали письма
      responses:
        '200':
          description: Полная информация о письме
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailDetail' }
              examples:
                mailDetail:
                  $ref: './mail-examples.yaml#/components/examples/MailDetail'
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
        '404': { $ref: '../../../shared/common/responses.yaml#/components/responses/NotFound' }
    delete:
      tags: [Mail]
      summary: Удалить письмо из почтового ящика
      responses:
        '204':
          description: "Письмо помечено к удалению"
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail:
    post:
      tags: [Mail]
      summary: Отправить письмо
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/MailSendRequest' }
            examples:
              sendMail:
                $ref: './mail-examples.yaml#/components/examples/SendMail'
      responses:
        '201':
          description: Письмо отправлено
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailDetail' }
        '400':
          description: "Ошибка вложений или адресата"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
        '429': { $ref: '../../../shared/common/responses.yaml#/components/responses/TooManyRequests' }
  /social/mail/{mailId}/attachments/claim:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Забрать вложения письма
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/AttachmentClaimRequest' }
      responses:
        '200':
          description: Вложения получены
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/AttachmentClaimResponse' }
        '400':
          description: "Вложения недоступны"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}/cod/pay:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Оплатить COD и получить вложения
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/CODPaymentRequest' }
            examples:
              payCOD:
                $ref: './mail-examples.yaml#/components/examples/CODPaymentRequest'
      responses:
        '200':
          description: COD оплачен, вложения доступны
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/CODPaymentResponse' }
        '400':
          description: "Оплата невозможна"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}/return:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Вернуть письмо отправителю
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/MailReturnRequest' }
      responses:
        '200':
          description: "Письмо возвращено"
        '400':
          description: "Возврат невозможен"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}/flag:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Пожаловаться на письмо
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/MailFlagRequest' }
      responses:
        '202':
          description: "Жалоба зарегистрирована"
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/settings:
    get:
      tags: [Settings]
      summary: Получить почтовые настройки
      responses:
        '200':
          description: Текущие настройки почты
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailSettings' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
    put:
      tags: [Settings]
      summary: Обновить почтовые настройки
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/MailSettingsUpdateRequest' }
      responses:
        '200':
          description: "Настройки обновлены"
        '400':
          description: "Некорректные параметры"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/system:
    post:
      tags: [System Mail]
      summary: Отправить системное письмо или рассылку
      security:
        - ServiceToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/SystemMailRequest' }
            examples:
              systemMail:
                $ref: './mail-examples.yaml#/components/examples/SystemMailRequest'
      responses:
        '202':
          description: "Системная рассылка запланирована"
        '400':
          description: "Ошибка шаблона или сегмента"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/system/batch:
    post:
      tags: [System Mail]
      summary: Массовая отправка писем
      security:
        - ServiceToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: './mail-components.yaml#/components/schemas/SystemMailBatchRequest' }
      responses:
        '202':
          description: "Batch отправка принята"
        '400':
          description: "Нарушение лимитов"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/history:
    get:
      tags: [Analytics]
      summary: Журнал операций почты
      parameters:
        - in: query
          name: type
          schema: { type: string }
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageNumber'
        - $ref: '../../../shared/common/pagination.yaml#/components/parameters/PageSize'
      responses:
        '200':
          description: История операций
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailHistoryResponse' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}/read:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Пометить письмо как прочитанное
      responses:
        '200':
          description: "Письмо отмечено"
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/stats:
    get:
      tags: [Analytics]
      summary: Статистика почтовой активности
      parameters:
        - in: query
          name: range
          schema: { type: string, enum: [24h, 7d, 30d, season] }
      responses:
        '200':
          description: Почтовые метрики
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailStats' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }
  /social/mail/{mailId}/resend:
    parameters:
      - $ref: './mail-components.yaml#/components/parameters/MailId'
    post:
      tags: [Mail]
      summary: Повторно отправить письмо
      responses:
        '202':
          description: "Повторная отправка запланирована"
        '400':
          description: "Повторная отправка невозможна"
          content:
            application/json:
              schema: { $ref: './mail-components.yaml#/components/schemas/MailError' }
        '401': { $ref: '../../../shared/common/responses.yaml#/components/responses/Unauthorized' }

x-websocket:
  url: wss://api.necp.game/v1/social/mail/stream
  description: Realtime события почтовой системы
  messages:
    mailReceived:
      summary: Получено новое письмо
      payload: { $ref: './mail-components.yaml#/components/schemas/MailEvent' }
    mailRead:
      summary: Письмо прочитано
      payload: { $ref: './mail-components.yaml#/components/schemas/MailEvent' }
    mailReturned:
      summary: Письмо возвращено
      payload: { $ref: './mail-components.yaml#/components/schemas/MailEvent' }
    attachmentClaimed:
      summary: Вложения получены
      payload: { $ref: './mail-components.yaml#/components/schemas/AttachmentEvent' }
    codPaid:
      summary: COD оплачен
      payload: { $ref: './mail-components.yaml#/components/schemas/Codevent' }
    mailFlagged:
      summary: Письмо помечено/жалоба
      payload: { $ref: './mail-components.yaml#/components/schemas/MailFlagEvent' }
components:
  securitySchemes:
    BearerAuth: { $ref: '../../../shared/common/security.yaml#/components/securitySchemes/BearerAuth' }
    ServiceToken: { $ref: '../../../shared/common/security.yaml#/components/securitySchemes/ServiceToken' }
    GMToken: { $ref: '../../../shared/common/security.yaml#/components/securitySchemes/GMToken' }
  parameters:
    MailId: { $ref: './mail-components.yaml#/components/parameters/MailId' }
  schemas:
    MailDetail: { $ref: './mail-components.yaml#/components/schemas/MailDetail' }
    MailError: { $ref: './mail-components.yaml#/components/schemas/MailError' }
    MailSettings: { $ref: './mail-components.yaml#/components/schemas/MailSettings' }
  examples:
    MailDetail: { $ref: './mail-examples.yaml#/components/examples/MailDetail' }
    SendMail: { $ref: './mail-examples.yaml#/components/examples/SendMail' }
    CODPaymentRequest: { $ref: './mail-examples.yaml#/components/examples/CODPaymentRequest' }
    SystemMailRequest: { $ref: './mail-examples.yaml#/components/examples/SystemMailRequest' }



