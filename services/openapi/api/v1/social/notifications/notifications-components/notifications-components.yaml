openapi: 3.0.3
info:
  title: Notifications Components
  version: 1.0.0
  x-microservice:
    name: social-service
    port: 8084
    domain: social
    base-path: /api/v1/social/notifications
    package: com.necpgame.socialservice
paths: {}
components:
  parameters:
    NotificationId:
      name: notificationId
      in: path
      required: true
      description: Идентификатор уведомления
      schema: { type: string }
    DeviceId:
      name: deviceId
      in: path
      required: true
      description: Идентификатор зарегистрированного устройства
      schema: { type: string }
  schemas:
    Notification:
      type: object
      required: [notificationId, type, channel, title, status]
      properties:
        notificationId: { type: string }
        type: { type: string }
        title: { type: string }
        message: { type: string }
        channel: { type: string, enum: [IN_GAME, PUSH, EMAIL, SMS] }
        category: { type: string }
        priority: { type: string, enum: [LOW, NORMAL, HIGH, CRITICAL], default: NORMAL }
        payload: { $ref: '#/components/schemas/NotificationPayload' }
        link: { type: string, format: uri }
        expiresAt: { type: string, format: date-time }
        status: { type: string, enum: [UNREAD, READ, DELIVERED, FAILED, ARCHIVED] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    NotificationPayload:
      type: object
      properties:
        context: { type: string }
        entities:
          type: array
          items:
            type: object
            properties:
              type: { type: string }
              id: { type: string }
        cta:
          type: object
          properties:
            label: { type: string }
            action: { type: string }
            target: { type: string }
        metadata: { type: object, additionalProperties: true }
    NotificationInboxResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Notification' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    NotificationHistoryResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Notification' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    NotificationSendRequest:
      type: object
      required: [recipientId, channel, templateId]
      properties:
        recipientId: { type: string }
        channel: { type: string, enum: [IN_GAME, PUSH, EMAIL, SMS] }
        templateId: { type: string }
        locale: { type: string }
        data: { type: object, additionalProperties: true }
        idempotencyKey: { type: string }
        dedupeToken: { type: string }
        priority: { type: string, enum: [LOW, NORMAL, HIGH, CRITICAL] }
        overrides:
          type: object
          properties:
            subject: { type: string }
            message: { type: string }
            media:
              type: array
              items:
                type: object
                properties:
                  type: { type: string }
                  url: { type: string, format: uri }
    NotificationSendResponse:
      type: object
      properties:
        notificationId: { type: string }
        deliveryId: { type: string }
        queuedAt: { type: string, format: date-time }
    NotificationBatchRequest:
      type: object
      required: [batchId, templateId]
      properties:
        batchId: { type: string }
        templateId: { type: string }
        segments:
          type: array
          items: { type: string }
        recipients:
          type: array
          items:
            type: object
            properties:
              recipientId: { type: string }
              locale: { type: string }
              data: { type: object, additionalProperties: true }
        scheduledAt: { type: string, format: date-time }
        priority: { type: string, enum: [LOW, NORMAL, HIGH, CRITICAL] }
        idempotencyKey: { type: string }
    NotificationBatchResponse:
      type: object
      properties:
        batchId: { type: string }
        acceptedRecipients: { type: integer }
        scheduledAt: { type: string, format: date-time }
        status: { type: string, enum: [QUEUED, PROCESSING, COMPLETED, FAILED] }
    NotificationTestRequest:
      type: object
      required: [templateId, channel]
      properties:
        templateId: { type: string }
        channel: { type: string, enum: [IN_GAME, PUSH, EMAIL, SMS] }
        recipient:
          type: object
          properties:
            playerId: { type: string }
            email: { type: string, format: email }
            deviceToken: { type: string }
        data: { type: object, additionalProperties: true }
    NotificationPreferencesResponse:
      type: object
      properties:
        preferences: { $ref: '#/components/schemas/NotificationPreferences' }
    NotificationPreferences:
      type: object
      properties:
        channels:
          type: array
          items: { $ref: '#/components/schemas/NotificationPreferenceChannel' }
        categories:
          type: array
          items: { $ref: '#/components/schemas/NotificationPreferenceCategory' }
        quietHours: { $ref: '#/components/schemas/QuietHours' }
        mutedUntil: { type: string, format: date-time }
    NotificationPreferenceChannel:
      type: object
      properties:
        channel: { type: string, enum: [IN_GAME, PUSH, EMAIL, SMS] }
        enabled: { type: boolean }
        frequency: { type: string, enum: [INSTANT, DIGEST, DAILY], default: INSTANT }
    NotificationPreferenceCategory:
      type: object
      properties:
        category: { type: string }
        enabled: { type: boolean }
        channelOverrides:
          type: array
          items: { $ref: '#/components/schemas/NotificationPreferenceChannel' }
    NotificationPreferencesUpdateRequest:
      type: object
      properties:
        channels:
          type: array
          items: { $ref: '#/components/schemas/NotificationPreferenceChannel' }
        categories:
          type: array
          items: { $ref: '#/components/schemas/NotificationPreferenceCategory' }
        mutedUntil: { type: string, format: date-time }
    QuietHours:
      type: object
      properties:
        start: { type: string, pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$' }
        end: { type: string, pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$' }
        timezone: { type: string }
        suppressCritical: { type: boolean }
    QuietHoursUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/QuietHours'
    NotificationDevicesResponse:
      type: object
      properties:
        devices:
          type: array
          items: { $ref: '#/components/schemas/NotificationDevice' }
    NotificationDevice:
      type: object
      required: [deviceId, platform, status]
      properties:
        deviceId: { type: string }
        platform: { type: string, enum: [IOS, ANDROID, WINDOWS, MAC, WEB] }
        token: { type: string }
        capabilities:
          type: array
          items: { type: string }
        lastSeen: { type: string, format: date-time }
        status: { type: string, enum: [ACTIVE, INACTIVE, REVOKED] }
        metadata: { type: object, additionalProperties: true }
    NotificationDeviceRegisterRequest:
      type: object
      required: [deviceId, platform, token]
      properties:
        deviceId: { type: string }
        platform: { type: string, enum: [IOS, ANDROID, WINDOWS, MAC, WEB] }
        token: { type: string }
        capabilities:
          type: array
          items: { type: string }
        timezone: { type: string }
    NotificationTemplatesResponse:
      type: object
      properties:
        templates:
          type: array
          items: { $ref: '#/components/schemas/NotificationTemplate' }
    NotificationTemplate:
      type: object
      properties:
        templateId: { type: string }
        name: { type: string }
        category: { type: string }
        version: { type: string }
        locales:
          type: array
          items: { type: string }
        variables:
          type: array
          items: { type: string }
    NotificationTemplateRenderRequest:
      type: object
      required: [templateId, locale]
      properties:
        templateId: { type: string }
        locale: { type: string }
        channel: { type: string, enum: [IN_GAME, PUSH, EMAIL, SMS] }
        data: { type: object, additionalProperties: true }
    NotificationTemplateRenderResponse:
      type: object
      properties:
        rendered:
          type: object
          properties:
            title: { type: string }
            body: { type: string }
            html: { type: string }
            plainText: { type: string }
    NotificationDeliveryResponse:
      type: object
      properties:
        deliveries:
          type: array
          items: { $ref: '#/components/schemas/DeliveryStatus' }
        pagination: { $ref: '../../../shared/common/pagination.yaml#/components/schemas/PaginationMeta' }
    DeliveryStatus:
      type: object
      properties:
        deliveryId: { type: string }
        notificationId: { type: string }
        channel: { type: string }
        state: { type: string, enum: [QUEUED, SENT, DELIVERED, FAILED, RETRYING] }
        attempts: { type: integer }
        lastAttemptAt: { type: string, format: date-time }
        error: { type: string }
    NotificationAckRequest:
      type: object
      required: [notificationId, status]
      properties:
        notificationId: { type: string }
        status: { type: string, enum: [READ, DISMISSED] }
        acknowledgedAt: { type: string, format: date-time }
    NotificationWebhookRequest:
      type: object
      required: [url, events]
      properties:
        url: { type: string, format: uri }
        events:
          type: array
          items: { type: string }
        secret: { type: string }
        enabled: { type: boolean, default: true }
    NotificationRetryRequest:
      type: object
      properties:
        reason: { type: string }
        force: { type: boolean }
    NotificationStatusEvent:
      type: object
      properties:
        notificationId: { type: string }
        status: { type: string }
        updatedAt: { type: string, format: date-time }
    NotificationError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [CHANNEL_DISABLED, DEVICE_INVALID, QUIET_HOURS, TEMPLATE_MISSING, DELIVERY_FAILED, PAYLOAD_INVALID, RATE_LIMITED, WEBHOOK_ERROR]
        message: { type: string }
        traceId: { type: string }
servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
