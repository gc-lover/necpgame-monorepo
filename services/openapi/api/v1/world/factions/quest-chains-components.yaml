openapi: 3.0.3
info:
  title: Faction Quest Chains Components
  version: 1.0.0
  description: Переиспользуемые параметры, схемы и ошибки для управления фракционными цепочками контрактов.
  x-microservice:
    name: world-service
    port: 8086
    domain: world
    base-path: /api/v1/world
    package: com.necpgame.worldservice
paths: {}
components:
  parameters:
    ChainId:
      name: chainId
      in: path
      required: true
      schema: { type: string, format: uuid }
      description: Идентификатор цепочки фракционного контракта.
    PlayerId:
      name: playerId
      in: query
      required: false
      schema: { type: string, format: uuid }
    FactionId:
      name: factionId
      in: query
      required: false
      schema: { type: string, format: uuid }
    ReputationMin:
      name: reputationMin
      in: query
      required: false
      schema: { type: integer, minimum: -1000, maximum: 1000 }
    ReputationMax:
      name: reputationMax
      in: query
      required: false
      schema: { type: integer, minimum: -1000, maximum: 1000 }
    IncludeLocked:
      name: includeLocked
      in: query
      required: false
      schema: { type: boolean, default: false }
    BranchId:
      name: branchId
      in: query
      required: false
      schema: { type: string }
    AuditReason:
      name: X-Audit-Reason
      in: header
      required: false
      schema: { type: string, maxLength: 160 }
    ContractTraceId:
      name: X-Contract-Trace-Id
      in: header
      required: false
      schema: { type: string, maxLength: 64 }
  schemas:
    ChainVisibility:
      type: string
      enum: [PUBLIC, FACTION_ONLY, GUILD_BOARD, HIDDEN]
    ChainStatus:
      type: string
      enum: [AVAILABLE, LOCKED, IN_PROGRESS, COMPLETED, COOLDOWN]
    StageType:
      type: string
      enum: [STORY, ESCORT, SABOTAGE, DEFENSE, INVESTIGATION, DIPLOMACY, ARCHIVE, TRIBUNAL]
    BranchType:
      type: string
      enum: [ESCORT, SABOTAGE, ARCHIVE, TRIBUNAL, INFILTRATION, EXTRACTION]
    ReputationImpactType:
      type: string
      enum: [GAIN, LOSS]
    EntryRequirement:
      type: object
      properties:
        minimumLevel: { type: integer, minimum: 1, maximum: 100 }
        reputationThreshold: { type: integer, minimum: -1000, maximum: 1000 }
        prerequisiteChains:
          type: array
          items: { type: string, format: uuid }
        worldFlagsRequired:
          type: array
          items: { type: string }
        cooldownExpiresAt: { type: string, format: date-time }
        guildStandingRequired: { type: integer, minimum: 0, maximum: 100 }
    StageObjective:
      type: object
      required: [objectiveId, type, target]
      properties:
        objectiveId: { type: string }
        type: { type: string }
        target: { type: string }
        quantity: { type: integer, minimum: 1 }
        optional: { type: boolean, default: false }
        progress:
          type: object
          properties:
            current: { type: number }
            total: { type: number }
            percentage: { type: number, minimum: 0, maximum: 100 }
    BranchOption:
      type: object
      required: [branchId, title, type]
      properties:
        branchId: { type: string }
        title: { type: string }
        type: { $ref: '#/components/schemas/BranchType' }
        description: { type: string }
        recommendedRoles:
          type: array
          items: { type: string }
        reputationPreview:
          type: array
          items: { $ref: '#/components/schemas/ReputationChange' }
        rewardPreview: { $ref: '#/components/schemas/RewardPayload' }
        lockoutOnSelect: { type: integer, description: "Длительность блокировки в минутах", minimum: 0 }
    ChainStage:
      type: object
      required: [stageId, title, type, order]
      properties:
        stageId: { type: string }
        title: { type: string }
        order: { type: integer, minimum: 1 }
        type: { $ref: '#/components/schemas/StageType' }
        description: { type: string }
        objectives:
          type: array
          items: { $ref: '#/components/schemas/StageObjective' }
        branchOptions:
          type: array
          items: { $ref: '#/components/schemas/BranchOption' }
        recommendedPowerScore: { type: integer, minimum: 0 }
        worldFlagUpdates:
          type: array
          items: { type: string }
        timerSeconds: { type: integer, minimum: 0 }
    ReputationChange:
      type: object
      required: [factionId, delta]
      properties:
        factionId: { type: string, format: uuid }
        delta: { type: integer, minimum: -200, maximum: 200 }
        type: { $ref: '#/components/schemas/ReputationImpactType' }
        reason: { type: string }
        capMin: { type: integer, minimum: -1000, maximum: 1000 }
        capMax: { type: integer, minimum: -1000, maximum: 1000 }
    RewardAsset:
      type: object
      properties:
        type: { type: string, enum: [CREDITS, ITEM, BLUEPRINT, GUILD_FAVOR, WORLD_FLAG, TITLE] }
        assetId: { type: string }
        quantity: { type: integer, minimum: 1 }
        quality: { type: string }
    RewardPayload:
      type: object
      properties:
        rewards:
          type: array
          items: { $ref: '#/components/schemas/RewardAsset' }
        economyProfile: { type: string }
        deliveryMethod: { type: string, enum: [DIRECT, MAIL, VENDOR] }
        unlockedVendors:
          type: array
          items: { type: string, format: uuid }
    FactionChain:
      type: object
      required: [chainId, factionId, name, status, visibility]
      properties:
        chainId: { type: string, format: uuid }
        factionId: { type: string, format: uuid }
        name: { type: string }
        synopsis: { type: string }
        visibility: { $ref: '#/components/schemas/ChainVisibility' }
        status: { $ref: '#/components/schemas/ChainStatus' }
        entryRequirements: { $ref: '#/components/schemas/EntryRequirement' }
        contactNpc:
          type: object
          properties:
            npcId: { type: string, format: uuid }
            name: { type: string }
            location: { type: string }
        stages:
          type: array
          items: { $ref: '#/components/schemas/ChainStage' }
        estimatedDurationMinutes: { type: integer, minimum: 5 }
        cooldownMinutes: { type: integer, minimum: 0 }
        lockoutUntil: { type: string, format: date-time }
        reputationImpacts:
          type: array
          items: { $ref: '#/components/schemas/ReputationChange' }
        rewards: { $ref: '#/components/schemas/RewardPayload' }
        telemetry:
          type: object
          properties:
            contractSuccessRate: { type: number, minimum: 0, maximum: 1 }
            branchPreferenceIndex: { type: number, minimum: 0, maximum: 1 }
    FactionChainList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/FactionChain' }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
    AcceptRequest:
      type: object
      required: [playerId]
      properties:
        playerId: { type: string, format: uuid }
        partyId: { type: string, format: uuid }
        guildId: { type: string, format: uuid }
        entryContext: { type: string }
        forceOverride: { type: boolean, default: false }
    BranchSelectionRequest:
      type: object
      required: [playerId, branchId]
      properties:
        playerId: { type: string, format: uuid }
        branchId: { type: string }
        rationale: { type: string }
    ProgressUpdate:
      type: object
      required: [playerId, stageId]
      properties:
        playerId: { type: string, format: uuid }
        stageId: { type: string }
        branchId: { type: string }
        objectiveId: { type: string }
        progressValue: { type: number }
        status: { type: string, enum: [STARTED, IN_PROGRESS, COMPLETED, FAILED] }
        worldFlags:
          type: array
          items: { type: string }
        telemetry:
          type: object
          properties:
            event: { type: string, enum: [contract_viewed, contract_progressed, contract_failed] }
            metadata: { type: object, additionalProperties: true }
    OutcomeRequest:
      type: object
      required: [playerId, outcome]
      properties:
        playerId: { type: string, format: uuid }
        outcome: { type: string, enum: [SUCCESS, FAILURE, ABORTED] }
        rewardsOverride: { $ref: '#/components/schemas/RewardPayload' }
        reputationChanges:
          type: array
          items: { $ref: '#/components/schemas/ReputationChange' }
        analytics:
          type: object
          properties:
            completionTimeSeconds: { type: integer, minimum: 0 }
            branchPath: { type: string }
            anomalies: { type: array, items: { type: string } }
    OutcomeResponse:
      type: object
      properties:
        chainId: { type: string, format: uuid }
        outcome: { type: string }
        rewards: { $ref: '#/components/schemas/RewardPayload' }
        reputation: { type: array, items: { $ref: '#/components/schemas/ReputationChange' } }
        unlocks:
          type: array
          items: { type: string }
        scheduledFollowUps:
          type: array
          items: { type: string, format: uuid }
    ContractError:
      allOf:
        - $ref: '../../shared/common/responses.yaml#/components/schemas/Error'
        - type: object
          properties:
            error:
              type: object
              properties:
                code:
                  type: string
                  enum:
                    - BIZ_FACTION_CONTRACT_LOCKED
                    - BIZ_FACTION_CONTRACT_COOLDOWN
                    - BIZ_FACTION_CONTRACT_NOT_FOUND
                    - BIZ_FACTION_BRANCH_NOT_AVAILABLE
                    - BIZ_FACTION_STAGE_INVALID
                    - BIZ_FACTION_OUTCOME_ALREADY_APPLIED
                    - VAL_FACTION_REQUIREMENTS_FAILED
                    - VAL_FACTION_BRANCH_INVALID
                    - VAL_FACTION_PROGRESS_INVALID
                    - INT_FACTION_SOCIAL_SERVICE_FAILURE
                    - INT_FACTION_ECONOMY_SERVICE_FAILURE
                    - INT_FACTION_ANALYTICS_FAILURE
              required: [code, message]

servers:
  - url: https://api.necp.game/v1
    description: Production API Gateway
  - url: http://localhost:8080/api/v1
    description: Local API Gateway
