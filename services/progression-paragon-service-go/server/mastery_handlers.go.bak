// Issue: #1604
package server

import (
	"context"
	"encoding/json"
	"net/http"
	"time"

	"github.com/google/uuid"
	masteryapi "github.com/necpgame/progression-paragon-service-go/pkg/api/mastery"
	"github.com/sirupsen/logrus"
)

// Context timeout constants
const (
	DBTimeout = 50 * time.Millisecond
)

type MasteryHandlers struct {
	service MasteryServiceInterface
	logger  *logrus.Logger
}

func NewMasteryHandlers(service MasteryServiceInterface) *MasteryHandlers {
	return &MasteryHandlers{
		service: service,
		logger:  GetLogger(),
	}
}

func (h *MasteryHandlers) GetMasteryLevels(w http.ResponseWriter, r *http.Request, params masteryapi.GetMasteryLevelsParams) {
	ctx, cancel := context.WithTimeout(r.Context(), DBTimeout)
	defer cancel()

	characterID := uuid.UUID(params.CharacterId)

	levels, err := h.service.GetMasteryLevels(ctx, characterID)
	if err != nil {
		h.logger.WithError(err).Error("Failed to get mastery levels")
		h.respondError(w, http.StatusInternalServerError, "failed to get mastery levels")
		return
	}

	if levels == nil {
		h.respondError(w, http.StatusNotFound, "mastery levels not found")
		return
	}

	apiLevels := convertMasteryLevelsToAPI(levels)
	h.respondJSON(w, http.StatusOK, apiLevels)
}

func (h *MasteryHandlers) GetMasteryProgress(w http.ResponseWriter, r *http.Request, pType masteryapi.GetMasteryProgressParamsType, params masteryapi.GetMasteryProgressParams) {
	ctx, cancel := context.WithTimeout(r.Context(), DBTimeout)
	defer cancel()

	characterID := uuid.UUID(params.CharacterId)
	masteryType := string(pType)

	progress, err := h.service.GetMasteryProgress(ctx, characterID, masteryType)
	if err != nil {
		h.logger.WithError(err).Error("Failed to get mastery progress")
		if err.Error() == "invalid mastery type: "+masteryType {
			h.respondError(w, http.StatusBadRequest, "invalid mastery type")
			return
		}
		h.respondError(w, http.StatusInternalServerError, "failed to get mastery progress")
		return
	}

	if progress == nil {
		h.respondError(w, http.StatusNotFound, "mastery progress not found")
		return
	}

	apiProgress := convertMasteryProgressToAPI(progress)
	h.respondJSON(w, http.StatusOK, apiProgress)
}

func (h *MasteryHandlers) GetMasteryRewards(w http.ResponseWriter, r *http.Request, params masteryapi.GetMasteryRewardsParams) {
	ctx, cancel := context.WithTimeout(r.Context(), DBTimeout)
	defer cancel()

	characterID := uuid.UUID(params.CharacterId)
	var masteryType *string
	if params.MasteryType != nil {
		masteryTypeStr := string(*params.MasteryType)
		masteryType = &masteryTypeStr
	}

	rewards, err := h.service.GetMasteryRewards(ctx, characterID, masteryType)
	if err != nil {
		h.logger.WithError(err).Error("Failed to get mastery rewards")
		if masteryType != nil && err.Error() == "invalid mastery type: "+*masteryType {
			h.respondError(w, http.StatusBadRequest, "invalid mastery type")
			return
		}
		h.respondError(w, http.StatusInternalServerError, "failed to get mastery rewards")
		return
	}

	if rewards == nil {
		h.respondError(w, http.StatusNotFound, "mastery rewards not found")
		return
	}

	apiRewards := convertMasteryRewardsToAPI(rewards)
	h.respondJSON(w, http.StatusOK, apiRewards)
}

func convertMasteryLevelsToAPI(levels *MasteryLevels) masteryapi.MasteryLevels {
	characterID := uuid.UUID(levels.CharacterID)
	masteries := make([]masteryapi.Mastery, len(levels.Masteries))
	
	for i, m := range levels.Masteries {
		masteryType := masteryapi.MasteryMasteryType(m.MasteryType)
		masteryLevel := m.MasteryLevel
		expCurrent := int(m.ExperienceCurrent)
		expRequired := int(m.ExperienceRequired)
		
		var rewards *[]struct {
			Level      *int    `json:"level,omitempty"`
			RewardId   *string `json:"reward_id,omitempty"`
			RewardType *string `json:"reward_type,omitempty"`
		}
		if len(m.RewardsUnlocked) > 0 {
			rewardsList := make([]struct {
				Level      *int    `json:"level,omitempty"`
				RewardId   *string `json:"reward_id,omitempty"`
				RewardType *string `json:"reward_type,omitempty"`
			}, len(m.RewardsUnlocked))
			for j, r := range m.RewardsUnlocked {
				level := r.Level
				rewardType := r.RewardType
				rewardID := r.RewardID
				rewardsList[j] = struct {
					Level      *int    `json:"level,omitempty"`
					RewardId   *string `json:"reward_id,omitempty"`
					RewardType *string `json:"reward_type,omitempty"`
				}{
					Level:      &level,
					RewardType: &rewardType,
					RewardId:   &rewardID,
				}
			}
			rewards = &rewardsList
		}
		
		masteries[i] = masteryapi.Mastery{
			MasteryType:       &masteryType,
			MasteryLevel:      &masteryLevel,
			ExperienceCurrent: &expCurrent,
			ExperienceRequired: &expRequired,
			RewardsUnlocked:   rewards,
		}
	}

	return masteryapi.MasteryLevels{
		CharacterId: &characterID,
		Masteries:   &masteries,
	}
}

func convertMasteryProgressToAPI(progress *MasteryProgress) masteryapi.MasteryProgress {
	characterID := uuid.UUID(progress.CharacterID)
	masteryType := masteryapi.MasteryProgressMasteryType(progress.MasteryType)
	masteryLevel := progress.MasteryLevel
	expCurrent := int(progress.ExperienceCurrent)
	expRequired := int(progress.ExperienceRequired)
	totalExperience := int(progress.TotalExperienceEarned)
	completions := progress.CompletionsCount
	progressPercent := float32(progress.ProgressPercent)
	
	var rewards *[]struct {
		Level      *int       `json:"level,omitempty"`
		RewardId   *string    `json:"reward_id,omitempty"`
		RewardType *string    `json:"reward_type,omitempty"`
		UnlockedAt *time.Time `json:"unlocked_at,omitempty"`
	}
	if len(progress.RewardsUnlocked) > 0 {
		rewardsList := make([]struct {
			Level      *int       `json:"level,omitempty"`
			RewardId   *string    `json:"reward_id,omitempty"`
			RewardType *string    `json:"reward_type,omitempty"`
			UnlockedAt *time.Time `json:"unlocked_at,omitempty"`
		}, len(progress.RewardsUnlocked))
		for i, r := range progress.RewardsUnlocked {
			level := r.Level
			rewardType := r.RewardType
			rewardID := r.RewardID
			rewardsList[i] = struct {
				Level      *int       `json:"level,omitempty"`
				RewardId   *string    `json:"reward_id,omitempty"`
				RewardType *string    `json:"reward_type,omitempty"`
				UnlockedAt *time.Time `json:"unlocked_at,omitempty"`
			}{
				Level:      &level,
				RewardType: &rewardType,
				RewardId:   &rewardID,
				UnlockedAt: r.UnlockedAt,
			}
		}
		rewards = &rewardsList
	}

	return masteryapi.MasteryProgress{
		CharacterId:        &characterID,
		MasteryType:        &masteryType,
		MasteryLevel:       &masteryLevel,
		ExperienceCurrent: &expCurrent,
		ExperienceRequired: &expRequired,
		TotalExperienceEarned: &totalExperience,
		CompletionsCount:       &completions,
		ProgressPercent:    &progressPercent,
		RewardsUnlocked:    rewards,
	}
}

func convertMasteryRewardsToAPI(rewards *MasteryRewards) masteryapi.MasteryRewards {
	characterID := uuid.UUID(rewards.CharacterID)
	
	rewardItems := make([]struct {
		Level       *int                              `json:"level,omitempty"`
		MasteryType *masteryapi.MasteryRewardsRewardsMasteryType `json:"mastery_type,omitempty"`
		RewardId    *string                           `json:"reward_id,omitempty"`
		RewardName  *string                           `json:"reward_name,omitempty"`
		RewardType  *string                           `json:"reward_type,omitempty"`
		Unlocked    *bool                             `json:"unlocked,omitempty"`
		UnlockedAt  *time.Time                        `json:"unlocked_at"`
	}, len(rewards.Rewards))
	
	for i, r := range rewards.Rewards {
		masteryType := masteryapi.MasteryRewardsRewardsMasteryType(r.MasteryType)
		level := r.Level
		rewardType := r.RewardType
		rewardID := r.RewardID
		rewardName := r.RewardName
		unlocked := r.Unlocked
		rewardItems[i] = struct {
			Level       *int                              `json:"level,omitempty"`
			MasteryType *masteryapi.MasteryRewardsRewardsMasteryType `json:"mastery_type,omitempty"`
			RewardId    *string                           `json:"reward_id,omitempty"`
			RewardName  *string                           `json:"reward_name,omitempty"`
			RewardType  *string                           `json:"reward_type,omitempty"`
			Unlocked    *bool                             `json:"unlocked,omitempty"`
			UnlockedAt  *time.Time                        `json:"unlocked_at"`
		}{
			MasteryType: &masteryType,
			Level:       &level,
			RewardType:  &rewardType,
			RewardId:    &rewardID,
			RewardName:  &rewardName,
			Unlocked:    &unlocked,
			UnlockedAt:  r.UnlockedAt,
		}
	}

	return masteryapi.MasteryRewards{
		CharacterId: &characterID,
		Rewards:     &rewardItems,
	}
}

func (h *MasteryHandlers) respondJSON(w http.ResponseWriter, status int, data interface{}) {
	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(status)
	json.NewEncoder(w).Encode(data)
}

func (h *MasteryHandlers) respondError(w http.ResponseWriter, status int, message string) {
	errorResponse := map[string]string{
		"error":   http.StatusText(status),
		"message": message,
	}
	h.respondJSON(w, status, errorResponse)
}
