openapi: 3.0.3
info:
  title: Quest Engine Rewards and Events Service API
  description: |
    API для управления наградами и событиями квестов.

    **Основные возможности:**
    - Распределение наград за квесты
    - Получение информации о наградах
    - Просмотр событий квестов
  version: 1.0.0
  license:
    name: Proprietary
  contact:
    name: NECPGAME API Support
    url: https://necpgame.com/support
    email: api@necpgame.com
servers:
  - url: http://localhost:8083/api/v1
    description: Gameplay Service (локальная разработка)
  - url: https://gameplay.necpgame.com/api/v1
    description: Gameplay Service (продакшн)
tags:
  - name: Quest Rewards
    description: Награды за квесты
  - name: Quest Events
    description: События квестов
paths:
  /gameplay/quests/{quest_id}/rewards/distribute:
    post:
      tags:
        - Quest Rewards
      summary: Распределить награды за квест
      description: |
        Распределяет награды за завершённый квест.
        Выдаёт опыт, валюту, предметы, репутацию и титулы.
        Интегрируется с economy-service и mail-service.
      operationId: distributeQuestRewards
      security:
        - BearerAuth: [ ]
      parameters:
        - name: quest_id
          in: path
          required: true
          description: ID инстанса квеста
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Награды успешно распределены
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - rewards
                properties:
                  success:
                    type: boolean
                    description: Успешно ли распределены награды
                  rewards:
                    $ref: '#/components/schemas/QuestRewards'
                  distribution_details:
                    type: object
                    description: Детали распределения (какие награды куда отправлены)
                    additionalProperties: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /gameplay/quests/{quest_id}/rewards:
    get:
      tags:
        - Quest Rewards
      summary: Получить награды квеста
      description: |
        Возвращает информацию о наградах квеста.
        Показывает, какие награды будут выданы при завершении квеста.
      operationId: getQuestRewards
      security:
        - BearerAuth: [ ]
      parameters:
        - name: quest_id
          in: path
          required: true
          description: ID определения квеста или инстанса квеста
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Награды квеста
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestRewards'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /gameplay/quests/{quest_id}/events:
    get:
      tags:
        - Quest Events
      summary: Получить события квеста
      description: |
        Возвращает историю событий квеста.
        Включает события начала, выполнения целей, завершения и отмены.
        Поддерживает фильтрацию по типу события и пагинацию.
      operationId: getQuestEvents
      security:
        - BearerAuth: [ ]
      parameters:
        - name: quest_id
          in: path
          required: true
          description: ID инстанса квеста
          schema:
            type: string
            format: uuid
        - name: event_type
          in: query
          description: Фильтр по типу события
          schema:
            type: string
            enum:
              - started
              - objective-completed
              - completed
              - failed
              - cancelled
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Список событий квеста
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestEventsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен для аутентификации
  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: BadRequest
            message: Неверные параметры запроса
            code: INVALID_PARAMETERS
    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            message: Требуется аутентификация
            code: AUTH_REQUIRED
    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: NotFound
            message: Ресурс не найден
            code: RESOURCE_NOT_FOUND
    InternalServerError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: InternalServerError
            message: Внутренняя ошибка сервера
            code: INTERNAL_ERROR
  schemas:
    QuestRewards:
      type: object
      properties:
        experience:
          type: integer
          description: Опыт
          minimum: 0
        currency:
          type: integer
          description: Валюта
          minimum: 0
        items:
          type: array
          description: Предметы
          items:
            type: object
            properties:
              item_id:
                type: string
                format: uuid
              quantity:
                type: integer
                minimum: 1
        reputation:
          type: object
          description: Репутация
          additionalProperties: true
        titles:
          type: array
          description: Титулы
          items:
            type: string
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Тип ошибки
        message:
          type: string
          description: Сообщение об ошибке
        code:
          type: string
          description: Код ошибки
          nullable: true
        details:
          type: object
          additionalProperties: true
          description: Дополнительные детали ошибки
          nullable: true
    QuestEvent:
      type: object
      required:
        - event_type
        - timestamp
      properties:
        id:
          type: string
          format: uuid
          description: ID события
        quest_instance_id:
          type: string
          format: uuid
          description: ID инстанса квеста
        event_type:
          type: string
          enum:
            - started
            - objective-completed
            - completed
            - failed
            - cancelled
          description: |
            Тип события:
            - `started` - квест начат
            - `objective-completed` - цель выполнена
            - `completed` - квест завершён
            - `failed` - квест провален
            - `cancelled` - квест отменён
        event_data:
          type: object
          description: Данные события (JSON)
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
          description: Время события
    QuestEventsResponse:
      type: object
      required:
        - events
        - total
      properties:
        events:
          type: array
          description: Список событий
          items:
            $ref: '#/components/schemas/QuestEvent'
        total:
          type: integer
          description: Общее количество событий
          minimum: 0
  parameters:
    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 50
      description: Количество элементов на странице
    Offset:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Смещение для пагинации
