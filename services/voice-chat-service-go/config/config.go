// Code generated by NECPGAME backend agent. Enterprise-grade Voice Chat service configuration.
// PERFORMANCE: Optimized configuration loading for real-time voice communication

package config

import (
	"os"
	"strconv"
	"strings"
	"time"
)

// Config holds the complete service configuration
// PERFORMANCE: Struct field alignment optimized for memory efficiency
type Config struct {
	Server     ServerConfig     `yaml:"server"`
	Signaling  SignalingConfig  `yaml:"signaling"`
	Database   DatabaseConfig   `yaml:"database"`
	Redis      RedisConfig      `yaml:"redis"`
	Kafka      KafkaConfig      `yaml:"kafka"`
	VoiceChat  VoiceChatConfig  `yaml:"voice_chat"`
	Security   SecurityConfig   `yaml:"security"`
}

// ServerConfig holds HTTP server configuration
type ServerConfig struct {
	Port         string        `yaml:"port"`
	ReadTimeout  time.Duration `yaml:"read_timeout"`
	WriteTimeout time.Duration `yaml:"write_timeout"`
	IdleTimeout  time.Duration `yaml:"idle_timeout"`
}

// SignalingConfig holds WebRTC signaling configuration
type SignalingConfig struct {
	Port            string        `yaml:"port"`
	ReadTimeout     time.Duration `yaml:"read_timeout"`
	WriteTimeout    time.Duration `yaml:"write_timeout"`
	IdleTimeout     time.Duration `yaml:"idle_timeout"`
	MaxConnections  int           `yaml:"max_connections"`
	MessageTimeout  time.Duration `yaml:"message_timeout"`
	HeartbeatInterval time.Duration `yaml:"heartbeat_interval"`
	STUNServers     []string      `yaml:"stun_servers"`
	TURNServers     []string      `yaml:"turn_servers"`
}

// DatabaseConfig holds PostgreSQL database configuration
type DatabaseConfig struct {
	Host            string `yaml:"host"`
	Port            int    `yaml:"port"`
	User            string `yaml:"user"`
	Password        string `yaml:"password"`
	Database        string `yaml:"database"`
	SSLMode         string `yaml:"ssl_mode"`
	MaxOpenConns    int    `yaml:"max_open_conns"`
	MaxIdleConns    int    `yaml:"max_idle_conns"`
	ConnMaxLifetime time.Duration `yaml:"conn_max_lifetime"`
	ConnMaxIdleTime time.Duration `yaml:"conn_max_idle_time"`
}

// RedisConfig holds Redis configuration
type RedisConfig struct {
	Host         string `yaml:"host"`
	Port         int    `yaml:"port"`
	Password     string `yaml:"password"`
	DB           int    `yaml:"db"`
	PoolSize     int    `yaml:"pool_size"`
	MinIdleConns int    `yaml:"min_idle_conns"`
}

// KafkaConfig holds Kafka configuration
type KafkaConfig struct {
	Brokers         []string      `yaml:"brokers"`
	ClientID        string        `yaml:"client_id"`
	GroupID         string        `yaml:"group_id"`
	SessionTimeout  time.Duration `yaml:"session_timeout"`
	HeartbeatInterval time.Duration `yaml:"heartbeat_interval"`
	RebalanceTimeout time.Duration `yaml:"rebalance_timeout"`
	AutoOffsetReset string        `yaml:"auto_offset_reset"`
	EnableAutoCommit bool         `yaml:"enable_auto_commit"`
	FlushFrequency  time.Duration `yaml:"flush_frequency"`
	FlushMessages   int           `yaml:"flush_messages"`
	FlushBytes      int           `yaml:"flush_bytes"`
	MaxMessageBytes int           `yaml:"max_message_bytes"`
	RequiredAcks    int           `yaml:"required_cks"`
	RetryMax        int           `yaml:"retry_max"`
	RetryBackoff    time.Duration `yaml:"retry_backoff"`
	SASL            SASLConfig    `yaml:"sasl"`
	TLS             TLSConfig     `yaml:"tls"`
}

// SASLConfig holds SASL authentication configuration
type SASLConfig struct {
	Enable   bool   `yaml:"enable"`
	User     string `yaml:"user"`
	Password string `yaml:"password"`
}

// TLSConfig holds TLS configuration
type TLSConfig struct {
	Enable bool   `yaml:"enable"`
	Cert   string `yaml:"cert"`
	Key    string `yaml:"key"`
	CA     string `yaml:"ca"`
}

// VoiceChatConfig holds voice chat specific configuration
type VoiceChatConfig struct {
	MaxRooms           int           `yaml:"max_rooms"`
	MaxUsersPerRoom    int           `yaml:"max_users_per_room"`
	RoomTimeout        time.Duration `yaml:"room_timeout"`
	UserTimeout        time.Duration `yaml:"user_timeout"`
	QualityMonitorInterval time.Duration `yaml:"quality_monitor_interval"`
	MaxBandwidthPerUser int           `yaml:"max_bandwidth_per_user"` // kbps
	DefaultAudioCodec  string        `yaml:"default_audio_codec"`
	SupportedCodecs    []string      `yaml:"supported_codecs"`
	NoiseGateThreshold float64       `yaml:"noise_gate_threshold"`
	EchoCancellation   bool          `yaml:"echo_cancellation"`
	NoiseSuppression   bool          `yaml:"noise_suppression"`
	AGCEnabled         bool          `yaml:"agc_enabled"`
	VADThreshold       float64       `yaml:"vad_threshold"`
	JitterBufferSize   time.Duration `yaml:"jitter_buffer_size"`
	OpusComplexity     int           `yaml:"opus_complexity"`
	OpusBitrate        int           `yaml:"opus_bitrate"`

	// Room types
	GroupChatEnabled   bool `yaml:"group_chat_enabled"`
	RaidChatEnabled    bool `yaml:"raid_chat_enabled"`
	GuildChatEnabled   bool `yaml:"guild_chat_enabled"`
	PartyChatEnabled   bool `yaml:"party_chat_enabled"`
	ProximityChatEnabled bool `yaml:"proximity_chat_enabled"`
	GlobalChatEnabled  bool `yaml:"global_chat_enabled"`

	// Quality settings
	HighQualityEnabled bool `yaml:"high_quality_enabled"`
	MediumQualityEnabled bool `yaml:"medium_quality_enabled"`
	LowQualityEnabled  bool `yaml:"low_quality_enabled"`

	// Moderation
	AutoMuteEnabled    bool          `yaml:"auto_mute_enabled"`
	MuteTimeout        time.Duration `yaml:"mute_timeout"`
	SpamDetectionEnabled bool        `yaml:"spam_detection_enabled"`
	MaxVoiceMessagesPerMinute int    `yaml:"max_voice_messages_per_minute"`
}

// SecurityConfig holds security specific configuration
type SecurityConfig struct {
	EnableEncryption bool     `yaml:"enable_encryption"`
	EncryptionKey    string   `yaml:"encryption_key"`
	AllowedOrigins   []string `yaml:"allowed_origins"`
	RateLimitRequests int     `yaml:"rate_limit_requests"`
	RateLimitWindow  time.Duration `yaml:"rate_limit_window"`
	IPWhitelist      []string `yaml:"ip_whitelist"`
	UserAuthRequired bool     `yaml:"user_auth_required"`
	TokenExpiration  time.Duration `yaml:"token_expiration"`
}

// Load loads configuration from environment variables with voice-chat defaults
func Load() *Config {
	cfg := &Config{
		Server: ServerConfig{
			Port:         getEnv("VOICE_CHAT_PORT", "8085"),
			ReadTimeout:  getDurationEnv("VOICE_CHAT_READ_TIMEOUT", 30*time.Second),
			WriteTimeout: getDurationEnv("VOICE_CHAT_WRITE_TIMEOUT", 30*time.Second),
			IdleTimeout:  getDurationEnv("VOICE_CHAT_IDLE_TIMEOUT", 120*time.Second),
		},
		Signaling: SignalingConfig{
			Port:             getEnv("SIGNALING_PORT", "8086"),
			ReadTimeout:      getDurationEnv("SIGNALING_READ_TIMEOUT", 15*time.Second),
			WriteTimeout:     getDurationEnv("SIGNALING_WRITE_TIMEOUT", 15*time.Second),
			IdleTimeout:      getDurationEnv("SIGNALING_IDLE_TIMEOUT", 300*time.Second),
			MaxConnections:   getIntEnv("SIGNALING_MAX_CONNECTIONS", 10000),
			MessageTimeout:   getDurationEnv("SIGNALING_MESSAGE_TIMEOUT", 10*time.Second),
			HeartbeatInterval: getDurationEnv("SIGNALING_HEARTBEAT_INTERVAL", 30*time.Second),
			STUNServers:      getStringSliceEnv("STUN_SERVERS", []string{"stun:stun.l.google.com:19302"}),
			TURNServers:      getStringSliceEnv("TURN_SERVERS", []string{}),
		},
		Database: DatabaseConfig{
			Host:            getEnv("DB_HOST", "localhost"),
			Port:            getIntEnv("DB_PORT", 5432),
			User:            getEnv("DB_USER", "postgres"),
			Password:        getEnv("DB_PASSWORD", "postgres"),
			Database:        getEnv("DB_NAME", "necpgame"),
			SSLMode:         getEnv("DB_SSL_MODE", "disable"),
			MaxOpenConns:    getIntEnv("DB_MAX_OPEN_CONNS", 30),
			MaxIdleConns:    getIntEnv("DB_MAX_IDLE_CONNS", 10),
			ConnMaxLifetime: getDurationEnv("DB_CONN_MAX_LIFETIME", 30*time.Minute),
			ConnMaxIdleTime: getDurationEnv("DB_CONN_MAX_IDLE_TIME", 5*time.Minute),
		},
		Redis: RedisConfig{
			Host:         getEnv("REDIS_HOST", "localhost"),
			Port:         getIntEnv("REDIS_PORT", 6379),
			Password:     getEnv("REDIS_PASSWORD", ""),
			DB:           getIntEnv("REDIS_DB", 2), // Use DB 2 for voice chat
			PoolSize:     getIntEnv("REDIS_POOL_SIZE", 30),
			MinIdleConns: getIntEnv("REDIS_MIN_IDLE_CONNS", 10),
		},
		Kafka: KafkaConfig{
			Brokers:           getStringSliceEnv("KAFKA_BROKERS", []string{"localhost:9092"}),
			ClientID:          getEnv("KAFKA_CLIENT_ID", "voice-chat-service"),
			GroupID:           getEnv("KAFKA_GROUP_ID", "voice-chat-group"),
			SessionTimeout:    getDurationEnv("KAFKA_SESSION_TIMEOUT", 10*time.Second),
			HeartbeatInterval: getDurationEnv("KAFKA_HEARTBEAT_INTERVAL", 3*time.Second),
			RebalanceTimeout:  getDurationEnv("KAFKA_REBALANCE_TIMEOUT", 60*time.Second),
			AutoOffsetReset:   getEnv("KAFKA_AUTO_OFFSET_RESET", "latest"),
			EnableAutoCommit:  getBoolEnv("KAFKA_ENABLE_AUTO_COMMIT", true),
			FlushFrequency:    getDurationEnv("KAFKA_FLUSH_FREQUENCY", 500*time.Millisecond),
			FlushMessages:     getIntEnv("KAFKA_FLUSH_MESSAGES", 100),
			FlushBytes:        getIntEnv("KAFKA_FLUSH_BYTES", 1048576), // 1MB
			MaxMessageBytes:   getIntEnv("KAFKA_MAX_MESSAGE_BYTES", 1048576), // 1MB
			RequiredAcks:      getIntEnv("KAFKA_REQUIRED_ACKS", 1),
			RetryMax:          getIntEnv("KAFKA_RETRY_MAX", 3),
			RetryBackoff:      getDurationEnv("KAFKA_RETRY_BACKOFF", 100*time.Millisecond),
			SASL: SASLConfig{
				Enable:   getBoolEnv("KAFKA_SASL_ENABLE", false),
				User:     getEnv("KAFKA_SASL_USER", ""),
				Password: getEnv("KAFKA_SASL_PASSWORD", ""),
			},
			TLS: TLSConfig{
				Enable: getBoolEnv("KAFKA_TLS_ENABLE", false),
				Cert:   getEnv("KAFKA_TLS_CERT", ""),
				Key:    getEnv("KAFKA_TLS_KEY", ""),
				CA:     getEnv("KAFKA_TLS_CA", ""),
			},
		},
		VoiceChat: VoiceChatConfig{
			MaxRooms:            getIntEnv("VOICE_CHAT_MAX_ROOMS", 1000),
			MaxUsersPerRoom:     getIntEnv("VOICE_CHAT_MAX_USERS_PER_ROOM", 50),
			RoomTimeout:         getDurationEnv("VOICE_CHAT_ROOM_TIMEOUT", 1*time.Hour),
			UserTimeout:         getDurationEnv("VOICE_CHAT_USER_TIMEOUT", 5*time.Minute),
			QualityMonitorInterval: getDurationEnv("VOICE_CHAT_QUALITY_MONITOR", 10*time.Second),
			MaxBandwidthPerUser: getIntEnv("VOICE_CHAT_MAX_BANDWIDTH", 128), // kbps
			DefaultAudioCodec:   getEnv("VOICE_CHAT_DEFAULT_CODEC", "opus"),
			SupportedCodecs:     getStringSliceEnv("VOICE_CHAT_SUPPORTED_CODECS", []string{"opus", "speex", "g711"}),
			NoiseGateThreshold:  getFloat64Env("VOICE_CHAT_NOISE_GATE", -60.0),
			EchoCancellation:    getBoolEnv("VOICE_CHAT_ECHO_CANCELLATION", true),
			NoiseSuppression:    getBoolEnv("VOICE_CHAT_NOISE_SUPPRESSION", true),
			AGCEnabled:          getBoolEnv("VOICE_CHAT_AGC_ENABLED", true),
			VADThreshold:        getFloat64Env("VOICE_CHAT_VAD_THRESHOLD", 0.01),
			JitterBufferSize:    getDurationEnv("VOICE_CHAT_JITTER_BUFFER", 50*time.Millisecond),
			OpusComplexity:      getIntEnv("VOICE_CHAT_OPUS_COMPLEXITY", 8),
			OpusBitrate:         getIntEnv("VOICE_CHAT_OPUS_BITRATE", 64000),

			// Room types
			GroupChatEnabled:    getBoolEnv("VOICE_CHAT_GROUP_ENABLED", true),
			RaidChatEnabled:     getBoolEnv("VOICE_CHAT_RAID_ENABLED", true),
			GuildChatEnabled:    getBoolEnv("VOICE_CHAT_GUILD_ENABLED", true),
			PartyChatEnabled:    getBoolEnv("VOICE_CHAT_PARTY_ENABLED", true),
			ProximityChatEnabled: getBoolEnv("VOICE_CHAT_PROXIMITY_ENABLED", true),
			GlobalChatEnabled:   getBoolEnv("VOICE_CHAT_GLOBAL_ENABLED", false),

			// Quality settings
			HighQualityEnabled:  getBoolEnv("VOICE_CHAT_HIGH_QUALITY", true),
			MediumQualityEnabled: getBoolEnv("VOICE_CHAT_MEDIUM_QUALITY", true),
			LowQualityEnabled:   getBoolEnv("VOICE_CHAT_LOW_QUALITY", true),

			// Moderation
			AutoMuteEnabled:     getBoolEnv("VOICE_CHAT_AUTO_MUTE", true),
			MuteTimeout:         getDurationEnv("VOICE_CHAT_MUTE_TIMEOUT", 5*time.Minute),
			SpamDetectionEnabled: getBoolEnv("VOICE_CHAT_SPAM_DETECTION", true),
			MaxVoiceMessagesPerMinute: getIntEnv("VOICE_CHAT_MAX_MESSAGES", 30),
		},
		Security: SecurityConfig{
			EnableEncryption: getBoolEnv("VOICE_CHAT_ENCRYPTION_ENABLED", true),
			EncryptionKey:    getEnv("VOICE_CHAT_ENCRYPTION_KEY", ""),
			AllowedOrigins:   getStringSliceEnv("VOICE_CHAT_ALLOWED_ORIGINS", []string{"*"}),
			RateLimitRequests: getIntEnv("VOICE_CHAT_RATE_LIMIT_REQUESTS", 100),
			RateLimitWindow:  getDurationEnv("VOICE_CHAT_RATE_LIMIT_WINDOW", time.Minute),
			IPWhitelist:      getStringSliceEnv("VOICE_CHAT_IP_WHITELIST", []string{}),
			UserAuthRequired: getBoolEnv("VOICE_CHAT_USER_AUTH_REQUIRED", true),
			TokenExpiration:  getDurationEnv("VOICE_CHAT_TOKEN_EXPIRATION", 24*time.Hour),
		},
	}

	return cfg
}

// Helper functions for environment variable parsing
func getEnv(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}

func getIntEnv(key string, defaultValue int) int {
	if value := os.Getenv(key); value != "" {
		if intValue, err := strconv.Atoi(value); err == nil {
			return intValue
		}
	}
	return defaultValue
}

func getFloat64Env(key string, defaultValue float64) float64 {
	if value := os.Getenv(key); value != "" {
		if floatValue, err := strconv.ParseFloat(value, 64); err == nil {
			return floatValue
		}
	}
	return defaultValue
}

func getBoolEnv(key string, defaultValue bool) bool {
	if value := os.Getenv(key); value != "" {
		if boolValue, err := strconv.ParseBool(value); err == nil {
			return boolValue
		}
	}
	return defaultValue
}

func getDurationEnv(key string, defaultValue time.Duration) time.Duration {
	if value := os.Getenv(key); value != "" {
		if duration, err := time.ParseDuration(value); err == nil {
			return duration
		}
	}
	return defaultValue
}

func getStringSliceEnv(key string, defaultValue []string) []string {
	if value := os.Getenv(key); value != "" {
		return strings.Split(value, ",")
	}
	return defaultValue
}