databaseChangeLog:
  - changeSet:
      id: 011-create-content-core
      author: workqueue
      changes:
        - createTable:
            tableName: content_entities
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: title
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: summary
                  type: TEXT
              - column:
                  name: entity_type_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: status_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: visibility_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: category_id
                  type: UUID
              - column:
                  name: risk_level_id
                  type: UUID
              - column:
                  name: owner_role
                  type: VARCHAR(64)
              - column:
                  name: tags
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: topics
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: last_updated
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: source_document
                  type: VARCHAR(512)
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            constraintName: uq_content_entities_code
            tableName: content_entities
            columnNames: code
        - addForeignKeyConstraint:
            baseTableName: content_entities
            baseColumnNames: entity_type_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_content_entities_type
        - addForeignKeyConstraint:
            baseTableName: content_entities
            baseColumnNames: status_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_content_entities_status
        - addForeignKeyConstraint:
            baseTableName: content_entities
            baseColumnNames: visibility_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_content_entities_visibility
        - addForeignKeyConstraint:
            baseTableName: content_entities
            baseColumnNames: category_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_content_entities_category
        - addForeignKeyConstraint:
            baseTableName: content_entities
            baseColumnNames: risk_level_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_content_entities_risk
        - createIndex:
            indexName: idx_content_entities_type
            tableName: content_entities
            columns:
              - column:
                  name: entity_type_id
        - createIndex:
            indexName: idx_content_entities_status
            tableName: content_entities
            columns:
              - column:
                  name: status_id
        - createTable:
            tableName: entity_tags
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: tag
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_tags
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_tags_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: entity_tags
            columnNames: content_entity_id, tag
            constraintName: uq_entity_tags_tag
        - createTable:
            tableName: entity_topics
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: topic
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_topics
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_topics_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: entity_topics
            columnNames: content_entity_id, topic
            constraintName: uq_entity_topics_topic
        - createTable:
            tableName: entity_audiences
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: audience_code
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_audiences
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_audiences_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: entity_audiences
            columnNames: content_entity_id, audience_code
            constraintName: uq_entity_audiences_code
        - createTable:
            tableName: entity_related_systems
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: system_code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_related_systems
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_related_systems_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: entity_related_systems
            columnNames: content_entity_id, system_code
            constraintName: uq_entity_related_systems_code
        - createTable:
            tableName: entity_history
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: changed_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: changed_by
                  type: VARCHAR(128)
              - column:
                  name: changes_summary
                  type: TEXT
              - column:
                  name: diff_blob
                  type: TEXT
        - addForeignKeyConstraint:
            baseTableName: entity_history
            baseColumnNames: entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_history_entity
            onDelete: CASCADE
        - createIndex:
            indexName: idx_entity_history_entity
            tableName: entity_history
            columns:
              - column:
                  name: entity_id
        - createTable:
            tableName: entity_links
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: source_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: relation_type_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: target_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: notes
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_links
            baseColumnNames: source_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_links_source
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: entity_links
            baseColumnNames: target_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_links_target
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: entity_links
            baseColumnNames: relation_type_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_entity_links_relation
        - createIndex:
            indexName: idx_entity_links_source
            tableName: entity_links
            columns:
              - column:
                  name: source_entity_id
        - createIndex:
            indexName: idx_entity_links_target
            tableName: entity_links
            columns:
              - column:
                  name: target_entity_id
        - createTable:
            tableName: entity_sections
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: section_key_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: body
                  type: TEXT
              - column:
                  name: sort_order
                  type: INT
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_sections
            baseColumnNames: entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_sections_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: entity_sections
            baseColumnNames: section_key_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_entity_sections_key
        - createIndex:
            indexName: idx_entity_sections_entity
            tableName: entity_sections
            columns:
              - column:
                  name: entity_id
        - createTable:
            tableName: entity_attributes
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: attribute_key_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: value_type_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: value_string
                  type: TEXT
              - column:
                  name: value_int
                  type: BIGINT
              - column:
                  name: value_decimal
                  type: NUMERIC(19,4)
              - column:
                  name: value_boolean
                  type: BOOLEAN
              - column:
                  name: value_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: source
                  type: VARCHAR(128)
        - addForeignKeyConstraint:
            baseTableName: entity_attributes
            baseColumnNames: entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_attributes_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: entity_attributes
            baseColumnNames: attribute_key_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_entity_attributes_attribute
        - addForeignKeyConstraint:
            baseTableName: entity_attributes
            baseColumnNames: value_type_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_entity_attributes_value_type
        - createIndex:
            indexName: idx_entity_attributes_entity
            tableName: entity_attributes
            columns:
              - column:
                  name: entity_id
        - createTable:
            tableName: entity_notes
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: author_agent_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: note_text
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_notes
            baseColumnNames: entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_notes_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: entity_notes
            baseColumnNames: author_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_entity_notes_author
        - createIndex:
            indexName: idx_entity_notes_entity
            tableName: entity_notes
            columns:
              - column:
                  name: entity_id
        - createTable:
            tableName: entity_localizations
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: locale
                  type: VARCHAR(16)
                  constraints:
                    nullable: false
              - column:
                  name: title_localized
                  type: VARCHAR(512)
              - column:
                  name: description_localized
                  type: TEXT
              - column:
                  name: flavor_text
                  type: TEXT
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: entity_localizations
            baseColumnNames: entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_entity_localizations_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: entity_localizations
            columnNames: entity_id, locale
            constraintName: uq_entity_localizations_locale

