databaseChangeLog:
  - changeSet:
      id: 012-create-quest-tables
      author: workqueue
      changes:
        - createTable:
            tableName: quest_data
            columns:
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: quest_category_value_id
                  type: UUID
              - column:
                  name: segment
                  type: VARCHAR(64)
              - column:
                  name: difficulty_value_id
                  type: UUID
              - column:
                  name: level_min
                  type: INT
              - column:
                  name: level_max
                  type: INT
              - column:
                  name: estimated_duration_min
                  type: INT
              - column:
                  name: estimated_duration_max
                  type: INT
              - column:
                  name: repeatable
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: recommended_players
                  type: INT
              - column:
                  name: start_npc_entity_id
                  type: UUID
              - column:
                  name: end_npc_entity_id
                  type: UUID
              - column:
                  name: start_location_entity_id
                  type: UUID
              - column:
                  name: end_location_entity_id
                  type: UUID
              - column:
                  name: prerequisites
                  type: JSONB
              - column:
                  name: metadata
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_data_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: quest_category_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_quest_data_category
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: difficulty_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_quest_data_difficulty
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: start_npc_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_data_start_npc
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: end_npc_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_data_end_npc
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: start_location_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_data_start_location
        - addForeignKeyConstraint:
            baseTableName: quest_data
            baseColumnNames: end_location_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_data_end_location
        - createTable:
            tableName: quest_stages
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: quest_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: stage_index
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(256)
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: objective_type_value_id
                  type: UUID
              - column:
                  name: target_entity_id
                  type: UUID
              - column:
                  name: target_location_entity_id
                  type: UUID
              - column:
                  name: is_optional
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: success_conditions
                  type: JSONB
              - column:
                  name: failure_conditions
                  type: JSONB
              - column:
                  name: metadata
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: quest_stages
            baseColumnNames: quest_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_stages_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: quest_stages
            baseColumnNames: objective_type_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_quest_stages_objective_type
        - addForeignKeyConstraint:
            baseTableName: quest_stages
            baseColumnNames: target_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_stages_target_entity
        - addForeignKeyConstraint:
            baseTableName: quest_stages
            baseColumnNames: target_location_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_stages_target_location
        - createIndex:
            indexName: idx_quest_stages_quest
            tableName: quest_stages
            columns:
              - column:
                  name: quest_entity_id
        - addUniqueConstraint:
            tableName: quest_stages
            columnNames: quest_entity_id, stage_index
            constraintName: uq_quest_stages_order
        - createTable:
            tableName: quest_rewards
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: quest_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: reward_type_value_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: reward_entity_id
                  type: UUID
              - column:
                  name: amount
                  type: NUMERIC(19,4)
              - column:
                  name: metadata
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: quest_rewards
            baseColumnNames: quest_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_rewards_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: quest_rewards
            baseColumnNames: reward_type_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_quest_rewards_type
        - addForeignKeyConstraint:
            baseTableName: quest_rewards
            baseColumnNames: reward_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_rewards_entity_target
        - createIndex:
            indexName: idx_quest_rewards_quest
            tableName: quest_rewards
            columns:
              - column:
                  name: quest_entity_id
        - createTable:
            tableName: quest_branches
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: quest_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: branch_key
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: from_stage_index
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: leads_to_stage_index
                  type: INT
              - column:
                  name: trigger_conditions
                  type: JSONB
              - column:
                  name: notes
                  type: TEXT
        - addForeignKeyConstraint:
            baseTableName: quest_branches
            baseColumnNames: quest_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_branches_entity
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: quest_branches
            columnNames: quest_entity_id, branch_key
            constraintName: uq_quest_branches_key
        - createTable:
            tableName: quest_world_effects
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: quest_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: effect_type_value_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: target_entity_id
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: notes
                  type: TEXT
        - addForeignKeyConstraint:
            baseTableName: quest_world_effects
            baseColumnNames: quest_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_effects_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: quest_world_effects
            baseColumnNames: effect_type_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_quest_effects_type
        - addForeignKeyConstraint:
            baseTableName: quest_world_effects
            baseColumnNames: target_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_quest_effects_target
        - createIndex:
            indexName: idx_quest_effects_quest
            tableName: quest_world_effects
            columns:
              - column:
                  name: quest_entity_id

