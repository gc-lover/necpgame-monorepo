databaseChangeLog:
  - changeSet:
      id: 015-create-npc-tables
      author: workqueue
      changes:
        - createTable:
            tableName: npc_data
            columns:
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: alignment_value_id
                  type: UUID
              - column:
                  name: behavior_value_id
                  type: UUID
              - column:
                  name: faction_entity_id
                  type: UUID
              - column:
                  name: role_title
                  type: VARCHAR(128)
              - column:
                  name: level
                  type: INT
              - column:
                  name: power_score
                  type: NUMERIC(19,4)
              - column:
                  name: vendor_catalog
                  type: JSONB
              - column:
                  name: schedule_metadata
                  type: JSONB
              - column:
                  name: dialogue_profile
                  type: JSONB
              - column:
                  name: metadata
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: npc_data
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_data_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: npc_data
            baseColumnNames: alignment_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_npc_data_alignment
        - addForeignKeyConstraint:
            baseTableName: npc_data
            baseColumnNames: behavior_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_npc_data_behavior
        - addForeignKeyConstraint:
            baseTableName: npc_data
            baseColumnNames: faction_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_data_faction
        - createTable:
            tableName: npc_schedule_entries
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: npc_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: day_time_range
                  type: VARCHAR(64)
              - column:
                  name: location_entity_id
                  type: UUID
              - column:
                  name: schedule_payload
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: npc_schedule_entries
            baseColumnNames: npc_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_schedule_entity
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: npc_schedule_entries
            baseColumnNames: location_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_schedule_location
        - createIndex:
            indexName: idx_npc_schedule_npc
            tableName: npc_schedule_entries
            columns:
              - column:
                  name: npc_entity_id
        - createTable:
            tableName: npc_inventory_items
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: npc_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: item_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: quantity
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: restock_interval_minutes
                  type: INT
              - column:
                  name: price_override
                  type: NUMERIC(19,4)
              - column:
                  name: metadata
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: npc_inventory_items
            baseColumnNames: npc_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_inventory_npc
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: npc_inventory_items
            baseColumnNames: item_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_inventory_item
        - createIndex:
            indexName: idx_npc_inventory_npc
            tableName: npc_inventory_items
            columns:
              - column:
                  name: npc_entity_id
        - createTable:
            tableName: npc_dialogue_links
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: npc_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: dialogue_entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: priority
                  type: INT
                  defaultValueNumeric: 0
              - column:
                  name: conditions
                  type: JSONB
              - column:
                  name: metadata
                  type: JSONB
        - addForeignKeyConstraint:
            baseTableName: npc_dialogue_links
            baseColumnNames: npc_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_dialogue_npc
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: npc_dialogue_links
            baseColumnNames: dialogue_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_npc_dialogue_dialogue

