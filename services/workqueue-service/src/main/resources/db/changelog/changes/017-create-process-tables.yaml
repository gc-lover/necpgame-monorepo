databaseChangeLog:
  - changeSet:
      id: 017-add-task-status-columns
      author: workqueue
      changes:
        - addColumn:
            tableName: queue_items
            columns:
              - column:
                  name: status_value_id
                  type: UUID
        - addColumn:
            tableName: queue_item_states
            columns:
              - column:
                  name: status_value_id
                  type: UUID
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: status_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_queue_items_status
        - addForeignKeyConstraint:
            baseTableName: queue_item_states
            baseColumnNames: status_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_queue_item_states_status
        - createIndex:
            indexName: idx_queue_items_status
            tableName: queue_items
            columns:
              - column:
                  name: status_value_id
      rollback:
        - dropIndex:
            indexName: idx_queue_items_status
            tableName: queue_items
        - dropForeignKeyConstraint:
            baseTableName: queue_item_states
            constraintName: fk_queue_item_states_status
        - dropForeignKeyConstraint:
            baseTableName: queue_items
            constraintName: fk_queue_items_status
        - dropColumn:
            tableName: queue_item_states
            columnName: status_value_id
        - dropColumn:
            tableName: queue_items
            columnName: status_value_id
  - changeSet:
      id: 017-create-process-templates
      author: workqueue
      changes:
        - createTable:
            tableName: process_templates
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: code_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: schema_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: usage_notes
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: process_templates
            columnNames: code_id
            constraintName: uq_process_templates_code
        - addForeignKeyConstraint:
            baseTableName: process_templates
            baseColumnNames: code_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_process_templates_code
        - createTable:
            tableName: template_instances
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: template_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: entity_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: data_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: filled_by_agent_id
                  type: UUID
              - column:
                  name: filled_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: template_instances
            baseColumnNames: template_id
            referencedTableName: process_templates
            referencedColumnNames: id
            constraintName: fk_template_instances_template
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: template_instances
            baseColumnNames: filled_by_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_template_instances_filled_by
        - createIndex:
            indexName: idx_template_instances_entity
            tableName: template_instances
            columns:
              - column:
                  name: entity_type
              - column:
                  name: entity_id
      rollback:
        - dropTable:
            tableName: template_instances
            cascadeConstraints: true
        - dropTable:
            tableName: process_templates
            cascadeConstraints: true
  - changeSet:
      id: 017-create-checklist-tables
      author: workqueue
      changes:
        - createTable:
            tableName: checklist_definitions
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: code_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: is_required
                  type: BOOLEAN
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: checklist_definitions
            baseColumnNames: code_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_checklist_definitions_code
        - createTable:
            tableName: checklist_definition_items
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: checklist_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sort_order
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: expected_result
                  type: TEXT
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: checklist_definition_items
            baseColumnNames: checklist_id
            referencedTableName: checklist_definitions
            referencedColumnNames: id
            constraintName: fk_checklist_definition_items_definition
            onDelete: CASCADE
        - createTable:
            tableName: checklist_runs
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: checklist_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: entity_type
                  type: VARCHAR(64)
              - column:
                  name: entity_id
                  type: UUID
              - column:
                  name: executor_agent_id
                  type: UUID
              - column:
                  name: status_value_id
                  type: UUID
              - column:
                  name: results
                  type: JSONB
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: checklist_runs
            baseColumnNames: checklist_id
            referencedTableName: checklist_definitions
            referencedColumnNames: id
            constraintName: fk_checklist_runs_definition
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: checklist_runs
            baseColumnNames: executor_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_checklist_runs_executor
        - addForeignKeyConstraint:
            baseTableName: checklist_runs
            baseColumnNames: status_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_checklist_runs_status
        - createTable:
            tableName: checklist_run_items
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: checklist_run_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: item_key
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: status_value_id
                  type: UUID
              - column:
                  name: note
                  type: TEXT
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: checklist_run_items
            baseColumnNames: checklist_run_id
            referencedTableName: checklist_runs
            referencedColumnNames: id
            constraintName: fk_checklist_run_items_run
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: checklist_run_items
            baseColumnNames: status_value_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_checklist_run_items_status
        - addUniqueConstraint:
            tableName: checklist_run_items
            columnNames: checklist_run_id, item_key
            constraintName: uq_checklist_run_items_key
      rollback:
        - dropTable:
            tableName: checklist_run_items
            cascadeConstraints: true
        - dropTable:
            tableName: checklist_runs
            cascadeConstraints: true
        - dropTable:
            tableName: checklist_definition_items
            cascadeConstraints: true
        - dropTable:
            tableName: checklist_definitions
            cascadeConstraints: true
  - changeSet:
      id: 017-create-release-run-tables
      author: workqueue
      changes:
        - createTable:
            tableName: release_runs
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: change_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: title
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: author_agent_id
                  type: UUID
              - column:
                  name: release_date
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: impact_level_id
                  type: UUID
              - column:
                  name: summary
                  type: TEXT
              - column:
                  name: scope_description_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: rollback_plan
                  type: TEXT
              - column:
                  name: status_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: release_runs
            columnNames: change_id
            constraintName: uq_release_runs_change
        - addForeignKeyConstraint:
            baseTableName: release_runs
            baseColumnNames: author_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_release_runs_author
        - addForeignKeyConstraint:
            baseTableName: release_runs
            baseColumnNames: impact_level_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_release_runs_impact
        - addForeignKeyConstraint:
            baseTableName: release_runs
            baseColumnNames: status_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_release_runs_status
        - createTable:
            tableName: release_run_steps
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: release_run_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: sort_order
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: owner_role
                  type: VARCHAR(64)
              - column:
                  name: action_description
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: due_date
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: status_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: release_run_steps
            baseColumnNames: release_run_id
            referencedTableName: release_runs
            referencedColumnNames: id
            constraintName: fk_release_run_steps_run
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: release_run_steps
            baseColumnNames: status_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_release_run_steps_status
        - addUniqueConstraint:
            tableName: release_run_steps
            columnNames: release_run_id, sort_order
            constraintName: uq_release_run_steps_order
        - createTable:
            tableName: release_run_validations
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: release_run_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: validation_type
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: status_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: validated_by_agent_id
                  type: UUID
              - column:
                  name: validated_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: results_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: release_run_validations
            baseColumnNames: release_run_id
            referencedTableName: release_runs
            referencedColumnNames: id
            constraintName: fk_release_run_validations_run
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: release_run_validations
            baseColumnNames: status_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_release_run_validations_status
        - addForeignKeyConstraint:
            baseTableName: release_run_validations
            baseColumnNames: validated_by_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_release_run_validations_validator
      rollback:
        - dropTable:
            tableName: release_run_validations
            cascadeConstraints: true
        - dropTable:
            tableName: release_run_steps
            cascadeConstraints: true
        - dropTable:
            tableName: release_runs
            cascadeConstraints: true
  - changeSet:
      id: 017-create-analytics-tables
      author: workqueue
      changes:
        - createTable:
            tableName: analytics_schemas
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: feature_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: kpi_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: events_schema_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: dashboards_links_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: last_validated_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: validation_results_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: analytics_schemas
            columnNames: content_entity_id
            constraintName: uq_analytics_schemas_content
        - addForeignKeyConstraint:
            baseTableName: analytics_schemas
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_analytics_schemas_content
        - createTable:
            tableName: analytics_metrics
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: schema_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: metric_code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: display_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: target_value
                  type: NUMERIC(19,4)
              - column:
                  name: current_value
                  type: NUMERIC(19,4)
              - column:
                  name: last_updated
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: analytics_metrics
            baseColumnNames: schema_id
            referencedTableName: analytics_schemas
            referencedColumnNames: id
            constraintName: fk_analytics_metrics_schema
            onDelete: CASCADE
      rollback:
        - dropTable:
            tableName: analytics_metrics
            cascadeConstraints: true
        - dropTable:
            tableName: analytics_schemas
            cascadeConstraints: true
  - changeSet:
      id: 017-create-qa-tables
      author: workqueue
      changes:
        - createTable:
            tableName: qa_plans
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: content_entity_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: plan_code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: feature_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: prepared_by_agent_id
                  type: UUID
              - column:
                  name: plan_date
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: scope_in_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: scope_out_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: environments_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: test_types_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: test_cases_summary_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: entry_criteria_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: exit_criteria_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: risks_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: schedule_start_date
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: schedule_end_date
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: approvals_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: qa_plans
            baseColumnNames: content_entity_id
            referencedTableName: content_entities
            referencedColumnNames: id
            constraintName: fk_qa_plans_content
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: qa_plans
            baseColumnNames: prepared_by_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_qa_plans_prepared_by
        - createTable:
            tableName: qa_plan_items
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: qa_plan_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: sort_order
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: expected_result
                  type: TEXT
              - column:
                  name: test_type_id
                  type: UUID
              - column:
                  name: automation_status
                  type: VARCHAR(64)
              - column:
                  name: metadata_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: qa_plan_items
            baseColumnNames: qa_plan_id
            referencedTableName: qa_plans
            referencedColumnNames: id
            constraintName: fk_qa_plan_items_plan
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: qa_plan_items
            baseColumnNames: test_type_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_qa_plan_items_test_type
        - createTable:
            tableName: qa_reports
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: qa_plan_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: tester_agent_id
                  type: UUID
              - column:
                  name: report_date
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: summary
                  type: TEXT
              - column:
                  name: execution_metrics_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: defects_reference_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: risks_mitigations_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: release_decision_id
                  type: UUID
              - column:
                  name: recommendations_json
                  type: JSONB
                  defaultValue: '{}'
                  constraints:
                    nullable: false
              - column:
                  name: approvals_json
                  type: JSONB
                  defaultValue: '[]'
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: qa_reports
            baseColumnNames: qa_plan_id
            referencedTableName: qa_plans
            referencedColumnNames: id
            constraintName: fk_qa_reports_plan
        - addForeignKeyConstraint:
            baseTableName: qa_reports
            baseColumnNames: tester_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_qa_reports_tester
        - addForeignKeyConstraint:
            baseTableName: qa_reports
            baseColumnNames: release_decision_id
            referencedTableName: enum_values
            referencedColumnNames: id
            constraintName: fk_qa_reports_release_decision
        - addUniqueConstraint:
            tableName: qa_reports
            columnNames: qa_plan_id
            constraintName: uq_qa_reports_plan
      rollback:
        - dropTable:
            tableName: qa_reports
            cascadeConstraints: true
        - dropTable:
            tableName: qa_plan_items
            cascadeConstraints: true
        - dropTable:
            tableName: qa_plans
            cascadeConstraints: true
