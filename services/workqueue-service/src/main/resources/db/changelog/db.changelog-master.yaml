databaseChangeLog:
  - changeSet:
      id: 001-create-agents
      author: workqueue
      changes:
        - createTable:
            tableName: agents
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: role_key
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: display_name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: contact
                  type: VARCHAR(256)
              - column:
                  name: active
                  type: BOOLEAN
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
        - createIndex:
            indexName: idx_agents_role_key
            tableName: agents
            columns:
              - column:
                  name: role_key
  - changeSet:
      id: 002-create-queues
      author: workqueue
      changes:
        - createTable:
            tableName: queues
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: segment
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: status_code
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: owner_agent_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: queues
            baseColumnNames: owner_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_queues_owner_agent
        - createIndex:
            indexName: idx_queues_segment_status
            tableName: queues
            columns:
              - column:
                  name: segment
              - column:
                  name: status_code
  - changeSet:
      id: 003-create-queue-items
      author: workqueue
      changes:
        - createTable:
            tableName: queue_items
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: queue_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: external_ref
                  type: VARCHAR(512)
              - column:
                  name: title
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: priority
                  type: INTEGER
                  defaultValueNumeric: 0
              - column:
                  name: payload
                  type: TEXT
              - column:
                  name: created_by
                  type: UUID
              - column:
                  name: assigned_to
                  type: UUID
              - column:
                  name: due_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_until
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: current_state_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: queue_id
            referencedTableName: queues
            referencedColumnNames: id
            constraintName: fk_queue_items_queue
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: created_by
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_queue_items_created_by
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: assigned_to
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_queue_items_assigned_to
        - createIndex:
            indexName: idx_queue_items_queue
            tableName: queue_items
            columns:
              - column:
                  name: queue_id
        - createIndex:
            indexName: idx_queue_items_assigned
            tableName: queue_items
            columns:
              - column:
                  name: assigned_to
        - createIndex:
            indexName: idx_queue_items_external_ref
            tableName: queue_items
            unique: true
            columns:
              - column:
                  name: external_ref
  - changeSet:
      id: 004-create-queue-item-states
      author: workqueue
      changes:
        - createTable:
            tableName: queue_item_states
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: item_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: status_code
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: note
                  type: TEXT
              - column:
                  name: actor_id
                  type: UUID
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: queue_item_states
            baseColumnNames: item_id
            referencedTableName: queue_items
            referencedColumnNames: id
            constraintName: fk_queue_item_states_item
        - addForeignKeyConstraint:
            baseTableName: queue_item_states
            baseColumnNames: actor_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_queue_item_states_actor
        - createIndex:
            indexName: idx_queue_item_states_item
            tableName: queue_item_states
            columns:
              - column:
                  name: item_id
  - changeSet:
      id: 005-link-queue-items-current-state
      author: workqueue
      dbms: postgresql
      changes:
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: current_state_id
            referencedTableName: queue_item_states
            referencedColumnNames: id
            constraintName: fk_queue_items_current_state
            deferrable: true
            initiallyDeferred: true
  - changeSet:
      id: 005-link-queue-items-current-state-h2
      author: workqueue
      dbms: h2
      changes:
        - addForeignKeyConstraint:
            baseTableName: queue_items
            baseColumnNames: current_state_id
            referencedTableName: queue_item_states
            referencedColumnNames: id
            constraintName: fk_queue_items_current_state
  - changeSet:
      id: 006-create-queue-locks
      author: workqueue
      changes:
        - createTable:
            tableName: queue_locks
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: scope
                  type: VARCHAR(16)
                  constraints:
                    nullable: false
              - column:
                  name: queue_id
                  type: UUID
              - column:
                  name: item_id
                  type: UUID
              - column:
                  name: owner_agent_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: token
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: expires_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: queue_locks
            baseColumnNames: queue_id
            referencedTableName: queues
            referencedColumnNames: id
            constraintName: fk_queue_locks_queue
        - addForeignKeyConstraint:
            baseTableName: queue_locks
            baseColumnNames: item_id
            referencedTableName: queue_items
            referencedColumnNames: id
            constraintName: fk_queue_locks_item
        - addForeignKeyConstraint:
            baseTableName: queue_locks
            baseColumnNames: owner_agent_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_queue_locks_owner
        - createIndex:
            indexName: idx_queue_locks_token
            tableName: queue_locks
            unique: true
            columns:
              - column:
                  name: token
        - createIndex:
            indexName: idx_queue_locks_queue
            tableName: queue_locks
            columns:
              - column:
                  name: queue_id
        - createIndex:
            indexName: idx_queue_locks_item
            tableName: queue_locks
            columns:
              - column:
                  name: item_id
  - changeSet:
      id: 007-create-activity-log
      author: workqueue
      changes:
        - createTable:
            tableName: activity_log
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: actor_id
                  type: UUID
              - column:
                  name: entity_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: TEXT
              - column:
                  name: recorded_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: activity_log
            baseColumnNames: actor_id
            referencedTableName: agents
            referencedColumnNames: id
            constraintName: fk_activity_log_actor
        - createIndex:
            indexName: idx_activity_log_entity
            tableName: activity_log
            columns:
              - column:
                  name: entity_type
              - column:
                  name: entity_id
  - changeSet:
      id: 008-create-agent-preferences
      author: workqueue
      changes:
        - createTable:
            tableName: agent_preferences
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: agent_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: role_key
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: primary_segments
                  type: VARCHAR(512)
              - column:
                  name: fallback_segments
                  type: VARCHAR(512)
              - column:
                  name: pickup_statuses
                  type: VARCHAR(512)
              - column:
                  name: active_statuses
                  type: VARCHAR(512)
              - column:
                  name: accept_status
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: return_status
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: max_in_progress_minutes
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - createIndex:
            indexName: idx_agent_preferences_role
            tableName: agent_preferences
            columns:
              - column:
                  name: role_key
  - include:
      file: changes/009-create-enum-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/010-seed-enum-values.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/011-create-content-core.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/012-create-quest-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/013-create-skill-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/014-create-item-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/015-create-npc-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/016-create-world-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/017-create-process-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/018-backfill-task-status-values.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/019-seed-core-data.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/020-create-queue-item-templates.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/021-create-queue-item-artifacts.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/022-create-handoff-rules.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/023-create-reference-templates.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/024-fix-vision-handoff.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/025-create-agent-briefs.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/026-migrate-knowledge-to-db.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/027-create-knowledge-documents.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/028-alter-knowledge-documents.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/029-add-agent-role-index.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/030-create-core-game-tables.yaml
      relativeToChangelogFile: true
  - include:
      file: changes/031-seed-agent-preferences.yaml
      relativeToChangelogFile: true
