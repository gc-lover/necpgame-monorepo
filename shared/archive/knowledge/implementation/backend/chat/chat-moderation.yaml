metadata:
  id: backend-chat-moderation
  title: 'Chat Moderation — Модерация чата'
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T05:30:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T05:30:00Z
  owners:
    - role: safety_lead
      contact: safety@necp.game
  tags:
    - chat
    - moderation
    - safety
  topics:
    - player-communication
    - trust-safety
  related_systems:
    - chat-service
    - moderation-service
    - security-service
  related_documents:
    - id: backend-chat-channels
      relation: complements
    - id: backend-chat-features
      relation: complements
  source: shared/docs/knowledge/implementation/backend/chat/chat-moderation.md
  visibility: internal
  audience:
    - safety
    - backend
    - live-ops
  risk_level: high
review:
  chain:
    - role: safety_lead
      reviewer: ''
      reviewed_at: 2025-11-07T05:30:00Z
      status: approved
  next_actions: []
summary:
  problem: Нужна серверная спецификация модерации чата для защиты от спама, нарушений и злоупотреблений.
  goal: Описать фильтрацию сообщений, алгоритмы спама, систему банов и инструменты администраторов.
  essence: Документ фиксирует схему `chat_bans`, реализацию фильтров, детекцию спама, авто-баны и административные API.
  key_points:
    - Profanity filter комбинирует список запрещённых слов, whitelist URL и защиту от повторов/CAPS.
    - SpamDetector контролирует частоту сообщений и дублирование с использованием Redis.
    - Auto-ban сервис создаёт глобальные баны и уведомляет игроков.
    - REST API покрывает жалобы, выдачу банов, просмотр и снятие блокировок.
content:
  sections:
    - id: overview
      title: Система модерации
      body: |
        Модерация чата предотвращает токсичное поведение через автоматические фильтры и админ-инструменты. Система объединяет
        фильтрацию сообщений, контроль спама и управление банами.
      mechanics_links: []
      assets: []
    - id: data_model
      title: Схема `chat_bans`
      body: |
        Таблица `chat_bans` хранит информацию о забаненном игроке, канале, причине, администраторе и сроке действия. Индексы
        по игроку и сроку действия ускоряют проверку активных банов.
      mechanics_links: []
      assets: []
    - id: profanity_filter
      title: Фильтр запрещённых выражений
      body: |
        ModerationService обрабатывает сообщения, заменяя запрещённые слова, блокируя не-whitelist ссылки, сокращая повторяющиеся
        символы и нормализуя верхний регистр. Проверка severe violations запускает эскалацию.
      mechanics_links: []
      assets: []
    - id: spam_detection
      title: Обнаружение спама
      body: |
        SpamDetector отслеживает частоту сообщений (rate limit >10 в минуту) и повторение контента. Данные хранятся в Redis с
        ограниченным TTL, что позволяет быстро реагировать на спам.
      mechanics_links: []
      assets: []
    - id: auto_ban
      title: Автоматические баны
      body: |
        Auto-ban сохраняет записи в `chat_bans`, уведомляет игрока через WebSocket и журналирует событие. Глобальные баны
        поддерживают конфигурацию по длительности.
      mechanics_links: []
      assets: []
    - id: api_endpoints
      title: API модерации
      body: |
        Предоставлены endpoints `POST /chat/report`, `POST /chat/ban`, `GET /chat/bans` и `DELETE /chat/bans/{id}` для управления
        жалобами и банами администраторами.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#backend-chat-moderation
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: Описаны фильтрация, детекция спама, авто-баны и административные API для модерации чата.
validation:
  checksum: ''
  schema_version: '1.0'

