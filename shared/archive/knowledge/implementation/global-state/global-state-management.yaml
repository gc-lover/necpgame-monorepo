metadata:
  id: implementation-global-state-management
  title: 'Global State Management — Управление состоянием'
  document_type: implementation
  category: global-state
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T06:00:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T06:00:00Z
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - global-state
    - event-sourcing
    - backend
  topics:
    - state-management
    - event-processing
  related_systems:
    - global-state-service
    - quest-service
    - analytics-pipeline
  related_documents:
    - id: implementation-global-state-events
      relation: complements
    - id: implementation-global-state-operations
      relation: references
  source: shared/docs/knowledge/implementation/global-state/global-state-management.md
  visibility: internal
  audience:
    - concept
    - backend
    - analytics
  risk_level: high
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: 'Логика обработки глобальных событий и управления состоянием оставалась в Markdown и не проходила схемную проверку.'
  goal: 'Перенести микрофичу Global State Management в YAML, описав пайплайн обработки, менеджер состояния, реконструкцию и интеграцию с Event Bus.'
  essence: 'Документ фиксирует 10-этапный Event Processing Pipeline, контракт GlobalStateManager, механизмы time travel и state reconstruction.'
  key_points:
    - 'Event Processing Pipeline описывает путь события от валидации до аналитики.'
    - 'GlobalStateManager покрывает кэширование, обновление, пакетные операции и публикацию StateChangedEvent.'
    - 'Time travel и state reconstruction базируются на snapshots и повторном применении событий из Event Store.'
content:
  sections:
    - id: event_pipeline
      title: 'Пайплайн обработки событий'
      body: |
        События проходят десять шагов: прием, валидация, авторизация, обогащение, запись в Event Store,
        публикация в шину, обработка подписчиками, обновление состояния, уведомления и аналитика.
        Пример QuestEventHandler показывает применение изменений к репутации, флагам, предметам и публикацию follow-up событий.
      mechanics_links:
        - mechanics/combat/combat-system-expansion-summary.yaml
      assets: []
    - id: state_manager
      title: 'GlobalStateManager'
      body: |
        Сервис реализует чтение ключей и категорий, обновление по одному и пакетами, работает с PostgreSQL и Redis,
        инвалидирует кэш и публикует StateChangedEvent через Event Bus.
      mechanics_links: []
      assets: []
    - id: time_travel
      title: 'Time Travel и реконструкция'
      body: |
        getStateAtTime и reconstructState используют snapshots и реплей событий для восстановления состояния,
        поддерживая миграции, отладку и аудит.
      mechanics_links:
        - implementation/global-state/global-state-sync.yaml
      assets: []
    - id: event_bus
      title: 'Event Bus и подписчики'
      body: |
        Kafka/RabbitMQ/Redis маршрутизируют события по доменным topics. Подписчики обновляют state, рассылают уведомления,
        записывают аналитику и инвалидацию кэша.
      mechanics_links:
        - implementation-global-state/global-state-events.yaml
      assets: []
    - id: api_contracts
      title: 'API контракты'
      body: |
        REST эндпоинты позволяют читать категории состояния и создавать события, обеспечивая интеграцию с другими сервисами.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: 'Описан пайплайн обработки событий, менеджер состояния и поддержка time travel.'
validation:
  checksum: ''
  schema_version: '1.0'

