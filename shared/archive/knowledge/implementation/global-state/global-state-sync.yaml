metadata:
  id: implementation-global-state-sync
  title: 'Global State Sync — Синхронизация и персистентность'
  document_type: implementation
  category: global-state
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-08T12:20:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-08T12:20:00Z
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - global-state
    - synchronization
    - websocket
  topics:
    - persistence
    - conflict-resolution
  related_systems:
    - websocket-gateway
    - global-state-service
    - event-store
  related_documents:
    - id: implementation-global-state-operations
      relation: references
    - id: implementation-global-state-events
      relation: complements
  source: shared/docs/knowledge/implementation/global-state/global-state-sync.md
  visibility: internal
  audience:
    - concept
    - backend
    - devops
  risk_level: high
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: 'Описание синхронизации глобального состояния оставалось в Markdown и не участвовало в контроле знаний.'
  goal: 'Описать модели синхронизации, стратегии конфликтов, персистентность, replay и WebSocket каналы в YAML.'
  essence: 'Документ фиксирует server-wide, player-specific и phased модели, conflict resolution, WAL/Outbox, idempotency и real-time sync.'
  key_points:
    - 'MMORPG синхронизация делится на глобальную, персональную и фазовую модели.'
    - 'Конфликты решаются стратегиями last write wins, голосованием, версионностью и merge.'
    - 'Persistence использует WAL, transactional outbox, идемпотентность и event replay.'
content:
  sections:
    - id: sync_models
      title: 'Модели синхронизации'
      body: |
        Server-wide покрывает мировые данные, player-specific — персональные квесты, phased — сюжетные фазы и инстансы.
        Каждый подход описывает консистентность и каналы доставки.
      mechanics_links:
        - implementation-global-state/global-state-management.yaml
      assets: []
    - id: conflict_resolution
      title: 'Разрешение конфликтов'
      body: |
        Применяются Last Write Wins, голосование, event версионность и merge дельт. Optimistic locking защищает критичные операции.
      mechanics_links: []
      assets: []
    - id: persistence
      title: 'Персистентность и идемпотентность'
      body: |
        Write-Ahead Log, transactional outbox и таблица processed_events гарантируют доставку и предотвращают повторную обработку.
      mechanics_links:
        - implementation-global-state/global-state-operations.yaml
      assets: []
    - id: replay_versioning
      title: 'Event replay и версионность'
      body: |
        Replay Engine воспроизводит события батчами для восстановления, миграций и тестирования, а optimistic locking проверяет версии.
      mechanics_links:
        - implementation-global-state/global-state-events.yaml
      assets: []
    - id: realtime_sync
      title: 'Real-time синхронизация'
      body: |
        WebSocket каналы (player, world, economy, combat) работают на `wss://api.necp.game/v1`, передают STATE_CHANGED сообщения,
        поддерживая точечные, региональные и серверные трансляции.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: 'Определены модели синхронизации, стратегии конфликтов и каналы реального времени.'
validation:
  checksum: ''
  schema_version: '1.0'

