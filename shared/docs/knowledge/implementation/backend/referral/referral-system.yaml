metadata:
  id: backend-referral-system
  title: Referral System
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T22:05:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T02:40:00Z
  owners:
    - role: growth_backend_lead
      contact: growth@necp.game
  tags:
    - referral
    - growth
    - rewards
  topics:
    - economy
    - social
  related_systems:
    - referral-service
    - reward-service
    - notification-service
  related_documents:
    - id: backend-achievement-system
      relation: references
    - id: economy-premium-currency
      relation: references
  source: shared/docs/knowledge/implementation/backend/referral/referral-system.md
  visibility: internal
  audience:
    - backend
    - growth
  risk_level: medium
review:
  chain:
    - role: growth_backend_lead
      reviewer: ''
      reviewed_at: 2025-11-07T22:05:00Z
      status: approved
  next_actions: []
summary:
  problem: "Нужно описать систему рефералов с кодами, наградами и milestone бонусами."
  goal: "Документировать логику реферальной программы, схемы данных, выдачу наград и API."
  essence: "Документ охватывает генерацию кодов, регистрацию по коду, трекинг milestone, лидерборд и REST эндпоинты."
  key_points:
    - "SQL таблицы `referral_codes` и `referrals` с полями статусов и наград."
    - "Сервис `ReferralService` генерирует уникальные коды и обрабатывает регистрацию."
    - "Event listener отслеживает достижение уровня 10, выдаёт награды и milestone бонусы."
    - "Поддерживаются leaderboard и публичные API для статистики."
content:
  sections:
    - id: overview
      title: Краткое описание
      body: |
        Referral System стимулирует рост через уникальные коды, общие награды и milestone бонусы за активных приглашённых.
      mechanics_links: []
    - id: database
      title: Схемы базы данных
      body: |
        Приведены таблицы `referral_codes` и `referrals` с ограничениями, индексами и полями для статусов и наград.
      mechanics_links: []
    - id: code_generation
      title: Генерация и использование кодов
      body: |
        Сервис генерирует уникальный код, создаёт запись referral при регистрации и выдаёт приветственный бонус новому игроку.
      mechanics_links: []
    - id: milestones
      title: Milestone и награды
      body: |
        Слушатель события уровня отслеживает достижения, выдаёт двусторонние награды, обновляет статус и проверяет milestones
        (`5/10/25/50/100` рефералов).
      mechanics_links: []
    - id: api
      title: API и leaderboard
      body: |
        Описаны endpoints получения кода, генерации, статистики и лидерборда; приведён materialized view для рейтинга.
      mechanics_links: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: growth_backend_lead
    changes: Описаны коды, награды, milestones и leaderboard системы рефералов.
validation:
  checksum: ''
  schema_version: '1.0'

