metadata:
  id: backend-session-lifecycle-heartbeat
  title: 'Session Management: Lifecycle & Heartbeat'
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T21:35:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T01:46:00Z
  owners:
    - role: backend_architect
      contact: backend@necp.game
  tags:
    - session
    - heartbeat
    - lifecycle
  topics:
    - session-management
    - player-lifecycle
  related_systems:
    - session-service
    - redis-cache
    - event-bus
  related_documents:
    - id: backend-session-reconnection-monitoring
      relation: complements
  source: shared/docs/knowledge/implementation/backend/session/session-lifecycle-heartbeat.md
  visibility: internal
  audience:
    - backend
    - operations
    - qa
  risk_level: high
review:
  chain:
    - role: backend_lead
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Нужна надёжная система управления игровыми сессиями с контролем активности и состояния.
  goal: Описать жизненный цикл сессии, хранение данных и heartbeat механизм для отслеживания онлайн игроков.
  essence: Документ определяет схемы БД, кэш, создание сессий, heartbeat API и контроль таймаутов.
  key_points:
    - Жизненный цикл охватывает состояния от CREATED до CLOSED с чёткими переходами.
    - Структура таблиц player_sessions и session_audit_log обеспечивает аудит и хранение состояния.
    - Redis хранит активные сессии и списки игроков по серверам.
    - Heartbeat каждые 30 секунд и batch обновления защищают БД от перегрузки.
content:
  sections:
    - id: lifecycle_overview
      title: 'Жизненный цикл и состояния'
      body: |
        Определены этапы CREATED, ACTIVE, IDLE, AFK, DISCONNECTED, EXPIRED и CLOSED. Таблицы переходов описывают условия перевода между состояниями и время ожидания.
      mechanics_links: []
      assets: []
    - id: data_model
      title: 'Модель данных и аудит'
      body: |
        Таблица player_sessions хранит токены, статус, атрибуты персонажа и счётчики. audit_log фиксирует события, индексы ускоряют поиск активных записей.
      mechanics_links: []
      assets: []
    - id: cache_layout
      title: 'Кэш и структуры Redis'
      body: |
        Расписаны ключи session:{token}, player_session:{playerId} и множества active_players:{serverId}. TTL 24 часа, данные синхронизируются с БД.
      mechanics_links: []
      assets: []
    - id: session_creation
      title: 'Создание сессии и слоты'
      body: |
        SessionManager проверяет существующие подключения, генерирует токены, сохраняет запись, обновляет кэш и публикует SessionCreatedEvent.
      mechanics_links: []
      assets: []
    - id: heartbeat_mechanism
      title: 'Heartbeat и обновления'
      body: |
        Endpoint `/session/heartbeat` обновляет lastHeartbeat, сбрасывает статус в ACTIVE и ставит запись в очередь batch обновления. Срабатывают таймауты AFK и disconnect при отсутствии heartbeat.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: 'Задокументированы жизненный цикл сессии, схема данных, кэш и heartbeat.'
validation:
  checksum: ''
  schema_version: '1.0'

