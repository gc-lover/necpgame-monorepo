metadata:
  id: backend-session-reconnection-monitoring
  title: 'Session Management: Reconnection & Monitoring'
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T21:35:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T01:46:00Z
  owners:
    - role: backend_architect
      contact: backend@necp.game
  tags:
    - session
    - reconnection
    - monitoring
    - security
  topics:
    - session-management
    - player-lifecycle
  related_systems:
    - session-service
    - event-bus
    - notification-service
    - analytics-service
  related_documents:
    - id: backend-session-lifecycle-heartbeat
      relation: complements
  source: shared/docs/knowledge/implementation/backend/session/session-reconnection-monitoring.md
  visibility: internal
  audience:
    - backend
    - operations
    - analytics
  risk_level: high
review:
  chain:
    - role: backend_lead
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: Нужна устойчивая обработка разрывов связи и контроль сессий, чтобы игроки не теряли прогресс.
  goal: Описать процессы переподключения, ограничение параллельных сессий, таймауты и мониторинг состояния.
  essence: Документ фиксирует API и сервисную логику для восстановления сессий, очистки ресурсов и наблюдаемости.
  key_points:
    - Быстрый reconnect с проверкой токена в пяти минутном окне.
    - Управление параллельными входами через стратегии one session per player.
    - Таймауты активности и плановая очистка старых сессий.
    - Метрики, дашборды и защитные проверки от угонов сессий.
content:
  sections:
    - id: reconnection_flow
      title: 'Переподключение и API'
      body: |
        Клиент отправляет reconnect_token, сервис проверяет окно, статус и восстанавливает состояние. При успехе обновляется heartbeat, увеличивается счетчик disconnect и публикуется PlayerReconnectedEvent.
      mechanics_links: []
      assets: []
    - id: concurrent_sessions
      title: 'Контроль параллельных сессий'
      body: |
        Поддерживаются стратегии одного входа, нескольких устройств или вытеснения. Рекомендована схема single session per player с уведомлением и закрытием старой сессии через WebSocket.
      mechanics_links: []
      assets: []
    - id: session_timeouts
      title: 'Таймауты и очистка'
      body: |
        Определены inactivity, absolute и idle timeouts. Планировщик каждые пять минут закрывает истекшие сессии и удаляет архивные записи старше семи дней.
      mechanics_links: []
      assets: []
    - id: monitoring_metrics
      title: 'Мониторинг и аналитика'
      body: |
        Отслеживаются показатели активных сессий, AFK, частоты heartbeat и reconnect. Админ API предоставляет статистику, а Redis хранит активных игроков по серверам.
      mechanics_links: []
      assets: []
    - id: security_controls
      title: 'Безопасность и аудит'
      body: |
        Реализованы проверки IP, User-Agent, ротация токенов и ограничение попыток. Все события пишутся в журнал и используются для обнаружения захвата сессий.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#backend-session-reconnection-monitoring
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: 'Описаны механизмы переподключения, ограничения параллельных сессий, таймауты и мониторинг.'
validation:
  checksum: ''
  schema_version: '1.0'

