metadata:
  id: backend-session-reconnection-monitoring
  title: Session Management — Reconnection & Monitoring
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T21:35:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T01:46:00Z
  owners:
    - role: platform_lead
      contact: platform@necp.game
  tags:
    - sessions
    - reconnection
    - monitoring
  topics:
    - session-service
    - reliability
  related_systems:
    - analytics-service
    - event-bus
    - redis
  related_documents:
    - id: backend-session-lifecycle-heartbeat
      relation: complements
  source: shared/docs/knowledge/implementation/backend/session/session-reconnection-monitoring.md
  visibility: internal
  audience:
    - backend
    - platform
    - support
  risk_level: high
review:
  chain:
    - role: platform_lead
      reviewer: ''
      reviewed_at: 2025-11-07T01:46:00Z
      status: approved
  next_actions: []
summary:
  problem: Нужно гарантировать устойчивое переподключение игроков и мониторинг сессий при обрывах связи.
  goal: Задать правила reconnect окна, стратегий одновременных сессий, мониторинг метрик и закрытие сессий по тайм-аутам.
  essence: Документ описывает API переподключения, стратегии concurrent login, политики тайм-аутов, сохранение состояния и метрики мониторинга.
  key_points:
    - Reconnect токен действителен 5 минут, валидируется сервером и восстанавливает состояние.
    - Поддерживаются стратегии единственной сессии и вытеснения старых подключений.
    - Тайм-ауты (inactivity, absolute, idle) обслуживаются scheduled cleanup сервисом.
    - Мониторинг сессий поставляет статистику и интеграцию с аналитикой и event bus.
content:
  sections:
    - id: reconnection_flow
      title: Механизм переподключения
      body: |
        Endpoint `/reconnect` проверяет токен, окно действия и статус DISCONNECTED. При успешной проверке сессия возвращается в
        ACTIVE, обновляется heartbeat, пишется в Redis и публикуется событие PlayerReconnected.
      mechanics_links: []
      assets: []
    - id: concurrent_sessions
      title: Управление параллельными сессиями
      body: |
        Поддерживаются стратегии: одна сессия на игрока, несколько сессий и принудительное завершение старых подключений.
        Рекомендуемая схема закрывает предыдущие сессии, уведомляет клиента и сохраняет целостность данных.
      mechanics_links: []
      assets: []
    - id: timeouts_cleanup
      title: Тайм-ауты и очистка
      body: |
        SessionCleanupService по расписанию ищет истекшие сессии, закрывает их с причиной TIMEOUT и удаляет старые записи.
        Система поддерживает inactivity, absolute и idle тайм-ауты с разными порогами.
      mechanics_links: []
      assets: []
    - id: state_management
      title: Сохранение состояния
      body: |
        Session state хранит минимальный и расширенный набор атрибутов, включающих позицию, текущие задания и временные эффекты.
        Это используется при восстановлении после reconnect и при публикации событий.
      mechanics_links: []
      assets: []
    - id: monitoring_metrics
      title: Мониторинг и метрики
      body: |
        Метрики отслеживают активные сессии, AFK, heartbeat rate, количество переподключений и среднюю длительность. Endpoint
        `/admin/sessions/stats` предоставляет агрегации для панелей мониторинга.
      mechanics_links: []
      assets: []
    - id: security_controls
      title: Защита и интеграции
      body: |
        Проверяются IP, User-Agent и применяется ротация токенов для защиты от hijacking. При закрытии сессии система очищает
        состояния в party, combat и trade сервисах и отправляет события в Event Bus и Analytics.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: false
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml#backend-session-reconnection-monitoring
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: Описаны переподключение, несколько сессий, тайм-ауты и мониторинг.
validation:
  checksum: ''
  schema_version: '1.0'

