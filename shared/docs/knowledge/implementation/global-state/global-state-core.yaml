metadata:
  id: implementation-global-state-core-architecture
  title: 'Global State Core — Архитектура'
  document_type: implementation
  category: global-state
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T06:00:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T06:00:00Z
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - global-state
    - event-sourcing
    - backend
  topics:
    - state-management
    - persistence
    - telemetry
  related_systems:
    - event-bus
    - global-state-service
    - analytics-pipeline
  related_documents:
    - id: implementation-global-state-events
      relation: references
    - id: implementation-global-state-management
      relation: references
    - id: implementation-global-state-sync
      relation: references
    - id: implementation-global-state-operations
      relation: references
  source: shared/docs/knowledge/implementation/global-state/global-state-core.md
  visibility: internal
  audience:
    - concept
    - backend
    - analytics
  risk_level: high
review:
  chain:
    - role: concept_director
      reviewer: ''
      reviewed_at: ''
      status: pending
  next_actions: []
summary:
  problem: 'Глобальные события игры требуют централизованного учёта и воспроизведения, чего не обеспечивает традиционный CRUD.'
  goal: 'Сформировать устойчивую архитектуру Global State на основе Event Sourcing с полнотой истории и контролем конкуренции.'
  essence: 'Микросервисное ядро, в котором события через шину попадают в Event Store и пересобирают состояние мира, игроков и экономики.'
  key_points:
    - 'Используется event bus и выделенный Event Store в PostgreSQL для долговременного хранения.'
    - 'State Store и snapshots обеспечивают быстрые чтения и быстрый rollback состояния.'
    - 'Иерархия ключей и политики snapshot регулируют масштабируемость и аудит.'
content:
  sections:
    - id: architecture
      title: 'Контур системы'
      body: |
        Поток начинается на клиенте и через API Gateway поступает в специализированные сервисы (квесты, бой, экономика, социальные механики).
        Каждый сервис публикует события в шину (Kafka или RabbitMQ), откуда их считывают Event Store Writer, Global State Manager и аналитические конвейеры.
        Хранилище использует PostgreSQL и кэш Redis; архитектура рассчитана на поддержание целостного представления мира и игровых сессий.
      mechanics_links: []
      assets: []
    - id: event_sourcing
      title: 'Event Sourcing как основной паттерн'
      body: |
        В отличие от CRUD, система фиксирует каждое изменение как событие, что позволяет воспроизводить историю и проводить аудит.
        Event Store хранит версию, корреляцию, контекст игрока и сервера, а также JSONB полезную нагрузку и состояние обработки.
        Повторное воспроизведение событий даёт возможность синхронизировать кластеры, строить анализ ретроспективы и откатывать ошибки.
      mechanics_links: []
      assets: []
    - id: persistence
      title: 'Схемы хранения'
      body: |
        Таблица game_events индексируется по типу события, агрегату и времени, что ускоряет выборку и мониторинг необработанных записей.
        State Store поддерживает текущую проекцию состояния с уникальностью по server_id и ключу, отслеживая владельцев, регионы и версии.
        Snapshots фиксируют агрегированное состояние каждые 1000 событий, каждый час и при ключевых триггерах (например, смена лиги) для ускорения восстановления.
      mechanics_links: []
      assets: []
    - id: state_model
      title: 'Модель ключей и домены'
      body: |
        Ключи состоят из категории, сущности и атрибутов: player.{playerId}.level, world.territory.{zone}.controller, economy.item.{itemId}.price.
        Иерархия покрывает игроков, мир, экономику и специальные сервисы, позволяя хранить дополнительные метаданные и связи с событиями.
        Такая структура обеспечивает унифицированный доступ к данным и гибкость для новых подсистем без миграции схемы.
      mechanics_links: []
      assets: []
    - id: snapshots
      title: 'Снапшоты и восстановление'
      body: |
        Таблица state_snapshots хранит JSON-проекции, версию, ссылку на последнее событие и метрики создания.
        Снапшоты формируются каждые 1000 событий, каждый час и при ключевых игровых триггерах (например, смена лиги), ускоряя откат и анализ.
      mechanics_links: []
      assets: []
    - id: data_flow
      title: 'Поток данных'
      body: |
        Event Store Writer записывает события, Global State Manager обновляет проекции, Analytics фиксирует state_changes и affected_players,
        а шина событий транслирует изменения подписчикам. Такой поток поддерживает консистентность между сервисами и наблюдаемость.
      mechanics_links: []
      assets: []
    - id: integration
      title: 'Интеграции и зависимые артефакты'
      body: |
        Документ связан с серией микрофич: глобальные события, управление состоянием, синхронизация и операционные процессы.
        Эти материалы описывают типы событий, правила репликации, инструменты DevOps и playbooks для обработки ошибок.
        Вместе набор формирует полную методологию Global State, согласованную с архитектурой MMORPG/шутера.
      mechanics_links: []
      assets: []
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: ai_brain_manager
    changes: 'Выделена микрофича Global State Core с описанием архитектуры и схем хранения.'
validation:
  checksum: ''
  schema_version: '1.0'
