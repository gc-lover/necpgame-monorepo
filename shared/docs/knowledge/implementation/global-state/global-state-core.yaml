metadata:
  id: global-state-core
  title: Global State Core — архитектура и Event Sourcing
  document_type: implementation
  category: backend
  status: approved
  version: '1.0.0'
  last_updated: 2025-11-07T06:00:00Z
  concept_approved: true
  concept_reviewed_at: 2025-11-07T06:00:00Z
  owners:
    - role: concept_director
      contact: concept@necp.game
  tags:
    - world-state
    - event-sourcing
    - architecture
  topics:
    - world-service
    - event-store
  related_systems:
    - world-service
    - analytics-service
    - event-bus
  related_documents:
    - id: global-state-overview
      relation: references
    - id: global-state-management
      relation: complements
    - id: global-state-sync
      relation: complements
  source: shared/docs/knowledge/implementation/global-state/global-state-core.md
  visibility: internal
  audience:
    - concept
    - backend
    - data
  risk_level: high
review:
  chain:
    - role: world_service_lead
      reviewer: ''
      reviewed_at: 2025-11-07T06:00:00Z
      status: approved
  next_actions: []
summary:
  problem: Ядро глобального состояния описывалось в Markdown и требовало формализованной структуры для архитектуры и схем хранения.
  goal: Зафиксировать паттерн Event Sourcing, схемы Event Store и Global State, а также стратегию снапшотов и аудит.
  essence: Документ определяет архитектуру world-service, поток событий, схемы PostgreSQL и принципы восстановления состояния.
  key_points:
    - Event Sourcing фиксирует каждое игровое событие, обеспечивая аудит и реплей.
    - Event Store, Global State и Snapshots имеют формализованные схемы с индексацией.
    - Терминальные сервисы используют Kafka/RabbitMQ для трансляции изменений и аналитики.
    - Снапшоты снимаются по количеству событий, времени и ключевым игровым событиям.
content:
  sections:
    - id: system_architecture
      title: Архитектура системы
      body: |
        Клиент подключается через WebSocket к API Gateway, Backend-сервисы публикуют события в Event Bus,
        а подсистемы Event Store Writer, Global State Manager и Analytics сохраняют данные в PostgreSQL и Redis.
        Архитектура поддерживает масштабируемость и декомпозицию по доменам (Quest, Combat, Economy, Social).
      mechanics_links:
        - implementation/global-state/global-state-overview.yaml
    - id: event_sourcing
      title: Паттерн Event Sourcing
      body: |
        Вместо хранения только текущего состояния система записывает последовательность событий (например,
        PlayerLeveledUp). История позволяет делать аудит, отладку и time-travel. Реплей событий восстанавливает
        состояние для аналитики или тестирования.
      mechanics_links:
        - implementation/global-state/global-state-management.yaml
    - id: event_store_schema
      title: Схема Event Store
      body: |
        Таблица `game_events` содержит метаданные, данные события, контекст (server_id, player_id, session_id),
        временные отметки и статус обработки. Индексы по aggregate, типу, времени и player_id ускоряют выборки,
        а флаги `is_processed` и `retry_count` поддерживают повторную обработку.
      mechanics_links:
        - implementation/database/event-store-schema.yaml
    - id: state_store_schema
      title: Схема Global State
      body: |
        Таблица `global_state` хранит ключ, категорию, значение, тип и метаданные, включая предыдущие значения,
        ссылку на событие и время изменения. Индексы по серверу, категории, ключу и владельцу обеспечивают быстрый доступ.
      mechanics_links:
        - implementation/global-state/global-state-management.yaml
    - id: snapshot_strategy
      title: Snapshots и стратегия
      body: |
        `state_snapshots` сохраняют агрегированное состояние: JSON-данные, версию, ссылку на последнее событие,
        количество событий, размер и длительность создания. Снапшоты создаются каждые 1000 событий, каждый час
        или при ключевых игровых триггерах (например, смена лиги).
      mechanics_links:
        - implementation/global-state/global-state-sync.yaml
    - id: data_flow
      title: Поток данных и интеграции
      body: |
        Event Store Writer записывает события, Global State Manager обновляет `global_state`, Analytics регистрирует
        state_changes и affected_players, а Event Bus транслирует изменения подписчикам. Этот поток обеспечивает
        консистентность между сервисами и поддержку аналитики.
      mechanics_links:
        - implementation/global-state/global-state-operations.yaml
appendix:
  glossary: []
  references: []
  decisions: []
implementation:
  needs_task: true
  queue_reference:
    - shared/trackers/queues/concept/queued.yaml
  blockers: []
history:
  - version: '1.0.0'
    date: 2025-11-07
    author: world_service_team
    changes: Сформирована архитектура Event Sourcing и схемы хранения глобального состояния.
validation:
  checksum: ''
  schema_version: '1.0'

