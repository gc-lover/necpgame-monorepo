# Боевая система — Loadouts и комплекты

**api-readiness:** ready  
**api-readiness-check-date:** 2025-11-08 00:14
**api-readiness-notes:** Документ детализирует PvE-петли, доменную модель, API и интеграции для loadouts; готов к постановке API задач.  
**target-domain:** gameplay-combat  
**target-microservice:** gameplay-service (port 8083)  
**target-frontend-module:** modules/combat/loadouts  
**Статус:** review — подготовка к API задачам  
**Приоритет:** Высокий  
**Дата создания:** 2025-11-08  
**Последнее обновление:** 2025-11-08 00:14  
**Версия:** 0.3.0

---

---

## Цели системы Loadouts

- Давать игроку до 10 преднастроенных боевых конфигураций, чтобы быстро переключаться между ролями, режимами и сценариями.
- Объединять экипировку, способности, импланты, навыки, гаджеты, кибердеку и расходники в единое целое.
- Обеспечесать совместимость с микро-сервисной архитектурой: хранение и валидация на `gameplay-service`, синхронизация с `economy-service` и `social-service`.
- Упростить матчмейкинг и подготовку к рейдам, аренам, экстракциям, PvP/PvE событиям.

---

## Ключевые определения

- **Loadout (Лодаут):** сохранённый набор всех боевых параметров персонажа, который можно активировать перед матчем или в безопасной зоне.
- **Комплект (Kit):** связка внутри лодаута, объединяющая конкретный тип сущностей (пример: оружейный комплект, имплант-комплект, кибердек-комплект). Комплекты можно переиспользовать между лодаутами.
- **Активный лодаут:** текущая конфигурация персонажа.
- **Резервные лодауты:** сохранённые конфигурации, которые можно быстро активировать.
- **Глобальные пресеты:** типовые лодауты от фракций/корпораций, выдаваемые за прогресс, события, сезоны.

---

## Ограничения и слоты

- **Количество:** базово 3 слота лодаутов, расширение до 10 через прогрессию (уровень репутации, фракционные квесты, премиальные сервисы).
- **Группировка:** лодауты делятся на категории — PvE-рейды, PvP-арена, Экстракция, Стелс, Кибервойна. Категория влияет на доступные комплекты и рекомендуемые пресеты.
- **Лимиты пересохранения:** в бою запрещено менять комплекты, в безопасной зоне — без ограничения, в экстракции — только через мобильные станции.
- **Привязка к классам:** каждый лодаут хранит выбранную боевую роль (`combat-roles-detailed.md`) и проверяет совместимость навыков и имплантов.
- **Синхронизация:** при смене лодаута система валидирует вес/энергию/перегрев, проверяет наличие предметов в инвентаре и доступность навыков.

---

## Структура лодаута

1. **Экипировочный комплект**
   - Основное и дополнительное оружие (с модами, брендовыми сигнатурами).
   - Броня и щиты (вкл. сетовые бонусы).
   - Тактические гаджеты (дроны, турели, ловушки).
2. **Комплект способностей**
   - Слоты Q/E/R + два дополнительных активных слота для гибридных билдов.
   - Пассивные способности и перки.
   - Расход ресурсов (энергия, здоровье, боеприпасы способностей).
3. **Имплант-комплект**
   - Слоты по типам (боевые, тактические, защитные, двигатель, операционная система).
   - Энергетический бюджет, лимиты человечности, риск киберпсихоза.
4. **Комплект навыков и прокачки**
   - Поддерево очков навыков, активируемое с лодаутом (выбор ветки, распределение очков).
   - Умения классовых линий, которые зависят от выбранной роли.
5. **Кибердек-комплект**
   - Слоты программ взлома (5 активных, 5 запасных).
   - Настройки защиты, протоколы быстрого взлома, триггеры AI-помощника.
6. **Комплект расходников**
   - Мед-гели, стимы, гранаты, батареи имплантов.
   - Ограничение по весу и количеству.
7. **Транспорт/дрон-комплект**
   - Персональные дроны, мех-существа, экзо-скелеты, их моды и командные режимы.

Каждый комплект имеет независимый шаблон и версию. Изменение комплекта обновляет все лодауты, в которых он используется, с логом изменений.

---

## Комплекты и переиспользование

- **Личная библиотека:** игрок хранит комплекты отдельно и комбинирует их в лодауты.
- **Фракционные комплекты:** выдаются фракциями, имеют ограничения по изменению (пример: `Arasaka Black Ops`).
- **Корпоративные бренды:** интеграция с `economy/equipment` — брендовые бонусы активируются, если комплект собран полностью.
- **Командные комплекты:** лидер отряда может рекомендовать стандартизированные комплекты для рейда; члены отряда получают временный доступ.
- **Рынок:** возможность обмениваться комплектами (через рецепты/планы) внутри `economy-service` с валидацией авторских прав.

---

## Loadouts для навыков и способностей

- **Гибридная сетка:** каждая роль имеет базовый набор слотов навыков и дополнительных гибридных слотов, доступных через импланты или прогрессию.
- **Сохранение распределения:** при активации лодаута автоматически применяются выбранные пассивы и очки в поддеревьях.
- **Синергия с имплантами:** определённые импланты автоматически активируют/деактивируют навыки.
- **Макрофункции:** игрок создаёт макрокоманды (например, «стелс-комбо»), привязанные к конкретному набору способностей и гаджетов.
- **Вариативность:** поддержка минимум 4 типов ability-loadouts — штурм, поддержка, кибервойна, разведка.

---

## Управление лодаутами

- **Создание:** пошаговый мастер (выбор роли → выбор категории → добавление комплектов → проверка лимитов → сохранение).
- **Редактирование:** режим изменения конкретного комплекта или всей конфигурации; история версий с откатом.
- **Активирование:** через безопасные зоны, мобильные станции, командный интерфейс перед матчем; отображаются требования режима.
- **UI:** вкладки по категориям, визуализация энергобюджета, веса, синергий. Использование компонентов `shared/ui/CyberpunkTabs`, `shared/ui/LoadoutCard`.
- **Совместимость:** система автоматически подсвечивает несовместимые элементы и предлагает альтернативы.

---

## Прогрессия и монетизация

- **Разблокировка слотов:** уровень персонажа, репутация, достижения, подписки корпораций.
- **Расширенные комплекты:** премиум-слоты для дополнительного набора гаджетов или уникальных имплантов (балансируется ограничениями).
- **Сезонные стимули:** временные лодауты, дающие бонус к прогрессу, но требующие активной игры.
- **Экономика:** крафт и сбор комплектов в `economy-service`, торговля чертежами, обслуживание имплантов.

---

## PvE экспедиции и лутинг по мотивам ARC Raiders

- **Экстракшн-петля:** лодауты должны поддерживать полный цикл «высадка → зачистка → эвакуация». Перед вылетом игрок выбирает профиль (ударный, разведывательный, эвакуационный) и соответствующий комплект, влияющий на бонусы при выходе с добычей.
- **Динамические условия карты:** сохранение шаблонов событий вроде «Скрытый бункер», «Ночные рейды», «Электромагнитные бури». Лодауты обязаны иметь предустановки для энергетической защиты, сенсорных модулей и борьбы с помехами.
- **Модули против механических ARC:** отдельный каталог комплектов с импульсным, EMP и разрушающим оружием. Требуется проверка совместимости с имплантами, повышающими сопротивление перегреву и урону от машин.
- **Командные роли PvE:** лидер рейда назначает «Сноубрейкера» (вскрывает укрепления), «Сэйфраннера» (тащит груз) и «Штормового оператора» (держит агрессоров). Для каждой роли — рекомендованный набор умений, гаджетов и транспорта.
- **Сбор трофеев:** комплекты должны учитывать вес, объём и тип ресурса. При превышении лимита система предлагает подключить дрон-носитель или сбросить низкоценные предметы.
- **Экстренная эвакуация:** активные способности лодаута включают «эвак-маяки» и мобильные станции. Валидатор проверяет наличие необходимых расходников, аккумуляторов и доступ к сетевому каналу.
- **Риск-награда:** чем больше времени игрок проводит на карте, тем выше уровень угрозы ARC и шанс вторжения других отрядов. Лодауты получают адаптивные модификаторы — усиление щитов, снижение шума, расширение сенсоров.

---

## Связь с прогрессией и классами

- **Роль-схемы:** каждый лодаут хранит `loadoutRoleCode` (stormbreaker, safebearer, scout, stormrunner). Роли синхронизированы с `progression/classes-overview.md` и `progression-skills-mapping.md`.
- **Уровни мастерства:** разблокировка расширенных комплектов требует `masteryTier` (T1-T3) по ветке класса и `skillSynergyScore`. Формулы берутся из `progression-attributes-matrix.md`.
- **Перки и узлы:** при активации лодаута подтягиваются значения из `progression-attributes.json` и `skills-mapping.yaml`, что гарантирует соответствие навыков и экипировки.
- **Ресет через сервис:** смена класса требует `respecToken` с проверкой, что неактивные лодауты не нарушают ограничения класса.

---

## Интеграция с событиями и картами

- **Live Events:** события из `world/events/live-events-system.md` могут публиковать `world.events.loadouts-modifier` с изменением допустимых комплектов (например, «Электромагнитная буря» отключает высоковольтные импланты).
- **Динамические угрозы:** глобальные события повышают `threatLevel` зон, что отражается в рекомендациях лодаута через `threatAdaptationProfile`.
- **Календарь рейдов:** расписание PvE-зон из `combat-extract.md` формирует очереди подготовки; система loadouts автоматически предлагает рекомендуемые комплекты по типу события.

---

## Доменные сущности и схемы

| Сущность | Основные поля | Описание |
| --- | --- | --- |
| `Loadout` | `loadoutId`, `characterId`, `roleCode`, `category`, `masteryTier`, `energyBudget`, `weightBudget`, `active` | Базовая запись конфигурации. |
| `LoadoutKit` | `kitId`, `type` (weapon, implants, abilities, deck, consumables, transport), `version`, `ownerId`, `sharedScope` | Шаблон комплекта, который можно переиспользовать. |
| `LoadoutSlot` | `loadoutId`, `kitType`, `kitId`, `priority`, `constraints` (JSONB) | Привязка комплекта к лодауту. |
| `LoadoutMacro` | `macroId`, `loadoutId`, `trigger` (ability, sensor, manual), `sequence` | Пресеты макрокоманд. |
| `LoadoutProfileRequirement` | `profileCode`, `attributeCaps`, `skillTags`, `eventModifiers` | Ограничения ролей и событий. |

Схема в `gameplay-service` реализуется через таблицы `combat_loadouts`, `combat_loadout_kits`, `combat_loadout_slots`, `combat_loadout_macros`, `combat_loadout_profiles`.

---

## API контракты (расширено)

| Endpoint | Метод | Payload | Ответ |
| --- | --- | --- | --- |
| `/api/v1/gameplay/loadouts` | `GET` | `?category`, `?role`, `?eventCode` | Массив `LoadoutSummary` с агрегированными метриками. |
| `/api/v1/gameplay/loadouts` | `POST` | `CreateLoadoutRequest` (роль, категория, список `kitRefs`, `macroSetup`, `profileCode`) | `201` + `LoadoutDetail`. |
| `/api/v1/gameplay/loadouts/{id}` | `PATCH` | `UpdateLoadoutRequest` (новые комплекты, актуализация лимитов, связывание с событиями) | `LoadoutDetail`. |
| `/api/v1/gameplay/loadouts/{id}/activate` | `POST` | `ActivateLoadoutRequest` (context: `mode`, `zoneId`, `eventCode`) | `ActivationReport` с валидатором рисков. |
| `/api/v1/gameplay/loadouts/{id}/macros` | `PUT` | `MacroBatchRequest` | `MacroBatchResult` с перезапуском макропроцессов. |
| `/api/v1/gameplay/loadouts/profiles` | `GET` | `?role`, `?eventCode` | Каталог ролей и требований. |

**События:**  
`combat.loadouts.created`, `combat.loadouts.updated`, `combat.loadouts.activated`, `combat.loadouts.profile-violated`, `combat.loadouts.event-adjusted`.  
**Контроллеры:** реализуются в `gameplay-service`, публикация в Kafka темах `combat-loadouts`.

---

## Очереди обновлений и масштабирование

- **Batch Update Queue:** nightly job, который пересчитывает комплектные веса после балансового патча. Очередь `combat.loadouts.recalculate` обрабатывается воркерами, разделёнными по shard ключу `characterId`.
- **Live Patch Hook:** админ-интерфейс отправляет `POST /admin/combat/loadouts/rebalance` → формируется задание в Redis Streams с шагом `diffPreview` → только изменённые комплекты обновляются.
- **Conflict Resolution:** при одновременных изменениях ключом является `revision`. REST возвращает `409`, UI предлагает merge, backend использует `jsonb_diff_patch`.

---

## Управление недоступными предметами и имплантами

- Если предмет временно изъят (аренда, таймер, блокировка), `availabilityService` помечает запись `inventory_item` флагом `suspended_until`.
- При активации лодаута валидатор либо предлагает замены из `fallbackKit`, либо переводит лодаут в режим `degraded` и ограничивает вход в высокорисковые зоны.
- Репорт отправляется через `combat.loadouts.availability-warning`, чтобы аналитика отслеживала частоту деградаций.

---

## Политики фракционных комплектов

- Количество фракционных комплектов в одном лодауте ограничено `maxFactionKits=2`. Превышение запрещено валидатором.
- Изменение фракционных комплектов требует разрешение `factionPermitLevel`. Операции логируются в `faction_audit`.
- Сезонные фракционные комплекты автоматически истекают; по истечении система предлагает замену из личной библиотеки.

---

## Макрокоманды и UX ограничители

- Макрокоманды делятся на типы: `sequenced`, `conditional`, `sync`. Каждая команда имеет лимит `maxSteps=8`.
- Редактор макросов проверяет коллизию управления с привязками способностей; конфликтные шаги подсвечиваются.
- Экспорт макроса формирует JSON с декларативными шагами; импорт возможен только внутри аккаунта для предотвращения злоупотреблений.

---

## Обмен лодаутами между персонажами

- Разрешён экспорт шаблонов через `blueprintToken`. Токен привязывается к `accountId` и может быть активирован на других персонажах пользователя.
- При импорте проводится повторная валидация ролей и уровня мастерства; несовместимые элементы заменяются предложениями из каталога.
- Публичный обмен разрешён только через `economy-service` (аукцион чертежей) с комиссией и записью в `blueprint_registry`.

---

## Метрики и телеметрия

- `activation_success_rate`, `availability_conflicts`, `event_adjustments`, `macro_usage`, `profile_violations`.
- Метрики публикуются в `combat_loadouts_metrics` (Prometheus) и выгружаются в `analytics/loadouts-dataset.parquet`.
- Для PvE экспедиций отдельно трекаются `extraction_completion_rate` и `loot_weight_distribution`.

---

## Интеграция с другими системами

- **Матчмейкинг:** лодауты передаются в `matchmaking-service` для подбора команд и расчёта рейтинга.
- **Социальные функции:** возможность делиться публичными лодаутами в кланах, голосовать за пресеты, назначать обязательные комплекты.
- **Прогрессия:** данные о использовании лодаутов влияют на перки, достижения и рекомендательные системы.
- **События:** специальные события требуют конкретных комплектов (например, «нулевой имплант», «хардкор»).
- **Аналитика:** логирование активности для балансировки (какие комплекты популярны, какие комбинации ломают баланс).

---

## Требования к данным и API (черновик)

- `GET /api/v1/gameplay/loadouts` — список лодаутов персонажа, фильтрация по категории.
- `POST /api/v1/gameplay/loadouts` — создание нового лодаута на основе выбранных комплектов и роли.
- `PATCH /api/v1/gameplay/loadouts/{id}` — обновление составных комплектов, история версий.
- `POST /api/v1/gameplay/loadouts/{id}/activate` — активация с проверкой условий режима.
- `GET /api/v1/gameplay/loadouts/kits` — библиотека комплектов (личные, фракционные, глобальные) с фильтрацией по событиям.
- `POST /api/v1/gameplay/loadouts/{id}/macros/preview` — прогон макроса в симуляторе.
- События RabbitMQ/Kafka при активации лодаута для синхронизации с `economy-service` и `social-service`.
- Требуется схема валидации для энергии, веса, лимитов имплантов, совместимости способностей.

---

## История изменений

- v0.3.0 (2025-11-08 00:14) — Готовность к API: добавлены связи с прогрессией и событиями, доменная модель, расширенные API контракты, очереди обновлений и политики макросов.
- v0.2.0 (2025-11-07) — добавлены механики PvE экспедиций, динамических условий карт и лутинг-систем, вдохновлённых ARC Raiders.
- v0.1.0 (2025-11-08) — первичное описание системы боевых лодаутов, комплектов и интеграций.


****