# Система семейных отношений с NPC — детальная версия

- **Status:** queued
- **Last Updated:** 2025-11-08 20:10
---


**Статус:** approved  \\n**Версия:** 1.0.0  \\n**Дата создания:** 2025-11-07  \\n**Последнее обновление:** 2025-11-08 20:10  \\n**Приоритет:** высокий

**target-domain:** social  \\n**target-microservice:** social-service (port 8084)  \\n**target-microservice-secondary:** world-service (port 8092), economy-service (port 8089), character-service (port 8090)  \\n**target-frontend-module:** modules/social/families, modules/world/insights

**api-readiness:** ready  \\n**api-readiness-check-date:** 2025-11-09 11:21  \\n**api-readiness-notes:** Перепроверено 2025-11-09 11:21: дерево родства, события, наследование и REST/Kafka контуры остаются консистентными, блокеров нет.

---

## 1. Методика детализации

- **Слои:** структура семьи, эмоциональные связи, события, квесты, наследование, влияние на фракции.
- **Роли:** Родитель, Ребенок, Брат/Сестра, Супруг/Партнер, Опекун, Подопечный, Расширенная семья, Клан.
- **Модули:** `social-service` (отношения, доверие, семейные статусы), `world-service` (события, обновления мира), `character-service` (биография NPC), `economy-service` (наследство, ресурсы), `gameplay-service` (квесты, миссии), `factions-service` (династии, влияние).
- **Интерфейсы:** дерево семьи, карточки членов семьи, журналы событий, предупреждения.

---

## 2. Семейные структуры

- **Ядро:** родители, дети, супруги/партнёры.
- **Расширение:** бабушки/дедушки, дяди/тёти, кузены, приёмные связи.
- **Кланы:** фамильные кланы, объединяющие несколько семей (поддержка фракций, бизнесов).
- **Опека:** опекуны и подопечные (включая сирот, спасённых NPC, роботов).
- **Связи:** родственные и брачные отношения, их состояние (активно, напряжено, разорвано).

### 2.1 Атрибуты члена семьи

- **ID, имя, возраст, статус** (жив, пропал, погиб).
- **Профессия, фракция, местоположение.**
- **Отношение к игроку** (репутация, доверие, эмоции).
- **Секреты:** скрытая информация, раскрывающаяся через квесты.

---

## 3. Эмоциональные и социальные уровни

- **Базовое отношение:** как в `npc-relationships-system-детально.md`, но с повышенными коэффициентами.
- **Эмоции:** семейная привязанность, тревога, гордость, грусть, гнев.
- **Доверие:** влияет на доступ к семейным секретам, ресурсам, помощи.
- **Лояльность к клану:** определяет готовность NPC участвовать в семейных миссиях.

### 3.1 Дерево эмоций

- Комбинации эмоций определяют поведение (например, «гордость + тревога» → NPC просит помощи).
- События вызывают сдвиги (свадьба, болезнь, похищение, победа).

---

## 4. События семейной жизни

- **Свадьбы и союзы:** меняют связи, дают бонусы, создают квесты.
- **Рождение/усыновление:** новые NPC, изменение статуса, потребность в ресурсах.
- **Болезнь/кризис:** запрос помощи, запуск медицинских/экономических миссий.
- **Конфликты:** споры о наследстве, идеологии, фракциях.
- **Трагедии:** смерть, похищение, пропажа — сильное влияние на отношения.
- **Праздники:** семейные события, улучшение отношений, подарки.

Каждое событие имеет триггеры, последствия, связанные квесты и визуальные сигнализации.

---

## 5. Взаимодействие игрока с семьёй NPC

- **Диалоги:** дополнительные ветки в зависимости от отношения, статуса семьи.
- **Помощь:** доставка лекарств, защита, участие в свадьбах.
- **Подарки:** семейные реликвии, предметы, влияющие на эмоции.
- **Посещения:** семейные дома, встречи, VR-воспоминания.
- **Медиатор:** решение споров между членами семьи.

### 5.1 Семейные квесты и цепочки

- **Помощь:** лечебные, логистические, эмоциональные.
- **Конфликты:** выбор стороны, переговоры, акции.
- **Воссоединение:** поиск пропавших, возвращение членов.
- **Тайны:** расследования, раскрытие правды.
- **Династии:** многопоколенные цепочки, влияющие на фракции.

---

## 6. Усыновление и вступление в семью

- **Условия:** высокая репутация, квесты, ресурсы.
- **Процесс:** согласие NPC, разрешение фракции, церемония.
- **Последствия:** NPC становится частью «семьи игрока», появляются семейные квесты, доступ к ресурсам.
- **Игрок в семье NPC:** может стать «приёмным сыном/дочерью», получить поддержку, обязанности.

---

## 7. Наследование и ресурсы

- **Наследство:** имущество, компании, акции, тайники.
- **Завещания:** выбор наследников, условия, квесты на подтверждение.
- **Споры:** суды, переговоры, силовые решения.
- **Экономика:** налоги, фракционные проверки, влияние на `economy-service`.

---

## 8. Влияние на фракции и мир

- **Клановые союзы:** семьи входят в союзы корпораций/банд, предоставляют ресурсы.
- **Политика:** семейные решения меняют дипломатические связи.
- **Общественное мнение:** новости, медиа, кампании.
- **Города:** семейные дома, районные события, семейные бренды.

---

## 9. UX и визуализация

- **Дерево семьи:** интерактивное, с фильтрами, историей событий.
- **Календарь:** важные даты (дни рождения, юбилеи, церемонии).
- **Журнал:** хронология взаимодействий, эмоций, квестов, решений.
- **Оповещения:** уведомления о событиях, просьбах, конфликтах.
- **VR-архив:** воспоминания, записи.

---

## 10. Связи с другими системами

- `relationships-system-детально.md` — базовая репутация и доверие.
- `npc-relationships-system-детально.md` — эмоции и романтика.
- `mentorship-system-детально.md` — наставничество внутри семьи.
- `npc-hiring-system-детально.md` — семейный бизнес и найм родственников.
- `player-orders-system-детально.md` — семейные поручения.
- `visual-style-assets-детально.md` — визуальные черты семей.

---

## 11. Использование документа

- Использовать при разработке API для семейных событий, связей, наследования.
- Подготовить UX/UI (дерево семьи, журналы, уведомления).
- Связать с нарративными сюжетами, фракционными войнами, экономикой.
- UX макеты дерева семьи, журналов и уведомлений утверждены (PR `FW-FAMILY-010`).
- Баланс влияния семей согласован с economy/world/social командами.

---

## 12. REST API и JSON схемы

- `GET /social/families/{familyId}/tree` — структура семьи (`FamilyTreeResponse`).
- `POST /social/families/tree/update` — обновление связей (`FamilyTreeUpdateRequest`).
- `GET /social/families/{familyId}/events` — события семейной жизни (`FamilyEvent`).
- `POST /social/families/events` — регистрация событий (свадьба, кризис, праздник) (`FamilyEventCreateRequest`).
- `POST /economy/families/heritage/calculate` — расчёт наследства (`FamilyHeritageRequest`).
- `GET /social/families/{familyId}/history` — журнал взаимодействий (`FamilyHistoryResponse`).

**JSON схемы:**  
- `schemas/social/family-tree-response.schema.json`  
- `schemas/social/family-tree-update.schema.json`  
- `schemas/social/family-event.schema.json`  
- `schemas/economy/family-heritage.schema.json`  
- `schemas/social/family-history.schema.json`

---

## 13. Kafka события и очереди

| Topic | Producer | Payload | Консьюмеры |
|-------|----------|---------|-----------|
| `social.family.event` | social-service | `{ familyId, eventId, eventType, severity, relatedNpcIds[] }` | world-service, notification-service, quest-service |
| `economy.family.heritage` | economy-service | `{ heritageId, familyId, assets[], taxes, disputes }` | social-service, factions-service |
| `world.family.crisis` | world-service | `{ crisisId, cityId, familyId, crisisType, requiredActions[] }` | social-service, npc-service |
| `social.family.status.changed` | social-service | `{ familyId, relationType, oldState, newState, timestamp }` | telemetry, analytics |

- Очереди: `family-event-review` (модерация), `family-heritage-validation` (проверка наследства), `family-crisis-forecast` (world-service).

---

## 14. Метрики и аналитика

- `FamilyStabilityIndex` — устойчивость семей, влияет на world-events.
- `HeritageDisputeRate` — частота споров о наследстве, используется economy-service.
- `FamilyEventImpact` — воздействие событий на отношения и фракции.
- `AdoptionSuccessRate` — успешность усыновлений, влияет на social-service.
- `ClanAllianceStrength` — сила семейных союзов в фракциях.

---

## 15. UX, QA и согласование

- UI макеты утверждены: PR `FW-FAMILY-010` (дерево, календарь, журнал).
- Security review `SEC-FAMILY-003` — проверены санкции и конфиденциальность данных.
- QA чеклист:  
  - [x] JSON схемы валидированы `schema-test`.  
  - [x] Kafka payloadы синхронизированы с backend.  
  - [x] UX сценарии протестированы (свадьбы, кризисы, наследование).
- Workshop 2025-11-08 10:45: social/economy/world команды подтвердили индексы и события.

---

## 16. История изменений

- 2025-11-08 — добавлены API задачи, REST/Kafka контуры, метрики и UX согласование; статус `approved`, готовность `ready`.
- 2025-11-07 — первичный драфт семейной системы.