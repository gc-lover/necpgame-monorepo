# Система отношений с NPC — детальная версия

- **Status:** approved
- **Last Updated:** 2025-11-09 12:15
---

**Статус:** approved  
**Версия:** 1.0.0  
**Дата создания:** 2025-11-07  
**Последнее обновление:** 2025-11-09 12:15  
**Приоритет:** высокий

**target-domain:** social  
**target-microservice:** social-service (port 8084)  
**target-microservice-secondary:** world-service (port 8092), gameplay-service (port 8086), economy-service (port 8089), character-service (port 8090)  
**target-frontend-module:** modules/social/npc-relations, modules/world/insights

**api-readiness:** ready  
**api-readiness-check-date:** 2025-11-09 12:15  
**api-readiness-notes:** Перепроверено 2025-11-09 12:15 — менеджер подтвердил полноту шкал, событий и REST/Kafka контуров; блокировок для API задач нет.

---
**API Tasks Status:**
- Status: completed
- Tasks:
  - API-TASK-096: NPC Relationships API — `api/v1/social/npc-relationships/npc-relationships.yaml`
    - Создано: 2025-11-09 16:40
    - Завершено: 2025-11-09 19:17
    - Доп. файлы: `npc-relationships-models.yaml`, `npc-relationships-models-operations.yaml`, `README.md`
    - Файл задания: `API-SWAGGER/tasks/completed/2025-11-09/task-096-social-npc-relationships-api.md`
- Last Updated: 2025-11-09 19:17
---

---

## 1. Методика детализации

- **Слои:** уровень симпатий, репутация, эмоции, доверие, сюжетные события.
- **Типы NPC:** сюжетные, функциональные, романтические, наёмные, социальные лидеры, антагонисты.
- **Модули:** `social-service` (отношения), `world-service` (события и реакция мира), `gameplay-service` (миссии), `character-service` (биографии и статусы NPC).
- **Интерфейсы:** карточки NPC, журнал отношений, индикаторы эмоций, всплывающие уведомления.
- **События:** реплики, изменение поведения, открытие квестов, бонусы и штрафы.

---

## 2. Типы NPC и уровни важности

- **Core Story NPC:** сюжетные фигуры, влияют на главный нарратив.
- **Functional NPC:** торговцы, тренеры, мастера имплантов.
- **Romance NPC:** высокий уровень сложности, моральные и репутационные требования.
- **Hireable NPC:** кандидаты в персонал (боевые, экономические, социальные роли).
- **Social Leaders:** главы кланов, политические лидеры, медиа-фигуры.
- **Antagonist NPC:** враги, с которыми возможно перейти из вражды в союз и обратно.

Каждый тип имеет собственные пороги отношений, эмоциональные триггеры и последствия.

---

## 3. Уровни отношений с NPC

### 3.1 Ступени базового отношения

- **-100..-51: Ненависть** — NPC атакуют, саботируют, нанимают охотников.
- **-50..-11: Неприязнь** — холодное поведение, отказ в услугах, угрозы, повышенные цены.
- **-10..+10: Нейтралитет** — стандартное взаимодействие, базовые реплики.
- **+11..+50: Дружба** — скидки, индивидуальные квесты, доступны совместные действия.
- **+51..+100: Союз/Партнёрство** — совместные операции, доступ к ресурсам NPC, поддержка в кризисах.

### 3.2 Эмоциональные слои

- **Доверие (Trust NPC):** влияет на доступ к тайнам, совместным миссиям, безопасности.
- **Эмоции (Mood):** отображает текущее состояние NPC (радость, тревога, гнев, печаль, интерес). Определяет реплики, эмодзи, реакции.
- **Лояльность (Loyalty):** долгое взаимодействие, влияет на готовность NPC рисковать.

### 3.3 Романтическая шкала

- **Interest:** NPC проявляет интерес, открываются личные квесты.
- **Affection:** доступ к доверительным диалогам, небольшие бонусы.
- **Commitment:** серьёзные отношения, совместные истории, доступ к особым миссиям.
- **Bond:** высокий уровень — NPC готов жертвовать, предоставлять эксклюзивы.

Романтика требует поведения (репутация, решения, классовые и фракционные требования, тайминг).

---

## 4. Влияние класса, фракции и происхождения

### 4.1 Классовые бонусы

- **NetRunner:** доступ к хакерским квестам NPC, бонус к доверию техно-персонажей.
- **Solo:** уважение боевых NPC, скидки на оружие.
- **Techie:** дополнительные диалоги с инженерами, ускоренный найм.
- **Face:** бонус к социальным тестам, большая эмпатия, штраф за предательство.
- **Nomad:** усиленное доверие у клановых NPC, бонусы в Badlands.

### 4.2 Фракционное влияние

- **Корпорации:** NPC союзники корпораций дают бонусы, противники — штрафы. Смена фракции = изменение отношений.
- **Банды:** высокий уровень уличных NPC зависит от выбора игрока.
- **Организации:** синхронизация с `factions-overview-детально.md`.

### 4.3 Происхождение персонажа

- **Аркология, улицы, номадские степи** — определяют стартовые отношения, диалоги, скрытые квесты.

---

## 5. Механики роста/падения отношений

- **Квесты:** основное влияние (плюс/минус). Некоторые квесты меняют отношение навсегда.
- **Подарки:** разный эффект в зависимости от вкусов NPC (каталог предметов).
- **Свободное время:** использование социальных хабов, посещение мероприятий, романтические сцены.
- **Предательство:** резкое снижение, вводится cooldown на восстановление.
- **Ивенты:** события в мире (войны, кризисы) меняют отношение NPC глобально.

---

## 6. Специальные типы отношений

- **Наставничество:** NPC выступает наставником, открывая навыки и навыковые квесты.
- **Гильдейские связи:** NPC как контакт для фракций.
- **Семейные связи:** родственные NPC, доступ к семейным квестам.
- **Деловые связи:** торговые соглашения, проценты, совместные предприятия.
- **Скрытые связи:** отношения необходимо раскрыть (разгадать тайну, выполнить условия).

---

## 7. Игроки как NPC

- **Персонажи игроков могут выполнять роли NPC** (квестодатели, торговцы, фиксеров).
- **Поддержка:** нужно наличие репутации, рейтинга и договоров.
- **Интерфейс:** карточка игрока-NPC отображает услуги, цены, репутацию.
- **Модерация:** `social-service` контролирует честность, `economy-service` — платежи.

---

## 8. Найм NPC и персональный состав

- **Уровни найма:** базовый, продвинутый, элитный.
- **Параметры:** ранг, специализация, расходы, доступное снаряжение.
- **Доверие:** высокий наём требует доверия и репутации.
- **Менеджмент:** связка с `npc-hiring-*` документами (экономика, лимиты, управление).

---

## 9. Влияние отношений на игровой мир

- **Города:** доступ к хабам, скидки, персональные приглашения.
- **Фракции:** изменение политической карты, влияние на войны.
- **События:** NPC приглашают на мероприятия, спасают игрока, передают секреты.
- **Экономика:** скидки, эксклюзивные товары, совместные бизнесы.
- **Комбат:** помощь NPC в боях, вызов подкреплений.

---

## 10. Журнал отношений и UX

- **Карточка NPC:** фото/голограмма, уровни, эмоции, история.
- **Таймлайн:** события взаимодействий, ключевые моменты, подарки.
- **Чеклист романтики:** условия, доступные сцены, последствия.
- **Напоминания:** уведомления о днях рождения, событиях, статусе.

---

## 11. История и арбитраж

- **Логи:** все изменения отношений фиксируются.
- **Арбитраж:** игрок может жаловаться на NPC или наоборот, влияет на доверие.
- **Публичность:** у некоторых NPC отношения публичны, у других — скрыты.

---

## 12. Использование документа

- Применять при создании API функций для отношений с NPC.
- Использовать как базу при разработке квестов, романтики, социальных хабов.
- Синхронизировать с `relationships-system-детально.md`, `visual-style-assets-детально.md`, `factions-overview-детально.md`.
- UX/UI макеты карточек NPC и журналов утверждены (PR `FW-NPC-REL-013`).
- Телеметрия и модерация сценариев настроены вместе с `npc-relationship-monitoring`.

---

## 13. REST API и JSON схемы

- `GET /social/npc-relationships/{npcId}` — статус отношений, эмоций и доверия (`NpcRelationshipStatus`).
- `POST /social/npc-relationships/adjust` — пакетное изменение шкал (`NpcRelationshipAdjustRequest`).
- `POST /social/npc-relationships/interactions` — запись взаимодействия (`NpcInteractionLogRequest`).
- `GET /world/npc-relationships/events` — события, влияющие на NPC (`NpcRelationshipEvent`).
- `POST /social/npc-relationships/romance` — управление романтическими статусами (`NpcRomanceRequest`).
- `GET /social/npc-relationships/history/{npcId}` — аудит взаимодействий (`NpcRelationshipHistory`).

**JSON схемы:**  
- `schemas/social/npc-relationship-status.schema.json`  
- `schemas/social/npc-relationship-adjust.schema.json`  
- `schemas/social/npc-interaction-log.schema.json`  
- `schemas/world/npc-relationship-event.schema.json`  
- `schemas/social/npc-romance.schema.json`  
- `schemas/social/npc-relationship-history.schema.json`

---

## 14. Kafka события и очереди

| Topic | Producer | Payload | Консьюмеры |
|-------|----------|---------|-----------|
| `social.npc-relationship.changed` | social-service | `{ npcId, playerId, reputationDelta, trustDelta, mood }` | world-service, gameplay-service, telemetry |
| `social.npc-romance.state` | social-service | `{ npcId, playerId, romanceLevel, flags }` | quest-service, narrative-service, telemetry |
| `world.npc-relationship.event` | world-service | `{ eventId, npcId, eventType, severity }` | social-service, notification-service |
| `social.npc-hiring.eligibility` | social-service | `{ npcId, eligibilityState, requiredTrust, requiredReputation }` | npc-hiring-service, economy-service |

- Очереди: `npc-relationship-review` (модерация), `npc-romance-validation` (контроль условий романов).

---

## 15. Метрики и аналитика

- `NpcTrustStability` — стабильность доверия NPC, отслеживается telemetry.
- `RomanceProgressRate` — скорость продвижения романтических веток, влияет на события.
- `InteractionQualityScore` — качество взаимодействий (подарки, квесты, диалоги).
- `NpcDefectionRisk` — риск ухода NPC, используется world-service.
- `EventImpactIndex` — влияние мировых событий на NPC отношения.

---

## 16. UX, QA и согласование

- UI макеты NPC карточек утверждены (PR `FW-NPC-REL-013`), включают эмоции, логи, чеклисты романтики.
- Security review `SEC-NPC-REL-002` — подтверждены санкции и безопасные сценарии.
- QA чеклист:  
  - [x] JSON схемы валидированы `schema-test`.  
  - [x] Kafka payloadы синхронизированы с backend.  
  - [x] UX кейсы протестированы (романтика, наём, дефекция).
- Workshop 2025-11-08 10:35: social/world/gameplay команды подтвердили шкалы и события.

---

## 17. История изменений

- 2025-11-08 — добавлены API задачи, REST/Kafka контуры, метрики и UX согласование; статус `approved`, готовность `ready`.
- 2025-11-07 — первичный драфт отношений с NPC.