# Система отношений и репутации — детальная версия

**Статус:** approved  
**Версия:** 1.0.0  
**Дата создания:** 2025-11-07  
**Последнее обновление:** 2025-11-09 01:28  
**Приоритет:** высокий

**target-domain:** social  
**target-microservice:** social-service (8084)  
**target-microservice-secondary:** world-service (8092), economy-service (8089), gameplay-service (8086)  
**target-frontend-module:** modules/social/relationships, modules/world/diplomacy

**api-readiness:** ready  
**api-readiness-check-date:** 2025-11-09 01:28  
**api-readiness-notes:** Шкалы репутации, договоры и события перепроверены 2025-11-09 01:28; REST/Kafka контуры согласованы с social/world/economy сервисами, блокеров нет.

---

## 1. Методика детализации

- **Шкалы:** указаны ступени и триггеры переходов (репутация, доверие, рейтинги).
- **Визуализация:** описаны UI-интерфейсы, цветовые кодировки, уведомления.
- **События:** для каждого уровня — разблокируемые миссии, бонусы, санкции.
- **Микросервисы:** `social-service` (отношения, доверие, союзные договоры), `economy-service` (контракты, торговля), `world-service` (события, последствия), `gameplay-service` (боевые операции).
- **Логи:** история взаимодействий, арбитраж, аудит.
- **Влияние:** связка с фракциями, кланами, городами, социальными объектами.

---

## 2. Отношения между игроками — расширенные уровни

### 2.1 Friends / Allies / Pact

- **Friends:** доступ к статусу, быстрым сообщениям, совместным операциям. UI: зеленая рамка, индикатор онлайн.
- **Close Allies:** расширенный доступ к ресурсам, дележ репутации, совместные квесты. Требования: высокий trust, успешные операции.
- **Pact (Клятва):** сочетание союза и доверия, общие цели, предупреждения при угрозах. UI: золотая рамка, совместный символ.

### 2.2 Enemies / Nemesis

- **Enemies:** красная рамка, предупреждения, история конфликтов.
- **Nemesis:** автоматические уведомления, точечные награды за победу/защиту, доступ к PvP-квестам.
- **Арбитраж:** возможность подачи жалоб (`social-service`) на нечестное поведение, лог смен репутации.

---

## 3. Репутация (Player ↔ Player, Clan, Faction)

### 3.1 Шкала и триггеры

- **Сегменты:** Hostile (-100..-50), Unfriendly (-50..-10), Neutral (-10..+10), Friendly (+10..+50), Ally (+50..+100).
- **UI:** цвет индикатора (красный, оранжевый, серый, синий, золотой), всплывающее сообщение при переходе сегмента.
- **Триггеры:** совместные миссии, торговля, предательство, спасение, участие в событиях.

### 3.2 Эффекты

- **Hostile:** NPC атакуют, запрет торговли, блокировка зон.
- **Unfriendly:** повышенные цены, проверки, ограниченный доступ.
- **Neutral:** стандартные условия.
- **Friendly:** скидки, дополнительные квесты, доступ к базам.
- **Ally:** эксклюзивные контракты, совместные базы, оповещения.

### 3.3 Репутация в цепочке (Player ↔ Clan ↔ Faction ↔ City)

- **Player-Clan:** доступ к рангу, голосованию, ресурсам.
- **Clan-Faction:** влияние на налоги, события, территорию.
- **Faction-Faction:** дипломатические статусы (союз, нейтралитет, конкуренция, война).
- **City Effects:** цвет подсветки кварталов, бонусы/штрафы, доступ к объектам.

---

## 4. Доверие (Trust) — детальные уровни

### 4.1 Шкала

- **0-20: нет доверия** — запрет на ценные сделки, предоплата, флаги риска.
- **21-40: низкое** — базовые контракты, повышенная комиссия.
- **41-60: умеренное** — расширенные сделки, возможность кредитов.
- **61-80: высокое** — доступ к закрытым ресурсам, совместные базы.
- **81-100: полное** — общие хранилища, доступ к секретным квестам, доверительные операции.

### 4.2 Механика набора

- **Положительное:** успешные контракты, время в союзе, PvE защита, совместные бизнесы.
- **Отрицательное:** предательство, штрафы, нарушение договоров, жалобы.
- **UI:** прогресс-бар, всплывающие уведомления, индикация событий.

### 4.3 Договор доверия

- **Виды:** торговый, боевой, стратегический (управление кланом).
- **Опции:** лимит доступа к складу, доля прибыли, условия выхода.
- **Арбитраж:** жалобы на нарушение, штрафы, репутационные удары.

---

## 5. Союзы и договоры

### 5.1 Типы союзов

- **Combat Alliance:** совместные операции, доступ к боевым базам, общие сигналы тревоги.
- **Trade Alliance:** совместные логистические миссии, скидки, общие контракты.
- **Clan Alliance:** объединение кланов, общие ресурсы, голосование.
- **Faction Support:** коллективная поддержка фракции, бонусы.

### 5.2 Процесс создания союза

- **Инициатор → приглашение → условия → подтверждение → публикация**.
- **UI:** панель союза, история договоров, таймеры продления.
- **Нарушение:** штраф репутации, прекращение, арбитраж.

---

## 6. Рейтинги и социальный капитал

- **Overall:** интегрирует все факторы, влияет на доступ к элитным миссиям.
- **Combat:** PvP, рейды, эскорт.
- **Trade:** экономическая эффективность, логистика.
- **Reliability:** выполнение контрактов, отсутствие жалоб.
- **Social Influence:** участие в событиях, медиапокрытие, квесты.
- **UI:** вкладки рейтинга, медали, сезонные трофеи.
- **Награды:** кастомизация, доступ к особым NPC, позывные.

---

## 7. История взаимодействий и арбитраж

- **Записи:** контракты, торговля, боевые операции, квесты, предательства.
- **Фильтры:** по типу, дате, участникам, результатам.
- **Отзывы:** игроки оставляют фидбэк (баллы + текст).
- **Арбитраж:** `social-service` получает жалобы, применяет санкции.

---

## 8. Взаимодействие с фракциями и городами

- **Фракции:** доступ к эксклюзивам, влияние на территории, участие в политике.
- **Города:** репутация влияет на цены, доступ к хабам, безопасность.
- **Ежедневные обновления:** сводки по фракциям, предупреждения о войнах, ивенты.
- **Интеграция:** `factions-overview-детально.md`, `visual-style-locations-детально.md`.

---

## 9. Использование документа

- Применять при подготовке API спецификаций для отношений и доверия.
- Использовать как базу для UI-описаний, сценариев квестов, социальных хабов.
- Связывать с экономикой, логистикой, боевыми операциями и системой фракций.
- При создании пользовательских контрактов и союзов использовать описанные шаблоны.
- UX макеты отношений и дипломатии согласованы (PR `FW-RELATIONS-011`).
- Модерационные и телеметрические процессы настроены (`relationships-monitoring`).

---

## 10. REST API и JSON схемы

- `GET /social/relationships/{entityId}` — состояние отношений и репутации (`RelationshipStatus`).
- `POST /social/relationships/update` — изменение шкал (batch) (`RelationshipUpdateRequest`).
- `POST /social/trust/contracts` — создание договора доверия (`TrustContractRequest`).
- `GET /social/trust/contracts/{contractId}` — детали договора (`TrustContract`).
- `POST /world/alliances/events` — публикация событий союзов (`AllianceEventRequest`).
- `GET /social/relationships/history/{entityId}` — аудит взаимодействий (`RelationshipHistory`).

**JSON схемы:**  
- `schemas/social/relationship-status.schema.json`  
- `schemas/social/relationship-update.schema.json`  
- `schemas/social/trust-contract.schema.json`  
- `schemas/world/alliance-event.schema.json`  
- `schemas/social/relationship-history.schema.json`

---

## 11. Kafka события и очереди

| Topic | Producer | Payload | Консьюмеры |
|-------|----------|---------|-----------|
| `social.relationships.changed` | social-service | `{ entityId, targetId, reputationDelta, trustDelta, reason }` | economy-service, world-service, quest-service |
| `social.trust.contract.created` | social-service | `{ contractId, type, participants[], escrowRequired }` | economy-service, notification-service |
| `world.alliance.event` | world-service | `{ eventId, allianceId, eventType, severity }` | social-service, telemetry, npc-service |
| `social.relationships.alert` | social-service | `{ alertId, severity, message, involvedParties[] }` | UI, monitoring, security-service |

- Очередь `relationships-arbitration` обрабатывает жалобы и правовые проверки.

---

## 12. Метрики и аналитика

- `TrustStabilityIndex` — стабильность доверительных договоров, отслеживается telemetry.
- `ReputationVolatility` — волатильность репутации, влияет на уведомления и предупреждения.
- `AllianceSuccessRate` — успешность союзов, применяется для world-events.
- `ArbitrationLatency` — время обработки жалоб, SLA < 5 минут.
- `RelationshipEngagementScore` — активность игроков в социальных механиках.

---

## 13. UX, QA и согласование

- UI макеты отношений и дипломатии утверждены (PR `FW-RELATIONS-011`).
- Security review `SEC-REL-005` — валидация санкций и правовых ограничений.
- QA чеклист:  
  - [x] JSON схемы проверены `schema-test`.  
  - [x] Kafka payloadы синхронизированы с backend.  
  - [x] UX потоки протестированы на клановых и фракционных сценариях.
- Workshop 2025-11-08 10:25: social/world/economy команды подтвердили шкалы и события.

---

## 14. История изменений

- 2025-11-08 — добавлены API задачи, REST/Kafka контуры, метрики и UX согласование; статус `approved`, готовность `ready`.
- 2025-11-07 — первичный драфт системы отношений.